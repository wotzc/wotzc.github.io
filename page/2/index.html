<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="真正的大师永远都怀着一颗学徒的心">
<meta property="og:type" content="website">
<meta property="og:title" content="Cai">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Cai">
<meta property="og:description" content="真正的大师永远都怀着一颗学徒的心">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="wotzc">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Cai</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Cai</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wotzc"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">wotzc</p>
  <div class="site-description" itemprop="description">真正的大师永远都怀着一颗学徒的心</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">69</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/11/git%E5%8D%8F%E4%BD%9C%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="wotzc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cai">
      <meta itemprop="description" content="真正的大师永远都怀着一颗学徒的心">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cai">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/11/git%E5%8D%8F%E4%BD%9C%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">git协作工作流程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-03-11 14:59:38" itemprop="dateCreated datePublished" datetime="2024-03-11T14:59:38+08:00">2024-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-25 20:16:47" itemprop="dateModified" datetime="2024-03-25T20:16:47+08:00">2024-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/" itemprop="url" rel="index"><span itemprop="name">版本控制</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="git-远程"><a href="#git-远程" class="headerlink" title="git 远程"></a>git 远程</h1><p>SVN 使用单一的集中式版本库作为开发人员的通信中心，通过在开发人员的工作副本和中心版本库之间传递变更集来实现协作。这与 Git 的分布式协作模式不同，后者为每个开发人员提供了自己的版本库副本，并拥有自己的本地历史记录和分支结构。用户通常需要共享一系列提交，而不是单个变更集。Git 可让你在不同版本库之间共享整个分支，而不是将工作副本中的变更集提交到中央版本库。</p>
<p><code>git remote</code>命令是更广泛系统中负责同步变更的一个部分。通过 <code>git remote</code>命令注册的记录会与 <code>git fetch</code>、<code>git push</code> 和 <code>git pull</code> 命令结合使用。这些命令都有各自的同步职责，可以在相应的链接中查看。</p>
<h2 id="git-remote"><a href="#git-remote" class="headerlink" title="git remote"></a>git remote</h2><p>使用 <code>git remote</code> 命令可以创建、查看和删除与其他版本库的连接。远程连接更像是书签，而不是其他版本库的直接链接。与其说它们提供了对另一个版本库的实时访问，不如说它们是一个方便的名字，可以用来引用一个不太方便的 URL。</p>
<p>例如，下图显示了从你的版本库到中央版本库和另一个开发者版本库的两个远程连接。与其用完整的 URL 来引用它们，你可以把 origin 和 john 的快捷方式传递给其他 Git 命令。</p>
<h3 id="git-remote使用概述"><a href="#git-remote使用概述" class="headerlink" title="git remote使用概述"></a>git remote使用概述</h3><p><code>git remote</code> 命令本质上是一个界面，用于管理存储在版本库 <code>./.git/config</code> 文件中的远程条目列表。以下命令用于查看远程列表的当前状态。</p>
<h3 id="查看-git-远程配置"><a href="#查看-git-远程配置" class="headerlink" title="查看 git 远程配置"></a>查看 git 远程配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote</span><br></pre></td></tr></table></figure>

<p>列出您与其他存储库的远程连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote -v</span><br></pre></td></tr></table></figure>

<p>与上面的命令相同，但包含每个连接的 URL。</p>
<h3 id="创建和修改-git-远程配置"><a href="#创建和修改-git-远程配置" class="headerlink" title="创建和修改 git 远程配置"></a>创建和修改 git 远程配置</h3><p><code>git remote</code> 命令也是修改软件仓库 <code>./.git/config</code> 文件的一种方便或 “辅助 “方法。下面的命令可以让你管理与其他版本库的连接。以下命令将修改版本库的 <code>./.git/config</code> 文件。使用文本编辑器直接编辑 <code>./.git/config</code> 文件也能达到以下命令的效果。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add &lt;name&gt; &lt;url&gt;</span><br></pre></td></tr></table></figure>

<p>创建与远程版本库的新连接。添加远程仓库后，你就可以在其他 Git 命令中使用<code>＜name＞</code>作为<code>＜url＞</code>的快捷方式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote rm &lt;name&gt;</span><br></pre></td></tr></table></figure>

<p>删除与名为 <code>＜name＞</code> 的远程存储库的连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote rename &lt;old-name&gt; &lt;new-name&gt;</span><br></pre></td></tr></table></figure>

<p>将远程连接从 <code>＜old-name＞</code> 重命名为 <code>＜new-name＞</code>。</p>
<h3 id="git-remote讨论"><a href="#git-remote讨论" class="headerlink" title="git remote讨论"></a>git remote讨论</h3><p>Git 旨在为每个开发人员提供一个完全独立的开发环境。这意味着信息不会在仓库之间自动来回传递。相反，开发者需要手动将上游提交拉入本地仓库，或手动将本地提交推回中央仓库。<code>git remote</code> 命令实际上只是为这些 “共享 “命令传递 URL 的一种更简便的方式。</p>
<p>当你用 <code>git clone</code> 克隆一个仓库时，它会自动创建一个名为 <code>origin</code> 的远程连接，指向被克隆的仓库。这对于创建中央仓库本地副本的开发者来说非常有用，因为它提供了一种拉取上游变更或发布本地提交的简便方法。这也是大多数基于 Git 的项目将其中央仓库称为 <code>origin</code> 的原因。</p>
<p>Git 支持多种引用远程仓库的方式。访问远程仓库最简单的两种方式是 <code>HTTP</code> 和 <code>SSH</code> 协议。<code>HTTP</code> 是一种允许匿名、只读访问仓库的简单方式。例如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://host/path/to/repo.git</span><br></pre></td></tr></table></figure>

<p>但是，通常无法将提交推送到 <code>HTTP</code> 地址（反正你也不想允许匿名推送）。要进行读写访问，应该使用 <code>SSH</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh:&#x2F;&#x2F;user@host&#x2F;path&#x2F;to&#x2F;repo.git</span><br></pre></td></tr></table></figure>

<p>你需要在主机上有一个有效的 <code>SSH</code> 账户，除此之外，Git 本身就支持通过 <code>SSH</code> 验证访问。现代安全的第三方托管解决方案（如 Bitbucket.com）会为你提供这些 URL。</p>
<h3 id="git-remote命令"><a href="#git-remote命令" class="headerlink" title="git remote命令"></a>git remote命令</h3><p><code>git remote</code>命令是众多 Git 命令中的一个，这些命令会附加 “子命令”。下面将介绍常用的 <code>git remote</code>子命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote ADD &lt;NAME&gt; &lt;URL&gt;</span><br></pre></td></tr></table></figure>

<p>在 <code>./.git/config</code> 中为名为<code>＜name＞</code>的远程仓库URL<code>＜url＞</code>添加一条记录。</p>
<p>接受 <code>-f</code> 选项，该选项会在远程记录创建后立即 <code>git fetch</code>。</p>
<p>接受 <code>--tags</code> 选项，该选项将立即 git 抓取并从远程仓库导入每个标签。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote RENAME &lt;OLD&gt; &lt;NEW&gt;</span><br></pre></td></tr></table></figure>

<p>更新 <code>./.git/config</code>，将记录<code>＜OLD＞</code>重命名为<code>＜NEW＞</code>。所有远程跟踪分支和远程配置设置都会更新。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote REMOVE or RM &lt;NAME&gt;</span><br></pre></td></tr></table></figure>

<p>修改 <code>./.git/config</code> 并删除名为 <code>＜NAME＞</code> 的远程。所有远程跟踪分支和远程配置设置都会被删除。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote GET-URL &lt;NAME&gt;</span><br></pre></td></tr></table></figure>

<p>输出远程记录的 URL。</p>
<p>接受 <code>--push</code> 时，查询的是推送 URL 而不是获取 URL。</p>
<p>使用 <code>--all</code> 时，将列出远程记录的所有 URL。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote SHOW &lt;NAME&gt;</span><br></pre></td></tr></table></figure>

<p>输出远程 <code>＜NAME＞</code>的高级信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote PRUNE &lt;NAME&gt;</span><br></pre></td></tr></table></figure>

<p>删除远程版本库中不存在的任何本地<code>＜NAME＞</code> 分支。</p>
<p>接受 <code>--dry-run</code> 选项，该选项会列出要删除的分支，但不会真的删除。</p>
<p>除了<code>origin</code>之外，与队友的仓库建立连接通常也很方便。例如，如果你的同事约翰在 dev.example.com/john.git 上维护了一个可公开访问的仓库，你可以添加如下连接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add john http://dev.example.com/john.git</span><br></pre></td></tr></table></figure>

<p>有了这种访问个人开发者仓库的权限，就可以在中央仓库之外进行协作。这对于开发大型项目的小团队来说非常有用。</p>
<h3 id="查看远程存储库"><a href="#查看远程存储库" class="headerlink" title="查看远程存储库"></a>查看远程存储库</h3><p>默认情况下，<code>git remote</code> 命令会列出之前存储的与其他版本库的远程连接。这将产生单行输出，列出远程仓库的 “书签 “名称。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git remote</span><br><span class="line">origin</span><br><span class="line">upstream</span><br><span class="line">other_users_repo</span><br></pre></td></tr></table></figure>

<p>使用<code>-v</code>选项调用<code>git remote</code>会打印书签仓库名称列表以及相应的仓库 URL。<code>-v</code>选项代表 “<code>verbose</code>“。下面是 <code>git remote</code> 的详细输出示例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git remote -v</span><br><span class="line">origin  git@bitbucket.com:origin_user&#x2F;reponame.git (fetch)</span><br><span class="line">origin  git@bitbucket.com:origin_user&#x2F;reponame.git (push)</span><br><span class="line">upstream    https:&#x2F;&#x2F;bitbucket.com&#x2F;upstream_user&#x2F;reponame.git (fetch)</span><br><span class="line">upstream    https:&#x2F;&#x2F;bitbucket.com&#x2F;upstream_user&#x2F;reponame.git (push)</span><br><span class="line">other_users_repo    https:&#x2F;&#x2F;bitbucket.com&#x2F;other_users_repo&#x2F;reponame (fetch)</span><br><span class="line">other_users_repo    https:&#x2F;&#x2F;bitbucket.com&#x2F;other_users_repo&#x2F;reponame (push)</span><br></pre></td></tr></table></figure>

<h3 id="添加远程存储库"><a href="#添加远程存储库" class="headerlink" title="添加远程存储库"></a>添加远程存储库</h3><p><code>git remote add</code> 命令将为远程仓库创建一个新的连接记录。添加远程记录后，你就可以把它作为其他 Git 命令的快捷方式。有关可接受的 URL 语法的更多信息，请参阅下面的 “版本库 URL “部分。该命令将在版本库的<code>./.git/config</code>文件中创建一条新记录。配置文件更新示例如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git remote add fake_test https:&#x2F;&#x2F;bitbucket.com&#x2F;upstream_user&#x2F;reponame.git; [remote &quot;remote_test&quot;] </span><br><span class="line">   url &#x3D; https:&#x2F;&#x2F;bitbucket.com&#x2F;upstream_user&#x2F;reponame.git </span><br><span class="line">   fetch &#x3D; +refs&#x2F;heads&#x2F;*:refs&#x2F;remotes&#x2F;remote_test&#x2F;*</span><br></pre></td></tr></table></figure>

<h3 id="检查远程存储库"><a href="#检查远程存储库" class="headerlink" title="检查远程存储库"></a>检查远程存储库</h3><p><code>show</code> 子命令可附加到 <code>git remote</code>，以提供远程配置的详细输出。该输出将包含与远程相关联的分支列表，以及用于获取和推送的端点。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git remote show upstream</span><br><span class="line">* remote upstream</span><br><span class="line">   Fetch URL: https://bitbucket.com/upstream_user/reponame.git</span><br><span class="line">   Push URL: https://bitbucket.com/upstream_user/reponame.git</span><br><span class="line">   HEAD branch: main</span><br><span class="line">   Remote branches:</span><br><span class="line">      main tracked</span><br><span class="line">      simd-deprecated tracked</span><br><span class="line">      tutorial tracked</span><br><span class="line">   Local ref configured <span class="keyword">for</span> <span class="string">&#x27;git push&#x27;</span>:</span><br><span class="line">      main pushes to main (fast-forwardable)</span><br></pre></td></tr></table></figure>

<h3 id="从-Git-远程fetching和pulling"><a href="#从-Git-远程fetching和pulling" class="headerlink" title="从 Git 远程fetching和pulling"></a>从 Git 远程fetching和pulling</h3><p>使用 <code>git remote</code> 命令配置远程记录后，远程名称就可以作为参数传递给其他 Git 命令，以便与远程仓库通信。<code>git fetch</code> 和 <code>git pull</code> 都可以用来读取远程仓库。这两个命令都有不同的操作，我们将在它们各自的链接中作更深入的解释。</p>
<h3 id="推送到-Git-远程"><a href="#推送到-Git-远程" class="headerlink" title="推送到 Git 远程"></a>推送到 Git 远程</h3><p><code>git push</code>命令用于写入远程仓库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push &lt;remote-name&gt; &lt;branch-name&gt;</span><br></pre></td></tr></table></figure>

<p>此示例将把<code>＜branch-name＞</code>的本地状态上传到<code>＜remote-name＞</code>指定的远程存储库。</p>
<h3 id="重命名和删除Git-远程"><a href="#重命名和删除Git-远程" class="headerlink" title="重命名和删除Git 远程"></a>重命名和删除Git 远程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote rename &lt;old-name&gt; &lt;new-name&gt;</span><br></pre></td></tr></table></figure>

<p><code>git remote rename</code> 命令不言自明。执行该命令后，远程连接将从<code>&lt;old-name&gt;</code>更名为<code>&lt;new-name&gt;</code>。此外，该命令还将修改 <code>./.git/config</code> 中的内容，重新命名远程记录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote rm &lt;name&gt;</span><br></pre></td></tr></table></figure>

<p><code>git remote rm</code>命令将删除与<code>＜name＞</code>参数指定的远程仓库的连接。为了演示，让我们 “撤销 “上一个例子中的远程添加。如果我们执行<code>git remote rm remote_test</code>，然后检查<code>./.git/config</code>的内容，就会发现 [remote “remote_test”] 记录已不复存在。</p>
<hr>
<h2 id="git-fetch"><a href="#git-fetch" class="headerlink" title="git fetch"></a>git fetch</h2><p><code>git fetch</code> 命令会将提交、文件和引用从远程仓库下载到本地仓库。当你想看看其他人都在做些什么时，你就会使用 <code>fetch</code> 命令。它与<code>svn update</code>类似，能让你看到中心历史的进展，但并不强制你把修改合并到自己的仓库中。Git 将获取的内容与现有的本地内容隔离开来，对本地开发工作完全没有影响。获取的内容必须使用 <code>git checkout</code> 命令明确签出。因此，在将提交内容整合到本地仓库之前，获取内容是一种安全的审查方式。</p>
<p>从远程仓库下载内容时，可以使用<code>git pull</code>和<code>git fetch</code>命令来完成任务。<code>git fetch</code> 是这两个命令的 “安全 “版本。<code>git pull</code>是更激进的选择；它会下载本地活动分支的远程内容，并立即执行 <code>git merge</code> 为新的远程内容创建合并提交。如果您有待处理的修改正在进行中，这将导致冲突，并启动合并冲突解决流程。</p>
<h3 id="git-fetch-如何使用远程分支"><a href="#git-fetch-如何使用远程分支" class="headerlink" title="git fetch 如何使用远程分支"></a>git fetch 如何使用远程分支</h3><p>为了更好地理解 <code>git fetch</code> 的工作原理，我们先来讨论一下 Git 是如何组织和存储提交的。在仓库的 <code>./.git/objects</code> 目录中，Git 隐藏了所有本地和远程提交。Git 通过使用分支索引将远程和本地分支的提交区分开来。本地分支的 refs 保存在 <code>./.git/refs/heads/</code> 目录中。执行 <code>git branch</code> 命令会输出本地分支 refs 的列表。下面是一个 git 分支输出示例，其中包含一些演示分支名称。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git branch</span><br><span class="line">main</span><br><span class="line">feature1</span><br><span class="line">debug2</span><br></pre></td></tr></table></figure>

<p>检查 <code>/.git/refs/heads/</code> 目录的内容也会发现类似的输出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ls ./.git/refs/heads/</span><br><span class="line">main</span><br><span class="line">feature1</span><br><span class="line">debug2</span><br></pre></td></tr></table></figure>

<p>远程分支和本地分支一样，只不过它们映射的是别人版本库中的提交。远程分支的前缀是其所属的远程仓库，这样就不会与本地分支混淆。和本地分支一样，Git 也有远程分支的 refs。远程分支参考位于 <code>./.git/refs/remotes/</code> 目录中。下一个示例代码片段展示了在获取一个名为<code>remote-repo</code>的远程仓库后可能看到的分支：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git branch -r</span><br><span class="line"><span class="comment"># origin/main</span></span><br><span class="line"><span class="comment"># origin/feature1</span></span><br><span class="line"><span class="comment"># origin/debug2</span></span><br><span class="line"><span class="comment"># remote-repo/main</span></span><br><span class="line"><span class="comment"># remote-repo/other-feature</span></span><br></pre></td></tr></table></figure>

<p>该输出显示了我们之前检查过的本地分支，但现在显示的是以 <code>origin/</code> 为前缀的分支。此外，我们现在还能看到以 <code>remote-repo</code> 为前缀的远程分支。你可以像检出本地分支一样检出远程分支，但这将使你处于分离的 <code>HEAD</code> 状态（就像检出旧提交一样）。你可以把它们看作只读分支。要查看远程分支，只需在 <code>git branch</code> 命令中加入 <code>-r</code> 标志即可。</p>
<p>你还可以用常用的 <code>git checkout</code> 和 <code>git log</code> 命令来检查远程分支。如果您批准了远程分支包含的改动，就可以用普通的 git 合并将其合并到本地分支中。因此，与 SVN 不同，同步本地仓库和远程仓库实际上只需两步：<code>fetch</code>，然后<code>merge</code>。<code>git pull</code> 命令是实现这一过程的便捷快捷方式。</p>
<h3 id="git-fetch-命令和选项"><a href="#git-fetch-命令和选项" class="headerlink" title="git fetch 命令和选项"></a>git fetch 命令和选项</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch &lt;remote&gt;</span><br></pre></td></tr></table></figure>

<p>从版本库中获取所有分支。这也会从另一个版本库下载所有需要的提交和文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch &lt;remote&gt; &lt;branch&gt;</span><br></pre></td></tr></table></figure>

<p>与上述命令相同，但只获取指定的分支。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch --all</span><br></pre></td></tr></table></figure>

<p>强力移动，可获取所有已注册的远程版本库及其分支：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch --dry-run</span><br></pre></td></tr></table></figure>

<p><code>--dry-run</code> 选项将执行命令的试运行。它会输出获取过程中的操作示例，但不会真的执行这些操作。</p>
<h3 id="git-fetch示例"><a href="#git-fetch示例" class="headerlink" title="git fetch示例"></a>git fetch示例</h3><h4 id="git-fetch远程分支"><a href="#git-fetch远程分支" class="headerlink" title="git fetch远程分支"></a>git fetch远程分支</h4><p>下面的示例将演示如何获取远程分支并将本地工作状态更新为远程内容。在这个示例中，我们假设有一个中心仓库，本地仓库是使用 <code>git clone</code> 命令从该仓库克隆的。我们还假设有一个名为<code>coworkers_repo</code>的远程仓库，其中包含一个 <code>feature_branch</code>，我们将对其进行配置和获取。有了这些假设，让我们继续举例说明。</p>
<p>首先，我们需要使用 <code>git remote</code> 命令配置远程仓库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add coworkers_repo git@bitbucket.org:coworker/coworkers_repo.git</span><br></pre></td></tr></table></figure>

<p>在这里，我们使用 repo URL 创建了一个指向同事 repo 的引用。现在，我们将把该远程名称传递给 <code>git fetch</code> 以下载内容。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git fetch coworkers_repo coworkers/feature_branch</span><br><span class="line">fetching coworkers/feature_branch</span><br></pre></td></tr></table></figure>

<p>现在我们在本地拥有了<code>coworkers/feature_branch</code>的内容，我们需要将其整合到本地工作副本中。首先，我们使用 <code>git checkout</code> 命令签出新下载的远程分支。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git checkout coworkers/feature_branch</span><br><span class="line">Note: checking out coworkers/feature_branch<span class="string">&#x27;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You are in &#x27;</span>detached HEAD<span class="string">&#x27; state. You can look around, make experimental</span></span><br><span class="line"><span class="string">changes and commit them, and you can discard any commits you make in this</span></span><br><span class="line"><span class="string">state without impacting any branches by performing another checkout.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">If you want to create a new branch to retain commits you create, you may</span></span><br><span class="line"><span class="string">do so (now or later) by using -b with the checkout command again. Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">git checkout -b &lt;new-branch-name&gt;</span></span><br></pre></td></tr></table></figure>

<p>该检出操作的输出结果显示，我们处于分离的 HEAD 状态。这是意料之中的，这意味着我们的 HEAD ref 指向的 ref 与本地历史不一致。由于 HEAD 指向的是<code>coworkers/feature_branch</code> ref，我们可以从该 ref 创建一个新的本地分支。分离的 HEAD “输出向我们展示了如何使用 <code>git checkout</code> 命令来做到这一点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b local_feature_branch</span><br></pre></td></tr></table></figure>

<p>在这里，我们创建了一个名为 <code>local_feature_branch</code> 的新本地分支。这样，HEAD 的更新就会指向最新的远程内容，我们就可以在此基础上继续开发。</p>
<h4 id="使用-git-fetch-同步远程分支"><a href="#使用-git-fetch-同步远程分支" class="headerlink" title="使用 git fetch 同步远程分支"></a>使用 git fetch 同步远程分支</h4><p>下面的示例介绍了本地版本库与中央版本库主分支同步的典型工作流程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch origin</span><br></pre></td></tr></table></figure>

<p>这将显示已下载的分支：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a1e8fb5..45e66a4 main -&gt; origin&#x2F;main</span><br><span class="line">a1e8fb5..9e8ab1c develop -&gt; origin&#x2F;develop</span><br><span class="line">* [new branch] some-feature -&gt; origin&#x2F;some-feature</span><br></pre></td></tr></table></figure>

<p>这些新远程分支的提交在下图中显示为方形而不是圆形。正如你所看到的，<code>git fetch</code> 可以让你访问另一个仓库的整个分支结构。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-fetch-2x.png" style="zoom:50%;" />

<p>要查看上游<code>main</code>分支添加了哪些提交，可以使用 <code>origin/main</code> 作为过滤器运行 git 日志：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline main..origin/main</span><br></pre></td></tr></table></figure>

<p>要批准更改并将其合并到本地主分支，请使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">git <span class="built_in">log</span> origin/main</span><br></pre></td></tr></table></figure>

<p>然后我们就可以使用 <code>git merge origin/main</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge origin/main</span><br></pre></td></tr></table></figure>

<p><code>origin/main</code> 分支和<code>main</code>分支现在指向同一个提交，你就能与上游开发同步了。</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p><code>git fetch</code> 与 <code>git remote</code>、<code>git branch</code>、<code>git checkout</code> 和 <code>git reset</code> 配合使用，可将本地仓库更新为远程仓库的状态。<code>git fetch</code> 命令是 git 协作工作流程中的一个重要部分。<code>git fetch</code> 的行为与 <code>git pull</code> 相似，但 <code>git fetch</code> 可被视为更安全的非破坏性版本。</p>
<hr>
<h2 id="git-push"><a href="#git-push" class="headerlink" title="git push"></a>git push</h2><p><code>git push</code>命令用于将本地仓库内容上传到远程仓库。<code>push</code>是将提交从本地仓库转移到远程仓库的方式。它与 <code>git fetch</code> 相对应，但 <code>fetch</code> 是将提交导入本地分支，而 <code>push</code> 则是将提交导出到远程分支。使用 <code>git remote</code> 命令可以配置远程分支。推送有可能会覆盖改动，因此在推送时应小心谨慎。下文将讨论这些问题。</p>
<h3 id="git-push-用法"><a href="#git-push-用法" class="headerlink" title="git push 用法"></a>git push 用法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push &lt;remote&gt; &lt;branch&gt;</span><br></pre></td></tr></table></figure>

<p>将指定的分支连同所有必要的提交和内部对象推送到远程指定分支。这会在目标仓库创建一个本地分支。为了防止覆盖提交，Git 不会允许你在目标版本库中进行非快速合并的推送。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push &lt;remote&gt; --force</span><br></pre></td></tr></table></figure>

<p>与上述命令相同，但即使结果是非快进合并，也会强制推送。除非你确信知道自己在做什么，否则不要使用 <code>--force</code> 标志。</p>
<p>将所有本地分支推送到指定的远程分支。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push &lt;remote&gt; --tags</span><br></pre></td></tr></table></figure>

<p>推送分支或使用 <code>--all</code> 选项时，标签不会自动推送。<code>--tags</code>标记会将所有本地标记发送到远程版本库。</p>
<h3 id="git-push讨论"><a href="#git-push讨论" class="headerlink" title="git push讨论"></a>git push讨论</h3><p><code>git push</code> 最常用于发布本地修改并上传到中央仓库。本地版本库修改后，执行推送以与远程团队成员共享修改内容。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-before-push-2x.png" style="zoom:50%;" />

<hr>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-after-push-2x.png" style="zoom:50%;" />

<p>上图显示的是当本地主仓库的进度超过中心仓库的主仓库时，您通过运行 <code>git push origin main</code> 发布改动的情况。请注意，<code>git push</code> 与在远程仓库中运行 <code>git merge main</code> 本质上是一样的。</p>
<p><code>git push</code> 是整个 Git “同步 “过程中使用的众多命令之一。<code>git push</code> 可视为 “上传 “命令，而 <code>git fetch</code> 和 <code>git pull</code> 可视为 “下载 “命令。通过下载或上传移动变更集后，可在目的地执行 <code>git merge</code>以整合变更。</p>
<h3 id="强制push"><a href="#强制push" class="headerlink" title="强制push"></a>强制push</h3><p>为了防止覆盖中央仓库的历史，Git 会在推送请求导致非快速合并时拒绝推送请求。因此，如果远程历史与本地历史有偏差，就需要拉取远程分支并将其合并到本地分支，然后再尝试推送。这类似于 SVN 让你在提交变更集之前通过 svn update 与中心版本库同步。</p>
<p><code>--force</code>标志会覆盖这一行为，并使远程版本库的分支与本地分支相匹配，同时删除上次推送后可能发生的任何上游变更。唯一需要强制推送的情况是，当你意识到刚刚共享的提交并不完全正确，并用 <code>git commit --amend</code> 或交互式 <code>rebase</code> 进行了修正。不过，在使用 <code>--force</code> 选项之前，您必须绝对确定没有任何队友拉取过这些提交。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p><strong>默认 git push</strong></p>
<p>下面的示例描述了向中央版本库发布本地贡献的标准方法之一。首先，它通过获取中央版本库的副本并在其上重置你的改动，确保你的本地<code>main</code>分支是最新的。交互式变基也是在分享之前清理提交的好机会。然后，<code>git push</code> 命令会将本地主仓库的所有提交发送到中央仓库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">git fetch origin main</span><br><span class="line">git rebase -i origin/main</span><br><span class="line"><span class="comment"># Squash commits, fix up commit messages etc.</span></span><br><span class="line">git push origin main</span><br></pre></td></tr></table></figure>

<p>由于我们已经确保了本地<code>main</code>分支是最新的，这应该会导致快进合并，而 <code>git push</code> 也不会抱怨上面讨论过的任何非快进问题。</p>
<p><strong>修改后的强制推送</strong></p>
<p><code>git commit</code> 命令接受一个 <code>--amend</code> 选项，它将更新之前的提交。修改提交通常是为了更新提交信息或添加新的改动。一旦提交被修改，git 推送就会失败，因为 Git 会把修改后的提交和远程提交视为不同的内容。要推送修改过的提交，必须使用 <code>--force</code> 选项。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># make changes to a repo and git add</span></span><br><span class="line">git commit --amend</span><br><span class="line"><span class="comment"># update the existing commit message</span></span><br><span class="line">git push --force origin main</span><br></pre></td></tr></table></figure>

<p>上面的示例假定是在一个有提交历史的现有版本库中执行的。<code>git commit --amend</code> 用于更新之前的提交。然后使用   <code>--force</code> 选项强制推送修正后的提交。</p>
<p><strong>删除远程分支或标签</strong></p>
<p>有时，出于记账或组织目的，需要清理分支。要完全删除分支，必须在本地和远程删除。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git branch -D branch_name</span><br><span class="line">git push origin :branch_name</span><br></pre></td></tr></table></figure>

<p>上面的命令将删除名为 <code>branch_name</code> 的远程分支，向 <code>git push</code> 传递一个以冒号为前缀的分支名称将删除该远程分支。</p>
<hr>
<h2 id="git-pull"><a href="#git-pull" class="headerlink" title="git pull"></a>git pull</h2><p><code>git pull</code> 命令用于从远程仓库获取和下载内容，并立即更新本地仓库以匹配这些内容。在基于 Git 的协作工作流程中，将远程上游改动合并到本地仓库是一项常见任务。<code>git pull</code> 命令实际上是其他两个命令的组合，即 <code>git fetch</code> 和 <code>git merge</code>。在操作的第一阶段，<code>git pull</code> 会对 HEAD 指向的本地分支执行 <code>git fetch</code>。下载完成后，<code>git pull</code> 将进入合并工作流程。会创建一个新的合并提交，并更新 HEAD 以指向新的提交。</p>
<h3 id="How-it-works"><a href="#How-it-works" class="headerlink" title="How it works"></a>How it works</h3><p><code>git pull</code> 命令首先运行 <code>git fetch</code>，从指定的远程仓库下载内容。然后执行 <code>git merge</code>，将远程内容的引用和头部合并到一个新的本地合并提交中。为了更好地演示拉取和合并过程，让我们看看下面的例子。假设我们有一个包含主分支和远程起源的仓库。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-pull-usage-2x.png" style="zoom:50%;" />

<p>在这种情况下，<code>git pul</code>l 会下载本地提交和主提交分歧点上的所有改动。在本例中，分歧点是 E。<code>git pull</code> 会获取分歧的远程提交，即 A-B-C。然后，拉取过程会创建一个新的本地合并提交，其中包含新的远程分歧提交的内容。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-fetch-and-merge-2x.png" style="zoom:50%;" />

<p>在上图中，我们可以看到新的提交 H。该提交是一个新的合并提交，包含了远程 A-B-C 提交的内容，并有一条合并日志信息。这个例子是 <code>git pull</code> 合并策略中的一种。<code>git pull</code> 可以通过 <code>--rebase</code> 选项来使用 <code>rebase</code> 合并策略，而不是<code>merge</code>提交。下一个例子将演示 <code>rebase pull</code> 的工作原理。假设我们在第一个图的起点执行了 <code>git pull --rebase</code> 命令。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-pull-rebase-2x.png" style="zoom:50%;" />

<p>从图中我们可以看到，<code>rebase</code> 拉取并没有创建新的 H 提交。相反，<code>rebase</code> 复制了远程提交 A–B–C，并改写了本地提交 E–F–G，使其出现在本地<code>origin/main</code>提交历史记录中。</p>
<h3 id="常用选项"><a href="#常用选项" class="headerlink" title="常用选项"></a>常用选项</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull &lt;remote&gt;</span><br></pre></td></tr></table></figure>

<p>获取当前分支的指定远程副本，并立即将其合并到本地副本中。这等同于<code>git fetch ＜remote＞</code> 然后 <code>git merge origin/＜current-branch＞</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull --no-commit &lt;remote&gt;</span><br></pre></td></tr></table></figure>

<p>与默认调用类似，获取远程内容，但不会创建新的合并提交。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull --rebase &lt;remote&gt;</span><br></pre></td></tr></table></figure>

<p>与上一次的拉取相同，并非使用 <code>git merge</code> 将远程分支与本地分支整合，而是使用 <code>git rebase</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull --verbose</span><br></pre></td></tr></table></figure>

<p>在拉取过程中提供详细输出，显示正在下载的内容和合并细节。</p>
<h3 id="讨论"><a href="#讨论" class="headerlink" title="讨论"></a>讨论</h3><p>你可以把 <code>git pull</code> 想象成 Git 版本的 <code>svn update</code>。它是同步本地仓库和上游改动的简便方法。下图解释了拉取过程的每一步。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-pull-step1-2x.png" style="zoom:50%;" />

<hr>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-pull-step2-2x.png" style="zoom: 33%;" />

<hr>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-pull-step3-2x.png" style="zoom: 33%;" />

<p>您一开始以为您的版本库已经同步，但 <code>git fetch</code> 发现自从您上次检查之后，<code>origin</code> 的 <code>main</code> 版本有了新的进展。然后 <code>git merge</code> 立即将远程的 <code>main</code> 整合到本地的 <code>main</code> 中。</p>
<p><code>git pull</code>是许多负责 “同步 “远程内容的命令之一。<code>git remote</code>命令用于指定同步命令将在哪些远程端点上运行。<code>git push</code>命令用于将内容上传到远程仓库。</p>
<p><code>git fetch</code>命令可能会与 <code>git pull</code> 命令混淆。它们都用于下载远程内容。<code>git fetch</code>被视为 “安全 “选项，而<code>git pull</code>则被视为不安全选项。或者，<code>git pull</code>会下载远程内容，并立即尝试改变本地状态以匹配该内容。这可能会无意中导致本地仓库处于冲突状态。</p>
<h3 id="Pulling-via-Rebase"><a href="#Pulling-via-Rebase" class="headerlink" title="Pulling via Rebase"></a>Pulling via Rebase</h3><p>使用 <code>--rebase</code> 选项可以防止不必要的合并提交，从而确保线性历史。相比合并，许多开发者更喜欢重定向，因为这就像在说：”我想把我的改动放在其他人的改动之上”。从这个意义上说，使用带有 <code>--rebase</code> 标志的 <code>git pull</code> 甚至比普通的 <code>git pull</code> 更像 svn update。</p>
<p>事实上，使用 <code>--rebase</code> 拉取是一个很常见的工作流程，以至于有专门的配置选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global branch.autosetuprebase always</span><br></pre></td></tr></table></figure>

<p> 运行该命令后，所有 <code>git pull</code> 命令都将通过 <code>git rebase</code> 而不是 <code>git merge</code> 进行整合。</p>
<h3 id="Git-Pull-Examples"><a href="#Git-Pull-Examples" class="headerlink" title="Git Pull Examples"></a>Git Pull Examples</h3><p>以下示例演示了如何在常见情况下使用 <code>git pull</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull</span><br></pre></td></tr></table></figure>

<p>执行 <code>git pull</code> 的默认调用相当于 <code>git fetch origin HEAD</code> 和 <code>git merge HEAD</code>，其中 <code>HEAD</code> 是指向当前分支的 ref。</p>
<h4 id="Git-pull-on-remotes"><a href="#Git-pull-on-remotes" class="headerlink" title="Git pull on remotes"></a>Git pull on remotes</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout new_feature</span><br><span class="line">git pull &lt;remote repo&gt;</span><br></pre></td></tr></table></figure>

<p>本例首先执行签出一个新分支并切换到分支。然后，通过传递执行 <code>git pull</code>。这将隐式地从 <code>&lt;remote repo&gt;</code> 下载完成后，将启动 <code>git merge</code>。</p>
<h4 id="Git-pull-rebase-instead-of-merge"><a href="#Git-pull-rebase-instead-of-merge" class="headerlink" title="Git pull rebase instead of merge"></a>Git pull rebase instead of merge</h4><p>下面的示例演示了如何使用 <code>rebase</code> 与中央版本库的主分支同步：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">git pull --rebase origin</span><br></pre></td></tr></table></figure>

<p>这只是将你的本地修改移到其他人已经贡献的内容之上。</p>
<hr>
<h1 id="使用分支"><a href="#使用分支" class="headerlink" title="使用分支"></a>使用分支</h1><h2 id="Git-Branch"><a href="#Git-Branch" class="headerlink" title="Git Branch"></a>Git Branch</h2><p>本文将深入评述 git 分支命令，并讨论 Git 的整体分支模型。分支是大多数现代版本控制系统都具备的功能。在其他版本控制系统中，分支操作会耗费大量时间和磁盘空间。在 Git 中，分支是日常开发流程的一部分。</p>
<p>Git 分支实际上就是您所做修改的快照指针。当你想添加一个新功能或修复一个错误时，无论大小，你都要创建一个新的分支来封装你的改动。这样一来，不稳定的代码就很难被合并到主代码库中，而且在合并到主分支之前，你还有机会清理未来的历史。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-branchs-2x.png" style="zoom:50%;" />

<p>上图展示了一个包含两条独立开发线的版本库，一条用于开发一个小功能，另一条用于开发一个运行时间较长的功能。通过在分支中开发这两条线，不仅可以并行处理这两条线，还能保证主分支不被有问题的代码干扰。</p>
<p>与其他版本控制系统模式相比，Git 分支的实现要轻便得多。Git 并不是把文件从一个目录复制到另一个目录，而是把分支作为提交的引用来存储。从这个意义上说，分支代表了一系列提交的顶端，而不是提交的容器。分支的历史是通过提交关系推断出来的。</p>
<p>在阅读过程中，请记住 Git 分支与 SVN 分支不同。SVN 分支只在偶尔的大规模开发工作中使用，而 Git 分支则是日常工作流程中不可或缺的一部分。下面的内容将详细介绍 Git 分支的内部架构。</p>
<h3 id="How-it-works-1"><a href="#How-it-works-1" class="headerlink" title="How it works"></a>How it works</h3><p>一个分支代表一条独立的开发线路。分支是<code>edit/stage/commit</code>流程的抽象。你可以把它们看作是申请全新工作目录、暂存区域和项目历史的一种方式。新的提交会被记录在当前分支的历史中，从而在项目历史中形成一个分叉。</p>
<p>git 分支命令允许你创建、列出、重命名和删除分支。但它不能在分支间切换，也不能把分叉的历史记录重新组合起来。因此，<code>git branch</code> 与 <code>git checkout</code> 和 <code>git merge</code> 命令紧密结合。</p>
<h3 id="Common-options"><a href="#Common-options" class="headerlink" title="Common options"></a>Common options</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch</span><br></pre></td></tr></table></figure>

<p>列出版本库中的所有分支。这与 <code>git branch --list</code> 同义。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch &lt;branch&gt;</span><br></pre></td></tr></table></figure>

<p>创建一个名为 <code>＜branch＞</code> 的新分支。这并不签出新分支。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -d &lt;branch&gt;</span><br></pre></td></tr></table></figure>

<p>删除指定的分支。这是一个 “安全 “的操作，因为如果分支有未合并的更改，Git 会阻止你删除该分支。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -D &lt;branch&gt;</span><br></pre></td></tr></table></figure>

<p>强制删除指定的分支，即使它还有未合并的改动。如果你想永久删除与某一行开发相关的所有提交，可以使用这条命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -m &lt;branch&gt;</span><br></pre></td></tr></table></figure>

<p>将当前分支重命名为 <code>＜branch＞</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -a</span><br></pre></td></tr></table></figure>

<p>列出所有远程分支。</p>
<h3 id="创建分支"><a href="#创建分支" class="headerlink" title="创建分支"></a>创建分支</h3><p>要知道，分支只是提交的指针。创建分支时，Git 需要做的只是创建一个新指针，不会以任何其他方式改变版本库。如果你一开始创建的版本库是这样的</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-branch-state-2x.png" style="zoom:50%;" />

<p>然后，使用以下命令创建一个分支：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch crazy-experiment</span><br></pre></td></tr></table></figure>

<p>版本库历史保持不变。你得到的只是一个指向当前提交的新指针：</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-branch-create-branch-2x.png" style="zoom:50%;" />

<p>注意，这只会创建新分支。要开始向其添加提交，需要用 <code>git checkout</code> 选中它，然后使用标准的 <code>git add</code> 和 <code>git commit</code> 命令。</p>
<h3 id="创建远程分支"><a href="#创建远程分支" class="headerlink" title="创建远程分支"></a>创建远程分支</h3><p>到目前为止，这些例子都演示了本地分支的操作。<code>git branch</code> 命令同样适用于远程分支。要在远程分支上运行，必须先配置远程 repo 并将其添加到本地 repo 配置中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git remote add new-remote-repo https://bitbucket.com/user/repo.git</span><br><span class="line"><span class="comment"># Add remote repo to local repo config</span></span><br><span class="line">$ git push &lt;new-remote-repo&gt; crazy-experiment~</span><br><span class="line"><span class="comment"># pushes the crazy-experiment branch to new-remote-repo</span></span><br></pre></td></tr></table></figure>

<p>这条命令会将本地分支 <code>crazy-experiment</code> 的副本推送到远程仓库 <code>＜remote＞</code>。</p>
<h3 id="删除分支"><a href="#删除分支" class="headerlink" title="删除分支"></a>删除分支</h3><p>一旦你完成了某个分支的工作，并将其合并到主代码库中，你就可以自由删除该分支，而不会丢失任何历史记录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -d crazy-experiment</span><br></pre></td></tr></table></figure>

<p>但是，如果分支尚未合并，上述命令将输出错误信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: The branch &#39;crazy-experiment&#39; is not fully merged. If you are sure you want to delete it, run &#39;git branch -D crazy-experiment&#39;.</span><br></pre></td></tr></table></figure>

<p>这样就不会失去对整个开发线的访问权限。如果你真的想删除该分支（例如，它是一个失败的实验），可以使用大写的 -D 标志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -D crazy-experiment</span><br></pre></td></tr></table></figure>

<p>该命令会删除分支，无论其状态如何，且不会发出警告，因此请谨慎使用。</p>
<p>前面的命令将删除分支的本地副本。该分支可能仍然存在于远程版本库中。要删除远程分支，请执行以下命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin --delete crazy-experiment</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin :crazy-experiment</span><br></pre></td></tr></table></figure>

<p>这将向远程源代码库推送一个删除信号，触发远程 <code>crazy-experiment</code> 分支的删除。</p>
<h3 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h3><p>本文将讨论 Git 的分支行为和 git 分支命令。git 分支命令的主要功能是创建、列出、重命名和删除分支。为了进一步操作生成的分支，该命令通常与其他命令（如 <code>git checkout</code>）一起使用。有关 <code>git checkout</code> 分支操作的更多信息，如切换分支和合并分支，请参阅 <code>git checkout</code> 页面。</p>
<p>与其他 VCS 相比，Git 的分支操作既便宜又常用。这种灵活性使得 Git 工作流程的定制功能非常强大。</p>
<hr>
<h2 id="git-checkout"><a href="#git-checkout" class="headerlink" title="git checkout"></a>git checkout</h2><p>本页将介绍 <code>git checkout</code> 命令。它将涵盖使用示例和边缘案例。在 Git 术语中，”checkout”是在目标实体的不同版本之间切换的行为。<code>git checkout</code> 命令针对三个不同的实体：文件、提交和分支。除了 “<code>checkout</code> “的定义，”checking out “也常用来表示执行 <code>git checkout</code> 命令的行为。在 “撤销修改 “主题中，我们看到了如何使用 git 签出查看旧提交。本文的大部分内容将集中在对分支的签出操作上。</p>
<p>签出分支与签出旧提交和文件类似，工作目录会被更新以匹配所选的分支/修订版本；不过，新的改动会被保存到项目历史中，也就是说，这不是一个只读操作。</p>
<h3 id="Checking-out-branches"><a href="#Checking-out-branches" class="headerlink" title="Checking out branches"></a>Checking out branches</h3><p>使用 <code>git checkout</code> 命令，你可以在 git 分支创建的各个分支之间切换。签出分支会更新工作目录中的文件，使之与该分支中的版本相匹配，并让 Git 记录该分支上的所有新提交。可以把它想象成一种选择开发方向的方式。</p>
<p>为每个新功能建立一个专用分支，是对传统 SVN 工作流程的巨大转变。它让尝试新功能变得非常容易，而不必担心破坏现有功能，也让同时开发许多不相关的功能成为可能。此外，分支还为多个协作工作流程提供了便利。</p>
<p><code>git checkout</code> 命令有时会与 <code>git clone</code> 混淆。这两个命令的区别在于，<code>clone</code> 的作用是从远程仓库获取代码，而 <code>checkout</code> 的作用则是在本地系统已经存在的代码版本之间切换。</p>
<h3 id="使用已存在的分支"><a href="#使用已存在的分支" class="headerlink" title="使用已存在的分支"></a>使用已存在的分支</h3><p>如果您正在使用的软件仓库包含已有的分支，您可以使用 <code>git checkout</code> 在这些分支间切换。要了解有哪些可用分支以及当前分支的名称，请执行 <code>git branch</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$＞ git branch </span><br><span class="line">main </span><br><span class="line">another_branch </span><br><span class="line">feature_inprogress_branch </span><br><span class="line">$＞ git checkout feature_inprogress_branch</span><br></pre></td></tr></table></figure>

<p>上面的例子演示了如何通过执行 <code>git branch</code> 命令查看可用分支列表，并切换到指定分支，在本例中就是 <code>feature_inprogress_branch</code>。</p>
<h3 id="新分支"><a href="#新分支" class="headerlink" title="新分支"></a>新分支</h3><p><code>git checkout</code>与 <code>git branch</code>是并行的。<code>git branch</code>命令可以用来创建一个新分支。当你想创建一个新功能时，可以用 <code>git branch new_branch</code>在主分支之外创建一个新分支。创建完成后，就可以使用 <code>git checkout new_branch</code> 切换到该分支。此外，<code>git checkout</code> 命令还接受一个 <code>-b</code> 参数，作为一种方便的方法，它会创建新的分支并立即切换到该分支。通过使用 <code>git checkout</code>，您可以在一个仓库中的多个特性之间进行切换。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b ＜new-branch＞</span><br></pre></td></tr></table></figure>

<p>上面的例子同时创建和签出了<code>＜new-branch＞</code>。<code>-b</code>选项是一个方便的标志，它告诉 Git 在运行<code>git checkout ＜new-branch＞</code> 之前先运行<code>git branch</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b ＜new-branch＞ ＜existing-branch＞</span><br></pre></td></tr></table></figure>

<p>默认情况下，<code>git checkout -b</code> 会以当前 <code>HEAD</code> 为基础创建新分支。<code>git checkout</code> 可以传递一个可选的附加分支参数。在上面的例子中，传递了<code>＜existing-branch＞</code>，新分支就会基于现有分支，而不是当前的 <code>HEAD</code>。</p>
<h3 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h3><p>切换分支是一个简单明了的操作。执行以下命令将把 <code>HEAD</code> 指向<code>＜branchname＞</code>的顶端。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout ＜branchname＞</span><br></pre></td></tr></table></figure>

<p>Git 会在 reflog 中记录检出操作的历史。你可以执行<code>git reflog</code>查看历史记录。</p>
<h3 id="git-checkout远程分支"><a href="#git-checkout远程分支" class="headerlink" title="git checkout远程分支"></a>git checkout远程分支</h3><p>与团队协作时，通常会使用远程资源库。这些版本库可能是托管和共享的，也可能是其他同事的本地副本。每个远程版本库都包含自己的分支集。要检出一个远程分支，必须先获取该分支的内容。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch --all</span><br></pre></td></tr></table></figure>

<p>在现代版本的 Git 中，你可以像签出本地分支一样签出远程分支。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout ＜remotebranch＞</span><br></pre></td></tr></table></figure>

<p>旧版本的 Git 需要在远程分支的基础上创建一个新分支。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b ＜remotebranch＞ origin/＜remotebranch＞</span><br></pre></td></tr></table></figure>

<p>此外，你还可以签出一个新的本地分支，并将其重置为远程分支的最后一次提交。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b ＜branchname＞</span><br><span class="line">git reset --hard origin/＜branchname＞</span><br></pre></td></tr></table></figure>

<h3 id="分离的-HEAD"><a href="#分离的-HEAD" class="headerlink" title="分离的 HEAD"></a>分离的 HEAD</h3><p>既然我们已经了解了 <code>git checkout</code> 在分支上的三种主要用途，那么讨论一下 “分离的 HEAD “状态就很重要了。请记住，<code>HEAD</code> 是 Git 表示当前快照的方式。在内部，<code>git checkout</code> 命令只是更新 <code>HEAD</code>，使其指向指定的分支或提交。当它指向一个分支时，Git 不会抱怨，但当你签出一个提交时，它就会切换到 <code>“detached HEAD”</code>状态。</p>
<p>这是一个警告，告诉你你正在做的一切都与项目的其他开发 “分离 “了。如果你在分离 HEAD 状态下开始开发某个功能，就不会有任何分支允许你返回到该功能。当你不可避免地签出另一个分支（例如，将你的功能合并到其中）时，你将无法引用你的功能：</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/detached-head-2x.png" style="zoom:50%;" />

<hr>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/attached-head-2x.png" style="zoom:50%;" />

<p>重点是，你的开发应该始终在分支上进行，而不是在分离的 HEAD 上。这样才能确保你的新提交始终有一个引用。不过，如果你只是在查看旧提交，那么是否处于分离的 HEAD 状态并不重要。</p>
<h3 id="Summary-2"><a href="#Summary-2" class="headerlink" title="Summary"></a>Summary</h3><p>本页主要介绍 <code>git checkout</code> 命令在更改分支时的用法。总的来说，在分支上使用 <code>git checkout</code> 会改变 <code>HEAD ref</code> 的目标。它可以用来创建分支、切换分支和签出远程分支。<code>git checkout</code> 命令是标准 Git 操作的基本工具。它是 <code>git merge</code> 的对应命令。<code>git checkout</code> 和 <code>git merge</code> 命令是实现 Git 工作流程的关键工具。</p>
<hr>
<h2 id="git-merge"><a href="#git-merge" class="headerlink" title="git merge"></a>git merge</h2><p>合并是 Git 将已分叉的历史重新组合起来的一种方式。通过 <code>git merge</code> 命令，你可以将 <code>git branch</code>创建的独立开发分支整合到一个分支中。</p>
<p>请注意，下面介绍的所有命令都会合并到当前分支。当前分支将被更新以反映合并，但目标分支将完全不受影响。这再次说明，<code>git merge</code> 经常与 <code>git checkout</code> 和 <code>git branch -d</code> 结合使用，前者用于选择当前分支，后者用于删除过时的目标分支。</p>
<h3 id="How-it-works-2"><a href="#How-it-works-2" class="headerlink" title="How it works"></a>How it works</h3><p><code>git merge</code>会将多个提交序列合并成一个统一的历史。在最常见的使用案例中，<code>git merge</code> 被用来合并两个分支。本文档的以下示例将重点介绍这种分支合并模式。在这些情况下，git 合并会使用两个提交指针（通常是分支提示），并在它们之间找到一个共同的基本提交。一旦 Git 找到了共同的基本提交，它就会创建一个新的 “合并提交”，把每个排队合并的提交序列的改动合并在一起。</p>
<p>假设我们有一个基于主分支的新特性分支。现在我们想把这个特性分支合并到主干分支中。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-merge-2x.png" style="zoom:50%;" />

<p>调用该命令会将指定的分支特性合并到当前分支，我们假设是主分支。Git 会自动决定合并算法（下文将讨论）。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-merge-feature-2x.png" style="zoom:50%;" />

<p>与其他提交相比，合并提交有两个父提交。在创建合并提交时，Git 会尝试自动神奇地合并两个不同的历史。如果 Git 遇到两个历史中都有改动的数据，它就无法自动合并它们。这种情况属于版本控制冲突，Git 需要用户干预才能继续。</p>
<h3 id="准备合并"><a href="#准备合并" class="headerlink" title="准备合并"></a>准备合并</h3><p>在执行合并之前，有几个准备步骤要做，以确保合并顺利进行。</p>
<h4 id="确认接收分支"><a href="#确认接收分支" class="headerlink" title="确认接收分支"></a>确认接收分支</h4><p>执行 <code>git status</code> 以确保 <code>HEAD</code> 指向正确的合并接收分支。如果需要，执行 <code>git checkout</code> 切换到接收分支。在我们的例子中，我们将执行 <code>git checkout main</code>。</p>
<h4 id="获取最新的远程提交"><a href="#获取最新的远程提交" class="headerlink" title="获取最新的远程提交"></a>获取最新的远程提交</h4><p>确保接收分支和合并分支都有最新的远程变更。执行 <code>git fetch</code> 提取最新的远程提交。获取完成后，执行 <code>git pull</code> 确保主分支有最新更新。</p>
<h4 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h4><p>一旦完成了之前讨论过的 “准备合并 “步骤，就可以执行 <code>git merge</code> 开始合并了。</p>
<h3 id="快进合并"><a href="#快进合并" class="headerlink" title="快进合并"></a>快进合并</h3><p>当从当前分支顶端到目标分支之间存在一条线性路径时，就会发生快进合并。Git 不需要 “实际 “合并分支，只需移动（即 “快进”）当前分支顶端到目标分支顶端，就能整合历史。这就有效地合并了历史，因为目标分支的所有提交现在都可以通过当前分支获得。例如，将 <code>some-feature</code> 快速合并到 <code>main</code> 分支的过程如下：</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/before-merge-2x.png" style="zoom:50%;" />

<hr>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/after-merge-2x.png" style="zoom:50%;" />

<p>不过，如果分支已经分叉，则无法进行快进合并。如果没有通往目标分支的线性路径，Git 只能通过三向合并来合并它们。三向合并使用专门的提交来连接两个历史分支。Git 使用三个提交来生成合并提交：两个分支的顶端和它们的共同祖先。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/three-way-merge-before.png" style="zoom:50%;" />

<hr>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/three-way-merge-after.png" style="zoom:50%;" />

<p>虽然您可以使用这两种合并策略中的任何一种，但许多开发人员喜欢使用快进合并（通过<code>rebase</code>来实现）来处理小功能或错误修复，而保留三向合并来整合运行时间较长的功能。在后一种情况下，合并提交的结果就是两个分支的象征性连接。</p>
<p>我们的第一个例子演示了快进合并。下面的代码创建了一个新分支，向其添加了两次提交，然后通过快进合并将其整合到主线中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start a new feature</span></span><br><span class="line">git checkout -b new-feature main</span><br><span class="line"><span class="comment"># Edit some files</span></span><br><span class="line">git add &lt;file&gt;</span><br><span class="line">git commit -m <span class="string">&quot;Start a feature&quot;</span></span><br><span class="line"><span class="comment"># Edit some files</span></span><br><span class="line">git add &lt;file&gt;</span><br><span class="line">git commit -m <span class="string">&quot;Finish a feature&quot;</span></span><br><span class="line"><span class="comment"># Merge in the new-feature branch</span></span><br><span class="line">git checkout main</span><br><span class="line">git merge new-feature</span><br><span class="line">git branch -d new-feature</span><br></pre></td></tr></table></figure>

<p>这是短生命周期特性分支的常见工作流程，这些分支更多是作为独立开发使用，而不是作为长期运行特性的组织工具。</p>
<p>另外要注意的是，由于 new-feature 现在可以从主分支访问，因此 Git 不会抱怨 <code>git branch -d</code> 的问题。</p>
<p>如果在快进合并过程中需要合并提交以保存记录，可以使用 <code>--no-ff</code> 选项执行 <code>git merge</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge --no-ff &lt;branch&gt;</span><br></pre></td></tr></table></figure>

<p>该命令将指定的分支合并到当前分支，但始终会生成合并提交（即使是快进合并）。这对记录版本库中发生的所有合并很有用。</p>
<h3 id="3-向合并"><a href="#3-向合并" class="headerlink" title="3 向合并"></a>3 向合并</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Start a new feature</span><br><span class="line">git checkout -b new-feature main</span><br><span class="line"><span class="comment"># Edit some files</span></span><br><span class="line">git add &lt;file&gt;</span><br><span class="line">git commit -m <span class="string">&quot;Start a feature&quot;</span></span><br><span class="line"><span class="comment"># Edit some files</span></span><br><span class="line">git add &lt;file&gt;</span><br><span class="line">git commit -m <span class="string">&quot;Finish a feature&quot;</span></span><br><span class="line"><span class="comment"># Develop the main branch</span></span><br><span class="line">git checkout main</span><br><span class="line"><span class="comment"># Edit some files</span></span><br><span class="line">git add &lt;file&gt;</span><br><span class="line">git commit -m <span class="string">&quot;Make some super-stable changes to main&quot;</span></span><br><span class="line"><span class="comment"># Merge in the new-feature branch</span></span><br><span class="line">git merge new-feature</span><br><span class="line">git branch -d new-feature</span><br></pre></td></tr></table></figure>

<p>请注意，Git 不可能执行快进合并，因为没有办法在不回溯的情况下将 main 上移到 new-feature。</p>
<p>对于大多数工作流程来说，new-feature 会是一个更大的特性分支，需要很长时间才能开发完成，这也是新提交会同时出现在 main 上的原因。如果您的特性分支和上面例子中的分支一样小，您最好将其重定向到主分支，然后进行快进合并。这样可以防止多余的合并提交扰乱项目历史。</p>
<h3 id="解决冲突"><a href="#解决冲突" class="headerlink" title="解决冲突"></a>解决冲突</h3><p>如果要合并的两个分支都修改了同一个文件的相同部分，Git 就无法判断该使用哪个版本。这种情况下，Git 会在合并提交前停止，让你手动解决冲突。</p>
<p>Git 合并流程的最大优点在于，它使用我们熟悉的编辑/阶段/提交工作流程来解决合并冲突。遇到合并冲突时，运行 <code>git status</code> 命令就会显示哪些文件需要解决。例如，如果两个分支都修改了 hello.py 的同一个部分，就会出现类似下面的情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">On branch main</span><br><span class="line">Unmerged paths:</span><br><span class="line">(use <span class="string">&quot;git add/rm ...&quot;</span> as appropriate to mark resolution)</span><br><span class="line">both modified: hello.py</span><br></pre></td></tr></table></figure>

<h3 id="冲突如何呈现"><a href="#冲突如何呈现" class="headerlink" title="冲突如何呈现"></a>冲突如何呈现</h3><p>当 Git 在合并过程中遇到冲突时，它会编辑受影响文件的内容，并在冲突内容的两侧标上可视化标记。这些视觉标记是 <code>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code>、<code>=======</code> 和 <code>&gt;&gt;&gt;&gt;&gt;&gt;&gt;</code>。在合并过程中，搜索项目中的这些标记，有助于找到需要解决冲突的地方。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">here is some content not affected by the conflict</span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; <span class="string">main</span></span><br><span class="line"><span class="string">this is conflicted text from main</span></span><br><span class="line">=======</span><br><span class="line">this is conflicted text from feature branch</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt; feature branch;</span><br></pre></td></tr></table></figure>

<p>一般来说，<code>=======</code> 标记之前的内容是接收分支，之后的部分是合并分支。</p>
<p>一般来说，<code>=======</code> 标记之前的内容是接收分支，之后的部分是合并分支。</p>
<p>一旦确定了有冲突的部分，就可以按照自己的喜好进行修改。准备完成合并时，只需在有冲突的文件上运行 <code>git add</code>，告诉 Git 它们已经解决了。然后，再运行正常的 <code>git commit</code>，生成合并提交。这与提交普通快照的过程完全相同，因此普通开发者也能轻松管理自己的合并。</p>
<p>请注意，合并冲突只会发生在三方合并的情况下。快进合并中不可能出现冲突的变更。</p>
<h3 id="Summary-3"><a href="#Summary-3" class="headerlink" title="Summary"></a>Summary</h3><p>本文档概述了<code>git merge</code>命令。在使用 Git 时，合并是一个必不可少的过程。我们讨论了合并背后的内部机制，以及快速合并和三方真正合并之间的区别。一些主要收获如下</p>
<ol>
<li><p>Git 合并将提交序列合并为一个统一的提交历史。</p>
</li>
<li><p>Git 有两种主要的合并方式： 快进和3向合并方式</p>
</li>
<li><p>Git 可以自动合并提交，除非两个提交序列中的改动有冲突。</p>
</li>
</ol>
<hr>
<h2 id="Git-merge-conflicts"><a href="#Git-merge-conflicts" class="headerlink" title="Git merge conflicts"></a>Git merge conflicts</h2><p>版本控制系统主要是管理多个分布式作者（通常是开发人员）之间的贡献。有时，多个开发人员可能会尝试编辑相同的内容。如果开发人员 A 试图编辑开发人员 B 正在编辑的代码，就可能发生冲突。为了减少冲突的发生，开发者会在独立的分支中工作。<code>git merge</code>命令的主要职责就是合并不同的分支，并解决任何冲突的编辑。</p>
<h3 id="理解合并冲突"><a href="#理解合并冲突" class="headerlink" title="理解合并冲突"></a>理解合并冲突</h3><p>一般来说，当两个人在一个文件中修改了相同的行，或者一个开发者删除了一个文件，而另一个开发者正在修改该文件时，就会产生冲突。在这种情况下，Git 无法自动判断哪个是正确的。冲突只会影响到进行合并的开发者，团队的其他成员并不知晓。Git 会将文件标记为冲突文件，并停止合并进程。解决冲突是开发人员的责任。</p>
<h3 id="合并冲突的类型"><a href="#合并冲突的类型" class="headerlink" title="合并冲突的类型"></a>合并冲突的类型</h3><p>合并可能在两个不同的时间点进入冲突状态。开始合并时和合并过程中。下面将讨论如何解决这些冲突情况。</p>
<h4 id="Git-启动合并失败"><a href="#Git-启动合并失败" class="headerlink" title="Git 启动合并失败"></a>Git 启动合并失败</h4><p>当 Git 发现当前项目的工作目录或暂存区域有改动时，合并就会失败。Git 无法启动合并是因为这些待处理的改动可能会被正在合并的提交所覆盖。发生这种情况时，不是因为与其他开发者的提交冲突，而是与本地的待处理变更冲突。本地状态需要使用 <code>git stash</code>、<code>git checkout</code>、<code>git commit</code> 或 <code>git reset</code> 来稳定。启动时合并失败会输出以下错误信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: Entry &#39;&lt;fileName&gt;&#39; not uptodate. Cannot merge. (Changes in working directory)</span><br></pre></td></tr></table></figure>

<h4 id="Git-在合并过程中失败"><a href="#Git-在合并过程中失败" class="headerlink" title="Git 在合并过程中失败"></a>Git 在合并过程中失败</h4><p>合并失败表示当前本地分支与正在合并的分支之间存在冲突。这表示与另一位开发者的代码有冲突。Git 会尽最大努力合并文件，但会把冲突文件中的问题留给你手动解决。中途合并失败会输出以下错误信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: Entry &#39;&lt;fileName&gt;&#39; would be overwritten by merge. Cannot merge. (Changes in staging area)</span><br></pre></td></tr></table></figure>

<h3 id="创建合并冲突"><a href="#创建合并冲突" class="headerlink" title="创建合并冲突"></a>创建合并冲突</h3><p>为了真正熟悉合并冲突，下一节将模拟一个冲突，以便稍后检查和解决。本示例将使用类似 Unix 的 Git 命令行界面来执行模拟示例。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir git-merge-test</span><br><span class="line">$ <span class="built_in">cd</span> git-merge-test</span><br><span class="line">$ git init .</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;this is some content to mess with&quot;</span> &gt; merge.txt</span><br><span class="line">$ git add merge.txt</span><br><span class="line">$ git commit -am<span class="string">&quot;we are commiting the inital content&quot;</span></span><br><span class="line">[main (root-commit) d48e74c] we are commiting the inital content</span><br><span class="line">1 file changed, 1 insertion(+)</span><br><span class="line">create mode 100644 merge.txt</span><br></pre></td></tr></table></figure>

<p>此代码示例将执行一系列命令，完成以下工作。</p>
<ul>
<li>新建一个名为 git-merge-test 的目录，并将其初始化为一个新的 Git 仓库。</li>
<li>新建一个文本文件 merge.txt，并在其中添加一些内容。 </li>
<li>将 merge.txt 添加到 repo 并提交。</li>
</ul>
<p>现在我们有了一个新的软件仓库，其中有一个主分支和一个包含内容的 merge.txt 文件。接下来，我们将创建一个新分支，作为冲突合并使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -b new_branch_to_merge_later</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;totally different content to merge later&quot;</span> &gt; merge.txt</span><br><span class="line">$ git commit -am<span class="string">&quot;edited the content of merge.txt to cause a conflict&quot;</span></span><br><span class="line">[new_branch_to_merge_later 6282319] edited the content of merge.txt to cause a conflict</span><br><span class="line">1 file changed, 1 insertion(+), 1 deletion(-)</span><br></pre></td></tr></table></figure>

<p>接下来的命令序列可实现以下功能：</p>
<ul>
<li>创建并签出名为 new_branch_ttoo_merge_later 的新分支</li>
<li>覆盖 merge.txt 中的内容  </li>
<li>提交新内容</li>
</ul>
<p>通过这个新分支：new_branch_to_merge_later，我们创建了一个覆盖 merge.txt 内容的提交。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">Switched to branch <span class="string">&#x27;main&#x27;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;content to append&quot;</span> &gt;&gt; merge.txt</span><br><span class="line">git commit -am<span class="string">&quot;appended content to merge.txt&quot;</span></span><br><span class="line">[main 24fbe3c] appended content to merge.tx</span><br><span class="line">1 file changed, 1 insertion(+)</span><br></pre></td></tr></table></figure>

<p>这一系列命令会检查主分支，将内容添加到 merge.txt 中，然后提交。这样，我们的示例仓库就有了 2 条新提交。一个在主分支，一个在 new_branch_too_merge_later 分支。现在让我们用 git 合并 new_branch_to_merge_later，看看会发生什么！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git merge new_branch_to_merge_later</span><br><span class="line">Auto-merging merge.txt</span><br><span class="line">CONFLICT (content): Merge conflict <span class="keyword">in</span> merge.txt</span><br><span class="line">Automatic merge failed; fix conflicts and <span class="keyword">then</span> commit the result.</span><br></pre></td></tr></table></figure>

<p>BOOM 💥. 冲突出现了。感谢 Git 让我们了解到这一点！</p>
<h3 id="如何确定合并冲突"><a href="#如何确定合并冲突" class="headerlink" title="如何确定合并冲突"></a>如何确定合并冲突</h3><p>正如我们在下面的例子中所体验到的，Git 会产生一些描述性输出，让我们知道发生了冲突。我们可以通过运行 <code>git status</code> 命令进一步了解情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">You have unmerged paths.</span><br><span class="line">(fix conflicts and run <span class="string">&quot;git commit&quot;</span>)</span><br><span class="line">(use <span class="string">&quot;git merge --abort&quot;</span> to abort the merge)</span><br><span class="line"></span><br><span class="line">Unmerged paths:</span><br><span class="line">(use <span class="string">&quot;git add &lt;file&gt;...&quot;</span> to mark resolution)</span><br><span class="line"></span><br><span class="line">both modified:   merge.txt</span><br></pre></td></tr></table></figure>

<p><code>git status</code> 的输出显示，由于冲突，存在未合并的路径。现在，merge.text 文件处于修改状态。让我们检查一下文件，看看修改了什么。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cat merge.txt</span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; <span class="string">HEAD</span></span><br><span class="line"><span class="string">this is some content to mess with</span></span><br><span class="line"><span class="string">content to append</span></span><br><span class="line"><span class="string">=======</span></span><br><span class="line"><span class="string">totally different content to merge later</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;&gt;&gt;&gt;&gt; new_branch_to_merge_later</span></span><br></pre></td></tr></table></figure>

<p>在这里，我们使用 cat 命令输出了 merge.txt 文件的内容。我们可以看到一些奇怪的新内容</p>
<ul>
<li><code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</code></li>
<li><code>=======</code></li>
<li><code>&gt;&gt;&gt;&gt;&gt;&gt;&gt; new_branch_to_merge_later</code></li>
</ul>
<p>将这些新线视为 “冲突分界线”。======= 行是冲突的 “中心”。中心和 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD 行之间的所有内容都是 HEAD ref 指向的当前分支 main 中存在的内容。或者，中心线和 &gt;&gt;&gt;&gt;&gt;&gt;&gt; new_branch_too_merge_later 之间的所有内容都是合并分支中的内容。</p>
<h3 id="如何使用命令行解决合并冲突"><a href="#如何使用命令行解决合并冲突" class="headerlink" title="如何使用命令行解决合并冲突"></a>如何使用命令行解决合并冲突</h3><p>解决合并冲突的最直接方法是编辑冲突文件。用你喜欢的编辑器打开 merge.txt 文件。在我们的例子中，让我们简单地删除所有冲突分隔符。修改后的 merge.txt 内容应如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">this is some content to mess with</span><br><span class="line">content to append</span><br><span class="line">totally different content to merge later</span><br></pre></td></tr></table></figure>

<p>文件编辑完成后，使用 <code>git add merge.txt</code> 将新合并的内容放入阶段。要最终完成合并，执行以下命令创建一个新提交</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -m <span class="string">&quot;merged and resolved the conflict in merge.txt&quot;</span></span><br></pre></td></tr></table></figure>

<p>Git 会发现冲突已被解决，并创建一个新的合并提交来最终完成合并。</p>
<h3 id="有助于解决合并冲突的-Git-命令"><a href="#有助于解决合并冲突的-Git-命令" class="headerlink" title="有助于解决合并冲突的 Git 命令"></a>有助于解决合并冲突的 Git 命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br></pre></td></tr></table></figure>

<p>在使用 Git 时，<code>status</code> 命令经常被使用，在合并过程中，它可以帮助识别冲突文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --merge</span><br></pre></td></tr></table></figure>

<p>在 <code>git log</code>命令中传递 <code>--merge</code> 参数，会生成一个包含合并分支间冲突提交列表的日志。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff</span><br></pre></td></tr></table></figure>

<p><code>diff</code>可帮助查找版本库/文件状态之间的差异。这对预测和防止合并冲突非常有用。</p>
<h3 id="当-git-启动合并失败时的工具"><a href="#当-git-启动合并失败时的工具" class="headerlink" title="当 git 启动合并失败时的工具"></a>当 git 启动合并失败时的工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout</span><br></pre></td></tr></table></figure>

<p><code>checkout</code> 可用于撤销对文件的更改，或更改分支</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --mixed</span><br></pre></td></tr></table></figure>

<p><code>reset</code>可用于撤销对工作目录和暂存区域的更改。</p>
<h3 id="合并过程中出现-git-冲突时的工具"><a href="#合并过程中出现-git-冲突时的工具" class="headerlink" title="合并过程中出现 git 冲突时的工具"></a>合并过程中出现 git 冲突时的工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge --abort</span><br></pre></td></tr></table></figure>

<p>使用 <code>--abort</code> 选项执行 <code>git merge</code> 会退出合并过程，并将分支恢复到合并开始前的状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset</span><br></pre></td></tr></table></figure>

<p><code>git reset</code>可在合并冲突期间使用，将冲突文件重置为已知的良好状态</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>合并冲突是一种令人生畏的经历。幸运的是，Git 提供了功能强大的工具来帮助浏览和解决冲突。Git 具备自动合并功能，可以自行处理大部分合并工作。当两个不同的分支对文件的同一行进行了编辑，或者一个分支删除了文件，而另一个分支却编辑了文件时，就会产生冲突。在团队环境中工作时，冲突最有可能发生。</p>
<p>有很多工具可以帮助解决合并冲突。我们在这里讨论的 Git 命令行工具就有很多。有关这些工具的详细信息，请访问 git log、git reset、git status、git checkout 和 git reset 的独立页面。除了 Git 之外，许多第三方工具也提供简化的合并冲突支持功能。</p>
<hr>
<h2 id="merge-strategy"><a href="#merge-strategy" class="headerlink" title="merge strategy"></a>merge strategy</h2><p>当一项工作完成、经过测试并准备并回开发主线时，你的团队需要做出一些策略选择。你有哪些合并策略选择？在本文中，我们将探讨各种可能性，然后提供一些有关 Atlassian 运行方式的说明。希望最后你能掌握一些工具来决定什么最适合你的团队。</p>
<h3 id="Git-merge-strategies"><a href="#Git-merge-strategies" class="headerlink" title="Git merge strategies"></a>Git merge strategies</h3><p>合并两个分支时。Git 会获取两个（或更多）提交指针，并试图在它们之间找到一个共同的基础提交。Git 有几种不同的方法来寻找基础提交，这些方法被称为 “合并策略”。一旦 Git 找到了共同的基础提交，它就会创建一个新的 “合并提交”，把指定合并提交的改动合并在一起。从技术上讲，合并提交是一个普通提交，只是恰好有两个父提交。</p>
<p>除非明确指定，否则<code>git merge</code>会自动选择合并策略。<code>git merge</code> 和 <code>git pull</code> 命令可以通过一个<code>-s</code>（策略）选项。<code>-s</code>选项可以附加所需的合并策略名称。如果没有明确指定，Git 会根据提供的分支选择最合适的合并策略。以下是可用的</p>
<h4 id="Recursive"><a href="#Recursive" class="headerlink" title="Recursive"></a>Recursive</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge -s recursive branch1 branch2</span><br></pre></td></tr></table></figure>

<p>这是在两个分支上进行的操作。在拉取或合并一个分支时，递归是默认的合并策略。此外，它还能检测并处理涉及重命名的合并，但目前还不能使用检测到的副本。在拉取或合并一个分支时，这是默认的合并策略。</p>
<h4 id="Resolve"><a href="#Resolve" class="headerlink" title="Resolve"></a>Resolve</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge -s resolve branch1 branch2</span><br></pre></td></tr></table></figure>

<p>这只能使用三向合并算法解决两个<code>head</code>的问题。它能仔细地检测出交叉合并的模糊之处，一般被认为是安全和快速的。</p>
<h4 id="Octopus"><a href="#Octopus" class="headerlink" title="Octopus"></a>Octopus</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge -s octopus branch1 branch2 branch3 branchN</span><br></pre></td></tr></table></figure>

<p>两个以上分支的默认合并策略。如果合并中出现需要手动解决的冲突，<code>octopus</code>将拒绝合并尝试。它主要用于将类似功能的分支头捆绑在一起。</p>
<h4 id="Ours"><a href="#Ours" class="headerlink" title="Ours"></a>Ours</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge -s ours branch1 branch2 branchN</span><br></pre></td></tr></table></figure>

<p>我们的策略在多个 N 个分支上运行。输出的合并结果总是当前分支 HEAD 的结果。我们的 “<code>Ours</code>“一词意味着优先选择当前分支而有效忽略所有其他分支的所有更改。它的目的是用于合并相似特性分支的历史记录。</p>
<h4 id="Subtree"><a href="#Subtree" class="headerlink" title="Subtree"></a>Subtree</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge -s subtree branchA branchB</span><br></pre></td></tr></table></figure>

<p>这是递归策略的扩展。在合并 A 和 B 时，如果 B 是 A 的子树，则首先更新 B 以反映 A 的树结构，同时也更新 A 和 B 共享的共同祖先树。</p>
<h3 id="递归的-git-merge策略选项"><a href="#递归的-git-merge策略选项" class="headerlink" title="递归的 git merge策略选项"></a>递归的 git merge策略选项</h3><p>上文介绍的 “递归 “策略有自己的附加操作选项子集。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ours</span><br></pre></td></tr></table></figure>

<p>不要与 “<code>Ours</code>“合并策略混淆。该选项通过偏向’<code>our</code>‘版本来自动解决冲突。如果不冲突，’<code>theirs</code>‘一方的改动会自动合并。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">theirs</span><br></pre></td></tr></table></figure>

<p>与 “<code>Ours</code>“战略相反，”<code>theirs</code>“方案在解决冲突时更倾向于外部合并分支。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patience</span><br></pre></td></tr></table></figure>

<p>此选项花费额外的时间来避免不重要的匹配行的错误合并。当要合并的分支极度分歧时，最好使用此选项。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diff-algorithim</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ignore-*</span><br><span class="line"></span><br><span class="line">    ignore-space-change</span><br><span class="line">    ignore-all-space</span><br><span class="line">    ignore-space-at-eol</span><br><span class="line">    ignore-cr-at-eol</span><br></pre></td></tr></table></figure>

<p>一组针对空白字符的选项。任何与所传选项子集匹配的行都将被忽略。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">renormalize</span><br></pre></td></tr></table></figure>

<p>该选项在解决三向合并的同时，对所有 git 树进行签出和签入。该选项适用于合并不同签入/签出状态的分支。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no-normalize</span><br></pre></td></tr></table></figure>

<p>禁用<code>renormalize</code>一化选项。这将覆盖<code>merge.renormalize</code>配置变量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no-renames</span><br></pre></td></tr></table></figure>

<p>该选项将在合并过程中忽略重命名的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find-renames&#x3D;n</span><br></pre></td></tr></table></figure>

<p>这是默认行为。递归合并将遵循文件重命名。该<code>n</code>参数可用于传递重命名相似性的阈值。默认<code>n</code>值为<code>100%.</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subtree</span><br></pre></td></tr></table></figure>

<p>该选项借鉴了 <code>subtree</code> 策略。该策略对两棵树进行操作，并修改如何使它们在共享祖先上匹配，而该选项则对树的路径元数据进行操作，使它们匹配。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>强烈倾向于使用显式合并。原因很简单：显式合并可为被合并的特性提供很好的可追溯性和上下文。在共享特性分支供审核之前进行本地历史清理重置是绝对值得鼓励的，但这根本不会改变政策。它只是对政策的补充。</p>
<h1 id="比较-Git-工作流程"><a href="#比较-Git-工作流程" class="headerlink" title="比较 Git 工作流程"></a>比较 Git 工作流程</h1><p>Git 是当今最常用的版本控制系统。Git 工作流程是如何使用 Git 以一致、高效的方式完成工作的秘诀或建议。Git 工作流程鼓励开发人员和 DevOps 团队有效、一致地使用 Git。Git 为用户管理变更提供了很大的灵活性。鉴于 Git 注重灵活性，因此在如何与 Git 互动方面并没有标准化的流程。在与团队合作开发 Git 管理的项目时，确保团队就如何应用变更流程达成一致非常重要。为确保团队意见一致，应制定或选择一个约定俗成的 Git 工作流程。有几种公开的 Git 工作流程可能很适合您的团队。在此，我们将讨论其中一些 Git 工作流程选项。</p>
<p>在工作场所实施 Git 时，可能会因为工作流程繁多而不知从何下手。本页通过调查软件团队最常见的 Git 工作流程，为您提供一个起点。</p>
<p>在阅读过程中，请记住这些工作流程只是指南，而非具体规则。我们希望向你展示各种可能，因此你可以根据自己的需求，混合搭配不同工作流程的各个环节。</p>
<h2 id="什么是成功的-Git-工作流？"><a href="#什么是成功的-Git-工作流？" class="headerlink" title="什么是成功的 Git 工作流？"></a>什么是成功的 Git 工作流？</h2><p>在为团队评估工作流程时，最重要的是考虑团队文化。您希望工作流程能提高团队效率，而不是成为限制工作效率的负担。评估 Git 工作流程时需要考虑以下几点</p>
<ul>
<li>该工作流程是否可根据团队规模进行扩展？</li>
<li>该工作流程是否容易撤销错误？</li>
<li>该工作流程是否会给团队带来新的不必要的认知开销？</li>
</ul>
<h2 id="集中式工作流程"><a href="#集中式工作流程" class="headerlink" title="集中式工作流程"></a>集中式工作流程</h2><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-centralized-workflow-2x.png" style="zoom:50%;" />

<p>对于从 SVN 过渡而来的团队来说，集中式工作流是一个很好的 Git 工作流。与 Subversion 类似，集中式工作流使用一个中央仓库作为项目所有变更的单一入口。默认的开发分支不是<code>trunk</code>，而是<code>main</code>，所有变更都提交到该分支。除<code>main</code>外，该工作流程不需要其他分支。</p>
<p>过渡到分布式版本控制系统看似是一项艰巨的任务，但你不必改变现有的工作流程，就能充分利用 Git 的优势。你的团队可以像使用 Subversion 一样开发项目。</p>
<p>不过，与 SVN 相比，使用 Git 支持开发工作流程有一些优势。首先，它为每个开发人员提供了整个项目的本地副本。这种隔离的环境让每个开发人员都能独立工作，不受项目中所有其他改动的影响–他们可以将提交添加到本地存储库，并完全忘记上游开发，直到对他们来说方便为止。</p>
<p>其次，它还能让你使用 Git 强大的分支和合并模型。与 SVN 不同，Git 分支的设计是一种安全可靠的机制，用于整合代码并在不同版本库之间共享变更。集中式工作流与其他工作流类似，都是利用远程服务器端托管的仓库，由开发人员推拉形成。与其他工作流相比，集中式工作流没有定义拉取请求或分叉模式。集中式工作流通常更适合从 SVN 迁移到 Git 的团队和规模较小的团队。</p>
<h2 id="How-it-works-3"><a href="#How-it-works-3" class="headerlink" title="How it works"></a>How it works</h2><p>开发人员从克隆中央版本库开始。在他们自己的项目本地副本中，他们编辑文件并提交更改，就像使用 SVN 一样；不过，这些新提交的内容都存储在本地，与中心版本库完全隔离。这样，开发人员就可以推迟向上游同步，直到达到方便的中断点。</p>
<p>要向正式项目发布变更，开发人员需要将本地主分支 “推送 “到中央版本库。这就相当于 <code>svn commit</code>，只不过它添加的是中心主分支中还没有的所有本地提交。</p>
<h3 id="初始化中央存储库"><a href="#初始化中央存储库" class="headerlink" title="初始化中央存储库"></a>初始化中央存储库</h3><p>首先，需要有人在服务器上创建中央资源库。如果是新项目，可以初始化一个空仓库。否则，就需要导入现有的 Git 或 SVN 仓库。</p>
<p>中心仓库应始终是裸仓库（不应有工作目录），创建方法如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh user@host git init --bare /path/to/repo.git</span><br></pre></td></tr></table></figure>

<p>用户名请务必使用有效的 SSH 用户名，主机请使用服务器的域名或 IP 地址，<code>/path/to/repo.git</code> 请使用存储 <code>repo</code> 的位置。请注意，<code>.git</code> 扩展名通常会附加到版本库名称上，以表明这是一个裸版本库。</p>
<h3 id="托管中央存储库"><a href="#托管中央存储库" class="headerlink" title="托管中央存储库"></a>托管中央存储库</h3><p>中心仓库通常是通过第三方 Git 托管服务（如 Bitbucket Cloud）创建的。托管服务会为你处理上述初始化裸仓库的过程。托管服务会为中央仓库提供一个地址，以便从本地仓库访问。</p>
<h3 id="克隆中央存储库"><a href="#克隆中央存储库" class="headerlink" title="克隆中央存储库"></a>克隆中央存储库</h3><p>接下来，每个开发人员都要创建整个项目的本地副本。这是通过 <code>git clone</code> 命令完成的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> ssh://user@host/path/to/repo.git</span><br></pre></td></tr></table></figure>

<p>当你克隆一个仓库时，Git 会自动添加一个名为 <code>origin</code> 的快捷方式，该快捷方式会指向 “父 “仓库，前提是你还想继续与它交互。</p>
<h3 id="更改并提交"><a href="#更改并提交" class="headerlink" title="更改并提交"></a>更改并提交</h3><p>仓库克隆到本地后，开发人员就可以使用标准的 Git 提交流程进行修改：编辑、暂存和提交。如果你对暂存区还不熟悉，它是一种准备提交的方法，而不必包含工作目录中的所有改动。这样，即使本地改动很多，也能创建高度集中的提交。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git status <span class="comment"># View the state of the repo</span></span><br><span class="line">git add &lt;some-file&gt; <span class="comment"># Stage a file</span></span><br><span class="line">git commit <span class="comment"># Commit a file&lt;/some-file&gt;</span></span><br></pre></td></tr></table></figure>

<p>请记住，由于这些命令创建的是本地提交，所以 John 可以随意重复这个过程，而不必担心中央版本库中的情况。这对于需要分解成更简单、更原子化的大功能来说非常有用。</p>
<h3 id="将新提交推送到中央版本库"><a href="#将新提交推送到中央版本库" class="headerlink" title="将新提交推送到中央版本库"></a>将新提交推送到中央版本库</h3><p>一旦本地版本库提交了新的变更。这些变更需要推送给项目中的其他开发人员共享。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin main</span><br></pre></td></tr></table></figure>

<p>该命令将把新提交的变更推送到中央版本库。在向中央仓库推送变更时，可能会出现之前推送的其他开发者的更新包含的代码与计划推送的更新冲突的情况。Git 会输出一条信息来说明这种冲突。在这种情况下，首先需要执行 <code>git pull</code>。这种冲突情况将在下一节中详述。</p>
<h3 id="管理冲突"><a href="#管理冲突" class="headerlink" title="管理冲突"></a>管理冲突</h3><p>中央仓库代表着正式项目，因此它的提交历史应该被视为神圣不可侵犯的。如果开发者的本地提交与中央仓库有出入，Git 会拒绝推送他们的改动，因为这会覆盖官方提交。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/manage-confilct-2x.png" style="zoom:50%;" />

<p>开发人员在发布自己的功能之前，需要获取更新后的中央提交，并将自己的更改重新加载到中央提交之上。这就好比在说：”我想把我的改动添加到其他人已经完成的改动中”。结果就是一个完美的线性历史，就像传统的 SVN 工作流程一样。</p>
<p>如果本地改动与上游提交直接冲突，Git 会暂停重定向过程，给你一个手动解决冲突的机会。Git 的好处在于，它使用相同的 <code>git status</code> 和 <code>git add</code> 命令来生成提交和解决合并冲突。这让新开发者可以轻松管理自己的合并。此外，如果他们遇到麻烦，Git 还能让他们很容易地中止整个重置过程，然后再试一次（或者去寻求帮助）。</p>
<hr>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>让我们以一个典型的小型团队如何使用此工作流程进行协作为例。我们将看到两个开发人员，John和Mary，如何在不同的功能上工作，并通过一个集中的资源库共享他们的贡献。</p>
<h3 id="John致力于他的特色功能"><a href="#John致力于他的特色功能" class="headerlink" title="John致力于他的特色功能"></a>John致力于他的特色功能</h3><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/john-and-his-feature.png" style="zoom:50%;" />

<p>在他的本地存储库中，John 可以使用标准 Git 提交流程来开发功能：编辑、暂存和提交。</p>
<p>请记住，由于这些命令创建本地提交，John 可以根据需要多次重复此过程，而不必担心中央存储库中发生的情况。</p>
<h3 id="Mary致力于她的特色功能"><a href="#Mary致力于她的特色功能" class="headerlink" title="Mary致力于她的特色功能"></a>Mary致力于她的特色功能</h3><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/marry-and-his-feature.png" style="zoom:50%;" />

<p>与此同时，玛丽正在自己的本地版本库中使用相同的编辑/阶段/提交流程开发自己的功能。和约翰一样，她并不关心中央版本库中发生了什么，她也真的不关心约翰在本地版本库中做了什么，因为所有的本地版本库都是私有的。</p>
<h3 id="John推送他的工作内容"><a href="#John推送他的工作内容" class="headerlink" title="John推送他的工作内容"></a>John推送他的工作内容</h3><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/john-push-feature-2x.png" style="zoom:50%;" />

<p>一旦约翰完成了他的功能，他就应该把本地提交发布到中央仓库，这样其他团队成员就可以访问它了。他可以使用 <code>git push</code> 命令这样做：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin main</span><br></pre></td></tr></table></figure>

<p>记住，<code>origin</code> 是约翰克隆中央仓库时 Git 创建的与中央仓库的远程连接。<code>main</code> 参数告诉 Git 尽量让 <code>origin</code> 的主分支看起来像他本地的主分支。由于中心仓库在约翰克隆后没有更新过，这不会导致任何冲突，推送也会如期进行。</p>
<h3 id="Mary推送他的工作内容"><a href="#Mary推送他的工作内容" class="headerlink" title="Mary推送他的工作内容"></a>Mary推送他的工作内容</h3><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/marry-push-fail-2x.png" style="zoom:50%;" />

<p>让我们看看如果 Mary 在 John 成功将其更改发布到中心版本库后尝试推送她的功能会发生什么。她可以使用完全相同的推送命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin main</span><br></pre></td></tr></table></figure>

<p>但是，由于她的本地历史已经偏离了中央仓库，Git 会拒绝该请求，并给出一条相当冗长的错误信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">error: failed to push some refs to <span class="string">&#x27;/path/to/repo.git&#x27;</span></span><br><span class="line">hint: Updates were rejected because the tip of your current branch is behind</span><br><span class="line">hint: its remote counterpart. Merge the remote changes (e.g. <span class="string">&#x27;git pull&#x27;</span>)</span><br><span class="line">hint: before pushing again.</span><br><span class="line">hint: See the <span class="string">&#x27;Note about fast-forwards&#x27;</span> <span class="keyword">in</span> <span class="string">&#x27;git push --help&#x27;</span> <span class="keyword">for</span> details.</span><br></pre></td></tr></table></figure>

<p>这就防止了 Mary 覆盖官方提交。她需要将 John 的更新拉入自己的版本库，与本地变更整合，然后再试一次。</p>
<h3 id="Mary在John提交的基础上进行Rebase"><a href="#Mary在John提交的基础上进行Rebase" class="headerlink" title="Mary在John提交的基础上进行Rebase"></a>Mary在John提交的基础上进行Rebase</h3><p>Mary 可以使用 <code>git pull</code> 将上游的改动整合到自己的版本库中。这个命令有点像 svn update–它会把整个上游提交历史拉入 Mary 的本地仓库，并尝试将其与本地提交整合在一起：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull --rebase origin main</span><br></pre></td></tr></table></figure>

<p>如下所示，<code>--rebase</code> 选项会告诉 Git 将 Mary 的所有提交与中心仓库的改动同步后移到主分支的顶端：</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/mary-git-pull-rebase-2x.png" style="zoom:50%;" />

<p>如果忘记了这个选项，<code>pull</code>仍然可以正常工作，但每次有人需要与中央版本库同步时，就会出现一个多余的“merge commit”。在这种工作流程中，最好是<code>rebase</code>而不是生成merge commit。</p>
<h3 id="Mary解决了合并冲突"><a href="#Mary解决了合并冲突" class="headerlink" title="Mary解决了合并冲突"></a>Mary解决了合并冲突</h3><p><code>Rebasing</code>的工作原理是将每个本地提交逐一转移到更新后的主分支。这意味着你可以逐个提交地捕捉合并冲突，而不是在一次大规模的合并提交中解决所有冲突。这样就能让提交尽可能集中，使项目历史更加清晰。反过来，这也更容易找出引入错误的地方，并在必要时回滚更改，将对项目的影响降到最低。</p>
<p>重置的工作原理是将每个本地提交逐一转移到更新后的主分支。这意味着你可以逐个提交地捕捉合并冲突，而不是在一次大规模的合并提交中解决所有冲突。这样就能让提交尽可能集中，使项目历史更加清晰。反过来，这也更容易找出引入错误的地方，并在必要时回滚更改，将对项目的影响降到最低。</p>
<p>如果 Mary 和 John 正在开发不相关的功能，<code>Rebasing</code>过程不太可能产生冲突。但如果发生冲突，Git 会在当前提交处暂停重置，并输出以下信息和相关说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFLICT (content): Merge conflict in &lt;some-file&gt;</span><br></pre></td></tr></table></figure>

<p>Git 的好处在于，任何人都可以解决自己的合并冲突。在我们的例子中，Mary 只需运行 <code>git status</code> 就能看到问题所在。有冲突的文件会出现在未合并路径部分：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Unmerged paths:</span></span><br><span class="line"><span class="comment"># (use &quot;git reset HEAD &lt;some-file&gt;...&quot; to unstage)</span></span><br><span class="line"><span class="comment"># (use &quot;git add/rm &lt;some-file&gt;...&quot; as appropriate to mark resolution)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># both modified: &lt;some-file&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后，她会按照自己的喜好编辑文件。一旦她对结果感到满意，就可以按照通常的方式对文件进行暂存，然后让 <code>git rebase</code> 完成剩下的工作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git add &lt;some-file&gt;</span><br><span class="line">git rebase --<span class="built_in">continue</span></span><br></pre></td></tr></table></figure>

<p>仅此而已。Git 会继续下一次提交，并对产生冲突的其他提交重复上述过程。</p>
<p>如果到了这一步，你发现自己完全不知道发生了什么，也不用惊慌。只要执行以下命令，就能回到起点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase --abort</span><br></pre></td></tr></table></figure>

<h4 id="Mary成功推送他的特色功能"><a href="#Mary成功推送他的特色功能" class="headerlink" title="Mary成功推送他的特色功能"></a>Mary成功推送他的特色功能</h4><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/mary-success-push-2x.png" style="zoom:50%;" />

<p>完成与中央版本库的同步后，玛丽就能成功发布她的更改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin main</span><br></pre></td></tr></table></figure>

<h2 id="何去何从？"><a href="#何去何从？" class="headerlink" title="何去何从？"></a>何去何从？</h2><p>如你所见，只需使用少量 Git 命令，就能复制传统的 Subversion 开发环境。这对于从 SVN 过渡到 Git 的团队来说是个不错的选择，但它并不能充分利用 Git 的分布式特性。</p>
<p>集中式工作流程非常适合小型团队。上文详述的冲突解决流程会随着团队规模的扩大而形成瓶颈。如果你的团队对集中式工作流程感到满意，但又想简化协作流程，那就绝对值得探索特性分支工作流程的好处。通过为每个功能指定一个独立的分支，可以在将新添加功能整合到正式项目之前发起深入讨论。</p>
<h2 id="其他常见工作流程"><a href="#其他常见工作流程" class="headerlink" title="其他常见工作流程"></a>其他常见工作流程</h2><p>集中式工作流本质上是其他 Git 工作流的构件。大多数流行的 Git 工作流程都会有某种集中式仓库，供开发人员推拉使用。下面我们将简要讨论一些其他流行的 Git 工作流程。这些扩展工作流在管理功能开发、热修复和最终发布的分支方面提供了更专业的模式。</p>
<h3 id="功能分支"><a href="#功能分支" class="headerlink" title="功能分支"></a>功能分支</h3><p>功能分支是集中式工作流程的逻辑延伸。特性分支工作流背后的核心理念是，所有特性开发都应在专用分支而非主分支中进行。这种封装方式可以让多个开发人员在不影响主代码库的情况下，轻松完成某个特定功能的开发。这也意味着主分支永远不会包含损坏的代码，这对于持续集成环境来说是一个巨大的优势。</p>
<h3 id="Gitflow-工作流程"><a href="#Gitflow-工作流程" class="headerlink" title="Gitflow 工作流程"></a>Gitflow 工作流程</h3><p>Gitflow 工作流最早发表于 nvie 的 Vincent Driessen 于 2010 年发表的一篇备受推崇的博文中。Gitflow 工作流定义了一种严格的分支模型，以项目发布为中心进行设计。除了特性分支工作流所需的内容外，该工作流没有添加任何新的概念或命令。相反，它为不同的分支分配了非常具体的角色，并定义了它们之间的交互方式和时间。</p>
<h3 id="分叉工作流程"><a href="#分叉工作流程" class="headerlink" title="分叉工作流程"></a>分叉工作流程</h3><p>分叉工作流与本教程中讨论的其他工作流有本质区别。它不使用单一的服务器端仓库作为 “中心 “代码库，而是为每个开发者提供一个服务器端仓库。这意味着每个贡献者拥有的不是一个，而是两个 Git 仓库：一个私有的本地仓库和一个公共的服务器端仓库。</p>
<h2 id="指南"><a href="#指南" class="headerlink" title="指南"></a>指南</h2><p>没有放之四海而皆准的 Git 工作流程。如前所述，开发一套能提高团队工作效率的 Git 工作流程非常重要。除了团队文化，工作流程还应该与企业文化相辅相成。分支和标签等 Git 功能应与企业的发布计划相辅相成。如果您的团队正在使用任务跟踪项目管理软件，您可能希望使用与进行中的任务相对应的分支。此外，在决定工作流程时还应考虑以下准则：</p>
<h3 id="短期分支"><a href="#短期分支" class="headerlink" title="短期分支"></a>短期分支</h3><p>分支与生产分支分离的时间越长，合并冲突和部署挑战的风险就越高。生命周期较短的分支能促进更简洁的合并和部署。</p>
<h3 id="最大限度减少和简化还原"><a href="#最大限度减少和简化还原" class="headerlink" title="最大限度减少和简化还原"></a>最大限度减少和简化还原</h3><p>重要的是要有一个工作流程，帮助主动防止合并后必须进行还原。在将分支合并到主分支之前对其进行测试的工作流程就是一个例子。然而，意外总会发生。尽管如此，拥有一个允许轻松还原且不会扰乱其他团队成员工作流程的工作流程还是很有好处的。</p>
<h3 id="与发布时间计划相匹配"><a href="#与发布时间计划相匹配" class="headerlink" title="与发布时间计划相匹配"></a>与发布时间计划相匹配</h3><p>工作流程应与企业的软件开发发布周期相辅相成。如果您计划每天发布多次版本，就需要保持主分支的稳定。如果发布频率较低，则可以考虑使用 Git 标签将分支标记为版本。</p>
<hr>
<h1 id="Git-功能分支工作流"><a href="#Git-功能分支工作流" class="headerlink" title="Git 功能分支工作流"></a>Git 功能分支工作流</h1><p>特性分支工作流程的核心理念是，所有特性开发都应在专用分支而非main中进行。这种封装方式可以让多个开发人员在不影响主代码库的情况下，轻松完成某个特定功能的开发。这也意味着<code>main</code>永远不会包含损坏的代码，这对于持续集成环境来说是一个巨大的优势。</p>
<p>封装功能开发还可以利用拉取请求，这是一种围绕分支发起讨论的方式。拉取请求是围绕分支发起讨论的一种方式，它让其他开发人员有机会在功能集成到正式项目之前对其进行签字确认。或者，如果你被某个功能卡住了，也可以打开拉取请求，征求同事的建议。关键是，拉取请求能让团队成员非常容易地对彼此的工作发表评论。</p>
<p>Git 功能分支工作流是一个可组合的工作流，可被其他高级 Git 工作流利用。我们在 Git 工作流程概览页面讨论了其他 Git 工作流程。Git 特性分支工作流专注于分支模型，也就是说，它是一个管理和创建分支的指导框架。其他工作流程则更侧重于仓库。Git 特性分支工作流可以并入其他工作流。传统上，Gitflow 和 Git f分叉工作流都使用 Git 特性分支工作流作为分支模型。</p>
<h2 id="How-it-works-4"><a href="#How-it-works-4" class="headerlink" title="How it works"></a>How it works</h2><p>功能分支工作流程假定有一个中央存储库，主分支代表正式的项目历史。开发人员每次开始开发新功能时，都会创建一个新的分支，而不是直接在本地主分支上提交。特性分支应有描述性的名称，如 animated-menu-items 或 issue-#1061。这样做的目的是让每个分支都有一个清晰、高度集中的目的。Git 在技术上不区分主分支和特性分支，因此开发者可以对特性分支进行编辑、阶段化和提交修改。</p>
<p>此外，特性分支还可以（也应该）推送到中心仓库。这样，开发人员就可以在不接触任何正式代码的情况下与其他开发人员共享某个特性。由于主分支是唯一的 “特殊 “分支，因此在中心版本库中存储多个特性分支不会造成任何问题。当然，这也是备份每个人的本地提交的便捷方法。下面是一个特性分支的生命周期。</p>
<h3 id="从主分支开始"><a href="#从主分支开始" class="headerlink" title="从主分支开始"></a>从主分支开始</h3><p>所有特性分支都是根据项目的最新代码状态创建的。本指南假定这是在主分支中维护和更新的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">git fetch origin </span><br><span class="line">git reset --hard origin/main</span><br></pre></td></tr></table></figure>

<h3 id="创建存储库"><a href="#创建存储库" class="headerlink" title="创建存储库"></a>创建存储库</h3><p>这会将 repo 切换到主分支，提取最新提交，并重置 repo 的本地 main 副本以匹配最新版本。</p>
<h3 id="创建新分支"><a href="#创建新分支" class="headerlink" title="创建新分支"></a>创建新分支</h3><p>为每个功能或问题创建一个单独的分支。创建分支后，在本地签出它，这样你所做的任何更改都会在该分支上进行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b new-feature</span><br></pre></td></tr></table></figure>

<p>这会基于 main 检查出一个名为 new-feature 的分支，而 <code>-b</code> 标志会告诉 Git 如果该分支还不存在，就创建它。</p>
<h3 id="更新、添加、提交和推送更改"><a href="#更新、添加、提交和推送更改" class="headerlink" title="更新、添加、提交和推送更改"></a>更新、添加、提交和推送更改</h3><p>在该分支上，按常规方式编辑、暂存和提交修改，根据需要提交尽可能多的改动。像任何时候使用 Git 一样，对功能进行修改和提交。准备就绪后，推送您的提交，更新 Bitbucket 上的功能分支。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br><span class="line">git add &lt;some-file&gt;</span><br><span class="line">git commit</span><br></pre></td></tr></table></figure>

<h3 id="向远程推送功能分支"><a href="#向远程推送功能分支" class="headerlink" title="向远程推送功能分支"></a>向远程推送功能分支</h3><p>将特性分支推送到中央版本库是个好主意。这可以作为一个方便的备份，在与其他开发人员协作时，可以让他们查看对新分支的提交。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push -u origin new-feature</span><br></pre></td></tr></table></figure>

<p>该命令会将 new-feature 推送到远程中央仓库（<code>origin</code>），而 <code>-u</code> 标志会将其添加为远程跟踪分支。设置好跟踪分支后，就可以调用 <code>git push</code>，无需任何参数，自动将 new-feature 分支推送到中心仓库。要获得对新特性分支的反馈，可在 Bitbucket Cloud 或 Bitbucket Data Center 等版本库管理解决方案中创建一个拉取请求。在那里，你可以添加审核员，并在合并前确保一切顺利。</p>
<h3 id="解决反馈"><a href="#解决反馈" class="headerlink" title="解决反馈"></a>解决反馈</h3><p>现在，队友们可以评论并批准推送的提交。在本地解决他们的意见，提交并将建议的修改推送到 Bitbucket。您的更新就会出现在拉取请求中。</p>
<h3 id="合并您的拉取请求"><a href="#合并您的拉取请求" class="headerlink" title="合并您的拉取请求"></a>合并您的拉取请求</h3><p>在合并之前，如果其他人对 repo 进行了修改，你可能需要解决合并冲突。当你的拉取请求被批准且无冲突后，你就可以把代码添加到主分支中了。从 Bitbucket 中的拉取请求进行合并。</p>
<p>除了隔离功能开发外，分支还能通过拉取请求讨论变更。一旦有人完成了一项功能，他们不会立即将其合并到主分支中。相反，他们会将功能分支推送到中心服务器，并提交拉取请求，要求将他们添加的内容合并到主分支中。这样，其他开发人员就有机会在修改成为主代码库的一部分之前对其进行审查。</p>
<p>代码审查是拉取请求的一个主要优点，但实际上拉取请求的设计初衷是作为一种谈论代码的通用方式。你可以把拉取请求看作是专门针对某个分支的讨论。这意味着拉取请求也可以在开发过程的更早阶段使用。例如，如果开发人员在某个功能上需要帮助，他们只需提交拉取请求即可。相关人员会自动收到通知，并能在相关提交旁边看到问题。</p>
<p>一旦拉取请求被接受，发布功能的实际操作与集中式工作流程中的操作大致相同。首先，你需要确保本地主目录与上游主目录同步。然后，将特性分支合并到主版本中，并将更新后的主版本推送回中央版本库。</p>
<p>Bitbucket Cloud 或 Bitbucket Server 等产品仓库管理解决方案可为拉取请求提供便利。查看 Bitbucket Server 拉取请求文档，了解示例。</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>下面是一个使用功能分支工作流程的示例。该场景是一个团队围绕新功能拉取请求进行代码审查。这只是该模型多种用途中的一个例子。</p>
<h3 id="玛丽开始了一项新功能"><a href="#玛丽开始了一项新功能" class="headerlink" title="玛丽开始了一项新功能"></a>玛丽开始了一项新功能</h3><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/mary-new-feature-2x.png" style="zoom:50%;" />

<p>在开始开发功能之前，Mary 需要一个独立的分支来工作。她可以使用以下命令申请一个新分支：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b marys-feature main</span><br></pre></td></tr></table></figure>

<p>这样就在 main 分支的基础上签出了一个名为 marys-feature 的分支，而 -b 标志则告诉 Git 如果该分支还不存在，就创建它。在这个分支上，Mary 按常规方式进行编辑、暂存和提交，并根据需要提交尽可能多的改动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br><span class="line">git add &lt;some-file&gt;</span><br><span class="line">git commit</span><br></pre></td></tr></table></figure>

<h3 id="玛丽去吃午饭"><a href="#玛丽去吃午饭" class="headerlink" title="玛丽去吃午饭"></a>玛丽去吃午饭</h3><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/mary-go-to-lauch-2x.png" style="zoom:50%;" />

<p>玛丽在一上午的时间里为她的功能添加了一些提交。在她离开去吃午饭之前，最好把她的功能分支推送到中央仓库。这可以作为方便的备份，但如果 Mary 与其他开发人员协作，这也会让他们访问她的初始提交。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push -u origin marys-feature</span><br></pre></td></tr></table></figure>

<p>这条命令会将 marys-feature 推送到中心仓库（origin），而 <code>-u</code> 标志会将其添加为远程跟踪分支。设置好跟踪分支后，Mary 可以不加任何参数地调用 <code>git push</code> 来推送她的功能。</p>
<h3 id="玛丽完成她的特色分支"><a href="#玛丽完成她的特色分支" class="headerlink" title="玛丽完成她的特色分支"></a>玛丽完成她的特色分支</h3><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/mary-finish-feature-2x.png" style="zoom:50%;" />

<p>当 Mary 吃完午饭回来时，她完成了她的功能。在将其合并到主仓库之前，她需要提交一个拉取请求，让团队其他成员知道她已经完成了。但首先，她要确保中央仓库中有她的最新提交：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push</span><br></pre></td></tr></table></figure>

<p>然后，她在 Git GUI 中提交拉取请求，要求将 marys-feature 合并到 main 中，团队成员就会自动收到通知。拉取请求的好处在于，它们会在相关提交的旁边显示注释，因此很容易就能提出有关特定变更集的问题。</p>
<h3 id="Bill收到拉取请求"><a href="#Bill收到拉取请求" class="headerlink" title="Bill收到拉取请求"></a>Bill收到拉取请求</h3><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/bill-pull-request-2x.png" style="zoom:50%;" />

<p>比尔收到<code>pull</code>请求并查看了 marys-feature。他决定在将其整合到正式项目之前做一些修改，于是他和玛丽通过<code>pull</code>请求进行了一些来回交流。</p>
<h3 id="玛丽进行更改"><a href="#玛丽进行更改" class="headerlink" title="玛丽进行更改"></a>玛丽进行更改</h3><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/mary-makes-changes-2x.png" style="zoom:50%;" />

<p>为了进行更改，Mary 采用了与创建第一个功能迭代完全相同的流程。她进行编辑、暂存、提交，并将更新推送到中央版本库。她的所有活动都会显示在pull请求中，而Bill仍然可以在整个过程中发表评论。</p>
<p>如果Bill愿意，他可以将 marys-feature 拉入他的本地版本库，然后自己继续工作。他添加的任何提交也会显示在pull请求中。</p>
<h3 id="玛丽发布特色功能"><a href="#玛丽发布特色功能" class="headerlink" title="玛丽发布特色功能"></a>玛丽发布特色功能</h3><p>一旦Bill准备好接受<code>pull</code>请求，就需要有人将该功能合并到稳定项目中（这可以由Bill或Mary完成）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">git pull</span><br><span class="line">git pull origin marys-feature</span><br><span class="line">git push</span><br></pre></td></tr></table></figure>

<p>这一过程通常会导致合并提交。有些开发人员喜欢这样做，因为这就像是将特性与代码库的其他部分象征性地结合在一起。不过，如果你偏爱线性历史，也可以在执行合并之前将特性重置到 <code>main</code> 的顶端，从而实现快进合并。</p>
<p>有些图形用户界面会自动执行拉取请求接受流程，只需点击 “<code>Accept</code> “按钮即可运行所有这些命令。如果你的 GUI 没有这样做，它至少能在特性分支合并到主分支时自动关闭拉取请求。</p>
<p>与此同时，John也在做着同样的事情。</p>
<p>当Mary和Bill在研究 marys-feature 并在她的拉取请求中进行讨论时，John正在他自己的特性分支中做着完全相同的事情。通过将特性功能隔离到不同的分支中，每个人都可以独立工作，但在必要时与其他开发人员共享变更仍是轻而易举的事。</p>
<h2 id="Summary-4"><a href="#Summary-4" class="headerlink" title="Summary"></a>Summary</h2><p>在本文档中，我们讨论了 Git 功能分支工作流程。该工作流有助于组织和跟踪专注于业务领域功能集的分支。其他 Git 工作流，如 Git Forking 工作流和 Gitflow 工作流，都是以 repo 为中心的，可以利用 Git 功能分支工作流来管理它们的分支模型。本文档演示了用于实现 Git 功能分支工作流的高级代码示例和虚构示例。与功能分支工作流程建立的一些关键关联是：</p>
<ul>
<li> 专注于分支模式</li>
<li>可被其他面向仓库的工作流程利用</li>
<li>通过拉取请求和合并审查促进与团队成员的协作</li>
</ul>
<p>在功能分支的审核和合并阶段使用<code>git rebase</code>，可以创建一个有凝聚力的 Git 历史记录。功能分支模型是促进团队协作的绝佳工具。</p>
<hr>
<h1 id="Gitflow-工作流"><a href="#Gitflow-工作流" class="headerlink" title="Gitflow 工作流"></a>Gitflow 工作流</h1><p><code>Gitflow</code> 是一种传统的 Git 工作流程，最初是一种管理 Git 分支的颠覆性新策略。如今，<code>Gitflow</code> 已不再受欢迎，而基于主干的工作流程已被视为现代持续软件开发和 <code>DevOps</code> 实践的最佳实践。在 <code>CI/CD</code> 中使用 <code>Gitflow</code> 也很有挑战性。本文章将详细介绍 <code>Gitflow</code> 的历史。</p>
<h2 id="什么是-Gitflow？"><a href="#什么是-Gitflow？" class="headerlink" title="什么是 Gitflow？"></a>什么是 Gitflow？</h2><p><code>Gitflow</code> 是另一种 Git 分支模式，包括使用特性分支和多个主分支。它由 nvie 网站的 Vincent Driessen 首次发布并流行开来。与基于主干的开发模式相比，<code>Gitflow</code> 的分支数量多、寿命长、提交量大。在这种模式下，开发人员创建一个特性分支，并推迟将其合并到主干分支，直到特性完成。这些生命周期较长的特性分支需要更多协作才能合并，偏离主干分支的风险也更高。它们还可能带来相互冲突的更新。</p>
<p><code>Gitflow</code> 可用于有计划发布周期的项目和 <code>DevOps</code> 最佳实践–持续交付。除特性分支工作流程外，该工作流程不添加任何新概念或命令。相反，它为不同的分支分配了非常具体的角色，并定义了它们应该如何以及何时进行交互。除了功能分支，它还使用单个分支来准备、维护和记录发布。当然，您还可以利用特性分支工作流的所有优点：拉取请求、隔离实验和更高效的协作。</p>
<h2 id="How-it-works-5"><a href="#How-it-works-5" class="headerlink" title="How it works"></a>How it works</h2><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/gitflow-workflow-2x.png" style="zoom:50%;" />

<h3 id="开发和主要分支"><a href="#开发和主要分支" class="headerlink" title="开发和主要分支"></a>开发和主要分支</h3><p>这种工作流程使用两个分支来记录项目的历史，而不是一个<code>main</code>分支。<code>main</code>分支存储正式发布的历史，而开发分支则作为功能的集成分支。在<code>main</code>分支中的所有提交都标上版本号也很方便。</p>
<p>第一步是用 <code>develop</code> 分支来补充默认的 <code>main</code> 分支。一个简单的方法是由一名开发人员在本地创建一个空的 <code>develop</code> 分支，然后推送到服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git branch develop</span><br><span class="line">git push -u origin develop</span><br></pre></td></tr></table></figure>

<p>该分支将包含项目的完整历史，而主分支将包含简略版本。其他开发者现在应该克隆中央仓库，并为 <code>develop</code> 创建一个跟踪分支。</p>
<p>使用 git-flow 扩展库时，在现有仓库上执行 <code>git flow init</code> 将创建 <code>develop</code> 分支：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ git flow init</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Initialized empty Git repository <span class="keyword">in</span> ~/project/.git/</span><br><span class="line">No branches exist yet. Base branches must be created now.</span><br><span class="line">Branch name <span class="keyword">for</span> production releases: [main]</span><br><span class="line">Branch name <span class="keyword">for</span> <span class="string">&quot;next release&quot;</span> development: [develop]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">How to name your supporting branch prefixes?</span><br><span class="line">Feature branches? [feature/]</span><br><span class="line">Release branches? [release/]</span><br><span class="line">Hotfix branches? [hotfix/]</span><br><span class="line">Support branches? [support/]</span><br><span class="line">Version tag prefix? []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ git branch</span><br><span class="line">* develop</span><br><span class="line"> main</span><br></pre></td></tr></table></figure>

<h2 id="功能分支-1"><a href="#功能分支-1" class="headerlink" title="功能分支"></a>功能分支</h2><h3 id="步骤-1-创建存储库"><a href="#步骤-1-创建存储库" class="headerlink" title="步骤 1. 创建存储库"></a>步骤 1. 创建存储库</h3><p>每个新功能都应该有自己的分支，可以推送到中央仓库进行备份/协作。但是， <code>feature</code> 分支不是从<code>main</code>分支中分离出来，而是将 <code>develop</code> 分支作为其父分支。当特性完成后，它会被合并回<code>develop</code> 分支。功能分支绝不能直接与<code>main</code>分支交互。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/gitflow-feature-banch-2x.png" style="zoom:50%;" />

<p>请注意， <code>feature</code> 分支与 <code>develop</code> 分支的结合，就是功能分支工作流程。但是，<code>Gitflow</code> 的工作流程并不止于此。</p>
<p> <code>feature</code> 分支通常是根据最新的 <code>develop</code> 分支创建的。</p>
<h3 id="创建功能分支"><a href="#创建功能分支" class="headerlink" title="创建功能分支"></a>创建功能分支</h3><p><strong>不使用 git-flow 扩展</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout develop</span><br><span class="line">git checkout -b feature_branch</span><br></pre></td></tr></table></figure>

<p><strong>使用 git-flow 扩展时</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git flow feature start feature_branch</span><br></pre></td></tr></table></figure>

<p>继续工作，像平常一样使用 Git。</p>
<h3 id="完成功能分支"><a href="#完成功能分支" class="headerlink" title="完成功能分支"></a>完成功能分支</h3><p>完成功能分支的开发工作后，下一步就是把 <code>feature_branch</code> 合并到 <code>develop</code> 中。</p>
<p>不使用 git-flow 扩展</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout develop</span><br><span class="line">git merge feature_branch</span><br></pre></td></tr></table></figure>

<p>使用 git-flow 扩展</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git flow feature finish feature_branch</span><br></pre></td></tr></table></figure>

<h3 id="发布分支"><a href="#发布分支" class="headerlink" title="发布分支"></a>发布分支</h3><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/release-banches.png" style="zoom:50%;" />

<p>一旦<code>develop</code>分支完成了足够的功能等待发布（或者预定的发布日期即将到来），就从 <code>develop</code>分支中分叉出一个 <code>release</code> 分支。创建该分支会启动下一个发布周期，因此在此之后就不能再添加新功能了，只有错误修复、文档生成和其他面向发布的任务应放在该分支中。一旦准备好发布，<code>release</code>分支就会被合并<code>main</code> 分支并标注版本号。此外，还应将其合并回<code>develop</code>分支，因为<code>develop</code>分支在发布分支后可能已经取得了进展。</p>
<p>使用专用分支来准备发布，可以让一个团队在完善当前发布的同时，让另一个团队继续为下一个发布开发功能。它还能创建定义明确的开发阶段（例如，可以轻松地说：”本周我们要准备 4.0 版”，并在版本库的结构中实际看到它）。</p>
<p>创建<code>release</code>分支是另一种直接的分支操作。与 <code>feature</code> 分支一样，<code>release</code>分支也基于 <code>develop</code> 分支。可以使用以下方法创建新的<code>release</code>分支。</p>
<p>不使用 git-flow 扩展：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout develop</span><br><span class="line">git checkout -b release/0.1.0</span><br></pre></td></tr></table></figure>

<p>使用 git-flow 扩展时：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git flow release start 0.1.0</span><br><span class="line">Switched to a new branch <span class="string">&#x27;release/0.1.0&#x27;</span></span><br></pre></td></tr></table></figure>

<p>一旦<code>release</code>版本准备就绪，就会将其合并到<code>main</code> 和<code>develop</code>分支中，然后删除<code>release</code>分支。合并回开发分支很重要，因为关键更新可能已添加到发布分支，它们需要能访问新功能。如果你的组织强调代码审查，这里将是拉取请求的理想位置。</p>
<p>要完成分支发布，可使用以下方法：</p>
<p>不使用 git-flow 扩展：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">git merge release/0.1.0</span><br></pre></td></tr></table></figure>

<p>或者使用 git-flow 扩展：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git flow release finish <span class="string">&#x27;0.1.0&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="热修复分支"><a href="#热修复分支" class="headerlink" title="热修复分支"></a>热修复分支</h2><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/hotfix-banches-2x.png" style="zoom:50%;" />

<p>维护或 “热修复 “分支用于快速修补生产版本。Hotfix 分支与 <code>release</code> 分支和 <code>feature</code> 分支很相似，只是它们基于 <code>main</code> 分支而不是 <code>develop</code>分支。这是唯一应该直接从<code>main</code>分支分叉出来的分支。修复完成后，应立即将其并入<code>main</code>分支和 <code>develop</code>分支（或当前的<code>release</code> 分支），并在<code>main</code>分支上标注更新的版本号。</p>
<p>为错误修复设置专门的开发线，可以让团队在不影响其他工作流程或等待下一个发布周期的情况下解决问题。你可以把维护分支看作是直接与主分支协同工作的临时发布分支。可以使用以下方法创建热修复分支：</p>
<p>不使用 git-flow 扩展：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">git checkout -b hotfix_branch</span><br></pre></td></tr></table></figure>

<p>使用 git-flow 扩展时：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git flow hotfix start hotfix_branch</span><br></pre></td></tr></table></figure>

<p>与完成<code>release</code>分支类似，<code>hotfix</code>分支会合并到<code>main</code> 分支和<code>develop</code>分支</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">git merge hotfix_branch</span><br><span class="line">git checkout develop</span><br><span class="line">git merge hotfix_branch</span><br><span class="line">git branch -D hotfix_branch</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git flow hotfix finish hotfix_branch</span><br></pre></td></tr></table></figure>

<h2 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h2><p>演示功能分支流程的完整示例如下。假设我们有一个包含<code>main</code>分支的版本库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">git checkout -b develop</span><br><span class="line">git checkout -b feature_branch</span><br><span class="line"><span class="comment"># work happens on feature branch</span></span><br><span class="line">git checkout develop</span><br><span class="line">git merge feature_branch</span><br><span class="line">git checkout main</span><br><span class="line">git merge develop</span><br><span class="line">git branch -d feature_branch</span><br></pre></td></tr></table></figure>

<p>除功能分支和发布分支流程外，热修复示例如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br><span class="line">git checkout -b hotfix_branch</span><br><span class="line"><span class="comment"># work is done commits are added to the hotfix_branch</span></span><br><span class="line">git checkout develop</span><br><span class="line">git merge hotfix_branch</span><br><span class="line">git checkout main</span><br><span class="line">git merge hotfix_branch</span><br></pre></td></tr></table></figure>

<p>这里我们讨论的是 Gitflow 工作流。Gitflow 是您和您的团队可以使用的多种 Git 工作流程之一。</p>
<p>了解 Gitflow 的一些要点如下:</p>
<ul>
<li>该工作流非常适合基于发布的软件工作流。</li>
<li>Gitflow 为热修复到生产提供了专用通道。</li>
</ul>
<p>Gitflow 的整体流程是:</p>
<ol>
<li><p>从 <code>main</code>分支创建一个 <code>develop</code> 分支</p>
</li>
<li><p>从 <code>develop</code>分支创建 <code>release</code> 分支</p>
</li>
<li><p>从 <code>develop</code>分支创建 <code>Feature</code> 分支</p>
</li>
<li><p> <code>feature</code> 完成后，合并到 <code>develop</code> 分支中</p>
</li>
<li><p> <code>release</code> 分支完成后，合并到 <code>develop</code> 分支和 <code>main</code>分支中</p>
</li>
<li><p>如果在 <code>main</code>分支中发现问题，就会从 <code>main</code>分支创建 <code>hotfix</code> 分支</p>
</li>
<li><p>一旦完成热修复，它就会被合并到 <code>develop</code> 分支和 <code>main</code>分支中</p>
</li>
</ol>
<hr>
<h1 id="Forking工作流"><a href="#Forking工作流" class="headerlink" title="Forking工作流"></a>Forking工作流</h1><p><code>Forking</code>工作流与其他流行的 Git 工作流有本质区别。它不使用单一的服务器端仓库作为 “中央 “代码库，而是让每个开发者都拥有自己的服务器端仓库。这意味着每个贡献者拥有的不是一个，而是两个 Git 仓库：一个私有的本地仓库和一个公共的服务器端仓库。<code>Forking Workflow</code>最常见于公共开源项目。</p>
<p> <code>Forking</code>工作流的主要优势在于，无需每个人都推送到一个中央仓库，就能整合贡献。开发人员推送到自己的服务器端版本库，只有项目维护者才能推送到官方版本库。这样，维护者就可以接受任何开发者的提交，而无需给予他们写入官方代码库的权限。</p>
<p>Forking工作流程通常遵循基于 Gitflow 工作流程的分支模型。这意味着完整的功能分支将被合并到原始项目维护者的仓库中。这样就形成了一个分布式工作流程，为大型有机团队（包括不受信任的第三方）提供了一种灵活的安全协作方式。这也使其成为开源项目的理想工作流程。 </p>
<h2 id="How-it-works-6"><a href="#How-it-works-6" class="headerlink" title="How it works"></a>How it works</h2><p>与其他 Git 工作流程一样，Forking Workflow也是从服务器上存储的官方公共仓库开始的。但当新的开发者想开始项目工作时，他们不会直接克隆官方仓库。</p>
<p>相反，他们会分叉官方版本库，在服务器上创建一个副本。这个新副本将作为他们的个人公共仓库–其他开发者不得向其推送，但他们可以从中提取修改（稍后我们将了解这一点的重要性）。创建完服务器端副本后，开发人员会执行<code>git clone</code>将其复制到本地计算机上。就像其他工作流程一样，这也是他们的私人开发环境。</p>
<p>当他们准备好发布本地提交时，就会把提交推送到自己的公共仓库–而不是官方仓库。然后，他们向主版本库提交拉取请求，让项目维护者知道更新已准备好集成。如果贡献的代码有问题，拉取请求还可以作为方便的讨论线程。下面是这一工作流程的分步示例。</p>
<ol>
<li>开发者 “forks”一个 “官方”服务器端版本库。这将创建他们自己的服务器端副本</li>
<li>将新的服务器端副本克隆到他们的本地系统</li>
<li>将 “官方 “仓库的 Git 远程路径添加到本地克隆中</li>
<li>创建新的本地特性分支</li>
<li>开发人员对新分支进行修改</li>
<li>为更改创建新提交</li>
<li> 分支会被推送到开发者自己的服务器端副本</li>
<li>开发人员从新分支向 “官方 “版本库打开拉取请求</li>
<li>拉取请求被批准合并，并被合并到原来的服务器端版本库中</li>
</ol>
<p>要将功能集成到正式代码库中，维护者会将贡献者的修改拉入本地版本库，检查确保不会破坏项目，将其合并到本地主分支，然后将主分支推送到服务器上的正式版本库。现在，该贡献已成为项目的一部分，其他开发人员应从官方版本库中提取，以同步他们的本地版本库。</p>
<p>重要的是要明白，在Forking工作流程中，”官方 “版本库的概念只是一种约定。事实上，官方版本库之所以如此官方，是因为它是项目维护者的公共版本库。</p>
<h2 id="Forking-vs-cloning"><a href="#Forking-vs-cloning" class="headerlink" title="Forking vs cloning"></a>Forking vs cloning</h2><p>需要注意的是，”forked”仓库和”forking”都不是特殊的操作。Forked仓库是使用标准的<code>git clone</code>命令创建的。分叉仓库一般是 “服务器端克隆”，通常由第三方 Git 服务（如 Bitbucket）管理和托管。创建分叉仓库没有唯一的 Git 命令。克隆操作本质上是复制一个仓库及其历史。</p>
<h2 id="Forking-工作流程中的分支"><a href="#Forking-工作流程中的分支" class="headerlink" title="Forking 工作流程中的分支"></a>Forking 工作流程中的分支</h2><p>所有这些个人公共仓库实际上只是一种与其他开发者共享分支的便捷方式。就像特性分支工作流和 Gitflow 工作流一样，每个人都应该继续使用分支来隔离单个特性。唯一的区别在于如何共享这些分支。在Forking工作流中，它们会被拉入其他开发者的本地版本库，而在特性分支和 Gitflow 工作流中，它们会被推送到官方版本库。</p>
<h2 id="Fork-a-repository"><a href="#Fork-a-repository" class="headerlink" title="Fork a repository"></a>Fork a repository</h2><p>所有加入 Forking Workflow 项目的新开发者都需要 fork 官方仓库。如前所述，fork只是一个标准的<code>git clone</code>操作。可以通过 SSH 登录服务器，然后运行<code>git clone</code>将其复制到服务器上的另一个位置。流行的 Git 托管服务（如 Bitbucket）提供的版本库fork功能可自动完成这一步骤。</p>
<h2 id="Clone-your-fork"><a href="#Clone-your-fork" class="headerlink" title="Clone your fork"></a>Clone your fork</h2><p>假设使用 Bitbucket 托管这些版本库，项目中的开发人员就应该拥有自己的 Bitbucket 账户，并克隆他们fork的版本库副本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://user@bitbucket.org/user/repo.git</span><br></pre></td></tr></table></figure>

<h2 id="Adding-a-remote"><a href="#Adding-a-remote" class="headerlink" title="Adding a remote"></a>Adding a remote</h2><p>其他 Git 工作流使用一个指向中央仓库的 <code>origin</code> 远程地址，而分叉工作流则需要两个远程地址–一个指向官方仓库，另一个指向开发者的个人服务器端仓库。虽然你可以随心所欲地调用这些远程地址，但常见的惯例是使用 <code>origin</code> 作为分叉仓库的远程地址（运行 <code>git clone</code> 时会自动创建），而使用 <code>upstream</code> 作为官方仓库的远程地址。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add upstream https://bitbucket.org/maintainer/repo</span><br></pre></td></tr></table></figure>

<p>您需要使用上述命令自行创建<code>upstream</code>远程仓库。这样你就能轻松地随着官方项目的进展更新本地版本库。请注意，如果你的<code>upstream</code>版本库启用了身份验证（即它不是开源的），你就需要提供一个用户名，就像这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add upstream https://user@bitbucket.org/maintainer/repo.git</span><br></pre></td></tr></table></figure>

<p>这要求用户在克隆或拉取官方代码库之前提供有效的密码。</p>
<h2 id="Working-in-a-branch-making-amp-pushing-changes"><a href="#Working-in-a-branch-making-amp-pushing-changes" class="headerlink" title="Working in a branch: making &amp; pushing changes"></a>Working in a branch: making &amp; pushing changes</h2><p>在开发人员的分叉存储库的本地副本中，他们可以编辑代码、提交更改并创建分支，就像在其他 Git 工作流程中一样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b some-feature <span class="comment"># Edit some code git commit -a -m &quot;Add first draft of some feature&quot;</span></span><br></pre></td></tr></table></figure>

<p>他们的所有更改都将完全私有，直到他们将其推送到公共存储库为止。而且，如果官方项目已经向前推进，他们可以使用 <code>git pull</code> 访问新的提交：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull upstream main</span><br></pre></td></tr></table></figure>

<p>由于开发人员应该在专用的功能分支中工作，因此这通常会导致快进合并。</p>
<h2 id="Making-a-pull-request"><a href="#Making-a-pull-request" class="headerlink" title="Making a pull request"></a>Making a pull request</h2><p>一旦开发人员准备好分享他们的新功能，他们需要做两件事。首先，他们必须将自己的贡献推送到公共仓库，让其他开发者也能访问。他们的远程源应该已经设置好了，所以他们只需做以下几件事</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin feature-branch</span><br></pre></td></tr></table></figure>

<p>这与其他工作流程的不同之处在于，origin remote指向开发者的个人服务器端版本库，而不是主代码库。</p>
<p>其次，他们需要通知项目维护者，他们想把自己的功能合并到官方代码库中。Bitbucket 提供了一个 “pull request”按钮，点击后会弹出一个表单，要求你指定要将哪个分支合并到正式版本库中。通常情况下，你会希望将你的功能分支整合到上游远程的<code>main</code>分支中。</p>
<h2 id="Summary-5"><a href="#Summary-5" class="headerlink" title="Summary"></a>Summary</h2><p>简而言之，<code>Forking</code>工作流程常用于公共开源项目。<code>Forking</code>是在项目 repo 的服务器副本上执行的<code>git clone</code>操作。<code>Forking</code>工作流程通常与 Bitbucket 等 Git 托管服务结合使用。<code>Forking</code>工作流程的一个高级示例是</p>
<ol>
<li><p>您想为一个托管在 bitbucket.org/userA/open-project 的开源库作出贡献</p>
</li>
<li><p>使用 Bitbucket 创建一个 repo 的 fork 到 bitbucket.org/YourName/open-project</p>
</li>
<li><p>在本地系统上执行 git clone on <a target="_blank" rel="noopener" href="https://bitbucket.org/YourName/open-project">https://bitbucket.org/YourName/open-project</a> 以获得该 repo 的本地副本</p>
</li>
<li><p>在本地仓库中创建一个新的 <code>feature</code> 分支</p>
</li>
<li><p>完成新功能的工作，并执行<code>git commit</code>保存更改</p>
</li>
<li><p>然后将新 <code>feature</code> 分支推送到远程forked仓库</p>
</li>
<li><p>使用 Bitbucket，在 bitbucket.org/userA/open-project 上针对原 repo 打开新分支的拉取请求。</p>
</li>
</ol>
<p>Forking工作流能帮助项目维护者向任何开发者开放版本库，而无需手动管理每个贡献者的授权设置。这就为维护者提供了更多 “pull”式的工作流程。Forking工作流最常用于开源项目，也可用于私有业务工作流，以便对合并到发布版本中的内容进行更权威的控制。这对于有部署经理或严格发布周期的团队非常有用。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/01/18/git-%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="wotzc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cai">
      <meta itemprop="description" content="真正的大师永远都怀着一颗学徒的心">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cai">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/18/git-%E6%95%99%E7%A8%8B/" class="post-title-link" itemprop="url">git详细教程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-01-18 15:10:19" itemprop="dateCreated datePublished" datetime="2024-01-18T15:10:19+08:00">2024-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-29 17:25:48" itemprop="dateModified" datetime="2024-03-29T17:25:48+08:00">2024-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/" itemprop="url" rel="index"><span itemprop="name">版本控制</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p><code>Git</code> 是一个免费的开源版本控制系统，最初由 <code>Linus Torvalds</code> 于 2005 年创建。与 SVN 和 CVS 等旧的集中式版本控制系统不同，<code>Git</code> 是分布式的：每个开发人员都在本地拥有其代码存储库的完整历史记录。这使得存储库的初始克隆速度变慢，但后续操作（例如提交、责备、比较、合并和日志）速度显着加快。</p>
<p><code>Git</code> 还对分支、合并和重写存储库历史提供出色的支持，这导致了许多创新且强大的工作流程和工具。Pull 请求是一种流行的工具，它允许团队在 <code>Git</code> 分支上进行协作并有效地审查彼此的代码。<code>Git</code> 是当今世界上使用最广泛的版本控制系统，被认为是软件开发的现代标准。</p>
<h1 id="工作流"><a href="#工作流" class="headerlink" title="工作流"></a>工作流</h1><p>你的本地仓库由 git 维护的三棵“树”组成。第一个是你的 <code>工作目录</code>，它持有实际文件；第二个是 <code>暂存区（Index）</code>，它像个缓存区域，临时保存你的改动；最后是 <code>HEAD</code>，它指向你最后一次提交的结果。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/Git%20Diagram.svg" style="zoom:50%;" />

<p><strong>Git 目录</strong>（位于 <code>YOUR-PROJECT-PATH/.git/</code> 中）是 Git 存储准确跟踪项目所需的所有内容的位置。这些内容包括元数据和一个对象数据库，其中包含项目文件的压缩版本。</p>
<p><strong>工作目录</strong>是用户在本地对项目进行更改的地方。工作目录从 <code>Git</code> 目录的对象数据库中提取项目的文件，并将其放置在用户的本地计算机上。</p>
<p><strong>暂存区</strong>是一个文件，用于存储下一次 <code>commit</code> 内容的信息。“commit” 的意思是你告诉 Git 保存暂存区的更改。 Git 照原样拍摄文件快照，并将该快照永久存储在 Git 目录中。</p>
<p>在三个部分中，文件可以在任何给定时间处于三种主要状态：<code>提交</code>，<code>修改</code>或<code>暂存</code>。在工作目录中对文件进行<strong>修改</strong>，然后，将其移至暂存区进行<strong>暂存</strong>，最后，<code>commit</code> 提交文件。</p>
<p><strong>以下是 Git 工作的基本概述：</strong></p>
<ol>
<li>使用 git 托管工具（如 <code>Bitbucket</code>）创建一个“存储库”（项目）</li>
<li>将远程存储库复制（或克隆）到本地计算机</li>
<li>将文件<code>add</code>到本地存储库并<code>commit</code>（保存）更改</li>
<li>将您的更改<code>push</code>到您的主分支</li>
<li>使用 git 托管工具更改文件并提交</li>
<li>将更改<code>pull</code>到本地计算机</li>
<li>创建“分支”（版本），进行更改，提交更改</li>
<li>打开“拉取请求”（建议对主分支进行更改）</li>
<li>将您的分支“合并”到主分支</li>
</ol>
<hr>
<h1 id="设置存储库"><a href="#设置存储库" class="headerlink" title="设置存储库"></a>设置存储库</h1><h2 id="git-init"><a href="#git-init" class="headerlink" title="git init"></a>git init</h2><p><code>git init</code> 命令会创建一个新的 Git 仓库。它可以用来将一个现有的、未版本控制的项目转换为 Git 仓库，也可以用来初始化一个新的、空的仓库。大多数其他 Git 命令在初始化仓库之前都不可用，所以这通常是在新项目中运行的第一个命令。</p>
<p>执行 <code>git init</code> 会在当前工作目录下创建一个 <code>.git</code> 子目录，其中包含新仓库所需的所有 Git 元数据。这些元数据包括对象、引用和模板文件的子目录。此外，还会创建一个 <code>HEAD</code> 文件，它是一个指向当前已签出分支或提交的指针，其中包含特定时间内整个代码库的不可更改快照。无论 HEAD 直接（使用哈希值）或通过引用（使用分支）引用哪个提交，它始终都是本地更改所依据的提交。</p>
<p>除了项目根目录中的 <code>.git</code> 目录外，现有项目不会被改动（与 SVN 不同，Git 并不要求每个子目录中都有 .git 子目录）。</p>
<p>默认情况下，<code>git init</code> 会将 Git 配置初始化为 .<code>git</code> 子目录路径。如果你想把子目录放在其他地方，可以修改或自定义子目录路径。你可以将 <code>$GIT_DIR</code> 环境变量设置为自定义路径，这样 <code>git init</code> 就会在那里初始化 Git 配置文件。此外，你还可以通过<code>--separate-git-dir</code>参数来达到同样的效果。</p>
<p>与 SVN 相比，该<code>git init</code>命令是创建新版本控制项目的极其简单的方法。Git 不需要您创建存储库、导入文件和签出工作副本。此外，Git 不需要任何预先存在的服务器或管理员权限。您所要做的就是 cd 进入您的项目子目录并运行<code>git init</code>，您将拥有一个功能齐全的 Git 存储库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></table></figure>

<p>将当前目录转换为 Git 存储库。这会向当前目录创建一个<code>.git</code>子目录，并可以开始记录项目的修订。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init &lt;directory&gt;</span><br></pre></td></tr></table></figure>

<p>在指定目录下创建一个空的 Git 仓库。运行此命令将创建一个名为 <code>＜directory＞</code> 的新子目录，其中只包含 <code>.git</code> 子目录。</p>
<p>如果已经在某个项目目录下运行过 <code>git init</code>，且其中包含 <code>.git</code> 子目录，那么可以放心地在同一项目目录下再次运行 git init。它不会覆盖现有的 <code>.git</code> 配置。</p>
<h2 id="git-clone"><a href="#git-clone" class="headerlink" title="git clone"></a>git clone</h2><h3 id="目的：repo-to-repo协作开发副本"><a href="#目的：repo-to-repo协作开发副本" class="headerlink" title="目的：repo-to-repo协作开发副本"></a>目的：repo-to-repo协作开发副本</h3><p>如果一个项目已经在中央仓库已建立，<code>git clone</code> 命令是用户获取开发副本的最常用方法。与 <code>git init</code> 一样，<code>git clone</code> 通常也是一次性操作。开发人员获得工作副本后，所有版本控制操作和协作都将通过本地仓库进行管理。</p>
<p>要知道，Git 的 “工作副本 “与从 SVN 仓库中签出代码所得到的工作副本是完全不同的。与 SVN 不同，Git 不区分工作副本和中央仓库，它们都是完整的 Git 仓库。</p>
<p>这就使得使用 Git 与使用 SVN 进行协作有了本质区别。SVN 依赖于中心仓库和工作副本之间的关系，而 Git 的协作模式则基于仓库与仓库之间的交互。你不需要把工作副本检查到 SVN 的中心仓库，而是从一个仓库推送或拉取提交到另一个仓库。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/central-repo.png" style="zoom:50%;" />

<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/repo-to-repo.png" style="zoom:50%;" />

<p><code>git clone</code> 主要用于指向现有存储库，并在另一个位置的新目录中克隆或复制该存储库。 原始存储库可以位于本地文件系统或远程计算机可访问的支持协议上。 <code>git clone</code> 命令复制现有的 Git 存储库。 这有点像 SVN <code>checkout</code>，只不过“工作副本”是一个成熟的 Git 存储库——它有自己的历史记录，管理自己的文件，并且是与原始存储库完全隔离的环境。</p>
<p>为了方便起见，克隆会自动创建一个名为<code>“origin”</code>的远程连接，指向原始存储库。 这使得与中央存储库交互变得非常容易。 这种自动连接是通过配置在<code>refs/remotes/origin</code>下的<code>remote.origin.url</code>和<code>remote.origin.fetch</code> 变量来建立对远程分支头的 Git 引用。</p>
<p>下面的示例演示了如何获取存储在可使用 SSH 用户名 john 访问的服务器上的中央存储库的本地副本：<code>git clone</code> <code>example.com</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> ssh://john@example.com/path/to/my-project.git </span><br><span class="line"><span class="built_in">cd</span> my-project </span><br><span class="line"><span class="comment"># Start working on the project</span></span><br></pre></td></tr></table></figure>

<p>第一条命令是在本地计算机的 my-project 文件夹中初始化一个新的 Git 仓库，并将中央仓库的内容填充到其中。您可以 cd 进入项目并开始编辑文件、提交快照以及与其他存储库交互。还要注意的是，克隆仓库中省略了 <code>.git</code> 扩展名。这反映了本地副本的非裸状态。</p>
<h3 id="clone到特定文件夹"><a href="#clone到特定文件夹" class="headerlink" title="clone到特定文件夹"></a>clone到特定文件夹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> &lt;repo&gt; &lt;directory&gt;</span><br></pre></td></tr></table></figure>

<p>将位于 <code>＜repo＞</code> 的版本库克隆到本地计算机上名为 <code>＜directory＞</code> 的文件夹中。</p>
<h3 id="clone特定标签"><a href="#clone特定标签" class="headerlink" title="clone特定标签"></a>clone特定标签</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --branch &lt;tag&gt; &lt;repo&gt;</span><br></pre></td></tr></table></figure>

<p>克隆位于 <code>＜repo＞</code> 的资源库，并只克隆 <code>＜tag＞</code> 的 <code>ref</code>。</p>
<h3 id="clone特定分支"><a href="#clone特定分支" class="headerlink" title="clone特定分支"></a>clone特定分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --branch</span><br></pre></td></tr></table></figure>

<p>通过 <code>-branch</code> 参数，你可以指定要克隆的特定分支，而不是远程 <code>HEAD</code> 指向的分支(通常是主分支)。此外，你还可以传递一个 <code>tag</code> 来代替分支，以达到同样的效果。</p>
<h3 id="Git-URL-协议"><a href="#Git-URL-协议" class="headerlink" title="Git URL 协议"></a>Git URL 协议</h3><h4 id="SSH"><a href="#SSH" class="headerlink" title="-SSH"></a>-SSH</h4><p><code>Secure Shell</code> (SSH) 是一种普遍存在的经过身份验证的网络协议，大多数服务器上通常默认配置该协议。由于 SSH 是一种经过身份验证的协议，因此您需要在连接之前与托管服务器建立凭据。</p>
<h4 id="GIT"><a href="#GIT" class="headerlink" title="- GIT"></a>- GIT</h4><p><code>git</code> 独有的协议。Git 自带一个守护进程，运行端口为 (9418)。该协议与<code>SSH</code>类似，但没有身份验证。</p>
<h4 id="HTTP"><a href="#HTTP" class="headerlink" title="- HTTP"></a>- HTTP</h4><p>超文本传输协议。Web 协议，最常用于通过 Internet 传输网页 HTML 数据。Git 可以配置为通过<code>HTTP</code>进行通信</p>
<hr>
<h2 id="git-config"><a href="#git-config" class="headerlink" title="git config"></a>git config</h2><p><code>git config</code> 命令是一个方便的功能，用于在全局或本地项目级别设置 Git 配置值。这些配置级别与 <code>.gitconfig</code> 文本文件相对应。执行 <code>git config</code> 会修改配置文本文件。</p>
<p>我们将讨论常见的配置设置，如电子邮件、用户名和编辑器。我们还将讨论 Git 别名，它允许你为常用的 Git 操作创建快捷方式。熟悉<code>git config</code>和各种 Git 配置设置，将有助于你创建强大的、个性化的 Git 工作流程。</p>
<p><code>git config</code> 最基本的用例是用一个配置名来调用它，从而显示该配置名下的设置值。配置名称是以点分隔的字符串。例如：<code>user.email</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config user.email</span><br></pre></td></tr></table></figure>

<p>查看配置文件中设置的所有变量，以及它们的值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --list</span><br></pre></td></tr></table></figure>

<h3 id="git-配置级别和文件"><a href="#git-配置级别和文件" class="headerlink" title="git 配置级别和文件"></a>git 配置级别和文件</h3><p>在进一步讨论<code>git config</code>的用法之前，我们先来了解一下配置级别。<code>git config</code>命令可以接受参数来指定操作的配置级别。以下是可用的配置级别：</p>
<ul>
<li><p><code>--local</code></p>
<p>默认情况下，如果没有通过配置选项，<code>git config</code>会写入本地级别。本地配置会应用到调用 git config 的上下文仓库。本地配置值保存在一个文件中，可以在 repo 的 .git 目录中找到：<code>.git/config</code></p>
</li>
<li><p><code>--global</code></p>
<p>全局配置是针对特定用户的，这意味着它适用于操作系统用户。全局配置值存储在用户主目录下的一个文件中。在 unix 系统中为 <code>~ /.gitconfig</code>，在 windows 系统中为 <code>C:\Users\\.gitconfig</code></p>
</li>
<li><p><code>--system</code></p>
<p>系统级配置适用于整个机器。这包括操作系统上的所有用户和所有版本库。系统级配置文件位于系统根目录下的 <code>gitconfig</code> 文件中。在 unix 系统中为 <code>$(prefix)/etc/gitconfig</code>。在 Windows XP 上，该文件位于 <code>C:\Documents and Settings\All Users\Application Data\Git\config</code> 下；在 Windows Vista 及更新版本上，该文件位于 <code>C:\ProgramData\Git\config</code> 下。</p>
</li>
</ul>
<p>因此，配置级别的优先顺序是：<code>local</code>、<code>global</code>、<code>system</code>。这意味着在查找配置值时，Git 会从本地层级开始，然后上升到系统层级。</p>
<h3 id="写一个配置项"><a href="#写一个配置项" class="headerlink" title="写一个配置项"></a>写一个配置项</h3><p>以我们已经了解的<code>git config</code>为基础，我们来看一个写值的例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.email <span class="string">&quot;your_email@example.com&quot;</span></span><br></pre></td></tr></table></figure>

<p>​    此示例将配置项<code>user.email</code>的值写为 <code>your_email@example.com</code> 。它使用了 <code>--global</code> 标志，因此该值是为当前操作系统用户设置的。</p>
<h3 id="git-配置编辑器-core-editor"><a href="#git-配置编辑器-core-editor" class="headerlink" title="git 配置编辑器 - core.editor"></a>git 配置编辑器 - core.editor</h3><p>许多 Git 命令都会启动一个文本编辑器，提示进一步输入。<code>git config</code>最常见的用例之一就是配置 Git 应该使用哪个编辑器。下面列出了常用的编辑器和与之匹配的 git 配置命令：</p>
<table>
<thead>
<tr>
<th align="left">编辑器</th>
<th align="center">配置命令</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Atom</code></td>
<td align="center"><code>~ git config --global core.editor &quot;atom --wait&quot;~</code></td>
</tr>
<tr>
<td align="left"><code>emacs</code></td>
<td align="center"><code>~ git config --global core.editor &quot;emacs&quot;~</code></td>
</tr>
<tr>
<td align="left"><code>nano</code></td>
<td align="center"><code>~ git config --global core.editor &quot;nano -w&quot;~</code></td>
</tr>
<tr>
<td align="left"><code>vim</code></td>
<td align="center"><code>~ git config --global core.editor &quot;vim&quot;~</code></td>
</tr>
<tr>
<td align="left"><code>Sublime Text (Mac)</code></td>
<td align="center"><code>~ git config --global core.editor &quot;subl -n -w&quot;~</code></td>
</tr>
<tr>
<td align="left"><code>Sublime Text (Win, 32-bit install)</code></td>
<td align="center"><code>~ git config --global core.editor &quot;&#39;c:/program files (x86)/sublime text 3/sublimetext.exe&#39; -w&quot;~</code></td>
</tr>
<tr>
<td align="left"><code>Sublime Text (Win, 64-bit install)</code></td>
<td align="center"><code>~ git config --global core.editor &quot;&#39;c:/program files/sublime text 3/sublimetext.exe&#39; -w&quot;~</code></td>
</tr>
<tr>
<td align="left"><code>Textmate</code></td>
<td align="center"><code>~ git config --global core.editor &quot;mate -w&quot;~</code></td>
</tr>
</tbody></table>
<h3 id="配置合并工具"><a href="#配置合并工具" class="headerlink" title="配置合并工具"></a>配置合并工具</h3><p>如果出现合并冲突，Git 会启动一个 “合并工具”。默认情况下，Git 使用的是通用 Unix diff 程序的内部实现。Git 内部的 diff 程序是最基本的合并冲突查看器。有许多外部第三方合并冲突解决工具可以替代它。有关各种合并工具和配置的概述，请参阅”<a target="_blank" rel="noopener" href="https://developer.atlassian.com/blog/2015/12/tips-tools-to-solve-git-conflicts/">tips and tools to resolve conflits with Git</a>“指南。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global merge.tool kdiff3</span><br></pre></td></tr></table></figure>

<h3 id="配置彩色输出"><a href="#配置彩色输出" class="headerlink" title="配置彩色输出"></a>配置彩色输出</h3><p>Git 支持彩色终端输出，有助于快速读取 Git 输出。你可以自定义 Git 输出，使用个性化的颜色主题。git config 命令用于设置这些颜色值。</p>
<p><code>color.ui</code>是 Git 颜色的主变量。设置为 <code>false</code> 将禁用所有 Git 彩色终端输出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global color.ui <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，<code>color.ui</code> 设置为<code>auto</code>，这将在直接终端输出流中应用颜色。如果输出流被重定向到文件或管道到其他进程，自动设置将省略颜色代码输出。</p>
<p>可以将 <code>color.ui</code> 值设置为<code>always</code>，这样在将输出流重定向到文件或管道时也会应用颜色代码输出。这可能会无意中造成问题，因为接收管道可能并不期待彩色编码输入。</p>
<h3 id="Git-颜色值"><a href="#Git-颜色值" class="headerlink" title="Git 颜色值"></a>Git 颜色值</h3><p>除了 <code>color.ui</code>，还有许多其他细粒度的颜色设置。与 <code>color.ui</code> 一样，这些颜色设置都可以设置为 <code>false</code>、<code>auto</code> 或 <code>always</code>。这些颜色设置还可以设置特定的颜色值。支持的颜色值举例如下</p>
<ul>
<li><code>normal</code></li>
<li><code>black</code></li>
<li><code>red</code></li>
<li><code>green</code></li>
<li><code>yellow</code></li>
<li><code>blue</code></li>
<li><code>magenta</code></li>
<li><code>cyan</code></li>
<li><code>white</code></li>
</ul>
<p>颜色也可以指定为十六进制颜色代码（如 <code>#ff0000</code>），或者 ANSI 256 颜色值（如果您的终端支持）。</p>
<ol>
<li><p><code>color.branch</code></p>
<p>配置 Git 分支命令的输出颜色</p>
</li>
<li><p><code>color.branch.</code>&lt;<code>slot</code>&gt; </p>
<ul>
<li>此值也适用于 Git 分支输出。<code>&lt;slot&gt;</code> 是以下选项之一：<ol>
<li><code>current</code>: 当前分支 </li>
<li><code>local</code>: 本地分支 </li>
<li><code>remote</code>: refs/remotes中的远程分支</li>
<li><code>upstream</code>: 上游跟踪分支 </li>
<li><code>plain</code>: 任何其他引用</li>
</ol>
</li>
</ul>
</li>
<li><p><code>color.diff</code></p>
<p>为 <code>git diff</code>、<code>git log</code> 和 <code>git show</code>命令 配置输出颜色</p>
</li>
<li><p><code>color.grep</code></p>
<p>为 <code>git grep</code> 的应用输出颜色。</p>
</li>
<li><p><code>color.showBranch</code> </p>
<p>启用或禁用<code>git show branch</code>命令的颜色输出</p>
</li>
<li><p><code>color.status</code> </p>
</li>
</ol>
<h3 id="Aliases-别名"><a href="#Aliases-别名" class="headerlink" title="Aliases-别名"></a>Aliases-别名</h3><p>你可能对操作系统命令行中的别名概念并不陌生；如果不熟悉，别名是一种自定义快捷方式，它定义了哪条命令将扩展为更长或更组合的命令。别名可以节省输入常用命令的时间和精力。Git 提供了自己的别名系统。Git 别名的一个常见用例是缩短提交命令。Git 别名存储在 Git 配置文件中。这意味着你可以使用 git config 命令来配置别名。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global alias.ci commit</span><br></pre></td></tr></table></figure>

<p>这个例子为 <code>commit</code> 命令创建了一个 <code>ci</code> 别名。然后你就可以通过执行 <code>git ci</code> 来调用 <code>git commit</code>。别名还可以引用其他别名来创建强大的组合。</p>
<hr>
<h2 id="git-alias"><a href="#git-alias" class="headerlink" title="git alias"></a>git alias</h2><p>本节将重点讨论 Git 别名。要更好地理解 Git 别名的价值，我们必须先讨论一下什么是别名。别名是快捷方式的同义词。</p>
<p>创建别名是其他流行工具（如 <code>bash</code> <code>shell</code>）的常见模式。别名用于创建可映射到较长命令的较短命令。别名可以减少执行命令所需的击键次数，从而提高工作流程的效率。</p>
<p>以 <code>git checkout</code> 命令为例。<code>checkout</code> 命令是一个频繁使用的 git 命令，随着时间的推移，按键次数会不断增加。我们可以创建一个别名，将 <code>git co</code> 映射到 <code>git checkout</code>，这样就可以用更短的按键形式：<code>git co</code> 代替，从而节省宝贵的人类指尖力量。</p>
<p>需要注意的是，没有直接的 <code>git alias</code> 命令。别名是通过使用 <code>git config</code> 命令和 Git 配置文件创建的。与其他配置值一样，别名可以在本地或全局范围内创建。</p>
<p>为了更好地理解 Git 别名，让我们举几个例子。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git config --global alias.co checkout</span><br><span class="line">$ git config --global alias.br branch</span><br><span class="line">$ git config --global alias.ci commit</span><br><span class="line">$ git config --global alias.st status</span><br></pre></td></tr></table></figure>

<p>前面的代码示例为常用的 git 命令创建了全局存储的快捷方式。创建别名不会修改源代码命令。因此，即使我们现在有了 <code>git co</code> 别名，<code>git checkout</code> 仍然可用。这些别名是使用 <code>--global</code> 标志创建的，这意味着它们将存储在 Git 的全局操作系统级配置文件中。在 Linux 系统中，全局配置文件位于用户主目录下的 <code>/.gitconfig</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">alias</span>]</span><br><span class="line">        co = checkout</span><br><span class="line">            br = branch</span><br><span class="line">            ci = commit</span><br><span class="line">            st = status</span><br></pre></td></tr></table></figure>

<h3 id="如何创建-Git-别名？"><a href="#如何创建-Git-别名？" class="headerlink" title="如何创建 Git 别名？"></a>如何创建 Git 别名？</h3><p>可以通过两种主要方法创建别名：</p>
<ol>
<li><p><strong>直接编辑 Git 配置文件</strong></p>
<p>可以手动编辑并保存全局或本地配置文件以创建别名。全局配置文件位于<code>$HOME/.gitconfig</code>文件路径中。本地路径位于活动 git 存储库中<code>/.git/config</code></p>
<p>配置文件将遵循如下所示的部分：<code>[alias]</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">alias</span>]</span><br><span class="line"> co = checkout</span><br></pre></td></tr></table></figure>
</li>
<li><h4 id="使用-git-config-创建别名"><a href="#使用-git-config-创建别名" class="headerlink" title="使用 git config 创建别名"></a>使用 git config 创建别名</h4><p>如前所述，<code>git config</code> 命令是快速创建别名的便捷工具。<code>git config</code>命令实际上是一个辅助工具，用于写入全局和本地 Git 配置文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global alias.co checkout</span><br></pre></td></tr></table></figure>

</li>
</ol>
<hr>
<h1 id="保存更改"><a href="#保存更改" class="headerlink" title="保存更改"></a>保存更改</h1><p>在 Git 或其他版本控制系统中工作时，”保存 “的概念要比在文字处理程序或其他传统文件编辑程序中的 “保存 “更为细微。传统软件中的 “保存 “与 Git 中的 “提交 “同义。提交相当于 Git 的 “保存”。传统的 “保存 “应被视为一种文件系统操作，用于覆盖现有文件或写入新文件。而 Git 的提交则是对文件和目录集合的操作。</p>
<p>在 Git 和 SVN 中保存更改也是一个不同的过程。SVN 提交或“签入”是远程推送到集中式服务器的操作。这意味着 SVN 提交需要互联网访问才能完全“保存”项目更改。Git 提交可以在本地捕获并建立，然后根据需要使用 <code>git push -u origin main</code> 命令推送到远程服务器。Git 是分布式应用模式，而 SVN 是集中式模式。分布式应用程序通常更健壮，因为它们不像集中式服务器那样存在单点故障。</p>
<p><code>git add</code>、<code>git status</code> 和 <code>git commit</code> 这几条命令结合使用，可以保存 Git 项目当前状态的快照。</p>
<p>Git 有一个额外的保存机制，做 “储藏库”。储藏室是一个短暂的存储区域，用于存储尚未提交的变更。储藏室在工作目录（三棵树中的第一棵）上运行，有很多使用选项。要了解更多信息，请访问 <a target="_blank" rel="noopener" href="https://www.atlassian.com/git/tutorials/saving-changes/git-stash">git stash</a> 页面。</p>
<p>Git 仓库可以配置为忽略特定文件或目录。这将阻止 Git 保存对忽略内容的修改。Git 有多种配置方法来管理忽略列表。关于 Git 忽略配置的更多详情，请参阅 <a target="_blank" rel="noopener" href="https://www.atlassian.com/git/tutorials/saving-changes/gitignore">git ignore</a> 页面。</p>
<h2 id="git-add"><a href="#git-add" class="headerlink" title="git add"></a>git add</h2><p><code>git add</code> 命令将工作目录中的改动添加到暂存区域。它告诉 Git，您想在下一次提交中包含对某个文件的更新。不过，<code>git add</code>并不会对版本库产生任何重大影响–直到运行 <code>git commit</code> 才会真正记录更改。</p>
<p>除了这些命令，你还需要使用 <code>git status</code> 来查看工作目录和暂存区域的状态。</p>
<h3 id="How-it-works"><a href="#How-it-works" class="headerlink" title="How it works"></a>How it works</h3><p><code>git add</code>和<code>git commit</code>命令构成了 Git 的基本工作流程。无论团队的协作模式如何，每个 Git 用户都需要了解这两个命令。它们是将项目版本记录到版本库历史中的手段。</p>
<p>项目开发围绕着基本的编辑/暂存/提交模式。首先，在工作目录中编辑文件。准备好保存一份项目当前状态的副本时，就用<code>git add</code>进行阶段性修改。对暂存的快照满意后，用<code>git commit</code>将其提交到项目历史中。<code>git reset</code>命令用于撤销提交或暂存快照</p>
<p>除了<code>git add</code> 和 <code>git commit</code>，第三个命令 <code>git push</code> 对于完整的 Git 协作工作流程也必不可少。<code>git push</code>用于将提交的更改发送到远程存储库以进行协作。这使得其他团队成员能够访问一组已保存的更改。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-push-2x.png" style="zoom:50%;" />

<h3 id="The-staging-area-暂存区"><a href="#The-staging-area-暂存区" class="headerlink" title="The staging area-暂存区"></a>The staging area-暂存区</h3><p><code>git add</code>命令的主要功能是将工作目录中的待处理更改推广到 git 暂存区域。暂存区是 Git 较为独特的功能之一，如果你来自 SVN（甚至 Mercurial）背景，可能需要一些时间来理解它。把它想象成工作目录和项目历史记录之间的缓冲区会有所帮助。暂存区与工作目录和提交历史一起被视为 Git 的 “三棵树”。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-three-tree-2x.png" style="zoom:50%;" />

<p>在提交到项目历史之前，暂存区可以让你把相关的改动归类为高度集中的快照，而不是提交上次提交后的所有改动。这意味着你可以对不相关的文件进行各种编辑，然后通过将相关变更添加到阶段并逐条提交，将它们分割成符合逻辑的提交。在任何版本控制系统中，创建原子提交都是很重要的，这样可以轻松跟踪错误，并在对项目其他部分影响最小的情况下还原更改。</p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add &lt;file&gt;</span><br></pre></td></tr></table></figure>

<p>暂存 <code>&lt;file&gt;</code> 中的所有更改，以便下一次提交。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add &lt;directory&gt;</span><br></pre></td></tr></table></figure>

<p>暂存目录 <code>&lt;directory&gt;</code> 中的所有更改，以便下一次提交。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add -p</span><br></pre></td></tr></table></figure>

<p>开始交互式暂存会话，让你选择文件的部分内容添加到下一次提交中。系统会显示一大段修改，并提示你输入命令。使用 <code>y</code> 可以暂存该修改块，使用 <code>n</code> 可以忽略该修改块，使用 <code>s</code> 可以将其分割成更小的修改块，使用 <code>e</code> 可以手动编辑该修改块，使用 <code>q</code> 可以退出。</p>
<p>在启动一个新项目时，<code>git add</code>的功能与 svn import 相同。要创建当前目录的初始提交，请使用以下两条命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>回顾一下，<code>git add</code> 是一系列操作中的第一个命令，它指示 Git 将当前项目状态的快照 “保存 “到提交历史中。单独使用时，<code>git add</code> 会将工作目录中的待定修改推进到暂存区域。<code>git status</code> 命令用于检查版本库的当前状态，并可用于确认 <code>git add</code> 的推送。<code>git reset</code> 命令用于撤销 <code>git add</code>。然后使用 <code>git commit</code> 命令将暂存目录的快照提交到版本库的提交历史中。</p>
<hr>
<h2 id="git-diff"><a href="#git-diff" class="headerlink" title="git diff"></a>git diff</h2><p>Diffing 是一个接收两个输入数据集并输出它们之间差异的函数。<code>git diff</code>是一条多用途 Git 命令，执行时会在 Git 数据源上运行差异函数。这些数据源可以是提交、分支、文件等。本文将讨论<code>git diff</code>的常见调用方式和差异化工作流程模式。<code>git diff</code>命令通常与<code>git status</code>和<code>git log</code>一起用于分析 Git 仓库的当前状态。</p>
<h3 id="读取差异：输出"><a href="#读取差异：输出" class="headerlink" title="读取差异：输出"></a>读取差异：输出</h3><ol>
<li><p><strong>比较输入</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/diff_test.txt b/diff_test.txt</span><br></pre></td></tr></table></figure>

<p>这一行显示 <code>diff</code> 的输入源。我们可以看到，<code>a/diff_test.txt</code> 和 <code>b/diff_test.txt</code> 已被传递给 <code>diff</code>。</p>
</li>
<li><p><strong>元数据</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index 6b0c6cf..b37e70a 100644</span><br></pre></td></tr></table></figure>

<p>这一行显示一些 Git 内部元数据。您很可能不需要这些信息。输出中的数字对应 Git 对象版本哈希标识符。</p>
</li>
<li><p><strong>变更标记</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--- a&#x2F;diff_test.txt</span><br><span class="line">+++ b&#x2F;diff_test.txt</span><br></pre></td></tr></table></figure>

<p>这是为每个差异输入源分配符号的案例。在本例中，来自文件 <code>a/diff_test.txt</code> 的变更用符号 <code>---</code> 标记，来自文件 <code>b/diff_test.txt</code> 的变更用符号 <code>+++</code> 标记。</p>
</li>
<li><p><strong>变更高亮</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff --color-words</span><br></pre></td></tr></table></figure>

<p><code>git diff</code> 还有一种特殊模式，能以更好的粒度高亮显示改动：<code>--color-words</code>。该模式用空白标记添加和删除的行，然后进行差异化。</p>
</li>
</ol>
<h3 id="比较文件：git-diff-file"><a href="#比较文件：git-diff-file" class="headerlink" title="比较文件：git diff file"></a>比较文件：git diff file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff HEAD ./path/to/file</span><br></pre></td></tr></table></figure>

<p>git diff 命令可以通过一个明确的文件路径选项。如果给<code>git diff</code>传递了一个文件路径，diff 操作就会作用于指定的文件。</p>
<p>此示例的作用域是 <code>./path/to/file</code>，调用时，它会将工作目录中的具体改动与索引进行比较，显示尚未暂存的改动。默认情况下，<code>git diff</code>会执行与<code>HEAD</code>的比较。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff --cached ./path/to/file</span><br></pre></td></tr></table></figure>

<p>当使用<code>--cached</code>选项调用<code>git diff</code>时，diff 会将已缓存的变更与本地版本库进行比较。<code>--cached</code>选项与<code>--staged</code>选项同义。</p>
<h3 id="比较所有变化"><a href="#比较所有变化" class="headerlink" title="比较所有变化"></a>比较所有变化</h3><p><code>git diff</code>命令不带文件路径的调用将比较整个存储库中的更改。上述文件特定示例可以在没有参数的情况下调用<code>./path/to/file</code>，并且在本地存储库中的所有文件中具有相同的输出结果。</p>
<h3 id="自上次提交以来的更改"><a href="#自上次提交以来的更改" class="headerlink" title="自上次提交以来的更改"></a>自上次提交以来的更改</h3><p>默认情况下，<code>git diff</code>将显示自上次提交以来所有未提交的更改。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff</span><br></pre></td></tr></table></figure>

<h3 id="比较两个不同提交之间的文件差异"><a href="#比较两个不同提交之间的文件差异" class="headerlink" title="比较两个不同提交之间的文件差异"></a>比较两个不同提交之间的文件差异</h3><p><code>git diff</code>可以将提交的 Git refs 传递给 diff。例如 HEAD、标签和分支名。Git 中的每个提交都有一个commit ID，执行<code>GIT LOG</code>命令时可以得到。您也可以将此commit ID 传递给<code>git diff</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --pretty=oneline</span><br><span class="line">957fbc92b123030c389bf8b4b874522bdf2db72c add feature</span><br><span class="line">ce489262a1ee34340440e55a0b99ea6918e19e7a rename some classes</span><br><span class="line">6b539f280d8b0ec4874671bae9c6bed80b788006 refactor some code <span class="keyword">for</span> feature</span><br><span class="line">646e7863348a427e1ed9163a9a96fa759112f102 add some copy to body</span><br><span class="line"></span><br><span class="line">$:&gt; git diff 957fbc92b123030c389bf8b4b874522bdf2db72c ce489262a1ee34340440e55a0b99ea6918e19e7a</span><br></pre></td></tr></table></figure>

<h3 id="比较分支"><a href="#比较分支" class="headerlink" title="比较分支"></a>比较分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff branch1..branch2</span><br></pre></td></tr></table></figure>

<p>本例介绍点运算符。示例中的两个点表示 diff 输入是两个分支的顶端。如果省略点，在分支之间使用空格，也会产生同样的效果。此外，还有一个三点操作符：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff branch1...branch2</span><br></pre></td></tr></table></figure>

<h2 id="比较两个分支的文件差异"><a href="#比较两个分支的文件差异" class="headerlink" title="比较两个分支的文件差异"></a>比较两个分支的文件差异</h2><p>要跨分支比较特定文件，请将文件的路径作为第三个参数传递给<code>git diff</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff main new_branch ./diff_test.txt</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="git-stash"><a href="#git-stash" class="headerlink" title="git stash"></a>git stash</h2><p><code>git stash</code>可以暂时搁置（或储藏）您对工作副本所做的修改，这样您就可以处理其他事情，稍后再回来重新应用。如果您需要快速切换上下文并处理其他工作，但代码改动进行到一半还没准备好提交，那么<code>stash</code>就很方便了。</p>
<h3 id="Stashing-your-work"><a href="#Stashing-your-work" class="headerlink" title="Stashing your work"></a>Stashing your work</h3><p><code>git stash</code>命令会获取未提交的修改（包括已暂存和未暂存的），将其保存起来以备后用，然后从工作副本中将其还原。例如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">Changes to be committed:</span><br><span class="line"></span><br><span class="line">    new file:   style.css</span><br><span class="line"></span><br><span class="line">Changes not staged <span class="keyword">for</span> commit:</span><br><span class="line"></span><br><span class="line">    modified:   index.html</span><br><span class="line"></span><br><span class="line">$ git stash</span><br><span class="line">Saved working directory and index state WIP on main: 5002d47 our new homepage</span><br><span class="line">HEAD is now at 5002d47 our new homepage</span><br><span class="line"></span><br><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">nothing to commit, working tree clean</span><br></pre></td></tr></table></figure>

<p>这时，你可以自由地进行修改、创建新提交、切换分支以及执行其他任何 Git 操作；准备好后，再回来重新应用你的储藏。</p>
<p>请注意，储藏库是本地的 Git 仓库；推送时储藏库不会转移到服务器上。</p>
<h3 id="Re-applying-your-stashed-changes"><a href="#Re-applying-your-stashed-changes" class="headerlink" title="Re-applying your stashed changes"></a>Re-applying your stashed changes</h3><p>你可以使用<code>git stash pop</code>命令重新应用之前储藏的更改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line">$ git stash pop</span><br><span class="line">On branch main</span><br><span class="line">Changes to be committed:</span><br><span class="line"></span><br><span class="line">    new file:   style.css</span><br><span class="line"></span><br><span class="line">Changes not staged <span class="keyword">for</span> commit:</span><br><span class="line"></span><br><span class="line">    modified:   index.html</span><br><span class="line"></span><br><span class="line">Dropped refs/stash@&#123;0&#125; (32b3aa1d185dfe6d57b3c3cc3b32cbf3e380cc6a)</span><br></pre></td></tr></table></figure>

<p><em>Popping</em> 会重新应用之前储藏的更改，并从储藏库中将其删除。</p>
<p>或者，你也可以使用<code>git stash apply</code>将更改重新应用到工作副本，并将其继续保留在储藏库中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ git stash apply</span><br><span class="line">On branch main</span><br><span class="line">Changes to be committed:</span><br><span class="line"></span><br><span class="line">    new file:   style.css</span><br><span class="line"></span><br><span class="line">Changes not staged <span class="keyword">for</span> commit:</span><br><span class="line"></span><br><span class="line">    modified:   index.html</span><br></pre></td></tr></table></figure>

<p>如果你想在多个分支中应用相同的隐藏更改，这一点非常有用。</p>
<p>现在你已经了解了储藏的基础知识，但还需要注意一个问题：默认情况下，Git 不会储藏对未跟踪或忽略的文件所做的修改。</p>
<h3 id="Stashing-untracked-or-ignored-files"><a href="#Stashing-untracked-or-ignored-files" class="headerlink" title="Stashing untracked or ignored files"></a>Stashing untracked or ignored files</h3><p>默认情况下，运行 <code>git stash</code> 会储藏以下内容：</p>
<ul>
<li>已添加到索引的变更（已暂存变更）</li>
<li>对当前由 Git 跟踪的文件所做的更改（未暂存的更改）</li>
</ul>
<p>但它不会储藏以下内容：</p>
<ul>
<li>工作副本中尚未暂存的新文件</li>
<li>被忽略的文件</li>
</ul>
<p>因此，如果我们在上面的例子中添加了第三个新文件，但没有将其放入暂存阶段（即没有运行<code>git add</code>），那么<code>git stash</code>也不会将其存放起来。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ script.js</span><br><span class="line"></span><br><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">Changes to be committed:</span><br><span class="line"></span><br><span class="line">    new file:   style.css</span><br><span class="line"></span><br><span class="line">Changes not staged <span class="keyword">for</span> commit:</span><br><span class="line"></span><br><span class="line">    modified:   index.html</span><br><span class="line"></span><br><span class="line">Untracked files:</span><br><span class="line"></span><br><span class="line">    script.js</span><br><span class="line"></span><br><span class="line">$ git stash</span><br><span class="line">Saved working directory and index state WIP on main: 5002d47 our new homepage</span><br><span class="line">HEAD is now at 5002d47 our new homepage</span><br><span class="line"></span><br><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">Untracked files:</span><br><span class="line"></span><br><span class="line">    script.js</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加<code>-u</code>选项（或<code>--include-untracked</code>选项）后，<code>git stash</code>也会将未跟踪的文件储藏起来：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">Changes to be committed:</span><br><span class="line"></span><br><span class="line">    new file:   style.css</span><br><span class="line"></span><br><span class="line">Changes not staged <span class="keyword">for</span> commit:</span><br><span class="line"></span><br><span class="line">    modified:   index.html</span><br><span class="line"></span><br><span class="line">Untracked files:</span><br><span class="line"></span><br><span class="line">    script.js</span><br><span class="line"></span><br><span class="line">$ git stash -u</span><br><span class="line">Saved working directory and index state WIP on main: 5002d47 our new homepage</span><br><span class="line">HEAD is now at 5002d47 our new homepage</span><br><span class="line"></span><br><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">nothing to commit, working tree clean</span><br></pre></td></tr></table></figure>

<p>在运行<code>git stash</code>时，你也可以通过<code>-a</code>选项（或<code>--all</code>选项）来包含对忽略文件的修改。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-stash-option-2x.png" style="zoom:50%;" />

<h3 id="Managing-multiple-stashes"><a href="#Managing-multiple-stashes" class="headerlink" title="Managing multiple stashes"></a>Managing multiple stashes</h3><p>你并不局限于一个储藏库。你可以多次运行 git stash 来创建多个储藏库，然后使用<code>git stash list</code>来查看它们。默认情况下，储藏库会在您创建储藏库的分支和提交上简单标识为 “<code>WIP</code>“（正在进行中）。时间久了，就很难记住每个匿藏库包含的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git stash list</span><br><span class="line">stash@&#123;0&#125;: WIP on main: 5002d47 our new homepage</span><br><span class="line">stash@&#123;1&#125;: WIP on main: 5002d47 our new homepage</span><br><span class="line">stash@&#123;2&#125;: WIP on main: 5002d47 our new homepage</span><br></pre></td></tr></table></figure>

<p>为了提供更多的上下文信息，使用 <code>git stash save &quot;message &quot;</code>为储藏注释说明是个不错的做法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ git stash save <span class="string">&quot;add style to our site&quot;</span></span><br><span class="line">Saved working directory and index state On main: add style to our site</span><br><span class="line">HEAD is now at 5002d47 our new homepage</span><br><span class="line"></span><br><span class="line">$ git stash list</span><br><span class="line">stash@&#123;0&#125;: On main: add style to our site</span><br><span class="line">stash@&#123;1&#125;: WIP on main: 5002d47 our new homepage</span><br><span class="line">stash@&#123;2&#125;: WIP on main: 5002d47 our new homepage</span><br></pre></td></tr></table></figure>

<p>默认情况下，<code>git stash pop</code>会重新应用最近创建的储藏： <code>stash@&#123;0&#125;</code></p>
<p>例如，你可以通过最后一个参数传递储藏库的标识符来选择要重新应用的储藏库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git stash pop stash@&#123;2&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Viewing-stash-diffs"><a href="#Viewing-stash-diffs" class="headerlink" title="Viewing stash diffs"></a>Viewing stash diffs</h3><p>您可以使用<code>git stash show</code>查看储藏的摘要：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git stash show</span><br><span class="line"> index.html | 1 +</span><br><span class="line"> style.css | 3 +++</span><br><span class="line"> 2 files changed, 4 insertions(+)</span><br></pre></td></tr></table></figure>

<p>或者通过<code>-p</code>选项（或<code>--patch</code>）来查看储藏的完整差异：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ git stash show -p</span><br><span class="line">diff --git a/style.css b/style.css</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000..d92368b</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/style.css</span><br><span class="line">@@ -0,0 +1,3 @@</span><br><span class="line">+* &#123;</span><br><span class="line">+  text-decoration: blink;</span><br><span class="line">+&#125;</span><br><span class="line">diff --git a/index.html b/index.html</span><br><span class="line">index 9daeafb..ebdcbd2 100644</span><br><span class="line">--- a/index.html</span><br><span class="line">+++ b/index.html</span><br><span class="line">@@ -1 +1,2 @@</span><br><span class="line">+&lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;style.css&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Partial-stashes"><a href="#Partial-stashes" class="headerlink" title="Partial stashes"></a>Partial stashes</h3><p>你也可以选择只储藏一个文件、一组文件或文件中的单个改动。如果向<code>git stash</code>传递<code>-p</code>选项（或<code>--patch</code>），它将遍历工作副本中每个更改的“块”并询问您是否希望储藏它:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ git stash -p</span><br><span class="line">diff --git a/style.css b/style.css</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000..d92368b</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/style.css</span><br><span class="line">@@ -0,0 +1,3 @@</span><br><span class="line">+* &#123;</span><br><span class="line">+  text-decoration: blink;</span><br><span class="line">+&#125;</span><br><span class="line">Stash this hunk [y,n,q,a,d,/,e,?]? y</span><br><span class="line">diff --git a/index.html b/index.html</span><br><span class="line">index 9daeafb..ebdcbd2 100644</span><br><span class="line">--- a/index.html</span><br><span class="line">+++ b/index.html</span><br><span class="line">@@ -1 +1,2 @@</span><br><span class="line">+&lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;style.css&quot;</span>/&gt;</span><br><span class="line">Stash this hunk [y,n,q,a,d,/,e,?]? n</span><br></pre></td></tr></table></figure>

<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-stash-p-2x.png" style="zoom:50%;" />

<p>你可以点击? 查看所有的块命令。常用的有:</p>
<table>
<thead>
<tr>
<th align="left">Command</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">/</td>
<td align="center"><code>search for a hunk by regex</code>(通过正则表达式搜索)</td>
</tr>
<tr>
<td align="left">?</td>
<td align="center">help</td>
</tr>
<tr>
<td align="left">n</td>
<td align="center">don’t stash this hunk（不储藏这个修改块）</td>
</tr>
<tr>
<td align="left">q</td>
<td align="center">quit (any hunks that have already been selected will be stashed) 退出</td>
</tr>
<tr>
<td align="left">s</td>
<td align="center">split this hunk into smaller hunks（拆分成更小的块）</td>
</tr>
<tr>
<td align="left">y</td>
<td align="center">stash this hunk（储藏这个修改块）</td>
</tr>
</tbody></table>
<p>没有明确的 “中止 “命令，但点击 CTRL-C(SIGINT)可以中止储藏过程。</p>
<hr>
<h3 id="Creating-a-branch-from-your-stash"><a href="#Creating-a-branch-from-your-stash" class="headerlink" title="Creating a branch from your stash"></a>Creating a branch from your stash</h3><p>如果分支上的更改与储藏库中的更改不同，则在弹出或应用存储时可能会遇到冲突。相反，您可以<code>git stash branch</code>创建一个新分支来将储藏的更改应用到新分支：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ git stash branch add-stylesheet stash@&#123;1&#125;</span><br><span class="line">Switched to a new branch <span class="string">&#x27;add-stylesheet&#x27;</span></span><br><span class="line">On branch add-stylesheet</span><br><span class="line">Changes to be committed:</span><br><span class="line"></span><br><span class="line">    new file:   style.css</span><br><span class="line"></span><br><span class="line">Changes not staged <span class="keyword">for</span> commit:</span><br><span class="line"></span><br><span class="line">    modified:   index.html</span><br><span class="line"></span><br><span class="line">Dropped refs/stash@&#123;1&#125; (32b3aa1d185dfe6d57b3c3cc3b32cbf3e380cc6a)</span><br></pre></td></tr></table></figure>

<p>这会根据你创建储藏的提交检查出一个新的分支，然后将你储藏的更改添加到该分支中。</p>
<h3 id="Cleaning-up-your-stash"><a href="#Cleaning-up-your-stash" class="headerlink" title="Cleaning up your stash"></a>Cleaning up your stash</h3><p>如果决定不再需要某个特定的储藏库，可以使用<code>git stash drop</code>删除它：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git stash drop stash@&#123;1&#125;</span><br><span class="line">Dropped stash@&#123;1&#125; (17e2697fd8251df6163117cb3d58c1f62a5e7cdb)</span><br></pre></td></tr></table></figure>

<p>或者，您也可以使用以下方法删除所有储藏库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git stash clear</span><br></pre></td></tr></table></figure>

<h3 id="How-git-stash-works"><a href="#How-git-stash-works" class="headerlink" title="How git stash works"></a>How git stash works</h3><p>如果你只想知道如何使用 <code>git stash</code>，那就别读了。但如果你想知道 Git（和<code>git stash</code>）在底层是如何工作的，请继续往下读！</p>
<p>储藏库实际上是以提交对象的形式在版本库中编码的。<code>.git/refs/stash</code> 中的特殊 ref 指向最近创建的 <code>stash</code>，而之前创建的 stash 则由 stash ref 的 reflog 引用。这就是为什么你会用 <code>stash@&#123;n&#125;</code> 来引用 <code>stash</code>：你实际上是在引用 <code>stash</code> 引用 的第 n 个 <code>reflog</code> 条目。因为 <code>stash</code> 只是一个提交，所以可以用 <code>git log</code> 来检查它。</p>
<p>根据您存储的内容，单个<code>git stash</code>操作会创建两个或三个新提交。上图中的提交是：</p>
<ul>
<li><code>stash@&#123;0&#125;</code>，一个新提交，用于存储运行 <code>git stash</code> 时工作副本中的跟踪文件</li>
<li><code>stash@&#123;0&#125;</code>的第一个父级，也就是运行 <code>git stash</code> 时位于 HEAD 的已有提交</li>
<li><code>stash@&#123;0&#125;</code>的第二个父级，一个新的提交代表您运行<code>git stash</code>时的索引</li>
<li><code>stash@&#123;0&#125;</code>的第三个父级，一个新的提交，代表您运行<code>git stash</code>时工作副本中未跟踪的文件。该第三个父级仅在以下情况下创建：<ul>
<li>您的工作副本实际上包含了未跟踪文件；并且</li>
<li>您在调用 <code>git stash</code> 时指定了 <code>--include-untracked</code> 或 <code>--all</code> 选项。</li>
</ul>
</li>
</ul>
<p><code>git stash</code> 如何将工作树和索引编码为提交：</p>
<ul>
<li>在<code>stash</code>之前，工作树可能包含对已跟踪文件、未跟踪文件和忽略文件的更改。其中一些更改也可能暂存于索引中。</li>
</ul>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/before-stashing-2x.png" style="zoom:33%;" />

<ul>
<li>调用<code>git stash</code>将对跟踪文件的任何更改编码为 DAG 中的两项新提交：一项用于未暂存的更改，一项用于索引中暂存的更改。特殊<code>refs/stash</code>引用已更新以指向它们。</li>
</ul>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-stash-2x.png" style="zoom:37%;" />

<ul>
<li>使用 <code>--include-untracked</code> 选项还会将对未跟踪文件的任何修改编码为额外提交。</li>
</ul>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-stash-untracked-2x.png" style="zoom:38%;" />

<ul>
<li>使用 <code>--all</code> 选项会将对任何忽略文件的修改与对未跟踪文件的修改一起包含在同一提交中。</li>
</ul>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-stash-all-2x.png" style="zoom:39%;" />

<p>当你运行 <code>git stash pop</code> 时，上面提交的改动会被用来更新你的工作副本和索引，而 stash reflog 会被洗牌以移除pop的提交。请注意，弹出的提交不会被立即删除，但会成为未来垃圾回收的候选者。</p>
<hr>
<h2 id="ignore"><a href="#ignore" class="headerlink" title=".ignore"></a>.ignore</h2><p>Git 将工作副本中的每个文件视为三种情况之一：</p>
<ol>
<li><p><code>tracked</code>（已跟踪） – 之前已暂存或已提交的文件；</p>
</li>
<li><p><code>untracked</code>（未跟踪）–未暂存或未提交的文件；</p>
</li>
<li><p><code>ignored</code>（忽略）–明确告知 Git 忽略的文件。</p>
</li>
</ol>
<p>忽略的文件通常是构建工件和机器生成的文件，这些文件可以从版本库源代码中导出，或者不应提交。常见的例子有：</p>
<ul>
<li>依赖缓存，如 /node_modules 或 /packages 的内容</li>
<li>编译过的代码，如 .o、.pyc 和 .class 文件</li>
<li>编译输出目录，如 /bin、/out 或 /target</li>
<li>运行时生成的文件，如 .log、.lock 或 .tmp</li>
<li>隐藏的系统文件，如 .DS_Store 或 Thumbs.db</li>
<li>个人IDE配置文件，如 .idea/workspace.xml</li>
</ul>
<p>被忽略的文件会被记录在一个名为 <code>.gitignore</code> 的特殊文件中，该文件位于版本库的根目录下。没有明确的 git 忽略命令：相反，当您有新文件需要忽略时，必须手动编辑并提交 <code>.gitignore</code> 文件。<code>.gitignore</code> 文件包含的模式会与版本库中的文件名进行匹配，以决定是否忽略这些文件。</p>
<h3 id="Git-ignore-patterns"><a href="#Git-ignore-patterns" class="headerlink" title="Git ignore patterns"></a>Git ignore patterns</h3><p><code>.gitignore</code> 使用通配模式来匹配文件名。你可以使用各种符号来构建匹配模式：</p>
<table>
<thead>
<tr>
<th align="left">模式</th>
<th align="center">匹配示例</th>
<th align="center">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="left">**/logs</td>
<td align="center">logs/debug.log   logs/monday/foo.bar build/logs/debug.log</td>
<td align="center">您可以在模式前加上双星号，以匹配版本库中的任何目录。</td>
</tr>
<tr>
<td align="left">**/logs/debug.log</td>
<td align="center">logs/debug.log   build/logs/debug.log  <br><em>但不是</em> <br/>  logs/build/debug.log</td>
<td align="center">您还可以使用双星号，根据文件名及其父目录的名称来匹配文件。</td>
</tr>
<tr>
<td align="left">*.log</td>
<td align="center">debug.log <br/>foo.log<br/>.log<br/>logs/debug.log</td>
<td align="center">星号是通配符，可匹配 0 个或多个字符。</td>
</tr>
<tr>
<td align="left">*.log <br> !important.log</td>
<td align="center">debug.log<br/> <em>但不是</em> <br/>logs/debug.log</td>
<td align="center">在模式前加上感叹号会否定该模式。如果文件与某个模式匹配，但也与文件后面定义的否定模式匹配，则不会被忽略。</td>
</tr>
<tr>
<td align="left">/debug.log</td>
<td align="center">debug.log<br/> <em>但不是</em><br/>logs/debug.log</td>
<td align="center">在否定模式之后定义的模式将重新忽略之前否定的任何文件。</td>
</tr>
<tr>
<td align="left">debug.log</td>
<td align="center">debug.log<br/>logs/debug.log</td>
<td align="center">前缀斜线只匹配版本库根目录下的文件。</td>
</tr>
<tr>
<td align="left">debug?.log</td>
<td align="center">debug0.log<br/>debugg.log<br/> <em>但不是</em><br/>debug10.log</td>
<td align="center">问号只能匹配一个字符。</td>
</tr>
<tr>
<td align="left">debug[0-9].log</td>
<td align="center">debug0.log<br/>debug1.log<br/> <em>但不是</em><br/>debug10.log</td>
<td align="center">方括号也可用于匹配指定范围内的单个字符。</td>
</tr>
<tr>
<td align="left">debug[01].log</td>
<td align="center">debug0.log<br/>debug1.log<br/> <em>但不是</em><br/>debug2.log<br/>debug01.log</td>
<td align="center">方括号匹配指定字符集中的单个字符。</td>
</tr>
<tr>
<td align="left">debug[!01].log</td>
<td align="center">debug2.log<br/> <em>但不是</em><br/>debug0.log<br/>debug1.log<br/>debug01.log</td>
<td align="center">感叹号可用于匹配指定字符集以外的任何字符。</td>
</tr>
<tr>
<td align="left">debug[a-z].log</td>
<td align="center">debuga.log<br/>debugb.log<br/> <em>但不是</em><br/>debug1.log</td>
<td align="center">范围可以是数字或字母。</td>
</tr>
<tr>
<td align="left">logs</td>
<td align="center">logs<br/>logs/debug.log<br/> logs/latest/foo.bar<br/>build/logs<br/>build/logs/debug.log</td>
<td align="center">如果不添加斜线，模式将同时匹配文件和该名称下的目录内容。在左边的匹配示例中，名为 logs 的目录和文件都会被忽略</td>
</tr>
<tr>
<td align="left">logs/</td>
<td align="center">logs/debug.log<br/>logs/latest/foo.bar<br/>build/logs/foo.bar<br/>build/logs/latest/debug.log</td>
<td align="center">添加斜线表示该模式是一个目录。版本库中与该名称匹配的任何目录的全部内容（包括其所有文件和子目录）都将被忽略</td>
</tr>
<tr>
<td align="left">logs/   !logs/important.log</td>
<td align="center">logs/debug.log   logs/important.log</td>
<td align="center">等一下！在左边的示例中，logs/important.log 不应该被忽略吗？不对！由于 Git 中一个与性能相关的怪癖，你不能否定一个由于模式匹配目录而被忽略的文件</td>
</tr>
<tr>
<td align="left">logs/**/debug.log</td>
<td align="center">logs/debug.log   logs/monday/debug.log   logs/monday/pm/debug.log</td>
<td align="center">双星号可匹配零个或多个目录</td>
</tr>
<tr>
<td align="left">logs/*day/debug.log</td>
<td align="center">logs/monday/debug.log   logs/tuesday/debug.log<br/>   <em>但不是</em><br/>logs/latest/debug.log</td>
<td align="center">目录名中也可以使用通配符。</td>
</tr>
<tr>
<td align="left">logs/debug.log</td>
<td align="center">logs/debug.log<br/>   <em>但不是</em><br/>  debug.log   build/logs/debug.log</td>
<td align="center">指定特定目录中文件的模式是相对于版本库根目录而言的。(如果你愿意，可以在前面加上斜线，但这并没有什么特别的作用）。</td>
</tr>
</tbody></table>
<p>这些解释假定您的 <code>.gitignore</code> 文件按照惯例位于版本库的顶层目录中。如果您的存储库有多个 <code>.gitignore</code> 文件，只需在心里将“存储库根目录”替换为“包含 <code>.gitignore</code> 文件的目录”（并考虑统一它们，以确保您团队的理智）。</p>
<p>除了这些字符，你还可以使用 <code>#</code> 在 <code>.gitignore</code> 文件中加入注释：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ignore all logs</span></span><br><span class="line">*.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>

<p>如果文件或目录中包含 <code>.gitignore</code> 模式字符，你可以使用 <code>\</code> 来转义这些字符：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ignore the file literally named foo[01].txt</span></span><br><span class="line">foo\[01\].txt</span><br></pre></td></tr></table></figure>

<h3 id="Shared-gitignore-files-in-your-repository"><a href="#Shared-gitignore-files-in-your-repository" class="headerlink" title="Shared .gitignore files in your repository"></a>Shared .gitignore files in your repository</h3><p>Git 忽略规则通常在版本库根目录下的 <code>.gitignore</code> 文件中定义。不过，你也可以选择在版本库的不同目录中定义多个 <code>.gitignore</code> 文件。特定 <code>.gitignore</code> 文件中的每个模式都会相对于该文件的目录进行测试。不过最简单的方法还是在根目录下定义一个 <code>.gitignore</code> 文件。在签入 <code>.gitignore</code> 文件时，它会像版本库中的其他文件一样进行版本控制，并在推送时与队友共享。通常情况下，你应该只在 <code>.gitignore</code> 文件中包含有利于版本库其他用户的模式。</p>
<h3 id="Personal-Git-ignore-rules"><a href="#Personal-Git-ignore-rules" class="headerlink" title="Personal Git ignore rules"></a>Personal Git ignore rules</h3><p>你还可以在 <code>.git/info/exclude</code> 这个特殊文件中为特定版本库定义个人忽略模式。这些文件没有版本控制，也不随版本库一起发布，所以在这里加入可能只会对你有利的模式很合适。例如，如果你有自定义日志设置，或者有特殊的开发工具会在版本库的工作目录中生成文件，你可以考虑把它们添加到 <code>.git/info/exclude</code> 中，以防止它们被意外提交到版本库中。</p>
<h3 id="Global-Git-ignore-rules"><a href="#Global-Git-ignore-rules" class="headerlink" title="Global Git ignore rules"></a>Global Git ignore rules</h3><p>此外，你还可以通过设置 Git <code>core.excludesFile</code> 属性，为本地系统中的所有仓库定义全局 Git 忽略模式。这个文件需要自己创建。如果你不确定把全局 <code>.gitignore</code> 文件放在哪里，那么您的主目录是一个不错的选择（并且可以方便以后查找）。创建文件后，您需要使用以下命令配置其位置<code>git config</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ touch ~/.gitignore</span><br><span class="line">$ git config --global core.excludesFile ~/.gitignore</span><br></pre></td></tr></table></figure>

<p>由于不同的文件类型适用于不同的项目，因此在选择全局忽略的模式时应慎重。特殊的操作系统文件（如 .DS_Store 和 thumbs.db）或某些开发工具创建的临时文件是典型的全局忽略对象。</p>
<h3 id="Ignoring-a-previously-committed-file"><a href="#Ignoring-a-previously-committed-file" class="headerlink" title="Ignoring a previously committed file"></a>Ignoring a previously committed file</h3><p>如果想忽略过去提交过的文件，需要先从版本库中删除该文件，然后为其添加 <code>.gitignore</code> 规则。在 <code>git rm</code> 中使用 <code>--cached</code> 选项意味着该文件将从版本库中删除，但会作为忽略文件保留在工作目录中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> debug.log &gt;&gt; .gitignore</span><br><span class="line">  </span><br><span class="line">$ git rm --cached debug.log</span><br><span class="line">rm <span class="string">&#x27;debug.log&#x27;</span></span><br><span class="line">  </span><br><span class="line">$ git commit -m <span class="string">&quot;Start ignoring debug.log&quot;</span></span><br></pre></td></tr></table></figure>

<p>如果想从版本库和本地文件系统中删除文件，可以省略 <code>--cached</code> 选项。</p>
<h3 id="Committing-an-ignored-file"><a href="#Committing-an-ignored-file" class="headerlink" title="Committing an ignored file"></a>Committing an ignored file</h3><p>使用 <code>git add</code> 的 <code>-f</code>（或 <code>--force</code>）选项，可以强制将忽略的文件提交到版本库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat .gitignore</span><br><span class="line">*.<span class="built_in">log</span></span><br><span class="line">  </span><br><span class="line">$ git add -f debug.log</span><br><span class="line">  </span><br><span class="line">$ git commit -m <span class="string">&quot;Force adding debug.log&quot;</span></span><br></pre></td></tr></table></figure>

<p>如果定义了通用匹配模式（如 <code>*.log</code>），但又想提交特定文件，可以考虑这样做。不过，更好的解决办法是定义一般规则的例外：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> !debug.log &gt;&gt; .gitignore</span><br><span class="line">  </span><br><span class="line">$ cat .gitignore</span><br><span class="line">*.<span class="built_in">log</span></span><br><span class="line">!debug.log</span><br><span class="line">  </span><br><span class="line">$ git add debug.log</span><br><span class="line">  </span><br><span class="line">$ git commit -m <span class="string">&quot;Adding debug.log&quot;</span></span><br></pre></td></tr></table></figure>

<p>对于您的其他开发伙伴来说，这种方法更明显，也更不容易混淆。</p>
<h3 id="Stashing-an-ignored-file"><a href="#Stashing-an-ignored-file" class="headerlink" title="Stashing an ignored file"></a>Stashing an ignored file</h3><p><code>git stash</code>是一项强大的 Git 功能，用于暂时储藏和还原本地更改，以便日后重新应用。如你所料，默认情况下，<code>git stash</code> 会忽略被忽略的文件，只存放 Git 追踪到的文件的改动。不过，你也可以使用 <code>--all</code> 选项调用 <code>git stash</code>，将被忽略和未被跟踪的文件的改动也储藏起来。</p>
<h3 id="Debugging-gitignore-files"><a href="#Debugging-gitignore-files" class="headerlink" title="Debugging .gitignore files"></a>Debugging .gitignore files</h3><p>如果你有复杂的 <code>.gitignore</code>模式，或者这些模式分布在多个 <code>.gitignore</code> 文件中，就很难找出某个文件被忽略的原因。你可以使用 <code>git check-ignore</code> 命令和 <code>-v</code>（或 <code>--verbose</code>）选项来确定是哪种模式导致了某个文件被忽略：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git check-ignore -v debug.log</span><br><span class="line">.gitignore:3:*.<span class="built_in">log</span>  debug.log</span><br></pre></td></tr></table></figure>

<p>输出显示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;file containing the pattern&gt; : &lt;line number of the pattern&gt; : &lt;pattern&gt;  &lt;file name&gt;</span><br></pre></td></tr></table></figure>

<p>你可以向 <code>git check-ignore</code> 传递多个文件名，文件名本身甚至不必与版本库中存在的文件相对应。</p>
<hr>
<h1 id="检查存储库"><a href="#检查存储库" class="headerlink" title="检查存储库"></a>检查存储库</h1><h2 id="git-statue"><a href="#git-statue" class="headerlink" title="git statue"></a>git statue</h2><p><code>git status</code>命令会显示工作目录和暂存区域的状态。通过它，你可以看到哪些变更已被暂存，哪些未被暂存，以及哪些文件未被 Git 跟踪。状态输出不会显示任何有关已提交项目历史的信息。为此，你需要使用 <code>git log</code>。</p>
<h3 id="相关-git-命令"><a href="#相关-git-命令" class="headerlink" title="相关 git 命令"></a>相关 git 命令</h3><ul>
<li><code>git tag</code><ul>
<li><code>tag</code>是指向 Git 历史记录中特定点的引用。 <code>git tag</code>通常用于捕获用于标记版本发布（即 v1.0.1）的历史记录点。 </li>
</ul>
</li>
<li><code>git blame</code><ul>
<li><code>git blame</code> 的高级功能是显示附加到文件中已提交行的作者元数据。这可以用来探索特定代码的历史，回答关于代码是什么、如何以及为什么被添加到版本库中的问题。</li>
</ul>
</li>
<li><code>git log</code><ul>
<li><code>git log</code> 命令会显示已提交的快照。您可以用它列出项目历史、过滤历史记录并搜索特定变更。</li>
</ul>
</li>
</ul>
<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br></pre></td></tr></table></figure>

<p>列出暂存、未暂存和未跟踪的文件。</p>
<p><code>git status</code> 命令是一个相对简单的命令。它只需显示 <code>git add</code> 和<code>git commit</code>的状态。状态信息还包括文件暂存/未暂存的相关说明。下面的示例输出显示了 git 状态调用的三个主要类别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># On branch main</span><br><span class="line"># Changes to be committed:</span><br><span class="line"># (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)</span><br><span class="line">#</span><br><span class="line">#modified: hello.py</span><br><span class="line">#</span><br><span class="line"># Changes not staged for commit:</span><br><span class="line"># (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)</span><br><span class="line"># (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</span><br><span class="line">#</span><br><span class="line">#modified: main.py</span><br><span class="line">#</span><br><span class="line"># Untracked files:</span><br><span class="line"># (use &quot;git add &lt;file&gt;...&quot; to include in what will be committed)</span><br><span class="line">#</span><br><span class="line">#hello.pyc</span><br></pre></td></tr></table></figure>

<h3 id="Ignoring-Files"><a href="#Ignoring-Files" class="headerlink" title="Ignoring Files"></a>Ignoring Files</h3><p>未跟踪文件通常分为两类。它们要么是刚添加到项目中但尚未提交的文件，要么是编译过的二进制文件，如 .pyc、.obj、.exe 等。在 git 状态输出中包含前者肯定是有好处的，但后者会让人很难看出仓库里到底发生了什么。</p>
<p>因此，Git 可以让你完全忽略文件，方法是把路径放在一个叫做 <code>.gitignore</code> 的特殊文件中。任何你想忽略的文件都应该单独列一行，<code>*</code>符号可以用作通配符。例如，在项目根目录下的 <code>.gitignore</code> 文件中添加以下内容，就能阻止编译后的 Python 文件出现在 <code>git status</code> 中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.pyc</span><br></pre></td></tr></table></figure>

<p>在提交更改之前，检查版本库的状态是个很好的做法，这样就不会不小心提交了一些你不想提交的内容。此示例显示了暂存和提交快照前后的版本库状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Edit hello.py</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># hello.py is listed under &quot;Changes not staged for commit&quot;</span></span><br><span class="line">git add hello.py</span><br><span class="line">git status</span><br><span class="line"><span class="comment"># hello.py is listed under &quot;Changes to be committed&quot;</span></span><br><span class="line">git commit</span><br><span class="line">git status</span><br><span class="line"><span class="comment"># nothing to commit (working directory clean)</span></span><br></pre></td></tr></table></figure>

<p>第一个状态输出将显示文件未暂存。<code>git add</code> 操作会反映在第二个 git 状态输出中，最后一个状态输出会告诉你没有要提交的内容–工作目录与最近的提交一致。有些 Git 命令（如 <code>git merge</code>）要求工作目录必须是干净的，以免意外覆盖改动。</p>
<h2 id="git-log"><a href="#git-log" class="headerlink" title="git log"></a>git log</h2><p><code>git log</code> 命令会显示已提交的快照。通过它，您可以列出项目历史，对其进行过滤，并搜索特定的改动。<code>git status</code> 可以查看工作目录和暂存区域，而 <code>git log</code> 只能查看已提交的历史记录。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-log-2x.png" style="zoom:50%;" />

<p>日志输出可通过多种方式自定义，从简单过滤提交到以完全由用户定义的格式显示。下面介绍一些最常见的 git 日志配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span></span><br></pre></td></tr></table></figure>

<p>使用默认格式显示整个提交历史。如果输出占用了一个屏幕以上，可以使用<code>空格</code>滚动，使用 <code>q</code> 退出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> -n &lt;<span class="built_in">limit</span>&gt;</span><br></pre></td></tr></table></figure>

<p>限制显示条数，例如，<code>git log -n 3</code> 只显示最近 3 次提交。</p>
<p>将每个提交压缩为一行。这有助于获得项目历史的高层概览。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --<span class="built_in">stat</span></span><br></pre></td></tr></table></figure>

<p>除了普通的 <code>git log</code> 信息外，还包括哪些文件被修改，以及每个文件被添加或删除的行数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> -p</span><br></pre></td></tr></table></figure>

<p>显示代表每次提交的补丁。这将显示每次提交的完整差异，是项目历史最详细的视图。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --author=<span class="string">&quot;&lt;pattern&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<p>搜索特定作者的提交。参数 <code>＜pattern</code>＞ 可以是纯字符串或正则表达式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --grep=<span class="string">&quot;&lt;pattern&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<p>搜索特定<code>commit</code> 提交信息的提交。参数 <code>＜pattern</code>＞ 可以是纯字符串或正则表达式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> &lt;since&gt;..&lt;until&gt;</span><br></pre></td></tr></table></figure>

<p>只显示 <code>&lt;since&gt;</code> 和 <code>&lt;until&gt;</code> 之间的提交。两个参数都可以是<code>commit ID</code>、分支名称、HEAD 或任何其他类型的修订引用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> &lt;file&gt;</span><br></pre></td></tr></table></figure>

<p>只显示包含指定文件的提交。这是查看特定文件历史记录的简便方法。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --graph --decorate --oneline</span><br></pre></td></tr></table></figure>

<p>有几个有用的选项值得考虑。<code>--graph</code> 标志会在提交信息的左侧绘制基于文本的提交图表。<code>--decorate</code>（装饰）标记会添加分支名称或提交标签。<code>--oneline</code>（单线）会将提交信息显示在一行上，方便用户一目了然地浏览提交信息。</p>
<p>检查文件状态:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">commit 3157ee3718e180a9476bf2e5cab8e3f1e78a73b7</span><br><span class="line">Author: John Smith</span><br></pre></td></tr></table></figure>

<p>大部分内容都很简单明了，但第一行需要解释一下。提交后的 40 个字符字符串是提交内容的 SHA-1 校验和。这样做有两个目的。首先，它可以确保提交的完整性–如果提交内容被破坏，提交将生成不同的校验和。其次，它可以作为提交的唯一 ID。</p>
<p>这个 ID 可以在 <code>git log ..</code> 等命令中用来指代特定的提交。例如，<code>git log 3157e..5ab91</code>  将显示 ID 为 3157e 和 5ab91 的提交之间的所有内容。除了校验和之外，分支名（分支模块中有讨论）和 HEAD 关键字也是引用单个提交的常用方法。HEAD 总是指当前提交，无论是分支还是特定提交。</p>
<p><code>~</code> 字符用于相对引用提交的父提交。例如，3157e~1 指的是 3157e 之前的提交，而 HEAD~3 则是当前提交的曾祖父。</p>
<p>前面提供了许多 <code>git log</code> 的示例，但请记住，多个选项可以合并为一条命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --author=<span class="string">&quot;John Smith&quot;</span> -p hello.py</span><br></pre></td></tr></table></figure>

<p>这将显示约翰-史密斯对文件 hello.py 所做更改的完整差异。</p>
<p><code>..</code>语法是比较分支的一个非常有用的工具。下一个示例将简要显示所有在<code>some-feature</code>中但不在<code>main</code>中的提交。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline main..some-feature</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="git-tag"><a href="#git-tag" class="headerlink" title="git tag"></a>git tag</h2><p>本文将讨论 Git 标签概念和 git 标签命令。<code>tag</code>是指向 Git 历史中特定点的 ref。标签一般用于捕捉历史中的某一点，该点用于标记版本发布（如<code>v1.0.1</code>）。</p>
<p>标签就像一个不会改变的分支。与分支不同的是，标签在创建后就不会再有提交历史。有关分支的更多信息，请访问 git 分支页面。</p>
<p>本文将介绍不同类型的标签、如何创建标签、列出所有标签、删除标签、共享标签等内容。</p>
<h3 id="创建标签"><a href="#创建标签" class="headerlink" title="创建标签"></a>创建标签</h3><p>要创建新标签，请执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git tag &lt;tagname&gt;</span><br></pre></td></tr></table></figure>

<p>将 <code>&lt;tagname&gt;</code> 替换为创建标签时版本仓库状态的语义标识符。常见的模式是使用版本号，如 <code>git tag v1.4</code>。Git 支持两种不同类型的标签：注释标签和轻量级标签。前面的例子创建了一个轻量级标签。轻量级标签和注释标签存储的元数据量不同。最佳做法是将注释标签视为公共标签，将轻量级标签视为私有标签。注释标签存储额外的元数据，例如：标签名称、电子邮件和日期。这对于公开发布来说是非常重要的数据。轻量级标签本质上是提交的 “书签”，它们只是一个名称和指向提交的指针，可用于创建指向相关提交的快速链接。</p>
<h3 id="附加说明注释的标签"><a href="#附加说明注释的标签" class="headerlink" title="附加说明注释的标签"></a>附加说明注释的标签</h3><p>注释标签（<code>annotated tags</code>）作为存储在 Git 数据库中完整对象。它们存储了额外的元数据，如：标签名称、电子邮件和日期。与提交和提交信息类似，注释标签也有标签信息。此外，为了安全起见，注释标签可以使用 GNU Privacy Guard（GPG）进行签名和验证。建议使用 <code>git tag</code> 的最佳做法是，优先使用注释标签，而不是轻量级标签，这样就能获得所有相关的元数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git tag -a v1.4</span><br></pre></td></tr></table></figure>

<p>执行该命令将创建一个标有 <code>v1.4</code> 的新注释标签。然后，该命令将打开配置的默认文本编辑器，提示进一步输入元数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git tag -a v1.4 -m <span class="string">&quot;my version 1.4&quot;</span></span><br></pre></td></tr></table></figure>

<p>执行该命令的过程与之前的调用类似，不过这个版本的命令会传入 <code>-m</code> 选项和一条信息。这是一种类似于 <code>git commit -m</code> 的便捷方法，它会立即创建一个新标签，并放弃打开本地文本编辑器，转而保存通过 <code>-m</code> 选项传递的信息。</p>
<h3 id="轻量级标签"><a href="#轻量级标签" class="headerlink" title="轻量级标签"></a>轻量级标签</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git tag v1.4-lw</span><br></pre></td></tr></table></figure>

<p>执行该命令将创建一个轻量级标签，标识为 <code>v1.4-lw</code>。创建轻量级标签时不使用 <code>-a</code>、<code>-s</code> 或 <code>-m</code> 选项。轻量级标签会创建一个新的标签校验和，并将其存储在项目 repo 的 <code>.git/</code> 目录中。</p>
<h3 id="列出所有标签"><a href="#列出所有标签" class="headerlink" title="列出所有标签"></a>列出所有标签</h3><p>要列出 repo 中已存储的标记，请执行以下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git tag</span><br></pre></td></tr></table></figure>

<p>这将输出一个标签列表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">v0.10.0</span><br><span class="line">    v0.10.0-rc1</span><br><span class="line">    v0.11.0</span><br><span class="line">    v0.11.0-rc1</span><br><span class="line">    v0.11.1</span><br><span class="line">    v0.11.2</span><br><span class="line">    v0.12.0</span><br><span class="line">    v0.12.0-rc1</span><br><span class="line">    v0.12.1</span><br><span class="line">    v0.12.2</span><br><span class="line">    v0.13.0</span><br><span class="line">    v0.13.0-rc1</span><br><span class="line">    v0.13.0-rc2</span><br></pre></td></tr></table></figure>

<p>要细化标签列表，<code>-l</code> 选项可与通配符表达式一起使用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ git tag -l *-rc*</span><br><span class="line">    v0.10.0-rc1</span><br><span class="line">    v0.11.0-rc1</span><br><span class="line">    v0.12.0-rc1</span><br><span class="line">    v0.13.0-rc1</span><br><span class="line">    v0.13.0-rc2</span><br><span class="line">    v0.14.0-rc1</span><br><span class="line">    v0.9.0-rc1</span><br><span class="line">    v15.0.0-rc.1</span><br><span class="line">    v15.0.0-rc.2</span><br><span class="line">    v15.4.0-rc.3</span><br></pre></td></tr></table></figure>

<p>上例中使用了 <code>-l</code> 选项和 <code>-rc</code> 通配符表达式，可返回所有标有 <code>-rc</code> 前缀（传统上用于识别候选发布版本）的标记列表。</p>
<h3 id="标记旧提交"><a href="#标记旧提交" class="headerlink" title="标记旧提交"></a>标记旧提交</h3><p>默认情况下，<code>git tag</code>将在<code>HEAD</code>引用的提交上创建一个标签。另外，也可以将 <code>git tag</code> 作为特定提交的引用。这将标记所传递的提交，而不是默认的 <code>HEAD</code>。要收集较早提交的列表，请执行 <code>git log</code> 命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> --pretty=oneline</span><br><span class="line">    15027957951b64cf874c3557a0f3547bd83b3ff6 Merge branch <span class="string">&#x27;feature&#x27;</span></span><br><span class="line">    a6b4c97498bd301d84096da251c98a07c7723e65 add update method <span class="keyword">for</span> thing</span><br><span class="line">    0d52aaab4479697da7686c15f77a3d64d9165190 one more thing</span><br><span class="line">    6d52a271eda8725415634dd79daabbc4d9b6008e Merge branch <span class="string">&#x27;experiment&#x27;</span></span><br></pre></td></tr></table></figure>

<p>执行 git log 会输出提交列表。在本例中，我们将选取注释为 “Merge branch ‘feature’ “去创建新标签。我们需要引用提交的 SHA 哈希值传递给 Git：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git tag -a v1.2 15027957951b64cf874c3557a0f3547bd83b3ff6</span><br></pre></td></tr></table></figure>

<p>执行上述<code>git tag</code>调用将将为SHA哈希值为’15027957951b64cf874c3557a0f3547bd83b3ff6’ 的提交创建一个新标签<code>v1.2</code>。</p>
<h3 id="重新标记-替换旧标签"><a href="#重新标记-替换旧标签" class="headerlink" title="重新标记/替换旧标签"></a>重新标记/替换旧标签</h3><p>如果试图创建一个与现有标签标识符相同的标签，Git 会抛出类似的错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal: tag <span class="string">&#x27;v0.4&#x27;</span> already exists</span><br></pre></td></tr></table></figure>

<p>此外，如果您尝试用现有的标记标识符标记旧提交，Git 也会抛出同样的错误。</p>
<p>如果必须更新现有标签，则必须使用 <code>-f</code> FORCE 选项。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git tag -a -f v1.4 15027957951b64cf874c3557a0f3547bd83b3ff6</span><br></pre></td></tr></table></figure>

<p>执行上述命令将把 15027957951b64cf874c3557a0f3547bd83b3ff6 提交映射到 <code>v1.4</code> 标签标识符。它将覆盖 <code>v1.4</code> 标签的任何现有内容。</p>
<h3 id="共享：向远程仓库推送标签"><a href="#共享：向远程仓库推送标签" class="headerlink" title="共享：向远程仓库推送标签"></a>共享：向远程仓库推送标签</h3><p>共享标签与推送分支类似。默认情况下，<code>git push</code> 不会推送标签。标签必须明确传递给 <code>git push</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ git push origin v1.4</span><br><span class="line">    Counting objects: 14, <span class="keyword">done</span>.</span><br><span class="line">    Delta compression using up to 8 threads.</span><br><span class="line">    Compressing objects: 100% (12/12), <span class="keyword">done</span>.</span><br><span class="line">    Writing objects: 100% (14/14), 2.05 KiB | 0 bytes/s, <span class="keyword">done</span>.</span><br><span class="line">    Total 14 (delta 3), reused 0 (delta 0)</span><br><span class="line">    To git@bitbucket.com:atlasbro/gittagdocs.git</span><br><span class="line">     * [new tag]         v1.4 -&gt; v1.4</span><br></pre></td></tr></table></figure>

<p>要同时推送多个标签，可在 <code>git push</code> 命令中加入 <code>--tags</code> 选项。当其他用户克隆或拉取 repo 时，他们就会收到新标签。</p>
<h3 id="检查标签"><a href="#检查标签" class="headerlink" title="检查标签"></a>检查标签</h3><p>您可以使用 <code>git checkout</code> 命令在标签上查看 repo 的状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout v1.4</span><br></pre></td></tr></table></figure>

<p>上述命令将签出 v1.4 标签。这将使 repo 处于分离<code>HEAD</code>的状态。这意味着任何更改都不会更新标签。它们将创建一个新的分离提交。这个新的分离提交不会成为任何分支的一部分，只能通过提交的 SHA 哈希值直接访问。因此，在分离 HEAD 状态下进行修改时，最好先创建一个新的分支。</p>
<h3 id="删除标签"><a href="#删除标签" class="headerlink" title="删除标签"></a>删除标签</h3><p>删除标签的操作很简单。向 <code>git tag</code> 传递 <code>-d</code> 选项和标签标识符，就能删除标识的标签。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ git tag</span><br><span class="line">    v1</span><br><span class="line">    v2</span><br><span class="line">    v3</span><br><span class="line">    $ git tag -d v1</span><br><span class="line">    $ git tag</span><br><span class="line">    v2</span><br><span class="line">    v3</span><br></pre></td></tr></table></figure>

<p>在本例中，执行<code>git tag</code>会显示一个标签列表，其中显示 <code>v1</code>、<code>v2</code>、<code>v3</code>，然后执行 <code>git tag -d v1</code> 会删除<code>v1</code>标签。</p>
<hr>
<h2 id="git-blame"><a href="#git-blame" class="headerlink" title="git blame"></a>git blame</h2><p><code>git blame</code> 命令是一个多功能的故障诊断工具，有大量的使用选项。<code>git blame</code> 的高级功能是显示附加在文件的特定提交行上的作者元数据。这可以用来检查文件历史中的特定点，了解修改该行的最后一个作者是谁。<code>git blame</code> 还可以用来探索特定代码的历史，回答代码是什么、如何以及为什么被添加到版本库中的问题。</p>
<p><code>Git blame</code>通常与 GUI 显示屏一起使用。在线 Git 托管网站（如 Bitbucket）提供的<code>blame</code>视图是 Git blame 的 UI 包装。这些视图在围绕拉取请求和提交的协作讨论中被引用。此外，大多数集成了 Git 的集成开发环境也有动态 blame 视图。</p>
<h3 id="How-it-works-1"><a href="#How-it-works-1" class="headerlink" title="How it works"></a>How it works</h3><p>为了演示 <code>git blame</code>，我们需要一个有一定历史的版本库。我们将使用开源项目 <a target="_blank" rel="noopener" href="https://bitbucket.org/kevzettler/git-blame-example">git-blame-example</a>。这个开源项目是一个简单的版本库，包含一个 README.md 文件，其中有一些来自不同作者的提交。<code>git blame</code>使用示例的第一步是<code>git clone</code> 该示例仓库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://kevzettler@bitbucket.org/kevzettler/git-blame-example.git &amp;&amp; <span class="built_in">cd</span> git-blame-example</span><br></pre></td></tr></table></figure>

<p>现在我们有了示例代码的副本，可以用<code>git blame</code>开始探索它了。使用<code>git log</code>可以查看示例仓库的状态。提交历史应该如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">log</span></span><br><span class="line">    commit 548dabed82e4e5f3734c219d5a742b1c259926b2</span><br><span class="line">    Author: Juni Mukherjee &lt;jmukherjee@atlassian.com&gt;</span><br><span class="line">    Date:   Thu Mar 1 19:55:15 2018 +0000</span><br><span class="line"></span><br><span class="line">        Another commit to <span class="built_in">help</span> git blame track the who, the what, and the when</span><br><span class="line"></span><br><span class="line">    commit eb06faedb1fdd159d62e4438fc8dbe9c9fe0728b</span><br><span class="line">    Author: Juni Mukherjee &lt;jmukherjee@atlassian.com&gt;</span><br><span class="line">    Date:   Thu Mar 1 19:53:23 2018 +0000</span><br><span class="line"></span><br><span class="line">        Creating the third commit, along with Kev and Albert, so that Kev can get git blame docs.</span><br><span class="line"></span><br><span class="line">    commit 990c2b6a84464fee153253dbf02e845a4db372bb</span><br><span class="line">    Merge: 82496ea 89feb84</span><br><span class="line">    Author: Albert So &lt;aso@atlassian.com&gt;</span><br><span class="line">    Date:   Thu Mar 1 05:33:01 2018 +0000</span><br><span class="line"></span><br><span class="line">        Merged <span class="keyword">in</span> albert-so/git-blame-example/albert-so/readmemd-edited-online-with-bitbucket-1519865641474 (pull request <span class="comment">#2)</span></span><br><span class="line"></span><br><span class="line">        README.md edited online with Bitbucket</span><br><span class="line"></span><br><span class="line">    commit 89feb84d885fe33d1182f2112885c2a64a4206ec</span><br><span class="line">    Author: Albert So &lt;aso@atlassian.com&gt;</span><br><span class="line">    Date:   Thu Mar 1 00:54:03 2018 +0000</span><br><span class="line"></span><br><span class="line">        README.md edited online with Bitbucket</span><br></pre></td></tr></table></figure>

<p><code>git blame</code> 只能对单个文件进行操作。任何有用的输出都需要文件路径。<code>git blame</code> 的默认执行方式只是输出命令帮助菜单。在本例中，我们将对 <code>README.MD</code> 文件进行操作。在 git 仓库的根目录中包含一个 README 文件作为项目的文档源是开源软件的常见做法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git blame README.MD</span><br></pre></td></tr></table></figure>

<p>执行上述命令后，我们将获得第一个<code>blame</code>输出示例。以下输出是 <code>README</code> 中全部责备输出的子集。此外，该输出是静态的，反映了本文撰写时软件包的状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ git blame README.md</span><br><span class="line">    82496ea3 (kevzettler     2018-02-28 13:37:02 -0800  1) <span class="comment"># Git Blame example</span></span><br><span class="line">    82496ea3 (kevzettler     2018-02-28 13:37:02 -0800  2)</span><br><span class="line">    89feb84d (Albert So      2018-03-01 00:54:03 +0000  3) This repository is an example of a project with multiple contributors making commits.</span><br><span class="line">    82496ea3 (kevzettler     2018-02-28 13:37:02 -0800  4)</span><br><span class="line">    82496ea3 (kevzettler     2018-02-28 13:37:02 -0800  5) The repo use used elsewhere to demonstrate `git blame`</span><br><span class="line">    82496ea3 (kevzettler     2018-02-28 13:37:02 -0800  6)</span><br><span class="line">    89feb84d (Albert So      2018-03-01 00:54:03 +0000  7) Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed <span class="keyword">do</span> eiusmod TEMPOR incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor <span class="keyword">in</span> reprehenderit <span class="keyword">in</span> voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt <span class="keyword">in</span> culpa qui officia deserunt mollit anim id est laborum</span><br><span class="line">    89feb84d (Albert So      2018-03-01 00:54:03 +0000  8)</span><br><span class="line">    eb06faed (Juni Mukherjee 2018-03-01 19:53:23 +0000  9) Annotates each line <span class="keyword">in</span> the given file with information from the revision <span class="built_in">which</span> last modified the line. Optionally, start annotating from the given revision.</span><br><span class="line">    eb06faed (Juni Mukherjee 2018-03-01 19:53:23 +0000 10)</span><br><span class="line">    548dabed (Juni Mukherjee 2018-03-01 19:55:15 +0000 11) Creating a line to support documentation needs <span class="keyword">for</span> git blame.</span><br><span class="line">    548dabed (Juni Mukherjee 2018-03-01 19:55:15 +0000 12)</span><br><span class="line">    548dabed (Juni Mukherjee 2018-03-01 19:55:15 +0000 13) Also, it is important to have a few of these commits to clearly reflect the who, the what and the when. This will <span class="built_in">help</span> Kev get good screenshots when he runs the git blame on this README.</span><br></pre></td></tr></table></figure>

<p>这是 README.md 文件前 13 行的示例。为了更好地理解这些输出，让我们逐行分析。下表显示的是第 3 行的内容，表中的列表示该列的内容。</p>
<table>
<thead>
<tr>
<th align="left">Id</th>
<th align="center">Author</th>
<th align="center">Timestamp</th>
<th align="center">Line Number</th>
<th align="center">Line Content</th>
</tr>
</thead>
<tbody><tr>
<td align="left">89feb84d</td>
<td align="center">Albert So</td>
<td align="center">2018-03-01 00:54:03 +0000</td>
<td align="center">3</td>
<td align="center">This repository is an example of a project with multiple contributors making commits.</td>
</tr>
</tbody></table>
<p>如果我们查看一下<code>blame</code>输出列表，就会发现一些问题。列表中有三位作者。除了项目维护者 Kev Zettler，还有 Albert So 和 Juni Mukherjee。作者通常是 <code>git blame</code> 输出中最有价值的部分。时间戳列也很有帮助。行内容列则显示了改动的内容。</p>
<h3 id="常见选项"><a href="#常见选项" class="headerlink" title="常见选项"></a>常见选项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git blame -L 1,5 README.md</span><br></pre></td></tr></table></figure>

<p><code>-L</code>选项将把输出限制在所要求的行范围内。在这里，我们将输出限制在第 1 行至第 5 行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git blame -e README.md</span><br></pre></td></tr></table></figure>

<p><code>-e</code>选项显示的是作者的电子邮件地址，而不是用户名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git blame -w README.md</span><br></pre></td></tr></table></figure>

<p><code>-w</code>选项会忽略空白处的改动。如果前作者修改了文件的间距，将制表符换成了空格或添加了新行，那么很不幸，git blame 的输出就会因为显示了这些改动而变得模糊不清。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git blame -M README.md</span><br></pre></td></tr></table></figure>

<p><code>-M</code>选项可检测同一文件中被移动或复制的行。这将报告该行的原作者，而不是移动或复制该行的最后一位作者。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git blame -C README.md</span><br></pre></td></tr></table></figure>

<p><code>-C</code>选项可检测从其他文件中移动或复制的行。这将报告该行的原作者，而不是移动或复制该行的最后一位作者。</p>
<h3 id="Git-blame-vs-git-log"><a href="#Git-blame-vs-git-log" class="headerlink" title="Git blame vs git log"></a>Git blame vs git log</h3><p>虽然 <code>git blame</code> 会显示修改行最后修改的作者，但很多时候您还是想知道一行最初添加的时间。要做到这一点，使用 <code>git blame</code> 可能比较麻烦。这需要结合使用 -w、-C 和 -M 选项。使用 git log 命令会方便得多。</p>
<p>要列出添加或修改特定代码的所有原始提交，请执行带 <code>-S</code> 选项的 <code>git log</code> 命令。在 -S 选项后加上您要查找的代码。让我们以上面 README 输出中的一行为例。让我们以 README 输出第 12 行中的 “CSS3D and WebGL renderers. “为例。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> -S<span class="string">&quot;CSS3D and WebGL renderers.&quot;</span> --pretty=format:<span class="string">&#x27;%h %an %ad %s&#x27;</span></span><br><span class="line">    e339d3c85 Mario Schuettel Tue Oct 13 16:51:06 2015 +0200 reverted README.md to original content</span><br><span class="line">    509c2cc35 Daniel Tue Sep 8 13:56:14 2015 +0200 Updated README</span><br><span class="line">    cb20237cc Mr.doob Mon Dec 31 00:22:36 2012 +0100 Removed DOMRenderer. Now with the CSS3DRenderer it has become irrelevant.</span><br></pre></td></tr></table></figure>

<p>输出结果显示，README 中的内容被 3 位不同的作者添加或修改了 3 次。最初是由 Mr.doob 在 cb20237cc 提交中添加的。在本例中，git log 还预置了 –pretty-format 选项。该选项将 git log 的默认输出格式转换为与 git log 格式一致的格式。有关使用和配置选项的更多信息，请访问 git log 页面。</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p><code>git blame</code> 命令用于逐行检查文件内容，查看每一行的最后修改时间和作者。<code>git blame</code> 的输出格式可以通过各种命令行选项来改变。在线 Git 托管解决方案（如 Bitbucket）提供了责备视图，与使用命令行的 <code>git blame</code> 相比，它能提供更好的用户体验。<code>git log</code> 命令也有一些类似的 blame 功能，如需了解更多，请访问 git log 概述页面。</p>
<hr>
<h1 id="撤消提交和更改"><a href="#撤消提交和更改" class="headerlink" title="撤消提交和更改"></a>撤消提交和更改</h1><p>在本节中，我们将讨论可用的 Git “撤销 “策略和命令。首先需要注意的是，Git 并没有像文字处理程序那样的传统 “撤销 “系统。避免将 Git 操作映射到任何传统的 “撤消 “思维中会有所裨益。此外，Git 有自己的 “撤消 “操作术语，在讨论中最好加以利用。这些术语包括重置（<code>reset</code>）、还原（<code>revert</code>）、签出（<code>checkout</code>）、清理（<code>clean</code>）等。</p>
<p>一个有趣的比喻是把 Git 看成一个时间轴管理工具。提交是项目历史时间轴上某个时间点或兴趣点的快照。此外，还可以通过使用分支来管理多条时间线。在 Git 中进行 “撤消 “时，通常是向后移动，或移动到另一条没有发生错误的时间线上。</p>
<p>本教程提供了处理项目历史版本所需的全部技能。首先，它将向你展示如何探索旧的提交，然后解释在项目历史中恢复公开提交与在本地机器上重置未发布的修改之间的区别。</p>
<h2 id="查找丢失的内容：Reviewing-old-commits"><a href="#查找丢失的内容：Reviewing-old-commits" class="headerlink" title="查找丢失的内容：Reviewing old commits"></a>查找丢失的内容：Reviewing old commits</h2><p>任何版本控制系统背后的理念都是存储项目的 “安全 “副本，这样你就不必担心会不可挽回地破坏你的代码库。一旦建立了项目提交历史，就可以查看和重温历史中的任何提交。<code>git log</code>命令是查看 Git 仓库历史记录的最佳工具之一。在下面的例子中，我们使用<code>git log</code>获取了一个流行的开源图形库的最新提交列表。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline</span><br><span class="line">e2f9a78fe Replaced FlyControls with OrbitControls</span><br><span class="line">d35ce0178 Editor: Shortcuts panel Safari support.</span><br><span class="line">9dbe8d0cf Editor: Sidebar.Controls to Sidebar.Settings.Shortcuts. Clean up.</span><br><span class="line">05c5288fc Merge pull request <span class="comment">#12612 from TyLindberg/editor-controls-panel</span></span><br><span class="line">0d8b6e74b Merge pull request <span class="comment">#12805 from harto/patch-1</span></span><br><span class="line">23b20c22e Merge pull request <span class="comment">#12801 from gam0022/improve-raymarching-example-v2</span></span><br><span class="line">fe78029f1 Fix typo <span class="keyword">in</span> documentation</span><br><span class="line">7ce43c448 Merge pull request <span class="comment">#12794 from WestLangley/dev-x</span></span><br><span class="line">17452bb93 Merge pull request <span class="comment">#12778 from OndrejSpanel/unitTestFixes</span></span><br><span class="line">b5c1b5c70 Merge pull request <span class="comment">#12799 from dhritzkiv/patch-21</span></span><br><span class="line">1b48ff4d2 Updated builds.</span><br><span class="line">88adbcdf6 WebVRManager: Clean up.</span><br><span class="line">2720fbb08 Merge pull request <span class="comment">#12803 from dmarcos/parentPoseObject</span></span><br><span class="line">9ed629301 Check parent of poseObject instead of camera</span><br><span class="line">219f3eb13 Update GLTFLoader.js</span><br><span class="line">15f13bb3c Update GLTFLoader.js</span><br><span class="line">6d9c22a3b Update uniforms only when onWindowResize</span><br><span class="line">881b25b58 Update ProjectionMatrix on change aspect</span><br></pre></td></tr></table></figure>

<p>每个提交（<code>commit</code>）都有一个唯一的<code>SHA-1</code>哈希值。这些 ID 用于浏览提交时间线和重访提交。默认情况下，<code>git log</code> 只显示当前选定分支的提交。您要找的提交完全有可能在另一个分支上。您可以执行 <code>git log --branches=*</code>，查看所有其他分支的所有提交。<code>git branch</code> 命令用于查看和访问其他分支。调用 <code>git branch -a</code> 命令将返回所有已知分支名称的列表。然后可以使用<code>git log</code>.</p>
<p>当找到要访问的历史节点的某个提交引用时，就可以使用<code>git checkout</code>命令访问该提交。Git 签出是将这些保存的快照 “加载 “到开发机器上的简单方法。在正常开发过程中，<code>HEAD</code>通常指向主分支或其他本地分支，但当你签出之前的提交时，<code>HEAD</code>不再指向分支，而是直接指向某个提交。这就是所谓的 “分离 HEAD “状态，可视化如下：</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-detached-head.png" style="zoom:50%;" />

<h2 id="查看旧版本"><a href="#查看旧版本" class="headerlink" title="查看旧版本"></a>查看旧版本</h2><p>此示例假设您已经开始开发一个疯狂的实验，但您不确定是否要保留它。为了帮助您做出决定，您需要在开始实验之前查看项目的状态。首先，您需要找到您想要查看的修订版本的 ID。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline</span><br></pre></td></tr></table></figure>

<p>假设您的项目历史记录如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">b7119f2 Continue doing crazy things</span><br><span class="line">872fa7e Try something crazy</span><br><span class="line">a1e8fb5 Make some important changes to hello.txt</span><br><span class="line">435b61d Create hello.txt</span><br><span class="line">9773e52 Initial import</span><br></pre></td></tr></table></figure>

<p>您可以使用 <code>git checkout</code> 查看 “对 hello.txt 做一些导入改动 “的提交，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout a1e8fb5</span><br></pre></td></tr></table></figure>

<p>这将使你的工作目录与 a1e8fb5 提交时的状态完全一致。你可以查看文件、编译项目、运行测试，甚至编辑文件，而不必担心丢失项目的当前状态。在这里所做的一切都不会保存到版本库中。要继续开发，就必须回到项目的 “当前 “状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout main</span><br></pre></td></tr></table></figure>

<p>这假定您正在默认的主分支上进行开发。回到主分支后，您可以使用 <code>git revert</code> 或 <code>git reset</code> 撤销任何不希望的改动。</p>
<h2 id="撤销已提交的快照"><a href="#撤销已提交的快照" class="headerlink" title="撤销已提交的快照"></a>撤销已提交的快照</h2><p>从技术上讲，”撤销 “提交有几种不同的策略。下面的示例假定我们的提交历史如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline</span><br><span class="line">872fa7e Try something crazy</span><br><span class="line">a1e8fb5 Make some important changes to hello.txt</span><br><span class="line">435b61d Create hello.txt</span><br><span class="line">9773e52 Initial import</span><br></pre></td></tr></table></figure>

<p>我们将重点撤销 872fa7e Try something crazy 提交。也许事情有点太疯狂了。</p>
<h3 id="如何使用-git-checkout-撤销提交"><a href="#如何使用-git-checkout-撤销提交" class="headerlink" title="如何使用 git checkout 撤销提交"></a>如何使用 git checkout 撤销提交</h3><p>使用 <code>git checkout</code> 命令，我们可以签出上一个提交（a1e8fb5），使仓库处于疯狂提交之前的状态。签出特定提交将使版本库处于 “分离 HEAD “状态。这意味着你不再在任何分支上工作。在分离状态下，当你将分支改回已建立的分支时，你所做的任何新提交都将成为孤儿。孤儿提交会被 Git 的垃圾回收器删除。垃圾回收器会按照设定的时间间隔运行，并永久销毁已成为孤儿的提交。为了防止被垃圾回收器回收的提交，我们需要确保自己在一个分支上。</p>
<p>在分离的 HEAD 状态下，我们可以执行 <code>git checkout -b new_branch_without_crazy_commit</code>。这将创建一个名为 <code>new_branch_without_crazy_commit</code> 的新分支，并切换到该状态。现在，该 repo 已进入新的历史时间线，其中的 872fa7e 提交已不复存在。此时，我们可以继续在这个新分支上工作，而 872fa7e 提交已不复存在，并将其视为 “撤消”。不幸的是，如果你需要之前的分支，也许它是你的主分支，那么这种撤消策略就不合适了。让我们看看其他一些 “撤销 “策略。如需了解更多信息和示例，请参阅我们的 git check 深入讨论。</p>
<h3 id="如何用-git-revert-撤销公开提交"><a href="#如何用-git-revert-撤销公开提交" class="headerlink" title="如何用 git revert 撤销公开提交"></a>如何用 git revert 撤销公开提交</h3><p>让我们回到最初的提交历史示例。包含 872fa7e 提交的历史。这一次，让我们试试 “撤销”（undo）。如果我们执行 <code>git revert HEAD</code>，Git 会创建一个与上次提交相反的新提交。这就在当前分支历史中添加了一个新的提交，现在看起来就像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline</span><br><span class="line">e2f9a78 Revert <span class="string">&quot;Try something crazy&quot;</span></span><br><span class="line">872fa7e Try something crazy</span><br><span class="line">a1e8fb5 Make some important changes to hello.txt</span><br><span class="line">435b61d Create hello.txt</span><br><span class="line">9773e52 Initial import</span><br></pre></td></tr></table></figure>

<p>至此，我们在技术上再次 “撤销 “了 872fa7e 提交。虽然 872fa7e 仍存在于历史中，但新的 e2f9a78 提交是 872fa7e 变动的反转。与之前的签出策略不同，我们可以继续使用同一分支。这个解决方案的撤消效果令人满意。这是处理公共共享源的理想 “撤销 “方法。如果您需要保留精选且最少的 Git 历史记录，则此策略可能无法令人满意。</p>
<h3 id="如何使用-git-reset-撤消提交"><a href="#如何使用-git-reset-撤消提交" class="headerlink" title="如何使用 git reset 撤消提交"></a>如何使用 git reset 撤消提交</h3><p><code>git reset</code> 是一个用途广泛、功能多样的命令。如果我们调用 <code>git reset --hard a1e8fb5</code>，提交历史将重置为指定的提交。现在用<code>git log</code>查看提交历史会如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline</span><br><span class="line">a1e8fb5 Make some important changes to hello.txt</span><br><span class="line">435b61d Create hello.txt</span><br><span class="line">9773e52 Initial import</span><br></pre></td></tr></table></figure>

<p>交历史中。此时，我们可以继续工作并创建新的提交，就好像这些 “疯狂 “的提交从未发生过一样。这种撤销修改的方法对历史记录的影响最为干净。<code>reset</code> 对于本地变更来说很好，但在使用共享远程版本库时却会增加复杂性。如果我们有一个推送了 872fa7e 提交的共享远程仓库，而我们试图用 git 推送一个我们已经重置了历史的分支，Git 会捕捉到这一点并抛出一个错误。Git 会认为推送的分支因为缺少提交而不是最新的。在这种情况下，<code>git revert</code> 应该是首选的撤销方法。</p>
<h3 id="撤销最后一次提交"><a href="#撤销最后一次提交" class="headerlink" title="撤销最后一次提交"></a>撤销最后一次提交</h3><p>在上一节中，我们讨论了撤销提交的不同策略。这些策略同样适用于最近的提交。不过在某些情况下，你可能并不需要删除或重置最后一次提交。也许只是提交时间过早。在这种情况下，您可以修改最近的提交。一旦你在工作目录中做了更多改动，并用 <code>git add</code> 将它们暂存以备提交，你就可以执行 <code>git commit --amend</code>。这会让 Git 打开配置好的系统编辑器，让你修改上次的提交信息。新的改动将被添加到修改后的提交中。</p>
<h3 id="撤销公开更改"><a href="#撤销公开更改" class="headerlink" title="撤销公开更改"></a>撤销公开更改</h3><p>当在一个拥有远程仓库的团队中工作时，在撤销更改时需要格外注意。<code>Git reset</code> 通常被视为一种 “本地 “撤销方法。在撤销私有分支的变更时，应使用重置。这样可以安全地将提交与其他开发者正在使用的分支隔离开来。如果在共享分支上执行重置，然后用 git push 远程推送该分支，就会出现问题。在这种情况下，Git 会阻止推送，抱怨被推送的分支与远程分支不同步，因为缺少提交。</p>
<p>撤销共享版本库的首选方法是 <code>git revert</code>。<code>revert</code>比<code>reset</code>更安全，因为它不会从共享版本库历史中删除任何提交。还原会保留要撤销的提交，并创建一个新的提交来反转不想要的提交。这种方法对于共享远程协作更安全，因为远程开发人员可以拉取分支，然后接收新的还原提交，从而撤销不想要的提交。</p>
<h2 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h2><p>我们介绍了许多在 Git 中撤销的高级策略。重要的是要记住，在 Git 项目中 “撤销 “的方法不止一种。本页讨论的大部分内容都涉及更深层次的话题，而这些话题在相关 Git 命令的具体页面中会有更详尽的解释。最常用的 “撤销 “工具是 <code>git checkout</code>、<code>git revert</code> 和 <code>git reset</code>。需要记住的要点有：</p>
<ul>
<li>修改一旦提交，通常就是永久性的</li>
<li>使用 <code>git checkout</code> 查看历史提交</li>
<li><code>git revert</code> 是撤销共享版本库的公共修改的最佳工具</li>
<li><code>git reset</code> 是撤销本地私有修改的最佳工具</li>
</ul>
<p>除了主要的撤消命令，我们还学习了其他 Git 工具：用于查找丢失提交的 git log、用于撤消未提交改动的 git clean、用于修改暂存索引的 git add。</p>
<p>每个命令都有自己的深入文档。要进一步了解此处提到的某个命令，请访问相应链接。</p>
<h2 id="git-clean"><a href="#git-clean" class="headerlink" title="git clean"></a>git clean</h2><p> 在本节中，我们将重点详细讨论 <code>git clean</code> 命令。<code>git clean</code> 在某种程度上是一个 “撤销 “命令。<code>git clean</code> 可以说是其他命令（如 <code>git reset</code> 和 <code>git checkout</code>）的补充。这些命令针对的是之前添加到 Git 跟踪索引中的文件，而 <code>git clean</code> 命令针对的是未被跟踪的文件。未跟踪文件是指在您的 repo 工作目录中创建的、但尚未使用 git add 命令添加到版本库跟踪索引中的文件。</p>
<p>为了更好地展示跟踪文件和非跟踪文件的区别，请看下面的命令行示例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir git_clean_test</span><br><span class="line">$ <span class="built_in">cd</span> git_clean_test/</span><br><span class="line">$ git init .</span><br><span class="line">Initialized empty Git repository <span class="keyword">in</span> /Users/kev/code/git_clean_test/.git/</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;tracked&quot;</span> &gt; ./tracked_file</span><br><span class="line">$ git add ./tracked_file</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;untracked&quot;</span> &gt; ./untracked_file</span><br><span class="line">$ mkdir ./untracked_dir &amp;&amp; touch ./untracked_dir/file</span><br><span class="line">$ git status</span><br><span class="line">On branch master</span><br><span class="line"></span><br><span class="line">Initial commit</span><br><span class="line"></span><br><span class="line">Changes to be committed: (use <span class="string">&quot;git rm --cached &lt;file&gt;...&quot;</span> to unstage)</span><br><span class="line"></span><br><span class="line">new file: tracked_file</span><br><span class="line"></span><br><span class="line">Untracked files: (use <span class="string">&quot;git add &lt;file&gt;...&quot;</span> to include <span class="keyword">in</span> what will be committed) untracked_dir/ untracked_file</span><br></pre></td></tr></table></figure>

<p>该示例在 git_clean_test 目录下创建了一个新的 Git 仓库。然后创建了一个跟踪文件（tracked_file），并将其添加到 Git 索引中，此外还创建了一个未跟踪文件（untracked_file）和一个未跟踪目录（untracked_dir）。然后，示例调用了 git status，输出显示了 Git 内部已跟踪和未跟踪的变更状态。有了这样的仓库状态，我们就可以执行 <code>git clean</code> 命令来演示其预期目的了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clean fatal: clean.requireForce defaults to <span class="literal">true</span> and neither -i, -n, nor -f given; refusing to clean</span><br></pre></td></tr></table></figure>

<p>此时，执行默认的 <code>git clean</code> 命令可能会产生致命错误。上面的例子演示了这种情况。默认情况下，Git 的全局配置要求 <code>git clean</code> 必须通过 “<code>force</code> “选项才能启动。这是一个重要的安全机制。当最后执行时，<code>git clean</code> 是不可撤销的。完全执行后，<code>git clean</code> 会硬性删除文件系统，类似于执行命令行 <code>rm</code> 工具。运行前请确保您真的想删除未跟踪的文件。</p>
<h3 id="常用选项和用法"><a href="#常用选项和用法" class="headerlink" title="常用选项和用法"></a>常用选项和用法</h3><p>鉴于前面对 git 清理默认行为和注意事项的解释，下面的内容将演示各种 git 清理用例及其操作所需的命令行选项。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-n</span><br></pre></td></tr></table></figure>

<p>-n 选项将执行 git clean 的“试运行”。这会显示哪些文件将被移除，但不会真正移除。最好的做法是先执行一次<code>git clean</code> “试运行 “。我们可以在之前创建的演示版本中演示这个选项。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git clean -n</span><br><span class="line">Would remove untracked_file</span><br></pre></td></tr></table></figure>

<p>输出结果告诉我们，当执行 <code>git clean</code> 命令时，untracked_file 将被移除。注意这里的输出没有报告 untracked_dir。默认情况下，git clean 不会对目录进行递归操作。这是防止意外永久删除的另一种安全机制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-f or --force</span><br></pre></td></tr></table></figure>

<p>强制选项会启动实际删除当前目录中未跟踪文件的操作。除非 clean.requireForce 配置选项设置为 false，否则强制是必须的。这不会删除 .gitignore 指定的未跟踪文件夹或文件。现在让我们在示例仓库中执行一次实时的 git clean。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git clean -f </span><br><span class="line">Removing untracked_file</span><br></pre></td></tr></table></figure>

<p>该命令将输出已删除的文件。这里可以看到 untracked_file 已被删除。此时执行 git status 或进行 ls 将显示 untracked_file 已被删除，并且无处可寻。默认情况下，<code>git clean -</code>f 会对当前目录下所有未被跟踪的文件执行操作。此外，还可以通过 <code>-f</code> 选项传递 <code>&lt; path &gt;</code> 值来删除特定文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clean -f &lt;path&gt;</span><br><span class="line">-d include directories</span><br></pre></td></tr></table></figure>

<p><code>-d</code>选项会告诉<code>git clean</code>您还想移除任何未跟踪的目录，默认情况下它会忽略这些目录。我们可以在之前的例子中添加 -d 选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git clean -dn</span><br><span class="line">Would remove untracked_dir/</span><br><span class="line">$ git clean -df</span><br><span class="line">Removing untracked_dir/</span><br></pre></td></tr></table></figure>

<p>在这里，我们使用 -dn 组合执行了一次 “试运行”，输出结果是 untracked_dir 将被移除。然后，我们执行了强制清理，得到的输出结果是 untracked_dir 已被删除。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-x force removal of ignored files</span><br></pre></td></tr></table></figure>

<p>一种常见的软件发布模式是建立一个未提交到版本库跟踪索引的构建或发布目录。构建目录将包含从已提交源代码生成的短暂构建工程。该构建目录通常会添加到版本库的 <code>.gitignore</code> 文件中。清理该目录中的其他未跟踪文件也很方便。<code>-x</code> 选项会告诉 <code>git clean</code> 也包含任何被忽略的文件。与之前的 git clean 一样，在最终删除之前，最好先执行一次 “试运行”。-x 选项将作用于所有被忽略的文件，而不仅仅是项目构建时特定的文件。比如 ./.idea IDE 配置文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clean -xf</span><br></pre></td></tr></table></figure>

<p>与 <code>-d</code> 选项一样，<code>-x</code> 可以与其他选项一起传递和组合。本例演示了与 <code>-f</code> 的组合，可以移除当前目录中未跟踪的文件以及 Git 忽略的文件。</p>
<h3 id="交互模式或-git-clean-交互式"><a href="#交互模式或-git-clean-交互式" class="headerlink" title="交互模式或 git clean 交互式"></a>交互模式或 git clean 交互式</h3><p>除了我们已经演示过的临时命令行执行外，git clean 还有一个 “交互式 “模式，可以通过 <code>-i</code> 选项启动。让我们重温一下本文导言中的示例仓库。在初始状态下，我们将启动一个交互式的清理会话。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git clean -di</span><br><span class="line">Would remove the following items:</span><br><span class="line">  untracked_dir/  untracked_file</span><br><span class="line">*** Commands ***</span><br><span class="line">    1: clean                2: filter by pattern    3: select by numbers    4: ask each             5: quit                 6: <span class="built_in">help</span></span><br><span class="line">What now&gt;</span><br></pre></td></tr></table></figure>

<p>我们使用 -d 选项启动了交互式会话，因此它也会作用于 untracked_dir。交互模式将显示 “What now&gt; “提示，要求对未跟踪文件执行命令。命令本身很容易解释。我们将从命令 6：帮助开始，按随机顺序简要介绍每条命令。选择命令 6 将进一步解释其他命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">What now&gt; 6</span><br><span class="line">clean               - start cleaning</span><br><span class="line">filter by pattern   - exclude items from deletion</span><br><span class="line">select by numbers   - select items to be deleted by numbers</span><br><span class="line">ask each            - confirm each deletion (like <span class="string">&quot;rm -i&quot;</span>)</span><br><span class="line">quit                - stop cleaning</span><br><span class="line"><span class="built_in">help</span>                - this screen</span><br><span class="line">?                   - <span class="built_in">help</span> <span class="keyword">for</span> prompt selection</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5: quit</span><br></pre></td></tr></table></figure>

<p>直截了当，退出互动会话。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1: clean</span><br></pre></td></tr></table></figure>

<p>将删除指定的项目。如果此时执行 1: <code>clean</code>，<code>untracked_dir/ untracked_file</code> 将被删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4: ask each</span><br></pre></td></tr></table></figure>

<p>会遍历每个未跟踪的文件，并显示 “<code>Y/N</code> “提示是否删除。如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*** Commands ***</span><br><span class="line">    1: clean                2: filter by pattern    3: select by numbers    4: ask each             5: quit                 6: <span class="built_in">help</span></span><br><span class="line">What now&gt; 4</span><br><span class="line">Remove untracked_dir/ [y/N]? N</span><br><span class="line">Remove untracked_file [y/N]? N</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2: filter by pattern</span><br></pre></td></tr></table></figure>

<p>将显示额外提示，输入用于过滤未跟踪文件列表的信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Would remove the following items:</span><br><span class="line">  untracked_dir/  untracked_file</span><br><span class="line">*** Commands ***</span><br><span class="line">    1: clean                2: filter by pattern    3: select by numbers    4: ask each             5: quit                 6: <span class="built_in">help</span></span><br><span class="line">What now&gt; 2</span><br><span class="line">  untracked_dir/  untracked_file</span><br><span class="line">Input ignore patterns&gt;&gt; *_file</span><br><span class="line">  untracked_dir/</span><br></pre></td></tr></table></figure>

<p>在这里，我们输入 <code>*_file</code> 通配符模式，然后将未跟踪文件列表限制为 untracked_dir。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3: select by numbers</span><br></pre></td></tr></table></figure>

<p>与命令 2 类似，命令 3 的作用也是完善未跟踪文件名列表。交互会话将提示输入与未跟踪文件名相对应的数字。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Would remove the following items:</span><br><span class="line">  untracked_dir/  untracked_file</span><br><span class="line">*** Commands ***</span><br><span class="line">    1: clean                2: filter by pattern    3: select by numbers    4: ask each             5: quit                 6: <span class="built_in">help</span></span><br><span class="line">What now&gt; 3</span><br><span class="line">    1: untracked_dir/    2: untracked_file</span><br><span class="line">Select items to delete&gt;&gt; 2</span><br><span class="line">    1: untracked_dir/  * 2: untracked_file</span><br><span class="line">Select items to delete&gt;&gt;</span><br><span class="line">Would remove the following item:</span><br><span class="line">  untracked_file</span><br><span class="line">*** Commands ***</span><br><span class="line">    1: clean                2: filter by pattern    3: select by numbers    4: ask each             5: quit                 6: <span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<h3 id="Summary-2"><a href="#Summary-2" class="headerlink" title="Summary"></a>Summary</h3><p>概括地说，git clean 是一种方便的方法，用于删除 repo 工作目录中未被跟踪的文件。未跟踪文件是指那些在仓库目录中，但尚未被 git add 添加到仓库索引中的文件。总的来说，git clean 的效果可以通过使用 git status 和操作系统原生的删除工具来实现。Git clean 可与 git reset 同时使用，以完全撤销版本库中的任何新增和提交。</p>
<h2 id="git-revert"><a href="#git-revert" class="headerlink" title="git revert"></a>git revert</h2><p>git revert 命令可被视为 “撤销 “类型的命令，但它并不是传统的撤销操作。它不是从项目历史中删除提交，而是找出如何反转提交带来的改动，并用反转后的内容追加新的提交。这可以防止 Git 丢失历史记录，而这对于保持修订历史的完整性和可靠的协作非常重要。</p>
<p>当你想从项目历史中应用逆向提交时，就应该使用还原。例如，如果你在追踪一个 Bug 时发现它是由一次提交引入的，这就很有用了。你可以使用 git revert 自动完成所有这些工作，而不用手动去修复它，再提交一个新的快照。</p>
<h3 id="How-it-works-2"><a href="#How-it-works-2" class="headerlink" title="How it works"></a>How it works</h3><p>git revert 命令用于撤销对版本库提交历史的修改。其他 “撤消 “命令，如 git checkout 和 git reset，会将 HEAD 和分支的 ref 指针移动到指定的提交。git revert 也需要指定的提交，但 git revert 不会将 ref 指针移动到该提交。</p>
<p>还原操作会使用指定的提交，反转该提交的改动，并创建一个新的 “还原提交”。然后 ref 指针就会更新，指向新的 revert 提交，使其成为分支的顶端。</p>
<p>为了演示，让我们使用下面的命令行示例创建一个 repo：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir git_revert_test</span><br><span class="line">$ <span class="built_in">cd</span> git_revert_test/</span><br><span class="line">$ git init .</span><br><span class="line">Initialized empty Git repository <span class="keyword">in</span> /git_revert_test/.git/</span><br><span class="line">$ touch demo_file</span><br><span class="line">$ git add demo_file</span><br><span class="line">$ git commit -am<span class="string">&quot;initial commit&quot;</span></span><br><span class="line">[main (root-commit) 299b15f] initial commit</span><br><span class="line"> 1 file changed, 0 insertions(+), 0 deletions(-)</span><br><span class="line"> create mode 100644 demo_file</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;initial content&quot;</span> &gt;&gt; demo_file</span><br><span class="line">$ git commit -am<span class="string">&quot;add new content to demo file&quot;</span></span><br><span class="line">[main 3602d88] add new content to demo file</span><br><span class="line">n 1 file changed, 1 insertion(+)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;prepended line content&quot;</span> &gt;&gt; demo_file</span><br><span class="line">$ git commit -am<span class="string">&quot;prepend content to demo file&quot;</span></span><br><span class="line">[main 86bb32e] prepend content to demo file</span><br><span class="line"> 1 file changed, 1 insertion(+)</span><br><span class="line">$ git <span class="built_in">log</span> --oneline</span><br><span class="line">86bb32e prepend content to demo file</span><br><span class="line">3602d88 add new content to demo file</span><br><span class="line">299b15f initial commit</span><br></pre></td></tr></table></figure>

<p>在这里，我们在名为 git_revert_test 的新建目录中初始化了一个 repo。我们对 repo 进行了 3 次提交，其中添加了一个文件 demo_file，并对其内容修改了两次。在仓库设置过程的最后，我们调用了 git log 来显示提交历史，总共显示了 3 次提交。这样，我们就可以启动 git revert 了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git revert HEAD</span><br><span class="line">[main b9cd081] Revert <span class="string">&quot;prepend content to demo file&quot;</span> 1 file changed, 1 deletion(-)</span><br></pre></td></tr></table></figure>

<p>git revert 希望传递一个提交引用，否则不会执行。这里我们传入了 HEAD。这将还原最新的提交。这与还原 3602d8815dbfa78cd37cd4d189552764b5e96c58 提交的行为相同。与合并类似，还原将创建一个新的提交，并打开配置的系统编辑器，提示输入新的提交信息。输入并保存提交信息后，Git 将恢复运行。现在我们可以用 git 日志查看 repo 的状态，发现在之前的日志中添加了新的提交：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> --oneline 1061e79 Revert <span class="string">&quot;prepend content to demo file&quot;</span> 86bb32e prepend content to demo file 3602d88 add new content to demo file 299b15f initial commit</span><br></pre></td></tr></table></figure>

<p>请注意，第 3 次提交在还原后仍在项目历史中。git revert 并没有删除它，而是添加了一个新的提交来撤销它的改动。因此，第 2 次和第 4 次提交代表的是完全相同的代码库，而第 3 次提交仍保留在历史记录中，以备日后回溯。</p>
<h3 id="常见选项-1"><a href="#常见选项-1" class="headerlink" title="常见选项"></a>常见选项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-e</span><br><span class="line">--edit</span><br></pre></td></tr></table></figure>

<p>这是默认选项，无需指定。该选项将打开配置的系统编辑器，并提示你在提交还原之前编辑提交信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--no-edit</span><br></pre></td></tr></table></figure>

<p>这与 <code>-e</code> 选项相反。revert 不会打开编辑器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-n</span><br><span class="line">--no-commit</span><br></pre></td></tr></table></figure>

<p>传递此选项将阻止 git revert 创建一个与目标提交相反的新提交。该选项不会创建新的提交，而是将反转的改动添加到暂存索引和工作目录中。这些是 Git 用来管理仓库状态的其他树。更多信息，请访问 git reset页面。</p>
<h3 id="Resetting-vs-reverting"><a href="#Resetting-vs-reverting" class="headerlink" title="Resetting vs. reverting"></a>Resetting vs. reverting</h3><p>重要的是要明白，git revert 只撤销一次提交，而不是通过删除所有后续提交来 “还原 “到项目之前的状态。在 Git 中，这被称为重置，而非还原。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-reverting-resetting.png" style="zoom:50%;" />

<p>与<code>resetting</code>相比，<code>Reverting</code>有两个重要优势。首先，它不会改变项目历史，因此对于已经发布到共享仓库的提交来说，这是一个 “安全 “的操作。关于更改共享历史为何是危险的，请参阅 git reset 页面。</p>
<p>其次，git revert 可以针对历史中任意点的单个提交，而 git reset 只能从当前提交向后操作。举例来说，如果想用 git reset来撤消一次旧提交，就必须移除目标提交之后的所有提交，移除之后再重新提交所有后续提交。不用说，这不是一个优雅的撤消解决方案。关于 git revert 与其他 “撤消 “命令的区别，请参阅重置、签出和回退。 </p>
<h3 id="Summary-3"><a href="#Summary-3" class="headerlink" title="Summary"></a>Summary</h3><p>git revert 命令是一种向前移动的撤销操作，它提供了一种安全的撤销修改的方法。它不会删除或销毁提交历史中的提交，而是创建一个新的提交来反转指定的改动。就丢失工作而言，git revert 是比 git reset 更安全的选择。</p>
<h2 id="git-reset"><a href="#git-reset" class="headerlink" title="git reset"></a>git reset</h2><p><code>git reset</code>命令是一个复杂的多功能工具，用于撤销更改。它有三种主要的调用形式。这些形式与命令行参数<code>--soft</code>, <code>--mixed</code>, <code>--hard</code>相对应。这三个参数分别对应 Git 的三个内部状态管理机制：提交树（HEAD）、暂存索引和工作目录。</p>
<h3 id="git-reset-amp-git-三棵树"><a href="#git-reset-amp-git-三棵树" class="headerlink" title="git reset &amp; git 三棵树"></a>git reset &amp; git 三棵树</h3><p>要正确理解 <code>git reset</code>的用法，我们必须先了解 Git 的内部状态管理系统。这些机制有时被称为 Git 的 “三棵树”。三棵树 “可能名不副实，因为它们并非严格意义上的传统树形数据结构。不过，它们是基于节点和指针的数据结构，Git 用它来跟踪编辑的时间轴。演示这些机制的最佳方式是在版本库中创建一个变更集，并通过三棵树来跟踪它。</p>
<p>首先，我们将使用下面的命令创建一个新的版本库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir git_reset_test</span><br><span class="line">$ <span class="built_in">cd</span> git_reset_test/</span><br><span class="line">$ git init .</span><br><span class="line">Initialized empty Git repository <span class="keyword">in</span> /git_reset_test/.git/</span><br><span class="line">$ touch reset_lifecycle_file</span><br><span class="line">$ git add reset_lifecycle_file</span><br><span class="line">$ git commit -m<span class="string">&quot;initial commit&quot;</span></span><br><span class="line">[main (root-commit) d386d86] initial commit</span><br><span class="line">1 file changed, 0 insertions(+), 0 deletions(-)</span><br><span class="line">create mode 100644 reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>上面的示例代码创建了一个新的 git 仓库，其中只有一个空文件 <code>reset_lifecycle_file</code>。此时，示例仓库中只有一次提交 (d386d86) 是在添加 reset_lifecycle_file 时提交的。</p>
<h3 id="The-working-directory"><a href="#The-working-directory" class="headerlink" title="The working directory"></a>The working directory</h3><p>我们要查看的第一个树是 “工作目录”。这棵树与本地文件系统同步，代表着对文件和目录内容所做的即时更改。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;hello git reset&#x27;</span> &gt; reset_lifecycle_file</span><br><span class="line"> $ git status </span><br><span class="line"> On branch main</span><br><span class="line"> Changes not staged <span class="keyword">for</span> commit: </span><br><span class="line"> (use <span class="string">&quot;git add ...&quot;</span> to update what will be committed) </span><br><span class="line"> (use <span class="string">&quot;git checkout -- ...&quot;</span> to discard changes <span class="keyword">in</span> working directory) </span><br><span class="line"> modified: reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>在我们的演示版本库中，我们修改了 reset_lifecycle_file 并添加了一些内容。调用 git status 可以看到 Git 已经知道了文件的改动。这些改动目前是第一个树 “工作目录 “的一部分。<code>git status</code> 可以用来显示工作目录的改动。它们将以红色显示，并带有 “modified”前缀。</p>
<h3 id="Staging-index"><a href="#Staging-index" class="headerlink" title="Staging index"></a>Staging index</h3><p>接下来是 “暂存索引 “树。这棵树会跟踪工作目录中的变更，这些变更已通过 git add 进行了暂存，并将存储在下一次提交中。这棵树是一个复杂的内部缓存机制。git 通常会尽量向用户隐藏暂存索引的执行细节。</p>
<p>接下来是 “暂存索引 “树。这棵树会跟踪工作目录中的变更，这些变更已通过 git add 进行了推广，并将存储在下一次提交中。这棵树是一个复杂的内部缓存机制。Git 通常会尽量向用户隐藏暂存索引的执行细节。</p>
<p>要准确查看暂存索引的状态，我们必须使用一个鲜为人知的 Git 命令 <code>git ls-files</code>。<code>git ls-files</code> 命令本质上是一个用于检查暂存索引树状态的调试工具。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git ls-files -s</span><br><span class="line">100644 e69de29bb2d1d6434b8b29ae775ad8c2e48c5391 0   reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>这里我们使用了 <code>-s</code> 或 <code>--stage</code> 选项来执行 <code>git ls-files</code>。不使用 <code>-s</code> 选项时，git ls-files 的输出只是一个当前索引中的文件名和路径列表。-s选项会显示暂存索引中文件的附加元数据。这些元数据包括暂存内容的模式位、对象名称和阶段编号。在这里，我们感兴趣的是对象名称的第二个值（d7d77c1b04b5edd5acfc85de0b592449e5303770）。这是标准的 Git 对象 SHA-1 哈希值。它是文件内容的哈希值。提交历史存储了自己的 SHA 对象，用于识别提交和引用的指针，暂存索引也有自己的 SHA 对象，用于跟踪索引中文件的版本。</p>
<p>接下来，我们将把修改后的 reset_lifecycle_file 加到暂存索引中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ git add reset_lifecycle_file </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">$ git status </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">On branch main Changes to be committed: </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">(use <span class="string">&quot;git reset HEAD ...&quot;</span> to unstage) </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">modified: reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>在这里，我们调用了 git add reset_lifecycle_file，将文件添加到了暂存索引中。现在调用 git status，reset_lifecycle_file 在 “Changes to be committed”下显示为绿色。需要注意的是，git status 并不能真实反映暂存索引。git status 命令输出显示的是提交历史和暂存索引之间的变化。让我们来看看暂存索引的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git ls-files -s 100644 d7d77c1b04b5edd5acfc85de0b592449e5303770 0 reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>我们可以看到，reset_lifecycle_file 的对象 SHA 哈希值已从 e69de29bb2d1d6434b8b29ae775ad8c2e48c5391 更新为 d7d77c1b04b5edd5acfc85de0b592449e5303770。</p>
<h3 id="Commit-history"><a href="#Commit-history" class="headerlink" title="Commit history"></a>Commit history</h3><p>最后一棵树是提交历史。git commit 命令会将修改添加到永久快照中，该快照保存在 “提交历史 “中。该快照还包括提交时暂存索引的状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git commit -am<span class="string">&quot;update content of reset_lifecycle_file&quot;</span></span><br><span class="line">[main dc67808] update content of reset_lifecycle_file</span><br><span class="line">1 file changed, 1 insertion(+)</span><br><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">nothing to commit, working tree clean</span><br></pre></td></tr></table></figure>

<p>在这里，我们创建了一个新提交，其信息为 “更新 resetlifecyclefile 的内容”。该变更集已被添加到提交历史中。此时调用 git status 会显示没有任何待处理的修改。执行 git log 会显示提交历史。现在，我们已经在三棵树中跟踪了这个变更集，可以开始使用 git reset了。</p>
<h3 id="How-it-works-3"><a href="#How-it-works-3" class="headerlink" title="How it works"></a>How it works</h3><p>从表面上看，git reset 的行为与 git checkout 类似。git checkout 只对 HEAD ref 指针进行操作，而 git reset 则会移动 HEAD ref 指针和当前分支 ref 指针。为了更好地演示这一行为，请看下面的例子：</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-head-mian.png" style="zoom:50%;" />

<p>这个例子演示了主分支上的一系列提交。现在让我们执行并比较一下 <code>git checkout b</code> 和 <code>git reset b</code>。</p>
<p><strong>git checkout b</strong></p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-checkout-b.png" style="zoom:50%;" />

<p>通过 git checkout，Main引用仍指向 d。HEAD 引用已被移动，现在指向提交 b。</p>
<p><strong>git reset b</strong></p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-reset-b.png" style="zoom:50%;" />

<p>相比之下，git reset 会把 HEAD 和 Main 分支的引用都移到指定的提交上。</p>
<p>除了更新commit ref 指针，git 重置还会修改三棵树的状态。ref 指针的修改总是会发生，而且是对第三棵树，即提交树的更新。命令行参数–soft、–mixed 和–hard 会指示如何修改暂存索引树和工作目录树。</p>
<h3 id="主要选项"><a href="#主要选项" class="headerlink" title="主要选项"></a>主要选项</h3><p>git reset 的默认参数是 <code>--mixed HEAD</code>。这意味着执行 <code>git reset</code> 等同于执行 <code>git reset --mixed HEAD</code>。在这种形式中，HEAD 就是指定的提交。可以使用任何 Git SHA-1 commit哈希值来代替 HEAD。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-reset-models.png" style="zoom:50%;" />

<h4 id="‘–hard"><a href="#‘–hard" class="headerlink" title="‘–hard"></a>‘–hard</h4><p>这是最直接、最危险和最常用的选项。当使用 <code>--hard</code> 时，提交历史 ref 指针会更新到指定的提交。然后，暂存索引和工作目录会重置为与指定提交一致。任何之前对暂存索引和工作目录的待定更改都会被重置，以匹配提交树的状态。这意味着暂存索引和工作目录中的任何待处理工作都将丢失。</p>
<p>为了演示这一点，让我们继续之前建立的三棵树示例 repo。首先，让我们对 repo 做一些修改。在示例 repo 中执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;new file content&#x27;</span> &gt; new_file</span><br><span class="line">$ git add new_file</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;changed content&#x27;</span> &gt;&gt; reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>这些命令创建了一个名为 new_file 的新文件，并将其添加到 repo 中。此外，reset_lifecycle_file 的内容也会被修改。有了这些改动，现在让我们用 git status 查看一下 repo 的状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">Changes to be committed:</span><br><span class="line">   (use <span class="string">&quot;git reset HEAD ...&quot;</span> to unstage)</span><br><span class="line"></span><br><span class="line">new file: new_file</span><br><span class="line"></span><br><span class="line">Changes not staged <span class="keyword">for</span> commit:</span><br><span class="line">   (use <span class="string">&quot;git add ...&quot;</span> to update what will be committed)</span><br><span class="line">   (use <span class="string">&quot;git checkout -- ...&quot;</span> to discard changes <span class="keyword">in</span> working directory)</span><br><span class="line"></span><br><span class="line">modified: reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>在这里，我们调用了 git add reset_lifecycle_file，将文件添加到了暂存索引中。现在调用 git status，reset_lifecycle_file 在 “Changes to be committed “下显示为绿色。</p>
<p>需要注意的是，git status 并不能真实反映暂存索引。git status 命令输出显示的是提交历史和暂存索引之间的变化。让我们来看看暂存索引的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git ls-files -s</span><br><span class="line">100644 8e66654a5477b1bf4765946147c49509a431f963 0 new_file</span><br><span class="line">100644 d7d77c1b04b5edd5acfc85de0b592449e5303770 0 reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>我们可以看到 new_file 已被添加到索引中。我们对 reset_lifecycle_file 进行了更新，但暂存索引的 SHA (d7d77c1b04b5edd5acfc85de0b592449e5303770) 仍保持不变。这是意料之中的事情，因为我们并没有使用 git add 将这些更改推广到暂存索引。这些改动存在于工作目录中。</p>
<p>现在，让我们执行 git reset –hard 并检查仓库的新状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ git reset --hard</span><br><span class="line">HEAD is now at dc67808 update content of reset_lifecycle_file</span><br><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line">$ git ls-files -s</span><br><span class="line">100644 d7d77c1b04b5edd5acfc85de0b592449e5303770 0 reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>在这里，我们使用 <code>--hard</code> 选项执行了一次 “硬重置”。Git 的输出显示 HEAD 指向了最新提交 dc67808。</p>
<p>接下来，我们用 git status 检查 repo 的状态。Git 显示没有待处理的修改。我们还检查了暂存索引的状态，发现它已被重置到 new_file 被添加之前的位置。我们对 reset_lifecycle_file 所做的修改和 new_file 的添加都被销毁了。这种数据丢失是无法挽回的，因此必须引起注意。</p>
<h4 id="‘–mixed"><a href="#‘–mixed" class="headerlink" title="‘–mixed"></a>‘–mixed</h4><p>这是默认运行模式。ref 指针会被更新。暂存索引会重置为指定提交时的状态。任何从暂存索引中撤销的更改都会被移到工作目录中。让我们继续。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;new file content&#x27;</span> &gt; new_file</span><br><span class="line">$ git add new_file</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;append content&#x27;</span> &gt;&gt; reset_lifecycle_file</span><br><span class="line">$ git add reset_lifecycle_file</span><br><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">Changes to be committed:</span><br><span class="line">    (use <span class="string">&quot;git reset HEAD ...&quot;</span> to unstage)</span><br><span class="line"></span><br><span class="line">new file: new_file</span><br><span class="line">modified: reset_lifecycle_file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ git ls-files -s</span><br><span class="line">100644 8e66654a5477b1bf4765946147c49509a431f963 0 new_file</span><br><span class="line">100644 7ab362db063f9e9426901092c00a3394b4bec53d 0 reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>在上面的示例中，我们对版本库做了一些修改。我们添加了一个 new_file，并修改了 reset_lifecycle_file 的内容。这些改动会通过 git add 应用到暂存索引中。有了这样的版本库，我们现在就要执行重置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ git reset --mixed</span><br><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">Changes not staged <span class="keyword">for</span> commit:</span><br><span class="line">    (use <span class="string">&quot;git add ...&quot;</span> to update what will be committed)</span><br><span class="line">    (use <span class="string">&quot;git checkout -- ...&quot;</span> to discard changes <span class="keyword">in</span> working directory)</span><br><span class="line"></span><br><span class="line">modified: reset_lifecycle_file</span><br><span class="line"></span><br><span class="line">Untracked files:</span><br><span class="line">    (use <span class="string">&quot;git add ...&quot;</span> to include <span class="keyword">in</span> what will be committed)</span><br><span class="line"></span><br><span class="line">new_file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">no changes added to commit (use <span class="string">&quot;git add&quot;</span> and/or <span class="string">&quot;git commit -a&quot;</span>)</span><br><span class="line">$ git ls-files -s</span><br><span class="line">100644 d7d77c1b04b5edd5acfc85de0b592449e5303770 0 reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>这里我们执行了一次 “mixed reset”。重申一遍，–mixed 是默认模式，与执行 git reset的效果相同。查看 git status 和 git ls-files 的输出，可以发现暂存索引已被重置到 reset_lifecycle_file 是索引中唯一文件的状态。reset_lifecycle_file 的 SHA 对象也被重置为之前的版本。</p>
<p>这里需要注意的是，git status 显示 reset_lifecycle_file 有修改，而且还有一个未跟踪的文件：new_file。这是显式<code>--mixed</code>行为。暂存索引已被重置，待处理的修改已被移入工作目录。</p>
<h4 id="‘–soft"><a href="#‘–soft" class="headerlink" title="‘–soft"></a>‘–soft</h4><p>当传递–soft 参数时，将更新 ref 指针，重置到此为止。暂存索引和工作目录则保持不变。这种行为很难清晰演示。让我们继续演示 repo，为软重置做好准备。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ git add reset_lifecycle_file </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">$ git ls-files -s </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">100644 67cc52710639e5da6b515416fd779d0741e3762e 0 reset_lifecycle_file </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">$ git status </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">On branch main</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">Changes to be committed: </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">(use <span class="string">&quot;git reset HEAD ...&quot;</span> to unstage) </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">modified: reset_lifecycle_file </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">Untracked files: </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">(use <span class="string">&quot;git add ...&quot;</span> to include <span class="keyword">in</span> what will be committed) </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">new_file</span><br></pre></td></tr></table></figure>

<p>在这里，我们再次使用 git add 将修改后的 reset_lifecycle_file 添加到暂存索引中。我们通过 <code>git ls-files</code> 的输出确认索引已经更新。git status 的输出现在显示绿色的 “Changes to be committed”。之前例子中的 new_file 作为一个未跟踪文件漂浮在工作目录中。让我们快速执行 <code>rm new_file</code> 删除该文件，因为在接下来的示例中我们不需要它了。</p>
<p>在版本库处于这种状态的情况下，我们现在执行软重置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ git reset --soft</span><br><span class="line">$ git status</span><br><span class="line">On branch main</span><br><span class="line">Changes to be committed:</span><br><span class="line">    (use <span class="string">&quot;git reset HEAD ...&quot;</span> to unstage)</span><br><span class="line"></span><br><span class="line">modified: reset_lifecycle_file</span><br><span class="line">$ git ls-files -s</span><br><span class="line">100644 67cc52710639e5da6b515416fd779d0741e3762e 0 reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>我们执行了 “soft reset”。使用 git status 和 git ls-files 检查 repo 的状态显示，没有任何变化。这是意料之中的。软重置只会重置提交历史。默认情况下，git 重置的目标提交是 HEAD。由于我们的提交历史已经在 HEAD 上了，而我们又隐式重置到了 HEAD，所以什么也没发生。</p>
<p>为了更好地理解和利用<code>--soft</code>，我们需要一个非 HEAD 的目标提交。我们有 reset_lifecycle_file 在暂存索引中等待。让我们创建一个新的提交。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git commit -m<span class="string">&quot;prepend content to reset_lifecycle_file&quot;</span></span><br></pre></td></tr></table></figure>

<p>此时，我们的 repo 应该有三次提交。我们将回溯到第一次提交。为此，我们需要第一个提交的 ID。这可以通过查看 git 日志的输出找到。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">log</span></span><br><span class="line">commit 62e793f6941c7e0d4ad9a1345a175fe8f45cb9df</span><br><span class="line">Author: bitbucket </span><br><span class="line">Date: Fri Dec 1 15:03:07 2017 -0800</span><br><span class="line">prepend content to reset_lifecycle_file</span><br><span class="line"></span><br><span class="line">commit dc67808a6da9f0dec51ed16d3d8823f28e1a72a</span><br><span class="line">Author: bitbucket </span><br><span class="line">Date: Fri Dec 1 10:21:57 2017 -0800</span><br><span class="line"></span><br><span class="line">update content of reset_lifecycle_file</span><br><span class="line"></span><br><span class="line">commit 780411da3b47117270c0e3a8d5dcfd11d28d04a4</span><br><span class="line"></span><br><span class="line">Author: bitbucket </span><br><span class="line">Date: Thu Nov 30 16:50:39 2017 -0800</span><br><span class="line"></span><br><span class="line">initial commit</span><br></pre></td></tr></table></figure>

<p>请记住，每个系统的提交历史 ID 都是唯一的。这意味着本示例中的提交 ID 将与您在个人计算机上看到的不同。本例中我们感兴趣的提交 ID 是 780411da3b47117270c0e3a8d5dcfd11d28d04a4。这是对应于 “初始提交 “的 ID。找到这个 ID 后，我们将把它作为soft reset的目标。</p>
<p>在回到过去之前，让我们先检查一下 repo 的当前状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git status &amp;&amp; git ls-files -s</span><br><span class="line">On branch main</span><br><span class="line">nothing to commit, working tree clean</span><br><span class="line">100644 67cc52710639e5da6b515416fd779d0741e3762e 0 reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>在这里，我们执行了 git status 和 git ls-files -s 的组合命令，结果显示软件仓库有待处理的更改，暂存索引中的 reset_lifecycle_file 版本为 67cc52710639e5da6b515416fd779d0741e3762e。有鉴于此，让我们执行一次软重置，回到第一次提交。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$git</span> reset --soft 780411da3b47117270c0e3a8d5dcfd11d28d04a4</span><br><span class="line">$ git status &amp;&amp; git ls-files -s</span><br><span class="line">On branch main</span><br><span class="line">Changes to be committed:</span><br><span class="line">    (use <span class="string">&quot;git reset HEAD ...&quot;</span> to unstage)</span><br><span class="line"></span><br><span class="line">modified: reset_lifecycle_file</span><br><span class="line">100644 67cc52710639e5da6b515416fd779d0741e3762e 0 reset_lifecycle_file</span><br></pre></td></tr></table></figure>

<p>上面的代码会执行一次 “软重置”，同时调用 git status 和 git ls-files 组合命令，输出版本库的状态。我们可以检查 repo 的状态输出，并注意到一些有趣的现象。首先，git status 显示 reset_lifecycle_file 有修改，并高亮显示这些修改是为下一次提交准备的。其次，git ls-files 输出显示暂存索引没有变化，并保留了之前的 SHA 67cc52710639e5da6b515416fd779d0741e3762e。</p>
<p>为了进一步弄清重置过程中发生了什么，让我们查看一下 git 日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">log</span> commit 780411da3b47117270c0e3a8d5dcfd11d28d04a4 Author: bitbucket  Date: Thu Nov 30 16:50:39 2017 -0800 initial commit</span><br></pre></td></tr></table></figure>

<p>现在，日志输出显示提交历史中有一次提交。这有助于清楚地说明 –soft 所做的一切。与所有的 git 重置调用一样，重置的第一个动作是重置提交树。我们之前用–hard 和–mixed 重置的例子都是针对 HEAD 的，并没有及时移动提交树。在软重置过程中，这就是发生的全部情况。</p>
<p>这可能会让人困惑，为什么 git status 会显示有修改过的文件。<code>--soft</code>不会触及暂存索引，因此对暂存索引的更新会随着我们的提交历史记录而及时回溯。git ls-files -s 的输出显示 reset_lifecycle_file 的 SHA 没有变化，这就证实了这一点。需要提醒的是，git status 并不显示 “三棵树 “的状态，而是显示它们之间的差异。在本例中，它显示的是暂存索引比提交历史中的改动要早，就好像我们已经暂存了这些改动一样。</p>
<h3 id="Resetting-vs-reverting-1"><a href="#Resetting-vs-reverting-1" class="headerlink" title="Resetting vs reverting"></a>Resetting vs reverting</h3><p>如果说 git revert 是撤销修改的 “安全 “方法，那么 git reset 就是危险的方法。使用 git reset 确实存在丢失工作的风险。Git reset永远不会删除提交，但提交可能会成为 “孤儿”，这意味着没有从 ref 访问它们的直接路径。这些 “孤儿 “提交通常可以用 git reflog 找到并恢复。Git 在运行内部垃圾回收器后，会永久删除任何 “孤儿 “提交。默认情况下，Git 会每隔 30 天运行一次垃圾回收器。提交历史是 “git 三棵树 “之一，其他两棵树（暂存索引和工作目录）并不像提交历史那样具有永久性。使用该工具时必须小心，因为它是唯一有可能丢失工作的 Git 命令之一。</p>
<p>Revert 是为了安全地撤销公开提交，而 git reset 则是为了撤销对暂存索引和工作目录的本地修改。由于目标不同，这两个命令的实现方式也不同：reset会完全删除更改集，而revert会保留原始更改集，并使用新提交来应用撤销。</p>
<h3 id="Don’t-reset-public-history"><a href="#Don’t-reset-public-history" class="headerlink" title="Don’t reset public history"></a>Don’t reset public history</h3><p>当快照被推送到公共仓库后，千万不要使用 git reset。发布提交后，你必须假定其他开发者也依赖于该提交。</p>
<p>删除其他团队成员还在继续开发的提交会给协作带来严重问题。当他们尝试与你的版本库同步时，看起来就像项目历史的一部分突然消失了。</p>
<p>一旦你在重置后添加了新提交，Git 就会认为你的本地历史与 origin/main 有所偏离，而同步版本库所需的合并提交很可能会让你的团队感到困惑和沮丧。</p>
<p>重点是，请确保 git reset ＜commit＞ 是用在出错的本地版本库上，而不是用在已发布的修改上。如果您需要修复公开提交，git revert 命令就是专门为此设计的。</p>
<h3 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset ＜file＞</span><br></pre></td></tr></table></figure>

<p>从暂存区域删除指定文件，但保留工作目录不变。这将取消文件的暂存，但不会覆盖任何更改。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset</span><br></pre></td></tr></table></figure>

<p>重置暂存区域以匹配最新提交，但工作目录保持不变。这将在不覆盖任何更改的情况下解除所有文件的暂存，让你有机会从头开始重新构建暂存快照。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard</span><br></pre></td></tr></table></figure>

<p>重置暂存区域和工作目录，使其与最新提交一致。除了取消暂存更改，<code>--hard</code> 标志还会告诉 Git 覆盖工作目录中的所有更改。换句话说，这会抹去所有未提交的改动，所以在使用前，请确保你真的想扔掉本地的开发成果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset  </span><br></pre></td></tr></table></figure>

<p>将当前分支顶端向后移动到提交位置，重置暂存区域以匹配，但工作目录保持不变。自＜提交＞后所做的所有更改都将保留在工作目录中，这样你就可以使用更简洁、更原子化的快照来重新提交项目历史。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard  </span><br></pre></td></tr></table></figure>

<p>将当前分支顶端向后移动到＜commit＞，并重置暂存区域和工作目录，使其与之匹配。这不仅会抹去未提交的修改，还会抹去之后的所有提交。</p>
<h3 id="取消文件暂存"><a href="#取消文件暂存" class="headerlink" title="取消文件暂存"></a>取消文件暂存</h3><p>在准备暂存快照时，经常会用到 git reset 命令。下一个示例假定您已经将两个名为 hello.py 和 main.py 的文件添加到了版本库中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Edit both hello.py and main.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Stage everything in the current directory</span></span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line"><span class="comment"># Realize that the changes in hello.py and main.py</span></span><br><span class="line"><span class="comment"># should be committed in different snapshots</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Unstage main.py</span></span><br><span class="line">git reset main.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># Commit only hello.py</span></span><br><span class="line">git commit -m <span class="string">&quot;Make some changes to hello.py&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Commit main.py in a separate snapshot</span></span><br><span class="line">git add main.py</span><br><span class="line">git commit -m <span class="string">&quot;Edit main.py&quot;</span></span><br></pre></td></tr></table></figure>

<p>正如你所看到的，git reset 可以让你取消与下一次提交无关的改动，从而帮助你保持高度集中的提交。</p>
<h3 id="删除本地提交"><a href="#删除本地提交" class="headerlink" title="删除本地提交"></a>删除本地提交</h3><p>下一个示例展示了一个更高级的用例。它演示了当你在一个新实验上工作了一段时间，但在提交了几个快照后决定将其完全丢弃时会发生的情况。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create a new file called `foo.py` and add some code to it</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Commit it to the project history</span></span><br><span class="line">git add foo.py</span><br><span class="line">git commit -m <span class="string">&quot;Start developing a crazy feature&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Edit `foo.py` again and change some other tracked files, too</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Commit another snapshot</span></span><br><span class="line">git commit -a -m <span class="string">&quot;Continue my crazy feature&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Decide to scrap the feature and remove the associated commits</span></span><br><span class="line">git reset --hard HEAD~2</span><br></pre></td></tr></table></figure>

<p><code>git reset HEAD~2</code> 命令会将当前分支向后移动两次提交，从而有效地从项目历史中删除我们刚刚创建的两个快照。请记住，这种重置只能用于未发布的提交。如果你已经将提交推送到共享版本库，千万不要执行上述操作。</p>
<h3 id="Summary-4"><a href="#Summary-4" class="headerlink" title="Summary"></a>Summary</h3><p>回顾一下，<code>git reset</code>是一个功能强大的命令，用于撤销对 Git 仓库状态的本地更改。<code>git reset</code>基于 “Git 的三棵树”。这三棵树分别是提交历史（<code>HEAD</code>）、暂存索引（<code>Staging Index</code>）和工作目录（<code>Working Directory</code>）。有三个命令行选项与这三棵树相对应。选项<code>--soft</code>、<code>--mixed</code> 和<code>--hard</code>可以传递给 <code>git reset</code>。</p>
<p>在本文中，我们还使用了其他几条 Git 命令来演示重置过程。关于这些命令的更多信息，请参见：git status、git log、git add、git checkout、git reflog 和 git revert。</p>
<hr>
<h2 id="git-rm"><a href="#git-rm" class="headerlink" title="git rm"></a>git rm</h2><p>刚开始使用 Git 时，一个常见问题是 “如何让 Git 不再跟踪某个（或某些）文件？<code>git rm</code> 命令用于从 Git 仓库中删除文件。它可以看作是 <code>git add</code> 命令的反义词。</p>
<h3 id="git-rm-overview"><a href="#git-rm-overview" class="headerlink" title="git rm overview"></a>git rm overview</h3><p>git rm 命令可用于删除单个文件或文件集。git rm 的主要功能是从 Git 索引中移除跟踪的文件。此外，git rm 还能用于同时从暂存索引和工作目录中移除文件。没有只从工作目录删除文件的选项。被操作的文件必须与当前 HEAD 中的文件完全相同。如果文件的 HEAD 版本与暂存索引或工作树版本不一致，Git 会阻止删除操作。这种阻止是一种安全机制，以防止正在进行的修改被移除。</p>
<p>注意，git rm 不会移除分支。</p>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;file&gt;…</span><br></pre></td></tr></table></figure>

<p>指定要删除的目标文件。选项值可以是单个文件、以空格分隔的文件列表 file1 file2 file3 或通配符文件 (~./directory/*)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-f</span><br><span class="line">--force</span><br></pre></td></tr></table></figure>

<p>-f 选项用于覆盖 Git 为确保 HEAD 中的文件与暂存索引和工作目录中的当前内容相匹配而进行的安全检查。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-n</span><br><span class="line">--dry-run</span><br></pre></td></tr></table></figure>

<p>“试运行”选项是一种安全措施，它将执行命令但不会实际删除文件。相反，它会输出它将删除哪些文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-r</span><br></pre></td></tr></table></figure>

<p>该<code>-r</code>选项是“递归”的简写。当以递归模式操作时，将删除目标目录以及该目录的所有内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--</span><br></pre></td></tr></table></figure>

<p>分隔符选项用于明确区分文件名列表和传递给 git rm 的参数。 如果某些文件名的语法可能被误认为其他选项，这个选项就很有用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--cached</span><br></pre></td></tr></table></figure>

<p>缓存选项指定只在暂存索引中删除文件。工作目录文件将不会被删除。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--ignore-unmatch</span><br></pre></td></tr></table></figure>

<p>这样，即使没有匹配的文件，命令也会以 0 sigterm 状态退出。这是一个 Unix 级别的状态代码。代码 0 表示命令调用成功。当使用 git rm 作为一个更大的 shell 脚本的一部分时，–ignore-unmatch 选项会很有用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-q</span><br><span class="line">--quiet</span><br></pre></td></tr></table></figure>

<p>quiet 选项会隐藏 git rm 命令的输出。通常情况下，每删除一个文件，命令就会输出一行。</p>
<h3 id="如何撤销-git-rm"><a href="#如何撤销-git-rm" class="headerlink" title="如何撤销 git rm"></a>如何撤销 git rm</h3><p>执行 git rm 并不是永久更新。该命令会更新暂存索引和工作目录。在创建新提交并将更改添加到提交历史之前，这些更改不会被持久化。这意味着这里的改动可以用普通的 Git 命令 “撤销”。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset HEAD</span><br></pre></td></tr></table></figure>

<p>Reset会将当前暂存索引和工作目录还原回 HEAD 提交时的状态。这将撤销 git rm。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout .</span><br></pre></td></tr></table></figure>

<p>签出也会产生同样的效果，从 HEAD 恢复文件的最新版本。</p>
<p>如果执行了 git rm，但又创建了新的提交来坚持删除，可以使用 git reflog 来查找执行 git rm 之前的 ref。</p>
<p>该命令的 <code>&lt;file&gt;</code> 参数可以是精确路径、通配符文件 glob 模式或精确目录名。该命令只删除当前已提交到 Git 仓库的路径。</p>
<p>通配符文件全局匹配可跨目录。使用通配符 glob 时一定要谨慎。请看例子：directory/* 和 directory*。第一个示例将删除 directory/ 的所有子文件，而第二个示例将删除所有同级目录，如 directory1 directory2 directory_whatever，这可能是一个意想不到的结果。</p>
<p>git rm 命令只在当前分支上运行。移除事件只应用于工作目录和暂存索引树。在创建新提交之前，文件移除不会持续到版本库历史中。</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rm Documentation/\*.txt</span><br></pre></td></tr></table></figure>

<p>本例使用通配符文件删除Documentation目录及其任何子目录下的所有 *.txt 文件。</p>
<p>请注意，本例中的星号 <code>*</code> 是用斜线转义的；这是为了防止 shell 扩展通配符。通配符会扩展 Documentation/ 目录下的文件和子目录的路径名。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rm -f git-*.sh</span><br></pre></td></tr></table></figure>

<p>本例使用了强制选项，并以所有通配符 <code>git-*.sh</code> 文件为目标。强制选项明确地将目标文件从工作目录和暂存索引中删除。</p>
<h3 id="如何删除文件系统中已不存在的文件"><a href="#如何删除文件系统中已不存在的文件" class="headerlink" title="如何删除文件系统中已不存在的文件"></a>如何删除文件系统中已不存在的文件</h3><p>正如上文 “为什么使用 git rm 而不是 rm “一文所述，git rm 实际上是一个方便的命令，它结合了标准 shell rm 和 git add 命令，可以从工作目录中移除文件，并将移除的文件放到暂存索引中。如果仅使用标准 shell rm 命令就能移除多个文件，那么版本库就会变得非常累赘。</p>
<p>如果打算在下一次提交时记录所有明确移除的文件，git commit -a 会将所有移除事件添加到暂存索引中，为下一次提交做准备。</p>
<p>不过，如果想要持续移除用 shell rm 移除的文件，请使用下面的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff --name-only --diff-filter&#x3D;D -z | xargs -0 git rm --cached</span><br></pre></td></tr></table></figure>

<p>该命令将生成工作目录中已删除文件的列表，并将该列表导入 git rm –cached 更新暂存索引。</p>
<h3 id="Git-rm-summary"><a href="#Git-rm-summary" class="headerlink" title="Git rm summary"></a>Git rm summary</h3><p>git rm 是一条在两个主要的 Git 内部状态管理树（工作目录和暂存索引）上运行的命令。它是一种方便的方法，结合了 shell 默认的 rm 命令和 git add 的效果。也就是说，它会首先从文件系统中移除目标文件，然后将移除事件添加到暂存索引中。该命令是 Git 中用于撤销更改的众多命令之一。</p>
<hr>
<h1 id="重写历史"><a href="#重写历史" class="headerlink" title="重写历史"></a>重写历史</h1><p><code>Git commit --amend</code> 和其他重写历史的方法</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>本教程将介绍各种重写和修改 Git 历史记录的方法。Git 使用几种不同的方法来记录更改。我们将讨论不同方法的优缺点，并举例说明如何使用它们。本教程将讨论覆盖已提交快照的一些最常见原因，并告诉你如何避免这样做的陷阱。</p>
<p>Git 的主要工作是确保你不会丢失已提交的变更。但它也能让你完全控制开发工作流程。这包括让你精确定义你的项目历史；然而，这也带来了丢失提交的可能性。Git 在提供历史记录重写命令时声明，使用这些命令可能会导致内容丢失。</p>
<p>Git 有多种存储历史和保存修改的机制。这些机制包括 <code>Commit --amend</code>, <code>git rebase</code> 和 <code>git reflog</code>。这些选项为你提供了强大的工作流程定制选项。在本教程结束时，你将熟悉一些命令，这些命令能让你重组 Git 提交，并能避免重写历史时常遇到的陷阱。</p>
<h3 id="Changing-the-Last-Commit-git-commit-amend"><a href="#Changing-the-Last-Commit-git-commit-amend" class="headerlink" title="Changing the Last Commit: git commit --amend"></a>Changing the Last Commit: <code>git commit --amend</code></h3><p><code>git commit --amend</code> 命令是修改最新提交的便捷方法。它能让你把已缓存的改动与上一次提交结合起来，而不是创建一个全新的提交。它也可以用来简单编辑上一次提交的信息，而不改变其快照。不过，修改并不只是修改最近的提交，而是完全替换它，这意味着修改后的提交将是一个拥有自己 ref 的新实体。对 Git 来说，它看起来就像一个全新的提交，在下图中用星号（<code>*</code>）表示。使用 <code>git commit --amend</code> 有几种常见情况。我们将在下面的章节中举例说明。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-amend-history.png" style="zoom:50%;" />

<p><strong>更改最近的 Git 提交信息</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit --amend</span><br></pre></td></tr></table></figure>

<p>比方说，你刚刚提交了文件，却在提交日志信息中犯了一个错误。在没有任何缓存的情况下运行这条命令，就能在不更改快照的情况下编辑前一次提交的信息。</p>
<p>在日常开发过程中，提交过早的情况时有发生。忘记暂存文件或提交信息格式错误都很容易发生。使用 <code>--amend</code> 标志就能很方便地修复这些小错误。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit --amend -m <span class="string">&quot;an updated commit message&quot;</span></span><br></pre></td></tr></table></figure>

<p>添加 <code>-m</code> 选项后，就可以从命令行输入新信息，而无需打开编辑器。</p>
<p><strong>更改已提交的文件</strong></p>
<p>下面的示例演示了基于 Git 的开发中常见的一种情况。假设我们编辑了几个文件，想在一次快照中提交，但第一次提交时忘记添加其中一个文件。要修复这个错误，只需暂存另一个文件，然后使用 <code>--amend</code> 标志提交即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Edit hello.py and main.py</span></span><br><span class="line">git add hello.py</span><br><span class="line">git commit </span><br><span class="line"><span class="comment"># Realize you forgot to add the changes from main.py </span></span><br><span class="line">git add main.py </span><br><span class="line">git commit --amend --no-edit</span><br></pre></td></tr></table></figure>

<p>使用<code>--no-edit</code>（无编辑）标记，可以在不修改提交信息的情况下修改提交。由此产生的提交将取代不完整的提交，看起来就像我们在一个快照中提交了对 hello.py 和 main.py 的修改。</p>
<p><strong>不要修改公共提交</strong></p>
<p>修改后的提交实际上是全新的提交，之前的提交将不再出现在当前分支上。其后果与重置公共快照相同。避免修改其他开发人员的工作所基于的提交。这种情况会让其他开发人员感到困惑，而且恢复起来也很复杂。</p>
<p><strong>Recap</strong></p>
<p><code>git commit --amend</code>可以让你使用最近的提交，并添加新的暂存修改。您可以从 Git 暂存区添加或移除修改，然后用 <code>--amend</code> 提交来应用。如果没有暂存的改动，<code>--amend</code> 仍会提示你修改上次提交的信息日志。在与其他团队成员共享的提交中使用 <code>--amend</code> 时要谨慎。修改与其他用户共享的提交可能需要混乱而冗长的合并冲突解决方案。</p>
<h3 id="更改旧提交或多次提交"><a href="#更改旧提交或多次提交" class="headerlink" title="更改旧提交或多次提交"></a>更改旧提交或多次提交</h3><p>要修改旧提交或多个提交，可以使用 <code>git rebase</code> 将一系列提交合并为一个新的基本提交。在标准模式下，<code>git rebase</code> 可以让你真正改写历史–自动将当前工作分支中的提交应用到已通过的分支顶部。由于新的提交将替换旧的提交，因此不要在已公开推送的提交上使用 git rebase，否则会导致项目历史消失。</p>
<p>在这种或类似情况下，如果需要保留完整的项目历史，可以在 <code>git rebase</code> 中添加 -i 选项，以交互方式运行 <code>rebase</code>。这样，你就有机会在过程中修改单个提交，而不是移动所有提交。你可以在 git rebase 页面了解更多关于交互式<code>rebase</code> 和其他 <code>rebase</code> 命令的信息。</p>
<p><strong>更改已提交的文件</strong></p>
<p>在<code>rebase</code>过程中，<code>edit</code> 或 <code>e</code> 命令将暂停该提交上的<code>rebase</code>回放，并允许您使用 <code>git commit --amend</code> 命令进行其他修改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Stopped at 5d025d1... formatting</span><br><span class="line">You can amend the commit now, with</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> git commit --amend</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Once you are satisfied with your changes, run</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> git rebase --<span class="built_in">continue</span></span><br></pre></td></tr></table></figure>

<p><strong>Multiple messages</strong></p>
<p>每个常规 Git 提交都会有一条日志信息，解释提交过程中发生了什么。这些信息对了解项目历史很有价值。在<code>rebase</code>过程中，你可以对提交执行一些命令来修改提交信息。</p>
<p><strong>Squash commits for a clean history</strong></p>
<p>通过 <code>s</code> “<code>squash</code> “命令，我们可以看到 <code>rebase</code> 的真正用途。<code>Squash</code> 允许你指定要将哪些提交合并到之前的提交中。这就是实现 “干净历史 “的方法。在 <code>rebase</code> 回放过程中，Git 会为每个提交执行指定的 <code>rebase</code> 命令</p>
<p>在<code>squash commits</code>示例中，Git 会打开配置的文本编辑器，提示合并指定的提交信息。整个过程可视化如下：</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/squashed-commited.png" style="zoom:50%;" />

<p>请注意，使用 rebase 命令修改的提交与原始提交的 ID 不同。如果之前的提交已被改写，则标记为 pick 的提交会有一个新的 ID。</p>
<p><strong>Recap</strong></p>
<p><code>git rebase</code> 使您能够修改历史记录，而交互式 <code>rebase</code> 使您可以在不留下“混乱”痕迹的情况下执行此操作。这创造了犯错和纠正错误以及完善工作的自由，同时仍然保持干净、线性的项目历史记录。</p>
<h3 id="安全网：git-reflog"><a href="#安全网：git-reflog" class="headerlink" title="安全网：git reflog"></a>安全网：git reflog</h3><p>引用日志，或称 “reflog”，是 Git 用于记录应用于分支提示和其他提交引用的更新的机制。<code>reflog</code>允许你回溯提交，即使它们没有被任何分支或标记引用。重写历史后，reflog 会包含分支旧状态的信息，允许你在必要时回到旧状态。</p>
<p>每次分支提示因任何原因更新时（通过切换分支、拉入新变更、重写历史或仅仅通过添加新提交），都会在 reflog 中添加一个新条目。在本节中，我们将对 git reflog 命令做一个高层次的了解，并探讨一些常见的用法。</p>
<p><strong>使用方法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reflog</span><br></pre></td></tr></table></figure>

<p>这将显示本地版本库的 reflog。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reflog --relative-date</span><br></pre></td></tr></table></figure>

<p>这将显示指定相对日期信息（如 2 周前）的 reflog。</p>
<p><strong>示例</strong></p>
<p>为了理解 git reflog，我们先来看一个例子。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0a2e358 HEAD@&#123;0&#125;: reset: moving to HEAD~2</span><br><span class="line">0254ea7 HEAD@&#123;1&#125;: checkout: moving from 2.2 to main</span><br><span class="line">c10f740 HEAD@&#123;2&#125;: checkout: moving from main to 2.2</span><br></pre></td></tr></table></figure>

<p>上面的引用日志显示了从主分支签出到 2.2 分支并返回。从那里开始，将硬重置到旧的提交。最新活动显示在顶部，标记为。<code>HEAD@&#123;0&#125;</code></p>
<p>如果事实证明您不小心向后移动了，重写日志中将包含您意外删除 2 次提交之前的主提交（0254ea7）。</p>
<p><code>git reset --hard 0254ea7</code></p>
<p>通过 git reset，现在可以将 main 改回之前的提交状态。这为历史记录被意外更改提供了安全保障。</p>
<p>需要注意的是，reflog 只在变更已提交到本地版本库的情况下提供安全网，而且它只跟踪版本库分支tip的移动。此外，reflog 条目也有过期日期。reflog 条目的默认过期时间是 90 天。</p>
<p>如需了解更多信息，请参阅我们的 git reflog 页面。</p>
<h3 id="Summary-5"><a href="#Summary-5" class="headerlink" title="Summary"></a>Summary</h3><p>在本文中，我们讨论了更改 git 历史记录和撤消 git 更改的几种方法。我们对 git rebase 过程进行了高层次的研究。一些关键要点是：</p>
<ul>
<li>有很多方法可以用 git 重写历史</li>
<li>使用 <code>git commit --amend</code> 来修改最新的提交日志信息</li>
<li>使用 <code>git commit --amend</code> 修改最新提交</li>
<li>用于<code>git rebase</code>合并提交并修改分支的历史记录</li>
<li><code>git rebase -i</code>与标准 <code>git rebase</code> 相比，对历史修改提供了更细粒度的控制。</li>
</ul>
<p>了解有关我们在各个页面中介绍的命令的更多信息：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.atlassian.com/git/tutorials/rewriting-history/git-rebase">git rebase</a></li>
<li><a target="_blank" rel="noopener" href="https://www.atlassian.com/git/tutorials/rewriting-history/git-reflog">git reflog</a></li>
</ul>
<hr>
<h2 id="git-rebase"><a href="#git-rebase" class="headerlink" title="git rebase"></a>git rebase</h2><p>本文档将深入讨论 git rebase 命令。Rebase 命令在建立仓库和重写历史页面中也有介绍。本页将更详细地介绍 git rebase 的配置和执行。这里将介绍常见的 Rebase 用例和陷阱。</p>
<p>Rebase 是两个 Git 工具之一，专门用于将一个分支的变更整合到另一个分支。另一个变更整合工具是 git merge。merge总是向前移动的变更记录。相反，rebase 具有强大的历史重写功能。Rebase 本身有两种主要模式： “手动 “和 “交互 “模式。下面我们将详细介绍不同的 Rebase 模式。</p>
<h3 id="什么是-git-rebase？"><a href="#什么是-git-rebase？" class="headerlink" title="什么是 git rebase？"></a>什么是 git rebase？</h3><p>变基是将一系列提交移动或合并到一个新的基本提交的过程。变基在<code>feature</code>分支工作流程中最有用，也最容易可视化。一般流程可视化如下：</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/brand-new-commits.png" style="zoom:50%;" />

<p>从内容的角度来看，变基是将分支的基础从一个提交更改为另一个提交，使分支看起来像是从另一个提交创建的。在内部，Git 通过创建新的提交并将它们应用到指定的base来实现这一点。理解这一点非常重要：尽管分支看起来相同，但它是由全新的提交组成的。</p>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><p>变基的主要原因是维持线性项目历史。例如，考虑这样一种情况：在你开始创建<code>feature</code>分支后，<code>main</code>分支已经取得了进展。你想在<code>feature</code>分支中获得<code>main</code>分支的最新更新，但又想保持分支历史的完整性，这样看起来就像是你一直在最新的主分支上工作。这样做的好处是，以后可以将<code>feature</code>分支干净利落地合并回<code>main</code>分支。为什么要保持 “干净的历史”？在执行 Git 操作以调查回归的引入时，拥有清晰历史的好处就显而易见了。更真实的场景是</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/clean-history.png" style="zoom:50%;" />

<ol>
<li>在主分支中发现一个错误。一个曾成功运行的功能现在被破坏了</li>
<li>开发人员检查所使用<code>git log</code>的主分支的历史记录，因为“干净的历史记录”使开发人员能够快速推断出项目的历史记录</li>
<li>开发人员无法通过<code>git log</code>确定 bug 是何时出现的，因此执行了 <code>git bisect</code></li>
<li>由于 git 历史是干净的，git bisect 在查找回归时就有了一组精炼的提交进行比较。开发人员很快就能找到引入 bug 的提交，并采取相应措施</li>
</ol>
<p>有关 git log 和 git bisect 的更多信息，请参阅它们各自的用法页面。</p>
<p>将feature分支整合到main分支有两种选择：直接merge或先变基后再合并。前者会导致 3 路合并和合并提交，而后者会导致快进合并和完美的线性历史记录。下图演示了变基到主分支如何促进快进合并。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/git/git-rebase-usage.png" style="zoom:50%;" />

<p>变基是将上游更改集成到本地存储库的常用方法。用 Git 合并的方式拉入上游改动会导致每次想查看项目进展时都要提交一次多余的合并。另一方面，变基就像在说：”我想把我的改动建立在大家已经完成的基础上”。</p>
<h3 id="不要rebase公共历史"><a href="#不要rebase公共历史" class="headerlink" title="不要rebase公共历史"></a>不要rebase公共历史</h3><p>正如我们之前在 “重写历史 “一文中讨论过的，一旦提交被推送到公共仓库，就不应该对其进行<code>rebase</code>。<code>rebase</code>会用新提交替换旧提交，看起来就像项目历史的这一部分突然消失了。</p>
<h3 id="Git-rebase-标准版-vs-git-rebase-交互版"><a href="#Git-rebase-标准版-vs-git-rebase-交互版" class="headerlink" title="Git rebase 标准版 vs git rebase 交互版"></a>Git rebase 标准版 vs git rebase 交互版</h3><p>Git rebase interactive 是指 git rebase 接受 – i 参数。这代表 “交互式”。如果不带任何参数，命令将以标准模式运行。在这两种情况下，假设我们都创建了一个独立的特性分支。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create a feature branch based off of main </span></span><br><span class="line">git checkout -b feature_branch main</span><br><span class="line"><span class="comment"># Edit files </span></span><br><span class="line">git commit -a -m <span class="string">&quot;Adds new feature&quot;</span> </span><br></pre></td></tr></table></figure>

<p>标准模式下的 git rebase 会自动将当前工作分支中的提交应用到已传递分支的头部。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase &lt;base&gt;</span><br></pre></td></tr></table></figure>

<p>它会自动将当前分支重定向到<code>＜base＞</code>上，＜base＞可以是任何类型的提交引用（例如 ID、分支名、标签或 HEAD 的相对引用）。</p>
<p>使用 <code>-i</code> 标志运行 git rebase 会开始一个交互式的<code>rebase</code>会话。交互式<code>rebase</code>不会盲目地将所有提交移到新的基础上，而是让你有机会在过程中修改单个提交。这样，你就可以通过删除、拆分和修改现有的一系列提交来清理历史。这就像是 Git commit –amend。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase --interactive &lt;base&gt;</span><br></pre></td></tr></table></figure>

<p>此操作会将当前分支重定向到<code>＜base＞</code>，但使用的是交互式重定向会话。这将打开一个编辑器，你可以为每个要重定向的提交输入命令（如下所述）。这些命令决定了如何将单个提交转移到新的base。你还可以重新排列提交列表，改变提交本身的顺序。一旦你为每个提交指定了命令，Git 就会开始回放应用 rebase 命令的提交。rebase编辑命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pick 2231360 some old commit</span><br><span class="line">pick ee2adc2 Adds new feature</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rebase 2cf755d..ee2adc2 onto 2cf755d (9 commands)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Commands:</span></span><br><span class="line"><span class="comment"># p, pick = use commit</span></span><br><span class="line"><span class="comment"># r, reword = use commit, but edit the commit message</span></span><br><span class="line"><span class="comment"># e, edit = use commit, but stop for amending</span></span><br><span class="line"><span class="comment"># s, squash = use commit, but meld into previous commit</span></span><br><span class="line"><span class="comment"># f, fixup = like &quot;squash&quot;, but discard this commit&#x27;s log message</span></span><br><span class="line"><span class="comment"># x, exec = run command (the rest of the line) using shell</span></span><br><span class="line"><span class="comment"># d, drop = remove commit</span></span><br></pre></td></tr></table></figure>

<h3 id="其他-rebase-命令"><a href="#其他-rebase-命令" class="headerlink" title="其他 rebase 命令"></a>其他 rebase 命令</h3><p>正如改写历史页面所详述的，rebase 可用于修改旧提交、多次提交、已提交文件和多条信息。虽然这些都是最常见的应用，但 git rebase 还有额外的命令选项，在更复杂的应用中也很有用。</p>
<ul>
<li><code>git rebase -- d</code> 表示在回放过程中，该提交将从最终合并的提交块中丢弃。</li>
<li><code>git rebase -- p</code> 表示保持提交原样。它不会修改提交信息或内容，在分支历史中仍是一个单独的提交。</li>
<li><code>git rebase -- x</code> 在播放期间，在每个标记的提交上执行命令行 shell 脚本。一个有用的示例是在特定提交上运行代码库的测试套件，这可能有助于识别变基期间的回归。</li>
</ul>
<h3 id="Recap"><a href="#Recap" class="headerlink" title="Recap"></a>Recap</h3><p>交互式变基使您可以完全控制项目历史记录。这为开发人员提供了很大的自由，因为它允许他们在专注于编写代码时提交“混乱”的历史记录，然后在事后返回并清理它。</p>
<p>大多数开发人员都喜欢在将特性分支合并到主代码库之前，使用交互式rebase来完善它。这让他们有机会压制无关紧要的提交、删除过时的提交，并在提交到 “正式 “项目历史之前确保其他一切正常。在其他人看来，整个功能就是在一系列精心策划的提交中开发出来的。</p>
<p>交互式<code>rebase</code>的真正威力可以从生成的主分支的历史中看出。对于其他人来说，您似乎是一位出色的开发人员，第一次就以完美的提交实现了新功能。这就是交互式变基可以保持项目历史清晰且有意义的方式。</p>
<h3 id="配置选项"><a href="#配置选项" class="headerlink" title="配置选项"></a>配置选项</h3><p>使用 git config 可以设置一些 rebase 属性。这些选项将改变 git rebase 输出的外观和感觉。</p>
<ul>
<li><strong><code>rebase.stat</code></strong>: 一个布尔值，默认设置为 false。该选项可切换显示可视化 diffstat 内容，显示自上次变基以来发生的更改</li>
<li><code>rebase.autoSquash:</code>布尔值，用于切换 –autosquash 行为</li>
<li><code>rebase.missingCommitsCheck:</code>可设置为多个值，从而改变缺失提交时的回溯行为。</li>
</ul>
<table>
<thead>
<tr>
<th><code>warn</code></th>
<th>在交互模式下打印警告输出，警告已删除的提交</th>
</tr>
</thead>
<tbody><tr>
<td><code>error</code></td>
<td>停止重置并打印已删除的提交警告信息</td>
</tr>
<tr>
<td><code>ignore</code></td>
<td>默认设置为忽略任何缺失提交警告</td>
</tr>
</tbody></table>
<ul>
<li><code>rebase.instructionFormat:</code>将用于格式化交互式变基显示的格式字符串</li>
</ul>
<h3 id="高级变基应用"><a href="#高级变基应用" class="headerlink" title="高级变基应用"></a>高级变基应用</h3><p>命令行参数 –onto 可以传递给 git rebase。在 git rebase –onto 模式下，命令会扩展为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase --onto &lt;newbase&gt; &lt;oldbase&gt;</span><br></pre></td></tr></table></figure>

<p>该<code>--onto</code>命令启用更强大的形式或变基，允许传递特定的引用作为变基的提示。假设我们有一个示例存储库，其分支如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">o---o---o---o---o  main</span><br><span class="line">     \</span><br><span class="line">      o---o---o---o---o  featureA</span><br><span class="line">           \</span><br><span class="line">            o---o---o  featureB</span><br></pre></td></tr></table></figure>

<p>featureB 基于 featureA，但是，我们意识到 featureB 不依赖于 featureA 的任何更改，并且可以从 main 中分支出来。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase --onto main featureA featureB</span><br></pre></td></tr></table></figure>

<p>featureA 是＜oldbase＞，main 是＜newbase＞，featureB 是＜newbase＞的 HEAD 所指向的引用。结果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">                  o---o---o  featureB</span><br><span class="line">                 /</span><br><span class="line">o---o---o---o---o  main</span><br><span class="line"> \</span><br><span class="line">  o---o---o---o---o  featureA</span><br><span class="line">                    </span><br></pre></td></tr></table></figure>

<h3 id="了解rebase的危险"><a href="#了解rebase的危险" class="headerlink" title="了解rebase的危险"></a>了解rebase的危险</h3><p>使用 Git Rebase 时需要考虑的一个警告是，在 rebase 工作流程中，合并冲突可能会变得更加频繁。如果您有一个长期存在的分支偏离了主分支，就会发生这种情况。最终你会想要针对 main 进行 rebase，那时它可能包含许多新的提交，你的分支更改可能会与这些提交发生冲突。这一点很容易解决，只要频繁地针对主分支rebase，并进行更频繁的提交即可。在处理冲突时，可以向 git rebase 传递 –continue 和 –abort 命令行参数，以推进或重置rebase。</p>
<p>更严重的变基警告是交互式历史重写造成的提交丢失。在交互模式下运行 rebase 并执行 squash 或 drop 等子命令，会从分支的即时日志中删除提交。乍一看，这些提交好像永远消失了。使用 git reflog 可以恢复这些提交，并撤销整个rebase。有关使用 git reflog 查找丢失提交的更多信息，请访问我们的 Git reflog 文档页面。</p>
<p>Git Rebase 本身并没有严重危险。当执行交互式变基重写历史并强制将结果推送到由其他用户共享的远程分支时，真正的危险情况就会出现。这是一种应该避免的模式，因为它能够在其他远程用户拉取时覆盖他们的工作。</p>
<h3 id="从上游变基恢复"><a href="#从上游变基恢复" class="headerlink" title="从上游变基恢复"></a>从上游变基恢复</h3><p>如果有其他用户执行了rebase并强制推送到您正在提交的分支，那么 git pull 就会用强制推送的提示覆盖您基于之前分支的任何提交。幸运的是，使用 git reflog 可以获得远程分支的 reflog。在远程分支的 reflog 中，你可以找到该分支被重置前的 ref。然后，你就可以使用 –onto 选项，根据该远程 ref 重定向你的分支，如上文 “高级变基应用 “部分所述。</p>
<h3 id="Summary-6"><a href="#Summary-6" class="headerlink" title="Summary"></a>Summary</h3><p>在本文中，我们介绍了<code>git rebase</code>用法。我们讨论了基本和高级用例以及更高级的示例。一些关键讨论点是：</p>
<ul>
<li>git rebase 标准模式与交互模式</li>
<li>git rebase 配置选项</li>
<li>git rebase –onto</li>
<li>git rebase 丢失提交</li>
</ul>
<hr>
<h2 id="git-reflog"><a href="#git-reflog" class="headerlink" title="git reflog"></a>git reflog</h2><p>本页将详细讨论 git reflog 命令。Git 使用一种称为引用日志或 “reflogs “的机制来跟踪分支顶端的更新。许多 Git 命令都接受一个参数来指定引用或 “ref”，也就是指向某个提交的指针。常见的例子包括</p>
<ul>
<li><code>git checkout </code></li>
<li><code>git reset </code></li>
<li><code>git merge </code></li>
</ul>
<p>Reflogs会记录本地仓库中 Git 分支的更新时间。除了分支提示 reflog，Git 储藏库也有一个特殊的 reflog。reflog存储在本地存储库 <code>.git</code>目录下的目录中。git reflog 目录位于 .git/logs/refs/heads/.、.git/logs/HEAD 和 .git/logs/refs/stash（如果在 repo 上使用了 git stash）。</p>
<p>我们在重写历史页面上对 git reflog 进行了深入讨论。本文档将介绍：git reflog 的扩展配置选项、git reflog 的常见用例和误区、如何使用 git reflog 撤销修改，以及更多。</p>
<h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><p>最基本的 Reflog 用例是调用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reflog</span><br></pre></td></tr></table></figure>

<p>这实质上是一条捷径，相当于：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reflog show HEAD</span><br></pre></td></tr></table></figure>

<p>这将输出 HEAD reflog。你应该看到类似的输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">eff544f HEAD@&#123;0&#125;: commit: migrate existing content</span><br><span class="line">bf871fd HEAD@&#123;1&#125;: commit: Add Git Reflog outline</span><br><span class="line">9a4491f HEAD@&#123;2&#125;: checkout: moving from main to git_reflog</span><br><span class="line">9a4491f HEAD@&#123;3&#125;: checkout: moving from Git_Config to main</span><br><span class="line">39b159a HEAD@&#123;4&#125;: commit: expand on git context </span><br><span class="line">9b3aa71 HEAD@&#123;5&#125;: commit: more color clarification</span><br><span class="line">f34388b HEAD@&#123;6&#125;: commit: expand on color support </span><br><span class="line">9962aed HEAD@&#123;7&#125;: commit: a git editor -&gt; the Git editor</span><br></pre></td></tr></table></figure>

<h3 id="Reflog参考"><a href="#Reflog参考" class="headerlink" title="Reflog参考"></a>Reflog参考</h3><p>默认情况下，git reflog 会输出 HEAD ref 的 reflog。HEAD 是对当前活动分支的符号引用。引用日志也可用于其他引用。访问 git ref 的语法是 name@{qualifier}。访问 git ref 的语法是<code>name@&#123;qualifier&#125;</code>。除了<code>HEAD</code>refs 之外，还可以引用其他分支、标签、远程和 Git 储藏库。</p>
<p>您可以通过执行以下命令来获取所有引用的完整引用日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reflog show --all </span><br></pre></td></tr></table></figure>

<p>要查看特定分支的 reflog，可将该分支名称传给 git reflog show。</p>
<p>Bitbucket 会显示 “创建新版本库 “页面。花点时间看看对话框的内容。除了版本库类型，你在这个页面上输入的所有内容都可以在以后修改。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git reflog show otherbranch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">9a4491f otherbranch@&#123;0&#125;: commit: seperate articles into branch PRs</span><br><span class="line">35aee4a otherbranch&#123;1&#125;: commit (initial): initial commit add git-init and setting-up-a-repo docs</span><br></pre></td></tr></table></figure>

<p>执行此示例将显示 <code>otherbranch</code> 分支的 reflog。下面的示例假定您之前已使用 git stash 命令隐藏了一些改动。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git reflog stash</span><br><span class="line"></span><br><span class="line">0d44de3 stash@&#123;0&#125;: WIP on git_reflog: c492574 flesh out intro</span><br></pre></td></tr></table></figure>

<p>这将输出 Git 存储的引用日志。返回的 ref 指针可以传递给其他 Git 命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff stash@&#123;0&#125; otherbranch@&#123;0&#125;</span><br></pre></td></tr></table></figure>

<p>执行该示例代码后，将显示 Git diff 输出，比较 stash@{0} 和 otherbranch@{0} 的改动。</p>
<p>每个 reflog 条目都附有一个时间戳。这些时间戳可用作 Git ref 指针语法的限定符标记。这样就能按时间过滤 Git reflog。以下是一些可用的时间限定符示例：</p>
<ul>
<li><code>1.minute.ago</code></li>
<li><code>1.hour.ago</code></li>
<li><code>1.day.ago</code></li>
<li><code>yesterday</code></li>
<li><code>1.week.ago</code></li>
<li><code>1.month.ago</code></li>
<li><code>1.year.ago</code></li>
<li><code>2011-05-17.09:00:00</code></li>
</ul>
<p>时间限定词可以组合（例如<code>1.day.2.hours.ago</code>），此外还接受复数形式（例如<code>5.minutes.ago</code>）。</p>
<p>时间限定符可以传递给其他 git 命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff main@&#123;0&#125; main@&#123;1.day.ago&#125; </span><br></pre></td></tr></table></figure>

<p>此示例将当前的主分支与 1 天前的主分支进行比较。如果你想知道某段时间内发生的变化，这个示例非常有用。</p>
<h3 id="子命令和配置选项"><a href="#子命令和配置选项" class="headerlink" title="子命令和配置选项"></a>子命令和配置选项</h3><p>git reflog 接受一些附加参数，这些参数被视为子命令。</p>
<h4 id="Show-git-reflog-show"><a href="#Show-git-reflog-show" class="headerlink" title="Show - git reflog show"></a>Show - <code>git reflog show</code></h4><p>show 默认为隐式传递。例如命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reflog main@&#123;0&#125; </span><br></pre></td></tr></table></figure>

<p>等同于命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reflog show main@&#123;0&#125; </span><br></pre></td></tr></table></figure>

<p>此外，git reflog show 是 git log -g –abbrev-commit –pretty=oneline 的别名。执行 git reflog show 会显示所传递的引用日志。</p>
<h4 id="Expire-git-reflog-expire"><a href="#Expire-git-reflog-expire" class="headerlink" title="Expire - git reflog expire"></a>Expire - <code>git reflog expire</code></h4><p><code>expire</code>子命令可清除旧的或无法访问的 reflog 条目。<code>expire</code>子命令有可能导致数据丢失。最终用户通常不会使用该子命令，但 git 内部会使用它。给 git reflog expire 传递 -n 或 –dry-run 选项会执行一次 “试运行”，输出哪些 reflog 条目被标记为要剪枝，但实际上不会剪枝。</p>
<p>默认情况下，reflog 的过期日期设置为 90 天。默认情况下，reflog 的过期日期设置为 90 天。过期时间可以通过向 git reflog expire 传递命令行参数 –expire=time 或设置 git 配置名 gc.reflogExpire 的值来指定。</p>
<h4 id="Delete-git-reflog-delete"><a href="#Delete-git-reflog-delete" class="headerlink" title="Delete - git reflog delete"></a>Delete - <code>git reflog delete</code></h4><p><code>Delete</code>子命令不言自明，它将删除传递的 reflog 条目。与<code>expire</code>一样，<code>delete</code>有可能丢失数据，终端用户通常不会调用。</p>
<h3 id="恢复丢失的提交"><a href="#恢复丢失的提交" class="headerlink" title="恢复丢失的提交"></a>恢复丢失的提交</h3><p>Git 不会丢失任何东西，即使是在执行历史重写操作（如rebase或修改提交）时也是如此。在下一个例子中，假设我们对仓库做了一些新的改动。我们的  <code>git log --pretty=oneline</code> 看起来如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">338fbcb41de10f7f2e54095f5649426cb4bf2458 extended content</span><br><span class="line">1e63ceab309da94256db8fb1f35b1678fb74abd4 bunch of content</span><br><span class="line">c49257493a95185997c87e0bc3a9481715270086 flesh out intro</span><br><span class="line">eff544f986d270d7f97c77618314a06f024c7916 migrate existing content</span><br><span class="line">bf871fd762d8ef2e146d7f0226e81a92f91975ad Add Git Reflog outline</span><br><span class="line">35aee4a4404c42128bee8468a9517418ed0eb3dc initial commit add git-init and setting-up-a-repo docs</span><br></pre></td></tr></table></figure>

<p>然后，我们提交这些更改并执行以下操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#make changes to HEAD</span></span><br><span class="line">git commit -am <span class="string">&quot;some WIP changes&quot;</span></span><br></pre></td></tr></table></figure>

<p>增加了新的提交。日志现在看起来像:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">37656e19d4e4f1a9b419f57850c8f1974f871b07 some WIP changes</span><br><span class="line">338fbcb41de10f7f2e54095f5649426cb4bf2458 extended content</span><br><span class="line">1e63ceab309da94256db8fb1f35b1678fb74abd4 bunch of content</span><br><span class="line">c49257493a95185997c87e0bc3a9481715270086 flesh out intro</span><br><span class="line">eff544f986d270d7f97c77618314a06f024c7916 migrate existing content</span><br><span class="line">bf871fd762d8ef2e146d7f0226e81a92f91975ad Add Git Reflog outline</span><br><span class="line">35aee4a4404c42128bee8468a9517418ed0eb3dc initial commit add git-init and setting-up-a-repo docs</span><br></pre></td></tr></table></figure>

<p>请在命令行输入以下内容，如果出现此错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span></span><br><span class="line"></span><br><span class="line">https://emmap1@bitbucket.org/emmap1/bitbucketstationlocations.git </span><br><span class="line"></span><br><span class="line">Cloning into <span class="string">&#x27;bitbucketspacestation&#x27;</span>...</span><br><span class="line"></span><br><span class="line">fatal: could not <span class="built_in">read</span></span><br><span class="line"></span><br><span class="line">Password <span class="keyword">for</span> <span class="string">&#x27;https://emmap1@bitbucket.org&#x27;</span>: No such file or directory</span><br></pre></td></tr></table></figure>

<p>此时，我们通过执行以下命令对主分支执行交互式变基：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase -i origin/main</span><br></pre></td></tr></table></figure>

<p>在变基过程中，我们使用 rebase s子命令标记压缩的提交。我们会将一些提交压入最新的 “some WIP changes “提交中。</p>
<p>因为我们删除了提交，所以现在的 git log输出看起来像:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">40dhsoi37656e19d4e4f1a9b419f57850ch87dah987698hs some WIP changes</span><br><span class="line">35aee4a4404c42128bee8468a9517418ed0eb3dc initial commit add git-init and setting-up-a-repo docs</span><br></pre></td></tr></table></figure>

<p>如果我们检查一下此时的 git 日志，就会发现已经没有被标记为压缩(squashing)的提交了。如果我们想对其中一个被压缩的提交进行操作呢？也许从历史中删除它的改动？这就是利用 reflog 的好机会。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git reflog</span><br><span class="line">37656e1 HEAD@&#123;0&#125;: rebase -i (finish): returning to refs/heads/git_reflog</span><br><span class="line">37656e1 HEAD@&#123;1&#125;: rebase -i (start): checkout origin/main</span><br><span class="line">37656e1 HEAD@&#123;2&#125;: commit: some WIP changes</span><br></pre></td></tr></table></figure>

<p>我们可以看到有关于<code>rebase</code>开始和结束的引用日志条目，在这些条目之前是我们的”some WIP changes”提交。我们可以将 reflog ref 传递给 git reset，然后reset到rebase之前的提交。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/01/15/%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="wotzc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cai">
      <meta itemprop="description" content="真正的大师永远都怀着一颗学徒的心">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cai">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/15/%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">责任链模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-01-15 15:07:00" itemprop="dateCreated datePublished" datetime="2024-01-15T15:07:00+08:00">2024-01-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-18 11:43:02" itemprop="dateModified" datetime="2024-01-18T11:43:02+08:00">2024-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="意图"><a href="#意图" class="headerlink" title="意图"></a>意图</h1><p>责任链模式（<code>Chain of Responsibility</code>）使多个对象都有机会处理请求，从而避免请求的发送者和接收者之间的耦合关系。</p>
<p>将这些对象连成一条链，并沿着这条链传递该请求，直到有一个对象处理它为止。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/design-pattern/chain-of-responsibility-2x.png" style="zoom:50%;" />

<p>与许多其他行为设计模式一样， <strong>责任链</strong>会将特定行为转换为被称作<em>处理者</em>的独立对象。 在上述示例中， 每个检查步骤都可被抽取为仅有单个方法的类， 并执行检查操作。 请求及其数据则会被作为参数传递给该方法。</p>
<p>模式建议你将这些处理者连成一条链。 链上的每个处理者都有一个成员变量来保存对于下一处理者的引用。 除了处理请求外， 处理者还负责沿着链传递请求。 请求会在链上移动， 直至所有处理者都有机会对其进行处理。</p>
<p>最重要的是： 处理者可以决定不再沿着链传递请求， 这可高效地取消所有后续处理步骤。</p>
<h1 id="责任链模式结构"><a href="#责任链模式结构" class="headerlink" title="责任链模式结构"></a>责任链模式结构</h1><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/design-pattern/structure-of-chain-responsibility-2x.png" style="zoom:50%;" />

<h1 id="现实世界的例子"><a href="#现实世界的例子" class="headerlink" title="现实世界的例子"></a>现实世界的例子</h1><p>兽人国王向他的军队发出响亮的命令。最接近反应的是兽人指挥官<code>OrcCommander</code>，然后是兽人军官<code>OrcOfficer</code>，然后是兽人士兵<code>OrcSoldier</code>。指挥官、军官和士兵形成责任链。</p>
<p>用上面的兽人来翻译我们的例子。首先，我们有这样的<code>Request</code>类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The type of this request, used by each item in the chain to see if they should or can handle</span></span><br><span class="line"><span class="comment">     * this particular request.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RequestType requestType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name of the request.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Indicates if the request is handled or not. A request can only switch state from unhandled to</span></span><br><span class="line"><span class="comment">     * handled, there&#x27;s no way to &#x27;unhandle&#x27; a request.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> handled;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Request</span><span class="params">(RequestType requestType, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.requestType = Objects.requireNonNull(requestType);</span><br><span class="line">        <span class="keyword">this</span>.name = Objects.requireNonNull(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestType <span class="title">getRequestType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> requestType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Mark the request as handled.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">markHandled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.handled = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isHandled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.handled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，是我们请求处理程序的层次结构。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setNextHandler</span><span class="params">(RequestHandler handler)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(Request req)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrcCommander</span> <span class="keyword">implements</span> <span class="title">RequestHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RequestHandler nextHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNextHandler</span><span class="params">(RequestHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nextHandler = handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Request req)</span> </span>&#123;</span><br><span class="line">        System.out.println(name() + <span class="string">&quot; handle the request &quot;</span> + req);</span><br><span class="line">        <span class="keyword">this</span>.nextHandler.handle(req);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Orc commander&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrcOfficer</span> <span class="keyword">implements</span> <span class="title">RequestHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RequestHandler nextHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNextHandler</span><span class="params">(RequestHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nextHandler = handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Request req)</span> </span>&#123;</span><br><span class="line">        System.out.println(name() + <span class="string">&quot; handle the request &quot;</span> + req);</span><br><span class="line">        <span class="keyword">this</span>.nextHandler.handle(req);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Orc Officer&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrcSoldier</span> <span class="keyword">implements</span> <span class="title">RequestHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RequestHandler nextHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNextHandler</span><span class="params">(RequestHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nextHandler = handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Request req)</span> </span>&#123;</span><br><span class="line">        System.out.println(name() + <span class="string">&quot; handle the request &quot;</span> + req);</span><br><span class="line">        req.markHandled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Orc Soldier&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>兽人国王下达命令并形成请求链。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrcKing</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;RequestHandler&gt; handlers;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrcKing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        buildRequestChain();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildRequestChain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        handlers = Arrays.asList(<span class="keyword">new</span> OrcCommander(), <span class="keyword">new</span> OrcOfficer(), <span class="keyword">new</span> OrcSoldier());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; handlers.size() - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            handlers.get(i).setNextHandler(handlers.get(i +<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle request by the chain.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeRequest</span><span class="params">(Request req)</span> </span>&#123;</span><br><span class="line">        handlers.get(<span class="number">0</span>).handle(req);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Request request = <span class="keyword">new</span> Request(RequestType.DEFEND_CASTLE, <span class="string">&quot;defend castle&quot;</span>);</span><br><span class="line">    OrcKing orcKing = <span class="keyword">new</span> OrcKing();</span><br><span class="line">    orcKing.makeRequest(request);</span><br><span class="line"></span><br><span class="line">    System.out.println(request.isHandled());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Orc commander handle the request defend castle</span><br><span class="line">Orc Officer handle the request defend castle</span><br><span class="line">Orc Soldier handle the request defend castle</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h1><p><code>Responsibility</code>链有下列优点和缺点:</p>
<ul>
<li><p><strong>降低耦合度</strong></p>
<p>该模式使得一个对象无需知道是其他哪一个对象处理其请求。对象仅需知道该请求会被“正确”地处理。</p>
<p>接收者和发送者都没有对方的明确的信息，且链中的对象不需知道链的结构。</p>
<p>结果是，职责链可简化对象的相互连接。它们仅需保持一个指向其后继者的引用，而不需保持它所有的候选接受者的引用。</p>
</li>
<li><p><strong>增强了给对象指派职责(Responsibility)的灵活性</strong></p>
<p>当在对象中分派职责时，职责链给你更多的灵活性。</p>
<p>你可以通过在运行时刻对该链进行动态的增加或修改来增加或改变处理一个请求的那些职责。你可以将这种机制与静态的特例化处理对象的继承机制结合起来使用。</p>
</li>
<li><p><strong>不保证被接受</strong></p>
<p>既然一个请求没有明确的接收者，那么就不能保证它一定会被处理—该请求可能一直到链的末端都得不到处理。</p>
<p>一个请求也可能因该链没有被正确配置而得不到处理。</p>
</li>
</ul>
<h1 id="适合应用场景"><a href="#适合应用场景" class="headerlink" title="适合应用场景"></a>适合应用场景</h1><ol>
<li>当程序需要使用不同方式处理不同种类请求， 而且请求类型和顺序预先未知时， 可以使用责任链模式。<ul>
<li>该模式能将多个处理者连接成一条链。 接收到请求后， 它会 “询问” 每个处理者是否能够对其进行处理。 这样所有处理者都有机会来处理请求。</li>
</ul>
</li>
<li>当一个请求必须按顺序被多个处理者执行时， 可以使用该模式。<ul>
<li>无论你以何种顺序将处理者连接成一条链， 所有请求都会严格按照顺序通过链上的处理者。</li>
</ul>
</li>
<li>如果所需处理者及其顺序必须在运行时进行改变， 可以使用责任链模式。<ul>
<li>如果在处理者类中有对引用成员变量的设定方法， 你将能动态地插入和移除处理者， 或者改变其顺序。</li>
</ul>
</li>
</ol>
<h1 id="已知使用"><a href="#已知使用" class="headerlink" title="已知使用"></a>已知使用</h1><ul>
<li><code>java.util.logging.Logger#log()</code></li>
<li><code>Apache Commons Chain</code></li>
<li><code>javax.servlet.Filter#doFilter()</code> </li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/01/11/%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="wotzc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cai">
      <meta itemprop="description" content="真正的大师永远都怀着一颗学徒的心">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cai">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/11/%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">外观模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-01-11 09:38:35 / 修改时间：17:33:10" itemprop="dateCreated datePublished" datetime="2024-01-11T09:38:35+08:00">2024-01-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="意图"><a href="#意图" class="headerlink" title="意图"></a>意图</h1><p>外观模式(<code>Facade Pattern</code>)：外部与一个子系统的通信必须通过一个统一的外观对象进行，为子系统中的一组接口提供一个一致的界面，外观模式定义了一个高层接口，这个接口使得这一子系统更加容易使用。外观模式又称为门面模式，它是一种对象结构型模式。</p>
<h1 id="模式结构"><a href="#模式结构" class="headerlink" title="模式结构"></a>模式结构</h1><p>外观模式包含如下角色：</p>
<ul>
<li>Facade: 外观角色</li>
<li>SubSystem:子系统角色</li>
</ul>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/design-pattern/Facade.jpg" style="zoom: 67%;" />

<h1 id="现实世界的例子"><a href="#现实世界的例子" class="headerlink" title="现实世界的例子"></a>现实世界的例子</h1><p>金矿如何运作？ “好吧，矿工们到那里去挖金子吧！” 你说。 这就是你所相信的，因为你使用的是 goldmine 在外部提供的一个简单界面，在内部它必须做很多事情才能实现。 这个复杂子系统的简单接口就是外观。</p>
<h1 id="程序化示例"><a href="#程序化示例" class="headerlink" title="程序化示例"></a>程序化示例</h1><p>让我们以上面的金矿为例。这里我们有矮人矿工的等级制度。首先有一个基类<code>DwarvenMineWorker</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DwarvenMineWorker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">wakeUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(name() + <span class="string">&quot; wakes up.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">goToMine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(name() + <span class="string">&quot; goes to the mine.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">goHome</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(name() + <span class="string">&quot; goes home.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">goToSleep</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(name() + <span class="string">&quot; goes to sleep.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">Action</span> </span>&#123;</span><br><span class="line">        WAKE_UP,</span><br><span class="line">        GO_TO_MINE,</span><br><span class="line">        GO_HOME,</span><br><span class="line">        GO_TO_SLEEP,</span><br><span class="line">        WORK</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">(Action... action)</span> </span>&#123;</span><br><span class="line">        Arrays.stream(action).forEach(<span class="keyword">this</span>::action);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">(Action action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">            <span class="keyword">case</span> WAKE_UP: wakeUp();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> GO_TO_MINE: goToMine();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> GO_HOME: goHome();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> GO_TO_SLEEP: goToSleep();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> WORK: work();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                System.out.println(<span class="string">&quot;Undefine action!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们有具体的矮人类矮人隧道挖掘者<code>DwarvenTunnelDigger</code>，矮人掘金者<code>DwarvenGoldDigger</code>和矮人推车操作员<code>DwarvenCartOperator</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DwarvenTunnelDigger</span> <span class="keyword">extends</span> <span class="title">DwarvenMineWorker</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DwarvenTunnelDigger&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.name() + <span class="string">&quot; creates another promising tunnel.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DwarvenGoldDigger</span> <span class="keyword">extends</span> <span class="title">DwarvenMineWorker</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DwarvenGoldDigger&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.name() + <span class="string">&quot; digs for gold.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DwarvenCartOperator</span> <span class="keyword">extends</span> <span class="title">DwarvenMineWorker</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DwarvenCartOperator&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.name() + <span class="string">&quot; moves gold chunks out of the mine.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了操作所有这些金矿工人，我们有矮人金矿门面<code>DwarvenGoldmineFacade</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DwarvenGoldmineFacade</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;DwarvenMineWorker&gt; workers;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DwarvenGoldmineFacade</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        workers = Arrays.asList(<span class="keyword">new</span> DwarvenTunnelDigger(), <span class="keyword">new</span> DwarvenGoldDigger(), <span class="keyword">new</span> DwarvenCartOperator());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startNewDay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        makeActions(workers, DwarvenMineWorker.Action.WAKE_UP, DwarvenMineWorker.Action.GO_TO_MINE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">digOutGold</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        makeActions(workers, DwarvenMineWorker.Action.WORK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endDay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        makeActions(workers, DwarvenMineWorker.Action.GO_HOME, DwarvenMineWorker.Action.GO_TO_SLEEP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">makeActions</span><span class="params">(List&lt;DwarvenMineWorker&gt; workers, DwarvenMineWorker.Action... actions)</span> </span>&#123;</span><br><span class="line">        workers.forEach(worker -&gt; worker.action(actions));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在让我们使用门面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> facade = <span class="keyword">new</span> DwarvenGoldmineFacade();</span><br><span class="line">facade.startNewDay();</span><br><span class="line">facade.digOutGold();</span><br><span class="line">facade.endDay();</span><br></pre></td></tr></table></figure>

<p>输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DwarvenTunnelDigger wakes up.</span><br><span class="line">DwarvenTunnelDigger goes to the mine.</span><br><span class="line">DwarvenGoldDigger wakes up.</span><br><span class="line">DwarvenGoldDigger goes to the mine.</span><br><span class="line">DwarvenCartOperator wakes up.</span><br><span class="line">DwarvenCartOperator goes to the mine.</span><br><span class="line">DwarvenTunnelDigger creates another promising tunnel.</span><br><span class="line">DwarvenGoldDigger digs for gold.</span><br><span class="line">DwarvenCartOperator moves gold chunks out of the mine.</span><br><span class="line">DwarvenTunnelDigger goes home.</span><br><span class="line">DwarvenTunnelDigger goes to sleep.</span><br><span class="line">DwarvenGoldDigger goes home.</span><br><span class="line">DwarvenGoldDigger goes to sleep.</span><br><span class="line">DwarvenCartOperator goes home.</span><br><span class="line">DwarvenCartOperator goes to sleep.</span><br></pre></td></tr></table></figure>

<h1 id="外观模式适合应用场景"><a href="#外观模式适合应用场景" class="headerlink" title="外观模式适合应用场景"></a>外观模式适合应用场景</h1><ul>
<li><p>子系统通常会随着时间的推进变得越来越复杂。 即便是应用了设计模式， 通常你也会创建更多的类。 尽管在多种情形中子系统可能是更灵活或易于复用的， 但其所需的配置和样板代码数量将会增长得更快。 为了解决这个问题， 外观将会提供指向子系统中最常用功能的快捷方式， 能够满足客户端的大部分需求。</p>
</li>
<li><p>客户端和抽象的实现类之间存在许多依赖关系。引入外观将子系统与客户端和其他子系统解耦，从而提高子系统的独立性和可移植性。</p>
</li>
<li><p>如果需要将子系统组织为多层结构，可以使用外观。创建外观来定义子系统中各层次的入口。 你可以要求子系统仅使用外观来进行交互， 以减少子系统之间的耦合。让我们回到视频转换框架的例子。 该框架可以拆分为两个层次： 音频相关和视频相关。 你可以为每个层次创建一个外观， 然后要求各层的类必须通过这些外观进行交互。 这种方式看上去与中介者模式非常相似。</p>
</li>
</ul>
<h1 id="模式分析"><a href="#模式分析" class="headerlink" title="模式分析"></a>模式分析</h1><p>根据“单一职责原则”，在软件中将一个系统划分为若干个子系统有利于降低整个系统的复杂性，一个常见的设计目标是使子系统间的通信和相互依赖关系达到最小，而达到该目标的途径之一就是引入一个外观对象，它为子系统的访问提供了一个简单而单一的入口。 -外观模式也是“迪米特法则”的体现，通过引入一个新的外观类可以降低原有系统的复杂度，同时降低客户类与子系统类的耦合度。 - 外观模式要求一个子系统的外部与其内部的通信通过一个统一的外观对象进行，外观类将客户端与子系统的内部复杂性分隔开，使得客户端只需要与外观对象打交道，而不需要与子系统内部的很多对象打交道。 -外观模式的目的在于降低系统的复杂程度。 -外观模式从很大程度上提高了客户端使用的便捷性，使得客户端无须关心子系统的工作细节，通过外观角色即可调用相关功能。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>在外观模式中，外部与一个子系统的通信必须通过一个统一的外观对象进行，为子系统中的一组接口提供一个一致的界面，外观模式定义了一个高层接口，这个接口使得这一子系统更加容易使用。外观模式又称为门面模式，它是一种对象结构型模式。</li>
<li>外观模式包含两个角色：外观角色是在客户端直接调用的角色，在外观角色中可以知道相关的(一个或者多个)子系统的功能和责任，它将所有从客户端发来的请求委派到相应的子系统去，传递给相应的子系统对象处理；在软件系统中可以同时有一个或者多个子系统角色，每一个子系统可以不是一个单独的类，而是一个类的集合，它实现子系统的功能。</li>
<li>外观模式要求一个子系统的外部与其内部的通信通过一个统一的外观对象进行，外观类将客户端与子系统的内部复杂性分隔开，使得客户端只需要与外观对象打交道，而不需要与子系统内部的很多对象打交道。</li>
<li>外观模式主要优点在于对客户屏蔽子系统组件，减少了客户处理的对象数目并使得子系统使用起来更加容易，它实现了子系统与客户之间的松耦合关系，并降低了大型软件系统中的编译依赖性，简化了系统在不同平台之间的移植过程；其缺点在于不能很好地限制客户使用子系统类，而且在不引入抽象外观类的情况下，增加新的子系统可能需要修改外观类或客户端的源代码，违背了“开闭原则”。</li>
<li>外观模式适用情况包括：要为一个复杂子系统提供一个简单接口；客户程序与多个子系统之间存在很大的依赖性；在层次化结构中，需要定义系统中每一层的入口，使得层与层之间不直接产生联系。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="wotzc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cai">
      <meta itemprop="description" content="真正的大师永远都怀着一颗学徒的心">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cai">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">Arthas 命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-01-08 10:01:57" itemprop="dateCreated datePublished" datetime="2024-01-08T10:01:57+08:00">2024-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-10 15:20:36" itemprop="dateModified" datetime="2024-01-10T15:20:36+08:00">2024-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">Java诊断工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="命令列表"><a href="#命令列表" class="headerlink" title="命令列表"></a>命令列表</h1><h2 id="jvm-相关"><a href="#jvm-相关" class="headerlink" title="jvm 相关"></a>jvm 相关</h2><ul>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Dashboard-%E5%91%BD%E4%BB%A4">dashboard</a> - 当前系统的实时数据面板</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Getstatic-%E5%91%BD%E4%BB%A4">getstatic</a> - 查看类的静态属性</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#dump-%E5%91%BD%E4%BB%A4">heapdump</a> - dump java heap, 类似 jmap 命令的 heap dump 功能</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Jvm-%E5%91%BD%E4%BB%A4">jvm</a> - 查看当前 JVM 的信息</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Logger-%E5%91%BD%E4%BB%A4">logger</a> - 查看和修改 logger</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Mbean-%E5%91%BD%E4%BB%A4">mbean</a> - 查看 Mbean 的信息</li>
<li><a target="_blank" rel="noopener" href="http://localhost:4000/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#memory-%E5%91%BD%E4%BB%A4">memory</a> - 查看 JVM 的内存信息</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#ognl-%E5%91%BD%E4%BB%A4">ognl</a> - 执行 ognl 表达式</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Perfcounter-%E5%91%BD%E4%BB%A4">perfcounter</a> - 查看当前 JVM 的 Perf Counter 信息</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Sysenv-%E5%91%BD%E4%BB%A4">sysenv</a> - 查看 JVM 的环境变量</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#sysprop-%E5%91%BD%E4%BB%A4">sysprop</a> - 查看和修改 JVM 的系统属性</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#thread-%E5%91%BD%E4%BB%A4">thread</a> - 查看当前 JVM 的线程堆栈信息</li>
<li><a target="_blank" rel="noopener" href="http://localhost:4000/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Vmoption-%E5%91%BD%E4%BB%A4">vmoption</a> - 查看和修改 JVM 里诊断相关的 option</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Vmoption-%E5%91%BD%E4%BB%A4">vmtool</a> - 从 jvm 里查询对象，执行 forceGc</li>
</ul>
<h2 id="class-classloader-相关"><a href="#class-classloader-相关" class="headerlink" title="class/classloader 相关"></a>class/classloader 相关</h2><ul>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Classloader-%E5%91%BD%E4%BB%A4">classloader</a> - 查看 classloader 的继承树，urls，类加载信息，使用 classloader 去 getResource</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#dump-%E5%91%BD%E4%BB%A4">dump</a> - dump 已加载类的 byte code 到特定目录</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Jad-%E5%91%BD%E4%BB%A4">jad</a> - 反编译指定已加载类的源码</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#mc">mc</a> - 内存编译器，内存编译<code>.java</code>文件为<code>.class</code>文件</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#redefine">redefine</a> - 加载外部的<code>.class</code>文件，redefine 到 JVM 里</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#retransform-%E5%91%BD%E4%BB%A4">retransform</a> - 加载外部的<code>.class</code>文件，retransform 到 JVM 里</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Sc-%E5%91%BD%E4%BB%A4">sc</a> - 查看 JVM 已加载的类信息</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Sm-%E5%91%BD%E4%BB%A4">sm</a> - 查看已加载类的方法信息</li>
</ul>
<h2 id="monitor-watch-trace-相关"><a href="#monitor-watch-trace-相关" class="headerlink" title="monitor/watch/trace 相关"></a>monitor/watch/trace 相关</h2><p>注意</p>
<p>请注意，这些命令，都通过字节码增强技术来实现的，会在指定类的方法中插入一些切面来实现数据统计和观测，因此在线上、预发使用时，请尽量明确需要观测的类、方法以及条件，诊断结束要执行 <code>stop</code> 或将增强过的类执行 <code>reset</code> 命令。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Monitor-%E5%91%BD%E4%BB%A4">monitor</a> - 方法执行监控</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Stack-%E5%91%BD%E4%BB%A4">stack</a> - 输出当前方法被调用的调用路径</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#trace-%E5%91%BD%E4%BB%A4">trace</a> - 方法内部调用路径，并输出方法路径上的每个节点上耗时</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#tt-%E5%91%BD%E4%BB%A4">tt</a> - 方法执行数据的时空隧道，记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#watch-%E5%91%BD%E4%BB%A4">watch</a> - 方法执行数据观测</li>
</ul>
<h2 id="profiler-火焰图"><a href="#profiler-火焰图" class="headerlink" title="profiler/火焰图"></a>profiler/火焰图</h2><ul>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Profiler-%E5%91%BD%E4%BB%A4">profiler</a> - 使用<a target="_blank" rel="noopener" href="https://github.com/jvm-profiling-tools/async-profiler">async-profiler在新窗口打开</a>对应用采样，生成火焰图</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#jfr-%E5%91%BD%E4%BB%A4">jfr</a> - 动态开启关闭 JFR 记录</li>
</ul>
<h2 id="鉴权"><a href="#鉴权" class="headerlink" title="鉴权"></a>鉴权</h2><ul>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/auth.html">auth</a> - 鉴权</li>
</ul>
<h2 id="options"><a href="#options" class="headerlink" title="options"></a>options</h2><ul>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Options-%E5%91%BD%E4%BB%A4">options</a> - 查看或设置 Arthas 全局开关</li>
</ul>
<h2 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h2><p>Arthas 支持使用管道对上述命令的结果进行进一步的处理，如<code>sm java.lang.String * | grep &#39;index&#39;</code></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Grep-%E5%91%BD%E4%BB%A4">grep</a> - 搜索满足条件的结果</li>
<li>plaintext - 将命令的结果去除 ANSI 颜色</li>
<li>wc - 按行统计输出结果</li>
</ul>
<h2 id="后台异步任务"><a href="#后台异步任务" class="headerlink" title="后台异步任务"></a>后台异步任务</h2><p>当线上出现偶发的问题，比如需要 watch 某个条件，而这个条件一天可能才会出现一次时，异步后台任务就派上用场了，详情请参考<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/async.html">这里</a></p>
<ul>
<li>使用 <code>&gt;</code> 将结果重写向到日志文件，使用 <code>&amp;</code> 指定命令是后台运行，session 断开不影响任务执行（生命周期默认为 1 天）</li>
<li>jobs - 列出所有 job</li>
<li>kill - 强制终止任务</li>
<li>fg - 将暂停的任务拉到前台执行</li>
<li>bg - 将暂停的任务放到后台执行</li>
</ul>
<h2 id="基础命令"><a href="#基础命令" class="headerlink" title="基础命令"></a>基础命令</h2><ul>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/base64.html">base64</a> - base64 编码转换，和 linux 里的 base64 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Cat-%E5%91%BD%E4%BB%A4">cat</a> - 打印文件内容，和 linux 里的 cat 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Cls-%E5%91%BD%E4%BB%A4">cls</a> - 清空当前屏幕区域</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#echo-%E5%91%BD%E4%BB%A4">echo</a> - 打印参数，和 linux 里的 echo 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Grep-%E5%91%BD%E4%BB%A4">grep</a> - 匹配查找，和 linux 里的 grep 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Help-%E5%91%BD%E4%BB%A4">help</a> - 查看命令帮助信息</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#history-%E5%91%BD%E4%BB%A4">history</a> - 打印命令历史</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Keymap-%E5%91%BD%E4%BB%A4">keymap</a> - Arthas 快捷键列表及自定义快捷键</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Pwd-%E5%91%BD%E4%BB%A4">pwd</a> - 返回当前的工作目录，和 linux 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Quit-stop-%E5%91%BD%E4%BB%A4">quit</a> - 退出当前 Arthas 客户端，其他 Arthas 客户端不受影响</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Reset-%E5%91%BD%E4%BB%A4">reset</a> - 重置增强类，将被 Arthas 增强过的类全部还原，Arthas 服务端关闭时会重置所有增强过的类</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#session-%E5%91%BD%E4%BB%A4">session</a> - 查看当前会话的信息</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#Quit-stop-%E5%91%BD%E4%BB%A4">stop</a> - 关闭 Arthas 服务端，所有 Arthas 客户端全部退出</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#tee-%E5%91%BD%E4%BB%A4">tee</a> - 复制标准输入到标准输出和指定的文件，和 linux 里的 tee 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://tianzhencai.xyz/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/#version-%E5%91%BD%E4%BB%A4">version</a> - 输出当前目标 Java 进程所加载的 Arthas 版本号</li>
</ul>
<hr>
<h1 id="Cat-命令"><a href="#Cat-命令" class="headerlink" title="Cat 命令"></a>Cat 命令</h1><div class="note info no-icon"><p>提示</p>
<p>打印文件内容，和 linux 里的 cat 命令类似。</p>
</div>

<p>使用参考：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat &#x2F;tmp&#x2F;a.txt</span><br></pre></td></tr></table></figure>

<h1 id="Classloader-命令"><a href="#Classloader-命令" class="headerlink" title="Classloader 命令"></a>Classloader 命令</h1><h2 id="列出所有-ClassLoader"><a href="#列出所有-ClassLoader" class="headerlink" title="列出所有 ClassLoader"></a>列出所有 ClassLoader</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classloader -l</span><br></pre></td></tr></table></figure>

<h2 id="统计-ClassLoader-实际使用-URL-和未使用的-URL"><a href="#统计-ClassLoader-实际使用-URL-和未使用的-URL" class="headerlink" title="统计 ClassLoader 实际使用 URL 和未使用的 URL"></a>统计 ClassLoader 实际使用 URL 和未使用的 URL</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classloader --url-stat</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：基于 JVM 目前已加载的所有类统计，不代表 Unused URLs 可以从应用中删掉。因为可能将来需要从 Unused URLs 里加载类，或者需要加载 resources</p>
</blockquote>
<h2 id="列出-ClassLoader-里加载的所有类"><a href="#列出-ClassLoader-里加载的所有类" class="headerlink" title="列出 ClassLoader 里加载的所有类"></a>列出 ClassLoader 里加载的所有类</h2><p>列出上面的<code>org.apache.jasper.servlet.JasperLoader</code> 加载的类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classloader -a --classLoaderClass org.apache.jasper.servlet.JasperLoader | grep hello</span><br></pre></td></tr></table></figure>

<h2 id="查看类的-classloader-层次"><a href="#查看类的-classloader-层次" class="headerlink" title="查看类的 classloader 层次"></a>查看类的 classloader 层次</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc -d org.apache.jsp.jsp.hello_jsp</span><br></pre></td></tr></table></figure>

<h2 id="查看-ClassLoader-树"><a href="#查看-ClassLoader-树" class="headerlink" title="查看 ClassLoader 树"></a>查看 ClassLoader 树</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classloader -t</span><br></pre></td></tr></table></figure>

<h2 id="查看-URLClassLoader-实际的-urls"><a href="#查看-URLClassLoader-实际的-urls" class="headerlink" title="查看 URLClassLoader 实际的 urls"></a>查看 URLClassLoader 实际的 urls</h2><p>比如上面查看到的 spring LaunchedURLClassLoader 为 <code>org.springframework.boot.loader.LaunchedURLClassLoader</code> ，可以通过 <code>-c &lt;hashcode&gt;</code> 参数来指定 classloader，还有一种方法可以通过使用 <code>--classLoaderClass</code> 指定类名，从而查看 URLClassLoader 实际的 urls：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader</span><br></pre></td></tr></table></figure>

<h2 id="查找-ClassLoader-里的资源文件"><a href="#查找-ClassLoader-里的资源文件" class="headerlink" title="查找 ClassLoader 里的资源文件"></a>查找 ClassLoader 里的资源文件</h2><p>查找指定的资源文件： <code>classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</code></p>
<p>也可以尝试查找类的 class 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r java&#x2F;lang&#x2F;String.class</span><br></pre></td></tr></table></figure>

<h1 id="Cls-命令"><a href="#Cls-命令" class="headerlink" title="Cls 命令"></a>Cls 命令</h1><p>通过 <code>cls</code> 命令 可以清空当前屏幕区域。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cls</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Grep-命令"><a href="#Grep-命令" class="headerlink" title="Grep 命令"></a>Grep 命令</h1><div class="note info no-icon"><p>提示</p>
<p>类似传统的 grep 命令。</p>
</div>

<h2 id="使用参考"><a href="#使用参考" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">USAGE:</span><br><span class="line">  grep [-A &lt;value&gt;] [-B &lt;value&gt;] [-C &lt;value&gt;] [-h] [-i] [-v] [-n] [-m &lt;value&gt;] [-e] [--trim-end] pattern</span><br><span class="line"></span><br><span class="line">SUMMARY:</span><br><span class="line">  grep command for pipes.</span><br><span class="line"></span><br><span class="line">EXAMPLES:</span><br><span class="line"> sysprop | grep java</span><br><span class="line"> sysprop | grep java -n</span><br><span class="line"> sysenv | grep -v JAVA</span><br><span class="line"> sysenv | grep -e &quot;(?i)(JAVA|sun)&quot; -m 3  -C 2</span><br><span class="line"> sysenv | grep JAVA -A2 -B3</span><br><span class="line"> thread | grep -m 10 -e  &quot;TIMED_WAITING|WAITING&quot;</span><br><span class="line"></span><br><span class="line">WIKI:</span><br><span class="line">  https://arthas.aliyun.com/doc/grep</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">-A, --after-context &lt;value&gt;                                                    Print NUM lines of trailing context)</span><br><span class="line">-B, --before-context &lt;value&gt;                                                   Print NUM lines of leading context)</span><br><span class="line">-C, --context &lt;value&gt;                                                          Print NUM lines of output context)</span><br><span class="line">-h, --help                                                                     this help</span><br><span class="line">-i, --ignore-case                                                              Perform case insensitive matching.  By default, grep is case sensitive.</span><br><span class="line">-v, --invert-match                                                             Select non-matching lines</span><br><span class="line">-n, --line-number                                                              Print line number with output lines</span><br><span class="line">-m, --max-count &lt;value&gt;                                                        stop after NUM selected lines)</span><br><span class="line">-e, --regex                                                                    Enable regular expression to match</span><br><span class="line">    --trim-end                                                                 Remove whitespaces at the end of the line</span><br><span class="line">&lt;pattern&gt;                                                                      Pattern</span><br></pre></td></tr></table></figure>

<h3 id="匹配展示符合范本样式的项"><a href="#匹配展示符合范本样式的项" class="headerlink" title="匹配展示符合范本样式的项"></a>匹配展示符合范本样式的项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[arthas@13372]$ sysprop | grep java</span><br><span class="line"> java.specification.version                        1.8</span><br><span class="line"> java.class.path                                   math-game.jar</span><br><span class="line"> java.vm.vendor                                    Oracle Corporation</span><br><span class="line"> java.vendor.url                                   http:&#x2F;&#x2F;java.oracle.com&#x2F;</span><br><span class="line"> java.vm.specification.version                     1.8</span><br><span class="line"> sun.java.launcher                                 SUN_STANDARD</span><br><span class="line"> sun.java.command                                  math-game.jar</span><br><span class="line"> java.specification.vendor                         Oracle Corporation</span><br><span class="line"> java.home                                         D:\developInstall\JDK\jdk1.8.0_161\jre</span><br><span class="line"> java.vm.specification.vendor                      Oracle Corporation</span><br><span class="line"> java.specification.name                           Java Platform API Specification</span><br><span class="line"> java.awt.graphicsenv                              sun.awt.Win32GraphicsEnvironment</span><br><span class="line"> java.runtime.version                              1.8.0_161-b12</span><br><span class="line"> java.endorsed.dirs                                D:\developInstall\JDK\jdk1.8.0_161\jre\lib\endorsed</span><br><span class="line"> java.runtime.name                                 Java(TM) SE Runtime Environment</span><br><span class="line"> java.vm.name                                      Java HotSpot(TM) 64-Bit Server VM</span><br><span class="line"> java.vendor.url.bug                               http:&#x2F;&#x2F;bugreport.sun.com&#x2F;bugreport&#x2F;</span><br><span class="line"> java.io.tmpdir                                    C:\Users\PT-TIA~1\AppData\Local\Temp\</span><br><span class="line"> java.version                                      1.8.0_161</span><br><span class="line"> java.vm.specification.name                        Java Virtual Machine Specification</span><br><span class="line"> java.awt.printerjob                               sun.awt.windows.WPrinterJob</span><br><span class="line"> java.library.path                                 D:\developInstall\JDK\jdk1.8.0_161\bin;C:\Windows\Sun\Java\bin;C:\Windows\system32;C:\Windows;C:\Python27\;C:\Python27\Scripts;D:\app\pt-tianzhencai\product\11.1.0\db_1\bin;C:\Program Files (x86)\Comm</span><br><span class="line">                                                   on Files\Oracle\Java\javapath;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Windows\System32\OpenSSH\;C:\Program Files\TortoiseSVN\bin;C:\Progr</span><br><span class="line"> java.vm.info                                      mixed mode</span><br><span class="line"> java.vendor                                       Oracle Corporation</span><br><span class="line"> java.vm.version                                   25.161-b12</span><br><span class="line"> java.ext.dirs                                     D:\developInstall\JDK\jdk1.8.0_161\jre\lib\ext;C:\Windows\Sun\Java\lib\ext</span><br><span class="line"> java.class.version                                52.0</span><br></pre></td></tr></table></figure>

<h3 id="n-命令显示行号："><a href="#n-命令显示行号：" class="headerlink" title="-n 命令显示行号："></a><code>-n</code> 命令显示行号：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysprop | grep java -n</span><br></pre></td></tr></table></figure>

<h3 id="v-展示非匹配"><a href="#v-展示非匹配" class="headerlink" title="-v 展示非匹配"></a><code>-v</code> 展示非匹配</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysenv | grep -v JAVA</span><br></pre></td></tr></table></figure>

<h3 id="e-使用正则表达式匹配，-m-设定最大展示条数，"><a href="#e-使用正则表达式匹配，-m-设定最大展示条数，" class="headerlink" title="-e 使用正则表达式匹配，-m 设定最大展示条数，"></a><code>-e</code> 使用正则表达式匹配，<code>-m</code> 设定最大展示条数，</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sysenv | grep -e &quot;(?i)(JAVA|sun)&quot; -m 3 -C 2</span><br><span class="line">thread | grep -m 10 -e &quot;TIMED_WAITING|WAITING&quot;</span><br></pre></td></tr></table></figure>

<h3 id="除了显示符合范本样式的那一行之外，-A-指定显示该行之后的内容，-B-指定显示该行之前的内容。"><a href="#除了显示符合范本样式的那一行之外，-A-指定显示该行之后的内容，-B-指定显示该行之前的内容。" class="headerlink" title="除了显示符合范本样式的那一行之外，-A 指定显示该行之后的内容，-B 指定显示该行之前的内容。"></a>除了显示符合范本样式的那一行之外，<code>-A</code> 指定显示该行之后的内容，<code>-B</code> 指定显示该行之前的内容。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysenv | grep JAVA -A2 -B3</span><br></pre></td></tr></table></figure>

<h1 id="Dashboard-命令"><a href="#Dashboard-命令" class="headerlink" title="Dashboard 命令"></a>Dashboard 命令</h1><p>dashboard 命令可以查看当前系统的实时数据面板。</p>
<p>当运行在 Ali-tomcat 时，会显示当前 tomcat 的实时信息，如 HTTP 请求的 qps, rt, 错误数, 线程池信息等等。</p>
<h2 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right">[i:]</td>
<td align="left">刷新实时数据的时间间隔 (ms)，默认 5000ms</td>
</tr>
<tr>
<td align="right">[n:]</td>
<td align="left">刷新实时数据的次数</td>
</tr>
</tbody></table>
<h2 id="使用参考-1"><a href="#使用参考-1" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ dashboard</span><br><span class="line">ID   NAME                           GROUP           PRIORITY   STATE     %CPU      DELTA_TIME TIME      INTERRUPTE DAEMON</span><br><span class="line">-1   C2 CompilerThread0             -               -1         -         1.55      0.077      0:8.684   false      true</span><br><span class="line">53   Timer-for-arthas-dashboard-07b system          5          RUNNABLE  0.08      0.004      0:0.004   false      true</span><br><span class="line">22   scheduling-1                   main            5          TIMED_WAI 0.06      0.003      0:0.287   false      false</span><br><span class="line">-1   C1 CompilerThread0             -               -1         -         0.06      0.003      0:2.171   false      true</span><br><span class="line">-1   VM Periodic Task Thread        -               -1         -         0.03      0.001      0:0.092   false      true</span><br><span class="line">49   arthas-NettyHttpTelnetBootstra system          5          RUNNABLE  0.02      0.001      0:0.156   false      true</span><br><span class="line">16   Catalina-utility-1             main            1          TIMED_WAI 0.0       0.000      0:0.029   false      false</span><br><span class="line">-1   G1 Young RemSet Sampling       -               -1         -         0.0       0.000      0:0.019   false      true</span><br><span class="line">17   Catalina-utility-2             main            1          WAITING   0.0       0.000      0:0.025   false      false</span><br><span class="line">34   http-nio-8080-ClientPoller     main            5          RUNNABLE  0.0       0.000      0:0.016   false      true</span><br><span class="line">23   http-nio-8080-BlockPoller      main            5          RUNNABLE  0.0       0.000      0:0.011   false      true</span><br><span class="line">-1   VM Thread                      -               -1         -         0.0       0.000      0:0.032   false      true</span><br><span class="line">-1   Service Thread                 -               -1         -         0.0       0.000      0:0.006   false      true</span><br><span class="line">-1   GC Thread#5                    -               -1         -         0.0       0.000      0:0.043   false      true</span><br><span class="line">Memory                     used     total    max      usage    GC</span><br><span class="line">heap                       36M      70M      4096M    0.90%    gc.g1_young_generation.count   12</span><br><span class="line">g1_eden_space              6M       18M      -1       33.33%                                  86</span><br><span class="line">g1_old_gen                 30M      50M      4096M    0.74%    gc.g1_old_generation.count     0</span><br><span class="line">g1_survivor_space          491K     2048K    -1       24.01%   gc.g1_old_generation.time(ms)  0</span><br><span class="line">nonheap                    66M      69M      -1       96.56%</span><br><span class="line">codeheap_&#x27;non-nmethods&#x27;    1M       2M       5M       22.39%</span><br><span class="line">metaspace                  46M      47M      -1       98.01%</span><br><span class="line">Runtime</span><br><span class="line">os.name                                                        Mac OS X</span><br><span class="line">os.version                                                     10.15.4</span><br><span class="line">java.version                                                   15</span><br><span class="line">java.home                                                      /Library/Java/JavaVirtualMachines/jdk-15.jdk/Contents/Home</span><br><span class="line">systemload.average                                             10.68</span><br><span class="line">processors                                                     8</span><br><span class="line">uptime                                                         272s</span><br></pre></td></tr></table></figure>

<h2 id="数据说明"><a href="#数据说明" class="headerlink" title="数据说明"></a>数据说明</h2><ul>
<li>ID: Java 级别的线程 ID，注意这个 ID 不能跟 jstack 中的 nativeID 一一对应。</li>
<li>NAME: 线程名</li>
<li>GROUP: 线程组名</li>
<li>PRIORITY: 线程优先级, 1~10 之间的数字，越大表示优先级越高</li>
<li>STATE: 线程的状态</li>
<li>CPU%: 线程的 cpu 使用率。比如采样间隔 1000ms，某个线程的增量 cpu 时间为 100ms，则 cpu 使用率=100/1000=10%</li>
<li>DELTA_TIME: 上次采样之后线程运行增量 CPU 时间，数据格式为<code>秒</code></li>
<li>TIME: 线程运行总 CPU 时间，数据格式为<code>分:秒</code></li>
<li>INTERRUPTED: 线程当前的中断位状态</li>
<li>DAEMON: 是否是 daemon 线程</li>
</ul>
<h3 id="JVM-内部线程"><a href="#JVM-内部线程" class="headerlink" title="JVM 内部线程"></a>JVM 内部线程</h3><p>Java 8 之后支持获取 JVM 内部线程 CPU 时间，这些线程只有名称和 CPU 时间，没有 ID 及状态等信息（显示 ID 为-1）。 通过内部线程可以观测到 JVM 活动，如 GC、JIT 编译等占用 CPU 情况，方便了解 JVM 整体运行状况。</p>
<ul>
<li>当 JVM 堆(heap)/元数据(metaspace)空间不足或 OOM 时，可以看到 GC 线程的 CPU 占用率明显高于其他的线程。</li>
<li>当执行<code>trace/watch/tt/redefine</code>等命令后，可以看到 JIT 线程活动变得更频繁。因为 JVM 热更新 class 字节码时清除了此 class 相关的 JIT 编译结果，需要重新编译。</li>
</ul>
<p>JVM 内部线程包括下面几种：</p>
<ul>
<li>JIT 编译线程: 如 <code>C1 CompilerThread0</code>, <code>C2 CompilerThread0</code></li>
<li>GC 线程: 如<code>GC Thread0</code>, <code>G1 Young RemSet Sampling</code></li>
<li>其它内部线程: 如<code>VM Periodic Task Thread</code>, <code>VM Thread</code>, <code>Service Thread</code></li>
</ul>
<hr>
<h1 id="dump-命令"><a href="#dump-命令" class="headerlink" title="dump 命令"></a>dump 命令</h1><div class="note info no-icon"><p>提示</p>
<p>dump 已加载类的 bytecode 到特定目录</p>
</div>

<p>dump 命令将 JVM 中实际运行的 class 的 byte code dump 到指定目录，适用场景批量下载指定包目录的 class 字节码；如需反编译单一类、实时查看类信息，可参考 <a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/jad.html">jad</a>。</p>
<h2 id="参数说明-1"><a href="#参数说明-1" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>class-pattern</em></td>
<td align="left">类名表达式匹配</td>
</tr>
<tr>
<td align="right"><code>[c:]</code></td>
<td align="left">类所属 ClassLoader 的 hashcode</td>
</tr>
<tr>
<td align="right"><code>[classLoaderClass:]</code></td>
<td align="left">指定执行表达式的 ClassLoader 的 class name</td>
</tr>
<tr>
<td align="right"><code>[d:]</code></td>
<td align="left">设置类文件的目标目录</td>
</tr>
<tr>
<td align="right">[E]</td>
<td align="left">开启正则表达式匹配，默认为通配符匹配</td>
</tr>
</tbody></table>
<h2 id="使用参考-2"><a href="#使用参考-2" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dump java.lang.String</span><br><span class="line"> HASHCODE  CLASSLOADER  LOCATION</span><br><span class="line"> null                   /Users/admin/logs/arthas/classdump/java/lang/String.class</span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 119 ms.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ dump demo.*</span><br><span class="line"> HASHCODE  CLASSLOADER                                    LOCATION</span><br><span class="line"> 3d4eac69  +-sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69    /Users/admin/logs/arthas/classdump/sun.misc.Launcher<span class="variable">$AppClassLoader</span>-3d4eac69/demo/MathGame.class</span><br><span class="line">             +-sun.misc.Launcher<span class="variable">$ExtClassLoader</span>@66350f69</span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 39 ms.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dump -d /tmp/output java.lang.String</span><br><span class="line"> HASHCODE  CLASSLOADER  LOCATION</span><br><span class="line"> null                   /tmp/output/java/lang/String.class</span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 138 ms.</span><br></pre></td></tr></table></figure>

<ul>
<li>指定 classLoader</li>
</ul>
<p>注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，提取对应 ClassLoader 的 hashcode。</p>
<p>如果你使用<code>-c</code>，你需要手动输入 hashcode：<code>-c &lt;hashcode&gt;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dump -c 3d4eac69 demo.*</span><br></pre></td></tr></table></figure>

<p>对于只有唯一实例的 ClassLoader 可以通过<code>--classLoaderClass</code>指定 class name，使用起来更加方便：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ dump --classLoaderClass sun.misc.Launcher<span class="variable">$AppClassLoader</span> demo.*</span><br><span class="line"> HASHCODE  CLASSLOADER                                    LOCATION</span><br><span class="line"> 3d4eac69  +-sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69    /Users/admin/logs/arthas/classdump/sun.misc.Launcher<span class="variable">$AppClassLoader</span>-3d4eac69/demo/MathGame.class</span><br><span class="line">             +-sun.misc.Launcher<span class="variable">$ExtClassLoader</span>@66350f69</span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 39 ms.</span><br></pre></td></tr></table></figure>

<ul>
<li>注：这里 classLoaderClass 在 java 8 是 sun.misc.Launcher$AppClassLoader，而 java 11 的 classloader 是 jdk.internal.loader.ClassLoaders$AppClassLoader，killercoda 目前环境是 java11。</li>
</ul>
<p><code>--classLoaderClass</code> 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code>是动态变化的。</p>
<hr>
<h1 id="echo-命令"><a href="#echo-命令" class="headerlink" title="echo 命令"></a>echo 命令</h1><div class="note info no-icon"><p>提示</p>
<p>打印参数，和 linux 里的 echo 命令类似。</p>
</div>

<h2 id="使用参考-3"><a href="#使用参考-3" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;hello&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="Getstatic-命令"><a href="#Getstatic-命令" class="headerlink" title="Getstatic 命令"></a>Getstatic 命令</h1><ul>
<li>推荐直接使用<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/arthas-tutorials.html?language=cn&id=ognl">ognl</a>命令，更加灵活。</li>
</ul>
<p>通过 <code>getstatic</code> 命令可以方便的查看类的静态属性。使用方法为<code>getstatic class_name field_name</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ getstatic demo.MathGame random</span><br><span class="line">field: random</span><br><span class="line">@Random[</span><br><span class="line">    serialVersionUID=@Long[3905348978240129619],</span><br><span class="line">    seed=@AtomicLong[120955813885284],</span><br><span class="line">    multiplier=@Long[25214903917],</span><br><span class="line">    addend=@Long[11],</span><br><span class="line">    mask=@Long[281474976710655],</span><br><span class="line">    DOUBLE_UNIT=@Double[1.1102230246251565E-16],</span><br><span class="line">    BadBound=@String[bound must be positive],</span><br><span class="line">    BadRange=@String[bound must be greater than origin],</span><br><span class="line">    BadSize=@String[size must be non-negative],</span><br><span class="line">    seedUniquifier=@AtomicLong[-3282039941672302964],</span><br><span class="line">    nextNextGaussian=@Double[0.0],</span><br><span class="line">    haveNextNextGaussian=@Boolean[<span class="literal">false</span>],</span><br><span class="line">    serialPersistentFields=@ObjectStreamField[][isEmpty=<span class="literal">false</span>;size=3],</span><br><span class="line">    unsafe=@Unsafe[sun.misc.Unsafe@2eaa1027],</span><br><span class="line">    seedOffset=@Long[24],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li>指定 classLoader</li>
</ul>
<p>注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，使用<code>sc -d &lt;ClassName&gt;</code>提取对应 ClassLoader 的 hashcode。</p>
<p>如果你使用<code>-c</code>，你需要手动输入 hashcode：<code>-c &lt;hashcode&gt;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ getstatic -c 3d4eac69 demo.MathGame random</span><br></pre></td></tr></table></figure>

<p>对于只有唯一实例的 ClassLoader 可以通过<code>--classLoaderClass</code>指定 class name，使用起来更加方便：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getstatic --classLoaderClass sun.misc.Launcher$AppClassLoader demo.MathGame random</span><br></pre></td></tr></table></figure>

<ul>
<li>注: 这里 classLoaderClass 在 java 8 是 sun.misc.Launcher$AppClassLoader，而java 11的classloader是jdk.internal.loader.ClassLoaders$AppClassLoader，killercoda 目前环境是 java11。</li>
</ul>
<p><code>--classLoaderClass</code> 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code>是动态变化的。</p>
<hr>
<h1 id="Help-命令"><a href="#Help-命令" class="headerlink" title="Help 命令"></a>Help 命令</h1><p>查看命令帮助信息，可以查看当前 arthas 版本支持的指令，或者查看具体指令的使用说明。</p>
<div class="note info no-icon"><p>提示</p>
<p>[help 指令]的等同于[指令 -help]，都是查看具体指令的使用说明。</p>
</div>

<h2 id="参数说明-2"><a href="#参数说明-2" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right">不接参数</td>
<td align="left">查询当前 arthas 版本支持的指令以及指令描述</td>
</tr>
<tr>
<td align="right">[name:]</td>
<td align="left">查询具体指令的使用说明</td>
</tr>
</tbody></table>
<h2 id="使用参考-4"><a href="#使用参考-4" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ help dashboard</span><br><span class="line"> USAGE:</span><br><span class="line">  dashboard [-h] [-i &lt;value&gt;] [-n &lt;value&gt;]</span><br><span class="line"></span><br><span class="line">SUMMARY:</span><br><span class="line">  Overview of target jvm&#39;s thread, memory, gc, vm, tomcat info.</span><br><span class="line"></span><br><span class="line">EXAMPLES:</span><br><span class="line">  dashboard</span><br><span class="line">  dashboard -n 10</span><br><span class="line">  dashboard -i 2000</span><br><span class="line"></span><br><span class="line">WIKI:</span><br><span class="line">  https:&#x2F;&#x2F;arthas.aliyun.com&#x2F;doc&#x2F;dashboard</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">-h, --help                              this help</span><br><span class="line">-i, --interval &lt;value&gt;                  The interval (in ms) between two executions, default is 5000 ms.</span><br><span class="line">-n, --number-of-execution &lt;value&gt;       The number of times this command will be executed.</span><br></pre></td></tr></table></figure>

<h1 id="history-命令"><a href="#history-命令" class="headerlink" title="history 命令"></a>history 命令</h1><p>打印命令历史。</p>
<div class="note info no-icon"><p>提示</p>
<p>历史指令会通过一个名叫 history 的文件持久化，所以 history 指令可以查看当前 arthas 服务器的所有历史命令，而不仅只是当前次会话使用过的命令。</p>
</div>

<h2 id="参数说明-3"><a href="#参数说明-3" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right">[c:]</td>
<td align="left">清空历史指令</td>
</tr>
<tr>
<td align="right">[n:]</td>
<td align="left">显示最近执行的 n 条指令</td>
</tr>
</tbody></table>
<h2 id="使用参考-5"><a href="#使用参考-5" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#查看最近执行的3条指令</span><br><span class="line">$ history 3</span><br><span class="line">  269  thread</span><br><span class="line">  270  cls</span><br><span class="line">  271  history 3</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#清空指令</span><br><span class="line">$ history -c</span><br><span class="line">$ history 3</span><br><span class="line"> 1  history 3</span><br></pre></td></tr></table></figure>

<h1 id="Jad-命令"><a href="#Jad-命令" class="headerlink" title="Jad 命令"></a>Jad 命令</h1><p><code>jad</code> 命令 将 JVM 中实际运行的 class 的 byte code 反编译成 java 代码，便于你理解业务逻辑；</p>
<ul>
<li>在 Arthas Console 上，反编译出来的源码是带语法高亮的，阅读更方便</li>
<li>当然，反编译出来的 java 代码可能会存在语法错误，但不影响你进行阅读理解</li>
</ul>
<h2 id="参数说明-4"><a href="#参数说明-4" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>class-pattern</em></td>
<td align="left">类名表达式匹配</td>
</tr>
<tr>
<td align="right"><code>[c:]</code></td>
<td align="left">类所属 ClassLoader 的 hashcode</td>
</tr>
<tr>
<td align="right"><code>[classLoaderClass:]</code></td>
<td align="left">指定执行表达式的 ClassLoader 的 class name</td>
</tr>
<tr>
<td align="right">[E]</td>
<td align="left">开启正则表达式匹配，默认为通配符匹配</td>
</tr>
</tbody></table>
<h2 id="使用参考-6"><a href="#使用参考-6" class="headerlink" title="使用参考"></a>使用参考</h2><h3 id="反编译java-lang-String"><a href="#反编译java-lang-String" class="headerlink" title="反编译java.lang.String"></a>反编译<code>java.lang.String</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ jad java.lang.String</span><br><span class="line"></span><br><span class="line">ClassLoader:</span><br><span class="line"></span><br><span class="line">Location:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Decompiled with CFR.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">package</span> java.lang;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">import</span> java.io.ObjectStreamField;</span><br><span class="line">        <span class="keyword">import</span> java.io.Serializable;</span><br><span class="line">...</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">String</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Serializable</span>,</span></span><br><span class="line"><span class="class">        <span class="title">Comparable</span>&lt;<span class="title">String</span>&gt;,</span></span><br><span class="line"><span class="class">        <span class="title">CharSequence</span> </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">char</span>[] value;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">int</span> hash;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6849794470754667710L</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectStreamField[] serialPersistentFields = <span class="keyword">new</span> ObjectStreamField[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Comparator&lt;String&gt; CASE_INSENSITIVE_ORDER = <span class="keyword">new</span> CaseInsensitiveComparator();</span><br><span class="line">...</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(<span class="keyword">byte</span>[] byArray, <span class="keyword">int</span> n, <span class="keyword">int</span> n2, Charset charset)</span> </span>&#123;</span><br><span class="line"><span class="comment">/*460*/</span>         <span class="keyword">if</span> (charset == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;charset&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">/*462*/</span>         String.checkBounds(byArray, n, n2);</span><br><span class="line"><span class="comment">/*463*/</span>         <span class="keyword">this</span>.value = StringCoding.decode(charset, byArray, n, n2);</span><br><span class="line">            &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="反编译时只显示源代码"><a href="#反编译时只显示源代码" class="headerlink" title="反编译时只显示源代码"></a>反编译时只显示源代码</h3><p>默认情况下，反编译结果里会带有<code>ClassLoader</code>信息，通过<code>--source-only</code>选项，可以只打印源代码。方便和<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/mc.html">mc</a>/<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/retransform.html">retransform</a>命令结合使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ jad --source-only demo.MathGame</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Decompiled with CFR 0_132.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.PrintStream;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MathGame</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> illegalArgumentCount = <span class="number">0</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="反编译指定的函数"><a href="#反编译指定的函数" class="headerlink" title="反编译指定的函数"></a>反编译指定的函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ jad demo.MathGame main</span><br><span class="line"></span><br><span class="line">ClassLoader:</span><br><span class="line">+-sun.misc.Launcher$AppClassLoader@<span class="number">232204</span>a1</span><br><span class="line">  +-sun.misc.Launcher$ExtClassLoader@<span class="number">7f</span>31245a</span><br><span class="line"></span><br><span class="line">Location:</span><br><span class="line">/<span class="keyword">private</span>/tmp/math-game.jar</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">           MathGame game = <span class="keyword">new</span> MathGame();</span><br><span class="line">           <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"><span class="comment">/*16*/</span>         game.run();</span><br><span class="line"><span class="comment">/*17*/</span>         TimeUnit.SECONDS.sleep(<span class="number">1L</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h3 id="反编译时不显示行号"><a href="#反编译时不显示行号" class="headerlink" title="反编译时不显示行号"></a>反编译时不显示行号</h3><p><code>--lineNumber</code> 参数默认值为 true，显示指定为 false 则不打印行号。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ jad demo.MathGame main --lineNumber <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">ClassLoader:</span><br><span class="line">+-sun.misc.Launcher$AppClassLoader@<span class="number">232204</span>a1</span><br><span class="line">  +-sun.misc.Launcher$ExtClassLoader@<span class="number">7f</span>31245a</span><br><span class="line"></span><br><span class="line">Location:</span><br><span class="line">/<span class="keyword">private</span>/tmp/math-game.jar</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    MathGame game = <span class="keyword">new</span> MathGame();</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        game.run();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="反编译时指定-ClassLoader"><a href="#反编译时指定-ClassLoader" class="headerlink" title="反编译时指定 ClassLoader"></a>反编译时指定 ClassLoader</h3><div class="note info no-icon"><p>提示</p>
<p>当有多个 <code>ClassLoader</code> 都加载了这个类时，<code>jad</code> 命令会输出对应 <code>ClassLoader</code> 实例的 <code>hashcode</code>，然后你只需要重新执行 <code>jad</code> 命令，并使用参数 <code>-c &lt;hashcode&gt;</code> 就可以反编译指定 ClassLoader 加载的那个类了；</p>
</div>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ jad org.apache.log4j.Logger</span><br><span class="line"></span><br><span class="line">Found more than one class for: org.apache.log4j.Logger, Please use jad -c hashcode org.apache.log4j.Logger</span><br><span class="line">HASHCODE  CLASSLOADER</span><br><span class="line"><span class="number">69d</span>caba4  +-monitor<span class="string">&#x27;s ModuleClassLoader</span></span><br><span class="line"><span class="string">6e51ad67  +-java.net.URLClassLoader@6e51ad67</span></span><br><span class="line"><span class="string">            +-sun.misc.Launcher$AppClassLoader@6951a712</span></span><br><span class="line"><span class="string">            +-sun.misc.Launcher$ExtClassLoader@6fafc4c2</span></span><br><span class="line"><span class="string">2bdd9114  +-pandora-qos-service&#x27;</span>s ModuleClassLoader</span><br><span class="line"><span class="number">4</span>c0df5f8  +-pandora-framework<span class="string">&#x27;s ModuleClassLoader</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Affect(row-cnt:0) cost in 38 ms.</span></span><br><span class="line"><span class="string">$ jad org.apache.log4j.Logger -c 69dcaba4</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ClassLoader:</span></span><br><span class="line"><span class="string">+-monitor&#x27;</span>s ModuleClassLoader</span><br><span class="line"></span><br><span class="line">Location:</span><br><span class="line">/Users/admin/app/log4j-<span class="number">1.2</span>.<span class="number">14.</span>jar</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.log4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.spi.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Logger</span> <span class="keyword">extends</span> <span class="title">Category</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FQCN;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Logger</span><span class="params">(String name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:<span class="number">1</span>) cost in <span class="number">190</span> ms.</span><br></pre></td></tr></table></figure>

<p>对于只有唯一实例的 ClassLoader 还可以通过<code>--classLoaderClass</code>指定 class name，使用起来更加方便：</p>
<p><code>--classLoaderClass</code> 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code>是动态变化的。</p>
<h1 id="jfr-命令"><a href="#jfr-命令" class="headerlink" title="jfr 命令"></a>jfr 命令</h1><div class="note info no-icon"><p>提示</p>
<p>Java Flight Recorder (JFR) 是一种用于收集有关正在运行的 Java 应用程序的诊断和分析数据的工具。它集成到 Java 虚拟机 (JVM) 中，几乎不会造成性能开销，因此即使在负载较重的生产环境中也可以使用。</p>
</div>

<p><code>jfr</code> 命令支持在程序动态运行过程中开启和关闭 JFR 记录。 记录收集有关 event 的数据。事件在特定时间点发生在 JVM 或 Java 应用程序中。每个事件都有一个名称、一个时间戳和一个可选的有效负载。负载是与事件相关的数据，例如 CPU 使用率、事件前后的 Java 堆大小、锁持有者的线程 ID 等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jfr 命令基本运行结构是 jfr cmd [actionArg]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意： JDK8 的 8u262 版本之后才支持 jfr</p>
</blockquote>
<h2 id="参数说明-5"><a href="#参数说明-5" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>cmd</em></td>
<td align="left">要执行的操作 支持的命令【start，status，dump，stop】</td>
</tr>
<tr>
<td align="right"><em>actionArg</em></td>
<td align="left">属性名模式</td>
</tr>
<tr>
<td align="right">[n:]</td>
<td align="left">记录名称</td>
</tr>
<tr>
<td align="right">[r:]</td>
<td align="left">记录 id 值</td>
</tr>
<tr>
<td align="right">[dumponexit:]</td>
<td align="left">程序退出时，是否要 dump 出 .jfr 文件，默认为 false</td>
</tr>
<tr>
<td align="right">[d:]</td>
<td align="left">延迟多久后启动 JFR 记录，支持带单位配置，eg: 60s, 2m, 5h, 3d. 不带单位就是秒，默认无延迟</td>
</tr>
<tr>
<td align="right">[duration:]</td>
<td align="left">JFR 记录持续时间，支持单位配置，不带单位就是秒，默认一直记录</td>
</tr>
<tr>
<td align="right">[s:]</td>
<td align="left">采集 Event 的详细配置文件，默认是 default.jfc 位于 <code>$JAVA_HOME/lib/jfr/default.jfc</code></td>
</tr>
<tr>
<td align="right">[f:]</td>
<td align="left">将输出转储到指定路径</td>
</tr>
<tr>
<td align="right">[maxage:]</td>
<td align="left">缓冲区数据最大文件记录保存时间，支持单位配置，不带单位就是秒，默认是不限制</td>
</tr>
<tr>
<td align="right">[maxsize:]</td>
<td align="left">缓冲区的最大文件大小，支持单位配置， 不带单位是字节，m 或者 M 代表 MB，g 或者 G 代表 GB。</td>
</tr>
<tr>
<td align="right">[state:]</td>
<td align="left">jfr 记录状态</td>
</tr>
</tbody></table>
<h2 id="启动-JFR-记录"><a href="#启动-JFR-记录" class="headerlink" title="启动 JFR 记录"></a>启动 JFR 记录</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ jfr start</span><br><span class="line">Started recording 1. No limit specified, using maxsize=250MB as default.</span><br></pre></td></tr></table></figure>

<div class="note info no-icon"><p>提示</p>
<p>默认情况下，开启的是默认参数的 jfr 记录</p>
</div>

<p>启动 jfr 记录，指定记录名，记录持续时间，记录文件保存路径。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ jfr start -n myRecording --duration 60s -f /tmp/myRecording.jfr</span><br><span class="line">Started recording 2. The result will be written to:</span><br><span class="line">/tmp/myRecording.jfr</span><br></pre></td></tr></table></figure>

<h2 id="查看-JFR-记录状态"><a href="#查看-JFR-记录状态" class="headerlink" title="查看 JFR 记录状态"></a>查看 JFR 记录状态</h2><p>默认是查看所有 JFR 记录信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ jfr status</span><br><span class="line">Recording: recording=1 name=Recording-1 (running)</span><br><span class="line">Recording: recording=2 name=myRecording duration=PT1M (closed)</span><br></pre></td></tr></table></figure>

<p>查看指定记录 id 的记录信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ jfr status -r 1</span><br><span class="line">Recording: recording=1 name=Recording-1 (running)</span><br></pre></td></tr></table></figure>

<p>查看指定状态的记录信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ jfr status --state closed</span><br><span class="line">Recording: recording=2 name=myRecording duration=PT1M (closed)</span><br></pre></td></tr></table></figure>

<h2 id="dump-jfr-记录"><a href="#dump-jfr-记录" class="headerlink" title="dump jfr 记录"></a>dump jfr 记录</h2><p><code>jfr dump</code> 会输出从开始到运行该命令这段时间内的记录到 JFR 文件，且不会停止 <code>jfr</code> 的记录<br>指定记录输出路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ jfr dump -r 1 -f /tmp/myRecording1.jfr</span><br><span class="line">Dump recording 1, The result will be written to:</span><br><span class="line">/tmp/myRecording1.jfr</span><br></pre></td></tr></table></figure>

<p>不指定文件输出路径，默认是保存到<code>arthas-output</code>目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ jfr dump -r 1</span><br><span class="line">Dump recording 1, The result will be written to:</span><br><span class="line">/tmp/<span class="built_in">test</span>/arthas-output/20220819-200915.jfr</span><br></pre></td></tr></table></figure>

<h2 id="停止-jfr-记录"><a href="#停止-jfr-记录" class="headerlink" title="停止 jfr 记录"></a>停止 jfr 记录</h2><p>不指定记录输出路径，默认是保存到<code>arthas-output</code>目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ jfr stop -r 1</span><br><span class="line">Stop recording 1, The result will be written to:</span><br><span class="line">/tmp/<span class="built_in">test</span>/arthas-output/20220819-202049.jfr</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意一条记录只能停止一次。</p>
</blockquote>
<p>也可以指定记录输出路径。</p>
<h2 id="通过浏览器查看-arthas-output-下面-JFR-记录的结果"><a href="#通过浏览器查看-arthas-output-下面-JFR-记录的结果" class="headerlink" title="通过浏览器查看 arthas-output 下面 JFR 记录的结果"></a>通过浏览器查看 arthas-output 下面 JFR 记录的结果</h2><p>默认情况下，arthas 使用 8563 端口，则可以打开： <a target="_blank" rel="noopener" href="http://localhost:8563/arthas-output/%E5%9C%A8%E6%96%B0%E7%AA%97%E5%8F%A3%E6%89%93%E5%BC%80">http://localhost:8563/arthas-output/在新窗口打开</a>  查看到<code>arthas-output</code>目录下面的 JFR 记录结果：</p>
<p><img src="https://arthas.aliyun.com/images/arthas-output-recording.png" alt="img"></p>
<p>生成的结果可以用支持 jfr 格式的工具来查看。比如：</p>
<ul>
<li>JDK Mission Control ： <a target="_blank" rel="noopener" href="https://github.com/openjdk/jmc">https://github.com/openjdk/jmc</a></li>
</ul>
<hr>
<h1 id="Jvm-命令"><a href="#Jvm-命令" class="headerlink" title="Jvm 命令"></a>Jvm 命令</h1><div class="note info no-icon"><p>提示</p>
<p>查看当前 JVM 信息</p>
</div>

<h2 id="使用参考-7"><a href="#使用参考-7" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">$ jvm</span><br><span class="line">RUNTIME</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> MACHINE-NAME                   37@ff267334bb65</span><br><span class="line"> JVM-START-TIME                 2020-07-23 07:50:36</span><br><span class="line"> MANAGEMENT-SPEC-VERSION        1.2</span><br><span class="line"> SPEC-NAME                      Java Virtual Machine Specification</span><br><span class="line"> SPEC-VENDOR                    Oracle Corporation</span><br><span class="line"> SPEC-VERSION                   1.8</span><br><span class="line"> VM-NAME                        Java HotSpot(TM) 64-Bit Server VM</span><br><span class="line"> VM-VENDOR                      Oracle Corporation</span><br><span class="line"> VM-VERSION                     25.201-b09</span><br><span class="line"> INPUT-ARGUMENTS                []</span><br><span class="line"> CLASS-PATH                     demo-arthas-spring-boot.jar</span><br><span class="line"> BOOT-CLASS-PATH                /usr/lib/jvm/java-8-oracle/jre/lib/resources.jar:/usr/lib/jvm/java-8-oracle/j</span><br><span class="line">                                re/lib/rt.jar:/usr/lib/jvm/java-8-oracle/jre/lib/sunrsasign.jar:/usr/lib/jvm/</span><br><span class="line">                                java-8-oracle/jre/lib/jsse.jar:/usr/lib/jvm/java-8-oracle/jre/lib/jce.jar:/us</span><br><span class="line">                                r/lib/jvm/java-8-oracle/jre/lib/charsets.jar:/usr/lib/jvm/java-8-oracle/jre/l</span><br><span class="line">                                ib/jfr.jar:/usr/lib/jvm/java-8-oracle/jre/classes</span><br><span class="line"> LIBRARY-PATH                   /usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> CLASS-LOADING</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> LOADED-CLASS-COUNT             7529</span><br><span class="line"> TOTAL-LOADED-CLASS-COUNT       7529</span><br><span class="line"> UNLOADED-CLASS-COUNT           0</span><br><span class="line"> IS-VERBOSE                     false</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> COMPILATION</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> NAME                           HotSpot 64-Bit Tiered Compilers</span><br><span class="line"> TOTAL-COMPILE-TIME             14921(ms)</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> GARBAGE-COLLECTORS</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> PS Scavenge                            name : PS Scavenge</span><br><span class="line"> [count/time (ms)]                      collectionCount : 7</span><br><span class="line">                                        collectionTime : 68</span><br><span class="line"></span><br><span class="line"> PS MarkSweep                           name : PS MarkSweep</span><br><span class="line"> [count/time (ms)]                      collectionCount : 1</span><br><span class="line">                                        collectionTime : 47</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> MEMORY-MANAGERS</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> CodeCacheManager               Code Cache</span><br><span class="line"></span><br><span class="line"> Metaspace Manager              Metaspace</span><br><span class="line">                                Compressed Class Space</span><br><span class="line"></span><br><span class="line"> Copy                           Eden Space</span><br><span class="line">                                Survivor Space</span><br><span class="line"></span><br><span class="line"> MarkSweepCompact               Eden Space</span><br><span class="line">                                Survivor Space</span><br><span class="line">                                Tenured Gen</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> MEMORY</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> HEAP-MEMORY-USAGE                      init : 268435456(256.0 MiB)</span><br><span class="line"> [memory in bytes]                      used : 18039504(17.2 MiB)</span><br><span class="line">                                        committed : 181403648(173.0 MiB)</span><br><span class="line">                                        max : 3817865216(3.6 GiB)</span><br><span class="line"></span><br><span class="line"> NO-HEAP-MEMORY-USAGE                   init : 2555904(2.4 MiB)</span><br><span class="line"> [memory in bytes]                      used : 33926216(32.4 MiB)</span><br><span class="line">                                        committed : 35176448(33.5 MiB)</span><br><span class="line">                                        max : -1(-1 B)</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> OPERATING-SYSTEM</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> OS                             Linux</span><br><span class="line"> ARCH                           amd64</span><br><span class="line"> PROCESSORS-COUNT               3</span><br><span class="line"> LOAD-AVERAGE                   29.53</span><br><span class="line"> VERSION                        4.15.0-52-generic</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> THREAD</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> COUNT                          30</span><br><span class="line"> DAEMON-COUNT                   24</span><br><span class="line"> PEAK-COUNT                     31</span><br><span class="line"> STARTED-COUNT                  36</span><br><span class="line"> DEADLOCK-COUNT                 0</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> FILE-DESCRIPTOR</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> MAX-FILE-DESCRIPTOR-COUNT      1048576</span><br><span class="line"> OPEN-FILE-DESCRIPTOR-COUNT     100</span><br><span class="line">Affect(row-cnt:0) cost in 88 ms.</span><br></pre></td></tr></table></figure>

<h2 id="THREAD-相关"><a href="#THREAD-相关" class="headerlink" title="THREAD 相关"></a>THREAD 相关</h2><ul>
<li>COUNT: JVM 当前活跃的线程数</li>
<li>DAEMON-COUNT: JVM 当前活跃的守护线程数</li>
<li>PEAK-COUNT: 从 JVM 启动开始曾经活着的最大线程数</li>
<li>STARTED-COUNT: 从 JVM 启动开始总共启动过的线程次数</li>
<li>DEADLOCK-COUNT: JVM 当前死锁的线程数</li>
</ul>
<h2 id="文件描述符相关"><a href="#文件描述符相关" class="headerlink" title="文件描述符相关"></a>文件描述符相关</h2><ul>
<li>MAX-FILE-DESCRIPTOR-COUNT：JVM 进程最大可以打开的文件描述符数</li>
<li>OPEN-FILE-DESCRIPTOR-COUNT：JVM 当前打开的文件描述符数</li>
</ul>
<hr>
<h1 id="Keymap-命令"><a href="#Keymap-命令" class="headerlink" title="Keymap 命令"></a>Keymap 命令</h1><p><code>keymap</code>命令输出当前的快捷键映射表：</p>
<p>默认的快捷键如下：</p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>快捷键说明</th>
<th>命令名称</th>
<th>命令说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>&quot;\C-a&quot;</code></td>
<td>ctrl + a</td>
<td>beginning-of-line</td>
<td>跳到行首</td>
</tr>
<tr>
<td><code>&quot;\C-e&quot;</code></td>
<td>ctrl + e</td>
<td>end-of-line</td>
<td>跳到行尾</td>
</tr>
<tr>
<td><code>&quot;\C-f&quot;</code></td>
<td>ctrl + f</td>
<td>forward-word</td>
<td>向前移动一个单词</td>
</tr>
<tr>
<td><code>&quot;\C-b&quot;</code></td>
<td>ctrl + b</td>
<td>backward-word</td>
<td>向后移动一个单词</td>
</tr>
<tr>
<td><code>&quot;\e[D&quot;</code></td>
<td>键盘左方向键</td>
<td>backward-char</td>
<td>光标向前移动一个字符</td>
</tr>
<tr>
<td><code>&quot;\e[C&quot;</code></td>
<td>键盘右方向键</td>
<td>forward-char</td>
<td>光标向后移动一个字符</td>
</tr>
<tr>
<td><code>&quot;\e[B&quot;</code></td>
<td>键盘下方向键</td>
<td>next-history</td>
<td>下翻显示下一个命令</td>
</tr>
<tr>
<td><code>&quot;\e[A&quot;</code></td>
<td>键盘上方向键</td>
<td>previous-history</td>
<td>上翻显示上一个命令</td>
</tr>
<tr>
<td><code>&quot;\C-h&quot;</code></td>
<td>ctrl + h</td>
<td>backward-delete-char</td>
<td>向后删除一个字符</td>
</tr>
<tr>
<td><code>&quot;\C-?&quot;</code></td>
<td>ctrl + shift + /</td>
<td>backward-delete-char</td>
<td>向后删除一个字符</td>
</tr>
<tr>
<td><code>&quot;\C-u&quot;</code></td>
<td>ctrl + u</td>
<td>undo</td>
<td>撤销上一个命令，相当于清空当前行</td>
</tr>
<tr>
<td><code>&quot;\C-d&quot;</code></td>
<td>ctrl + d</td>
<td>delete-char</td>
<td>删除当前光标所在字符</td>
</tr>
<tr>
<td><code>&quot;\C-k&quot;</code></td>
<td>ctrl + k</td>
<td>kill-line</td>
<td>删除当前光标到行尾的所有字符</td>
</tr>
<tr>
<td><code>&quot;\C-i&quot;</code></td>
<td>ctrl + i</td>
<td>complete</td>
<td>自动补全，相当于敲<code>TAB</code></td>
</tr>
<tr>
<td><code>&quot;\C-j&quot;</code></td>
<td>ctrl + j</td>
<td>accept-line</td>
<td>结束当前行，相当于敲回车</td>
</tr>
<tr>
<td><code>&quot;\C-m&quot;</code></td>
<td>ctrl + m</td>
<td>accept-line</td>
<td>结束当前行，相当于敲回车</td>
</tr>
<tr>
<td><code>&quot;\C-w&quot;</code></td>
<td></td>
<td>backward-delete-word</td>
<td></td>
</tr>
<tr>
<td><code>&quot;\C-x\e[3~&quot;</code></td>
<td></td>
<td>backward-kill-line</td>
<td></td>
</tr>
<tr>
<td><code>&quot;\e\C-?&quot;</code></td>
<td></td>
<td>backward-kill-word</td>
<td></td>
</tr>
</tbody></table>
<ul>
<li>任何时候 <code>tab</code> 键，会根据当前的输入给出提示</li>
<li>命令后敲 <code>-</code> 或 <code>--</code> ，然后按 <code>tab</code> 键，可以展示出此命令具体的选项</li>
</ul>
<h2 id="自定义快捷键"><a href="#自定义快捷键" class="headerlink" title="自定义快捷键"></a>自定义快捷键</h2><p>在当前用户目录下新建<code>$USER_HOME/.arthas/conf/inputrc</code>文件，加入自定义配置。</p>
<p>假设我是 vim 的重度用户，我要把<code>ctrl+h</code>设置为光标向前一个字符，则设置如下，首先拷贝默认配置</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&quot;\C-a&quot;: beginning-of-line</span><br><span class="line">&quot;\C-e&quot;: end-of-line</span><br><span class="line">&quot;\C-f&quot;: forward-word</span><br><span class="line">&quot;\C-b&quot;: backward-word</span><br><span class="line">&quot;\e[D&quot;: backward-char</span><br><span class="line">&quot;\e[C&quot;: forward-char</span><br><span class="line">&quot;\e[B&quot;: next-history</span><br><span class="line">&quot;\e[A&quot;: previous-history</span><br><span class="line">&quot;\C-h&quot;: backward-delete-char</span><br><span class="line">&quot;\C-?&quot;: backward-delete-char</span><br><span class="line">&quot;\C-u&quot;: undo</span><br><span class="line">&quot;\C-d&quot;: delete-char</span><br><span class="line">&quot;\C-k&quot;: kill-line</span><br><span class="line">&quot;\C-i&quot;: complete</span><br><span class="line">&quot;\C-j&quot;: accept-line</span><br><span class="line">&quot;\C-m&quot;: accept-line</span><br><span class="line">&quot;\C-w&quot;: backward-delete-word</span><br><span class="line">&quot;\C-x\e[3~&quot;: backward-kill-line</span><br><span class="line">&quot;\e\C-?&quot;: backward-kill-word</span><br></pre></td></tr></table></figure>

<p>然后把<code>&quot;\C-h&quot;: backward-delete-char</code>换成<code>&quot;\C-h&quot;: backward-char</code>，然后重新连接即可。</p>
<h2 id="后台异步命令相关快捷键"><a href="#后台异步命令相关快捷键" class="headerlink" title="后台异步命令相关快捷键"></a>后台异步命令相关快捷键</h2><ul>
<li>ctrl + c: 终止当前命令</li>
<li>ctrl + z: 挂起当前命令，后续可以 bg/fg 重新支持此命令，或 kill 掉</li>
<li>ctrl + a: 回到行首</li>
<li>ctrl + e: 回到行尾</li>
</ul>
<h1 id="Logger-命令"><a href="#Logger-命令" class="headerlink" title="Logger 命令"></a>Logger 命令</h1><div class="note info no-icon"><p>提示</p>
<p>查看 logger 信息，更新 logger level</p>
</div>

<h2 id="使用参考-8"><a href="#使用参考-8" class="headerlink" title="使用参考"></a>使用参考</h2><h3 id="查看所有-logger-信息"><a href="#查看所有-logger-信息" class="headerlink" title="查看所有 logger 信息"></a>查看所有 logger 信息</h3><p>以下面的<code>logback.xml</code>为例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;APPLICATION&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>app.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>mylog-%d&#123;yyyy-MM-dd&#125;.%i.txt<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>60<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">totalSizeCap</span>&gt;</span>2GB<span class="tag">&lt;/<span class="name">totalSizeCap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%logger&#123;35&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;ASYNC&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.AsyncAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;APPLICATION&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;35&#125; - %msg %n</span><br><span class="line">            <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>utf8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;CONSOLE&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;ASYNC&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用<code>logger</code>命令打印的结果是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[arthas@2062]$ logger</span><br><span class="line"> name                                   ROOT</span><br><span class="line"> class                                  ch.qos.logback.classic.Logger</span><br><span class="line"> classLoader                            sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line"> classLoaderHash                        2a139a55</span><br><span class="line"> level                                  INFO</span><br><span class="line"> effectiveLevel                         INFO</span><br><span class="line"> additivity                             <span class="literal">true</span></span><br><span class="line"> codeSource                             file:/Users/hengyunabc/.m2/repository/ch/qos/logback/logback-classic/1.2.3/logback-classic-1.2.3.jar</span><br><span class="line"> appenders                              name            CONSOLE</span><br><span class="line">                                        class           ch.qos.logback.core.ConsoleAppender</span><br><span class="line">                                        classLoader     sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line">                                        classLoaderHash 2a139a55</span><br><span class="line">                                        target          System.out</span><br><span class="line">                                        name            APPLICATION</span><br><span class="line">                                        class           ch.qos.logback.core.rolling.RollingFileAppender</span><br><span class="line">                                        classLoader     sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line">                                        classLoaderHash 2a139a55</span><br><span class="line">                                        file            app.log</span><br><span class="line">                                        name            ASYNC</span><br><span class="line">                                        class           ch.qos.logback.classic.AsyncAppender</span><br><span class="line">                                        classLoader     sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line">                                        classLoaderHash 2a139a55</span><br><span class="line">                                        appenderRef     [APPLICATION]</span><br></pre></td></tr></table></figure>

<p>从<code>appenders</code>的信息里，可以看到</p>
<ul>
<li><code>CONSOLE</code> logger 的 target 是<code>System.out</code></li>
<li><code>APPLICATION</code> logger 是<code>RollingFileAppender</code>，它的 file 是<code>app.log</code></li>
<li><code>ASYNC</code>它的<code>appenderRef</code>是<code>APPLICATION</code>，即异步输出到文件里</li>
</ul>
<h3 id="查看指定名字的-logger-信息"><a href="#查看指定名字的-logger-信息" class="headerlink" title="查看指定名字的 logger 信息"></a>查看指定名字的 logger 信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[arthas@2062]$ logger -n org.springframework.web</span><br><span class="line"> name                                   org.springframework.web</span><br><span class="line"> class                                  ch.qos.logback.classic.Logger</span><br><span class="line"> classLoader                            sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line"> classLoaderHash                        2a139a55</span><br><span class="line"> level                                  null</span><br><span class="line"> effectiveLevel                         INFO</span><br><span class="line"> additivity                             <span class="literal">true</span></span><br><span class="line"> codeSource                             file:/Users/hengyunabc/.m2/repository/ch/qos/logback/logback-classic/1.2.3/logback-classic-1.2.3.jar</span><br></pre></td></tr></table></figure>

<h3 id="查看指定-classloader-的-logger-信息"><a href="#查看指定-classloader-的-logger-信息" class="headerlink" title="查看指定 classloader 的 logger 信息"></a>查看指定 classloader 的 logger 信息</h3><p>注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，提取对应 ClassLoader 的 hashcode。</p>
<p>如果你使用<code>-c</code>，你需要手动输入 hashcode：<code>-c &lt;hashcode&gt;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[arthas@2062]$ logger -c 2a139a55</span><br><span class="line"> name                                   ROOT</span><br><span class="line"> class                                  ch.qos.logback.classic.Logger</span><br><span class="line"> classLoader                            sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line"> classLoaderHash                        2a139a55</span><br><span class="line"> level                                  DEBUG</span><br><span class="line"> effectiveLevel                         DEBUG</span><br><span class="line"> additivity                             <span class="literal">true</span></span><br><span class="line"> codeSource                             file:/Users/hengyunabc/.m2/repository/ch/qos/logback/logback-classic/1.2.3/logback-classic-1.2.3.jar</span><br><span class="line"> appenders                              name            CONSOLE</span><br><span class="line">                                        class           ch.qos.logback.core.ConsoleAppender</span><br><span class="line">                                        classLoader     sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line">                                        classLoaderHash 2a139a55</span><br><span class="line">                                        target          System.out</span><br><span class="line">                                        name            APPLICATION</span><br><span class="line">                                        class           ch.qos.logback.core.rolling.RollingFileAppender</span><br><span class="line">                                        classLoader     sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line">                                        classLoaderHash 2a139a55</span><br><span class="line">                                        file            app.log</span><br><span class="line">                                        name            ASYNC</span><br><span class="line">                                        class           ch.qos.logback.classic.AsyncAppender</span><br><span class="line">                                        classLoader     sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line">                                        classLoaderHash 2a139a55</span><br><span class="line">                                        appenderRef     [APPLICATION]</span><br></pre></td></tr></table></figure>

<p>对于只有唯一实例的 ClassLoader 可以通过<code>--classLoaderClass</code>指定 class name，使用起来更加方便：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger --classLoaderClass sun.misc.Launcher$AppClassLoader</span><br></pre></td></tr></table></figure>

<ul>
<li>注: 这里 classLoaderClass 在 java 8 是 sun.misc.Launcher$AppClassLoader，而java 11的classloader是jdk.internal.loader.ClassLoaders$AppClassLoader。</li>
</ul>
<p><code>--classLoaderClass</code> 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code>是动态变化的。</p>
<h3 id="更新-logger-level"><a href="#更新-logger-level" class="headerlink" title="更新 logger level"></a>更新 logger level</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@2062]$ logger --name ROOT --level debug</span><br><span class="line">update logger level success.</span><br></pre></td></tr></table></figure>

<h3 id="指定-classloader-更新-logger-level"><a href="#指定-classloader-更新-logger-level" class="headerlink" title="指定 classloader 更新 logger level"></a>指定 classloader 更新 logger level</h3><p>默认情况下，logger 命令会在 SystemClassloader 下执行，如果应用是传统的<code>war</code>应用，或者 spring boot fat jar 启动的应用，那么需要指定 classloader。</p>
<p>可以先用 <code>sc -d yourClassName</code> 来查看具体的 classloader hashcode，然后在更新 level 时指定 classloader：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[arthas@2062]$ logger -c 2a139a55 --name ROOT --level debug</span><br></pre></td></tr></table></figure>

<h3 id="查看没有-appender-的-logger-的信息"><a href="#查看没有-appender-的-logger-的信息" class="headerlink" title="查看没有 appender 的 logger 的信息"></a>查看没有 appender 的 logger 的信息</h3><p>默认情况下，<code>logger</code>命令只打印有 appender 的 logger 的信息。如果想查看没有<code>appender</code>的 logger 的信息，可以加上参数<code>--include-no-appender</code>。</p>
<p>注意，通常输出结果会很长。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[arthas@2062]$ logger --include-no-appender</span><br><span class="line"> name                                   ROOT</span><br><span class="line"> class                                  ch.qos.logback.classic.Logger</span><br><span class="line"> classLoader                            sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line"> classLoaderHash                        2a139a55</span><br><span class="line"> level                                  DEBUG</span><br><span class="line"> effectiveLevel                         DEBUG</span><br><span class="line"> additivity                             <span class="literal">true</span></span><br><span class="line"> codeSource                             file:/Users/hengyunabc/.m2/repository/ch/qos/logback/logback-classic/1.2.3/logback-classic-1.2.3.jar</span><br><span class="line"> appenders                              name            CONSOLE</span><br><span class="line">                                        class           ch.qos.logback.core.ConsoleAppender</span><br><span class="line">                                        classLoader     sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line">                                        classLoaderHash 2a139a55</span><br><span class="line">                                        target          System.out</span><br><span class="line">                                        name            APPLICATION</span><br><span class="line">                                        class           ch.qos.logback.core.rolling.RollingFileAppender</span><br><span class="line">                                        classLoader     sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line">                                        classLoaderHash 2a139a55</span><br><span class="line">                                        file            app.log</span><br><span class="line">                                        name            ASYNC</span><br><span class="line">                                        class           ch.qos.logback.classic.AsyncAppender</span><br><span class="line">                                        classLoader     sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line">                                        classLoaderHash 2a139a55</span><br><span class="line">                                        appenderRef     [APPLICATION]</span><br><span class="line"></span><br><span class="line"> name                                   com</span><br><span class="line"> class                                  ch.qos.logback.classic.Logger</span><br><span class="line"> classLoader                            sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line"> classLoaderHash                        2a139a55</span><br><span class="line"> level                                  null</span><br><span class="line"> effectiveLevel                         DEBUG</span><br><span class="line"> additivity                             <span class="literal">true</span></span><br><span class="line"> codeSource                             file:/Users/hengyunabc/.m2/repository/ch/qos/logback/logback-classic/1.2.3/logback-classic-1.2.3.jar</span><br><span class="line"></span><br><span class="line"> name                                   com.alibaba</span><br><span class="line"> class                                  ch.qos.logback.classic.Logger</span><br><span class="line"> classLoader                            sun.misc.Launcher<span class="variable">$AppClassLoader</span>@2a139a55</span><br><span class="line"> classLoaderHash                        2a139a55</span><br><span class="line"> level                                  null</span><br><span class="line"> effectiveLevel                         DEBUG</span><br><span class="line"> additivity                             <span class="literal">true</span></span><br><span class="line"> codeSource                             file:/Users/hengyunabc/.m2/repository/ch/qos/logback/logback-classic/1.2.3/logback-classic-1.2.3.jar</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Mbean-命令"><a href="#Mbean-命令" class="headerlink" title="Mbean 命令"></a>Mbean 命令</h1><div class="note info no-icon"><p>提示</p>
<p>查看 Mbean 的信息</p>
</div>

<p>这个命令可以便捷的查看或监控 Mbean 的属性信息。</p>
<h2 id="参数说明-6"><a href="#参数说明-6" class="headerlink" title="参数说明"></a>参数说明</h2><hr>
<h1 id="mc-redefine-命令"><a href="#mc-redefine-命令" class="headerlink" title="mc-redefine 命令"></a>mc-redefine 命令</h1><h2 id="mc"><a href="#mc" class="headerlink" title="mc"></a>mc</h2><blockquote>
<p>Memory Compiler/内存编译器，编译<code>.java</code> 文件生成<code>.class</code> 。</p>
</blockquote>
<h2 id="使用参考-9"><a href="#使用参考-9" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mc /tmp/Test.java</span><br></pre></td></tr></table></figure>

<p>可以通过<code>-c</code>参数指定 classloader：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mc -c 327a647b /tmp/Test.java</span><br></pre></td></tr></table></figure>

<p>也可以通过<code>--classLoaderClass</code>参数指定 ClassLoader：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java -d /tmp</span><br><span class="line">Memory compiler output:</span><br><span class="line">/tmp/com/example/demo/arthas/user/UserController.class</span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 346 ms</span><br></pre></td></tr></table></figure>

<p>可以通过<code>-d</code>命令指定输出目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mc -d /tmp/output /tmp/ClassA.java /tmp/ClassB.java</span><br></pre></td></tr></table></figure>

<p>编译生成<code>.class</code>文件之后，可以结合<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/retransform.html">retransform</a>命令实现热更新代码。</p>
<details class="note "><summary><p>warn no-icon</p>
</summary>
<p>注意</p>
<p>注意，mc 命令有可能失败。如果编译失败可以在本地编译好 .class 文件，再上传到服务器。具体参考<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/retransform.html">retransform</a>命令说明。</p>

</details>

<h2 id="redefine"><a href="#redefine" class="headerlink" title="redefine"></a>redefine</h2><div class="note info no-icon"><p>提示</p>
<p>推荐使用 retransform 命令</p>
</div>

<ul>
<li>redefine 的 class 不能修改、添加、删除类的 field 和 method，包括方法参数、方法名称及返回值</li>
<li>如果 mc 失败，可以在本地开发环境编译好 class 文件，上传到目标系统，使用 redefine 热加载 class</li>
<li>目前 redefine 和 watch/trace/jad/tt 等命令冲突，以后重新实现 redefine 功能会解决此问题</li>
</ul>
<details class="note "><summary><p>warn no-icon</p>
</summary>
<p>注意</p>
<p>注意， redefine 后的原来的类不能恢复，redefine 有可能失败（比如增加了新的 field），参考 jdk 本身的文档。</p>

</details>

<div class="note info no-icon"><p>提示</p>
<p><code>reset</code>命令对<code>redefine</code>的类无效。如果想重置，需要<code>redefine</code>原始的字节码。</p>
</div>

<div class="note info no-icon"><p>提示</p>
<p><code>redefine</code>命令和<code>jad</code>/<code>watch</code>/<code>trace</code>/<code>monitor</code>/<code>tt</code>等命令会冲突。执行完<code>redefine</code>之后，如果再执行上面提到的命令，则会把<code>redefine</code>的字节码重置。 原因是 jdk 本身 redefine 和 Retransform 是不同的机制，同时使用两种机制来更新字节码，只有最后修改的会生效。</p>
</div>

<hr>
<h1 id="retransform-命令"><a href="#retransform-命令" class="headerlink" title="retransform 命令"></a>retransform 命令</h1><div class="note info no-icon"><p>提示</p>
<p>加载外部的 .class 文件，retransform jvm 已加载的类。</p>
</div>

<h2 id="使用参考-10"><a href="#使用参考-10" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">retransform /tmp/Test.class</span><br><span class="line">retransform -l</span><br><span class="line">retransform -d 1                    <span class="comment"># delete retransform entry</span></span><br><span class="line">retransform --deleteAll             <span class="comment"># delete all retransform entries</span></span><br><span class="line">retransform --classPattern demo.*   <span class="comment"># triger retransform classes</span></span><br><span class="line">retransform -c 327a647b /tmp/Test.class /tmp/Test\<span class="variable">$Inner</span>.class</span><br><span class="line">retransform --classLoaderClass <span class="string">&#x27;sun.misc.Launcher$AppClassLoader&#x27;</span> /tmp/Test.class</span><br></pre></td></tr></table></figure>

<h2 id="retransform-指定的-class-文件"><a href="#retransform-指定的-class-文件" class="headerlink" title="retransform 指定的 .class 文件"></a>retransform 指定的 .class 文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ retransform /tmp/MathGame.class</span><br><span class="line">retransform success, size: 1, classes:</span><br><span class="line">demo.MathGame</span><br></pre></td></tr></table></figure>

<p>加载指定的 .class 文件，然后解析出 class name，再 retransform jvm 中已加载的对应的类。每加载一个 <code>.class</code> 文件，则会记录一个 retransform entry.</p>
<div class="note info no-icon"><p>提示</p>
<p>如果多次执行 retransform 加载同一个 class 文件，则会有多条 retransform entry.</p>
</div>

<h2 id="查看-retransform-entry"><a href="#查看-retransform-entry" class="headerlink" title="查看 retransform entry"></a>查看 retransform entry</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ retransform -l</span><br><span class="line">Id              ClassName       TransformCount  LoaderHash      LoaderClassName</span><br><span class="line">1               demo.MathGame   1               null            null</span><br></pre></td></tr></table></figure>

<ul>
<li>TransformCount 统计在 ClassFileTransformer#transform 函数里尝试返回 entry 对应的 .class 文件的次数，但并不表明 transform 一定成功。</li>
</ul>
<h2 id="删除指定-retransform-entry"><a href="#删除指定-retransform-entry" class="headerlink" title="删除指定 retransform entry"></a>删除指定 retransform entry</h2><p>需要指定 id：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retransform -d 1</span><br></pre></td></tr></table></figure>

<h2 id="删除所有-retransform-entry"><a href="#删除所有-retransform-entry" class="headerlink" title="删除所有 retransform entry"></a>删除所有 retransform entry</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retransform --deleteAll</span><br></pre></td></tr></table></figure>

<h2 id="显式触发-retransform"><a href="#显式触发-retransform" class="headerlink" title="显式触发 retransform"></a>显式触发 retransform</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ retransform --classPattern demo.MathGame</span><br><span class="line">retransform success, size: 1, classes:</span><br><span class="line">demo.MathGame</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：对于同一个类，当存在多个 retransform entry 时，如果显式触发 retransform ，则最后添加的 entry 生效(id 最大的)。</p>
</blockquote>
<h2 id="消除-retransform-的影响"><a href="#消除-retransform-的影响" class="headerlink" title="消除 retransform 的影响"></a>消除 retransform 的影响</h2><p>如果对某个类执行 retransform 之后，想消除影响，则需要：</p>
<ul>
<li>删除这个类对应的 retransform entry</li>
<li>重新触发 retransform</li>
</ul>
<div class="note info no-icon"><p>提示</p>
<p>如果不清除掉所有的 retransform entry，并重新触发 retransform ，则 arthas stop 时，retransform 过的类仍然生效。</p>
</div>

<h2 id="结合-jad-mc-命令使用"><a href="#结合-jad-mc-命令使用" class="headerlink" title="结合 jad/mc 命令使用"></a>结合 jad/mc 命令使用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jad --source-only com.example.demo.arthas.user.UserController &gt; /tmp/UserController.java</span><br><span class="line"></span><br><span class="line">mc /tmp/UserController.java -d /tmp</span><br><span class="line"></span><br><span class="line">retransform /tmp/com/example/demo/arthas/user/UserController.class</span><br></pre></td></tr></table></figure>

<ul>
<li>jad 命令反编译，然后可以用其它编译器，比如 vim 来修改源码</li>
<li>mc 命令来内存编译修改过的代码</li>
<li>用 retransform 命令加载新的字节码</li>
</ul>
<h2 id="上传-class-文件到服务器的技巧"><a href="#上传-class-文件到服务器的技巧" class="headerlink" title="上传 .class 文件到服务器的技巧"></a>上传 .class 文件到服务器的技巧</h2><p>使用<code>mc</code>命令来编译<code>jad</code>的反编译的代码有可能失败。可以在本地修改代码，编译好后再上传到服务器上。有的服务器不允许直接上传文件，可以使用<code>base64</code>命令来绕过。</p>
<ol>
<li><p>在本地先转换<code>.class</code>文件为 base64，再保存为 result.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base64 &lt; Test.class &gt; result.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>到服务器上，新建并编辑<code>result.txt</code>，复制本地的内容，粘贴再保存</p>
</li>
<li><p>把服务器上的 <code>result.txt</code>还原为<code>.class</code></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base64 -d &lt; result.txt &gt; Test.class</span><br></pre></td></tr></table></figure>
</li>
<li><p>用 md5 命令计算哈希值，校验是否一致</p>
</li>
</ol>
<h2 id="retransform-的限制"><a href="#retransform-的限制" class="headerlink" title="retransform 的限制"></a>retransform 的限制</h2><ul>
<li>不允许新增加 field/method</li>
<li>正在跑的函数，没有退出不能生效，比如下面新增加的<code>System.out.println</code>，只有<code>run()</code>函数里的会生效</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MathGame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        MathGame game = <span class="keyword">new</span> MathGame();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            game.run();</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">// 这个不生效，因为代码一直跑在 while里</span></span><br><span class="line">            System.out.println(<span class="string">&quot;in loop&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 这个生效，因为run()函数每次都可以完整结束</span></span><br><span class="line">        System.out.println(<span class="string">&quot;call run()&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> number = random.nextInt();</span><br><span class="line">            List&lt;Integer&gt; primeFactors = primeFactors(number);</span><br><span class="line">            print(number, primeFactors);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(String.format(<span class="string">&quot;illegalArgumentCount:%3d, &quot;</span>, illegalArgumentCount) + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Monitor-命令"><a href="#Monitor-命令" class="headerlink" title="Monitor 命令"></a>Monitor 命令</h1><div class="note info no-icon"><p>提示</p>
<p>方法执行监控</p>
</div>

<p>对匹配 <code>class-pattern</code>／<code>method-pattern</code>／<code>condition-express</code>的类、方法的调用进行监控。</p>
<p><code>monitor</code> 命令是一个非实时返回命令.</p>
<p>实时返回命令是输入之后立即返回，而非实时返回的命令，则是不断的等待目标 Java 进程返回信息，直到用户输入 <code>Ctrl+C</code> 为止。</p>
<p>服务端是以任务的形式在后台跑任务，植入的代码随着任务的中止而不会被执行，所以任务关闭后，不会对原有性能产生太大影响，而且原则上，任何 Arthas 命令不会引起原有业务逻辑的改变。</p>
<h2 id="监控的维度说明"><a href="#监控的维度说明" class="headerlink" title="监控的维度说明"></a>监控的维度说明</h2><table>
<thead>
<tr>
<th align="right">监控项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right">timestamp</td>
<td align="left">时间戳</td>
</tr>
<tr>
<td align="right">class</td>
<td align="left">Java 类</td>
</tr>
<tr>
<td align="right">method</td>
<td align="left">方法（构造方法、普通方法）</td>
</tr>
<tr>
<td align="right">total</td>
<td align="left">调用次数</td>
</tr>
<tr>
<td align="right">success</td>
<td align="left">成功次数</td>
</tr>
<tr>
<td align="right">fail</td>
<td align="left">失败次数</td>
</tr>
<tr>
<td align="right">rt</td>
<td align="left">平均 RT</td>
</tr>
<tr>
<td align="right">fail-rate</td>
<td align="left">失败率</td>
</tr>
</tbody></table>
<h2 id="参数说明-7"><a href="#参数说明-7" class="headerlink" title="参数说明"></a>参数说明</h2><p>方法拥有一个命名参数 <code>[c:]</code>，意思是统计周期（cycle of output），拥有一个整型的参数值</p>
<table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>class-pattern</em></td>
<td align="left">类名表达式匹配</td>
</tr>
<tr>
<td align="right"><em>method-pattern</em></td>
<td align="left">方法名表达式匹配</td>
</tr>
<tr>
<td align="right"><em>condition-express</em></td>
<td align="left">条件表达式</td>
</tr>
<tr>
<td align="right">[E]</td>
<td align="left">开启正则表达式匹配，默认为通配符匹配</td>
</tr>
<tr>
<td align="right"><code>[c:]</code></td>
<td align="left">统计周期，默认值为 120 秒</td>
</tr>
<tr>
<td align="right">[b]</td>
<td align="left">在<strong>方法调用之前</strong>计算 condition-express</td>
</tr>
<tr>
<td align="right"><code>[m &lt;arg&gt;]</code></td>
<td align="left">指定 Class 最大匹配数量，默认值为 50。长格式为<code>[maxMatch &lt;arg&gt;]</code>。</td>
</tr>
</tbody></table>
<h2 id="使用参考-11"><a href="#使用参考-11" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ monitor -c 5 demo.MathGame primeFactors</span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 94 ms.</span><br><span class="line"> timestamp            class          method        total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"> 2018-12-03 19:06:38  demo.MathGame  primeFactors  5      1        4     1.15        80.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method        total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"> 2018-12-03 19:06:43  demo.MathGame  primeFactors  5      3        2     42.29       40.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method        total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"> 2018-12-03 19:06:48  demo.MathGame  primeFactors  5      3        2     67.92       40.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method        total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"> 2018-12-03 19:06:53  demo.MathGame  primeFactors  5      2        3     0.25        60.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method        total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"> 2018-12-03 19:06:58  demo.MathGame  primeFactors  1      1        0     0.45        0.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method        total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"> 2018-12-03 19:07:03  demo.MathGame  primeFactors  2      2        0     3182.72     0.00%</span><br></pre></td></tr></table></figure>

<h3 id="指定-Class-最大匹配数量"><a href="#指定-Class-最大匹配数量" class="headerlink" title="指定 Class 最大匹配数量"></a>指定 Class 最大匹配数量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ monitor -c 1 -m 1 demo.MathGame primeFactors</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count:1 , method count:1) cost <span class="keyword">in</span> 384 ms, listenerId: 6.</span><br><span class="line"> timestamp            class          method        total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"> 2022-12-25 21:12:58  demo.MathGame  primeFactors  1      1        0     0.18        0.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method        total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"> 2022-12-25 21:12:59  demo.MathGame  primeFactors  0      0        0     0.00       0.00%</span><br></pre></td></tr></table></figure>

<h3 id="计算条件表达式过滤统计结果-方法执行完毕之后"><a href="#计算条件表达式过滤统计结果-方法执行完毕之后" class="headerlink" title="计算条件表达式过滤统计结果(方法执行完毕之后)"></a>计算条件表达式过滤统计结果(方法执行完毕之后)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">monitor -c 5 demo.MathGame primeFactors <span class="string">&quot;params[0] &lt;= 2&quot;</span></span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 19 ms, listenerId: 5</span><br><span class="line"> timestamp            class          method         total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"> 2020-09-02 09:42:36  demo.MathGame  primeFactors    5       3       2      0.09       40.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method         total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"> 2020-09-02 09:42:41  demo.MathGame  primeFactors    5       2       3      0.11       60.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method         total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"> 2020-09-02 09:42:46  demo.MathGame  primeFactors    5       1       4      0.06       80.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method         total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"> 2020-09-02 09:42:51  demo.MathGame  primeFactors    5       1       4      0.12       80.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method         total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"> 2020-09-02 09:42:56  demo.MathGame  primeFactors    5       3       2      0.15       40.00%</span><br></pre></td></tr></table></figure>

<h3 id="计算条件表达式过滤统计结果-方法执行完毕之前"><a href="#计算条件表达式过滤统计结果-方法执行完毕之前" class="headerlink" title="#计算条件表达式过滤统计结果(方法执行完毕之前)"></a><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/monitor.html#%E8%AE%A1%E7%AE%97%E6%9D%A1%E4%BB%B6%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%BF%87%E6%BB%A4%E7%BB%9F%E8%AE%A1%E7%BB%93%E6%9E%9C-%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95%E4%B9%8B%E5%89%8D">#</a>计算条件表达式过滤统计结果(方法执行完毕之前)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">monitor -b -c 5 com.test.testes.MathGame primeFactors <span class="string">&quot;params[0] &lt;= 2&quot;</span></span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 21 ms, listenerId: 4</span><br><span class="line"> timestamp            class          method         total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"> 2020-09-02 09:41:57  demo.MathGame  primeFactors    1       0        1      0.10      100.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method         total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"> 2020-09-02 09:42:02  demo.MathGame  primeFactors    3       0        3      0.06      100.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method         total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"> 2020-09-02 09:42:07  demo.MathGame  primeFactors    2       0        2      0.06      100.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method         total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"> 2020-09-02 09:42:12  demo.MathGame  primeFactors    1       0        1      0.05      100.00%</span><br><span class="line"></span><br><span class="line"> timestamp            class          method         total  success  fail  avg-rt(ms)  fail-rate</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"> 2020-09-02 09:42:17  demo.MathGame  primeFactors    2       0        2      0.10      100.00%</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="ognl-命令"><a href="#ognl-命令" class="headerlink" title="ognl 命令"></a>ognl 命令</h1><p>在 Arthas 里，有一个单独的 ognl 命令，可以动态执行代码。</p>
<p>查看用法：<code>ognl --help</code></p>
<h2 id="参数说明-8"><a href="#参数说明-8" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>express</em></td>
<td align="left">执行的表达式</td>
</tr>
<tr>
<td align="right"><code>[c:]</code></td>
<td align="left">执行表达式的 ClassLoader 的 hashcode，默认值是 SystemClassLoader</td>
</tr>
<tr>
<td align="right"><code>[classLoaderClass:]</code></td>
<td align="left">指定执行表达式的 ClassLoader 的 class name</td>
</tr>
<tr>
<td align="right">[x]</td>
<td align="left">结果对象的展开层次，默认值 1</td>
</tr>
</tbody></table>
<h2 id="使用参考-12"><a href="#使用参考-12" class="headerlink" title="使用参考"></a>使用参考</h2><ul>
<li>OGNL 特殊用法请参考：<a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/71">https://github.com/alibaba/arthas/issues/71在新窗口打开</a></li>
<li>OGNL 表达式官方指南：<a target="_blank" rel="noopener" href="https://commons.apache.org/proper/commons-ognl/language-guide.html">https://commons.apache.org/proper/commons-ognl/language-guide.html在新窗口打开</a></li>
</ul>
<p>调用静态函数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ognl <span class="string">&#x27;@java.lang.System@out.println(&quot;hello&quot;)&#x27;</span></span><br><span class="line">null</span><br></pre></td></tr></table></figure>

<p>获取静态类的静态字段：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ognl <span class="string">&#x27;@demo.MathGame@random&#x27;</span></span><br><span class="line">@Random[</span><br><span class="line">    serialVersionUID=@Long[3905348978240129619],</span><br><span class="line">    seed=@AtomicLong[125451474443703],</span><br><span class="line">    multiplier=@Long[25214903917],</span><br><span class="line">    addend=@Long[11],</span><br><span class="line">    mask=@Long[281474976710655],</span><br><span class="line">    DOUBLE_UNIT=@Double[1.1102230246251565E-16],</span><br><span class="line">    BadBound=@String[bound must be positive],</span><br><span class="line">    BadRange=@String[bound must be greater than origin],</span><br><span class="line">    BadSize=@String[size must be non-negative],</span><br><span class="line">    seedUniquifier=@AtomicLong[-3282039941672302964],</span><br><span class="line">    nextNextGaussian=@Double[0.0],</span><br><span class="line">    haveNextNextGaussian=@Boolean[<span class="literal">false</span>],</span><br><span class="line">    serialPersistentFields=@ObjectStreamField[][isEmpty=<span class="literal">false</span>;size=3],</span><br><span class="line">    unsafe=@Unsafe[sun.misc.Unsafe@28ea5898],</span><br><span class="line">    seedOffset=@Long[24],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>通过 hashcode 指定 ClassLoader：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ classloader -t</span><br><span class="line">+-BootstrapClassLoader</span><br><span class="line">+-jdk.internal.loader.ClassLoaders<span class="variable">$PlatformClassLoader</span>@301ec38b</span><br><span class="line">  +-com.taobao.arthas.agent.ArthasClassloader@472067c7</span><br><span class="line">  +-jdk.internal.loader.ClassLoaders<span class="variable">$AppClassLoader</span>@4b85612c</span><br><span class="line">    +-org.springframework.boot.loader.LaunchedURLClassLoader@7f9a81e8</span><br><span class="line"></span><br><span class="line">$ ognl -c 7f9a81e8 @org.springframework.boot.SpringApplication@logger</span><br><span class="line">@Slf4jLocationAwareLog[</span><br><span class="line">    FQCN=@String[org.apache.commons.logging.LogAdapter<span class="variable">$Slf4jLocationAwareLog</span>],</span><br><span class="line">    name=@String[org.springframework.boot.SpringApplication],</span><br><span class="line">    logger=@Logger[Logger[org.springframework.boot.SpringApplication]],</span><br><span class="line">]</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

<p>注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，提取对应 ClassLoader 的 hashcode。</p>
<p>对于只有唯一实例的 ClassLoader 可以通过 class name 指定，使用起来更加方便：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader  @org.springframework.boot.SpringApplication@logger</span><br><span class="line">@Slf4jLocationAwareLog[</span><br><span class="line">    FQCN=@String[org.apache.commons.logging.LogAdapter<span class="variable">$Slf4jLocationAwareLog</span>],</span><br><span class="line">    name=@String[org.springframework.boot.SpringApplication],</span><br><span class="line">    logger=@Logger[Logger[org.springframework.boot.SpringApplication]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>执行多行表达式，赋值给临时变量，返回一个 List：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ognl <span class="string">&#x27;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#x27;</span></span><br><span class="line">@ArrayList[</span><br><span class="line">    @String[/opt/java/8.0.181-zulu/jre],</span><br><span class="line">    @String[OpenJDK Runtime Environment],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h1 id="Options-命令"><a href="#Options-命令" class="headerlink" title="Options 命令"></a>Options 命令</h1><blockquote>
<p>全局开关</p>
</blockquote>
<table>
<thead>
<tr>
<th>名称</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>unsafe</td>
<td>false</td>
<td>是否支持对系统级别的类进行增强，打开该开关可能导致把 JVM 搞挂，请慎重选择！</td>
</tr>
<tr>
<td>dump</td>
<td>false</td>
<td>是否支持被增强了的类 dump 到外部文件中，如果打开开关，class 文件会被 dump 到<code>/$&#123;application working dir&#125;/arthas-class-dump/</code> 目录下，具体位置详见控制台输出</td>
</tr>
<tr>
<td>batch-re-transform</td>
<td>true</td>
<td>是否支持批量对匹配到的类执行 retransform 操作</td>
</tr>
<tr>
<td>json-format</td>
<td>false</td>
<td>是否支持 json 化的输出</td>
</tr>
<tr>
<td>disable-sub-class</td>
<td>false</td>
<td>是否禁用子类匹配，默认在匹配目标类的时候会默认匹配到其子类，如果想精确匹配，可以关闭此开关</td>
</tr>
<tr>
<td>support-default-method</td>
<td>true</td>
<td>是否支持匹配到 default method，默认会查找 interface，匹配里面的 default method。参考 <a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/1105">#1105</a></td>
</tr>
<tr>
<td>save-result</td>
<td>false</td>
<td>是否打开执行结果存日志功能，打开之后所有命令的运行结果都将保存到<code>~/logs/arthas-cache/result.log</code> 中</td>
</tr>
<tr>
<td>job-timeout</td>
<td>1d</td>
<td>异步后台任务的默认超时时间，超过这个时间，任务自动停止；比如设置 1d, 2h, 3m, 25s，分别代表天、小时、分、秒</td>
</tr>
<tr>
<td>print-parent-fields</td>
<td>true</td>
<td>是否打印在 parent class 里的 filed</td>
</tr>
</tbody></table>
<h2 id="查看所有的-options"><a href="#查看所有的-options" class="headerlink" title="查看所有的 options"></a>查看所有的 options</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options</span><br></pre></td></tr></table></figure>

<h2 id="获取-option-的值"><a href="#获取-option-的值" class="headerlink" title="获取 option 的值"></a>获取 option 的值</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options json-format</span><br></pre></td></tr></table></figure>

<blockquote>
<p>默认情况下<code>json-format</code> 为 false，如果希望<code>watch</code> /<code>tt</code> 等命令结果以 json 格式输出，则可以设置<code>json-format</code> 为 true。</p>
</blockquote>
<h2 id="设置指定的-option"><a href="#设置指定的-option" class="headerlink" title="设置指定的 option"></a>设置指定的 option</h2><p>例如，想打开执行结果存日志功能首先查看日志，发现无记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;root&#x2F;logs&#x2F;arthas-cache&#x2F;result.log</span><br></pre></td></tr></table></figure>

<p>输入如下命令即可激活记录日志功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options save-result true</span><br></pre></td></tr></table></figure>

<p>稍候片刻，再次查看，发现出现记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;root&#x2F;logs&#x2F;arthas-cache&#x2F;result.log</span><br></pre></td></tr></table></figure>

<h1 id="Perfcounter-命令"><a href="#Perfcounter-命令" class="headerlink" title="Perfcounter 命令"></a>Perfcounter 命令</h1><p>查看当前 JVM 的 Perf Counter 信息</p>
<h2 id="使用参考-13"><a href="#使用参考-13" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ perfcounter</span><br><span class="line"> java.ci.totalTime                            2325637411</span><br><span class="line"> java.cls.loadedClasses                       3403</span><br><span class="line"> java.cls.sharedLoadedClasses                 0</span><br><span class="line"> java.cls.sharedUnloadedClasses               0</span><br><span class="line"> java.cls.unloadedClasses                     0</span><br><span class="line"> java.property.java.version                   11.0.4</span><br><span class="line"> java.property.java.vm.info                   mixed mode</span><br><span class="line"> java.property.java.vm.name                   OpenJDK 64-Bit Server VM</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可以用<code>-d</code>参数打印更多信息：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ perfcounter -d</span><br><span class="line"> Name                                   Variability   Units        Value</span><br><span class="line">---------------------------------------------------------------------------------</span><br><span class="line"> java.ci.totalTime                      Monotonic     Ticks        3242526906</span><br><span class="line"> java.cls.loadedClasses                 Monotonic     Events       3404</span><br><span class="line"> java.cls.sharedLoadedClasses           Monotonic     Events       0</span><br><span class="line"> java.cls.sharedUnloadedClasses         Monotonic     Events       0</span><br><span class="line"> java.cls.unloadedClasses               Monotonic     Events       0</span><br></pre></td></tr></table></figure>

<h2 id="jdk9-以上的应用"><a href="#jdk9-以上的应用" class="headerlink" title="jdk9 以上的应用"></a>jdk9 以上的应用</h2><p>如果没有打印出信息，应用在启动时，加下面的参数：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--add-opens java.base/jdk.internal.perf=ALL-UNNAMED --add-exports java.base/jdk.internal.perf=ALL-UNNAMED --add-opens java.management/sun.management.counter.perf=ALL-UNNAMED --add-opens java.management/sun.management.counter=ALL-UNNAMED</span><br></pre></td></tr></table></figure>

<h1 id="Plaintext-命令"><a href="#Plaintext-命令" class="headerlink" title="Plaintext 命令"></a>Plaintext 命令</h1><p>将输出结果去除 ANSI 颜色</p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jad demo.MathGame main</span><br><span class="line">jad demo.MathGame main | plaintext</span><br></pre></td></tr></table></figure>

<h1 id="Profiler-命令"><a href="#Profiler-命令" class="headerlink" title="Profiler 命令"></a>Profiler 命令</h1><blockquote>
<p>使用<a target="_blank" rel="noopener" href="https://github.com/jvm-profiling-tools/async-profiler">async-profiler</a>生成火焰图</p>
</blockquote>
<p><code>profiler</code> 命令支持生成应用热点的火焰图。本质上是通过不断的采样，然后把收集到的采样结果生成火焰图。</p>
<p><code>profiler</code> 命令基本运行结构是 <code>profiler action [actionArg]</code></p>
<h2 id="参数说明-9"><a href="#参数说明-9" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>action</em></td>
<td align="left">要执行的操作</td>
</tr>
<tr>
<td align="right"><em>actionArg</em></td>
<td align="left">属性名模式</td>
</tr>
<tr>
<td align="right">[i:]</td>
<td align="left">采样间隔（单位：ns）（默认值：10’000’000，即 10 ms）</td>
</tr>
<tr>
<td align="right">[f:]</td>
<td align="left">将输出转储到指定路径</td>
</tr>
<tr>
<td align="right">[d:]</td>
<td align="left">运行评测指定秒</td>
</tr>
<tr>
<td align="right">[e:]</td>
<td align="left">要跟踪哪个事件（cpu, alloc, lock, cache-misses 等），默认是 cpu</td>
</tr>
</tbody></table>
<h2 id="启动-profiler"><a href="#启动-profiler" class="headerlink" title="启动 profiler"></a>启动 profiler</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ profiler start</span><br><span class="line">Started [cpu] profiling</span><br></pre></td></tr></table></figure>

<p>提示</p>
<p>默认情况下，生成的是 cpu 的火焰图，即 event 为<code>cpu</code>。可以用<code>--event</code>参数来指定。</p>
<h2 id="获取已采集的-sample-的数量"><a href="#获取已采集的-sample-的数量" class="headerlink" title="获取已采集的 sample 的数量"></a>获取已采集的 sample 的数量</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ profiler getSamples</span><br><span class="line">23</span><br></pre></td></tr></table></figure>

<h2 id="查看-profiler-状态"><a href="#查看-profiler-状态" class="headerlink" title="查看 profiler 状态"></a>查看 profiler 状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ profiler status</span><br><span class="line">[cpu] profiling is running <span class="keyword">for</span> 4 seconds</span><br></pre></td></tr></table></figure>

<p>可以查看当前 profiler 在采样哪种<code>event</code>和采样时间。</p>
<h2 id="停止-profiler"><a href="#停止-profiler" class="headerlink" title="停止 profiler"></a>停止 profiler</h2><h3 id="生成-html-格式结果"><a href="#生成-html-格式结果" class="headerlink" title="生成 html 格式结果"></a>生成 html 格式结果</h3><p>默认情况下，结果文件是<code>html</code>格式，也可以用<code>--format</code>参数指定：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ profiler stop --format html</span><br><span class="line">profiler output file: /tmp/<span class="built_in">test</span>/arthas-output/20211207-111550.html</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>或者在<code>--file</code>参数里用文件名指名格式。比如<code>--file /tmp/result.html</code> 。</p>
<h2 id="通过浏览器查看-arthas-output-下面的-profiler-结果"><a href="#通过浏览器查看-arthas-output-下面的-profiler-结果" class="headerlink" title="通过浏览器查看 arthas-output 下面的 profiler 结果"></a>通过浏览器查看 arthas-output 下面的 profiler 结果</h2><p>默认情况下，arthas 使用 3658 端口，则可以打开： <a target="_blank" rel="noopener" href="http://localhost:3658/arthas-output/">http://localhost:3658/arthas-output/在新窗口打开</a> 查看到<code>arthas-output</code>目录下面的 profiler 结果：</p>
<p><img src="https://arthas.aliyun.com/images/arthas-output.jpg" alt="img"></p>
<p>点击可以查看具体的结果：</p>
<p><img src="https://arthas.aliyun.com/images/arthas-output-svg.jpg" alt="img"></p>
<p>提示</p>
<p>如果是 chrome 浏览器，可能需要多次刷新。</p>
<h2 id="profiler-支持的-events"><a href="#profiler-支持的-events" class="headerlink" title="profiler 支持的 events"></a>profiler 支持的 events</h2><p>在不同的平台，不同的 OS 下面，支持的 events 各有不同。比如在 macos 下面：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ profiler list</span><br><span class="line">Basic events:</span><br><span class="line">  cpu</span><br><span class="line">  alloc</span><br><span class="line">  lock</span><br><span class="line">  wall</span><br><span class="line">  itimer</span><br></pre></td></tr></table></figure>

<p>在 linux 下面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ profiler list</span><br><span class="line">Basic events:</span><br><span class="line">  cpu</span><br><span class="line">  alloc</span><br><span class="line">  lock</span><br><span class="line">  wall</span><br><span class="line">  itimer</span><br><span class="line">Perf events:</span><br><span class="line">  page-faults</span><br><span class="line">  context-switches</span><br><span class="line">  cycles</span><br><span class="line">  instructions</span><br><span class="line">  cache-references</span><br><span class="line">  cache-misses</span><br><span class="line">  branches</span><br><span class="line">  branch-misses</span><br><span class="line">  bus-cycles</span><br><span class="line">  L1-dcache-load-misses</span><br><span class="line">  LLC-load-misses</span><br><span class="line">  dTLB-load-misses</span><br><span class="line">  mem:breakpoint</span><br><span class="line">  trace:tracepoint</span><br></pre></td></tr></table></figure>

<p>如果遇到 OS 本身的权限/配置问题，然后  缺少部分 event，可以参考<code>async-profiler</code>本身文档：<a target="_blank" rel="noopener" href="https://github.com/jvm-profiling-tools/async-profiler">async-profiler在新窗口打开</a></p>
<p>可以用<code>--event</code>参数指定要采样的事件，比如对<code>alloc</code>事件进入采样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ profiler start --event alloc</span><br></pre></td></tr></table></figure>

<h2 id="恢复采样"><a href="#恢复采样" class="headerlink" title="恢复采样"></a>恢复采样</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ profiler resume</span><br><span class="line">Started [cpu] profiling</span><br></pre></td></tr></table></figure>

<p><code>start</code>和<code>resume</code>的区别是：<code>start</code>是新开始采样，<code>resume</code>会保留上次<code>stop</code>时的数据。</p>
<p>通过执行<code>profiler getSamples</code>可以查看 samples 的数量来验证。</p>
<h2 id="使用execute来执行复杂的命令"><a href="#使用execute来执行复杂的命令" class="headerlink" title="使用execute来执行复杂的命令"></a>使用<code>execute</code>来执行复杂的命令</h2><p>比如开始采样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">profiler execute <span class="string">&#x27;start,framebuf=5000000&#x27;</span></span><br></pre></td></tr></table></figure>

<p>停止采样，并保存到指定文件里：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">profiler execute <span class="string">&#x27;stop,file=/tmp/result.html&#x27;</span></span><br></pre></td></tr></table></figure>

<p>具体的格式参考： <a target="_blank" rel="noopener" href="https://github.com/jvm-profiling-tools/async-profiler/blob/v2.5/src/arguments.cpp#L50">arguments.cpp在新窗口打开</a></p>
<h2 id="查看所有支持的-action"><a href="#查看所有支持的-action" class="headerlink" title="查看所有支持的 action"></a>查看所有支持的 action</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ profiler actions</span><br><span class="line">Supported Actions: [resume, dumpCollapsed, getSamples, start, list, execute, version, stop, load, dumpFlat, actions, dumpTraces, status]</span><br></pre></td></tr></table></figure>

<h2 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ profiler version</span><br><span class="line">Async-profiler 1.6 built on Sep  9 2019</span><br><span class="line">Copyright 2019 Andrei Pangin</span><br></pre></td></tr></table></figure>

<h2 id="配置-framebuf-参数"><a href="#配置-framebuf-参数" class="headerlink" title="配置 framebuf 参数"></a>配置 framebuf 参数</h2><blockquote>
<p>如果遇到生成的火焰图有 <code>[frame_buffer_overflow]</code>，则需要增大 framebuf（默认值是 1’000’000），可以显式配置，比如：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">profiler start --framebuf 5000000</span><br></pre></td></tr></table></figure>

<h2 id="配置-include-exclude-来过滤数据"><a href="#配置-include-exclude-来过滤数据" class="headerlink" title="配置 include/exclude 来过滤数据"></a>配置 include/exclude 来过滤数据</h2><p>如果应用比较复杂，生成的内容很多，想只关注部分数据，可以通过 include/exclude 来过滤。比如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">profiler start --include <span class="string">&#x27;java/*&#x27;</span> --include <span class="string">&#x27;demo/*&#x27;</span> --exclude <span class="string">&#x27;*Unsafe.park*&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>include/exclude 都支持设置多个值 ，但是需要配置在命令行的最后。</p>
</blockquote>
<h2 id="指定执行时间"><a href="#指定执行时间" class="headerlink" title="指定执行时间"></a>指定执行时间</h2><p>比如，希望 profiler 执行 300 秒自动结束，可以用 <code>-d</code>/<code>--duration</code> 参数指定：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">profiler start --duration 300</span><br></pre></td></tr></table></figure>

<h2 id="生成-jfr-格式结果"><a href="#生成-jfr-格式结果" class="headerlink" title="生成 jfr 格式结果"></a>生成 jfr 格式结果</h2><blockquote>
<p>注意，jfr 只支持在 <code>start</code>时配置。如果是在<code>stop</code>时指定，则不会生效。</p>
</blockquote>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">profiler start --file /tmp/test.jfr</span><br></pre></td></tr></table></figure>

<p><code>file</code>参数支持一些变量：</p>
<ul>
<li>时间戳： <code>--file /tmp/test-%t.jfr</code></li>
<li>进程 ID： <code>--file /tmp/test-%p.jfr</code></li>
</ul>
<p>生成的结果可以用支持 jfr 格式的工具来查看。比如：</p>
<ul>
<li>JDK Mission Control ： <a target="_blank" rel="noopener" href="https://github.com/openjdk/jmc">https://github.com/openjdk/jmc</a></li>
<li>JProfiler ： <a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/1416">https://github.com/alibaba/arthas/issues/1416</a></li>
</ul>
<h2 id="生成的火焰图里的-unknown"><a href="#生成的火焰图里的-unknown" class="headerlink" title="生成的火焰图里的 unknown"></a>生成的火焰图里的 unknown</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/jvm-profiling-tools/async-profiler/discussions/409">https://github.com/jvm-profiling-tools/async-profiler/discussions/409</a></li>
</ul>
<hr>
<h1 id="Pwd-命令"><a href="#Pwd-命令" class="headerlink" title="Pwd 命令"></a>Pwd 命令</h1><p>通过 pwd 命令可以获知当前的工作目录，和 linux 命令类似</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwd</span><br></pre></td></tr></table></figure>

<h1 id="Quit-stop-命令"><a href="#Quit-stop-命令" class="headerlink" title="Quit-stop 命令"></a>Quit-stop 命令</h1><h2 id="退出-Arthas"><a href="#退出-Arthas" class="headerlink" title="退出 Arthas"></a>退出 Arthas</h2><p>用 <code>exit</code> 或者 <code>quit</code> 命令可以退出 Arthas。</p>
<p>退出 Arthas 之后，还可以再次用 <code>java -jar arthas-boot.jar</code> 来连接。</p>
<h2 id="彻底退出-Arthas"><a href="#彻底退出-Arthas" class="headerlink" title="彻底退出 Arthas"></a>彻底退出 Arthas</h2><p>exit/quit 命令 只是退出当前 session，arthas server 还在目标进程中运行。</p>
<p>想完全退出 Arthas，可以执行 <code>stop</code> 命令。</p>
<hr>
<h1 id="Reset-命令"><a href="#Reset-命令" class="headerlink" title="Reset 命令"></a>Reset 命令</h1><div class="note info no-icon"><p>提示</p>
<p>重置增强类，将被 Arthas 增强过的类全部还原，Arthas 服务端<code>stop</code>时会重置所有增强过的类</p>
</div>

<h2 id="使用参考-14"><a href="#使用参考-14" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ reset -h</span><br><span class="line"> USAGE:</span><br><span class="line">   reset [-h] [-E] [class-pattern]</span><br><span class="line"></span><br><span class="line"> SUMMARY:</span><br><span class="line">   Reset all the enhanced classes</span><br><span class="line"></span><br><span class="line"> EXAMPLES:</span><br><span class="line">   reset</span><br><span class="line">   reset *List</span><br><span class="line">   reset -E .*List</span><br><span class="line"></span><br><span class="line"> OPTIONS:</span><br><span class="line"> -h, --help                                                         this help</span><br><span class="line"> -E, --regex                                                        Enable regular expression to match (wildcard matching by default)</span><br><span class="line"> &lt;class-pattern&gt;                                                    Path and classname of Pattern Matching</span><br></pre></td></tr></table></figure>

<h2 id="还原指定类"><a href="#还原指定类" class="headerlink" title="还原指定类"></a>还原指定类</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ trace Test test</span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost in 57 ms.</span><br><span class="line">`---ts=2017-10-26 17:10:33;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=sun.misc.Launcher$AppClassLoader@14dad5dc</span><br><span class="line">    `---[0.590102ms] Test:test()</span><br><span class="line"></span><br><span class="line">`---ts=2017-10-26 17:10:34;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=sun.misc.Launcher$AppClassLoader@14dad5dc</span><br><span class="line">    `---[0.068692ms] Test:test()</span><br><span class="line"></span><br><span class="line">$ reset Test</span><br><span class="line">Affect(class-cnt:1 , method-cnt:0) cost in 11 ms.</span><br></pre></td></tr></table></figure>

<h2 id="还原所有类"><a href="#还原所有类" class="headerlink" title="还原所有类"></a>还原所有类</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ trace Test test</span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost in 15 ms.</span><br><span class="line">`---ts=2017-10-26 17:12:06;thread_name=main;id=1;is_daemon=false;priority=5;TCCL=sun.misc.Launcher$AppClassLoader@14dad5dc</span><br><span class="line">    `---[0.128518ms] Test:test()</span><br><span class="line"></span><br><span class="line">$ reset</span><br><span class="line">Affect(class-cnt:1 , method-cnt:0) cost in 9 ms.</span><br></pre></td></tr></table></figure>

<h1 id="Sc-命令"><a href="#Sc-命令" class="headerlink" title="Sc 命令"></a>Sc 命令</h1><blockquote>
<p>查看 JVM 已加载的类信息</p>
</blockquote>
<p>“Search-Class”的简写，这个命令能搜索出所有已经加载到 JVM 中的 Class 信息，这个命令支持的参数有 <code>[d]</code> 、<code>[E]</code> 、<code>[f]</code> 和 <code>[x:]</code> 。</p>
<h2 id="参数说明-10"><a href="#参数说明-10" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th>参数名称</th>
<th>参数说明</th>
</tr>
</thead>
<tbody><tr>
<td><em>class-pattern</em></td>
<td>类名表达式匹配</td>
</tr>
<tr>
<td><em>method-pattern</em></td>
<td>方法名表达式匹配</td>
</tr>
<tr>
<td>[d]</td>
<td>输出当前类的详细信息，包括这个类所加载的原始文件来源、类的声明、加载的 ClassLoader 等详细信息。 如果一个类被多个 ClassLoader 所加载，则会出现多次</td>
</tr>
<tr>
<td>[E]</td>
<td>开启正则表达式匹配，默认为通配符匹配</td>
</tr>
<tr>
<td>[f]</td>
<td>输出当前类的成员变量信息（需要配合参数-d 一起使用）</td>
</tr>
<tr>
<td>[x:]</td>
<td>指定输出静态变量时属性的遍历深度，默认为 0，即直接使用 <code>toString</code> 输出</td>
</tr>
<tr>
<td><code>[c:]</code></td>
<td>指定 class 的 ClassLoader 的 hashcode</td>
</tr>
<tr>
<td><code>[classLoaderClass:]</code></td>
<td>指定执行表达式的 ClassLoader 的 class name</td>
</tr>
<tr>
<td><code>[n:]</code></td>
<td>具有详细信息的匹配类的最大数量（默认为 100）</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/sc.html">sc 命令文档</a></p>
<blockquote>
<p>class-pattern 支持全限定名，如 com.taobao.test.AAA，也支持 com/taobao/test/AAA 这样的格式，这样，我们从异常堆栈里面把类名拷贝过来的时候，不需要在手动把<code>/</code> 替换为<code>.</code> 啦。</p>
</blockquote>
<blockquote>
<p>sc 默认开启了子类匹配功能，也就是说所有当前类的子类也会被搜索出来，想要精确的匹配，请打开<code>options disable-sub-class true</code> 开关</p>
</blockquote>
<h2 id="使用参考-15"><a href="#使用参考-15" class="headerlink" title="使用参考"></a>使用参考</h2><ul>
<li>模糊搜索 <code>sc demo.*</code></li>
<li>打印类的详细信息 <code>sc -d demo.MathGame</code></li>
</ul>
<h2 id="指定-classLoader"><a href="#指定-classLoader" class="headerlink" title="指定 classLoader"></a>指定 classLoader</h2><p>注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，提取对应 ClassLoader 的 hashcode。<br>如果你使用<code>-c</code> ，你需要手动输入 hashcode：<code>-c &lt;hashcode&gt;</code><br>对于只有唯一实例的 ClassLoader 可以通过<code>--classLoaderClass</code> 指定 class name，使用起来更加方便：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc --classLoaderClass jdk.internal.loader.ClassLoaders$AppClassLoader -d demo*</span><br></pre></td></tr></table></figure>

<ul>
<li>注：这里 classLoaderClass 在 java 8 是 sun.misc.Launcher$AppClassLoader，而 java 11 的 classloader 是 jdk.internal.loader.ClassLoaders$AppClassLoader，killercoda 目前环境是 java11。</li>
</ul>
<p><code>--classLoaderClass</code> 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code> 是动态变化的。</p>
<ul>
<li>打印出类的 Field 信息 <code>sc -d -f demo.MathGame</code></li>
</ul>
<hr>
<h1 id="session-命令"><a href="#session-命令" class="headerlink" title="session 命令"></a>session 命令</h1><p>查看当前会话的信息，显示当前绑定的 pid 以及会话 id。</p>
<blockquote>
<p>提示</p>
<p>如果配置了 tunnel server，会追加打印 代理 id、tunnel 服务器的 url 以及连接状态。</p>
<p>如果使用了 staturl 做统计，会追加显示 statUrl 地址。</p>
</blockquote>
<h2 id="使用参考-16"><a href="#使用参考-16" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ session</span><br><span class="line">  Name        Value</span><br><span class="line">--------------------------------------------------</span><br><span class="line"> JAVA_PID    14584</span><br><span class="line"> SESSION_ID  c2073d3b-443a-4a9b-9249-0c5d24a5756c</span><br></pre></td></tr></table></figure>

<h1 id="Sm-命令"><a href="#Sm-命令" class="headerlink" title="Sm 命令"></a>Sm 命令</h1><blockquote>
<p>提示</p>
<p>查看已加载类的方法信息</p>
</blockquote>
<p>“Search-Method” 的简写，这个命令能搜索出所有已经加载了 Class 信息的方法信息。</p>
<p><code>sm</code> 命令只能看到由当前类所声明 (declaring) 的方法，父类则无法看到。</p>
<h2 id="参数说明-11"><a href="#参数说明-11" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>class-pattern</em></td>
<td align="left">类名表达式匹配</td>
</tr>
<tr>
<td align="right"><em>method-pattern</em></td>
<td align="left">方法名表达式匹配</td>
</tr>
<tr>
<td align="right">[d]</td>
<td align="left">展示每个方法的详细信息</td>
</tr>
<tr>
<td align="right">[E]</td>
<td align="left">开启正则表达式匹配，默认为通配符匹配</td>
</tr>
<tr>
<td align="right"><code>[c:]</code></td>
<td align="left">指定 class 的 ClassLoader 的 hashcode</td>
</tr>
<tr>
<td align="right"><code>[classLoaderClass:]</code></td>
<td align="left">指定执行表达式的 ClassLoader 的 class name</td>
</tr>
<tr>
<td align="right"><code>[n:]</code></td>
<td align="left">具有详细信息的匹配类的最大数量（默认为 100）</td>
</tr>
</tbody></table>
<h2 id="使用参考-17"><a href="#使用参考-17" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ sm java.lang.String</span><br><span class="line">java.lang.String-&gt;&lt;init&gt;</span><br><span class="line">java.lang.String-&gt;equals</span><br><span class="line">java.lang.String-&gt;toString</span><br><span class="line">java.lang.String-&gt;hashCode</span><br><span class="line">java.lang.String-&gt;compareTo</span><br><span class="line">java.lang.String-&gt;indexOf</span><br><span class="line">java.lang.String-&gt;valueOf</span><br><span class="line">java.lang.String-&gt;checkBounds</span><br><span class="line">java.lang.String-&gt;length</span><br><span class="line">java.lang.String-&gt;isEmpty</span><br><span class="line">java.lang.String-&gt;charAt</span><br><span class="line">java.lang.String-&gt;codePointAt</span><br><span class="line">java.lang.String-&gt;codePointBefore</span><br><span class="line">java.lang.String-&gt;codePointCount</span><br><span class="line">java.lang.String-&gt;offsetByCodePoints</span><br><span class="line">java.lang.String-&gt;getChars</span><br><span class="line">java.lang.String-&gt;getBytes</span><br><span class="line">java.lang.String-&gt;contentEquals</span><br><span class="line">java.lang.String-&gt;nonSyncContentEquals</span><br><span class="line">java.lang.String-&gt;equalsIgnoreCase</span><br><span class="line">java.lang.String-&gt;compareToIgnoreCase</span><br><span class="line">java.lang.String-&gt;regionMatches</span><br><span class="line">java.lang.String-&gt;startsWith</span><br><span class="line">java.lang.String-&gt;endsWith</span><br><span class="line">java.lang.String-&gt;indexOfSupplementary</span><br><span class="line">java.lang.String-&gt;lastIndexOf</span><br><span class="line">java.lang.String-&gt;lastIndexOfSupplementary</span><br><span class="line">java.lang.String-&gt;substring</span><br><span class="line">java.lang.String-&gt;subSequence</span><br><span class="line">java.lang.String-&gt;concat</span><br><span class="line">java.lang.String-&gt;replace</span><br><span class="line">java.lang.String-&gt;matches</span><br><span class="line">java.lang.String-&gt;contains</span><br><span class="line">java.lang.String-&gt;replaceFirst</span><br><span class="line">java.lang.String-&gt;replaceAll</span><br><span class="line">java.lang.String-&gt;split</span><br><span class="line">java.lang.String-&gt;join</span><br><span class="line">java.lang.String-&gt;toLowerCase</span><br><span class="line">java.lang.String-&gt;toUpperCase</span><br><span class="line">java.lang.String-&gt;trim</span><br><span class="line">java.lang.String-&gt;toCharArray</span><br><span class="line">java.lang.String-&gt;format</span><br><span class="line">java.lang.String-&gt;copyValueOf</span><br><span class="line">java.lang.String-&gt;intern</span><br><span class="line">Affect(row-cnt:44) cost <span class="keyword">in</span> 1342 ms.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sm -d java.lang.String toString</span><br><span class="line"> declaring-class  java.lang.String</span><br><span class="line"> method-name      toString</span><br><span class="line"> modifier         public</span><br><span class="line"> annotation</span><br><span class="line"> parameters</span><br><span class="line"> <span class="built_in">return</span>           java.lang.String</span><br><span class="line"> exceptions</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 3 ms.</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Stack-命令"><a href="#Stack-命令" class="headerlink" title="Stack 命令"></a>Stack 命令</h1><div class="note info no-icon"><p>提示</p>
<p>输出当前方法被调用的调用路径</p>
</div>

<p>很多时候我们都知道一个方法被执行，但这个方法被执行的路径非常多，或者你根本就不知道这个方法是从那里被执行了，此时你需要的是 stack 命令。</p>
<h2 id="参数说明-12"><a href="#参数说明-12" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>class-pattern</em></td>
<td align="left">类名表达式匹配</td>
</tr>
<tr>
<td align="right"><em>method-pattern</em></td>
<td align="left">方法名表达式匹配</td>
</tr>
<tr>
<td align="right"><em>condition-express</em></td>
<td align="left">条件表达式</td>
</tr>
<tr>
<td align="right">[E]</td>
<td align="left">开启正则表达式匹配，默认为通配符匹配</td>
</tr>
<tr>
<td align="right"><code>[n:]</code></td>
<td align="left">执行次数限制</td>
</tr>
<tr>
<td align="right"><code>[m &lt;arg&gt;]</code></td>
<td align="left">指定 Class 最大匹配数量，默认值为 50。长格式为<code>[maxMatch &lt;arg&gt;]</code>。</td>
</tr>
</tbody></table>
<p>这里重点要说明的是观察表达式，观察表达式的构成主要由 ognl 表达式组成，所以你可以这样写<code>&quot;&#123;params,returnObj&#125;&quot;</code>，只要是一个合法的 ognl 表达式，都能被正常支持。</p>
<p>观察的维度也比较多，主要体现在参数 <code>advice</code> 的数据结构上。<code>Advice</code> 参数最主要是封装了通知节点的所有信息。</p>
<p>请参考<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/advice-class.html">表达式核心变量</a>中关于该节点的描述。</p>
<ul>
<li>特殊用法请参考：<a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/71">https://github.com/alibaba/arthas/issues/71在新窗口打开</a></li>
<li>OGNL 表达式官网：<a target="_blank" rel="noopener" href="https://commons.apache.org/proper/commons-ognl/language-guide.html">https://commons.apache.org/proper/commons-ognl/language-guide.html在新窗口打开</a></li>
</ul>
<h2 id="使用例子"><a href="#使用例子" class="headerlink" title="使用例子"></a>使用例子</h2><h3 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ stack demo.MathGame primeFactors</span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 36 ms.</span><br><span class="line">ts=2018-12-04 01:32:19;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    @demo.MathGame.run()</span><br><span class="line">        at demo.MathGame.main(MathGame.java:16)</span><br></pre></td></tr></table></figure>

<h3 id="指定-Class-最大匹配数量-1"><a href="#指定-Class-最大匹配数量-1" class="headerlink" title="指定 Class 最大匹配数量"></a>指定 Class 最大匹配数量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ stack demo.MathGame primeFactors -m 1</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count:1 , method count:1) cost <span class="keyword">in</span> 561 ms, listenerId: 5.</span><br><span class="line">ts=2022-12-25 21:07:07;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@b4aac2</span><br><span class="line">    @demo.MathGame.primeFactors()</span><br><span class="line">        at demo.MathGame.run(MathGame.java:46)</span><br><span class="line">        at demo.MathGame.main(MathGame.java:38)</span><br></pre></td></tr></table></figure>

<h3 id="据条件表达式来过滤"><a href="#据条件表达式来过滤" class="headerlink" title="据条件表达式来过滤"></a>据条件表达式来过滤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ stack demo.MathGame primeFactors <span class="string">&#x27;params[0]&lt;0&#x27;</span> -n 2</span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 30 ms.</span><br><span class="line">ts=2018-12-04 01:34:27;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    @demo.MathGame.run()</span><br><span class="line">        at demo.MathGame.main(MathGame.java:16)</span><br><span class="line"></span><br><span class="line">ts=2018-12-04 01:34:30;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    @demo.MathGame.run()</span><br><span class="line">        at demo.MathGame.main(MathGame.java:16)</span><br><span class="line"></span><br><span class="line">Command execution <span class="built_in">times</span> exceed <span class="built_in">limit</span>: 2, so <span class="built_in">command</span> will <span class="built_in">exit</span>. You can <span class="built_in">set</span> it with -n option.</span><br></pre></td></tr></table></figure>

<h3 id="据执行时间来过滤"><a href="#据执行时间来过滤" class="headerlink" title="据执行时间来过滤"></a>据执行时间来过滤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ stack demo.MathGame primeFactors <span class="string">&#x27;#cost&gt;5&#x27;</span></span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 35 ms.</span><br><span class="line">ts=2018-12-04 01:35:58;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    @demo.MathGame.run()</span><br><span class="line">        at demo.MathGame.main(MathGame.java:16)</span><br></pre></td></tr></table></figure>

<h1 id="Sysenv-命令"><a href="#Sysenv-命令" class="headerlink" title="Sysenv 命令"></a>Sysenv 命令</h1><div class="note info no-icon"><p>提示</p>
<p>查看当前 JVM 的环境属性( System Environment Variables )</p>
</div>

<h2 id="使用参考-18"><a href="#使用参考-18" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">USAGE:</span><br><span class="line">  sysenv [-h] [env-name]</span><br><span class="line"></span><br><span class="line">SUMMARY:</span><br><span class="line">  Display the system env.</span><br><span class="line"></span><br><span class="line">EXAMPLES:</span><br><span class="line">  sysenv</span><br><span class="line">  sysenv USER</span><br><span class="line"></span><br><span class="line">WIKI:</span><br><span class="line">  https://arthas.aliyun.com/doc/sysenv</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">-h, --help                                                 this help</span><br><span class="line">&lt;env-name&gt;                                                 env name</span><br></pre></td></tr></table></figure>

<h3 id="查看所有环境变量"><a href="#查看所有环境变量" class="headerlink" title="查看所有环境变量"></a>查看所有环境变量</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ sysenv</span><br><span class="line"> KEY                      VALUE</span><br><span class="line">----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> PATH                     /Users/admin/.sdkman/candidates/visualvm/current/bin:/Users/admin/.sdkman/candidates/ja</span><br><span class="line">                          va/current/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Applications/Wireshark.app/Contents/</span><br><span class="line">                          MacOS</span><br><span class="line"> SDKMAN_VERSION           5.7.3+337</span><br><span class="line"> JAVA_HOME                /Users/admin/.sdkman/candidates/java/current</span><br><span class="line"> JAVA_MAIN_CLASS_65244    demo.MathGame</span><br><span class="line"> TERM                     xterm-256color</span><br><span class="line"> LANG                     zh_CN.UTF-8</span><br><span class="line"> AUTOJUMP_SOURCED         1</span><br><span class="line"> COLORTERM                truecolor</span><br><span class="line"> LOGNAME                  admin</span><br><span class="line"> XPC_SERVICE_NAME         0</span><br><span class="line"> PWD                      /Users/admin/code/ali/arthas/demo</span><br><span class="line"> TERM_PROGRAM_VERSION     3.2.5</span><br><span class="line"> _                        /Users/admin/.sdkman/candidates/java/current/bin/java</span><br><span class="line"> SHELL                    /bin/bash</span><br><span class="line"> TERM_PROGRAM             iTerm.app</span><br><span class="line"> SDKMAN_PLATFORM          Darwin</span><br><span class="line"> USER                     admin</span><br><span class="line"> ITERM_PROFILE            Default</span><br><span class="line"> TMPDIR                   /var/folders/0r/k561bkk917gg972stqclbz9h0000gn/T/</span><br><span class="line"> XPC_FLAGS                0x0</span><br><span class="line"> TERM_SESSION_ID          w0t4p0:60BC264D-9649-42AC-A7E4-AF85B69F93F8</span><br><span class="line"> __CF_USER_TEXT_ENCODING  0x1F5:0x19:0x34</span><br><span class="line"> Apple_PubSub_Socket_Ren  /private/tmp/com.apple.launchd.DwmmjSQsll/Render</span><br><span class="line"> der</span><br><span class="line"> COLORFGBG                7;0</span><br><span class="line"> HOME                     /Users/admin</span><br><span class="line"> SHLVL                    1</span><br><span class="line"> AUTOJUMP_ERROR_PATH      /Users/admin/Library/autojump/errors.log</span><br></pre></td></tr></table></figure>

<h3 id="查看单个环境变量"><a href="#查看单个环境变量" class="headerlink" title="查看单个环境变量"></a>查看单个环境变量</h3><blockquote>
<p>提示</p>
<p>支持通过<code>TAB</code>键自动补全</p>
</blockquote>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sysenv USER</span><br><span class="line">USER=admin</span><br></pre></td></tr></table></figure>

<h1 id="sysprop-命令"><a href="#sysprop-命令" class="headerlink" title="sysprop 命令"></a>sysprop 命令</h1><div class="note info no-icon"><p>提示</p>
<p>查看当前 JVM 的系统属性( System Property )</p>
</div>

<h2 id="使用参考-19"><a href="#使用参考-19" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">USAGE:</span><br><span class="line">  sysprop [-h] [property-name] [property-value]</span><br><span class="line"></span><br><span class="line">SUMMARY:</span><br><span class="line">  Display, and change all the system properties.</span><br><span class="line"></span><br><span class="line">EXAMPLES:</span><br><span class="line">sysprop</span><br><span class="line">sysprop file.encoding</span><br><span class="line">sysprop production.mode true</span><br><span class="line"></span><br><span class="line">WIKI:</span><br><span class="line">  https://arthas.aliyun.com/doc/sysprop</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">-h, --help                                  this help</span><br><span class="line">&lt;property-name&gt;                             property name</span><br><span class="line">&lt;property-value&gt;                            property value</span><br></pre></td></tr></table></figure>

<h3 id="查看所有属性"><a href="#查看所有属性" class="headerlink" title="查看所有属性"></a>查看所有属性</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">$ sysprop</span><br><span class="line"> KEY                                                  VALUE</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> java.runtime.name                                    Java(TM) SE Runtime Environment</span><br><span class="line"> sun.boot.library.path                                /Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/lib</span><br><span class="line"> java.vm.version                                      25.51-b03</span><br><span class="line"> user.country.format                                  CN</span><br><span class="line"> gopherProxySet                                       false</span><br><span class="line"> java.vm.vendor                                       Oracle Corporation</span><br><span class="line"> java.vendor.url                                      http://java.oracle.com/</span><br><span class="line"> path.separator                                       :</span><br><span class="line"> java.vm.name                                         Java HotSpot(TM) 64-Bit Server VM</span><br><span class="line"> file.encoding.pkg                                    sun.io</span><br><span class="line"> user.country                                         US</span><br><span class="line"> sun.java.launcher                                    SUN_STANDARD</span><br><span class="line"> sun.os.patch.level                                   unknown</span><br><span class="line"> java.vm.specification.name                           Java Virtual Machine Specification</span><br><span class="line"> user.dir                                             /private/var/tmp</span><br><span class="line"> java.runtime.version                                 1.8.0_51-b16</span><br><span class="line"> java.awt.graphicsenv                                 sun.awt.CGraphicsEnvironment</span><br><span class="line"> java.endorsed.dirs                                   /Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/lib/endors</span><br><span class="line">                                                      ed</span><br><span class="line"> os.arch                                              x86_64</span><br><span class="line"> java.io.tmpdir                                       /var/folders/2c/tbxwzs4s4sbcvh7frbcc7n000000gn/T/</span><br><span class="line"> line.separator</span><br><span class="line"></span><br><span class="line"> java.vm.specification.vendor                         Oracle Corporation</span><br><span class="line"> os.name                                              Mac OS X</span><br><span class="line"> sun.jnu.encoding                                     UTF-8</span><br><span class="line"> java.library.path                                    /Users/wangtao/Library/Java/Extensions:/Library/Java/Extensions:/Network/Libra</span><br><span class="line">                                                      ry/Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java:.</span><br><span class="line"> sun.nio.ch.bugLevel</span><br><span class="line"> java.specification.name                              Java Platform API Specification</span><br><span class="line"> java.class.version                                   52.0</span><br><span class="line"> sun.management.compiler                              HotSpot 64-Bit Tiered Compilers</span><br><span class="line"> os.version                                           10.12.6</span><br><span class="line"> user.home                                            /Users/wangtao</span><br><span class="line"> user.timezone                                        Asia/Shanghai</span><br><span class="line"> java.awt.printerjob                                  sun.lwawt.macosx.CPrinterJob</span><br><span class="line"> file.encoding                                        UTF-8</span><br><span class="line"> java.specification.version                           1.8</span><br><span class="line"> user.name                                            wangtao</span><br><span class="line"> java.class.path                                      .</span><br><span class="line"> java.vm.specification.version                        1.8</span><br><span class="line"> sun.arch.data.model                                  64</span><br><span class="line"> java.home                                            /Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre</span><br><span class="line"> sun.java.command                                     Test</span><br><span class="line"> java.specification.vendor                            Oracle Corporation</span><br><span class="line"> user.language                                        en</span><br><span class="line"> awt.toolkit                                          sun.lwawt.macosx.LWCToolkit</span><br><span class="line"> java.vm.info                                         mixed mode</span><br><span class="line"> java.version                                         1.8.0_51</span><br><span class="line"> java.ext.dirs                                        /Users/wangtao/Library/Java/Extensions:/Library/Java/JavaVirtualMachines/jdk1.</span><br><span class="line">                                                      8.0_51.jdk/Contents/Home/jre/lib/ext:/Library/Java/Extensions:/Network/Library</span><br><span class="line">                                                      /Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java</span><br><span class="line"> sun.boot.class.path                                  /Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/lib/resour</span><br><span class="line">                                                      ces.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/li</span><br><span class="line">                                                      b/rt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/l</span><br><span class="line">                                                      ib/sunrsasign.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/H</span><br><span class="line">                                                      ome/jre/lib/jsse.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Content</span><br><span class="line">                                                      s/Home/jre/lib/jce.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Conte</span><br><span class="line">                                                      nts/Home/jre/lib/charsets.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jd</span><br><span class="line">                                                      k/Contents/Home/jre/lib/jfr.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.</span><br><span class="line">                                                      jdk/Contents/Home/jre/classes</span><br><span class="line"> java.vendor                                          Oracle Corporation</span><br><span class="line"> file.separator                                       /</span><br><span class="line"> java.vendor.url.bug                                  http://bugreport.sun.com/bugreport/</span><br><span class="line"> sun.cpu.endian                                       little</span><br><span class="line"> sun.io.unicode.encoding                              UnicodeBig</span><br><span class="line"> sun.cpu.isalist</span><br></pre></td></tr></table></figure>

<h3 id="查看单个属性"><a href="#查看单个属性" class="headerlink" title="查看单个属性"></a>查看单个属性</h3><blockquote>
<p>提示</p>
<p>支持通过<code>TAB</code>键自动补全</p>
</blockquote>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sysprop java.version</span><br><span class="line">java.version=1.8.0_51</span><br></pre></td></tr></table></figure>

<h3 id="修改单个属性"><a href="#修改单个属性" class="headerlink" title="修改单个属性"></a>修改单个属性</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sysprop user.country</span><br><span class="line">user.country=US</span><br><span class="line">$ sysprop user.country CN</span><br><span class="line">Successfully changed the system property.</span><br><span class="line">user.country=CN</span><br></pre></td></tr></table></figure>

<h1 id="tee-命令"><a href="#tee-命令" class="headerlink" title="tee 命令"></a>tee 命令</h1><p>类似传统的 <a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/tee.html">tee 命令</a> 用于读取标准输入的数据，并将其内容输出成文件。</p>
<p>tee 指令会从标准输入设备读取数据，将其内容输出到标准输出设备，同时保存成文件。</p>
<p>使用 <code>tee -h</code> 查看帮助信息</p>
<h2 id="命令示范"><a href="#命令示范" class="headerlink" title="命令示范"></a>命令示范</h2><h3 id="将-sysprop-命令执行结果另外存储在-tmp-logfile-中"><a href="#将-sysprop-命令执行结果另外存储在-tmp-logfile-中" class="headerlink" title="将 sysprop 命令执行结果另外存储在/tmp/logfile 中"></a>将 sysprop 命令执行结果另外存储在<code>/tmp/logfile</code> 中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysprop | tee &#x2F;tmp&#x2F;logfile</span><br></pre></td></tr></table></figure>

<p>查看<code>/tmp/logfile</code> 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;tmp&#x2F;logfile</span><br></pre></td></tr></table></figure>

<h3 id="将-sysprop-命令执行结果匹配java-后另外追加在-tmp-logfile-中"><a href="#将-sysprop-命令执行结果匹配java-后另外追加在-tmp-logfile-中" class="headerlink" title="将 sysprop 命令执行结果匹配java 后另外追加在/tmp/logfile 中"></a>将 sysprop 命令执行结果匹配<code>java</code> 后另外追加在<code>/tmp/logfile</code> 中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysprop | grep java | tee -a &#x2F;path&#x2F;to&#x2F;logfile</span><br></pre></td></tr></table></figure>

<p>查看<code>/tmp/logfile</code> 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;tmp&#x2F;logfile</span><br></pre></td></tr></table></figure>

<h1 id="thread-命令"><a href="#thread-命令" class="headerlink" title="thread 命令"></a>thread 命令</h1><p>查看当前线程信息，查看线程的堆栈</p>
<h2 id="参数说明-13"><a href="#参数说明-13" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th>参数名称</th>
<th>参数说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>线程 id</td>
</tr>
<tr>
<td>[n:]</td>
<td>指定最忙的前 N 个线程并打印堆栈</td>
</tr>
<tr>
<td>[b]</td>
<td>找出当前阻塞其他线程的线程</td>
</tr>
<tr>
<td>[i ]</td>
<td>指定 cpu 占比统计的采样间隔，单位为毫秒</td>
</tr>
<tr>
<td>[–all]</td>
<td>显示所有匹配的线程</td>
</tr>
</tbody></table>
<h2 id="Thread-用法"><a href="#Thread-用法" class="headerlink" title="Thread 用法"></a>Thread 用法</h2><h3 id="支持一键展示当前最忙的前-N-个线程并打印堆栈："><a href="#支持一键展示当前最忙的前-N-个线程并打印堆栈：" class="headerlink" title="支持一键展示当前最忙的前 N 个线程并打印堆栈："></a>支持一键展示当前最忙的前 N 个线程并打印堆栈：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread -n 3</span><br></pre></td></tr></table></figure>

<ul>
<li>没有线程 ID，包含<code>[Internal]</code> 表示为 JVM 内部线程，参考<code>dashboard</code> 命令的介绍。</li>
<li><code>cpuUsage</code> 为采样间隔时间内线程的 CPU 使用率，与<code>dashboard</code> 命令的数据一致。</li>
<li><code>deltaTime</code> 为采样间隔时间内线程的增量 CPU 时间，小于 1ms 时被取整显示为 0ms。</li>
<li><code>time</code> 线程运行总 CPU 时间。</li>
</ul>
<p>注意：线程栈为第二采样结束时获取，不能表明采样间隔时间内该线程都是在处理相同的任务。建议间隔时间不要太长，可能间隔时间越大越不准确。 可以根据具体情况尝试指定不同的间隔时间，观察输出结果。</p>
<h3 id="当没有参数时，显示第一页线程信息"><a href="#当没有参数时，显示第一页线程信息" class="headerlink" title="当没有参数时，显示第一页线程信息"></a>当没有参数时，显示第一页线程信息</h3><p>默认按照 CPU 增量时间降序排列，只显示第一页数据，避免滚屏。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread</span><br></pre></td></tr></table></figure>

<h3 id="thread-–all-显示所有匹配的线程"><a href="#thread-–all-显示所有匹配的线程" class="headerlink" title="thread –all, 显示所有匹配的线程"></a>thread –all, 显示所有匹配的线程</h3><p>显示所有匹配线程信息，有时需要获取全部 JVM 的线程数据进行分析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread --all</span><br></pre></td></tr></table></figure>

<h3 id="thread-id，显示指定线程的运行堆栈"><a href="#thread-id，显示指定线程的运行堆栈" class="headerlink" title="thread id，显示指定线程的运行堆栈"></a>thread id，显示指定线程的运行堆栈</h3><p>查看线程 ID 16 的栈：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread 16</span><br></pre></td></tr></table></figure>

<h3 id="thread-b-找出当前阻塞其他线程的线程"><a href="#thread-b-找出当前阻塞其他线程的线程" class="headerlink" title="thread -b, 找出当前阻塞其他线程的线程"></a>thread -b, 找出当前阻塞其他线程的线程</h3><p>有时候我们发现应用卡住了，通常是由于某个线程拿住了某个锁，并且其他线程都在等待这把锁造成的。为了排查这类问题，arthas 提供了<code>thread -b</code> ，一键找出那个罪魁祸首。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread -b</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>，目前只支持找出 synchronized 关键字阻塞住的线程，如果是<code>java.util.concurrent.Lock</code> ，目前还不支持。</p>
<h3 id="thread-i-指定采样时间间隔"><a href="#thread-i-指定采样时间间隔" class="headerlink" title="thread -i, 指定采样时间间隔"></a>thread -i, 指定采样时间间隔</h3><ul>
<li><code>thread -i 1000</code> : 统计最近 1000ms 内的线程 CPU 时间。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread -i 1000</span><br></pre></td></tr></table></figure>

<ul>
<li><code>thread -n 3 -i 1000</code> : 列出 1000ms 内最忙的 3 个线程栈</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread -n 3 -i 1000</span><br></pre></td></tr></table></figure>

<h3 id="thread-–state，查看指定状态的线程"><a href="#thread-–state，查看指定状态的线程" class="headerlink" title="thread –state，查看指定状态的线程"></a>thread –state，查看指定状态的线程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread --state WAITING</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="trace-命令"><a href="#trace-命令" class="headerlink" title="trace 命令"></a>trace 命令</h1><div class="note info no-icon"><p>提示</p>
<p>方法内部调用路径，并输出方法路径上的每个节点上耗时</p>
</div>

<p><code>trace</code> 命令能主动搜索 <code>class-pattern</code>／<code>method-pattern</code> 对应的方法调用路径，渲染和统计整个调用链路上的所有性能开销和追踪调用链路。</p>
<h2 id="参数说明-14"><a href="#参数说明-14" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>class-pattern</em></td>
<td align="left">类名表达式匹配</td>
</tr>
<tr>
<td align="right"><em>method-pattern</em></td>
<td align="left">方法名表达式匹配</td>
</tr>
<tr>
<td align="right"><em>condition-express</em></td>
<td align="left">条件表达式</td>
</tr>
<tr>
<td align="right">[E]</td>
<td align="left">开启正则表达式匹配，默认为通配符匹配</td>
</tr>
<tr>
<td align="right"><code>[n:]</code></td>
<td align="left">命令执行次数</td>
</tr>
<tr>
<td align="right"><code>#cost</code></td>
<td align="left">方法执行耗时</td>
</tr>
<tr>
<td align="right"><code>[m &lt;arg&gt;]</code></td>
<td align="left">指定 Class 最大匹配数量，默认值为 50。长格式为<code>[maxMatch &lt;arg&gt;]</code>。</td>
</tr>
</tbody></table>
<p>这里重点要说明的是<code>条件表达式</code>，<code>条件表达式</code>的构成主要由 ognl 表达式组成，所以你可以这样写<code>&quot;params[0]&lt;0&quot;</code>，只要是一个合法的 ognl 表达式，都能被正常支持。</p>
<p>请参考<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/advice-class.html">表达式核心变量</a>中关于该节点的描述。</p>
<ul>
<li>特殊用法请参考：<a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/71">https://github.com/alibaba/arthas/issues/71在新窗口打开</a></li>
<li>OGNL 表达式官网：<a target="_blank" rel="noopener" href="https://commons.apache.org/proper/commons-ognl/language-guide.html">https://commons.apache.org/proper/commons-ognl/language-guide.html在新窗口打开</a></li>
</ul>
<p>很多时候我们只想看到某个方法的 rt 大于某个时间之后的 trace 结果，现在 Arthas 可以按照方法执行的耗时来进行过滤了，例如<code>trace *StringUtils isBlank &#39;#cost&gt;100&#39;</code>表示当执行时间超过 100ms 的时候，才会输出 trace 的结果。</p>
<div class="note info no-icon"><p>提示</p>
<p>watch/stack/trace 这个三个命令都支持<code>#cost</code></p>
</div>

<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li><p><code>trace</code> 能方便的帮助你定位和发现因 RT 高而导致的性能问题缺陷，但其每次只能跟踪一级方法的调用链路。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/597">Trace 命令的实现原理在新窗口打开</a></p>
</li>
<li><p>3.3.0 版本后，可以使用动态 Trace 功能，不断增加新的匹配类，参考下面的示例。</p>
</li>
<li><p>目前不支持 <code>trace java.lang.Thread getName</code>，参考 issue: <a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/1610">#1610在新窗口打开</a> ，考虑到不是非常必要场景，且修复有一定难度，因此当前暂不修复</p>
</li>
</ul>
<h2 id="使用参考-20"><a href="#使用参考-20" class="headerlink" title="使用参考"></a>使用参考</h2><h3 id="trace-函数"><a href="#trace-函数" class="headerlink" title="trace 函数"></a>trace 函数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ trace demo.MathGame run</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 28 ms.</span><br><span class="line">`---ts=2019-12-04 00:45:08;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    `---[0.617465ms] demo.MathGame:run()</span><br><span class="line">        `---[0.078946ms] demo.MathGame:primeFactors() <span class="comment">#24 [throws Exception]</span></span><br><span class="line"></span><br><span class="line">`---ts=2019-12-04 00:45:09;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    `---[1.276874ms] demo.MathGame:run()</span><br><span class="line">        `---[0.03752ms] demo.MathGame:primeFactors() <span class="comment">#24 [throws Exception]</span></span><br></pre></td></tr></table></figure>

<div class="note info no-icon"><p>提示</p>
<p>结果里的 <code>#24</code>，表示在 run 函数里，在源文件的第<code>24</code>行调用了<code>primeFactors()</code>函数。</p>
</div>

<h3 id="指定-Class-匹配的最大数量"><a href="#指定-Class-匹配的最大数量" class="headerlink" title="指定 Class 匹配的最大数量"></a>指定 Class 匹配的最大数量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ trace demo.MathGame run -m 1</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 412 ms, listenerId: 4</span><br><span class="line">`---ts=2022-12-25 21:00:00;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@b4aac2</span><br><span class="line">    `---[0.762093ms] demo.MathGame:run()</span><br><span class="line">        `---[30.21% 0.230241ms] demo.MathGame:primeFactors() <span class="comment">#46 [throws Exception]</span></span><br><span class="line"></span><br><span class="line">`---ts=2022-12-25 21:00:10;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@b4aac2</span><br><span class="line">    `---[0.315298ms] demo.MathGame:run()</span><br><span class="line">        `---[13.95% 0.043995ms] demo.MathGame:primeFactors() <span class="comment">#46 [throws Exception]</span></span><br></pre></td></tr></table></figure>

<h3 id="trace-次数限制"><a href="#trace-次数限制" class="headerlink" title="trace 次数限制"></a>trace 次数限制</h3><p>如果方法调用的次数很多，那么可以用<code>-n</code>参数指定捕捉结果的次数。比如下面的例子里，捕捉到一次调用就退出命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ trace demo.MathGame run -n 1</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 20 ms.</span><br><span class="line">`---ts=2019-12-04 00:45:53;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    `---[0.549379ms] demo.MathGame:run()</span><br><span class="line">        +---[0.059839ms] demo.MathGame:primeFactors() <span class="comment">#24</span></span><br><span class="line">        `---[0.232887ms] demo.MathGame:<span class="built_in">print</span>() <span class="comment">#25</span></span><br><span class="line"></span><br><span class="line">Command execution <span class="built_in">times</span> exceed <span class="built_in">limit</span>: 1, so <span class="built_in">command</span> will <span class="built_in">exit</span>. You can <span class="built_in">set</span> it with -n option.</span><br></pre></td></tr></table></figure>

<h3 id="包含-jdk-的函数"><a href="#包含-jdk-的函数" class="headerlink" title="包含 jdk 的函数"></a>包含 jdk 的函数</h3><ul>
<li><code>--skipJDKMethod &lt;value&gt; </code>skip jdk method trace, default value true.</li>
</ul>
<p>默认情况下，trace 不会包含 jdk 里的函数调用，如果希望 trace jdk 里的函数，需要显式设置<code>--skipJDKMethod false</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ trace --skipJDKMethod <span class="literal">false</span> demo.MathGame run</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 60 ms.</span><br><span class="line">`---ts=2019-12-04 00:44:41;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    `---[1.357742ms] demo.MathGame:run()</span><br><span class="line">        +---[0.028624ms] java.util.Random:nextInt() <span class="comment">#23</span></span><br><span class="line">        +---[0.045534ms] demo.MathGame:primeFactors() <span class="comment">#24 [throws Exception]</span></span><br><span class="line">        +---[0.005372ms] java.lang.StringBuilder:&lt;init&gt;() <span class="comment">#28</span></span><br><span class="line">        +---[0.012257ms] java.lang.Integer:valueOf() <span class="comment">#28</span></span><br><span class="line">        +---[0.234537ms] java.lang.String:format() <span class="comment">#28</span></span><br><span class="line">        +---[min=0.004539ms,max=0.005778ms,total=0.010317ms,count=2] java.lang.StringBuilder:append() <span class="comment">#28</span></span><br><span class="line">        +---[0.013777ms] java.lang.Exception:getMessage() <span class="comment">#28</span></span><br><span class="line">        +---[0.004935ms] java.lang.StringBuilder:toString() <span class="comment">#28</span></span><br><span class="line">        `---[0.06941ms] java.io.PrintStream:println() <span class="comment">#28</span></span><br><span class="line"></span><br><span class="line">`---ts=2019-12-04 00:44:42;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    `---[3.030432ms] demo.MathGame:run()</span><br><span class="line">        +---[0.010473ms] java.util.Random:nextInt() <span class="comment">#23</span></span><br><span class="line">        +---[0.023715ms] demo.MathGame:primeFactors() <span class="comment">#24 [throws Exception]</span></span><br><span class="line">        +---[0.005198ms] java.lang.StringBuilder:&lt;init&gt;() <span class="comment">#28</span></span><br><span class="line">        +---[0.006405ms] java.lang.Integer:valueOf() <span class="comment">#28</span></span><br><span class="line">        +---[0.178583ms] java.lang.String:format() <span class="comment">#28</span></span><br><span class="line">        +---[min=0.011636ms,max=0.838077ms,total=0.849713ms,count=2] java.lang.StringBuilder:append() <span class="comment">#28</span></span><br><span class="line">        +---[0.008747ms] java.lang.Exception:getMessage() <span class="comment">#28</span></span><br><span class="line">        +---[0.019768ms] java.lang.StringBuilder:toString() <span class="comment">#28</span></span><br><span class="line">        `---[0.076457ms] java.io.PrintStream:println() <span class="comment">#28</span></span><br></pre></td></tr></table></figure>

<h3 id="根据调用耗时过滤"><a href="#根据调用耗时过滤" class="headerlink" title="根据调用耗时过滤"></a>根据调用耗时过滤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ trace demo.MathGame run <span class="string">&#x27;#cost &gt; 10&#x27;</span></span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 41 ms.</span><br><span class="line">`---ts=2018-12-04 01:12:02;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    `---[12.033735ms] demo.MathGame:run()</span><br><span class="line">        +---[0.006783ms] java.util.Random:nextInt()</span><br><span class="line">        +---[11.852594ms] demo.MathGame:primeFactors()</span><br><span class="line">        `---[0.05447ms] demo.MathGame:<span class="built_in">print</span>()</span><br></pre></td></tr></table></figure>

<div class="note info no-icon"><p>提示</p>
<p>只会展示耗时大于 10ms 的调用路径，有助于在排查问题的时候，只关注异常情况</p>
</div>

<ul>
<li>是不是很眼熟，没错，在 JProfiler 等收费软件中你曾经见识类似的功能，这里你将可以通过命令就能打印出指定调用路径。 友情提醒下，<code>trace</code> 在执行的过程中本身是会有一定的性能开销，在统计的报告中并未像 JProfiler 一样预先减去其自身的统计开销。所以这统计出来有些许的不准，渲染路径上调用的类、方法越多，性能偏差越大。但还是能让你看清一些事情的。</li>
<li>[12.033735ms] 的含义，<code>12.033735</code> 的含义是：当前节点在当前步骤的耗时，单位为毫秒</li>
<li>[0,0,0ms,11]xxx:yyy() [throws Exception]，对该方法中相同的方法调用进行了合并，<code>0,0,0ms,11</code> 表示方法调用耗时，<code>min,max,total,count</code>；<code>throws Exception</code> 表明该方法调用中存在异常返回</li>
<li>这里存在一个统计不准确的问题，就是所有方法耗时加起来可能会小于该监测方法的总耗时，这个是由于 Arthas 本身的逻辑会有一定的耗时</li>
</ul>
<h3 id="trace-多个类或者多个函数"><a href="#trace-多个类或者多个函数" class="headerlink" title="trace 多个类或者多个函数"></a>trace 多个类或者多个函数</h3><p>trace 命令只会 trace 匹配到的函数里的子调用，并不会向下 trace 多层。因为 trace 是代价比较贵的，多层 trace 可能会导致最终要 trace 的类和函数非常多。</p>
<p>可以用正则表匹配路径上的多个类和函数，一定程度上达到多层 trace 的效果。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace -E com.test.ClassA|org.test.ClassB method1|method2|method3</span><br></pre></td></tr></table></figure>

<h3 id="排除掉指定的类"><a href="#排除掉指定的类" class="headerlink" title="排除掉指定的类"></a>排除掉指定的类</h3><p>使用 <code>--exclude-class-pattern</code> 参数可以排除掉指定的类，比如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace javax.servlet.Filter * --exclude-class-pattern com.demo.TestFilter</span><br></pre></td></tr></table></figure>

<h2 id="动态-trace"><a href="#动态-trace" class="headerlink" title="动态 trace"></a>动态 trace</h2><div class="note info no-icon"><p>提示</p>
<p>3.3.0 版本后支持。</p>
</div>

<p>打开终端 1，trace 上面 demo 里的<code>run</code>函数，可以看到打印出 <code>listenerId: 1</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[arthas@59161]$ trace demo.MathGame run</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 112 ms, listenerId: 1</span><br><span class="line">`---ts=2020-07-09 16:48:11;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    `---[1.389634ms] demo.MathGame:run()</span><br><span class="line">        `---[0.123934ms] demo.MathGame:primeFactors() <span class="comment">#24 [throws Exception]</span></span><br><span class="line"></span><br><span class="line">`---ts=2020-07-09 16:48:12;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    `---[3.716391ms] demo.MathGame:run()</span><br><span class="line">        +---[3.182813ms] demo.MathGame:primeFactors() <span class="comment">#24</span></span><br><span class="line">        `---[0.167786ms] demo.MathGame:<span class="built_in">print</span>() <span class="comment">#25</span></span><br></pre></td></tr></table></figure>

<p>现在想要深入子函数<code>primeFactors</code>，可以打开一个新终端 2，使用<code>telnet localhost 3658</code>连接上 arthas，再 trace <code>primeFactors</code>时，指定<code>listenerId</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[arthas@59161]$ trace demo.MathGame primeFactors --listenerId 1</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 34 ms, listenerId: 1</span><br></pre></td></tr></table></figure>

<p>这时终端 2 打印的结果，说明已经增强了一个函数：<code>Affect(class count: 1 , method count: 1)</code>，但不再打印更多的结果。</p>
<p>再查看终端 1，可以发现 trace 的结果增加了一层，打印了<code>primeFactors</code>函数里的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">`---ts=2020-07-09 16:49:29;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    `---[0.492551ms] demo.MathGame:run()</span><br><span class="line">        `---[0.113929ms] demo.MathGame:primeFactors() <span class="comment">#24 [throws Exception]</span></span><br><span class="line">            `---[0.061462ms] demo.MathGame:primeFactors()</span><br><span class="line">                `---[0.001018ms] throw:java.lang.IllegalArgumentException() <span class="comment">#46</span></span><br><span class="line"></span><br><span class="line">`---ts=2020-07-09 16:49:30;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">    `---[0.409446ms] demo.MathGame:run()</span><br><span class="line">        +---[0.232606ms] demo.MathGame:primeFactors() <span class="comment">#24</span></span><br><span class="line">        |   `---[0.1294ms] demo.MathGame:primeFactors()</span><br><span class="line">        `---[0.084025ms] demo.MathGame:<span class="built_in">print</span>() <span class="comment">#25</span></span><br></pre></td></tr></table></figure>

<p>通过指定<code>listenerId</code>的方式动态 trace，可以不断深入。另外 <code>watch</code>/<code>tt</code>/<code>monitor</code>等命令也支持类似的功能。</p>
<h2 id="trace-结果时间不准确问题"><a href="#trace-结果时间不准确问题" class="headerlink" title="trace 结果时间不准确问题"></a>trace 结果时间不准确问题</h2><p>比如下面的结果里：<code>0.705196 &gt; (0.152743 + 0.145825)</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ trace demo.MathGame run -n 1</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 66 ms, listenerId: 1</span><br><span class="line">`---ts=2021-02-08 11:27:36;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@232204a1</span><br><span class="line">    `---[0.705196ms] demo.MathGame:run()</span><br><span class="line">        +---[0.152743ms] demo.MathGame:primeFactors() <span class="comment">#24</span></span><br><span class="line">        `---[0.145825ms] demo.MathGame:<span class="built_in">print</span>() <span class="comment">#25</span></span><br></pre></td></tr></table></figure>

<p>那么其它的时间消耗在哪些地方？</p>
<ol>
<li><p>没有被 trace 到的函数。比如<code>java.*</code> 下的函数调用默认会忽略掉。通过增加<code>--skipJDKMethod false</code>参数可以打印出来。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ trace demo.MathGame run --skipJDKMethod <span class="literal">false</span></span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 35 ms, listenerId: 2</span><br><span class="line">`---ts=2021-02-08 11:27:48;thread_name=main;id=1;is_daemon=<span class="literal">false</span>;priority=5;TCCL=sun.misc.Launcher<span class="variable">$AppClassLoader</span>@232204a1</span><br><span class="line">    `---[0.810591ms] demo.MathGame:run()</span><br><span class="line">        +---[0.034568ms] java.util.Random:nextInt() <span class="comment">#23</span></span><br><span class="line">        +---[0.119367ms] demo.MathGame:primeFactors() <span class="comment">#24 [throws Exception]</span></span><br><span class="line">        +---[0.017407ms] java.lang.StringBuilder:&lt;init&gt;() <span class="comment">#28</span></span><br><span class="line">        +---[0.127922ms] java.lang.String:format() <span class="comment">#57</span></span><br><span class="line">        +---[min=0.01419ms,max=0.020221ms,total=0.034411ms,count=2] java.lang.StringBuilder:append() <span class="comment">#57</span></span><br><span class="line">        +---[0.021911ms] java.lang.Exception:getMessage() <span class="comment">#57</span></span><br><span class="line">        +---[0.015643ms] java.lang.StringBuilder:toString() <span class="comment">#57</span></span><br><span class="line">        `---[0.086622ms] java.io.PrintStream:println() <span class="comment">#57</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>非函数调用的指令消耗。比如 <code>i++</code>, <code>getfield</code>等指令。</p>
</li>
<li><p>在代码执行过程中，JVM 可能出现停顿，比如 GC，进入同步块等。</p>
</li>
</ol>
<h3 id="使用-v-参数打印更多信息"><a href="#使用-v-参数打印更多信息" class="headerlink" title="使用 -v 参数打印更多信息"></a>使用 -v 参数打印更多信息</h3><div class="note info no-icon"><p>提示</p>
<p>watch/trace/monitor/stack/tt 命令都支持 <code>-v</code> 参数</p>
</div>

<p>当命令执行之后，没有输出结果。有两种可能：</p>
<ol>
<li>匹配到的函数没有被执行</li>
<li>条件表达式结果是 false</li>
</ol>
<p>但用户区分不出是哪种情况。</p>
<p>使用 <code>-v</code>选项，则会打印<code>Condition express</code>的具体值和执行结果，方便确认。</p>
<hr>
<h1 id="tt-命令"><a href="#tt-命令" class="headerlink" title="tt 命令"></a>tt 命令</h1><div class="note info no-icon"><p>提示</p>
<p>方法执行数据的时空隧道，记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测</p>
</div>

<p><code>watch</code> 虽然很方便和灵活，但需要提前想清楚观察表达式的拼写，这对排查问题而言要求太高，因为很多时候我们并不清楚问题出自于何方，只能靠蛛丝马迹进行猜测。</p>
<p>这个时候如果能记录下当时方法调用的所有入参和返回值、抛出的异常会对整个问题的思考与判断非常有帮助。</p>
<p>于是乎，TimeTunnel 命令就诞生了。</p>
<h2 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>tt 命令的实现是：把函数的入参/返回值等，保存到一个<code>Map&lt;Integer, TimeFragment&gt;</code>里，默认的大小是 100。</li>
<li>tt 相关功能在使用完之后，需要手动释放内存，否则长时间可能导致OOM。退出 arthas 不会自动清除 tt 的缓存 map。</li>
</ul>
<h2 id="使用参考-21"><a href="#使用参考-21" class="headerlink" title="使用参考"></a>使用参考</h2><h3 id="记录调用"><a href="#记录调用" class="headerlink" title="记录调用"></a>记录调用</h3><p>对于一个最基本的使用来说，就是记录下当前方法的每次调用环境现场。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ tt -t demo.MathGame primeFactors</span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 66 ms.</span><br><span class="line"> INDEX   TIMESTAMP            COST(ms)  IS-RET  IS-EXP   OBJECT         CLASS                          METHOD</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> 1000    2018-12-04 11:15:38  1.096236  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1001    2018-12-04 11:15:39  0.191848  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1002    2018-12-04 11:15:40  0.069523  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1003    2018-12-04 11:15:41  0.186073  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1004    2018-12-04 11:15:42  17.76437  <span class="literal">true</span>    <span class="literal">false</span>    0x4b67cf4d     MathGame                       primeFactors</span><br></pre></td></tr></table></figure>

<h3 id="指定-Class-最大匹配数量-2"><a href="#指定-Class-最大匹配数量-2" class="headerlink" title="指定 Class 最大匹配数量"></a>指定 Class 最大匹配数量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ tt -t -m 1 demo.MathGame primeFactors</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count:1 , method count:1) cost <span class="keyword">in</span> 130 ms, listenerId: 1.</span><br><span class="line"> INDEX   TIMESTAMP            COST(ms)  IS-RET  IS-EXP   OBJECT         CLASS                          METHOD</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> 1000    2022-12-25 19:41:45  2.629929  <span class="literal">true</span>    <span class="literal">false</span>    0x3bf400       MathGame                       primeFactors</span><br><span class="line"> 1001    2022-12-25 19:41:55  0.146161  <span class="literal">false</span>   <span class="literal">true</span>     0x3bf400       MathGame                       primeFactors</span><br></pre></td></tr></table></figure>

<ul>
<li><p>命令参数解析</p>
<ul>
<li><p><code>-t</code></p>
<p>tt 命令有很多个主参数，<code>-t</code> 就是其中之一。这个参数的表明希望记录下类 <code>*Test</code> 的 <code>print</code> 方法的每次执行情况。</p>
</li>
<li><p><code>-n 3</code></p>
<p>当你执行一个调用量不高的方法时可能你还能有足够的时间用 <code>CTRL+C</code> 中断 tt 命令记录的过程，但如果遇到调用量非常大的方法，瞬间就能将你的 JVM 内存撑爆。</p>
<p>此时你可以通过 <code>-n</code> 参数指定你需要记录的次数，当达到记录次数时 Arthas 会主动中断 tt 命令的记录过程，避免人工操作无法停止的情况。</p>
</li>
<li><p><code>-m 1</code></p>
<p>通过 <code>-m</code> 参数指定 Class 匹配的最大数量，防止匹配到的 Class 数量太多导致 JVM 挂起，默认值是 50。</p>
</li>
</ul>
</li>
<li><p>表格字段说明</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>表格字段</th>
<th>字段解释</th>
</tr>
</thead>
<tbody><tr>
<td>INDEX</td>
<td>时间片段记录编号，每一个编号代表着一次调用，后续 tt 还有很多命令都是基于此编号指定记录操作，非常重要。</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>方法执行的本机时间，记录了这个时间片段所发生的本机时间</td>
</tr>
<tr>
<td>COST(ms)</td>
<td>方法执行的耗时</td>
</tr>
<tr>
<td>IS-RET</td>
<td>方法是否以正常返回的形式结束</td>
</tr>
<tr>
<td>IS-EXP</td>
<td>方法是否以抛异常的形式结束</td>
</tr>
<tr>
<td>OBJECT</td>
<td>执行对象的<code>hashCode()</code>，注意，曾经有人误认为是对象在 JVM 中的内存地址，但很遗憾他不是。但他能帮助你简单的标记当前执行方法的类实体</td>
</tr>
<tr>
<td>CLASS</td>
<td>执行的类名</td>
</tr>
<tr>
<td>METHOD</td>
<td>执行的方法名</td>
</tr>
</tbody></table>
<ul>
<li><p>条件表达式</p>
<p>不知道大家是否有在使用过程中遇到以下困惑</p>
<ul>
<li>Arthas 似乎很难区分出重载的方法</li>
<li>我只需要观察特定参数，但是 tt 却全部都给我记录了下来</li>
</ul>
<p>条件表达式也是用 <code>OGNL</code> 来编写，核心的判断对象依然是 <code>Advice</code> 对象。除了 <code>tt</code> 命令之外，<code>watch</code>、<code>trace</code>、<code>stack</code> 命令也都支持条件表达式。</p>
</li>
<li><p>解决方法重载</p>
<p><code>tt -t *Test print params.length==1</code></p>
<p>通过制定参数个数的形式解决不同的方法签名，如果参数个数一样，你还可以这样写</p>
<p><code>tt -t *Test print &#39;params[1] instanceof Integer&#39;</code></p>
</li>
<li><p>解决指定参数</p>
<p><code>tt -t *Test print params[0].mobile==&quot;13989838402&quot;</code></p>
</li>
<li><p>构成条件表达式的 <code>Advice</code> 对象</p>
<p>前边看到了很多条件表达式中，都使用了 <code>params[0]</code>，有关这个变量的介绍，请参考<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/advice-class.html">表达式核心变量</a></p>
</li>
</ul>
<h3 id="检索调用记录"><a href="#检索调用记录" class="headerlink" title="检索调用记录"></a>检索调用记录</h3><p>当你用 <code>tt</code> 记录了一大片的时间片段之后，你希望能从中筛选出自己需要的时间片段，这个时候你就需要对现有记录进行检索。</p>
<p>假设我们有这些记录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ tt -l</span><br><span class="line"> INDEX   TIMESTAMP            COST(ms)  IS-RET  IS-EXP   OBJECT         CLASS                          METHOD</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> 1000    2018-12-04 11:15:38  1.096236  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1001    2018-12-04 11:15:39  0.191848  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1002    2018-12-04 11:15:40  0.069523  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1003    2018-12-04 11:15:41  0.186073  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1004    2018-12-04 11:15:42  17.76437  <span class="literal">true</span>    <span class="literal">false</span>    0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line">                              9</span><br><span class="line"> 1005    2018-12-04 11:15:43  0.4776    <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line">Affect(row-cnt:6) cost <span class="keyword">in</span> 4 ms.</span><br></pre></td></tr></table></figure>

<p>我需要筛选出 <code>primeFactors</code> 方法的调用信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ tt -s <span class="string">&#x27;method.name==&quot;primeFactors&quot;&#x27;</span></span><br><span class="line"> INDEX   TIMESTAMP            COST(ms)  IS-RET  IS-EXP   OBJECT         CLASS                          METHOD</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> 1000    2018-12-04 11:15:38  1.096236  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1001    2018-12-04 11:15:39  0.191848  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1002    2018-12-04 11:15:40  0.069523  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1003    2018-12-04 11:15:41  0.186073  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1004    2018-12-04 11:15:42  17.76437  <span class="literal">true</span>    <span class="literal">false</span>    0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line">                              9</span><br><span class="line"> 1005    2018-12-04 11:15:43  0.4776    <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line">Affect(row-cnt:6) cost <span class="keyword">in</span> 607 ms.</span><br></pre></td></tr></table></figure>

<p>你需要一个 <code>-s</code> 参数。同样的，搜索表达式的核心对象依旧是 <code>Advice</code> 对象。</p>
<h3 id="查看调用信息"><a href="#查看调用信息" class="headerlink" title="查看调用信息"></a>查看调用信息</h3><p>对于具体一个时间片的信息而言，你可以通过 <code>-i</code> 参数后边跟着对应的 <code>INDEX</code> 编号查看到他的详细信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ tt -i 1003</span><br><span class="line"> INDEX            1003</span><br><span class="line"> GMT-CREATE       2018-12-04 11:15:41</span><br><span class="line"> COST(ms)         0.186073</span><br><span class="line"> OBJECT           0x4b67cf4d</span><br><span class="line"> CLASS            demo.MathGame</span><br><span class="line"> METHOD           primeFactors</span><br><span class="line"> IS-RETURN        <span class="literal">false</span></span><br><span class="line"> IS-EXCEPTION     <span class="literal">true</span></span><br><span class="line"> PARAMETERS[0]    @Integer[-564322413]</span><br><span class="line"> THROW-EXCEPTION  java.lang.IllegalArgumentException: number is: -564322413, need &gt;= 2</span><br><span class="line">                      at demo.MathGame.primeFactors(MathGame.java:46)</span><br><span class="line">                      at demo.MathGame.run(MathGame.java:24)</span><br><span class="line">                      at demo.MathGame.main(MathGame.java:16)</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 11 ms.</span><br></pre></td></tr></table></figure>

<h3 id="重做一次调用"><a href="#重做一次调用" class="headerlink" title="重做一次调用"></a>重做一次调用</h3><p>当你稍稍做了一些调整之后，你可能需要前端系统重新触发一次你的调用，此时得求爷爷告奶奶的需要前端配合联调的同学再次发起一次调用。而有些场景下，这个调用不是这么好触发的。</p>
<p><code>tt</code> 命令由于保存了当时调用的所有现场信息，所以我们可以自己主动对一个 <code>INDEX</code> 编号的时间片自主发起一次调用，从而解放你的沟通成本。此时你需要 <code>-p</code> 参数。通过 <code>--replay-times</code> 指定 调用次数，通过 <code>--replay-interval</code> 指定多次调用间隔(单位 ms, 默认 1000ms)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ tt -i 1004 -p</span><br><span class="line"> RE-INDEX       1004</span><br><span class="line"> GMT-REPLAY     2018-12-04 11:26:00</span><br><span class="line"> OBJECT         0x4b67cf4d</span><br><span class="line"> CLASS          demo.MathGame</span><br><span class="line"> METHOD         primeFactors</span><br><span class="line"> PARAMETERS[0]  @Integer[946738738]</span><br><span class="line"> IS-RETURN      <span class="literal">true</span></span><br><span class="line"> IS-EXCEPTION   <span class="literal">false</span></span><br><span class="line"> COST(ms)         0.186073</span><br><span class="line"> RETURN-OBJ     @ArrayList[</span><br><span class="line">                    @Integer[2],</span><br><span class="line">                    @Integer[11],</span><br><span class="line">                    @Integer[17],</span><br><span class="line">                    @Integer[2531387],</span><br><span class="line">                ]</span><br><span class="line">Time fragment[1004] successfully replayed.</span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 14 ms.</span><br></pre></td></tr></table></figure>

<p>你会发现结果虽然一样，但调用的路径发生了变化，由原来的程序发起变成了 Arthas 自己的内部线程发起的调用了。</p>
<h3 id="观察表达式"><a href="#观察表达式" class="headerlink" title="观察表达式"></a>观察表达式</h3><p><code>-w, --watch-express</code> 观察时空隧道使用<code>ognl</code> 表达式</p>
<ul>
<li>使用<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/advice-class.html">表达式核心变量</a>中所有变量作为已知条件编写表达式。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[arthas@10718]$ tt -t demo.MathGame run -n 5</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 56 ms, listenerId: 1</span><br><span class="line"> INDEX      TIMESTAMP                   COST(ms)     IS-RET     IS-EXP      OBJECT              CLASS                                     METHOD</span><br><span class="line">----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> 1000       2021-01-08 21:54:17         0.901091     <span class="literal">true</span>       <span class="literal">false</span>       0x7699a589          MathGame                                  run</span><br><span class="line">[arthas@10718]$ tt -w <span class="string">&#x27;target.illegalArgumentCount&#x27;</span>  -x 1 -i 1000</span><br><span class="line">@Integer[60]</span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 7 ms.</span><br></pre></td></tr></table></figure>

<ul>
<li>获取类的静态字段、调用类的静态方法</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[arthas@10718]$ tt -t demo.MathGame run -n 5</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 56 ms, listenerId: 1</span><br><span class="line"> INDEX      TIMESTAMP                   COST(ms)     IS-RET     IS-EXP      OBJECT              CLASS                                     METHOD</span><br><span class="line">----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> 1000       2021-01-08 21:54:17         0.901091     <span class="literal">true</span>       <span class="literal">false</span>       0x7699a589          MathGame                                  run</span><br><span class="line">[arthas@10718]$ tt -w <span class="string">&#x27;@demo.MathGame@random.nextInt(100)&#x27;</span>  -x 1 -i 1000</span><br><span class="line">@Integer[46]</span><br></pre></td></tr></table></figure>

<p>注意这里使用 <code>com.taobao.arthas.core.advisor.Advice#getLoader</code>加载,使用精确<code>classloader</code> <a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/ognl.html">ognl</a>更好。</p>
<p>高级用法 <a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/482">获取 spring context 调用 bean 方法在新窗口打开</a></p>
<ul>
<li><p>需要强调的点</p>
<ol>
<li><p><strong>ThreadLocal 信息丢失</strong></p>
<p>很多框架偷偷的将一些环境变量信息塞到了发起调用线程的 ThreadLocal 中，由于调用线程发生了变化，这些 ThreadLocal 线程信息无法通过 Arthas 保存，所以这些信息将会丢失。</p>
<p>一些常见的 CASE 比如：鹰眼的 TraceId 等。</p>
</li>
<li><p><strong>引用的对象</strong></p>
<p>需要强调的是，<code>tt</code> 命令是将当前环境的对象引用保存起来，但仅仅也只能保存一个引用而已。如果方法内部对入参进行了变更，或者返回的对象经过了后续的处理，那么在 <code>tt</code> 查看的时候将无法看到当时最准确的值。这也是为什么 <code>watch</code> 命令存在的意义。</p>
</li>
</ol>
</li>
</ul>
<h3 id="通过索引删除指定的-tt-记录"><a href="#通过索引删除指定的-tt-记录" class="headerlink" title="通过索引删除指定的 tt 记录"></a>通过索引删除指定的 tt 记录</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tt -d 1001</span><br></pre></td></tr></table></figure>

<h3 id="清除所有的-tt-记录"><a href="#清除所有的-tt-记录" class="headerlink" title="清除所有的 tt 记录"></a>清除所有的 tt 记录</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tt --delete-all</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="version-命令"><a href="#version-命令" class="headerlink" title="version 命令"></a>version 命令</h1><p>输出当前目标 Java 进程所加载的 Arthas 版本号</p>
<h2 id="使用参考-22"><a href="#使用参考-22" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ version</span><br><span class="line"> 3.5.1</span><br></pre></td></tr></table></figure>

<h1 id="Vmoption-命令"><a href="#Vmoption-命令" class="headerlink" title="Vmoption 命令"></a>Vmoption 命令</h1><h2 id="使用参考-23"><a href="#使用参考-23" class="headerlink" title="使用参考"></a>使用参考</h2><h3 id="查看所有的-option"><a href="#查看所有的-option" class="headerlink" title="查看所有的 option"></a>查看所有的 option</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[arthas@56963]$ vmoption</span><br><span class="line"> KEY                    VALUE                   ORIGIN                 WRITEABLE</span><br><span class="line">---------------------------------------------------------------------------------------------</span><br><span class="line"> HeapDumpBeforeFullGC   <span class="literal">false</span>                   DEFAULT                <span class="literal">true</span></span><br><span class="line"> HeapDumpAfterFullGC    <span class="literal">false</span>                   DEFAULT                <span class="literal">true</span></span><br><span class="line"> HeapDumpOnOutOfMemory  <span class="literal">false</span>                   DEFAULT                <span class="literal">true</span></span><br><span class="line"> Error</span><br><span class="line"> HeapDumpPath                                   DEFAULT                <span class="literal">true</span></span><br><span class="line"> CMSAbortablePrecleanW  100                     DEFAULT                <span class="literal">true</span></span><br><span class="line"> aitMillis</span><br><span class="line"> CMSWaitDuration        2000                    DEFAULT                <span class="literal">true</span></span><br><span class="line"> CMSTriggerInterval     -1                      DEFAULT                <span class="literal">true</span></span><br><span class="line"> PrintGC                <span class="literal">false</span>                   DEFAULT                <span class="literal">true</span></span><br><span class="line"> PrintGCDetails         <span class="literal">true</span>                    MANAGEMENT             <span class="literal">true</span></span><br><span class="line"> PrintGCDateStamps      <span class="literal">false</span>                   DEFAULT                <span class="literal">true</span></span><br><span class="line"> PrintGCTimeStamps      <span class="literal">false</span>                   DEFAULT                <span class="literal">true</span></span><br><span class="line"> PrintGCID              <span class="literal">false</span>                   DEFAULT                <span class="literal">true</span></span><br><span class="line"> PrintClassHistogramBe  <span class="literal">false</span>                   DEFAULT                <span class="literal">true</span></span><br><span class="line"> foreFullGC</span><br><span class="line"> PrintClassHistogramAf  <span class="literal">false</span>                   DEFAULT                <span class="literal">true</span></span><br><span class="line"> terFullGC</span><br><span class="line"> PrintClassHistogram    <span class="literal">false</span>                   DEFAULT                <span class="literal">true</span></span><br><span class="line"> MinHeapFreeRatio       0                       DEFAULT                <span class="literal">true</span></span><br><span class="line"> MaxHeapFreeRatio       100                     DEFAULT                <span class="literal">true</span></span><br><span class="line"> PrintConcurrentLocks   <span class="literal">false</span>                   DEFAULT                <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="查看指定的-option"><a href="#查看指定的-option" class="headerlink" title="查看指定的 option"></a>查看指定的 option</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vmoption PrintGC</span><br><span class="line"> KEY                 VALUE                ORIGIN              WRITEABLE</span><br><span class="line">---------------------------------------------------------------------------------</span><br><span class="line"> PrintGC             <span class="literal">false</span>                MANAGEMENT          <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="更新指定的-option"><a href="#更新指定的-option" class="headerlink" title="更新指定的 option"></a>更新指定的 option</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vmoption PrintGC <span class="literal">true</span></span><br><span class="line">Successfully updated the vm option.</span><br><span class="line"> NAME     BEFORE-VALUE  AFTER-VALUE</span><br><span class="line">------------------------------------</span><br><span class="line"> PrintGC  <span class="literal">false</span>         <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>再使用<code>vmtool</code> 命令执行强制 GC，则可以在<code>Tab 1</code> 看到打印出 GC 日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool --action forceGc</span><br></pre></td></tr></table></figure>

<h3 id="配置打印-GC-详情"><a href="#配置打印-GC-详情" class="headerlink" title="配置打印 GC 详情"></a>配置打印 GC 详情</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmoption PrintGCDetails true</span><br></pre></td></tr></table></figure>

<p>再使用<code>vmtool</code> 命令执行强制 GC，则可以在<code>Tab 1</code> 看到打印出 GC 详情：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool --action forceGc</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="vmtool-命令"><a href="#vmtool-命令" class="headerlink" title="vmtool 命令"></a>vmtool 命令</h1><div class="note info no-icon"><p>提示</p>
<p>@since 3.5.1</p>
</div>

<p><code>vmtool</code> 利用<code>JVMTI</code>接口，实现查询内存对象，强制 GC 等功能。</p>
<h2 id="查找-jvm-里的字符串对象"><a href="#查找-jvm-里的字符串对象" class="headerlink" title="查找 jvm 里的字符串对象"></a>查找 jvm 里的字符串对象</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool --action getInstances --className java.lang.String</span><br></pre></td></tr></table></figure>

<h2 id="limit-参数"><a href="#limit-参数" class="headerlink" title="limit 参数"></a>limit 参数</h2><blockquote>
<p>通过 <code>--limit</code> 参数，可以限制返回值数量，避免获取超大数据时对 JVM 造成压力。默认值是 10。</p>
</blockquote>
<p>所以上面的命令实际上等值于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool --action getInstances --className java.lang.String --limit 10</span><br></pre></td></tr></table></figure>

<p>如果设置<code>--limit</code> 为负数，则遍历所有对象。</p>
<p>下面使用<code>vmtool</code> 命令查找 spring 里的对象。</p>
<h2 id="查找-spring-context"><a href="#查找-spring-context" class="headerlink" title="查找 spring context"></a>查找 spring context</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool --action getInstances --className org.springframework.context.ApplicationContext</span><br></pre></td></tr></table></figure>

<h2 id="指定返回结果展开层数"><a href="#指定返回结果展开层数" class="headerlink" title="指定返回结果展开层数"></a>指定返回结果展开层数</h2><blockquote>
<p><code>getInstances</code> action 返回结果绑定到<code>instances</code> 变量上，它是数组。</p>
</blockquote>
<blockquote>
<p>通过 <code>-x</code> /<code>--expand</code> 参数可以指定结果的展开层次，默认值是 1。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool --action getInstances --className org.springframework.context.ApplicationContext -x 2</span><br></pre></td></tr></table></figure>

<h2 id="执行表达式"><a href="#执行表达式" class="headerlink" title="执行表达式"></a>执行表达式</h2><blockquote>
<p><code>getInstances</code> action 返回结果绑定到<code>instances</code> 变量上，它是数组。可以通过<code>--express</code> 参数执行指定的表达式。</p>
</blockquote>
<p>查找所有的 spring beans 名字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool --action getInstances --className org.springframework.context.ApplicationContext --express &#39;instances[0].getBeanDefinitionNames()&#39;</span><br></pre></td></tr></table></figure>

<p>调用<code>userController.findUserById(1)</code> 函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool --action getInstances --className org.springframework.context.ApplicationContext --express &#39;instances[0].getBean(&quot;userController&quot;).findUserById(1)&#39;</span><br></pre></td></tr></table></figure>

<h2 id="直接获取-UserController-并调用方法"><a href="#直接获取-UserController-并调用方法" class="headerlink" title="直接获取 UserController 并调用方法"></a>直接获取 UserController 并调用方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool --action getInstances --className com.example.demo.arthas.user.UserController --express &#39;instances[0].findUserById(1)&#39;</span><br></pre></td></tr></table></figure>

<h2 id="指定-classloader"><a href="#指定-classloader" class="headerlink" title="指定 classloader"></a>指定 classloader</h2><p>可以通过<code>sc</code> 命令查找到加载 class 的 classloader。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc -d org.springframework.context.ApplicationContext</span><br></pre></td></tr></table></figure>

<p>通过上面命令得到 <code>org.springframework.boot.loader.LaunchedURLClassLoader</code> hashcode 之后用<code>-c</code> / <code>--classloader</code> 参数指定，这里使用 <code>--classLoaderClass </code>来指定 classloader</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool --action getInstances --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --className org.springframework.context.ApplicationContext</span><br></pre></td></tr></table></figure>

<h2 id="强制-GC"><a href="#强制-GC" class="headerlink" title="强制 GC"></a>强制 GC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool --action forceGc</span><br></pre></td></tr></table></figure>

<h2 id="interrupt-指定线程"><a href="#interrupt-指定线程" class="headerlink" title="interrupt 指定线程"></a>interrupt 指定线程</h2><p>thread id 通过<code>-t</code>参数指定，可以使用 <code>thread</code>命令获取。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool --action interruptThread -t 1</span><br></pre></td></tr></table></figure>

<h1 id="watch-命令"><a href="#watch-命令" class="headerlink" title="watch 命令"></a>watch 命令</h1><blockquote>
<p>方法执行数据观测</p>
</blockquote>
<p>让你能方便的观察到指定方法的调用情况。能观察到的范围为：<code>返回值</code> 、<code>抛出异常</code> 、<code>入参</code> ，通过编写 OGNL 表达式进行对应变量的查看。</p>
<h2 id="参数说明-15"><a href="#参数说明-15" class="headerlink" title="参数说明"></a>参数说明</h2><p>watch 的参数比较多，主要是因为它能在 4 个不同的场景观察对象</p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>参数说明</th>
</tr>
</thead>
<tbody><tr>
<td><em>class-pattern</em></td>
<td>类名表达式匹配</td>
</tr>
<tr>
<td><em>method-pattern</em></td>
<td>方法名表达式匹配</td>
</tr>
<tr>
<td><em>express</em></td>
<td>观察表达式，默认值：<code>&#123;params, target, returnObj&#125;</code></td>
</tr>
<tr>
<td><em>condition-express</em></td>
<td>条件表达式</td>
</tr>
<tr>
<td>[b]</td>
<td>在<strong>方法调用之前</strong>观察</td>
</tr>
<tr>
<td>[e]</td>
<td>在<strong>方法异常之后</strong>观察</td>
</tr>
<tr>
<td>[s]</td>
<td>在<strong>方法返回之后</strong>观察</td>
</tr>
<tr>
<td>[f]</td>
<td>在<strong>方法结束之后</strong>(正常返回和异常返回) 观察</td>
</tr>
<tr>
<td>[E]</td>
<td>开启正则表达式匹配，默认为通配符匹配</td>
</tr>
<tr>
<td>[x:]</td>
<td>指定输出结果的属性遍历深度，默认为 1</td>
</tr>
</tbody></table>
<p>这里重点要说明的是观察表达式，观察表达式的构成主要由 ognl 表达式组成，所以你可以这样写<code>&quot;&#123;params,returnObj&#125;&quot;</code> ，只要是一个合法的 ognl 表达式，都能被正常支持。</p>
<p>观察的维度也比较多，主要体现在参数 <code>advice</code> 的数据结构上。<code>Advice</code> 参数最主要是封装了通知节点的所有信息。请参考<a target="_blank" rel="noopener" href="https://killercoda.com/arthas/course/arthas-tutorials-cn/advice-class.md">表达式核心变量</a>中关于该节点的描述。</p>
<ul>
<li>特殊用法请参考：<a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/71">https://github.com/alibaba/arthas/issues/71</a></li>
<li>OGNL 表达式官网：<a target="_blank" rel="noopener" href="https://commons.apache.org/proper/commons-ognl/language-guide.html">https://commons.apache.org/proper/commons-ognl/language-guide.html</a></li>
</ul>
<p><strong>特别说明</strong>：</p>
<ul>
<li>watch 命令定义了 4 个观察事件点，即 <code>-b</code> 方法调用前，<code>-e</code> 方法异常后，<code>-s</code> 方法返回后，<code>-f</code> 方法结束后</li>
<li>4 个观察事件点 <code>-b</code> 、<code>-e</code> 、<code>-s</code> 默认关闭，<code>-f</code> 默认打开，当指定观察点被打开后，在相应事件点会对观察表达式进行求值并输出</li>
<li>这里要注意<code>方法入参</code> 和<code>方法出参</code> 的区别，有可能在中间被修改导致前后不一致，除了 <code>-b</code> 事件点 <code>params</code> 代表方法入参外，其余事件都代表方法出参</li>
<li>当使用 <code>-b</code> 时，由于观察事件点是在方法调用前，此时返回值或异常均不存在</li>
</ul>
<h2 id="使用参考-24"><a href="#使用参考-24" class="headerlink" title="使用参考"></a>使用参考</h2><h3 id="观察方法出参、this-对象和返回值"><a href="#观察方法出参、this-对象和返回值" class="headerlink" title="观察方法出参、this 对象和返回值"></a>观察方法出参、this 对象和返回值</h3><blockquote>
<p>观察表达式，默认值是<code>&#123;params, target, returnObj&#125;</code> 。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch demo.MathGame primeFactors -x 2</span><br></pre></td></tr></table></figure>

<p>按 <code>Q</code> 或者 <code>Ctrl+c</code> 退出</p>
<ul>
<li>从运行结果里，说明函数被执行了两次，第一次结果是<code>location=AtExceptionExit</code> ，说明函数抛出异常了，因此<code>returnObj</code> 是 null</li>
<li>在第二次结果里是<code>location=AtExit</code> ，说明函数正常返回，因此可以看到<code>returnObj</code> 结果是一个 ArrayList</li>
</ul>
<h3 id="观察方法入参"><a href="#观察方法入参" class="headerlink" title="观察方法入参"></a>观察方法入参</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch demo.MathGame primeFactors &quot;&#123;params,returnObj&#125;&quot; -x 2 -b</span><br></pre></td></tr></table></figure>

<p>按 <code>Q</code> 或者 <code>Ctrl+c</code> 退出</p>
<ul>
<li>对比前一个例子，返回值为空（事件点为方法执行前，因此获取不到返回值）</li>
</ul>
<h3 id="同时观察方法调用前和方法返回后"><a href="#同时观察方法调用前和方法返回后" class="headerlink" title="同时观察方法调用前和方法返回后"></a>同时观察方法调用前和方法返回后</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch demo.MathGame primeFactors &quot;&#123;params,target,returnObj&#125;&quot; -x 2 -b -s -n 2</span><br></pre></td></tr></table></figure>

<ul>
<li>参数里<code>-n 2</code> ，表示只执行两次</li>
<li>这里输出结果中，第一次输出的是方法调用前的观察表达式的结果，第二次输出的是方法返回后的表达式的结果</li>
<li>结果的输出顺序和事件发生的先后顺序一致，和命令中 <code>-s -b</code> 的顺序无关</li>
</ul>
<h3 id="调整-x-的值，观察具体的方法参数值"><a href="#调整-x-的值，观察具体的方法参数值" class="headerlink" title="调整-x 的值，观察具体的方法参数值"></a>调整<code>-x</code> 的值，观察具体的方法参数值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch demo.MathGame primeFactors &quot;&#123;params,target&#125;&quot; -x 3</span><br></pre></td></tr></table></figure>

<p>按 <code>Q</code> 或者 <code>Ctrl+c</code> 退出</p>
<ul>
<li><code>-x</code> 表示遍历深度，可以调整来打印具体的参数和结果内容，默认值是 1。</li>
</ul>
<h3 id="条件表达式的例子"><a href="#条件表达式的例子" class="headerlink" title="条件表达式的例子"></a>条件表达式的例子</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch demo.MathGame primeFactors &quot;&#123;params[0],target&#125;&quot; &quot;params[0]&lt;0&quot;</span><br></pre></td></tr></table></figure>

<p>按 <code>Q</code> 或者 <code>Ctrl+c</code> 退出</p>
<ul>
<li>只有满足条件的调用，才会有响应。</li>
<li><code>watch-express</code> 单个值可以不加’{}’，多个值需要加’{a,b,c}’。</li>
<li><code>condition-express</code> 不能加’{}’，可以使用逗号分隔子表达式，取表达式最后一个值来判断。</li>
<li>如果 watch 的方法存在同名的其它重载方法，可以通过下面的办法进行过滤：</li>
<li>根据参数类型进行过滤</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch demo.MathGame primeFactors &#39;&#123;params, params[0].class.name&#125;&#39; &#39;params[0].class.name &#x3D;&#x3D; &quot;java.lang.Integer&quot;&#39;</span><br></pre></td></tr></table></figure>

<p>按 <code>Q</code> 或者 <code>Ctrl+c</code> 退出</p>
<ul>
<li>根据参数个数进行过滤</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch demo.MathGame primeFactors &#39;&#123;params, params.length&#125;&#39; &#39;params.length&#x3D;&#x3D;1&#39;</span><br></pre></td></tr></table></figure>

<p>按 <code>Q</code> 或者 <code>Ctrl+c</code> 退出</p>
<h3 id="观察异常信息的例子"><a href="#观察异常信息的例子" class="headerlink" title="观察异常信息的例子"></a>观察异常信息的例子</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch demo.MathGame primeFactors &quot;&#123;params[0],throwExp&#125;&quot; -e -x 2</span><br></pre></td></tr></table></figure>

<p>按 <code>Q</code> 或者 <code>Ctrl+c</code> 退出</p>
<ul>
<li><code>-e</code> 表示抛出异常时才触发</li>
<li>express 中，表示异常信息的变量是<code>throwExp</code></li>
</ul>
<p>根据异常类型或者 message 进行过滤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch demo.MathGame primeFactors &#39;&#123;params, throwExp&#125;&#39; &#39;#msg&#x3D;throwExp.toString(), #msg.contains(&quot;IllegalArgumentException&quot;)&#39; -e -x 2</span><br></pre></td></tr></table></figure>

<p>按 <code>Q</code> 或者 <code>Ctrl+c</code> 退出</p>
<h3 id="按照耗时进行过滤"><a href="#按照耗时进行过滤" class="headerlink" title="按照耗时进行过滤"></a>按照耗时进行过滤</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch demo.MathGame primeFactors &#39;&#123;params, returnObj&#125;&#39; &#39;#cost&gt;200&#39; -x 2</span><br></pre></td></tr></table></figure>

<p>按 <code>Q</code> 或者 <code>Ctrl+c</code> 退出</p>
<ul>
<li><code>#cost&gt;200</code> (单位是<code>ms</code> ) 表示只有当耗时大于 200ms 时才会输出，过滤掉执行时间小于 200ms 的调用</li>
</ul>
<h3 id="观察当前对象中的属性"><a href="#观察当前对象中的属性" class="headerlink" title="观察当前对象中的属性"></a>观察当前对象中的属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch demo.MathGame primeFactors &#39;target&#39;</span><br></pre></td></tr></table></figure>

<p>按 <code>Q</code> 或者 <code>Ctrl+c</code> 退出</p>
<p>如果想查看方法运行前后，当前对象中的属性，可以使用<code>target</code> 关键字，代表当前对象<br>然后使用<code>target.field_name</code> 访问当前对象的某个属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch demo.MathGame primeFactors &#39;target.illegalArgumentCount&#39;</span><br></pre></td></tr></table></figure>

<p>按 <code>Q</code> 或者 <code>Ctrl+c</code> 退出</p>
<h1 id="wc-命令"><a href="#wc-命令" class="headerlink" title="wc 命令"></a>wc 命令</h1><p>按行统计输出结果</p>
<p>通过 <code>jad demo.MathGame main</code> 输出 <code>demo.MathGame</code> 类的 <code>main</code> 方法</p>
<p>计算输出结果行数 <code>jad demo.MathGame main | wc -l</code></p>
<h1 id="memory-命令"><a href="#memory-命令" class="headerlink" title="memory 命令"></a>memory 命令</h1><p>查看 JVM 内存信息。</p>
<h2 id="使用参考-25"><a href="#使用参考-25" class="headerlink" title="使用参考"></a>使用参考</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ memory</span><br><span class="line">Memory                           used      total      max        usage</span><br><span class="line">heap                             32M       256M       4096M      0.79%</span><br><span class="line">g1_eden_space                    11M       68M        -1         16.18%</span><br><span class="line">g1_old_gen                       17M       184M       4096M      0.43%</span><br><span class="line">g1_survivor_space                4M        4M         -1         100.00%</span><br><span class="line">nonheap                          35M       39M        -1         89.55%</span><br><span class="line">codeheap_&#x27;non-nmethods&#x27;          1M        2M         5M         20.53%</span><br><span class="line">metaspace                        26M       27M        -1         96.88%</span><br><span class="line">codeheap_&#x27;profiled_nmethods&#x27;     4M        4M         117M       3.57%</span><br><span class="line">compressed_class_space           2M        3M         1024M      0.29%</span><br><span class="line">codeheap_&#x27;non-profiled_nmethods&#x27; 685K      2496K      120032K    0.57%</span><br><span class="line">mapped                           0K        0K         -          0.00%</span><br><span class="line">direct                           48M       48M        -          100.00%</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="auth-命令"><a href="#auth-命令" class="headerlink" title="auth 命令"></a>auth 命令</h1><blockquote>
<p>提示</p>
<p>验证当前会话</p>
</blockquote>
<h2 id="配置用户名和密码"><a href="#配置用户名和密码" class="headerlink" title="配置用户名和密码"></a>配置用户名和密码</h2><p>在 attach 时，可以在命令行指定密码。比如：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar --password ppp</span><br></pre></td></tr></table></figure>

<ul>
<li><p>可以通过 <code>--username</code> 选项来指定用户，默认值是<code>arthas</code>。</p>
</li>
<li><p>也可以在 <code>arthas.properties</code> 里中配置 username/password。命令行的优先级大于配置文件。</p>
</li>
<li><p>如果只配置<code>username</code>，没有配置<code>password</code>，则会生成随机密码，打印在<code>~/logs/arthas/arthas.log</code>中</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Using generated security password: 0vUBJpRIppkKuZ7dYzYqOKtranj4unGh</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="本地连接不鉴权"><a href="#本地连接不鉴权" class="headerlink" title="本地连接不鉴权"></a>本地连接不鉴权</h2><p>默认情况下，在<code>arthas.properties</code>文件里有配置：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arthas.localConnectionNonAuth=true</span><br></pre></td></tr></table></figure>

<p>当配置密码时，使用本地连接，也不需要鉴权。默认配置值是 true，方便本地连接使用。只有远程连接时，才需要鉴权。</p>
<h2 id="在-telnet-console-里鉴权"><a href="#在-telnet-console-里鉴权" class="headerlink" title="在 telnet console 里鉴权"></a>在 telnet console 里鉴权</h2><p>连接到 arthas 后，直接执行命令会提示需要鉴权：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@37430]$ <span class="built_in">help</span></span><br><span class="line">Error! <span class="built_in">command</span> not permitted, try to use <span class="string">&#x27;auth&#x27;</span> <span class="built_in">command</span> to authenticates.</span><br></pre></td></tr></table></figure>

<p>使用<code>auth</code>命令来鉴权，成功之后可以执行其它命令。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@37430]$ auth ppp</span><br><span class="line">Authentication result: true</span><br></pre></td></tr></table></figure>

<ul>
<li>可以通过 <code>--username</code> 选项来指定用户，默认值是<code>arthas</code>。</li>
</ul>
<h2 id="Web-console-密码验证"><a href="#Web-console-密码验证" class="headerlink" title="Web console 密码验证"></a>Web console 密码验证</h2><p>打开浏览器，会有弹窗提示需要输入 用户名 和 密码。</p>
<p>成功之后，则可以直接连接上 web console。</p>
<h2 id="HTTP-API-验证"><a href="#HTTP-API-验证" class="headerlink" title="HTTP API 验证"></a>HTTP API 验证</h2><h3 id="Authorization-Header-方式（推荐）"><a href="#Authorization-Header-方式（推荐）" class="headerlink" title="Authorization Header 方式（推荐）"></a>Authorization Header 方式（推荐）</h3><p>Arthas 采用的是 HTTP 标准的 Basic Authorization，客户端请求时增加对应的 header 即可。</p>
<ul>
<li>参考：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication">https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication在新窗口打开</a></li>
</ul>
<p>例如，用户名是：<code>admin</code>，密码是 <code>admin</code>，则组合为字符串： <code>admin:admin</code>，base64 结果是： <code>YWRtaW46YWRtaW4=</code>，则 HTTP 请求增加<code>Authorization</code> header：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;http://localhost:8563/api&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Authorization: Basic YWRtaW46YWRtaW4=&#x27;</span> \</span><br><span class="line">  --data-raw <span class="string">&#x27;&#123;&quot;action&quot;:&quot;exec&quot;,&quot;command&quot;:&quot;version&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="URL-参数传递方式"><a href="#URL-参数传递方式" class="headerlink" title="URL 参数传递方式"></a>URL 参数传递方式</h3><p>为了方便各种特殊情况，支持了以 parameters 方式传递 username 和 password。比如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;http://localhost:8563/api?password=admin&#x27;</span> \</span><br><span class="line">  --data-raw <span class="string">&#x27;&#123;&quot;action&quot;:&quot;exec&quot;,&quot;command&quot;:&quot;version&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/01/05/Arthas%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="wotzc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cai">
      <meta itemprop="description" content="真正的大师永远都怀着一颗学徒的心">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cai">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/05/Arthas%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B/" class="post-title-link" itemprop="url">Arthas进阶教程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-01-05 09:27:15" itemprop="dateCreated datePublished" datetime="2024-01-05T09:27:15+08:00">2024-01-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-10 15:25:05" itemprop="dateModified" datetime="2024-01-10T15:25:05+08:00">2024-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">Java诊断工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="查看-JVM-信息"><a href="#查看-JVM-信息" class="headerlink" title="查看 JVM 信息"></a>查看 JVM 信息</h1><p>下面介绍 Arthas 里查看 <code>JVM</code> 信息的命令。</p>
<h2 id="sysprop"><a href="#sysprop" class="headerlink" title="sysprop"></a>sysprop</h2><p><code>sysprop</code> 可以打印所有的 System Properties 信息。</p>
<div class="note info no-icon"><p>提示</p>
<p>查看当前 JVM 的系统属性( System Property )</p>
</div>

<h3 id="使用参考"><a href="#使用参考" class="headerlink" title="使用参考"></a>使用参考</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">USAGE:</span><br><span class="line">  sysprop [-h] [property-name] [property-value]</span><br><span class="line"></span><br><span class="line">SUMMARY:</span><br><span class="line">  Display, and change all the system properties.</span><br><span class="line"></span><br><span class="line">EXAMPLES:</span><br><span class="line">sysprop</span><br><span class="line">sysprop file.encoding</span><br><span class="line">sysprop production.mode true</span><br><span class="line"></span><br><span class="line">WIKI:</span><br><span class="line">  https://arthas.aliyun.com/doc/sysprop</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">-h, --help                                  this help</span><br><span class="line">&lt;property-name&gt;                             property name</span><br><span class="line">&lt;property-value&gt;                            property value</span><br></pre></td></tr></table></figure>

<h3 id="查看所有属性"><a href="#查看所有属性" class="headerlink" title="查看所有属性"></a>查看所有属性</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">$ sysprop</span><br><span class="line"> KEY                                                  VALUE</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> java.runtime.name                                    Java(TM) SE Runtime Environment</span><br><span class="line"> sun.boot.library.path                                /Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/lib</span><br><span class="line"> java.vm.version                                      25.51-b03</span><br><span class="line"> user.country.format                                  CN</span><br><span class="line"> gopherProxySet                                       false</span><br><span class="line"> java.vm.vendor                                       Oracle Corporation</span><br><span class="line"> java.vendor.url                                      http://java.oracle.com/</span><br><span class="line"> path.separator                                       :</span><br><span class="line"> java.vm.name                                         Java HotSpot(TM) 64-Bit Server VM</span><br><span class="line"> file.encoding.pkg                                    sun.io</span><br><span class="line"> user.country                                         US</span><br><span class="line"> sun.java.launcher                                    SUN_STANDARD</span><br><span class="line"> sun.os.patch.level                                   unknown</span><br><span class="line"> java.vm.specification.name                           Java Virtual Machine Specification</span><br><span class="line"> user.dir                                             /private/var/tmp</span><br><span class="line"> java.runtime.version                                 1.8.0_51-b16</span><br><span class="line"> java.awt.graphicsenv                                 sun.awt.CGraphicsEnvironment</span><br><span class="line"> java.endorsed.dirs                                   /Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/lib/endors</span><br><span class="line">                                                      ed</span><br><span class="line"> os.arch                                              x86_64</span><br><span class="line"> java.io.tmpdir                                       /var/folders/2c/tbxwzs4s4sbcvh7frbcc7n000000gn/T/</span><br><span class="line"> line.separator</span><br><span class="line"></span><br><span class="line"> java.vm.specification.vendor                         Oracle Corporation</span><br><span class="line"> os.name                                              Mac OS X</span><br><span class="line"> sun.jnu.encoding                                     UTF-8</span><br><span class="line"> java.library.path                                    /Users/wangtao/Library/Java/Extensions:/Library/Java/Extensions:/Network/Libra</span><br><span class="line">                                                      ry/Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java:.</span><br><span class="line"> sun.nio.ch.bugLevel</span><br><span class="line"> java.specification.name                              Java Platform API Specification</span><br><span class="line"> java.class.version                                   52.0</span><br><span class="line"> sun.management.compiler                              HotSpot 64-Bit Tiered Compilers</span><br><span class="line"> os.version                                           10.12.6</span><br><span class="line"> user.home                                            /Users/wangtao</span><br><span class="line"> user.timezone                                        Asia/Shanghai</span><br><span class="line"> java.awt.printerjob                                  sun.lwawt.macosx.CPrinterJob</span><br><span class="line"> file.encoding                                        UTF-8</span><br><span class="line"> java.specification.version                           1.8</span><br><span class="line"> user.name                                            wangtao</span><br><span class="line"> java.class.path                                      .</span><br><span class="line"> java.vm.specification.version                        1.8</span><br><span class="line"> sun.arch.data.model                                  64</span><br><span class="line"> java.home                                            /Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre</span><br><span class="line"> sun.java.command                                     Test</span><br><span class="line"> java.specification.vendor                            Oracle Corporation</span><br><span class="line"> user.language                                        en</span><br><span class="line"> awt.toolkit                                          sun.lwawt.macosx.LWCToolkit</span><br><span class="line"> java.vm.info                                         mixed mode</span><br><span class="line"> java.version                                         1.8.0_51</span><br><span class="line"> java.ext.dirs                                        /Users/wangtao/Library/Java/Extensions:/Library/Java/JavaVirtualMachines/jdk1.</span><br><span class="line">                                                      8.0_51.jdk/Contents/Home/jre/lib/ext:/Library/Java/Extensions:/Network/Library</span><br><span class="line">                                                      /Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java</span><br><span class="line"> sun.boot.class.path                                  /Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/lib/resour</span><br><span class="line">                                                      ces.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/li</span><br><span class="line">                                                      b/rt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/l</span><br><span class="line">                                                      ib/sunrsasign.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/H</span><br><span class="line">                                                      ome/jre/lib/jsse.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Content</span><br><span class="line">                                                      s/Home/jre/lib/jce.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Conte</span><br><span class="line">                                                      nts/Home/jre/lib/charsets.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jd</span><br><span class="line">                                                      k/Contents/Home/jre/lib/jfr.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.</span><br><span class="line">                                                      jdk/Contents/Home/jre/classes</span><br><span class="line"> java.vendor                                          Oracle Corporation</span><br><span class="line"> file.separator                                       /</span><br><span class="line"> java.vendor.url.bug                                  http://bugreport.sun.com/bugreport/</span><br><span class="line"> sun.cpu.endian                                       little</span><br><span class="line"> sun.io.unicode.encoding                              UnicodeBig</span><br><span class="line"> sun.cpu.isalist</span><br></pre></td></tr></table></figure>

<h3 id="查看单个属性"><a href="#查看单个属性" class="headerlink" title="查看单个属性"></a>查看单个属性</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sysprop java.version</span><br><span class="line">java.version=1.8.0_51</span><br></pre></td></tr></table></figure>

<h3 id="修改单个属性"><a href="#修改单个属性" class="headerlink" title="修改单个属性"></a>修改单个属性</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sysprop user.country</span><br><span class="line">user.country=US</span><br><span class="line">$ sysprop user.country CN</span><br><span class="line">Successfully changed the system property.</span><br><span class="line">user.country=CN</span><br></pre></td></tr></table></figure>

<h2 id="sysenv"><a href="#sysenv" class="headerlink" title="sysenv"></a>sysenv</h2><p><code>sysenv</code> 命令可以获取到环境变量。和<code>sysprop</code> 命令类似。</p>
<div class="note info no-icon"><p>提示</p>
<p>查看当前 JVM 的环境属性( System Environment Variables )</p>
</div>

<h3 id="使用参考-1"><a href="#使用参考-1" class="headerlink" title="使用参考"></a>使用参考</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">USAGE:</span><br><span class="line">  sysenv [-h] [env-name]</span><br><span class="line"></span><br><span class="line">SUMMARY:</span><br><span class="line">  Display the system env.</span><br><span class="line"></span><br><span class="line">EXAMPLES:</span><br><span class="line">  sysenv</span><br><span class="line">  sysenv USER</span><br><span class="line"></span><br><span class="line">WIKI:</span><br><span class="line">  https://arthas.aliyun.com/doc/sysenv</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">-h, --help                                                 this help</span><br><span class="line">&lt;env-name&gt;                                                 env name</span><br></pre></td></tr></table></figure>

<h3 id="查看所有环境变量"><a href="#查看所有环境变量" class="headerlink" title="查看所有环境变量"></a>查看所有环境变量</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ sysenv</span><br><span class="line"> KEY                      VALUE</span><br><span class="line">----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> PATH                     /Users/admin/.sdkman/candidates/visualvm/current/bin:/Users/admin/.sdkman/candidates/ja</span><br><span class="line">                          va/current/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Applications/Wireshark.app/Contents/</span><br><span class="line">                          MacOS</span><br><span class="line"> SDKMAN_VERSION           5.7.3+337</span><br><span class="line"> JAVA_HOME                /Users/admin/.sdkman/candidates/java/current</span><br><span class="line"> JAVA_MAIN_CLASS_65244    demo.MathGame</span><br><span class="line"> TERM                     xterm-256color</span><br><span class="line"> LANG                     zh_CN.UTF-8</span><br><span class="line"> AUTOJUMP_SOURCED         1</span><br><span class="line"> COLORTERM                truecolor</span><br><span class="line"> LOGNAME                  admin</span><br><span class="line"> XPC_SERVICE_NAME         0</span><br><span class="line"> PWD                      /Users/admin/code/ali/arthas/demo</span><br><span class="line"> TERM_PROGRAM_VERSION     3.2.5</span><br><span class="line"> _                        /Users/admin/.sdkman/candidates/java/current/bin/java</span><br><span class="line"> SHELL                    /bin/bash</span><br><span class="line"> TERM_PROGRAM             iTerm.app</span><br><span class="line"> SDKMAN_PLATFORM          Darwin</span><br><span class="line"> USER                     admin</span><br><span class="line"> ITERM_PROFILE            Default</span><br><span class="line"> TMPDIR                   /var/folders/0r/k561bkk917gg972stqclbz9h0000gn/T/</span><br><span class="line"> XPC_FLAGS                0x0</span><br><span class="line"> TERM_SESSION_ID          w0t4p0:60BC264D-9649-42AC-A7E4-AF85B69F93F8</span><br><span class="line"> __CF_USER_TEXT_ENCODING  0x1F5:0x19:0x34</span><br><span class="line"> Apple_PubSub_Socket_Ren  /private/tmp/com.apple.launchd.DwmmjSQsll/Render</span><br><span class="line"> der</span><br><span class="line"> COLORFGBG                7;0</span><br><span class="line"> HOME                     /Users/admin</span><br><span class="line"> SHLVL                    1</span><br><span class="line"> AUTOJUMP_ERROR_PATH      /Users/admin/Library/autojump/errors.log</span><br></pre></td></tr></table></figure>

<h3 id="查看单个环境变量"><a href="#查看单个环境变量" class="headerlink" title="查看单个环境变量"></a>查看单个环境变量</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sysenv USER</span><br><span class="line">USER=admin</span><br></pre></td></tr></table></figure>

<h2 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h2><p><code>jvm</code> 命令会打印出<code>JVM</code> 的各种详细信息。</p>
<div class="note info no-icon"><p>提示</p>
<p>查看当前 JVM 信息</p>
</div>

<h3 id="使用参考-2"><a href="#使用参考-2" class="headerlink" title="使用参考"></a>使用参考</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">$ jvm</span><br><span class="line">RUNTIME</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> MACHINE-NAME                   37@ff267334bb65</span><br><span class="line"> JVM-START-TIME                 2020-07-23 07:50:36</span><br><span class="line"> MANAGEMENT-SPEC-VERSION        1.2</span><br><span class="line"> SPEC-NAME                      Java Virtual Machine Specification</span><br><span class="line"> SPEC-VENDOR                    Oracle Corporation</span><br><span class="line"> SPEC-VERSION                   1.8</span><br><span class="line"> VM-NAME                        Java HotSpot(TM) 64-Bit Server VM</span><br><span class="line"> VM-VENDOR                      Oracle Corporation</span><br><span class="line"> VM-VERSION                     25.201-b09</span><br><span class="line"> INPUT-ARGUMENTS                []</span><br><span class="line"> CLASS-PATH                     demo-arthas-spring-boot.jar</span><br><span class="line"> BOOT-CLASS-PATH                /usr/lib/jvm/java-8-oracle/jre/lib/resources.jar:/usr/lib/jvm/java-8-oracle/j</span><br><span class="line">                                re/lib/rt.jar:/usr/lib/jvm/java-8-oracle/jre/lib/sunrsasign.jar:/usr/lib/jvm/</span><br><span class="line">                                java-8-oracle/jre/lib/jsse.jar:/usr/lib/jvm/java-8-oracle/jre/lib/jce.jar:/us</span><br><span class="line">                                r/lib/jvm/java-8-oracle/jre/lib/charsets.jar:/usr/lib/jvm/java-8-oracle/jre/l</span><br><span class="line">                                ib/jfr.jar:/usr/lib/jvm/java-8-oracle/jre/classes</span><br><span class="line"> LIBRARY-PATH                   /usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> CLASS-LOADING</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> LOADED-CLASS-COUNT             7529</span><br><span class="line"> TOTAL-LOADED-CLASS-COUNT       7529</span><br><span class="line"> UNLOADED-CLASS-COUNT           0</span><br><span class="line"> IS-VERBOSE                     false</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> COMPILATION</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> NAME                           HotSpot 64-Bit Tiered Compilers</span><br><span class="line"> TOTAL-COMPILE-TIME             14921(ms)</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> GARBAGE-COLLECTORS</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> PS Scavenge                            name : PS Scavenge</span><br><span class="line"> [count/time (ms)]                      collectionCount : 7</span><br><span class="line">                                        collectionTime : 68</span><br><span class="line"></span><br><span class="line"> PS MarkSweep                           name : PS MarkSweep</span><br><span class="line"> [count/time (ms)]                      collectionCount : 1</span><br><span class="line">                                        collectionTime : 47</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> MEMORY-MANAGERS</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> CodeCacheManager               Code Cache</span><br><span class="line"></span><br><span class="line"> Metaspace Manager              Metaspace</span><br><span class="line">                                Compressed Class Space</span><br><span class="line"></span><br><span class="line"> Copy                           Eden Space</span><br><span class="line">                                Survivor Space</span><br><span class="line"></span><br><span class="line"> MarkSweepCompact               Eden Space</span><br><span class="line">                                Survivor Space</span><br><span class="line">                                Tenured Gen</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> MEMORY</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> HEAP-MEMORY-USAGE                      init : 268435456(256.0 MiB)</span><br><span class="line"> [memory in bytes]                      used : 18039504(17.2 MiB)</span><br><span class="line">                                        committed : 181403648(173.0 MiB)</span><br><span class="line">                                        max : 3817865216(3.6 GiB)</span><br><span class="line"></span><br><span class="line"> NO-HEAP-MEMORY-USAGE                   init : 2555904(2.4 MiB)</span><br><span class="line"> [memory in bytes]                      used : 33926216(32.4 MiB)</span><br><span class="line">                                        committed : 35176448(33.5 MiB)</span><br><span class="line">                                        max : -1(-1 B)</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> OPERATING-SYSTEM</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> OS                             Linux</span><br><span class="line"> ARCH                           amd64</span><br><span class="line"> PROCESSORS-COUNT               3</span><br><span class="line"> LOAD-AVERAGE                   29.53</span><br><span class="line"> VERSION                        4.15.0-52-generic</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> THREAD</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> COUNT                          30</span><br><span class="line"> DAEMON-COUNT                   24</span><br><span class="line"> PEAK-COUNT                     31</span><br><span class="line"> STARTED-COUNT                  36</span><br><span class="line"> DEADLOCK-COUNT                 0</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> FILE-DESCRIPTOR</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> MAX-FILE-DESCRIPTOR-COUNT      1048576</span><br><span class="line"> OPEN-FILE-DESCRIPTOR-COUNT     100</span><br><span class="line">Affect(row-cnt:0) cost in 88 ms.</span><br></pre></td></tr></table></figure>

<h3 id="THREAD-相关"><a href="#THREAD-相关" class="headerlink" title="THREAD 相关"></a>THREAD 相关</h3><ul>
<li><code>COUNT</code>: JVM 当前活跃的线程数</li>
<li><code>DAEMON-COUNT</code>: JVM 当前活跃的守护线程数</li>
<li><code>PEAK-COUNT</code>: 从 JVM 启动开始曾经活着的最大线程数</li>
<li><code>STARTED-COUNT</code>: 从 JVM 启动开始总共启动过的线程次数</li>
<li><code>DEADLOCK-COUNT</code>: JVM 当前死锁的线程数</li>
</ul>
<h3 id="文件描述符相关"><a href="#文件描述符相关" class="headerlink" title="文件描述符相关"></a>文件描述符相关</h3><ul>
<li><code>MAX-FILE-DESCRIPTOR-COUNT</code>：JVM 进程最大可以打开的文件描述符数</li>
<li><code>OPEN-FILE-DESCRIPTOR-COUNT</code>：JVM 当前打开的文件描述符数</li>
</ul>
<hr>
<h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>为了更好使用 Arthas，下面先介绍 Arthas 里的一些使用技巧。</p>
<h2 id="help"><a href="#help" class="headerlink" title="help"></a>help</h2><p>Arthas 里每一个命令都有详细的帮助信息。可以用<code>-h</code> 来查看。帮助信息里有<code>EXAMPLES</code> 和<code>WIKI</code> 链接。</p>
<p>比如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysprop -h</span><br></pre></td></tr></table></figure>

<h2 id="自动补全"><a href="#自动补全" class="headerlink" title="自动补全"></a>自动补全</h2><p><code>Arthas</code> 支持丰富的自动补全功能，在使用有疑惑时，可以输入<code>Tab</code> 来获取更多信息。</p>
<p>比如输入 <code>sysprop java.</code> 之后，再输入<code>Tab</code> ，会补全出对应的 key。</p>
<h2 id="readline-的快捷键支持"><a href="#readline-的快捷键支持" class="headerlink" title="readline 的快捷键支持"></a>readline 的快捷键支持</h2><p><code>Arthas</code> 支持常见的命令行快捷键，比如<code>Ctrl + A</code> 跳转行首，<code>Ctrl + E</code> 跳转行尾。</p>
<p>更多的快捷键可以用 <code>keymap</code> 命令查看。</p>
<h2 id="历史命令的补全"><a href="#历史命令的补全" class="headerlink" title="历史命令的补全"></a>历史命令的补全</h2><p>如果想再执行之前的命令，可以在输入一半时，按<code>Up/↑</code> 或者 <code>Ddown/↓</code> ，来匹配到之前的命令。</p>
<p>比如之前执行过<code>sysprop java.version</code> ，那么在输入<code>sysprop ja</code> 之后，可以输入<code>Up/↑</code> ，就会自动补全为<code>sysprop java.version</code> 。</p>
<p>如果想查看所有的历史命令，也可以通过 <code>history</code> 命令查看到。</p>
<h2 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h2><p><code>Arthas</code> 支持在 <code>pipeline</code> 之后，执行一些简单的命令，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sysprop | grep java</span><br><span class="line">sysprop | wc -l</span><br></pre></td></tr></table></figure>

<h1 id="Sc-sm-查看已加载的类"><a href="#Sc-sm-查看已加载的类" class="headerlink" title="Sc/sm 查看已加载的类"></a>Sc/sm 查看已加载的类</h1><p>下面介绍 <code>Arthas</code> 里查找已加载类的命令。</p>
<h2 id="Sc"><a href="#Sc" class="headerlink" title="Sc"></a>Sc</h2><p><code>sc</code> 命令可以查找到所有 JVM 已经加载到的类。</p>
<p>如果搜索的是接口，还会搜索所有的实现类。比如查看所有的<code>Filter</code> 实现类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc javax.servlet.Filter</span><br></pre></td></tr></table></figure>

<p>通过<code>-d</code> 参数，可以打印出类加载的具体信息，很方便查找类加载问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc -d javax.servlet.Filter</span><br></pre></td></tr></table></figure>

<p><code>sc</code> 支持通配，比如搜索所有的<code>StringUtils</code> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc *StringUtils</span><br></pre></td></tr></table></figure>

<h2 id="sm"><a href="#sm" class="headerlink" title="sm"></a>sm</h2><div class="note info no-icon"><p>提示</p>
<p>查看已加载类的方法信息</p>
</div>

<p>“Search-Method” 的简写，这个命令能搜索出所有已经加载了 Class 信息的方法信息。</p>
<p><code>sm</code> 命令只能看到由当前类所声明 (declaring) 的方法，父类则无法看到。</p>
<h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>class-pattern</em></td>
<td align="left">类名表达式匹配</td>
</tr>
<tr>
<td align="right"><em>method-pattern</em></td>
<td align="left">方法名表达式匹配</td>
</tr>
<tr>
<td align="right">[d]</td>
<td align="left">展示每个方法的详细信息</td>
</tr>
<tr>
<td align="right">[E]</td>
<td align="left">开启正则表达式匹配，默认为通配符匹配</td>
</tr>
<tr>
<td align="right"><code>[c:]</code></td>
<td align="left">指定 class 的 ClassLoader 的 hashcode</td>
</tr>
<tr>
<td align="right"><code>[classLoaderClass:]</code></td>
<td align="left">指定执行表达式的 ClassLoader 的 class name</td>
</tr>
<tr>
<td align="right"><code>[n:]</code></td>
<td align="left">具有详细信息的匹配类的最大数量（默认为 100）</td>
</tr>
</tbody></table>
<h3 id="使用参考-3"><a href="#使用参考-3" class="headerlink" title="使用参考"></a>使用参考</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ sm java.lang.String</span><br><span class="line">java.lang.String-&gt;&lt;init&gt;</span><br><span class="line">java.lang.String-&gt;equals</span><br><span class="line">java.lang.String-&gt;toString</span><br><span class="line">java.lang.String-&gt;hashCode</span><br><span class="line">java.lang.String-&gt;compareTo</span><br><span class="line">java.lang.String-&gt;indexOf</span><br><span class="line">java.lang.String-&gt;valueOf</span><br><span class="line">java.lang.String-&gt;checkBounds</span><br><span class="line">java.lang.String-&gt;length</span><br><span class="line">java.lang.String-&gt;isEmpty</span><br><span class="line">java.lang.String-&gt;charAt</span><br><span class="line">java.lang.String-&gt;codePointAt</span><br><span class="line">java.lang.String-&gt;codePointBefore</span><br><span class="line">java.lang.String-&gt;codePointCount</span><br><span class="line">java.lang.String-&gt;offsetByCodePoints</span><br><span class="line">java.lang.String-&gt;getChars</span><br><span class="line">java.lang.String-&gt;getBytes</span><br><span class="line">java.lang.String-&gt;contentEquals</span><br><span class="line">java.lang.String-&gt;nonSyncContentEquals</span><br><span class="line">java.lang.String-&gt;equalsIgnoreCase</span><br><span class="line">java.lang.String-&gt;compareToIgnoreCase</span><br><span class="line">java.lang.String-&gt;regionMatches</span><br><span class="line">java.lang.String-&gt;startsWith</span><br><span class="line">java.lang.String-&gt;endsWith</span><br><span class="line">java.lang.String-&gt;indexOfSupplementary</span><br><span class="line">java.lang.String-&gt;lastIndexOf</span><br><span class="line">java.lang.String-&gt;lastIndexOfSupplementary</span><br><span class="line">java.lang.String-&gt;substring</span><br><span class="line">java.lang.String-&gt;subSequence</span><br><span class="line">java.lang.String-&gt;concat</span><br><span class="line">java.lang.String-&gt;replace</span><br><span class="line">java.lang.String-&gt;matches</span><br><span class="line">java.lang.String-&gt;contains</span><br><span class="line">java.lang.String-&gt;replaceFirst</span><br><span class="line">java.lang.String-&gt;replaceAll</span><br><span class="line">java.lang.String-&gt;split</span><br><span class="line">java.lang.String-&gt;join</span><br><span class="line">java.lang.String-&gt;toLowerCase</span><br><span class="line">java.lang.String-&gt;toUpperCase</span><br><span class="line">java.lang.String-&gt;trim</span><br><span class="line">java.lang.String-&gt;toCharArray</span><br><span class="line">java.lang.String-&gt;format</span><br><span class="line">java.lang.String-&gt;copyValueOf</span><br><span class="line">java.lang.String-&gt;intern</span><br><span class="line">Affect(row-cnt:44) cost <span class="keyword">in</span> 1342 ms.</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sm -d java.lang.String toString</span><br><span class="line"> declaring-class  java.lang.String</span><br><span class="line"> method-name      toString</span><br><span class="line"> modifier         public</span><br><span class="line"> annotation</span><br><span class="line"> parameters</span><br><span class="line"> <span class="built_in">return</span>           java.lang.String</span><br><span class="line"> exceptions</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 3 ms.</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Jad"><a href="#Jad" class="headerlink" title="Jad"></a>Jad</h1><p>可以通过 <code>jad</code> 命令来反编译代码：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jad com.example.demo.arthas.user.UserController</span><br></pre></td></tr></table></figure>

<p>通过<code>--source-only</code> 参数可以只打印出在反编译的源代码：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jad --source-only com.example.demo.arthas.user.UserController</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="OGNL"><a href="#OGNL" class="headerlink" title="OGNL"></a>OGNL</h1><h2 id="OGNL-一般语法"><a href="#OGNL-一般语法" class="headerlink" title="OGNL 一般语法"></a>OGNL 一般语法</h2><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><ul>
<li><p>数组和列表的索引，可以使用 <code>array[&quot;length&quot;]</code></p>
</li>
<li><p>JavaBeans 索引属性</p>
<p>如一个 JavaBeans 有以下四个重载方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PropertyType[] getPropertyName();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyName</span><span class="params">(PropertyType[] anArray)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> PropertyType <span class="title">getPropertyName</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyName</span><span class="params">(<span class="keyword">int</span> index, PropertyType value)</span></span>;</span><br></pre></td></tr></table></figure>

<p>则</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">someProperty[2]</span><br></pre></td></tr></table></figure>

<p>等价于 Java 代码的</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getPropertyName(2)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl <span class="string">&quot;&#123;1,2,3,4&#125;[0]&quot;</span></span><br></pre></td></tr></table></figure>

<p>通过上面命令可以获取到列表的第一个元素</p>
<h3 id="变量引用"><a href="#变量引用" class="headerlink" title="变量引用"></a>变量引用</h3><p>使用 <code>#</code> 在 OGNL 中定义临时变量，他们全局可见，此外表达式计算的每一步结果都保存在变量 <code>this</code> 中：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl <span class="string">&quot;&#123;10,20,30&#125;[0].(#this &gt; 5 ? #this*2 : #this+10)&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面命令通过获取列表的第一个元素进行判断，如果大于 <code>5</code> 则乘以 <code>2</code> 反之则加 <code>10</code> 。</p>
<h3 id="方法调用"><a href="#方法调用" class="headerlink" title="方法调用"></a>方法调用</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method( ensureLoaded(), name )</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>OGNL 是运行时调用，因此没有任何静态类型的信息可以参考，所以如果解析到有多个匹配的方法，则任选其中一个方法调用</li>
<li>常量 null 可以匹配所有的非原始类型的对象</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl <span class="string">&quot;&#123;1,2,3,4&#125;.size()&quot;</span></span><br></pre></td></tr></table></figure>

<p>通过上面命令可以调用 <code>ArrayList</code> 的 <code>size()</code> 方法获取到 ArrayList 的大小</p>
<h3 id="复杂链式表达式"><a href="#复杂链式表达式" class="headerlink" title="复杂链式表达式"></a>复杂链式表达式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">headline.parent.(ensureLoaded(), name)</span><br></pre></td></tr></table></figure>

<p>等价于</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">headline.parent.ensureLoaded(), headline.parent.name</span><br><span class="line">ognl <span class="string">&quot;@java.lang.System@out.(print(&#x27;Hello &#x27;), print(&#x27;world\n&#x27;))&quot;</span></span><br></pre></td></tr></table></figure>

<p>运行上面这个命令后，你可以在 Tab1 的终端看到 <code>Hello world</code> 的输出。</p>
<h3 id="集合操作"><a href="#集合操作" class="headerlink" title="集合操作"></a>集合操作</h3><h4 id="新建列表"><a href="#新建列表" class="headerlink" title="新建列表"></a>新建列表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;1 in &#123;2, 3&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>上面这条命令判断 <code>1</code> 是否在列表 <code>[2, 3]</code> 中。</p>
<h4 id="新建原生数组"><a href="#新建原生数组" class="headerlink" title="新建原生数组"></a>新建原生数组</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;new int[] &#123;1, 2, 3&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>指定长度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;new int[9]&quot;</span><br></pre></td></tr></table></figure>

<h4 id="新建-Maps"><a href="#新建-Maps" class="headerlink" title="新建 Maps"></a>新建 Maps</h4><p>新建普通 Map</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;#&#123; &#39;foo&#39;: &#39;foo value&#39;, &#39;bar&#39;: &#39;bar value&#39; &#125;&quot;</span><br></pre></td></tr></table></figure>

<p>新建特定类型 Map</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;#@java.util.HashMap@&#123; &#39;foo&#39;: &#39;foo value&#39;, &#39;bar&#39;: &#39;bar value&#39; &#125;&quot;</span><br></pre></td></tr></table></figure>

<h4 id="集合的投影"><a href="#集合的投影" class="headerlink" title="集合的投影"></a>集合的投影</h4><p>OGNL 把对针对集合上的每个元素调用同一个方法并返回新的集合的行为称之为“投影”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;&#123;1, 2, 3&#125;.&#123;#this*2&#125;&quot;</span><br></pre></td></tr></table></figure>

<h4 id="查找集合元素"><a href="#查找集合元素" class="headerlink" title="查找集合元素"></a>查找集合元素</h4><ul>
<li>查找所有匹配的元素<br><code>ognl &quot;&#123;1024, &#39;Hello world!&#39;, true, 2048&#125;.&#123;? #this instanceof Number&#125;&quot;</code></li>
<li>查找第一个匹配的元素<br><code>ognl &quot;&#123;1024, &#39;Hello world!&#39;, true, 2048&#125;.&#123;^ #this instanceof Number&#125;&quot;</code></li>
<li>查找最后一个匹配的元素<br><code>ognl &quot;&#123;1024, &#39;Hello world!&#39;, true, 2048&#125;.&#123;$ #this instanceof Number&#125;&quot;</code></li>
</ul>
<h4 id="集合的虚拟属性"><a href="#集合的虚拟属性" class="headerlink" title="集合的虚拟属性"></a>集合的虚拟属性</h4><p>OGNL 定义了一些特定的集合属性，含义与相应的 Java 集合方法完全等价。</p>
<ul>
<li><code>Collections</code><ul>
<li><code>size</code> 集合大小</li>
<li><code>isEmpty</code> 集合为空时返回 <code>true</code></li>
</ul>
</li>
<li><code>List</code><ul>
<li><code>iterator</code> 返回 List 的 iterator</li>
</ul>
</li>
<li><code>Map</code><ul>
<li><code>keys</code> 返回 Map 的所有 Key 值</li>
<li><code>values</code> 返回 Map 的所有 Value 值</li>
</ul>
</li>
<li><code>Set</code><ul>
<li><code>iterator</code> 返回 Set 的 iterator</li>
</ul>
</li>
</ul>
<h4 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h4><p>非 <code>java.lang</code> 包下的所有类的构造函数都要用类的权限定名称。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;new java.util.ArrayList()&quot;</span><br></pre></td></tr></table></figure>

<h4 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl -x 3 &#39;@java.lang.Math@sqrt(9.0D)&#39;</span><br></pre></td></tr></table></figure>

<h4 id="静态属性"><a href="#静态属性" class="headerlink" title="静态属性"></a>静态属性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl -x 3 &#39;@java.io.File@separator&#39;</span><br></pre></td></tr></table></figure>

<h4 id="伪-lambda-表达式"><a href="#伪-lambda-表达式" class="headerlink" title="伪 lambda 表达式"></a>伪 lambda 表达式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;#fact &#x3D; :[#this&lt;&#x3D;1? 1 : #this*#fact(#this-1)], #fact(3)&quot;</span><br></pre></td></tr></table></figure>

<p>该命令实现了一个 lambda 递归实现了一个阶乘函数，并求 3 的阶乘。</p>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>更多详细语法请查看<a target="_blank" rel="noopener" href="https://commons.apache.org/proper/commons-ognl/language-guide.html">官方文档</a>。</p>
<h2 id="Arthas-OGNL"><a href="#Arthas-OGNL" class="headerlink" title="Arthas-OGNL"></a>Arthas-OGNL</h2><p>在 Arthas 里，有一个单独的 ognl 命令，可以动态执行代码。</p>
<h3 id="调用-static-函数"><a href="#调用-static-函数" class="headerlink" title="调用 static 函数"></a>调用 static 函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &#39;@java.lang.System@out.println(&quot;hello ognl&quot;)&#39;</span><br></pre></td></tr></table></figure>

<h3 id="查找-UserController-的-ClassLoader"><a href="#查找-UserController-的-ClassLoader" class="headerlink" title="查找 UserController 的 ClassLoader"></a>查找 UserController 的 ClassLoader</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc -d com.example.demo.arthas.user.UserController | grep classLoaderHash</span><br></pre></td></tr></table></figure>

<p>注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，提取对应 ClassLoader 的 hashcode。<br>如果你使用<code>-c</code> ，你需要手动输入由上述命令获取到的 hashcode：<code>-c &lt;hashcode&gt;</code><br>对于只有唯一实例的 ClassLoader 可以通过<code>--classLoaderClass</code> 指定 class name，使用起来更加方便：<br><code>--classLoaderClass</code> 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code> 是动态变化的。</p>
<h3 id="获取静态类的静态字段"><a href="#获取静态类的静态字段" class="headerlink" title="获取静态类的静态字段"></a>获取静态类的静态字段</h3><p>获取<code>CRBCMsgAdapterController</code> 类里的<code>logger</code> 字段：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[arthas@9012]$ ognl -c 18b4aac2 @com.crb.adaptor.controller.CRBCMsgAdapterController@logger</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID=@Long[5454405123156820674],</span><br><span class="line">    FQCN=@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name=@String[com.crb.adaptor.controller.CRBCMsgAdapterController],</span><br><span class="line">    level=null,</span><br><span class="line">    effectiveLevelInt=@Integer[20000],</span><br><span class="line">    parent=@Logger[Logger[com.crb.adaptor.controller]],</span><br><span class="line">    childrenList=null,</span><br><span class="line">    aai=null,</span><br><span class="line">    additive=@Boolean[<span class="literal">true</span>],</span><br><span class="line">    loggerContext=@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>还可以通过<code>-x</code> 参数控制返回值的展开层数。比如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[arthas@9012]$ ognl c 18b4aacc2 -x 2 @com.crb.adaptor.controller.CRBCMsgAdapterController@logger</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID=@Long[5454405123156820674],</span><br><span class="line">    FQCN=@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name=@String[com.crb.adaptor.controller.CRBCMsgAdapterController],</span><br><span class="line">    level=null,</span><br><span class="line">    effectiveLevelInt=@Integer[20000],</span><br><span class="line">    parent=@Logger[</span><br><span class="line">        serialVersionUID=@Long[5454405123156820674],</span><br><span class="line">        FQCN=@String[ch.qos.logback.classic.Logger],</span><br><span class="line">        name=@String[com.crb.adaptor.controller],</span><br><span class="line">        level=null,</span><br><span class="line">        effectiveLevelInt=@Integer[20000],</span><br><span class="line">        parent=@Logger[Logger[com.crb.adaptor]],</span><br><span class="line">        childrenList=@CopyOnWriteArrayList[isEmpty=<span class="literal">false</span>;size=1],</span><br><span class="line">        aai=null,</span><br><span class="line">        additive=@Boolean[<span class="literal">true</span>],</span><br><span class="line">        loggerContext=@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">    ],</span><br><span class="line">    childrenList=null,</span><br><span class="line">    aai=null,</span><br><span class="line">    additive=@Boolean[<span class="literal">true</span>],</span><br><span class="line">    loggerContext=@LoggerContext[</span><br><span class="line">        DEFAULT_PACKAGING_DATA=@Boolean[<span class="literal">false</span>],</span><br><span class="line">        root=@Logger[Logger[ROOT]],</span><br><span class="line">        size=@Integer[416],</span><br><span class="line">        noAppenderWarning=@Integer[2],</span><br><span class="line">        loggerContextListenerList=@ArrayList[isEmpty=<span class="literal">false</span>;size=1],</span><br><span class="line">        loggerCache=@ConcurrentHashMap[isEmpty=<span class="literal">false</span>;size=416],</span><br><span class="line">        loggerContextRemoteView=@LoggerContextVO[LoggerContextVO&#123;name=<span class="string">&#x27;default&#x27;</span>, propertyMap=&#123;PORT=8610, APPLICATION_NAME=core-tf-application&#125;, birthTime=1704438833539&#125;],</span><br><span class="line">        turboFilterList=@TurboFilterList[isEmpty=<span class="literal">true</span>;size=0],</span><br><span class="line">        packagingDataEnabled=@Boolean[<span class="literal">false</span>],</span><br><span class="line">        maxCallerDataDepth=@Integer[8],</span><br><span class="line">        resetCount=@Integer[2],</span><br><span class="line">        frameworkPackages=@ArrayList[isEmpty=<span class="literal">true</span>;size=0],</span><br><span class="line">        birthTime=@Long[1704438833539],</span><br><span class="line">        name=@String[default],</span><br><span class="line">        sm=@BasicStatusManager[ch.qos.logback.core.BasicStatusManager@2eb37a8d],</span><br><span class="line">        propertyMap=@HashMap[isEmpty=<span class="literal">false</span>;size=2],</span><br><span class="line">        objectMap=@HashMap[isEmpty=<span class="literal">false</span>;size=7],</span><br><span class="line">        configurationLock=@LogbackLock[ch.qos.logback.core.spi.LogbackLock@1db45c81],</span><br><span class="line">        scheduledExecutorService=@ScheduledThreadPoolExecutor[java.util.concurrent.ScheduledThreadPoolExecutor@ac21a5d[Running, pool size = 8, active threads = 0, queued tasks = 1, completed tasks = 28]],</span><br><span class="line">        scheduledFutures=@ArrayList[isEmpty=<span class="literal">false</span>;size=1],</span><br><span class="line">        lifeCycleManager=@LifeCycleManager[ch.qos.logback.core.LifeCycleManager@74197f30],</span><br><span class="line">        started=@Boolean[<span class="literal">false</span>],</span><br><span class="line">    ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="执行多行表达式，赋值给临时变量，返回一个-List"><a href="#执行多行表达式，赋值给临时变量，返回一个-List" class="headerlink" title="执行多行表达式，赋值给临时变量，返回一个 List"></a>执行多行表达式，赋值给临时变量，返回一个 List</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ognl <span class="string">&#x27;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#x27;</span></span><br><span class="line">@ArrayList[</span><br><span class="line">    @String[/opt/java/8.0.181-zulu/jre],</span><br><span class="line">    @String[OpenJDK Runtime Environment],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h3><p>在 Arthas 里<code>ognl</code> 表达式是很重要的功能，在很多命令里都可以使用<code>ognl</code> 表达式。</p>
<p>一些更复杂的用法，可以参考：</p>
<ul>
<li>OGNL 特殊用法请参考：<a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/71">https://github.com/alibaba/arthas/issues/71</a></li>
<li>OGNL 表达式官方指南：<a target="_blank" rel="noopener" href="https://commons.apache.org/proper/commons-ognl/language-guide.html">https://commons.apache.org/proper/commons-ognl/language-guide.html</a></li>
</ul>
<hr>
<h1 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h1><p>在 Arthas 里有一些开关，可以通过 <code>options</code> 命令来查看 。</p>
<h2 id="查看所有的-options"><a href="#查看所有的-options" class="headerlink" title="查看所有的 options"></a>查看所有的 options</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ options</span><br><span class="line"> LEVEL  TYPE    NAME          VALUE   SUMMARY               DESCRIPTION</span><br><span class="line">-------------------------------------------------------------------------------------------------------</span><br><span class="line"> 0      boolea  unsafe        <span class="literal">false</span>   Option to support sy  This option enables to proxy functionality</span><br><span class="line">        n                             stem-level class       of JVM classes. Due to serious security r</span><br><span class="line">                                                            isk a JVM crash is possibly be introduced.</span><br><span class="line">                                                             Do not activate it unless you are able to</span><br><span class="line">                                                             manage.</span><br><span class="line"> 1      boolea  dump          <span class="literal">false</span>   Option to dump the e  This option enables the enhanced classes t</span><br><span class="line">        n                             nhanced classes       o be dumped to external file <span class="keyword">for</span> further d</span><br><span class="line">                                                            e-compilation and analysis.</span><br><span class="line"> 1      boolea  batch-re-tra  <span class="literal">true</span>    Option to support ba  This options enables to reTransform classe</span><br><span class="line">        n       nsform                tch reTransform Clas  s with batch mode.</span><br><span class="line">                                      s</span><br><span class="line"> 2      boolea  json-format   <span class="literal">false</span>   Option to support JS  This option enables to format object outpu</span><br><span class="line">        n                             ON format of object   t with JSON when -x option selected.</span><br><span class="line">                                      output</span><br><span class="line"> 1      boolea  disable-sub-  <span class="literal">false</span>   Option to control <span class="keyword">in</span>  This option <span class="built_in">disable</span> to include sub class w</span><br><span class="line">        n       class                 clude sub class when  hen matching class.</span><br><span class="line">                                       class matching</span><br><span class="line"> 1      boolea  support-defa  <span class="literal">true</span>    Option to control <span class="keyword">in</span>  This option <span class="built_in">disable</span> to include default met</span><br><span class="line">        n       ult-method            clude default method  hod <span class="keyword">in</span> interface when matching class.</span><br><span class="line">                                       <span class="keyword">in</span> interface when c</span><br><span class="line">                                      lass matching</span><br><span class="line"> 1      boolea  save-result   <span class="literal">false</span>   Option to <span class="built_in">print</span> comm  This option enables to save each <span class="built_in">command</span><span class="string">&#x27;s</span></span><br><span class="line"><span class="string">        n                             and&#x27;</span>s result to <span class="built_in">log</span>    result to <span class="built_in">log</span> file, <span class="built_in">which</span> path is <span class="variable">$&#123;user.</span></span><br><span class="line"><span class="variable">                                      file                  home&#125;</span>/logs/arthas-cache/result.log.</span><br><span class="line"> 2      String  job-timeout   1d      Option to job timeou  This option setting job timeout,The unit c</span><br><span class="line">                                      t                     an be d, h, m, s <span class="keyword">for</span> day, hour, minute, se</span><br><span class="line">                                                            cond. 1d is one day <span class="keyword">in</span> default</span><br><span class="line"> 1      boolea  print-parent  <span class="literal">true</span>    Option to <span class="built_in">print</span> all   This option enables <span class="built_in">print</span> files <span class="keyword">in</span> parent</span><br><span class="line">        n       -fields               fileds <span class="keyword">in</span> parent cla  class, default value <span class="literal">true</span>.</span><br><span class="line">                                      ss</span><br><span class="line"> 1      boolea  verbose       <span class="literal">false</span>   Option to <span class="built_in">print</span> verb  This option enables <span class="built_in">print</span> verbose informat</span><br><span class="line">        n                             ose information       ion, default value <span class="literal">false</span>.</span><br><span class="line"> 1      boolea  strict        <span class="literal">true</span>    Option to strict mod  By default, strict mode is <span class="literal">true</span>, not allow</span><br><span class="line">        n                             e                     ed to <span class="built_in">set</span> object properties. Want to <span class="built_in">set</span> o</span><br><span class="line">                                                            bject properties, execute `options strict</span><br><span class="line">                                                            <span class="literal">false</span>`</span><br></pre></td></tr></table></figure>

<h2 id="参数说明-1"><a href="#参数说明-1" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th>名称</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>unsafe</td>
<td>false</td>
<td>是否支持对系统级别的类进行增强，打开该开关可能导致把 JVM 搞挂，请慎重选择！</td>
</tr>
<tr>
<td>dump</td>
<td>false</td>
<td>是否支持被增强了的类 dump 到外部文件中，如果打开开关，class 文件会被 dump 到<code>/$&#123;application working dir&#125;/arthas-class-dump/</code>目录下，具体位置详见控制台输出</td>
</tr>
<tr>
<td>batch-re-transform</td>
<td>true</td>
<td>是否支持批量对匹配到的类执行 retransform 操作</td>
</tr>
<tr>
<td>json-format</td>
<td>false</td>
<td>是否支持 json 化的输出</td>
</tr>
<tr>
<td>disable-sub-class</td>
<td>false</td>
<td>是否禁用子类匹配，默认在匹配目标类的时候会默认匹配到其子类，如果想精确匹配，可以关闭此开关</td>
</tr>
<tr>
<td>support-default-method</td>
<td>true</td>
<td>是否支持匹配到 default method， 默认会查找 interface，匹配里面的 default method。参考 <a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/1105">#1105在新窗口打开</a></td>
</tr>
<tr>
<td>save-result</td>
<td>false</td>
<td>是否打开执行结果存日志功能，打开之后所有命令的运行结果都将保存到<code>~/logs/arthas-cache/result.log</code>中</td>
</tr>
<tr>
<td>job-timeout</td>
<td>1d</td>
<td>异步后台任务的默认超时时间，超过这个时间，任务自动停止；比如设置 1d, 2h, 3m, 25s，分别代表天、小时、分、秒</td>
</tr>
<tr>
<td>print-parent-fields</td>
<td>true</td>
<td>是否打印在 parent class 里的 filed</td>
</tr>
<tr>
<td>verbose</td>
<td>false</td>
<td>是否打印更多详细信息</td>
</tr>
<tr>
<td>strict</td>
<td>true</td>
<td>是否启用 strict 模式</td>
</tr>
</tbody></table>
<h2 id="获取单个option-的值"><a href="#获取单个option-的值" class="headerlink" title="获取单个option 的值"></a>获取单个option 的值</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ options json-format</span><br><span class="line"> LEVEL  TYPE  NAME         VALUE  SUMMARY             DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------------------</span><br><span class="line"> 2      bool  json-format  false  Option to support   This option enables to format object</span><br><span class="line">        ean                       JSON format of obj  output with JSON when -x option selec</span><br><span class="line">                                  ect output          ted.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<div class="note info no-icon"><p>提示</p>
<p>默认情况下 json-format 为 false，如果希望 watch / tt 等命令结果以 json 格式输出，则可以设置 json-format 为 true。</p>
</div>

<h2 id="设置指定的-option"><a href="#设置指定的-option" class="headerlink" title="设置指定的 option"></a>设置指定的 option</h2><p>例如，想打开执行结果存日志功能，输入如下命令即可：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ options save-result true</span><br><span class="line"> NAME         BEFORE-VALUE  AFTER-VALUE</span><br><span class="line">----------------------------------------</span><br><span class="line"> save-result  false         true</span><br></pre></td></tr></table></figure>

<h2 id="允许增强-JDK-的类"><a href="#允许增强-JDK-的类" class="headerlink" title="允许增强 JDK 的类"></a>允许增强 JDK 的类</h2><p>默认情况下<code>unsafe</code> 为 false，即 watch/trace 等命令不会增强 JVM 的类，即<code>java.*</code> 下面的类。</p>
<p>如果想增强 JVM 里的类，可以执行 <code>options unsafe true</code> ，设置<code>unsafe</code> 为 true。</p>
<h2 id="以-JSON-格式打印对象"><a href="#以-JSON-格式打印对象" class="headerlink" title="以 JSON 格式打印对象"></a>以 JSON 格式打印对象</h2><p><code>options json-format</code> 可以看到当前的 <code>json-format</code> 为 false<br>运行 <code>ognl &#39;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#39;</code> 得到的结果并不是 JSON 格式</p>
<p>如果希望输出 JSON 格式，可以使用 <code>options json-format true</code> 开启，开启后再运行 <code>ognl &#39;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#39;</code> 这是可以看到输出的格式已经转变为 JSON 格式。</p>
<hr>
<h1 id="案例：排查函数调用异常"><a href="#案例：排查函数调用异常" class="headerlink" title="案例：排查函数调用异常"></a>案例：排查函数调用异常</h1><h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>目前，访问 <code>/user/0</code> ，会返回 500 异常：</p>
<p>但请求的具体参数，异常栈是什么呢？</p>
<h2 id="查看-UserController-的-参数-异常"><a href="#查看-UserController-的-参数-异常" class="headerlink" title="查看 UserController 的 参数/异常"></a>查看 UserController 的 参数/异常</h2><p>在 Arthas 里执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch com.example.demo.arthas.user.UserController * &#39;&#123;params, throwExp&#125;&#39;</span><br></pre></td></tr></table></figure>

<ol>
<li>第一个参数是类名，支持通配</li>
<li>第二个参数是函数名，支持通配</li>
</ol>
<p>访问 <code>/user/0</code>,<code>watch</code> 命令会打印调用的参数和异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[arthas@5728]$ watch  com.example.demo.arthas.user.UserController  * &#39;&#123;params, throwExp&#125;&#39;</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 2) cost in 172 ms, listenerId: 1</span><br><span class="line">method&#x3D;com.example.demo.arthas.user.UserController.findUserById location&#x3D;AtExceptionExit</span><br><span class="line">ts&#x3D;2024-01-05 16:31:06; [cost&#x3D;6.6047ms] result&#x3D;@ArrayList[</span><br><span class="line">    @Object[][isEmpty&#x3D;false;size&#x3D;1],</span><br><span class="line">    @IllegalArgumentException[java.lang.IllegalArgumentException: id &lt; 1],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>可以看到实际抛出的异常是<code>IllegalArgumentException</code> 。</p>
<p>可以输入 <code>Q</code> 或者 <code>Ctrl+C</code> 退出 watch 命令。</p>
<p>如果想把获取到的结果展开，可以用<code>-x</code> 参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[arthas@6392]$ watch  com.example.demo.arthas.user.UserController  * &#39;&#123;params, throwExp&#125;&#39; -x 2</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 2) cost in 119 ms, listenerId: 1</span><br><span class="line">method&#x3D;com.example.demo.arthas.user.UserController.findUserById location&#x3D;AtExceptionExit</span><br><span class="line">ts&#x3D;2024-01-05 16:38:32; [cost&#x3D;6.8937ms] result&#x3D;@ArrayList[</span><br><span class="line">    @Object[][</span><br><span class="line">        @Integer[0],</span><br><span class="line">    ],</span><br><span class="line">    java.lang.IllegalArgumentException: id &lt; 1</span><br><span class="line">        at com.example.demo.arthas.user.UserController.findUserById(UserController.java:19)</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)</span><br><span class="line">        at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)</span><br><span class="line">        at java.lang.reflect.Method.invoke(Unknown Source)</span><br><span class="line">        at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:205)</span><br><span class="line">        at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:133)</span><br><span class="line">        at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:97)</span><br><span class="line">        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:827)</span><br><span class="line">        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:738)</span><br><span class="line">        at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:85)</span><br><span class="line">        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:967)</span><br><span class="line">        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:901)</span><br><span class="line">        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:970)</span><br><span class="line">        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:861)</span><br><span class="line">        at javax.servlet.http.HttpServlet.service(HttpServlet.java:635)</span><br><span class="line">        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:846)</span><br><span class="line">        at javax.servlet.http.HttpServlet.service(HttpServlet.java:742)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        ......</span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>

<h2 id="返回值表达式"><a href="#返回值表达式" class="headerlink" title="返回值表达式"></a>返回值表达式</h2><p>在上面的例子里，第三个参数是<code>返回值表达式</code> ，它实际上是一个<code>ognl</code> 表达式，它支持一些内置对象：</p>
<ul>
<li><code>loader</code></li>
<li><code>clazz</code></li>
<li><code>method</code></li>
<li><code>target</code></li>
<li><code>params</code></li>
<li><code>returnObj</code></li>
<li><code>throwExp</code></li>
<li><code>isBefore</code></li>
<li><code>isThrow</code></li>
<li><code>isReturn</code></li>
</ul>
<p>你可以利用这些内置对象来组成不同的表达式。比如返回一个数组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch com.example.demo.arthas.user.UserController * &#39;&#123;params[0], target, returnObj&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>更多参考：<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/advice-class.html">https://arthas.aliyun.com/doc/advice-class.html</a></p>
<h2 id="条件表达式"><a href="#条件表达式" class="headerlink" title="条件表达式"></a>条件表达式</h2><p><code>watch</code> 命令支持在第 4 个参数里写条件表达式，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch com.example.demo.arthas.user.UserController * returnObj &#39;params[0] &gt; 100&#39;</span><br></pre></td></tr></table></figure>

<p>当访问 <code>/user/1</code> 时，<code>watch</code> 命令没有输出</p>
<p>当访问 <code>/user/101</code> 时，<code>watch</code> 会打印出结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[arthas@6392]$ watch com.example.demo.arthas.user.UserController  * returnObj &#39;params[0]&gt;100&#39;</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 2) cost in 31 ms, listenerId: 2</span><br><span class="line">method&#x3D;com.example.demo.arthas.user.UserController.findUserById location&#x3D;AtExit</span><br><span class="line">ts&#x3D;2024-01-05 16:46:59; [cost&#x3D;0.5729ms] result&#x3D;@User[</span><br><span class="line">    id&#x3D;@Integer[101],</span><br><span class="line">    name&#x3D;@String[name101],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="当异常时捕获"><a href="#当异常时捕获" class="headerlink" title="当异常时捕获"></a>当异常时捕获</h2><p><code>watch</code> 命令支持<code>-e</code> 选项，表示只捕获抛出异常时的请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch com.example.demo.arthas.user.UserController * &quot;&#123;params[0],throwExp&#125;&quot; -e</span><br></pre></td></tr></table></figure>

<p>当访问<code>/user/0</code>时，<code>watch</code>会打印异常信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[arthas@6392]$ watch com.example.demo.arthas.user.UserController * &quot;&#123;params[0],throwExp&#125;&quot; -e</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 2) cost in 38 ms, listenerId: 6</span><br><span class="line">method&#x3D;com.example.demo.arthas.user.UserController.findUserById location&#x3D;AtExceptionExit</span><br><span class="line">ts&#x3D;2024-01-05 16:57:40; [cost&#x3D;1.197ms] result&#x3D;@ArrayList[</span><br><span class="line">    @Integer[0],</span><br><span class="line">    @IllegalArgumentException[java.lang.IllegalArgumentException: id &lt; 1],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="按照耗时进行过滤"><a href="#按照耗时进行过滤" class="headerlink" title="按照耗时进行过滤"></a>按照耗时进行过滤</h2><p>watch 命令支持按请求耗时进行过滤，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch com.example.demo.arthas.user.UserController * &#39;&#123;params, returnObj&#125;&#39; &#39;#cost&gt;200&#39;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="案例：热更新代码"><a href="#案例：热更新代码" class="headerlink" title="案例：热更新代码"></a>案例：热更新代码</h1><p>下面介绍通过<code>jad</code> /<code>mc</code> /<code>redefine</code> 命令实现动态更新代码的功能。</p>
<p>目前，访问 <code>/user/0</code> ，会返回 500 异常：</p>
<p>下面通过热更新代码，修改这个逻辑。</p>
<h2 id="jad-反编译-UserController"><a href="#jad-反编译-UserController" class="headerlink" title="jad 反编译 UserController"></a>jad 反编译 UserController</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jad --source-only com.example.demo.arthas.user.UserController &gt; &#x2F;tmp&#x2F;UserController.java</span><br></pre></td></tr></table></figure>

<p>jad 反编译的结果保存在 <code>/tmp/UserController.java</code> 文件里了。</p>
<p>再打开一个终端于 <code>Tab 3</code> ，然后在 <code>Tab3</code> 里用 <code>sed</code> 来编辑<code>/tmp/UserController.java</code> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#39;s&#x2F;throw new IllegalArgumentException(&quot;id &lt; 1&quot;)&#x2F;return new User(id, &quot;name&quot; + id)&#x2F;g&#39; &#x2F;tmp&#x2F;UserController.java</span><br></pre></td></tr></table></figure>

<p>使用 <code>cat</code> 命令查看修改后的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;tmp&#x2F;UserController.java</span><br></pre></td></tr></table></figure>

<p>比如当 user id 小于 1 时，也正常返回，不抛出异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@GetMapping(value=&#123;&quot;/user/&#123;id&#125;&quot;&#125;)</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> </span>&#123;</span><br><span class="line">     logger.info(<span class="string">&quot;id: &#123;&#125;&quot;</span>, (Object)id);</span><br><span class="line">     <span class="keyword">if</span> (id != <span class="keyword">null</span> &amp;&amp; id &lt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> User(id, <span class="string">&quot;name&quot;</span> + id);</span><br><span class="line">         <span class="comment">// throw new IllegalArgumentException(&quot;id &lt; 1&quot;);</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> User(id.intValue(), <span class="string">&quot;name&quot;</span> + id);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>mc</code> (Memory Compiler) 命令来编译加载 UserController， 可以通过 -c 指定 classLoaderHash 或者 –classLoaderClass 参数指定 ClassLoader，这里为了操作连贯性使用 classLoaderClass。</p>
<h2 id="查询-UserController-类加载器"><a href="#查询-UserController-类加载器" class="headerlink" title="查询 UserController 类加载器"></a>查询 UserController 类加载器</h2><h3 id="sc-查找加载-UserController-的-ClassLoader"><a href="#sc-查找加载-UserController-的-ClassLoader" class="headerlink" title="sc 查找加载 UserController 的 ClassLoader"></a>sc 查找加载 UserController 的 ClassLoader</h3><p>回到 <code>Tab 2</code> 里运行 <code>sc -d *UserController | grep classLoaderHash</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@6392]$ sc -d *UserController | grep classLoaderHash</span><br><span class="line"> classLoaderHash   38af3868</span><br></pre></td></tr></table></figure>

<h3 id="classloader-查询类加载器名称"><a href="#classloader-查询类加载器名称" class="headerlink" title="classloader 查询类加载器名称"></a>classloader 查询类加载器名称</h3><p><code>classloader -l</code> 查询所有的类加载器列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[arthas@6392]$ classloader  -l</span><br><span class="line"> name                                                             loadedCount  hash      parent</span><br><span class="line"> BootstrapClassLoader                                             3221         null      null</span><br><span class="line"> com.taobao.arthas.agent.ArthasClassloader@384abb78               2630         384abb78  sun.misc.Launcher$ExtClassLoade</span><br><span class="line">                                                                                         r@a09ee92</span><br><span class="line"> org.springframework.boot.loader.LaunchedURLClassLoader@38af3868  4591         38af3868  sun.misc.Launcher$AppClassLoade</span><br><span class="line">                                                                                         r@5c647e05</span><br><span class="line"> sun.misc.Launcher$AppClassLoader@5c647e05                        45           5c647e05  sun.misc.Launcher$ExtClassLoade</span><br><span class="line">                                                                                         r@a09ee92</span><br><span class="line"> sun.misc.Launcher$ExtClassLoader@a09ee92                         19           a09ee92   null</span><br><span class="line">Affect(row-cnt:5) cost in 7 ms.</span><br></pre></td></tr></table></figure>

<p><code>UserController classLoaderHash</code> 值对应的类加载器为 <code>org.springframework.boot.loader.LaunchedURLClassLoader</code></p>
<h3 id="mc-编译加载-UserController"><a href="#mc-编译加载-UserController" class="headerlink" title="mc 编译加载 UserController"></a>mc 编译加载 UserController</h3><p>保存到 <code>/tmp/UserController.java</code> 之后可以使用 mc (Memory Compiler) 命令来编译</p>
<h3 id="mc-指定-classloader-编译-UserController"><a href="#mc-指定-classloader-编译-UserController" class="headerlink" title="mc 指定 classloader 编译 UserController"></a>mc 指定 classloader 编译 UserController</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ mc -c 33c7353a &#x2F;tmp&#x2F;UserController.java  -d &#x2F;tmp&#x2F;</span><br><span class="line">Memory compiler output:</span><br><span class="line">D:\tmp\com\example\demo\arthas\user\UserController.class</span><br><span class="line">Affect(row-cnt:1) cost in 4442 ms.</span><br></pre></td></tr></table></figure>

<h3 id="redefine"><a href="#redefine" class="headerlink" title="redefine"></a>redefine</h3><p>再使用<code>redefine</code> 命令重新加载新编译好的<code>UserController.class</code> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ redefine &#x2F;tmp&#x2F;com&#x2F;example&#x2F;demo&#x2F;arthas&#x2F;user&#x2F;UserController.class</span><br><span class="line">redefine success, size: 1, classes:</span><br><span class="line">com.example.demo.arthas.user.UserController</span><br></pre></td></tr></table></figure>

<h3 id="热修改代码结果"><a href="#热修改代码结果" class="headerlink" title="热修改代码结果"></a>热修改代码结果</h3><p><code>redefine</code> 成功之后，再次访问 <code>/user/0</code>，结果是：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;name0&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="案例：Arthas-后台异步任务"><a href="#案例：Arthas-后台异步任务" class="headerlink" title="案例：Arthas 后台异步任务"></a>案例：Arthas 后台异步任务</h1><p>arthas 中的后台异步任务，使用了仿 linux 系统任务相关的命令。</p>
<h2 id="使用-amp-在后台执行任务，任务输出重定向"><a href="#使用-amp-在后台执行任务，任务输出重定向" class="headerlink" title="使用 &amp; 在后台执行任务，任务输出重定向"></a>使用 &amp; 在后台执行任务，任务输出重定向</h2><p>可通过 <code>&gt;</code> 或者 <code>&gt;&gt;</code> 将任务输出结果输出到指定的文件中，可以和 <code>&amp;</code> 一起使用，实现 arthas 命令的后台异步任务。</p>
<p>当前我们需要排查一个问题，但是这个问题的出现时间不能确定，那我们就可以把检测命令挂在后台运行，并将保存到输出日志，如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch com.example.demo.arthas.user.UserController * &#39;&#123;params, throwExp&#125;&#39; &#39;throwExp !&#x3D; null&#39; &gt;&gt; a.log &amp;</span><br></pre></td></tr></table></figure>

<p>这时命令在后台执行，可以在 console 中继续执行其他命令。</p>
<p>之后我们去访问：<code>/user/0</code></p>
<p>然后使用 <code>cat a.log</code> 可以看到我们刚刚访问的 URL 抛出了一个异常</p>
<h2 id="通过-jobs-查看任务"><a href="#通过-jobs-查看任务" class="headerlink" title="通过 jobs 查看任务"></a>通过 jobs 查看任务</h2><p>如果希望查看当前有哪些 arthas 任务在执行，可以执行 jobs 命令，执行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ jobs</span><br><span class="line">[4]*</span><br><span class="line">       Running           watch com.example.demo.arthas.user.UserController * &#39;&#123;params, throwExp !&#x3D; null&#125;&#39; &gt;&gt; a.log &amp;</span><br><span class="line">       execution count : 1</span><br><span class="line">       start time      : Sat Jan 06 09:36:28 CST 2024</span><br><span class="line">       timeout date    : Sun Jan 07 09:36:28 CST 2024</span><br><span class="line">       session         : 4251ad90-2951-4d33-8da1-2d241a3e0a0f (current)</span><br></pre></td></tr></table></figure>

<p>可以看到目前有一个后台任务在执行</p>
<p>job id 是 4, <code>*</code> 表示此 job 是当前 session 创建（生命周期默认为一天）</p>
<p>状态是 <code>Running</code></p>
<p><code>execution count</code> 是执行次数，从启动开始已经执行了 1 次</p>
<p><code>timeout date</code> 是超时的时间，到这个时间，任务将会自动超时退出。</p>
<h2 id="停止命令、切换前后台"><a href="#停止命令、切换前后台" class="headerlink" title="停止命令、切换前后台"></a>停止命令、切换前后台</h2><p>异步执行的命令，如果希望停止，可执行 <code>kill</code>, 希望命令转到前台、后台继续执行 fg、bg 命令。</p>
<p><code>kill</code>掉job id 是 4 的任务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ kill 4</span><br><span class="line">kill job 4 success</span><br><span class="line">[arthas@3880]$ jobs</span><br></pre></td></tr></table></figure>

<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>最多同时支持 8 个命令使用重定向将结果写日志</li>
<li>请勿同时开启过多的后台异步命令，以免对目标 JVM 性能造成影响</li>
<li>如果不想停止 arthas，继续执行后台任务，可以执行 <code>quit</code> 退出 arthas 控制台（<code>stop</code> 会停止 arthas 服务）</li>
</ul>
<hr>
<h1 id="案例：动态更新应用-Logger-Level"><a href="#案例：动态更新应用-Logger-Level" class="headerlink" title="案例：动态更新应用 Logger Level"></a>案例：动态更新应用 Logger Level</h1><p>在这个案例里，动态修改应用的 Logger Level。</p>
<h2 id="使用-sc-查找-UserController-的-ClassLoader"><a href="#使用-sc-查找-UserController-的-ClassLoader" class="headerlink" title="使用 sc 查找 UserController 的 ClassLoader"></a>使用 sc 查找 UserController 的 ClassLoader</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc -d com.example.demo.arthas.user.UserController | grep classLoaderHash</span><br></pre></td></tr></table></figure>

<p>注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，提取对应 ClassLoader 的 hashcode。<br>如果你使用<code>-c</code> ，你需要手动输入 hashcode：<code>-c &lt;hashcode&gt;</code><br>对于只有唯一实例的 ClassLoader 可以通过<code>--classLoaderClass</code> 指定 class name，使用起来更加方便：<br><code>--classLoaderClass</code> 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code> 是动态变化的。</p>
<h2 id="使用-ognl"><a href="#使用-ognl" class="headerlink" title="使用 ognl"></a>使用 ognl</h2><h3 id="用-ognl-获取-logger"><a href="#用-ognl-获取-logger" class="headerlink" title="用 ognl 获取 logger"></a>用 ognl 获取 logger</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@com.example.demo.arthas.user.UserController@logger&#39;</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID&#x3D;@Long[5454405123156820674],</span><br><span class="line">    FQCN&#x3D;@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name&#x3D;@String[com.example.demo.arthas.user.UserController],</span><br><span class="line">    level&#x3D;null,</span><br><span class="line">    effectiveLevelInt&#x3D;@Integer[20000],</span><br><span class="line">    parent&#x3D;@Logger[Logger[com.example.demo.arthas.user]],</span><br><span class="line">    childrenList&#x3D;null,</span><br><span class="line">    aai&#x3D;null,</span><br><span class="line">    additive&#x3D;@Boolean[true],</span><br><span class="line">    loggerContext&#x3D;@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>可以知道 <code>UserController@logger</code> 实际使用的是 logback。可以看到 <code>level=null</code> ，则说明实际最终的 level 是从 <code>root logger </code>里来的。</p>
<p>查看<code>root logger </code>的<code>Lever</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@org.slf4j.LoggerFactory@getLogger(&quot;root&quot;)&#39;</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID&#x3D;@Long[5454405123156820674],</span><br><span class="line">    FQCN&#x3D;@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name&#x3D;@String[ROOT],</span><br><span class="line">    level&#x3D;@Level[INFO],</span><br><span class="line">    effectiveLevelInt&#x3D;@Integer[20000],</span><br><span class="line">    parent&#x3D;null,</span><br><span class="line">    childrenList&#x3D;@CopyOnWriteArrayList[isEmpty&#x3D;false;size&#x3D;3],</span><br><span class="line">    aai&#x3D;@AppenderAttachableImpl[ch.qos.logback.core.spi.AppenderAttachableImpl@452a4e77],</span><br><span class="line">    additive&#x3D;@Boolean[true],</span><br><span class="line">    loggerContext&#x3D;@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="单独设置-UserController-的-logger-level"><a href="#单独设置-UserController-的-logger-level" class="headerlink" title="单独设置 UserController 的 logger level"></a>单独设置 UserController 的 logger level</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@com.example.demo.arthas.user.UserController@logger.setLevel(@ch.qos.logback.classic.Level@DEBUG)&#39;</span><br><span class="line">null</span><br></pre></td></tr></table></figure>

<p>再次获取 <code>UserController@logger</code> ，可以发现已经是 <code>DEBUG</code> 了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@com.example.demo.arthas.user.UserController@logger&#39;</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID&#x3D;@Long[5454405123156820674],</span><br><span class="line">    FQCN&#x3D;@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name&#x3D;@String[com.example.demo.arthas.user.UserController],</span><br><span class="line">    level&#x3D;@Level[DEBUG],</span><br><span class="line">    effectiveLevelInt&#x3D;@Integer[10000],</span><br><span class="line">    parent&#x3D;@Logger[Logger[com.example.demo.arthas.user]],</span><br><span class="line">    childrenList&#x3D;null,</span><br><span class="line">    aai&#x3D;null,</span><br><span class="line">    additive&#x3D;@Boolean[true],</span><br><span class="line">    loggerContext&#x3D;@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="修改-logback-的全局-logger-level"><a href="#修改-logback-的全局-logger-level" class="headerlink" title="修改 logback 的全局 logger level"></a>修改 logback 的全局 logger level</h3><p>通过获取 <code>root</code> logger，可以修改全局的 logger level：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@org.slf4j.LoggerFactory@getLogger(&quot;root&quot;).setLevel(@ch.qos.logback.classic.Level@DEBUG)&#39;</span><br><span class="line">null</span><br></pre></td></tr></table></figure>

<p>运行下面命令可以看到 <code>ROOT</code> 的 level 已经修改为了 <code>DEBUG</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@org.slf4j.LoggerFactory@getLogger(&quot;root&quot;)&#39;</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID&#x3D;@Long[5454405123156820674],</span><br><span class="line">    FQCN&#x3D;@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name&#x3D;@String[ROOT],</span><br><span class="line">    level&#x3D;@Level[DEBUG],</span><br><span class="line">    effectiveLevelInt&#x3D;@Integer[10000],</span><br><span class="line">    parent&#x3D;null,</span><br><span class="line">    childrenList&#x3D;@CopyOnWriteArrayList[isEmpty&#x3D;false;size&#x3D;3],</span><br><span class="line">    aai&#x3D;@AppenderAttachableImpl[ch.qos.logback.core.spi.AppenderAttachableImpl@452a4e77],</span><br><span class="line">    additive&#x3D;@Boolean[true],</span><br><span class="line">    loggerContext&#x3D;@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="使用-logger"><a href="#使用-logger" class="headerlink" title="使用 logger"></a>使用 logger</h2><p>使用 <code>logger</code> 命令可以相较于 <code>ognl</code> 更加便捷的实现 logger level 的动态设置。</p>
<h3 id="使用-logger-命令获取对应-logger-信息"><a href="#使用-logger-命令获取对应-logger-信息" class="headerlink" title="使用 logger 命令获取对应 logger 信息"></a>使用 logger 命令获取对应 logger 信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ logger --name  com.example.demo.arthas.user.UserController</span><br><span class="line"> name                                      com.example.demo.arthas.user.UserController</span><br><span class="line"> class                                     ch.qos.logback.classic.Logger</span><br><span class="line"> classLoader                               org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a</span><br><span class="line"> classLoaderHash                           33c7353a</span><br><span class="line"> level                                     DEBUG</span><br><span class="line"> effectiveLevel                            DEBUG</span><br><span class="line"> additivity                                true</span><br><span class="line"> codeSource                                jar:file:&#x2F;D:&#x2F;arthas&#x2F;arthas-packaging-3.7.1-bin&#x2F;demo-arthas-spring-boot.jar!&#x2F;BOOT-INF&#x2F;lib&#x2F;logback-classic-1.1.11.jar!&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="单独设置-UserController-的-logger-level-1"><a href="#单独设置-UserController-的-logger-level-1" class="headerlink" title="单独设置 UserController 的 logger level"></a>单独设置 UserController 的 logger level</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ logger --name com.example.demo.arthas.user.UserController --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --level WARN</span><br><span class="line">Update logger level success.</span><br></pre></td></tr></table></figure>

<p>再次获取对应 <code>logger</code> 信息，可以发现已经是 <code>WARN</code> 了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ logger --name com.example.demo.arthas.user.UserController</span><br><span class="line"> name                                      com.example.demo.arthas.user.UserController</span><br><span class="line"> class                                     ch.qos.logback.classic.Logger</span><br><span class="line"> classLoader                               org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a</span><br><span class="line"> classLoaderHash                           33c7353a</span><br><span class="line"> level                                     WARN</span><br><span class="line"> effectiveLevel                            WARN</span><br><span class="line"> additivity                                true</span><br><span class="line"> codeSource                                jar:file:&#x2F;D:&#x2F;arthas&#x2F;arthas-packaging-3.7.1-bin&#x2F;demo-arthas-spring-boot.jar!&#x2F;BOOT-INF&#x2F;lib&#x2F;logback-classic-1.1.11.jar!&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="修改-logback-的全局-logger-level-1"><a href="#修改-logback-的全局-logger-level-1" class="headerlink" title="修改 logback 的全局 logger level"></a>修改 logback 的全局 logger level</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ logger --name ROOT --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --level ERROR</span><br><span class="line">Update logger level success.</span><br></pre></td></tr></table></figure>

<p>运行下面命令可以看到 <code>ROOT</code> 的 level 已经修改为了 <code>ERROR</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ logger  --name ROOT --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader</span><br><span class="line"> name                                      ROOT</span><br><span class="line"> class                                     ch.qos.logback.classic.Logger</span><br><span class="line"> classLoader                               org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a</span><br><span class="line"> classLoaderHash                           33c7353a</span><br><span class="line"> level                                     ERROR</span><br><span class="line"> effectiveLevel                            ERROR</span><br><span class="line"> additivity                                true</span><br><span class="line"> codeSource                                jar:file:&#x2F;D:&#x2F;arthas&#x2F;arthas-packaging-3.7.1-bin&#x2F;demo-arthas-spring-boot.jar!&#x2F;BOOT-INF&#x2F;lib&#x2F;logback-classic-1.1.11.jar!&#x2F;</span><br><span class="line"> appenders                                 name            CONSOLE</span><br><span class="line">                                           class           ch.qos.logback.core.ConsoleAppender</span><br><span class="line">                                           classLoader     org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a</span><br><span class="line">                                           classLoaderHash 33c7353a</span><br><span class="line">                                           target          System.out</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="案例：排查-logger-冲突问题"><a href="#案例：排查-logger-冲突问题" class="headerlink" title="案例：排查 logger 冲突问题"></a>案例：排查 logger 冲突问题</h1><p>在这个案例里，展示排查 logger 冲突的方法。</p>
<h2 id="查找-UserController-的-ClassLoader-1"><a href="#查找-UserController-的-ClassLoader-1" class="headerlink" title="查找 UserController 的 ClassLoader"></a>查找 UserController 的 ClassLoader</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc -d com.example.demo.arthas.user.UserController | grep classLoaderHash</span><br></pre></td></tr></table></figure>

<p>注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，提取对应 ClassLoader 的 hashcode。<br>如果你使用<code>-c</code> ，你需要手动输入 hashcode：<code>-c &lt;hashcode&gt;</code><br>对于只有唯一实例的 ClassLoader 可以通过<code>--classLoaderClass</code> 指定 class name，使用起来更加方便：<br><code>--classLoaderClass</code> 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code> 是动态变化的。</p>
<h2 id="确认应用使用的-logger-系统"><a href="#确认应用使用的-logger-系统" class="headerlink" title="确认应用使用的 logger 系统"></a>确认应用使用的 logger 系统</h2><p>以 <code>UserController</code> 为例，它使用的是 slf4j api，但实际使用到的 logger 系统是 logback。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@com.example.demo.arthas.user.UserController@logger&#39;</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID&#x3D;@Long[5454405123156820674],</span><br><span class="line">    FQCN&#x3D;@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name&#x3D;@String[com.example.demo.arthas.user.UserController],</span><br><span class="line">    level&#x3D;@Level[INFO],</span><br><span class="line">    effectiveLevelInt&#x3D;@Integer[20000],</span><br><span class="line">    parent&#x3D;@Logger[Logger[com.example.demo.arthas.user]],</span><br><span class="line">    childrenList&#x3D;null,</span><br><span class="line">    aai&#x3D;null,</span><br><span class="line">    additive&#x3D;@Boolean[true],</span><br><span class="line">    loggerContext&#x3D;@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="获取-logback-实际加载的配置文件"><a href="#获取-logback-实际加载的配置文件" class="headerlink" title="获取 logback 实际加载的配置文件"></a>获取 logback 实际加载的配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass  org.springframework.boot.loader.LaunchedURLClassLoader  &#39;#map1&#x3D;@org.slf4j.LoggerFactory@getLogger(&quot;root&quot;).loggerContext.objectMap, #map1.get(&quot;CONFIGURATION_WATCH_LIST&quot;)&#39;</span><br><span class="line">@ConfigurationWatchList[</span><br><span class="line">    mainURL&#x3D;@URL[jar:file:&#x2F;D:&#x2F;arthas&#x2F;arthas-packaging-3.7.1-bin&#x2F;demo-arthas-spring-boot.jar!&#x2F;BOOT-INF&#x2F;classes!&#x2F;logback-spring.xml],</span><br><span class="line">    fileWatchList&#x3D;@ArrayList[isEmpty&#x3D;true;size&#x3D;0],</span><br><span class="line">    lastModifiedList&#x3D;@ArrayList[isEmpty&#x3D;true;size&#x3D;0],</span><br><span class="line">    noContextWarning&#x3D;@Integer[0],</span><br><span class="line">    context&#x3D;@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">    declaredOrigin&#x3D;@ConfigurationWatchList[ch.qos.logback.core.joran.spi.ConfigurationWatchList@5149876],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="使用classloader-命令查找可能存在的-logger-配置文件"><a href="#使用classloader-命令查找可能存在的-logger-配置文件" class="headerlink" title="使用classloader 命令查找可能存在的 logger 配置文件"></a>使用classloader 命令查找可能存在的 logger 配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ classloader --classLoaderClass  org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</span><br><span class="line"> jar:file:&#x2F;D:&#x2F;arthas&#x2F;arthas-packaging-3.7.1-bin&#x2F;demo-arthas-spring-boot.jar!&#x2F;BOOT-INF&#x2F;classes!&#x2F;logback-spring.xml</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost in 1 ms.</span><br></pre></td></tr></table></figure>

<p>可以知道加载的配置的具体来源。</p>
<p>可以尝试加载容易冲突的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback.xml</span><br><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r log4j.properties</span><br></pre></td></tr></table></figure>

<h1 id="案例：获取-Spring-Context"><a href="#案例：获取-Spring-Context" class="headerlink" title="案例：获取 Spring Context"></a>案例：获取 Spring Context</h1><p>在这个案例里，展示获取 spring context，再获取 bean，然后调用函数。</p>
<h2 id="使用-tt-命令获取到-spring-context"><a href="#使用-tt-命令获取到-spring-context" class="headerlink" title="使用 tt 命令获取到 spring context"></a>使用 tt 命令获取到 spring context</h2><p><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/tt.html">tt</a> 即 TimeTunnel，它可以记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tt -t org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter invokeHandlerMethod</span><br></pre></td></tr></table></figure>

<p>访问：<code>/user/1</code></p>
<p>可以看到<code>tt</code> 命令捕获到了请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ tt -t  org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter invokeHandlerMethod</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost in 50 ms, listenerId: 2</span><br><span class="line"> INDEX           TIMESTAMP                              COST(ms)           IS-RET          IS-EXP         OBJECT                        CLASS                                                     METHOD</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> 1000            2024-01-06 15:47:59                    4.1345             true            false          0x369e7ab5                    RequestMappingHandlerAdapter                              invokeHandlerMethod</span><br></pre></td></tr></table></figure>

<h2 id="使用-tt-命令从调用记录里获取到-spring-context"><a href="#使用-tt-命令从调用记录里获取到-spring-context" class="headerlink" title="使用 tt 命令从调用记录里获取到 spring context"></a>使用 tt 命令从调用记录里获取到 spring context</h2><p>输入 <code>Q</code> 或者 <code>Ctrl + C</code> 退出上面的 <code>tt -t</code> 命令。<br>使用 <code>tt -l</code> 命令可以查看之前 <code>tt</code> 命令捕获到的请求信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tt -i 1000 -w &#39;target.getApplicationContext()&#39;</span><br></pre></td></tr></table></figure>

<h2 id="获取-spring-bean，并调用函数"><a href="#获取-spring-bean，并调用函数" class="headerlink" title="获取 spring bean，并调用函数"></a>获取 spring bean，并调用函数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ tt -i 1000 -w &#39;target.getApplicationContext().getBean(&quot;helloWorldService&quot;).getHelloMessage()&#39;</span><br><span class="line">@String[Hello World]</span><br><span class="line">Affect(row-cnt:1) cost in 4 ms.</span><br></pre></td></tr></table></figure>

<h2 id="Vmtool-获取-HelloWorldService-对象实例，并调用函数"><a href="#Vmtool-获取-HelloWorldService-对象实例，并调用函数" class="headerlink" title="Vmtool 获取 HelloWorldService 对象实例，并调用函数"></a>Vmtool 获取 HelloWorldService 对象实例，并调用函数</h2><p>上面的方法使用 tt 命令获取 spring bean，并调用函数，有点繁琐，更换为使用 <a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/vmtool.html">vmtool</a> 将会极大的简化这个流程，命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ vmtool --action getInstances --className com.example.demo.arthas.aop.HelloWorldService --express &#39;instances[0].getHelloMessage()&#39;</span><br><span class="line">@String[Hello World]</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="案例：排查-HTTP-请求返回-401"><a href="#案例：排查-HTTP-请求返回-401" class="headerlink" title="案例：排查 HTTP 请求返回 401"></a>案例：排查 HTTP 请求返回 401</h1><p>在这个案例里，展示排查 HTTP 401 问题的技巧。</p>
<p>访问： <code>/admin</code></p>
<p>结果是：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Something went wrong:</span> <span class="number">401</span> <span class="string">Unauthorized</span></span><br></pre></td></tr></table></figure>

<p>我们知道<code>401</code> 通常是被权限管理的<code>Filter</code> 拦截了，那么到底是哪个<code>Filter</code> 处理了这个请求，返回了 401？</p>
<h2 id="跟踪所有的-Filter-函数"><a href="#跟踪所有的-Filter-函数" class="headerlink" title="跟踪所有的 Filter 函数"></a>跟踪所有的 Filter 函数</h2><p>开始 trace：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace javax.servlet.Filter *</span><br></pre></td></tr></table></figure>

<p>访问： <code>/admin</code></p>
<p>可以在调用树的最深层，找到<code>AdminFilterConfig$AdminFilter</code> 返回了<code>401</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+---[<span class="number">3.806273</span>ms] javax.servlet.FilterChain:doFilter()</span><br><span class="line">|   <span class="string">`---[3.447472ms] com.example.demo.arthas.AdminFilterConfig$AdminFilter:doFilter()</span></span><br><span class="line"><span class="string">|       `</span>---[<span class="number">0.17259</span>ms] javax.servlet.http.HttpServletResponse:sendError()</span><br></pre></td></tr></table></figure>

<p>输入 <code>Q</code> 或者 <code>Ctrl+C</code> 退出 watch 命令。</p>
<h3 id="通过-stack-获取调用栈"><a href="#通过-stack-获取调用栈" class="headerlink" title="通过 stack 获取调用栈"></a>通过 stack 获取调用栈</h3><p>上面是通过<code>trace</code> 命令来获取信息，从结果里，我们可以知道通过<code>stack</code> 跟踪<code>HttpServletResponse:sendError()</code> ，同样可以知道是哪个<code>Filter</code> 返回了<code>401</code></p>
<p>执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stack javax.servlet.http.HttpServletResponse sendError &#39;params[0]&#x3D;&#x3D;401&#39;</span><br></pre></td></tr></table></figure>

<p>访问： <code>/admin</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ stack  javax.servlet.http.HttpServletResponse sendError &#39;params[0]&#x3D;&#x3D;401&#39;</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 3 , method count: 4) cost in 99 ms, listenerId: 4</span><br><span class="line">ts&#x3D;2024-01-06 16:33:24;thread_name&#x3D;http-nio-80-exec-3;id&#x3D;14;is_daemon&#x3D;true;priority&#x3D;5;TCCL&#x3D;org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader@54c14576</span><br><span class="line">    @org.apache.catalina.connector.Response.sendError()</span><br><span class="line">        at org.apache.catalina.connector.ResponseFacade.sendError(ResponseFacade.java:462)</span><br><span class="line">        at com.example.demo.arthas.AdminFilterConfig$AdminFilter.doFilter(AdminFilterConfig.java:38)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)</span><br><span class="line">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        at org.springframework.web.filter.HttpPutFormContentFilter.doFilterInternal(HttpPutFormContentFilter.java:109)</span><br><span class="line">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        at org.springframework.web.filter.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:81)</span><br><span class="line">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:197)</span><br><span class="line">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:198)</span><br><span class="line">        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)</span><br><span class="line">        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:496)</span><br><span class="line">        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:140)</span><br><span class="line">        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:81)</span><br><span class="line">        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)</span><br><span class="line">        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342)</span><br><span class="line">        at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:803)</span><br><span class="line">        at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)</span><br><span class="line">        at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:790)</span><br><span class="line">        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1468)</span><br><span class="line">        at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:748)</span><br></pre></td></tr></table></figure>

<p>输入 <code>Q</code> 或者 <code>Ctrl+C</code> 退出 watch 命令。</p>
<h1 id="案例：理解-Spring-Boot-应用的-ClassLoader-结构"><a href="#案例：理解-Spring-Boot-应用的-ClassLoader-结构" class="headerlink" title="案例：理解 Spring Boot 应用的 ClassLoader 结构"></a>案例：理解 Spring Boot 应用的 ClassLoader 结构</h1><p>下面介绍<code>classloader</code> 命令的功能。</p>
<p>先访问一个 jsp 网页，触发 jsp 的加载： <code>访问 hello 页面</code></p>
<h2 id="列出所有-ClassLoader"><a href="#列出所有-ClassLoader" class="headerlink" title="列出所有 ClassLoader"></a>列出所有 ClassLoader</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ classloader -l</span><br><span class="line"> name                                                             loadedCount  hash      parent</span><br><span class="line"> BootstrapClassLoader                                             3132         null      null</span><br><span class="line"> com.taobao.arthas.agent.ArthasClassloader@a3df247                1810         a3df247   sun.misc.Launcher$ExtClassLoader@f6f4d33</span><br><span class="line"> java.net.FactoryURLClassLoader@7b8e788f                          842          7b8e788f  sun.misc.Launcher$AppClassLoader@3d4eac69</span><br><span class="line"> org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a  4759         33c7353a  sun.misc.Launcher$AppClassLoader@3d4eac69</span><br><span class="line"> sun.misc.Launcher$AppClassLoader@3d4eac69                        45           3d4eac69  sun.misc.Launcher$ExtClassLoader@f6f4d33</span><br><span class="line"> sun.misc.Launcher$ExtClassLoader@f6f4d33                         23           f6f4d33   null</span><br><span class="line">Affect(row-cnt:6) cost in 4 ms.</span><br></pre></td></tr></table></figure>

<h2 id="统计-ClassLoader-实际使用-URL-和未使用的-URL"><a href="#统计-ClassLoader-实际使用-URL-和未使用的-URL" class="headerlink" title="统计 ClassLoader 实际使用 URL 和未使用的 URL"></a>统计 ClassLoader 实际使用 URL 和未使用的 URL</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classloader --url-stat</span><br></pre></td></tr></table></figure>

<div class="note info no-icon"><p>注意：基于 JVM 目前已加载的所有类统计，不代表 Unused URLs 可以从应用中删掉。因为可能将来需要从 Unused URLs 里加载类，或者需要加载 resources</p>
</div>

<h2 id="列出-ClassLoader-里加载的所有类"><a href="#列出-ClassLoader-里加载的所有类" class="headerlink" title="列出 ClassLoader 里加载的所有类"></a>列出 ClassLoader 里加载的所有类</h2><p>列出上面的<code>org.apache.jasper.servlet.JasperLoader</code> 加载的类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ classloader -a --classLoaderClass  org.apache.jasper.servlet.JasperLoader | grep hello</span><br><span class="line"> org.apache.jsp.jsp.hello_jsp</span><br></pre></td></tr></table></figure>

<h2 id="查看类的-classloader-层次"><a href="#查看类的-classloader-层次" class="headerlink" title="查看类的 classloader 层次"></a>查看类的 classloader 层次</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ sc -d org.apache.jsp.jsp.hello_jsp</span><br><span class="line"> class-info        org.apache.jsp.jsp.hello_jsp</span><br><span class="line"> code-source       &#x2F;C:&#x2F;Users&#x2F;pt-tianzhencai&#x2F;AppData&#x2F;Local&#x2F;Temp&#x2F;tomcat.2859845778385490372.80&#x2F;work&#x2F;Tomcat&#x2F;localhost&#x2F;ROOT&#x2F;</span><br><span class="line"> name              org.apache.jsp.jsp.hello_jsp</span><br><span class="line"> isInterface       false</span><br><span class="line"> isAnnotation      false</span><br><span class="line"> isEnum            false</span><br><span class="line"> isAnonymousClass  false</span><br><span class="line"> isArray           false</span><br><span class="line"> isLocalClass      false</span><br><span class="line"> isMemberClass     false</span><br><span class="line"> isPrimitive       false</span><br><span class="line"> isSynthetic       false</span><br><span class="line"> simple-name       hello_jsp</span><br><span class="line"> modifier          final,public</span><br><span class="line"> annotation</span><br><span class="line"> interfaces        org.apache.jasper.runtime.JspSourceDependent,org.apache.jasper.runtime.JspSourceImports</span><br><span class="line"> super-class       +-org.apache.jasper.runtime.HttpJspBase</span><br><span class="line">                     +-javax.servlet.http.HttpServlet</span><br><span class="line">                       +-javax.servlet.GenericServlet</span><br><span class="line">                         +-java.lang.Object</span><br><span class="line"> class-loader      +-org.apache.jasper.servlet.JasperLoader@4bc4fe20</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                       +-org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a</span><br><span class="line">                         +-sun.misc.Launcher$AppClassLoader@3d4eac69</span><br><span class="line">                           +-sun.misc.Launcher$ExtClassLoader@f6f4d33</span><br><span class="line"> classLoaderHash   4bc4fe20</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost in 7 ms.</span><br></pre></td></tr></table></figure>

<h2 id="查看-ClassLoader-树"><a href="#查看-ClassLoader-树" class="headerlink" title="查看 ClassLoader 树"></a>查看 ClassLoader 树</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ classloader -t</span><br><span class="line">+-BootstrapClassLoader</span><br><span class="line">+-sun.misc.Launcher$ExtClassLoader@f6f4d33</span><br><span class="line">  +-com.taobao.arthas.agent.ArthasClassloader@a3df247</span><br><span class="line">  +-sun.misc.Launcher$AppClassLoader@3d4eac69</span><br><span class="line">    +-java.net.FactoryURLClassLoader@7b8e788f</span><br><span class="line">    +-org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        +-org.apache.jasper.servlet.JasperLoader@4bc4fe20</span><br><span class="line">Affect(row-cnt:8) cost in 4 ms.</span><br></pre></td></tr></table></figure>

<h2 id="查看-URLClassLoader-实际的-urls"><a href="#查看-URLClassLoader-实际的-urls" class="headerlink" title="查看 URLClassLoader 实际的 urls"></a>查看 URLClassLoader 实际的 urls</h2><p>比如上面查看到的 spring LaunchedURLClassLoader 为 <code>org.springframework.boot.loader.LaunchedURLClassLoader</code> ，可以通过 <code>-c &lt;hashcode&gt;</code> 参数来指定 classloader，还有一种方法可以通过使用 <code>--classLoaderClass</code> 指定类名，从而查看 URLClassLoader 实际的 urls：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader</span><br></pre></td></tr></table></figure>

<h2 id="查找-ClassLoader-里的资源文件"><a href="#查找-ClassLoader-里的资源文件" class="headerlink" title="查找 ClassLoader 里的资源文件"></a>查找 ClassLoader 里的资源文件</h2><p>查找指定的资源文件： <code>classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r java&#x2F;lang&#x2F;String.class</span><br><span class="line"> jar:file:&#x2F;D:&#x2F;developInstall&#x2F;JDK&#x2F;jdk1.8.0_161&#x2F;jre&#x2F;lib&#x2F;rt.jar!&#x2F;java&#x2F;lang&#x2F;String.class</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost in 1 ms.</span><br></pre></td></tr></table></figure>

<p>也可以尝试查找类的 class 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r java&#x2F;lang&#x2F;String.class</span><br><span class="line"> jar:file:&#x2F;D:&#x2F;developInstall&#x2F;JDK&#x2F;jdk1.8.0_161&#x2F;jre&#x2F;lib&#x2F;rt.jar!&#x2F;java&#x2F;lang&#x2F;String.class</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost in 1 ms.</span><br></pre></td></tr></table></figure>

<h1 id="案例：查找-Top-N-线程"><a href="#案例：查找-Top-N-线程" class="headerlink" title="案例：查找 Top N 线程"></a>案例：查找 Top N 线程</h1><h2 id="查看所有线程信息"><a href="#查看所有线程信息" class="headerlink" title="查看所有线程信息"></a>查看所有线程信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread</span><br></pre></td></tr></table></figure>

<h2 id="查看具体线程的栈"><a href="#查看具体线程的栈" class="headerlink" title="查看具体线程的栈"></a>查看具体线程的栈</h2><p>查看线程 ID 16 的栈：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread 16</span><br></pre></td></tr></table></figure>

<h2 id="查看-CPU-使用率-top-n-线程的栈"><a href="#查看-CPU-使用率-top-n-线程的栈" class="headerlink" title="查看 CPU 使用率 top n 线程的栈"></a>查看 CPU 使用率 top n 线程的栈</h2><p>参数<code>n</code> 用来指定最忙的前 N 个线程并打印堆栈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread -n 3</span><br></pre></td></tr></table></figure>

<p>参数<code>i</code> 用来指定 cpu 占比统计的采样间隔，单位为毫秒</p>
<p>查看 5 秒内的 CPU 使用率 top n 线程栈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread -n 3 -i 5000</span><br></pre></td></tr></table></figure>

<h2 id="查找线程是否有阻塞"><a href="#查找线程是否有阻塞" class="headerlink" title="查找线程是否有阻塞"></a>查找线程是否有阻塞</h2><p>参数<code>b</code> 用来指定找出当前阻塞其他线程的线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread -b</span><br></pre></td></tr></table></figure>

<h1 id="案例：获取-Spring-应用运行时配置值"><a href="#案例：获取-Spring-应用运行时配置值" class="headerlink" title="案例：获取 Spring 应用运行时配置值"></a>案例：获取 Spring 应用运行时配置值</h1><p>众所周之，Spring 应用的配置注入方式非常多。除了我们熟悉的方式，比如</p>
<ul>
<li>System Properties/System Env</li>
<li>application.properties/application.yaml</li>
<li>spring profiles</li>
<li>spring cloud config</li>
</ul>
<p>还有很多配置注入的方式，令人眼花缭乱。</p>
<h2 id="获取运行时具体配置"><a href="#获取运行时具体配置" class="headerlink" title="获取运行时具体配置"></a>获取运行时具体配置</h2><p>对于开发人员来说，在运行时怎样确定某个配置是否生效？它的具体值是什么？</p>
<p>用Arthas可以一行命令获取。</p>
<p>比如获取<code>server.port</code>的具体值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vmtool --action getInstances --className org.springframework.context.ConfigurableApplicationContext --express <span class="string">&#x27;instances[0].getEnvironment().getProperty(&quot;server.port&quot;)&#x27;</span></span><br><span class="line">@String[8810]</span><br></pre></td></tr></table></figure>

<h2 id="获取具体的配置来源"><a href="#获取具体的配置来源" class="headerlink" title="获取具体的配置来源"></a>获取具体的配置来源</h2><p>但是怎样具体是从哪个配置源来的？</p>
<ol>
<li><p> 对于 spring boot应用，可以打开一个新的 terminal 窗口，执行 <code>telnet 127.0.0.1 3658</code>连接上Arthas。</p>
</li>
<li><p>执行下面的 watch 命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.context.properties.source.ConfigurationPropertySourcesPropertySource findConfigurationProperty</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li> 在原来窗口用上面的<code>vmtool</code>命令来获取<code>server.port</code>的值</li>
</ol>
<p>可以看到 watch 返回结果里有具体的配置来源<code>application.yml</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ watch org.springframework.boot.context.properties.source.ConfigurationPropertySourcesPropertySource findConfigurationProperty</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 2) cost <span class="keyword">in</span> 217 ms, listenerId: 5</span><br><span class="line">method=org.springframework.boot.context.properties.source.ConfigurationPropertySourcesPropertySource.findConfigurationProperty location=AtExit</span><br><span class="line">ts=2023-11-27 16:08:07.696; [cost=0.327042ms] result=@ArrayList[</span><br><span class="line">    @Object[][isEmpty=<span class="literal">false</span>;size=1],</span><br><span class="line">    @ConfigurationPropertySourcesPropertySource[ConfigurationPropertySourcesPropertySource &#123;name=<span class="string">&#x27;configurationProperties&#x27;</span>&#125;],</span><br><span class="line">    @ConfigurationProperty[[ConfigurationProperty@18fb3ec9 name = server.port, value = 7001, origin = class path resource [application.yml] - 2:9]],</span><br></pre></td></tr></table></figure>

<h1 id="Exit-Stop"><a href="#Exit-Stop" class="headerlink" title="Exit/Stop"></a>Exit/Stop</h1><h2 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h2><p>Arthas 在 watch/trace 等命令时，实际上是修改了应用的字节码，插入增强的代码。显式执行 <code>reset</code> 命令，可以清除掉这些增强代码。</p>
<h2 id="退出-Arthas"><a href="#退出-Arthas" class="headerlink" title="退出 Arthas"></a>退出 Arthas</h2><p>用 <code>exit</code> 或者 <code>quit</code> 命令可以退出 Arthas。</p>
<p>退出 Arthas 之后，还可以再次用 <code>java -jar arthas-boot.jar</code> 来连接。</p>
<h2 id="彻底退出-Arthas"><a href="#彻底退出-Arthas" class="headerlink" title="彻底退出 Arthas"></a>彻底退出 Arthas</h2><p><code>exit/quit</code> 命令只是退出当前 session，arthas server 还在目标进程中运行。</p>
<p>想完全退出 Arthas，可以执行 <code>stop</code> 命令。</p>
<h1 id="Arthas-boot-支持的参数"><a href="#Arthas-boot-支持的参数" class="headerlink" title="Arthas-boot 支持的参数"></a>Arthas-boot 支持的参数</h1><p><code>arthas-boot.jar</code> 支持很多参数，可以执行 <code>java -jar arthas-boot.jar -h</code> 来查看。</p>
<h2 id="允许外部访问"><a href="#允许外部访问" class="headerlink" title="允许外部访问"></a>允许外部访问</h2><p>默认情况下，arthas server 侦听的是 <code>127.0.0.1</code> 这个 IP，如果希望远程可以访问，可以使用<code>--target-ip</code> 的参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar --target-ip</span><br></pre></td></tr></table></figure>

<h2 id="列出所有的版本"><a href="#列出所有的版本" class="headerlink" title="列出所有的版本"></a>列出所有的版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar --versions</span><br></pre></td></tr></table></figure>

<p>使用指定版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar --use-version 3.1.0</span><br></pre></td></tr></table></figure>

<h2 id="只侦听-Telnet-端口，不侦听-HTTP-端口"><a href="#只侦听-Telnet-端口，不侦听-HTTP-端口" class="headerlink" title="只侦听 Telnet 端口，不侦听 HTTP 端口"></a>只侦听 Telnet 端口，不侦听 HTTP 端口</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar --telnet-port 9999 --http-port -1</span><br></pre></td></tr></table></figure>

<h2 id="打印运行的详情"><a href="#打印运行的详情" class="headerlink" title="打印运行的详情"></a>打印运行的详情</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar -v</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/01/03/Java%E5%BA%94%E7%94%A8%E8%AF%8A%E6%96%AD%E5%88%A9%E5%99%A8Arthas/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="wotzc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cai">
      <meta itemprop="description" content="真正的大师永远都怀着一颗学徒的心">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cai">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/03/Java%E5%BA%94%E7%94%A8%E8%AF%8A%E6%96%AD%E5%88%A9%E5%99%A8Arthas/" class="post-title-link" itemprop="url">Arthas基础教程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-01-03 16:18:54" itemprop="dateCreated datePublished" datetime="2024-01-03T16:18:54+08:00">2024-01-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-10 15:26:19" itemprop="dateModified" datetime="2024-01-10T15:26:19+08:00">2024-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">Java诊断工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Arthas 是一款线上监控诊断产品，通过全局视角实时查看应用 load、内存、gc、线程的状态信息，并能在不修改应用代码的情况下，对业务问题进行诊断，包括查看方法调用的出入参、异常，监测方法执行耗时，类加载信息等，大大提升线上问题排查效率。</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>通常，本地开发环境无法访问生产环境。如果在生产环境中遇到问题，则无法使用 IDE 远程调试。更糟糕的是，在生产环境中调试是不可接受的，因为它会暂停所有线程，导致服务暂停。</p>
<p>开发人员可以尝试在测试环境或者预发环境中复现生产环境中的问题。但是，某些问题无法在不同的环境中轻松复现，甚至在重新启动后就消失了。</p>
<p>如果您正在考虑在代码中添加一些日志以帮助解决问题，您将必须经历以下阶段：测试、预发，然后生产。这种方法效率低下，更糟糕的是，该问题可能无法解决，因为一旦 JVM 重新启动，它可能无法复现，如上文所述。</p>
<p>Arthas 旨在解决这些问题。开发人员可以在线解决生产问题。无需 JVM 重启，无需代码更改。 Arthas 作为观察者永远不会暂停正在运行的线程。</p>
<h1 id="Arthas（阿尔萨斯）能为你做什么？"><a href="#Arthas（阿尔萨斯）能为你做什么？" class="headerlink" title="Arthas（阿尔萨斯）能为你做什么？"></a>Arthas（阿尔萨斯）能为你做什么？</h1><p><code>Arthas</code> 是 Alibaba 开源的 Java 诊断工具，深受开发者喜爱。</p>
<p>当你遇到以下类似问题而束手无策时，<code>Arthas</code>可以帮助你解决：</p>
<ol>
<li>这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？</li>
<li>我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？</li>
<li>遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？</li>
<li>线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！</li>
<li>是否有一个全局视角来查看系统的运行状况？</li>
<li>有什么办法可以监控到 JVM 的实时运行状态？</li>
<li>怎么快速定位应用的热点，生成火焰图？</li>
<li>怎样直接从 JVM 内查找某个类的实例？</li>
</ol>
<p><code>Arthas</code> 支持 JDK 6+，支持 Linux/Mac/Windows，采用命令行交互模式，同时提供丰富的 <code>Tab</code> 自动补全功能，进一步方便进行问题的定位和诊断。</p>
<h1 id="安装启动Arthas"><a href="#安装启动Arthas" class="headerlink" title="安装启动Arthas"></a>安装启动Arthas</h1><p>在命令行下面执行（使用和目标进程一致的用户启动，否则可能 attach 失败）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://arthas.aliyun.com/arthas-boot.jar</span><br><span class="line">java -jar arthas-boot.jar</span><br></pre></td></tr></table></figure>

<p>如果下载速度比较慢，可以使用 aliyun 的镜像：<code>java -jar arthas-boot.jar --repo-mirror aliyun --use-http</code></p>
<p>选择应用 java 进程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ $ java -jar arthas-boot.jar</span><br><span class="line">* [1]: 35542</span><br><span class="line">  [2]: 71560 math-game.jar</span><br></pre></td></tr></table></figure>

<p><code>math-game</code>进程是第 2 个，则输入 2，再输入<code>回车/enter</code>。Arthas 会 attach 到目标进程上，并输出日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[INFO] Try to attach process 71560</span><br><span class="line">[INFO] Attach process 71560 success.</span><br><span class="line">[INFO] arthas-client connect 127.0.0.1 3658</span><br><span class="line">  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.</span><br><span class="line"> /  O  \ |  .--. <span class="string">&#x27;&#x27;</span>--.  .--<span class="string">&#x27;|  &#x27;</span>--<span class="string">&#x27;  | /  O  \ &#x27;</span>   .-<span class="string">&#x27;</span></span><br><span class="line"><span class="string">|  .-.  ||  &#x27;</span>--<span class="string">&#x27;.&#x27;</span>   |  |   |  .--.  ||  .-.  |`.  `-.</span><br><span class="line">|  | |  ||  |\  \    |  |   |  |  |  ||  | |  |.-<span class="string">&#x27;    |</span></span><br><span class="line"><span class="string">`--&#x27;</span> `--<span class="string">&#x27;`--&#x27;</span> <span class="string">&#x27;--&#x27;</span>   `--<span class="string">&#x27;   `--&#x27;</span>  `--<span class="string">&#x27;`--&#x27;</span> `--<span class="string">&#x27;`-----&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wiki: https://arthas.aliyun.com/doc</span><br><span class="line">version: 3.0.5.20181127201536</span><br><span class="line">pid: 71560</span><br><span class="line">time: 2018-11-28 19:16:24</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="表达式核心变量"><a href="#表达式核心变量" class="headerlink" title="表达式核心变量"></a>表达式核心变量</h1><p>无论是匹配表达式也好、观察表达式也罢，他们核心判断变量都是围绕着一个 Arthas 中的通用通知对象 <code>Advice</code> 进行。</p>
<p>它的简略代码结构如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Advice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader loader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; clazz;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArthasMethod method;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object target;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] params;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object returnObj;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Throwable throwExp;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isBefore;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isThrow;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isReturn;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter/setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里列一个表格来说明不同变量的含义</p>
<table>
<thead>
<tr>
<th align="right">变量名</th>
<th align="left">变量解释</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><code>loader</code></td>
<td align="left">本次调用类所在的 <code>ClassLoader</code></td>
</tr>
<tr>
<td align="right"><code>clazz</code></td>
<td align="left">本次调用类的 <code>Class</code> 引用</td>
</tr>
<tr>
<td align="right"><code>method</code></td>
<td align="left">本次调用方法反射引用</td>
</tr>
<tr>
<td align="right"><code>target</code></td>
<td align="left">本次调用类的实例</td>
</tr>
<tr>
<td align="right"><code>params</code></td>
<td align="left">本次调用参数列表，这是一个数组，如果方法是无参方法则为空数组</td>
</tr>
<tr>
<td align="right"><code>returnObj</code></td>
<td align="left">本次调用返回的对象。当且仅当 <code>isReturn==true</code> 成立时候有效，表明方法调用是以正常返回的方式结束。如果当前方法无返回值 <code>void</code>，则值为 null</td>
</tr>
<tr>
<td align="right"><code>throwExp</code></td>
<td align="left">本次调用抛出的异常。当且仅当 <code>isThrow==true</code> 成立时有效，表明方法调用是以抛出异常的方式结束。</td>
</tr>
<tr>
<td align="right"><code>isBefore</code></td>
<td align="left">辅助判断标记，当前的通知节点有可能是在方法一开始就通知，此时 <code>isBefore==true</code> 成立，同时 <code>isThrow==false</code> 和 <code>isReturn==false</code>，因为在方法刚开始时，还无法确定方法调用将会如何结束。</td>
</tr>
<tr>
<td align="right"><code>isThrow</code></td>
<td align="left">辅助判断标记，当前的方法调用以抛异常的形式结束。</td>
</tr>
<tr>
<td align="right"><code>isReturn</code></td>
<td align="left">辅助判断标记，当前的方法调用以正常返回的形式结束。</td>
</tr>
</tbody></table>
<p>所有变量都可以在表达式中直接使用，如果在表达式中编写了不符合 OGNL 脚本语法或者引入了不在表格中的变量，则退出命令的执行；用户可以根据当前的异常信息修正<code>条件表达式</code>或<code>观察表达式</code>。</p>
<ul>
<li>特殊用法请参考：<a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/71">https://github.com/alibaba/arthas/issues/71在新窗口打开</a></li>
<li>OGNL 表达式官网：<a target="_blank" rel="noopener" href="https://commons.apache.org/proper/commons-ognl/language-guide.html">https://commons.apache.org/proper/commons-ognl/language-guide.html</a></li>
</ul>
<h1 id="命令列表"><a href="#命令列表" class="headerlink" title="命令列表"></a>命令列表</h1><h2 id="jvm-相关"><a href="#jvm-相关" class="headerlink" title="jvm 相关"></a>jvm 相关</h2><ul>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/dashboard.html"><code>dashboard</code></a> - 当前系统的实时数据面板</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/getstatic.html"><code>getstatic</code></a> - 查看类的静态属性</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/heapdump.html"><code>heapdump</code></a> - dump java heap, 类似 jmap 命令的 heap dump 功能</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/jvm.html"><code>jvm</code></a> - 查看当前 JVM 的信息</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/logger.html"><code>logger</code></a> - 查看和修改 logger</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/mbean.html"><code>mbean</code></a> - 查看 Mbean 的信息</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/memory.html"><code>memory</code></a> - 查看 JVM 的内存信息</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/ognl.html"><code>ognl</code></a> - 执行 ognl 表达式</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/perfcounter.html"><code>perfcounter</code></a> - 查看当前 JVM 的 Perf Counter 信息</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/sysenv.html"><code>sysenv</code></a> - 查看 JVM 的环境变量</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/sysprop.html"><code>sysprop</code></a> - 查看和修改 JVM 的系统属性</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/thread.html"><code>thread</code></a> - 查看当前 JVM 的线程堆栈信息</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/vmoption.html"><code>vmoption</code></a> - 查看和修改 JVM 里诊断相关的 option</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/vmtool.html"><code>vmtool</code></a> - 从 jvm 里查询对象，执行 forceGc</li>
</ul>
<h2 id="class-classloader-相关"><a href="#class-classloader-相关" class="headerlink" title="class/classloader 相关"></a>class/classloader 相关</h2><ul>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/classloader.html"><code>classloader</code></a> - 查看 classloader 的继承树，urls，类加载信息，使用 classloader 去 getResource</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/dump.html"><code>dump</code></a> - dump 已加载类的 byte code 到特定目录</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/jad.html"><code>jad</code></a> - 反编译指定已加载类的源码</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/mc.html"><code>mc</code></a> - 内存编译器，内存编译<code>.java</code>文件为<code>.class</code>文件</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/redefine.html"><code>redefine</code></a> - 加载外部的<code>.class</code>文件，redefine 到 JVM 里</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/retransform.html"><code>retransform</code></a> - 加载外部的<code>.class</code>文件，retransform 到 JVM 里</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/sc.html"><code>sc</code></a> - 查看 JVM 已加载的类信息</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/sm.html"><code>sm</code></a> - 查看已加载类的方法信息</li>
</ul>
<h2 id="monitor-watch-trace-相关"><a href="#monitor-watch-trace-相关" class="headerlink" title="monitor/watch/trace 相关"></a>monitor/watch/trace 相关</h2><details class="note warning no-icon"><summary><p>注意</p>
</summary>
<p>请注意，这些命令，都通过字节码增强技术来实现的，会在指定类的方法中插入一些切面来实现数据统计和观测，因此在线上、预发使用时，请尽量明确需要观测的类、方法以及条件，诊断结束要执行 <code>stop</code> 或将增强过的类执行 <code>reset</code> 命令。</p>

</details>

<ul>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/monitor.html"><code>monitor</code></a> - 方法执行监控</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/stack.html"><code>stack</code></a> - 输出当前方法被调用的调用路径</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/trace.html"><code>trace</code></a> - 方法内部调用路径，并输出方法路径上的每个节点上耗时</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/tt.html"><code>tt</code></a> - 方法执行数据的时空隧道，记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/watch.html"><code>watch</code></a> - 方法执行数据观测</li>
</ul>
<h2 id="profiler-火焰图"><a href="#profiler-火焰图" class="headerlink" title="profiler/火焰图"></a>profiler/火焰图</h2><ul>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/profiler.html"><code>profiler</code></a> - 使用<a target="_blank" rel="noopener" href="https://github.com/jvm-profiling-tools/async-profiler">async-profiler在新窗口打开</a>对应用采样，生成火焰图</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/jfr.html"><code>jfr</code></a> - 动态开启关闭 JFR 记录</li>
</ul>
<h2 id="鉴权"><a href="#鉴权" class="headerlink" title="鉴权"></a>鉴权</h2><ul>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/auth.html"><code>auth</code></a> - 鉴权</li>
</ul>
<h2 id="options"><a href="#options" class="headerlink" title="options"></a>options</h2><ul>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/options.html"><code>options</code></a> - 查看或设置 Arthas 全局开关</li>
</ul>
<h2 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h2><p>Arthas 支持使用管道对上述命令的结果进行进一步的处理，如<code>sm java.lang.String * | grep &#39;index&#39;</code></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/grep.html"><code>grep</code></a> - 搜索满足条件的结果</li>
<li>plaintext - 将命令的结果去除 ANSI 颜色</li>
<li>wc - 按行统计输出结果</li>
</ul>
<h2 id="后台异步任务"><a href="#后台异步任务" class="headerlink" title="后台异步任务"></a>后台异步任务</h2><p>当线上出现偶发的问题，比如需要 watch 某个条件，而这个条件一天可能才会出现一次时，异步后台任务就派上用场了，详情请参考<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/async.html">这里</a></p>
<ul>
<li>使用 <code>&gt;</code> 将结果重写向到日志文件，使用 <code>&amp;</code> 指定命令是后台运行，session 断开不影响任务执行（生命周期默认为 1 天）</li>
<li><code>jobs</code> - 列出所有 job</li>
<li><code>kill</code> - 强制终止任务</li>
<li><code>fg</code> - 将暂停的任务拉到前台执行</li>
<li><code>bg</code> - 将暂停的任务放到后台执行</li>
</ul>
<h2 id="基础命令"><a href="#基础命令" class="headerlink" title="基础命令"></a>基础命令</h2><ul>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/base64.html"><code>base64</code></a> - base64 编码转换，和 linux 里的 base64 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/cat.html"><code>cat</code></a> - 打印文件内容，和 linux 里的 cat 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/cls.html"><code>cls</code></a> - 清空当前屏幕区域</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/echo.html"><code>echo</code></a> - 打印参数，和 linux 里的 echo 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/grep.html"><code>grep</code></a> - 匹配查找，和 linux 里的 grep 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/help.html"><code>help</code></a> - 查看命令帮助信息</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/history.html"><code>history</code></a> - 打印命令历史</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/keymap.html"><code>keymap</code></a> - Arthas 快捷键列表及自定义快捷键</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/pwd.html"><code>pwd</code></a> - 返回当前的工作目录，和 linux 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/quit.html"><code>quit</code></a> - 退出当前 Arthas 客户端，其他 Arthas 客户端不受影响</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/reset.html"><code>reset</code></a> - 重置增强类，将被 Arthas 增强过的类全部还原，Arthas 服务端关闭时会重置所有增强过的类</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/session.html"><code>session</code></a> - 查看当前会话的信息</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/stop.html"><code>stop</code></a> - 关闭 Arthas 服务端，所有 Arthas 客户端全部退出</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/tee.html"><code>tee</code></a> - 复制标准输入到标准输出和指定的文件，和 linux 里的 tee 命令类似</li>
<li><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/version.html"><code>version</code></a> - 输出当前目标 Java 进程所加载的 Arthas 版本号</li>
</ul>
<hr>
<h1 id="Arthas-基础教程"><a href="#Arthas-基础教程" class="headerlink" title="Arthas 基础教程"></a>Arthas 基础教程</h1><h2 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h2><p><code>dashboard</code> 命令可以查看当前系统的实时数据面板，<code>dashboard</code> 命令可以查看当前系统的实时数据面板。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ dashboard</span><br><span class="line">ID   NAME                           GROUP           PRIORITY   STATE     %CPU      DELTA_TIME TIME      INTERRUPTE DAEMON</span><br><span class="line">-1   C2 CompilerThread0             -               -1         -         1.55      0.077      0:8.684   <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">53   Timer-for-arthas-dashboard-07b system          5          RUNNABLE  0.08      0.004      0:0.004   <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">22   scheduling-1                   main            5          TIMED_WAI 0.06      0.003      0:0.287   <span class="literal">false</span>      <span class="literal">false</span></span><br><span class="line">-1   C1 CompilerThread0             -               -1         -         0.06      0.003      0:2.171   <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">-1   VM Periodic Task Thread        -               -1         -         0.03      0.001      0:0.092   <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">49   arthas-NettyHttpTelnetBootstra system          5          RUNNABLE  0.02      0.001      0:0.156   <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">16   Catalina-utility-1             main            1          TIMED_WAI 0.0       0.000      0:0.029   <span class="literal">false</span>      <span class="literal">false</span></span><br><span class="line">-1   G1 Young RemSet Sampling       -               -1         -         0.0       0.000      0:0.019   <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">17   Catalina-utility-2             main            1          WAITING   0.0       0.000      0:0.025   <span class="literal">false</span>      <span class="literal">false</span></span><br><span class="line">34   http-nio-8080-ClientPoller     main            5          RUNNABLE  0.0       0.000      0:0.016   <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">23   http-nio-8080-BlockPoller      main            5          RUNNABLE  0.0       0.000      0:0.011   <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">-1   VM Thread                      -               -1         -         0.0       0.000      0:0.032   <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">-1   Service Thread                 -               -1         -         0.0       0.000      0:0.006   <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">-1   GC Thread<span class="comment">#5                    -               -1         -         0.0       0.000      0:0.043   false      true</span></span><br><span class="line">Memory                     used     total    max      usage    GC</span><br><span class="line">heap                       36M      70M      4096M    0.90%    gc.g1_young_generation.count   12</span><br><span class="line">g1_eden_space              6M       18M      -1       33.33%                                  86</span><br><span class="line">g1_old_gen                 30M      50M      4096M    0.74%    gc.g1_old_generation.count     0</span><br><span class="line">g1_survivor_space          491K     2048K    -1       24.01%   gc.g1_old_generation.time(ms)  0</span><br><span class="line">nonheap                    66M      69M      -1       96.56%</span><br><span class="line">codeheap_<span class="string">&#x27;non-nmethods&#x27;</span>    1M       2M       5M       22.39%</span><br><span class="line">metaspace                  46M      47M      -1       98.01%</span><br><span class="line">Runtime</span><br><span class="line">os.name                                                        Mac OS X</span><br><span class="line">os.version                                                     10.15.4</span><br><span class="line">java.version                                                   15</span><br><span class="line">java.home                                                      /Library/Java/JavaVirtualMachines/jdk-15.jdk/Contents/Home</span><br><span class="line">systemload.average                                             10.68</span><br><span class="line">processors                                                     8</span><br><span class="line">uptime                                                         272s </span><br></pre></td></tr></table></figure>

<p>当运行在 Ali-tomcat 时，会显示当前 tomcat 的实时信息，如 HTTP 请求的 qps, rt, 错误数, 线程池信息等等。</p>
<h3 id="数据说明"><a href="#数据说明" class="headerlink" title="数据说明"></a>数据说明</h3><ul>
<li><code>ID</code>: Java 级别的线程 ID，注意这个 ID 不能跟 jstack 中的 nativeID 一一对应。</li>
<li><code>NAME</code>: 线程名</li>
<li><code>GROUP</code>: 线程组名</li>
<li><code>PRIORITY</code>: 线程优先级，1~10 之间的数字，越大表示优先级越高</li>
<li><code>STATE</code>: 线程的状态</li>
<li><code>CPU%</code>: 线程的 cpu 使用率。比如采样间隔 1000ms，某个线程的增量 cpu 时间为 100ms，则 cpu 使用率=100/1000=10%</li>
<li><code>DELTA_TIME</code>: 上次采样之后线程运行增量 CPU 时间，数据格式为<code>秒</code></li>
<li><code>TIME</code>: 线程运行总 CPU 时间，数据格式为<code>分:秒</code></li>
<li><code>INTERRUPTED</code>: 线程当前的中断位状态</li>
<li><code>DAEMON</code>: 是否是 daemon 线程</li>
</ul>
<h3 id="JVM-内部线程"><a href="#JVM-内部线程" class="headerlink" title="JVM 内部线程"></a>JVM 内部线程</h3><p>Java 8 之后支持获取 JVM 内部线程 CPU 时间，这些线程只有名称和 CPU 时间，没有 ID 及状态等信息（显示 ID 为 -1）。 通过内部线程可以观测到 JVM 活动，如 GC、JIT 编译等占用 CPU 情况，方便了解 JVM 整体运行状况。</p>
<ul>
<li>当 JVM 堆 (heap)/元数据 (metaspace) 空间不足或 OOM 时，可以看到 GC 线程的 CPU 占用率明显高于其他的线程。</li>
<li>当执行<code>trace/watch/tt/redefine</code> 等命令后，可以看到 JIT 线程活动变得更频繁。因为 JVM 热更新 class 字节码时清除了此 class 相关的 JIT 编译结果，需要重新编译。</li>
</ul>
<p>JVM 内部线程包括下面几种：</p>
<ul>
<li>JIT 编译线程：如 <code>C1 CompilerThread0</code> , <code>C2 CompilerThread0</code></li>
<li>GC 线程：如<code>GC Thread0</code> , <code>G1 Young RemSet Sampling</code></li>
<li>其它内部线程：如<code>VM Periodic Task Thread</code> , <code>VM Thread</code> , <code>Service Thread</code></li>
</ul>
<h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right">[i:]</td>
<td align="left">刷新实时数据的时间间隔 (ms)，默认 5000ms</td>
</tr>
<tr>
<td align="right">[n:]</td>
<td align="left">刷新实时数据的次数</td>
</tr>
</tbody></table>
<h4 id="使用参考"><a href="#使用参考" class="headerlink" title="使用参考:"></a>使用参考:</h4><p>每隔5000毫秒进行刷新一次，总共刷新3次</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dashboard -i 5000 -n 3</span><br></pre></td></tr></table></figure>

<h3 id="截图展示"><a href="#截图展示" class="headerlink" title="截图展示"></a>截图展示</h3><p><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2024/arthas/dashboard.png"></p>
<hr>
<h2 id="help"><a href="#help" class="headerlink" title="help"></a>help</h2><div class="note info no-icon"><p>提示</p>
<p>[help 指令]的等同于[指令 -help]，都是查看具体指令的使用说明。</p>
</div>

<h3 id="参数说明-1"><a href="#参数说明-1" class="headerlink" title="参数说明"></a>参数说明</h3><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right">不接参数</td>
<td align="left">查询当前 arthas 版本支持的指令以及指令描述</td>
</tr>
<tr>
<td align="right">[name:]</td>
<td align="left">查询具体指令的使用说明</td>
</tr>
</tbody></table>
<h3 id="使用参考-1"><a href="#使用参考-1" class="headerlink" title="使用参考"></a>使用参考</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ help</span><br><span class="line"> NAME         DESCRIPTION</span><br><span class="line"> help         Display Arthas Help</span><br><span class="line"> auth         Authenticates the current session</span><br><span class="line"> keymap       Display all the available keymap for the specified connection.</span><br><span class="line"> sc           Search all the classes loaded by JVM</span><br><span class="line"> sm           Search the method of classes loaded by JVM</span><br><span class="line"> classloader  Show classloader info</span><br><span class="line"> jad          Decompile class</span><br><span class="line"> getstatic    Show the static field of a class</span><br><span class="line"> monitor      Monitor method execution statistics, e.g. total/success/failure count, average rt, fail rate, etc.</span><br><span class="line"> stack        Display the stack trace for the specified class and method</span><br><span class="line"> thread       Display thread info, thread stack</span><br><span class="line"> trace        Trace the execution time of specified method invocation.</span><br><span class="line"> watch        Display the input/output parameter, return object, and thrown exception of specified method invocation</span><br><span class="line"> tt           Time Tunnel</span><br><span class="line"> jvm          Display the target JVM information</span><br><span class="line"> perfcounter  Display the perf counter information.</span><br><span class="line"> ognl         Execute ognl expression.</span><br><span class="line"> mc           Memory compiler, compiles java files into bytecode and class files in memory.</span><br><span class="line"> redefine     Redefine classes. @see Instrumentation#redefineClasses(ClassDefinition...)</span><br><span class="line"> retransform  Retransform classes. @see Instrumentation#retransformClasses(Class...)</span><br><span class="line"> dashboard    Overview of target jvm&#x27;s thread, memory, gc, vm, tomcat info.</span><br><span class="line"> dump         Dump class byte array from JVM</span><br><span class="line"> heapdump     Heap dump</span><br><span class="line"> options      View and change various Arthas options</span><br><span class="line"> cls          Clear the screen</span><br><span class="line"> reset        Reset all the enhanced classes</span><br><span class="line"> version      Display Arthas version</span><br><span class="line"> session      Display current session information</span><br><span class="line"> sysprop      Display, and change the system properties.</span><br><span class="line"> sysenv       Display the system env.</span><br><span class="line"> vmoption     Display, and update the vm diagnostic options.</span><br><span class="line"> logger       Print logger info, and update the logger level</span><br><span class="line"> history      Display command history</span><br><span class="line"> cat          Concatenate and print files</span><br><span class="line"> base64       Encode and decode using Base64 representation</span><br><span class="line"> echo         write arguments to the standard output</span><br><span class="line"> pwd          Return working directory name</span><br><span class="line"> mbean        Display the mbean information</span><br><span class="line"> grep         grep command for pipes.</span><br><span class="line"> tee          tee command for pipes.</span><br><span class="line"> profiler     Async Profiler. https://github.com/jvm-profiling-tools/async-profiler</span><br><span class="line"> stop         Stop/Shutdown Arthas server and exit the console.</span><br></pre></td></tr></table></figure>



<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ help dashboard</span><br><span class="line"> USAGE:</span><br><span class="line">  dashboard [-h] [-i &lt;value&gt;] [-n &lt;value&gt;]</span><br><span class="line"></span><br><span class="line">SUMMARY:</span><br><span class="line">  Overview of target jvm&#x27;s thread, memory, gc, vm, tomcat info.</span><br><span class="line"></span><br><span class="line">EXAMPLES:</span><br><span class="line">  dashboard</span><br><span class="line">  dashboard -n 10</span><br><span class="line">  dashboard -i 2000</span><br><span class="line"></span><br><span class="line">WIKI:</span><br><span class="line">  https://arthas.aliyun.com/doc/dashboard</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">-h, --help                              this help</span><br><span class="line">-i, --interval &lt;value&gt;                  The interval (in ms) between two executions, default is 5000 ms.</span><br><span class="line">-n, --number-of-execution &lt;value&gt;       The number of times this command will be executed.</span><br></pre></td></tr></table></figure>

<h2 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h2><p><code>thread 1</code> 命令会打印线程 ID 1 的栈。</p>
<p>Arthas 支持管道，可以用 <code>thread 1 | grep &#39;main(&#39;</code> 查找到<code>main class</code> 。</p>
<p>可以看到<code>main class</code> 是<code>demo.MathGame</code> ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> thread 1 | grep <span class="string">&#x27;main(&#x27;</span></span></span><br><span class="line">    at demo.MathGame.main(MathGame.java:17)</span><br></pre></td></tr></table></figure>

<div class="note info no-icon"><p>提示</p>
<p>查看当前线程信息，查看线程的堆栈。</p>
</div>

<h3 id="参数说明-2"><a href="#参数说明-2" class="headerlink" title="参数说明"></a>参数说明</h3><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>id</em></td>
<td align="left">线程 id</td>
</tr>
<tr>
<td align="right">[n:]</td>
<td align="left">指定最忙的前 N 个线程并打印堆栈</td>
</tr>
<tr>
<td align="right">[b]</td>
<td align="left">找出当前阻塞其他线程的线程</td>
</tr>
<tr>
<td align="right">[i <code>&lt;value&gt;</code>]</td>
<td align="left">指定 cpu 使用率统计的采样间隔，单位为毫秒，默认值为 200</td>
</tr>
<tr>
<td align="right">[–all]</td>
<td align="left">显示所有匹配的线程</td>
</tr>
</tbody></table>
<h3 id="使用参考-2"><a href="#使用参考-2" class="headerlink" title="使用参考"></a>使用参考</h3><h4 id="支持一键展示当前最忙的前-N-个线程并打印堆栈："><a href="#支持一键展示当前最忙的前-N-个线程并打印堆栈：" class="headerlink" title="支持一键展示当前最忙的前 N 个线程并打印堆栈："></a>支持一键展示当前最忙的前 N 个线程并打印堆栈：</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;Reference Handler&quot;</span> Id=2 cpuUsage=0.0% deltaTime=0ms time=0ms WAITING on java.lang.ref.Reference<span class="variable">$Lock</span>@2718d45c</span><br><span class="line">    at java.lang.Object.wait(Native Method)</span><br><span class="line">    -  waiting on java.lang.ref.Reference<span class="variable">$Lock</span>@2718d45c</span><br><span class="line">    at java.lang.Object.wait(Unknown Source)</span><br><span class="line">    at java.lang.ref.Reference.tryHandlePending(Unknown Source)</span><br><span class="line">    at java.lang.ref.Reference<span class="variable">$ReferenceHandler</span>.run(Unknown Source)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Finalizer&quot;</span> Id=3 cpuUsage=0.0% deltaTime=0ms time=0ms WAITING on java.lang.ref.ReferenceQueue<span class="variable">$Lock</span>@6ce75d0d</span><br><span class="line">    at java.lang.Object.wait(Native Method)</span><br><span class="line">    -  waiting on java.lang.ref.ReferenceQueue<span class="variable">$Lock</span>@6ce75d0d</span><br><span class="line">    at java.lang.ref.ReferenceQueue.remove(Unknown Source)</span><br><span class="line">    at java.lang.ref.ReferenceQueue.remove(Unknown Source)</span><br><span class="line">    at java.lang.ref.Finalizer<span class="variable">$FinalizerThread</span>.run(Unknown Source)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Signal Dispatcher&quot;</span> Id=4 cpuUsage=0.0% deltaTime=0ms time=0ms RUNNABLE</span><br></pre></td></tr></table></figure>

<ul>
<li>没有线程 ID，包含<code>[Internal]</code>表示为 JVM 内部线程，参考dashboard命令的介绍。</li>
<li><code>cpuUsage</code>为采样间隔时间内线程的 CPU 使用率，与dashboard命令的数据一致。</li>
<li><code>deltaTime</code>为采样间隔时间内线程的增量 CPU 时间，小于 1ms 时被取整显示为 0ms。</li>
<li><code>time</code> 线程运行总 CPU 时间。</li>
</ul>
<p>注意：线程栈为第二采样结束时获取，不能表明采样间隔时间内该线程都是在处理相同的任务。建议间隔时间不要太长，可能间隔时间越大越不准确。 可以根据具体情况尝试指定不同的间隔时间，观察输出结果。</p>
<h4 id="当没有参数时，显示第一页线程的信息"><a href="#当没有参数时，显示第一页线程的信息" class="headerlink" title="当没有参数时，显示第一页线程的信息"></a>当没有参数时，显示第一页线程的信息</h4><p>默认按照 CPU 增量时间降序排列，只显示第一页数据。</p>
<h4 id="thread-–all-显示所有匹配的线程"><a href="#thread-–all-显示所有匹配的线程" class="headerlink" title="thread –all, 显示所有匹配的线程"></a>thread –all, 显示所有匹配的线程</h4><p>显示所有匹配线程信息，有时需要获取全部 JVM 的线程数据进行分析。</p>
<h4 id="thread-id-显示指定线程的运行堆栈"><a href="#thread-id-显示指定线程的运行堆栈" class="headerlink" title="thread id, 显示指定线程的运行堆栈"></a>thread id, 显示指定线程的运行堆栈</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ thread 1</span><br><span class="line"><span class="string">&quot;main&quot;</span> Id=1 TIMED_WAITING</span><br><span class="line">    at java.lang.Thread.sleep(Native Method)</span><br><span class="line">    at java.lang.Thread.sleep(Unknown Source)</span><br><span class="line">    at java.util.concurrent.TimeUnit.sleep(Unknown Source)</span><br><span class="line">    at demo.MathGame.main(MathGame.java:17)</span><br></pre></td></tr></table></figure>

<h4 id="thread-b-找出当前阻塞其他线程的线程"><a href="#thread-b-找出当前阻塞其他线程的线程" class="headerlink" title="thread -b, 找出当前阻塞其他线程的线程"></a>thread -b, 找出当前阻塞其他线程的线程</h4><p>有时候我们发现应用卡住了， 通常是由于某个线程拿住了某个锁， 并且其他线程都在等待这把锁造成的。 为了排查这类问题， arthas 提供了<code>thread -b</code>， 一键找出那个罪魁祸首。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ thread -b</span><br><span class="line"><span class="string">&quot;http-bio-8080-exec-4&quot;</span> Id=27 TIMED_WAITING</span><br><span class="line">    at java.lang.Thread.sleep(Native Method)</span><br><span class="line">    at test.arthas.TestThreadBlocking.doGet(TestThreadBlocking.java:22)</span><br><span class="line">    -  locked java.lang.Object@725be470 &lt;---- but blocks 4 other threads!</span><br><span class="line">    at javax.servlet.http.HttpServlet.service(HttpServlet.java:624)</span><br><span class="line">    at javax.servlet.http.HttpServlet.service(HttpServlet.java:731)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:303)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)</span><br><span class="line">    at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)</span><br><span class="line">    at test.filter.TestDurexFilter.doFilter(TestDurexFilter.java:46)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)</span><br><span class="line">    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)</span><br><span class="line">    at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)</span><br><span class="line">    at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:122)</span><br><span class="line">    at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:505)</span><br><span class="line">    at com.taobao.tomcat.valves.ContextLoadFilterValve<span class="variable">$FilterChainAdapter</span>.doFilter(ContextLoadFilterValve.java:191)</span><br><span class="line">    at com.taobao.eagleeye.EagleEyeFilter.doFilter(EagleEyeFilter.java:81)</span><br><span class="line">    at com.taobao.tomcat.valves.ContextLoadFilterValve.invoke(ContextLoadFilterValve.java:150)</span><br><span class="line">    at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:170)</span><br><span class="line">    at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:103)</span><br><span class="line">    at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)</span><br><span class="line">    at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:429)</span><br><span class="line">    at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1085)</span><br><span class="line">    at org.apache.coyote.AbstractProtocol<span class="variable">$AbstractConnectionHandler</span>.process(AbstractProtocol.java:625)</span><br><span class="line">    at org.apache.tomcat.util.net.JIoEndpoint<span class="variable">$SocketProcessor</span>.run(JIoEndpoint.java:318)</span><br><span class="line">    -  locked org.apache.tomcat.util.net.SocketWrapper@7127ee12</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:617)</span><br><span class="line">    at org.apache.tomcat.util.threads.TaskThread<span class="variable">$WrappingRunnable</span>.run(TaskThread.java:61)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"></span><br><span class="line">    Number of locked synchronizers = 1</span><br><span class="line">    - java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>@31a6493e</span><br></pre></td></tr></table></figure>

<details class="note "><summary><p>warn no-icon</p>
</summary>
<p>注意</p>
<p>注意， 目前只支持找出 synchronized 关键字阻塞住的线程， 如果是<code>java.util.concurrent.Lock</code>， 目前还不支持。</p>

</details>

<h4 id="thread-i-指定采样时间间隔"><a href="#thread-i-指定采样时间间隔" class="headerlink" title="thread -i, 指定采样时间间隔"></a>thread -i, 指定采样时间间隔</h4><ul>
<li><code>thread -i 1000</code> : 统计最近 1000ms 内的线程 CPU 时间。</li>
<li><code>thread -n 3 -i 1000</code> : 列出 1000ms 内最忙的 3 个线程栈</li>
</ul>
<h4 id="thread-–state-，查看指定状态的线程"><a href="#thread-–state-，查看指定状态的线程" class="headerlink" title="thread –state ，查看指定状态的线程"></a>thread –state ，查看指定状态的线程</h4><h3 id="thread-–state-，查看指定状态的线程-1"><a href="#thread-–state-，查看指定状态的线程-1" class="headerlink" title="thread –state ，查看指定状态的线程"></a>thread –state ，查看指定状态的线程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[arthas@28114]$ thread --state WAITING</span><br><span class="line">Threads Total: 16, NEW: 0, RUNNABLE: 9, BLOCKED: 0, WAITING: 3, TIMED_WAITING: 4, TERMINATED: 0</span><br><span class="line">ID   NAME                           GROUP           PRIORITY   STATE     %CPU      DELTA_TIME TIME      INTERRUPTE DAEMON</span><br><span class="line">3    Finalizer                      system          8          WAITING   0.0       0.000      0:0.000   <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">20   arthas-UserStat                system          9          WAITING   0.0       0.000      0:0.001   <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">14   arthas-timer                   system          9          WAITING   0.0       0.000      0:0.000   <span class="literal">false</span>      <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="Sc"><a href="#Sc" class="headerlink" title="Sc"></a>Sc</h2><p>可以通过 <code>sc</code> 命令 来查找 JVM 里已加载的类：</p>
<p>“Search-Class” 的简写，这个命令能搜索出所有已经加载到 JVM 中的 Class 信息，这个命令支持的参数有 <code>[d]</code>、<code>[E]</code>、<code>[f]</code> 和 <code>[x:]</code>。</p>
<h3 id="参数说明-3"><a href="#参数说明-3" class="headerlink" title="参数说明"></a>参数说明</h3><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>class-pattern</em></td>
<td align="left">类名表达式匹配</td>
</tr>
<tr>
<td align="right"><em>method-pattern</em></td>
<td align="left">方法名表达式匹配</td>
</tr>
<tr>
<td align="right"><code>[d]</code></td>
<td align="left">输出当前类的详细信息，包括这个类所加载的原始文件来源、类的声明、加载的 ClassLoader 等详细信息。 如果一个类被多个 ClassLoader 所加载，则会出现多次</td>
</tr>
<tr>
<td align="right"><code>[E]</code></td>
<td align="left">开启正则表达式匹配，默认为通配符匹配</td>
</tr>
<tr>
<td align="right"><code>[f]</code></td>
<td align="left">输出当前类的成员变量信息（需要配合参数-d 一起使用）</td>
</tr>
<tr>
<td align="right"><code>[x:]</code></td>
<td align="left">指定输出静态变量时属性的遍历深度，默认为 0，即直接使用 <code>toString</code> 输出</td>
</tr>
<tr>
<td align="right"><code>[c:]</code></td>
<td align="left">指定 class 的 ClassLoader 的 hashcode</td>
</tr>
<tr>
<td align="right"><code>[classLoaderClass:]</code></td>
<td align="left">指定执行表达式的 ClassLoader 的 class name</td>
</tr>
<tr>
<td align="right"><code>[n:]</code></td>
<td align="left">具有详细信息的匹配类的最大数量（默认为 100）</td>
</tr>
<tr>
<td align="right"><code>[cs &lt;arg&gt;]</code></td>
<td align="left">指定 class 的 ClassLoader#toString() 返回值。长格式<code>[classLoaderStr &lt;arg&gt;]</code></td>
</tr>
</tbody></table>
<div class="note primary no-icon"><p><strong>提示</strong></p>
<p>class-pattern 支持全限定名，如 com.taobao.test.AAA，也支持 com/taobao/test/AAA 这样的格式，这样，我们从异常堆栈里面把类名拷贝过来的时候，不需要在手动把/替换为.啦。</p>
</div>

<div class="note primary no-icon"><p><strong>提示</strong></p>
<p>sc 默认开启了子类匹配功能，也就是说所有当前类的子类也会被搜索出来，想要精确的匹配，请打开options disable-sub-class true开关</p>
</div>

<h3 id="使用参考-3"><a href="#使用参考-3" class="headerlink" title="使用参考"></a>使用参考</h3><ul>
<li><p>模糊搜索</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sc demo.*</span><br><span class="line">demo.MathGame</span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 55 ms.</span><br></pre></td></tr></table></figure>
</li>
<li><p>打印类的详细信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ sc -d demo.MathGame</span><br><span class="line">class-info        demo.MathGame</span><br><span class="line">code-source       /private/tmp/math-game.jar</span><br><span class="line">name              demo.MathGame</span><br><span class="line">isInterface       <span class="literal">false</span></span><br><span class="line">isAnnotation      <span class="literal">false</span></span><br><span class="line">isEnum            <span class="literal">false</span></span><br><span class="line">isAnonymousClass  <span class="literal">false</span></span><br><span class="line">isArray           <span class="literal">false</span></span><br><span class="line">isLocalClass      <span class="literal">false</span></span><br><span class="line">isMemberClass     <span class="literal">false</span></span><br><span class="line">isPrimitive       <span class="literal">false</span></span><br><span class="line">isSynthetic       <span class="literal">false</span></span><br><span class="line">simple-name       MathGame</span><br><span class="line">modifier          public</span><br><span class="line">annotation</span><br><span class="line">interfaces</span><br><span class="line">super-class       +-java.lang.Object</span><br><span class="line">class-loader      +-sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">                    +-sun.misc.Launcher<span class="variable">$ExtClassLoader</span>@66350f69</span><br><span class="line">classLoaderHash   3d4eac69</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 875 ms.</span><br></pre></td></tr></table></figure>
</li>
<li><p>打印出类的 Field 信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ sc -d -f demo.MathGame</span><br><span class="line">class-info        demo.MathGame</span><br><span class="line">code-source       /private/tmp/math-game.jar</span><br><span class="line">name              demo.MathGame</span><br><span class="line">isInterface       <span class="literal">false</span></span><br><span class="line">isAnnotation      <span class="literal">false</span></span><br><span class="line">isEnum            <span class="literal">false</span></span><br><span class="line">isAnonymousClass  <span class="literal">false</span></span><br><span class="line">isArray           <span class="literal">false</span></span><br><span class="line">isLocalClass      <span class="literal">false</span></span><br><span class="line">isMemberClass     <span class="literal">false</span></span><br><span class="line">isPrimitive       <span class="literal">false</span></span><br><span class="line">isSynthetic       <span class="literal">false</span></span><br><span class="line">simple-name       MathGame</span><br><span class="line">modifier          public</span><br><span class="line">annotation</span><br><span class="line">interfaces</span><br><span class="line">super-class       +-java.lang.Object</span><br><span class="line">class-loader      +-sun.misc.Launcher<span class="variable">$AppClassLoader</span>@3d4eac69</span><br><span class="line">                    +-sun.misc.Launcher<span class="variable">$ExtClassLoader</span>@66350f69</span><br><span class="line">classLoaderHash   3d4eac69</span><br><span class="line">fields            modifierprivate,static</span><br><span class="line">                  <span class="built_in">type</span>    java.util.Random</span><br><span class="line">                  name    random</span><br><span class="line">                  value   java.util.Random@522b4</span><br><span class="line">                          08a</span><br><span class="line"></span><br><span class="line">                  modifierprivate</span><br><span class="line">                  <span class="built_in">type</span>    int</span><br><span class="line">                  name    illegalArgumentCount</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 19 ms.</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过 ClassLoader#toString 查找类（前提：有一个 toString()返回值是<code>apo</code>的类加载器，加载的类中包含<code>demo.MathGame</code>, <code>demo.MyBar</code>,<code> demo.MyFoo</code>3 个类）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sc -cs apo *demo*</span><br><span class="line">demo.MathGame</span><br><span class="line">demo.MyBar</span><br><span class="line">demo.MyFoo</span><br><span class="line">Affect(row-cnt:3) cost <span class="keyword">in</span> 56 ms.</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Jad"><a href="#Jad" class="headerlink" title="Jad"></a>Jad</h2><p>可以通过 <code>jad</code> 命令来反编译代码：</p>
<div class="note info no-icon"><p><strong>提示</strong></p>
<p>反编译指定已加载类的源码</p>
</div>

<p><code>jad</code> 命令将 JVM 中实际运行的 class 的 byte code 反编译成 java 代码，便于你理解业务逻辑；如需批量下载指定包的目录的 class 字节码可以参考 <a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/dump.html">dump</a>。</p>
<ul>
<li>在 Arthas Console 上，反编译出来的源码是带语法高亮的，阅读更方便</li>
<li>当然，反编译出来的 java 代码可能会存在语法错误，但不影响你进行阅读理解</li>
</ul>
<h3 id="参数说明-4"><a href="#参数说明-4" class="headerlink" title="参数说明"></a>参数说明</h3><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>class-pattern</em></td>
<td align="left">类名表达式匹配</td>
</tr>
<tr>
<td align="right"><code>[c:]</code></td>
<td align="left">类所属 ClassLoader 的 hashcode</td>
</tr>
<tr>
<td align="right"><code>[classLoaderClass:]</code></td>
<td align="left">指定执行表达式的 ClassLoader 的 class name</td>
</tr>
<tr>
<td align="right">[E]</td>
<td align="left">开启正则表达式匹配，默认为通配符匹配</td>
</tr>
</tbody></table>
<h3 id="使用参考-4"><a href="#使用参考-4" class="headerlink" title="使用参考"></a>使用参考</h3><h4 id="反编译java-lang-String"><a href="#反编译java-lang-String" class="headerlink" title="反编译java.lang.String"></a>反编译<code>java.lang.String</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ jad java.lang.String</span><br><span class="line"></span><br><span class="line">ClassLoader:</span><br><span class="line"></span><br><span class="line">Location:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Decompiled with CFR.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">package</span> java.lang;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">import</span> java.io.ObjectStreamField;</span><br><span class="line">        <span class="keyword">import</span> java.io.Serializable;</span><br><span class="line">...</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">String</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Serializable</span>,</span></span><br><span class="line"><span class="class">        <span class="title">Comparable</span>&lt;<span class="title">String</span>&gt;,</span></span><br><span class="line"><span class="class">        <span class="title">CharSequence</span> </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">char</span>[] value;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">int</span> hash;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6849794470754667710L</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectStreamField[] serialPersistentFields = <span class="keyword">new</span> ObjectStreamField[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Comparator&lt;String&gt; CASE_INSENSITIVE_ORDER = <span class="keyword">new</span> CaseInsensitiveComparator();</span><br><span class="line">...</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(<span class="keyword">byte</span>[] byArray, <span class="keyword">int</span> n, <span class="keyword">int</span> n2, Charset charset)</span> </span>&#123;</span><br><span class="line"><span class="comment">/*460*/</span>         <span class="keyword">if</span> (charset == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;charset&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">/*462*/</span>         String.checkBounds(byArray, n, n2);</span><br><span class="line"><span class="comment">/*463*/</span>         <span class="keyword">this</span>.value = StringCoding.decode(charset, byArray, n, n2);</span><br><span class="line">            &#125;</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="反编译时只显示源代码"><a href="#反编译时只显示源代码" class="headerlink" title="反编译时只显示源代码"></a>反编译时只显示源代码</h4><p>默认情况下，反编译结果里会带有<code>ClassLoader</code>信息，通过<code>--source-only</code>选项，可以只打印源代码。方便和<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/mc.html">mc</a>/<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/retransform.html">retransform</a>命令结合使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ jad --source-only demo.MathGame</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Decompiled with CFR 0_132.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.PrintStream;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MathGame</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> illegalArgumentCount = <span class="number">0</span>;</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="反编译指定的函数"><a href="#反编译指定的函数" class="headerlink" title="反编译指定的函数"></a>反编译指定的函数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ jad demo.MathGame main</span><br><span class="line"></span><br><span class="line">ClassLoader:</span><br><span class="line">+-sun.misc.Launcher$AppClassLoader@<span class="number">232204</span>a1</span><br><span class="line">  +-sun.misc.Launcher$ExtClassLoader@<span class="number">7f</span>31245a</span><br><span class="line"></span><br><span class="line">Location:</span><br><span class="line">/<span class="keyword">private</span>/tmp/math-game.jar</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">           MathGame game = <span class="keyword">new</span> MathGame();</span><br><span class="line">           <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"><span class="comment">/*16*/</span>         game.run();</span><br><span class="line"><span class="comment">/*17*/</span>         TimeUnit.SECONDS.sleep(<span class="number">1L</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="反编译时不显示行号"><a href="#反编译时不显示行号" class="headerlink" title="反编译时不显示行号"></a>反编译时不显示行号</h4><p><code>--lineNumber</code> 参数默认值为 true，显示指定为 false 则不打印行号。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ jad demo.MathGame main --lineNumber <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">ClassLoader:</span><br><span class="line">+-sun.misc.Launcher$AppClassLoader@<span class="number">232204</span>a1</span><br><span class="line">  +-sun.misc.Launcher$ExtClassLoader@<span class="number">7f</span>31245a</span><br><span class="line"></span><br><span class="line">Location:</span><br><span class="line">/<span class="keyword">private</span>/tmp/math-game.jar</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    MathGame game = <span class="keyword">new</span> MathGame();</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        game.run();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="反编译时指定-ClassLoader"><a href="#反编译时指定-ClassLoader" class="headerlink" title="反编译时指定 ClassLoader"></a>反编译时指定 ClassLoader</h4><div class="note info no-icon"><p><strong>提示</strong></p>
<p>当有多个 <code>ClassLoader</code> 都加载了这个类时，<code>jad</code> 命令会输出对应 <code>ClassLoader</code> 实例的 <code>hashcode</code>，然后你只需要重新执行 <code>jad</code> 命令，并使用参数 <code>-c &lt;hashcode&gt;</code> 就可以反编译指定 ClassLoader 加载的那个类了；</p>
</div>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ jad org.apache.log4j.Logger</span><br><span class="line"></span><br><span class="line">Found more than one class for: org.apache.log4j.Logger, Please use jad -c hashcode org.apache.log4j.Logger</span><br><span class="line">HASHCODE  CLASSLOADER</span><br><span class="line"><span class="number">69d</span>caba4  +-monitor<span class="string">&#x27;s ModuleClassLoader</span></span><br><span class="line"><span class="string">6e51ad67  +-java.net.URLClassLoader@6e51ad67</span></span><br><span class="line"><span class="string">            +-sun.misc.Launcher$AppClassLoader@6951a712</span></span><br><span class="line"><span class="string">            +-sun.misc.Launcher$ExtClassLoader@6fafc4c2</span></span><br><span class="line"><span class="string">2bdd9114  +-pandora-qos-service&#x27;</span>s ModuleClassLoader</span><br><span class="line"><span class="number">4</span>c0df5f8  +-pandora-framework<span class="string">&#x27;s ModuleClassLoader</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Affect(row-cnt:0) cost in 38 ms.</span></span><br><span class="line"><span class="string">$ jad org.apache.log4j.Logger -c 69dcaba4</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ClassLoader:</span></span><br><span class="line"><span class="string">+-monitor&#x27;</span>s ModuleClassLoader</span><br><span class="line"></span><br><span class="line">Location:</span><br><span class="line">/Users/admin/app/log4j-<span class="number">1.2</span>.<span class="number">14.</span>jar</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.log4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.spi.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Logger</span> <span class="keyword">extends</span> <span class="title">Category</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FQCN;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Logger</span><span class="params">(String name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:<span class="number">1</span>) cost in <span class="number">190</span> ms.</span><br></pre></td></tr></table></figure>

<p>对于只有唯一实例的 ClassLoader 还可以通过<code>--classLoaderClass</code>指定 class name，使用起来更加方便：</p>
<p><code>--classLoaderClass</code> 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code>是动态变化的。</p>
<hr>
<h2 id="Watch"><a href="#Watch" class="headerlink" title="Watch"></a>Watch</h2><p>通过 <code>watch</code> 命令可以查看函数的参数/返回值/异常信息。</p>
<div class="note info no-icon"><p>提示</p>
<p>函数执行数据观测</p>
</div>

<p>让你能方便的观察到指定函数的调用情况。能观察到的范围为：<code>返回值</code>、<code>抛出异常</code>、<code>入参</code>，通过编写 OGNL 表达式进行对应变量的查看。</p>
<h3 id="参数说明-5"><a href="#参数说明-5" class="headerlink" title="参数说明"></a>参数说明</h3><p>watch 的参数比较多，主要是因为它能在 4 个不同的场景观察对象</p>
<table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>class-pattern</em></td>
<td align="left">类名表达式匹配</td>
</tr>
<tr>
<td align="right"><em>method-pattern</em></td>
<td align="left">函数名表达式匹配</td>
</tr>
<tr>
<td align="right"><em>express</em></td>
<td align="left">观察表达式，默认值：<code>&#123;params, target, returnObj&#125;</code></td>
</tr>
<tr>
<td align="right"><em>condition-express</em></td>
<td align="left">条件表达式</td>
</tr>
<tr>
<td align="right">[b]</td>
<td align="left">在<strong>函数调用之前</strong>观察</td>
</tr>
<tr>
<td align="right">[e]</td>
<td align="left">在<strong>函数异常之后</strong>观察</td>
</tr>
<tr>
<td align="right">[s]</td>
<td align="left">在<strong>函数返回之后</strong>观察</td>
</tr>
<tr>
<td align="right">[f]</td>
<td align="left">在<strong>函数结束之后</strong>(正常返回和异常返回)观察</td>
</tr>
<tr>
<td align="right">[E]</td>
<td align="left">开启正则表达式匹配，默认为通配符匹配</td>
</tr>
<tr>
<td align="right">[x:]</td>
<td align="left">指定输出结果的属性遍历深度，默认为 1，最大值是 4</td>
</tr>
<tr>
<td align="right"><code>[m &lt;arg&gt;]</code></td>
<td align="left">指定 Class 最大匹配数量，默认值为 50。长格式为<code>[maxMatch &lt;arg&gt;]</code>。</td>
</tr>
</tbody></table>
<p>这里重点要说明的是观察表达式，观察表达式的构成主要由 ognl 表达式组成，所以你可以这样写<code>&quot;&#123;params,returnObj&#125;&quot;</code>，只要是一个合法的 ognl 表达式，都能被正常支持。</p>
<p>观察的维度也比较多，主要体现在参数 <code>advice</code> 的数据结构上。<code>Advice</code> 参数最主要是封装了通知节点的所有信息。</p>
<ul>
<li>特殊用法请参考：<a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/71">https://github.com/alibaba/arthas/issues/71在新窗口打开</a></li>
<li>OGNL 表达式官网：<a target="_blank" rel="noopener" href="https://commons.apache.org/proper/commons-ognl/language-guide.html">https://commons.apache.org/proper/commons-ognl/language-guide.html在新窗口打开</a></li>
</ul>
<p><strong>特别说明</strong>：</p>
<ul>
<li>watch 命令定义了 4 个观察事件点，即 <code>-b</code> 函数调用前，<code>-e</code> 函数异常后，<code>-s</code> 函数返回后，<code>-f</code> 函数结束后</li>
<li>4 个观察事件点 <code>-b</code>、<code>-e</code>、<code>-s</code> 默认关闭，<code>-f</code> 默认打开，当指定观察点被打开后，在相应事件点会对观察表达式进行求值并输出</li>
<li>这里要注意<code>函数入参</code>和<code>函数出参</code>的区别，有可能在中间被修改导致前后不一致，除了 <code>-b</code> 事件点 <code>params</code> 代表函数入参外，其余事件都代表函数出参</li>
<li>当使用 <code>-b</code> 时，由于观察事件点是在函数调用前，此时返回值或异常均不存在</li>
<li>在 watch 命令的结果里，会打印出<code>location</code>信息。<code>location</code>有三种可能值：<code>AtEnter</code>，<code>AtExit</code>，<code>AtExceptionExit</code>。对应函数入口，函数正常 return，函数抛出异常。</li>
</ul>
<h3 id="使用参考-5"><a href="#使用参考-5" class="headerlink" title="使用参考"></a>使用参考</h3><h4 id="观察函数调用返回时的参数、this-对象和返回值"><a href="#观察函数调用返回时的参数、this-对象和返回值" class="headerlink" title="观察函数调用返回时的参数、this 对象和返回值"></a>观察函数调用返回时的参数、this 对象和返回值</h4><div class="note info no-icon"><p>提示</p>
<p>观察表达式，默认值是 {params, target, returnObj}</p>
</div>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ watch demo.MathGame primeFactors -x 2</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 32 ms, listenerId: 5</span><br><span class="line">method=demo.MathGame.primeFactors location=AtExceptionExit</span><br><span class="line">ts=2021-08-31 15:22:57; [cost=0.220625ms] result=@ArrayList[</span><br><span class="line">    @Object[][</span><br><span class="line">        @Integer[-179173],</span><br><span class="line">    ],</span><br><span class="line">    @MathGame[</span><br><span class="line">        random=@Random[java.util.Random@31cefde0],</span><br><span class="line">        illegalArgumentCount=@Integer[44],</span><br><span class="line">    ],</span><br><span class="line">    null,</span><br><span class="line">]</span><br><span class="line">method=demo.MathGame.primeFactors location=AtExit</span><br><span class="line">ts=2021-08-31 15:22:58; [cost=1.020982ms] result=@ArrayList[</span><br><span class="line">    @Object[][</span><br><span class="line">        @Integer[1],</span><br><span class="line">    ],</span><br><span class="line">    @MathGame[</span><br><span class="line">        random=@Random[java.util.Random@31cefde0],</span><br><span class="line">        illegalArgumentCount=@Integer[44],</span><br><span class="line">    ],</span><br><span class="line">    @ArrayList[</span><br><span class="line">        @Integer[2],</span><br><span class="line">        @Integer[2],</span><br><span class="line">        @Integer[26947],</span><br><span class="line">    ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的结果里，说明函数被执行了两次，第一次结果是<code>location=AtExceptionExit</code>，说明函数抛出异常了，因此<code>returnObj</code>是 null</li>
<li>在第二次结果里是<code>location=AtExit</code>，说明函数正常返回，因此可以看到<code>returnObj</code>结果是一个 ArrayList</li>
</ul>
<h4 id="指定-Class最大匹配数量"><a href="#指定-Class最大匹配数量" class="headerlink" title="指定 Class最大匹配数量"></a>指定 Class最大匹配数量</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ watch demo.MathGame primeFactors -m 1</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost <span class="keyword">in</span> 302 ms, listenerId: 3</span><br><span class="line">method=demo.MathGame.primeFactors location=AtExceptionExit</span><br><span class="line">ts=2022-12-25 19:58:41; [cost=0.222419ms] result=@ArrayList[</span><br><span class="line">    @Object[][isEmpty=<span class="literal">false</span>;size=1],</span><br><span class="line">    @MathGame[demo.MathGame@3bf400],</span><br><span class="line">    null,</span><br><span class="line">]</span><br><span class="line">method=demo.MathGame.primeFactors location=AtExceptionExit</span><br><span class="line">ts=2022-12-25 19:58:51; [cost=0.046928ms] result=@ArrayList[</span><br><span class="line">    @Object[][isEmpty=<span class="literal">false</span>;size=1],</span><br><span class="line">    @MathGame[demo.MathGame@3bf400],</span><br><span class="line">    null,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h4 id="观察函数调用入口的参数和返回值"><a href="#观察函数调用入口的参数和返回值" class="headerlink" title="观察函数调用入口的参数和返回值"></a>观察函数调用入口的参数和返回值</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ watch demo.MathGame primeFactors <span class="string">&quot;&#123;params,returnObj&#125;&quot;</span> -x 2 -b</span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 50 ms.</span><br><span class="line">ts=2018-12-03 19:23:23; [cost=0.0353ms] result=@ArrayList[</span><br><span class="line">    @Object[][</span><br><span class="line">        @Integer[-1077465243],</span><br><span class="line">    ],</span><br><span class="line">    null,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li>对比前一个例子，返回值为空（事件点为函数执行前，因此获取不到返回值）</li>
</ul>
<h2 id="Vmtool"><a href="#Vmtool" class="headerlink" title="Vmtool"></a>Vmtool</h2><p>通过 <code>vmtool</code> 命令，可以搜索内存对象。</p>
<h3 id="获取-class-实例"><a href="#获取-class-实例" class="headerlink" title="获取 class 实例"></a>获取 class 实例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ vmtool --action getInstances --className java.lang.String --<span class="built_in">limit</span> 10</span><br><span class="line">@String[][</span><br><span class="line">    @String[com/taobao/arthas/core/shell/session/Session],</span><br><span class="line">    @String[com.taobao.arthas.core.shell.session.Session],</span><br><span class="line">    @String[com/taobao/arthas/core/shell/session/Session],</span><br><span class="line">    @String[com/taobao/arthas/core/shell/session/Session],</span><br><span class="line">    @String[com/taobao/arthas/core/shell/session/Session.class],</span><br><span class="line">    @String[com/taobao/arthas/core/shell/session/Session.class],</span><br><span class="line">    @String[com/taobao/arthas/core/shell/session/Session.class],</span><br><span class="line">    @String[com/],</span><br><span class="line">    @String[java/util/concurrent/ConcurrentHashMap<span class="variable">$ValueIterator</span>],</span><br><span class="line">    @String[java/util/concurrent/locks/LockSupport],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<div class="note info no-icon"><p>提示</p>
<p>通过 –limit 参数，可以限制返回值数量，避免获取超大数据时对 JVM 造成压力。默认值是 10。</p>
</div>

<h4 id="调用实例方法"><a href="#调用实例方法" class="headerlink" title="调用实例方法"></a>调用实例方法</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[arthas@13416]$ vmtool --action  getInstances  --className demo.MathGame --express <span class="string">&#x27;instances[0].primeFactors(3)&#x27;</span> -x 3</span><br><span class="line">@ArrayList[</span><br><span class="line">    @Integer[3],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="退出-Arthas"><a href="#退出-Arthas" class="headerlink" title="退出 Arthas"></a>退出 Arthas</h2><p>用 <code>exit</code> 或者 <code>quit</code> 命令可以退出 Arthas。</p>
<p>退出 Arthas 之后，还可以再次用 <code>java -jar arthas-boot.jar</code> 来连接。</p>
<h2 id="彻底退出-Arthas"><a href="#彻底退出-Arthas" class="headerlink" title="彻底退出 Arthas"></a>彻底退出 Arthas</h2><p><code>exit/quit</code> 命令只是退出当前 session，arthas server 还在目标进程中运行。</p>
<p>想完全退出 Arthas，可以执行 <code>stop</code> 命令。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/25/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="wotzc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cai">
      <meta itemprop="description" content="真正的大师永远都怀着一颗学徒的心">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cai">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/25/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">适配器模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-12-25 14:26:59 / 修改时间：16:32:17" itemprop="dateCreated datePublished" datetime="2023-12-25T14:26:59+08:00">2023-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>适配器模式(Adapter Pattern) ：将一个接口转换成客户希望的另一个接口，适配器模式使接口不兼容的那些类可以一起工作，其别名为包装器(Wrapper)。适配器模式既可以作为类结构型模式，也可以作为对象结构型模式。</p>
<p>现实世界的例子</p>
<blockquote>
<p>假设您的存储卡上有一些照片，并且需要将它们传输到计算机上。要传输它们，您需要某种与计算机端口兼容的适配器，以便可以将存储卡连接到计算机。在这种情况下，读卡器是一个适配器。<br>另一个例子是著名的电源适配器；三脚插头不能连接两脚插座，需要使用兼容两脚插座的电源适配器。<br>另一个例子是翻译人员将一个人所说的单词翻译成另一个人所说的单词</p>
</blockquote>
<p>用简单的话来说</p>
<blockquote>
<p>适配器模式允许您将不兼容的对象包装在适配器中，以使其与另一个类兼容。</p>
</blockquote>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>假如你正在开发一款股票市场监测程序， 它会从不同来源下载 XML 格式的股票数据， 然后向用户呈现出美观的图表。</p>
<p>在开发过程中， 你决定在程序中整合一个第三方智能分析函数库。 但是遇到了一个问题， 那就是分析函数库只兼容 JSON 格式的数据。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2023/designpattern/adaptor_problem-zh-2x%281%29.png" style="zoom: 50%;" />

<p>你可以修改程序库来支持 XML。 但是， 这可能需要修改部分依赖该程序库的现有代码。 甚至还有更糟糕的情况， 你可能根本没有程序库的源代码， 从而无法对其进行修改。</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>你可以创建一个<em>适配器</em>。 这是一个特殊的对象， 能够转换对象接口， 使其能与其他对象进行交互。</p>
<p>适配器模式通过封装对象将复杂的转换过程隐藏于幕后。 被封装的对象甚至察觉不到适配器的存在。 例如， 你可以使用一个将所有数据转换为英制单位 （如英尺和英里） 的适配器封装运行于米和千米单位制中的对象。</p>
<p>适配器不仅可以转换不同格式的数据， 其还有助于采用不同接口的对象之间的合作。 它的运作方式如下：</p>
<ol>
<li>适配器实现与其中一个现有对象兼容的接口。</li>
<li>现有对象可以使用该接口安全地调用适配器方法。</li>
<li>适配器方法被调用后将以另一个对象兼容的格式和顺序将请求传递给该对象。</li>
</ol>
<p>有时你甚至可以创建一个双向适配器来实现双向转换调用。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2023/designpattern/adaptor_solution-zh-2x.png" style="zoom: 50%;" />

<p>让我们回到股票市场程序。 为了解决数据格式不兼容的问题， 你可以为分析函数库中的每个类创建将 XML 转换为 JSON 格式的适配器， 然后让客户端仅通过这些适配器来与函数库进行交流。 当某个适配器被调用时， 它会将传入的 XML 数据转换为 JSON 结构， 并将其传递给被封装分析对象的相应方法。</p>
<h4 id="适配器模式结构"><a href="#适配器模式结构" class="headerlink" title="适配器模式结构"></a>适配器模式结构</h4><p>实现时使用了构成原则： 适配器实现了其中一个对象的接口， 并对另一个对象进行封装。 所有流行的编程语言都可以实现适配器。</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2023/designpattern/structure-object-adapter-2x.png" style="zoom:50%;" />

<p>程序示例：</p>
<p>对象适配器模式，是通过组合的形式来完成适配，在实际开发中，如果能够适用组合的形式，就尽量不用要继承。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.design.patterns.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adaptee</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">adapteeRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;被适配者的方法&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.design.patterns.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Target</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">request</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.design.patterns.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteTarget</span> <span class="keyword">implements</span> <span class="title">Target</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;concreteTarget目标方法&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.design.patterns.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">implements</span> <span class="title">Target</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Adaptee adaptee = <span class="keyword">new</span> Adaptee();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    adaptee.adapteeRequest();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.design.patterns.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Target target = <span class="keyword">new</span> ConcreteTarget();</span><br><span class="line">    target.request();</span><br><span class="line"></span><br><span class="line">    Target adapterTarget = <span class="keyword">new</span> Adapter();</span><br><span class="line">    adapterTarget.request();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>将目标类和适配者类解耦，通过引入一个适配器类来重用现有的适配者类，而无须修改原有代码。</li>
<li>增加了类的透明性和复用性，将具体的实现封装在适配者类中，对于客户端类来说是透明的，而且提高了适配者的复用性。</li>
<li>开闭原则。 只要客户端代码通过客户端接口与适配器进行交互， 你就能在不修改现有客户端代码的情况下在程序中添加新类型的适配器。</li>
</ul>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>过多地使用适配器，会让系统非常零乱，不易整体进行把握。比如，明明看到调用的是 A 接口，其实内部被适配成了 B 接口的实现，一个系统如果太多出现这种情况，无异于一场灾难。因此如果不是很有必要，可以不使用适配器，而是直接对系统进行重构</li>
<li> 代码整体复杂度增加， 因为你需要新增一系列接口和类。 有时直接更改服务类使其与其他代码兼容会更简单。</li>
</ul>
<h4 id="已知使用："><a href="#已知使用：" class="headerlink" title="已知使用："></a>已知使用：</h4><ul>
<li><code>java.util.Arrays#asList()</code></li>
<li><code>java.util.Collections#list()</code></li>
<li><code>java.util.Collections#enumeration()</code></li>
<li><code>javax.xml.bind.annotation.adapters.XMLAdapter</code></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/23/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="wotzc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cai">
      <meta itemprop="description" content="真正的大师永远都怀着一颗学徒的心">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cai">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/23/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">策略模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-23 16:11:57" itemprop="dateCreated datePublished" datetime="2023-12-23T16:11:57+08:00">2023-12-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-12-25 10:15:26" itemprop="dateModified" datetime="2023-12-25T10:15:26+08:00">2023-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="模式动机"><a href="#模式动机" class="headerlink" title="模式动机"></a>模式动机</h2><p>在策略模式中定义了一系列算法，将每一个算法封装起来，并让它们可以相互替换。策略模式让算法独立于使用它的客户而变化，也称为政策模式。策略模式是一种对象行为型模式。</p>
<p>在软件开发中也常常遇到类似的情况，实现某一个功能有多个途径，此时可以使用一种设计模式来使得系统可以灵活地选择解决途径，也能够方便地增加新的解决途径。</p>
<p>在软件系统中，有许多算法可以实现某一功能，如查找、排序等，一种常用的方法是硬编码(Hard Coding)在一个类中，如需要提供多种查找算法，可以将这些算法写到一个类中，在该类中提供多个方法，每一个方法对应一个具体的查找算法；当然也可以将这些查找算法封装在一个统一的方法中，通过if…else…等条件判断语句来进行选择。这两种实现方法我们都可以称之为硬编码，如果需要增加一种新的查找算法，需要修改封装算法类的源代码；更换查找算法，也需要修改客户端调用代码。在这个算法类中封装了大量查找算法，该类代码将较复杂，维护较为困难。</p>
<p>除了提供专门的查找算法类之外，还可以在客户端程序中直接包含算法代码，这种做法更不可取，将导致客户端程序庞大而且难以维护，如果存在大量可供选择的算法时问题将变得更加严重。</p>
<p>为了解决这些问题，可以定义一些独立的类来封装不同的算法，每一个类封装一个具体的算法，在这里，每一个封装算法的类我们都可以称之为策略(<code>Strategy</code>)，为了保证这些策略的一致性，一般会用一个抽象的策略类来做算法的定义，而具体每种算法则对应于一个具体策略类。</p>
<h2 id="真实世界类比"><a href="#真实世界类比" class="headerlink" title="真实世界类比"></a>真实世界类比</h2><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2023/designpattern/strategy-comic-1-zh-2x.png" style="zoom:50%;" />

<p>假如你需要前往机场。 你可以选择乘坐公共汽车、 预约出租车或骑自行车。 这些就是你的出行策略。 你可以根据预算或时间等因素来选择其中一种策略。</p>
<h2 id="策略模式结构"><a href="#策略模式结构" class="headerlink" title="策略模式结构"></a>策略模式结构</h2><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2023/designpattern/strategy-pattern-struct.png" style="zoom: 50%;" />

<ol>
<li><strong>上下文</strong> （Context） 维护指向具体策略的引用， 且仅通过策略接口与该对象进行交流。</li>
<li><strong>策略</strong> （Strategy） 接口是所有具体策略的通用接口， 它声明了一个上下文用于执行策略的方法。</li>
<li><strong>具体策略</strong> （Concrete Strategies） 实现了上下文所用算法的各种不同变体。</li>
<li>当上下文需要运行算法时， 它会在其已连接的策略对象上调用执行方法。 上下文不清楚其所涉及的策略类型与算法的执行方式。</li>
<li><strong>客户端</strong> （Client） 会创建一个特定策略对象并将其传递给上下文。 上下文则会提供一个设置器以便客户端在运行时替换相关联的策略。</li>
</ol>
<h2 id="现实中的例子"><a href="#现实中的例子" class="headerlink" title="现实中的例子"></a>现实中的例子</h2><div class="note info no-icon"><p>某商场在618期间推出多种促销活动，在618活动前期使用立减促销的策略，在618活动中期采用满减促销的策略，在618活动后期采用返现促销的策略。</p>
</div>

<h2 id="程序化示例"><a href="#程序化示例" class="headerlink" title="程序化示例"></a>程序化示例</h2><p>我们先介绍一下促销策略接口及其实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 促销</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doPromotion</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FanXianStrategy</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPromotion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;返现促销！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LiJianStrategy</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPromotion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;立减促销！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ManJianStrategy</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPromotion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;满减促销！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是强大的活动类，他可以根据618时间节点选择促销策略。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Strategy strategy;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Activity</span><span class="params">(Strategy strategy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.strategy = strategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStrategy</span><span class="params">(Strategy strategy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.strategy = strategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeStrategy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        strategy.doPromotion();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        LiJianStrategy liJianStrategy = <span class="keyword">new</span> LiJianStrategy();</span><br><span class="line">        Activity activity618 = <span class="keyword">new</span> Activity(liJianStrategy);</span><br><span class="line">        activity618.executeStrategy();</span><br><span class="line"></span><br><span class="line">        ManJianStrategy manJianStrategy = <span class="keyword">new</span> ManJianStrategy();</span><br><span class="line">        activity618.setStrategy(manJianStrategy);</span><br><span class="line">        activity618.executeStrategy();</span><br><span class="line"></span><br><span class="line">        FanXianStrategy fanXianStrategy = <span class="keyword">new</span> FanXianStrategy();</span><br><span class="line">        activity618.setStrategy(fanXianStrategy);</span><br><span class="line">        activity618.executeStrategy();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">立减促销！</span><br><span class="line">满减促销！</span><br><span class="line">返现促销！</span><br></pre></td></tr></table></figure>

<p>UML：</p>
<img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2023/designpattern/assets_-LWJYTjaWpc4_WfP8Kq__-LdZ9gEHvPQcz52n4K7B_-LdZ9hFdGXFide-o-RzQ_strategy-pattern.webp" style="zoom:50%;" />

<h2 id="策略模式适合应用场景"><a href="#策略模式适合应用场景" class="headerlink" title="策略模式适合应用场景"></a>策略模式适合应用场景</h2><ul>
<li>当你想使用对象中各种不同的算法变体，并希望能在运行时切换算法时，可使用策略模式。（策略模式让你能够将对象关联至可以不同方式执行特定子任务的不同子对象， 从而以间接方式在运行时更改对象行为。）</li>
<li>当你有许多仅在执行某些行为时略有不同的相似类时， 可使用策略模式。（策略模式让你能将不同行为抽取到一个独立类层次结构中， 并将原始类组合成同一个， 从而减少重复代码。）</li>
<li>如果算法在上下文的逻辑中不是特别重要，使用该模式能将类的业务逻辑与其算法实现细节隔离开来。（策略模式让你能将各种算法的代码、 内部数据和依赖关系与其他代码隔离开来。 不同客户端可通过一个简单接口执行算法， 并能在运行时进行切换。）</li>
<li>当类中使用了复杂条件运算符以在同一算法的不同变体中切换时， 可使用该模式。（策略模式将所有继承自同样接口的算法抽取到独立类中， 因此不再需要条件语句。 原始对象并不实现所有算法的变体， 而是将执行工作委派给其中的一个独立算法对象。）</li>
</ul>
<h2 id="模式分析"><a href="#模式分析" class="headerlink" title="模式分析"></a>模式分析</h2><ul>
<li>策略模式是一个比较容易理解和使用的设计模式，策略模式是对算法的封装，它把算法的责任和算法本身分割开，委派给不同的对象管理。策略模式通常把一个系列的算法封装到一系列的策略类里面，作为一个抽象策略类的子类。用一句话来说，就是“准备一组算法，并将每一个算法封装起来，使得它们可以互换”。</li>
<li>在策略模式中，应当由客户端自己决定在什么情况下使用什么具体策略角色。</li>
<li>策略模式仅仅封装算法，提供新算法插入到已有系统中，以及老算法从系统中“退休”的方便，策略模式并不决定在何时使用何种算法，算法的选择由客户端来决定。这在一定程度上提高了系统的灵活性，但是客户端需要理解所有具体策略类之间的区别，以便选择合适的算法，这也是策略模式的缺点之一，在一定程度上增加了客户端的使用难度。</li>
</ul>
<h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><ul>
<li>策略模式提供了对“开闭原则”的完美支持，用户可以在不修改原有系统的基础上选择算法或行为，也可以灵活地增加新的算法或行为。</li>
<li>策略模式提供了管理相关的算法族的办法。</li>
<li>策略模式提供了可以替换继承关系的办法。</li>
<li>使用策略模式可以避免使用多重条件转移语句。</li>
</ul>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><ul>
<li>客户端必须知道所有的策略类，并自行决定使用哪一个策略类。</li>
<li>策略模式将造成产生很多策略类，可以通过使用享元模式在一定程度上减少对象的数量。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>在策略模式中定义了一系列算法，将每一个算法封装起来，并让它们可以相互替换。策略模式让算法独立于使用它的客户而变化，也称为政策模式。策略模式是一种对象行为型模式。</li>
<li>策略模式包含三个角色：环境类在解决某个问题时可以采用多种策略，在环境类中维护一个对抽象策略类的引用实例；抽象策略类为所支持的算法声明了抽象方法，是所有策略类的父类；具体策略类实现了在抽象策略类中定义的算法。</li>
<li>策略模式是对算法的封装，它把算法的责任和算法本身分割开，委派给不同的对象管理。策略模式通常把一个系列的算法封装到一系列的策略类里面，作为一个抽象策略类的子类。</li>
<li>策略模式主要优点在于对“开闭原则”的完美支持，在不修改原有系统的基础上可以更换算法或者增加新的算法，它很好地管理算法族，提高了代码的复用性，是一种替换继承，避免多重条件转移语句的实现方式；其缺点在于客户端必须知道所有的策略类，并理解其区别，同时在一定程度上增加了系统中类的个数，可能会存在很多策略类。</li>
<li>策略模式适用情况包括：在一个系统里面有许多类，它们之间的区别仅在于它们的行为，使用策略模式可以动态地让一个对象在许多行为中选择一种行为；一个系统需要动态地在几种算法中选择一种；避免使用难以维护的多重条件选择语句；希望在具体策略类中封装算法和与相关的数据结构。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/23/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="wotzc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cai">
      <meta itemprop="description" content="真正的大师永远都怀着一颗学徒的心">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cai">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/23/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">代理模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-12-23 09:46:51 / 修改时间：17:30:34" itemprop="dateCreated datePublished" datetime="2023-12-23T09:46:51+08:00">2023-12-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>代理模式：</strong> 为一个对象提供一个替身，以控制对目标对象的访问。即通过代理对象访问目标对象。这样做的好处是：可以在目标对象实现的基础上，增强额外的功能操作，及扩展目标对象的功能。</p>
<p>被代理的对象可以是远程对象，创建开销大的对象或需要安全控制的对象。</p>
<p>在现实生活中，一个对象不能直接访问另一个对象，这时需要找中介来访问目标对象，此时的中介就是代理对象。例如：租房子时，我们无法与房东取得联系，只能通过某网站与中介进行交易，获取自己心仪的房间等等。</p>
<h4 id="代理模式结构"><a href="#代理模式结构" class="headerlink" title="代理模式结构"></a>代理模式结构</h4><img src="https://myblob-pics.oss-cn-hangzhou.aliyuncs.com/2023/designpattern/2560px-Proxy_pattern_diagram.png" style="zoom: 33%;" />

<ul>
<li><strong>抽象主题</strong>（Subject）类：通过接口或抽象类声明真实主题和代理对象实现的业务方法。代理必须遵循该接口才能伪装成服务对象。</li>
<li><strong>真实主题</strong>（Real Subject）类：实现了出现主题中的具体业务，是代理对象所代理的真实对象，是最终要引用的对象。</li>
<li><strong>代理</strong>（Proxy）类：提供了与真实主题相同的接口，其内部含有对真实主题的引用，它可以访问、控制或扩展真实主题的功能。</li>
<li><strong>客户端</strong> （Client） 能通过同一接口与服务或代理进行交互， 所以你可在一切需要服务对象的代码中使用代理。</li>
</ul>
<h4 id="现实中的例子"><a href="#现实中的例子" class="headerlink" title="现实中的例子"></a>现实中的例子</h4><div class="note info no-icon"><p>我们模拟在现实生活通过携程火车票系统购票的过程，假设我们通过代理购票系统购票时，购票系统首先会校验购票人的购票资格，校验成功则会调用真正的购票系统进行购票，购票成功后会收取购票人的一定的服务费。</p>
</div>

<h4 id="程序化示例"><a href="#程序化示例" class="headerlink" title="程序化示例"></a>程序化示例</h4><p>1、抽象主题类：代理类与被代理类都需要实现的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Ticketing</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">buyTicket</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、真实主题类： 目标类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RailwaySite</span> <span class="keyword">implements</span> <span class="title">Ticketing</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buyTicket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;调用官方系统购票成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、代理类：需要实现被代理类的接口，使用代理方法调用目标对象的方法，同时实现对目标方法的扩展。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTicketSystem</span> <span class="keyword">implements</span> <span class="title">Ticketing</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Ticketing ticket;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyTicketSystem</span><span class="params">(Ticketing ticket)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ticket = ticket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buyTicket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        preHandle();</span><br><span class="line">        ticket.buyTicket();</span><br><span class="line">        postHandle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">preHandle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;代理（携程火车票）系统校验购票人资格！&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;校验成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;代理（携程火车票）系统收取购票人服务费10元！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、客户端：需要创建被代理对象和代理对象，并进行组合调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RailwaySite railwaySite = <span class="keyword">new</span> RailwaySite();</span><br><span class="line">        ProxyTicketSystem proxy = <span class="keyword">new</span> ProxyTicketSystem(railwaySite);</span><br><span class="line">        proxy.buyTicket();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">代理（携程火车票）系统校验购票人资格！</span><br><span class="line">校验成功！</span><br><span class="line">调用官方系统购票成功！</span><br><span class="line">代理（携程火车票）系统收取购票人服务费10元！</span><br></pre></td></tr></table></figure>

<h4 id="适用性"><a href="#适用性" class="headerlink" title="适用性"></a>适用性</h4><p>当需要比简单指针更通用或更复杂的对象引用时，就需要使用代理模式。以下是代理模式适用的几种常见情况。</p>
<ul>
<li>远程代理为不同地址空间的对象提供本地代表。</li>
<li>虚拟代理按需创建昂贵的对象。</li>
<li>保护代理控制对原始对象的访问。当对象应具有不同访问权限时，保护代理非常有用。</li>
</ul>
<h4 id="已知使用"><a href="#已知使用" class="headerlink" title="已知使用"></a>已知使用</h4><ul>
<li><code>java.lang.reflect.Proxyopen in new window</code></li>
<li><code>Apache Commons Proxy</code></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">wotzc</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/wotzc" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
