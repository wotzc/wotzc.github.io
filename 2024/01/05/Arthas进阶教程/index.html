<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="查看 JVM 信息下面介绍 Arthas 里查看 JVM 信息的命令。 syspropsysprop 可以打印所有的 System Properties 信息。 提示 查看当前 JVM 的系统属性( System Property )   使用参考123456789101112131415161718USAGE:  sysprop [-h] [property-name] [property-va">
<meta property="og:type" content="article">
<meta property="og:title" content="Arthas进阶教程">
<meta property="og:url" content="http://example.com/2024/01/05/Arthas%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B/index.html">
<meta property="og:site_name" content="Cai">
<meta property="og:description" content="查看 JVM 信息下面介绍 Arthas 里查看 JVM 信息的命令。 syspropsysprop 可以打印所有的 System Properties 信息。 提示 查看当前 JVM 的系统属性( System Property )   使用参考123456789101112131415161718USAGE:  sysprop [-h] [property-name] [property-va">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-01-05T01:27:15.000Z">
<meta property="article:modified_time" content="2024-01-10T07:25:05.406Z">
<meta property="article:author" content="wotzc">
<meta property="article:tag" content="Arthas">
<meta property="article:tag" content="Java诊断工具">
<meta property="article:tag" content="线上问题排查">
<meta property="article:tag" content="JVM">
<meta property="article:tag" content="反编译">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2024/01/05/Arthas%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2024/01/05/Arthas%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B/","path":"2024/01/05/Arthas进阶教程/","title":"Arthas进阶教程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Arthas进阶教程 | Cai</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Cai</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-JVM-%E4%BF%A1%E6%81%AF"><span class="nav-number">1.</span> <span class="nav-text">查看 JVM 信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#sysprop"><span class="nav-number">1.1.</span> <span class="nav-text">sysprop</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%8F%82%E8%80%83"><span class="nav-number">1.1.1.</span> <span class="nav-text">使用参考</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E5%B1%9E%E6%80%A7"><span class="nav-number">1.1.2.</span> <span class="nav-text">查看所有属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%8D%95%E4%B8%AA%E5%B1%9E%E6%80%A7"><span class="nav-number">1.1.3.</span> <span class="nav-text">查看单个属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%8D%95%E4%B8%AA%E5%B1%9E%E6%80%A7"><span class="nav-number">1.1.4.</span> <span class="nav-text">修改单个属性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sysenv"><span class="nav-number">1.2.</span> <span class="nav-text">sysenv</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%8F%82%E8%80%83-1"><span class="nav-number">1.2.1.</span> <span class="nav-text">使用参考</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">1.2.2.</span> <span class="nav-text">查看所有环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%8D%95%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">1.2.3.</span> <span class="nav-text">查看单个环境变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JVM"><span class="nav-number">1.3.</span> <span class="nav-text">JVM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%8F%82%E8%80%83-2"><span class="nav-number">1.3.1.</span> <span class="nav-text">使用参考</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#THREAD-%E7%9B%B8%E5%85%B3"><span class="nav-number">1.3.2.</span> <span class="nav-text">THREAD 相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E7%9B%B8%E5%85%B3"><span class="nav-number">1.3.3.</span> <span class="nav-text">文件描述符相关</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Tips"><span class="nav-number">2.</span> <span class="nav-text">Tips</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#help"><span class="nav-number">2.1.</span> <span class="nav-text">help</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="nav-number">2.2.</span> <span class="nav-text">自动补全</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#readline-%E7%9A%84%E5%BF%AB%E6%8D%B7%E9%94%AE%E6%94%AF%E6%8C%81"><span class="nav-number">2.3.</span> <span class="nav-text">readline 的快捷键支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%86%E5%8F%B2%E5%91%BD%E4%BB%A4%E7%9A%84%E8%A1%A5%E5%85%A8"><span class="nav-number">2.4.</span> <span class="nav-text">历史命令的补全</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pipeline"><span class="nav-number">2.5.</span> <span class="nav-text">pipeline</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Sc-sm-%E6%9F%A5%E7%9C%8B%E5%B7%B2%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%B1%BB"><span class="nav-number">3.</span> <span class="nav-text">Sc&#x2F;sm 查看已加载的类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Sc"><span class="nav-number">3.1.</span> <span class="nav-text">Sc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sm"><span class="nav-number">3.2.</span> <span class="nav-text">sm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="nav-number">3.2.1.</span> <span class="nav-text">参数说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%8F%82%E8%80%83-3"><span class="nav-number">3.2.2.</span> <span class="nav-text">使用参考</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Jad"><span class="nav-number">4.</span> <span class="nav-text">Jad</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#OGNL"><span class="nav-number">5.</span> <span class="nav-text">OGNL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#OGNL-%E4%B8%80%E8%88%AC%E8%AF%AD%E6%B3%95"><span class="nav-number">5.1.</span> <span class="nav-text">OGNL 一般语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95"><span class="nav-number">5.1.1.</span> <span class="nav-text">索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E5%BC%95%E7%94%A8"><span class="nav-number">5.1.2.</span> <span class="nav-text">变量引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8"><span class="nav-number">5.1.3.</span> <span class="nav-text">方法调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E6%9D%82%E9%93%BE%E5%BC%8F%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">5.1.4.</span> <span class="nav-text">复杂链式表达式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C"><span class="nav-number">5.1.5.</span> <span class="nav-text">集合操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E5%88%97%E8%A1%A8"><span class="nav-number">5.1.5.1.</span> <span class="nav-text">新建列表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E5%8E%9F%E7%94%9F%E6%95%B0%E7%BB%84"><span class="nav-number">5.1.5.2.</span> <span class="nav-text">新建原生数组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA-Maps"><span class="nav-number">5.1.5.3.</span> <span class="nav-text">新建 Maps</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E7%9A%84%E6%8A%95%E5%BD%B1"><span class="nav-number">5.1.5.4.</span> <span class="nav-text">集合的投影</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E9%9B%86%E5%90%88%E5%85%83%E7%B4%A0"><span class="nav-number">5.1.5.5.</span> <span class="nav-text">查找集合元素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E7%9A%84%E8%99%9A%E6%8B%9F%E5%B1%9E%E6%80%A7"><span class="nav-number">5.1.5.6.</span> <span class="nav-text">集合的虚拟属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="nav-number">5.1.5.7.</span> <span class="nav-text">构造函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="nav-number">5.1.5.8.</span> <span class="nav-text">静态方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E5%B1%9E%E6%80%A7"><span class="nav-number">5.1.5.9.</span> <span class="nav-text">静态属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%AA-lambda-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">5.1.5.10.</span> <span class="nav-text">伪 lambda 表达式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A5%E5%85%85"><span class="nav-number">5.1.5.11.</span> <span class="nav-text">补充</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Arthas-OGNL"><span class="nav-number">5.2.</span> <span class="nav-text">Arthas-OGNL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8-static-%E5%87%BD%E6%95%B0"><span class="nav-number">5.2.1.</span> <span class="nav-text">调用 static 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE-UserController-%E7%9A%84-ClassLoader"><span class="nav-number">5.2.2.</span> <span class="nav-text">查找 UserController 的 ClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E9%9D%99%E6%80%81%E7%B1%BB%E7%9A%84%E9%9D%99%E6%80%81%E5%AD%97%E6%AE%B5"><span class="nav-number">5.2.3.</span> <span class="nav-text">获取静态类的静态字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%A4%9A%E8%A1%8C%E8%A1%A8%E8%BE%BE%E5%BC%8F%EF%BC%8C%E8%B5%8B%E5%80%BC%E7%BB%99%E4%B8%B4%E6%97%B6%E5%8F%98%E9%87%8F%EF%BC%8C%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA-List"><span class="nav-number">5.2.4.</span> <span class="nav-text">执行多行表达式，赋值给临时变量，返回一个 List</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E5%A4%9A"><span class="nav-number">5.2.5.</span> <span class="nav-text">更多</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Options"><span class="nav-number">6.</span> <span class="nav-text">Options</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E7%9A%84-options"><span class="nav-number">6.1.</span> <span class="nav-text">查看所有的 options</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E-1"><span class="nav-number">6.2.</span> <span class="nav-text">参数说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%8D%95%E4%B8%AAoption-%E7%9A%84%E5%80%BC"><span class="nav-number">6.3.</span> <span class="nav-text">获取单个option 的值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E6%8C%87%E5%AE%9A%E7%9A%84-option"><span class="nav-number">6.4.</span> <span class="nav-text">设置指定的 option</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%81%E8%AE%B8%E5%A2%9E%E5%BC%BA-JDK-%E7%9A%84%E7%B1%BB"><span class="nav-number">6.5.</span> <span class="nav-text">允许增强 JDK 的类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A5-JSON-%E6%A0%BC%E5%BC%8F%E6%89%93%E5%8D%B0%E5%AF%B9%E8%B1%A1"><span class="nav-number">6.6.</span> <span class="nav-text">以 JSON 格式打印对象</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%8E%92%E6%9F%A5%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%BC%82%E5%B8%B8"><span class="nav-number">7.</span> <span class="nav-text">案例：排查函数调用异常</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%B0%E8%B1%A1"><span class="nav-number">7.1.</span> <span class="nav-text">现象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-UserController-%E7%9A%84-%E5%8F%82%E6%95%B0-%E5%BC%82%E5%B8%B8"><span class="nav-number">7.2.</span> <span class="nav-text">查看 UserController 的 参数&#x2F;异常</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">7.3.</span> <span class="nav-text">返回值表达式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">7.4.</span> <span class="nav-text">条件表达式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BD%93%E5%BC%82%E5%B8%B8%E6%97%B6%E6%8D%95%E8%8E%B7"><span class="nav-number">7.5.</span> <span class="nav-text">当异常时捕获</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%89%E7%85%A7%E8%80%97%E6%97%B6%E8%BF%9B%E8%A1%8C%E8%BF%87%E6%BB%A4"><span class="nav-number">7.6.</span> <span class="nav-text">按照耗时进行过滤</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%83%AD%E6%9B%B4%E6%96%B0%E4%BB%A3%E7%A0%81"><span class="nav-number">8.</span> <span class="nav-text">案例：热更新代码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#jad-%E5%8F%8D%E7%BC%96%E8%AF%91-UserController"><span class="nav-number">8.1.</span> <span class="nav-text">jad 反编译 UserController</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2-UserController-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">8.2.</span> <span class="nav-text">查询 UserController 类加载器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sc-%E6%9F%A5%E6%89%BE%E5%8A%A0%E8%BD%BD-UserController-%E7%9A%84-ClassLoader"><span class="nav-number">8.2.1.</span> <span class="nav-text">sc 查找加载 UserController 的 ClassLoader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#classloader-%E6%9F%A5%E8%AF%A2%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%90%8D%E7%A7%B0"><span class="nav-number">8.2.2.</span> <span class="nav-text">classloader 查询类加载器名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mc-%E7%BC%96%E8%AF%91%E5%8A%A0%E8%BD%BD-UserController"><span class="nav-number">8.2.3.</span> <span class="nav-text">mc 编译加载 UserController</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mc-%E6%8C%87%E5%AE%9A-classloader-%E7%BC%96%E8%AF%91-UserController"><span class="nav-number">8.2.4.</span> <span class="nav-text">mc 指定 classloader 编译 UserController</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redefine"><span class="nav-number">8.2.5.</span> <span class="nav-text">redefine</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%83%AD%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%9C"><span class="nav-number">8.2.6.</span> <span class="nav-text">热修改代码结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9AArthas-%E5%90%8E%E5%8F%B0%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1"><span class="nav-number">9.</span> <span class="nav-text">案例：Arthas 后台异步任务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-amp-%E5%9C%A8%E5%90%8E%E5%8F%B0%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%EF%BC%8C%E4%BB%BB%E5%8A%A1%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-number">9.1.</span> <span class="nav-text">使用 &amp; 在后台执行任务，任务输出重定向</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-jobs-%E6%9F%A5%E7%9C%8B%E4%BB%BB%E5%8A%A1"><span class="nav-number">9.2.</span> <span class="nav-text">通过 jobs 查看任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%81%9C%E6%AD%A2%E5%91%BD%E4%BB%A4%E3%80%81%E5%88%87%E6%8D%A2%E5%89%8D%E5%90%8E%E5%8F%B0"><span class="nav-number">9.3.</span> <span class="nav-text">停止命令、切换前后台</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">9.4.</span> <span class="nav-text">注意事项</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E5%BA%94%E7%94%A8-Logger-Level"><span class="nav-number">10.</span> <span class="nav-text">案例：动态更新应用 Logger Level</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-sc-%E6%9F%A5%E6%89%BE-UserController-%E7%9A%84-ClassLoader"><span class="nav-number">10.1.</span> <span class="nav-text">使用 sc 查找 UserController 的 ClassLoader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-ognl"><span class="nav-number">10.2.</span> <span class="nav-text">使用 ognl</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8-ognl-%E8%8E%B7%E5%8F%96-logger"><span class="nav-number">10.2.1.</span> <span class="nav-text">用 ognl 获取 logger</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E7%8B%AC%E8%AE%BE%E7%BD%AE-UserController-%E7%9A%84-logger-level"><span class="nav-number">10.2.2.</span> <span class="nav-text">单独设置 UserController 的 logger level</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-logback-%E7%9A%84%E5%85%A8%E5%B1%80-logger-level"><span class="nav-number">10.2.3.</span> <span class="nav-text">修改 logback 的全局 logger level</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-logger"><span class="nav-number">10.3.</span> <span class="nav-text">使用 logger</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-logger-%E5%91%BD%E4%BB%A4%E8%8E%B7%E5%8F%96%E5%AF%B9%E5%BA%94-logger-%E4%BF%A1%E6%81%AF"><span class="nav-number">10.3.1.</span> <span class="nav-text">使用 logger 命令获取对应 logger 信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E7%8B%AC%E8%AE%BE%E7%BD%AE-UserController-%E7%9A%84-logger-level-1"><span class="nav-number">10.3.2.</span> <span class="nav-text">单独设置 UserController 的 logger level</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-logback-%E7%9A%84%E5%85%A8%E5%B1%80-logger-level-1"><span class="nav-number">10.3.3.</span> <span class="nav-text">修改 logback 的全局 logger level</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%8E%92%E6%9F%A5-logger-%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98"><span class="nav-number">11.</span> <span class="nav-text">案例：排查 logger 冲突问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE-UserController-%E7%9A%84-ClassLoader-1"><span class="nav-number">11.1.</span> <span class="nav-text">查找 UserController 的 ClassLoader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AE%E8%AE%A4%E5%BA%94%E7%94%A8%E4%BD%BF%E7%94%A8%E7%9A%84-logger-%E7%B3%BB%E7%BB%9F"><span class="nav-number">11.2.</span> <span class="nav-text">确认应用使用的 logger 系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-logback-%E5%AE%9E%E9%99%85%E5%8A%A0%E8%BD%BD%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">11.3.</span> <span class="nav-text">获取 logback 实际加载的配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8classloader-%E5%91%BD%E4%BB%A4%E6%9F%A5%E6%89%BE%E5%8F%AF%E8%83%BD%E5%AD%98%E5%9C%A8%E7%9A%84-logger-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">11.4.</span> <span class="nav-text">使用classloader 命令查找可能存在的 logger 配置文件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E8%8E%B7%E5%8F%96-Spring-Context"><span class="nav-number">12.</span> <span class="nav-text">案例：获取 Spring Context</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-tt-%E5%91%BD%E4%BB%A4%E8%8E%B7%E5%8F%96%E5%88%B0-spring-context"><span class="nav-number">12.1.</span> <span class="nav-text">使用 tt 命令获取到 spring context</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-tt-%E5%91%BD%E4%BB%A4%E4%BB%8E%E8%B0%83%E7%94%A8%E8%AE%B0%E5%BD%95%E9%87%8C%E8%8E%B7%E5%8F%96%E5%88%B0-spring-context"><span class="nav-number">12.2.</span> <span class="nav-text">使用 tt 命令从调用记录里获取到 spring context</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-spring-bean%EF%BC%8C%E5%B9%B6%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0"><span class="nav-number">12.3.</span> <span class="nav-text">获取 spring bean，并调用函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vmtool-%E8%8E%B7%E5%8F%96-HelloWorldService-%E5%AF%B9%E8%B1%A1%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%B9%B6%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0"><span class="nav-number">12.4.</span> <span class="nav-text">Vmtool 获取 HelloWorldService 对象实例，并调用函数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%8E%92%E6%9F%A5-HTTP-%E8%AF%B7%E6%B1%82%E8%BF%94%E5%9B%9E-401"><span class="nav-number">13.</span> <span class="nav-text">案例：排查 HTTP 请求返回 401</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%9F%E8%B8%AA%E6%89%80%E6%9C%89%E7%9A%84-Filter-%E5%87%BD%E6%95%B0"><span class="nav-number">13.1.</span> <span class="nav-text">跟踪所有的 Filter 函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-stack-%E8%8E%B7%E5%8F%96%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-number">13.1.1.</span> <span class="nav-text">通过 stack 获取调用栈</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%90%86%E8%A7%A3-Spring-Boot-%E5%BA%94%E7%94%A8%E7%9A%84-ClassLoader-%E7%BB%93%E6%9E%84"><span class="nav-number">14.</span> <span class="nav-text">案例：理解 Spring Boot 应用的 ClassLoader 结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89-ClassLoader"><span class="nav-number">14.1.</span> <span class="nav-text">列出所有 ClassLoader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%9F%E8%AE%A1-ClassLoader-%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8-URL-%E5%92%8C%E6%9C%AA%E4%BD%BF%E7%94%A8%E7%9A%84-URL"><span class="nav-number">14.2.</span> <span class="nav-text">统计 ClassLoader 实际使用 URL 和未使用的 URL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%97%E5%87%BA-ClassLoader-%E9%87%8C%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%89%80%E6%9C%89%E7%B1%BB"><span class="nav-number">14.3.</span> <span class="nav-text">列出 ClassLoader 里加载的所有类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%B1%BB%E7%9A%84-classloader-%E5%B1%82%E6%AC%A1"><span class="nav-number">14.4.</span> <span class="nav-text">查看类的 classloader 层次</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-ClassLoader-%E6%A0%91"><span class="nav-number">14.5.</span> <span class="nav-text">查看 ClassLoader 树</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-URLClassLoader-%E5%AE%9E%E9%99%85%E7%9A%84-urls"><span class="nav-number">14.6.</span> <span class="nav-text">查看 URLClassLoader 实际的 urls</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE-ClassLoader-%E9%87%8C%E7%9A%84%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6"><span class="nav-number">14.7.</span> <span class="nav-text">查找 ClassLoader 里的资源文件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%9F%A5%E6%89%BE-Top-N-%E7%BA%BF%E7%A8%8B"><span class="nav-number">15.</span> <span class="nav-text">案例：查找 Top N 线程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E7%BA%BF%E7%A8%8B%E4%BF%A1%E6%81%AF"><span class="nav-number">15.1.</span> <span class="nav-text">查看所有线程信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%85%B7%E4%BD%93%E7%BA%BF%E7%A8%8B%E7%9A%84%E6%A0%88"><span class="nav-number">15.2.</span> <span class="nav-text">查看具体线程的栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-CPU-%E4%BD%BF%E7%94%A8%E7%8E%87-top-n-%E7%BA%BF%E7%A8%8B%E7%9A%84%E6%A0%88"><span class="nav-number">15.3.</span> <span class="nav-text">查看 CPU 使用率 top n 线程的栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E7%BA%BF%E7%A8%8B%E6%98%AF%E5%90%A6%E6%9C%89%E9%98%BB%E5%A1%9E"><span class="nav-number">15.4.</span> <span class="nav-text">查找线程是否有阻塞</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E8%8E%B7%E5%8F%96-Spring-%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E9%85%8D%E7%BD%AE%E5%80%BC"><span class="nav-number">16.</span> <span class="nav-text">案例：获取 Spring 应用运行时配置值</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%BF%90%E8%A1%8C%E6%97%B6%E5%85%B7%E4%BD%93%E9%85%8D%E7%BD%AE"><span class="nav-number">16.1.</span> <span class="nav-text">获取运行时具体配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%85%B7%E4%BD%93%E7%9A%84%E9%85%8D%E7%BD%AE%E6%9D%A5%E6%BA%90"><span class="nav-number">16.2.</span> <span class="nav-text">获取具体的配置来源</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exit-Stop"><span class="nav-number">17.</span> <span class="nav-text">Exit&#x2F;Stop</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#reset"><span class="nav-number">17.1.</span> <span class="nav-text">reset</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%80%E5%87%BA-Arthas"><span class="nav-number">17.2.</span> <span class="nav-text">退出 Arthas</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BD%BB%E5%BA%95%E9%80%80%E5%87%BA-Arthas"><span class="nav-number">17.3.</span> <span class="nav-text">彻底退出 Arthas</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Arthas-boot-%E6%94%AF%E6%8C%81%E7%9A%84%E5%8F%82%E6%95%B0"><span class="nav-number">18.</span> <span class="nav-text">Arthas-boot 支持的参数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%81%E8%AE%B8%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AE"><span class="nav-number">18.1.</span> <span class="nav-text">允许外部访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89%E7%9A%84%E7%89%88%E6%9C%AC"><span class="nav-number">18.2.</span> <span class="nav-text">列出所有的版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AA%E4%BE%A6%E5%90%AC-Telnet-%E7%AB%AF%E5%8F%A3%EF%BC%8C%E4%B8%8D%E4%BE%A6%E5%90%AC-HTTP-%E7%AB%AF%E5%8F%A3"><span class="nav-number">18.3.</span> <span class="nav-text">只侦听 Telnet 端口，不侦听 HTTP 端口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E8%BF%90%E8%A1%8C%E7%9A%84%E8%AF%A6%E6%83%85"><span class="nav-number">18.4.</span> <span class="nav-text">打印运行的详情</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wotzc"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">wotzc</p>
  <div class="site-description" itemprop="description">真正的大师永远都怀着一颗学徒的心</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">65</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">85</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/01/05/Arthas%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="wotzc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cai">
      <meta itemprop="description" content="真正的大师永远都怀着一颗学徒的心">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Arthas进阶教程 | Cai">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Arthas进阶教程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-01-05 09:27:15" itemprop="dateCreated datePublished" datetime="2024-01-05T09:27:15+08:00">2024-01-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-01-10 15:25:05" itemprop="dateModified" datetime="2024-01-10T15:25:05+08:00">2024-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">Java诊断工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="查看-JVM-信息"><a href="#查看-JVM-信息" class="headerlink" title="查看 JVM 信息"></a>查看 JVM 信息</h1><p>下面介绍 Arthas 里查看 <code>JVM</code> 信息的命令。</p>
<h2 id="sysprop"><a href="#sysprop" class="headerlink" title="sysprop"></a>sysprop</h2><p><code>sysprop</code> 可以打印所有的 System Properties 信息。</p>
<div class="note info no-icon"><p>提示</p>
<p>查看当前 JVM 的系统属性( System Property )</p>
</div>

<h3 id="使用参考"><a href="#使用参考" class="headerlink" title="使用参考"></a>使用参考</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">USAGE:</span><br><span class="line">  sysprop [-h] [property-name] [property-value]</span><br><span class="line"></span><br><span class="line">SUMMARY:</span><br><span class="line">  Display, and change all the system properties.</span><br><span class="line"></span><br><span class="line">EXAMPLES:</span><br><span class="line">sysprop</span><br><span class="line">sysprop file.encoding</span><br><span class="line">sysprop production.mode true</span><br><span class="line"></span><br><span class="line">WIKI:</span><br><span class="line">  https://arthas.aliyun.com/doc/sysprop</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">-h, --help                                  this help</span><br><span class="line">&lt;property-name&gt;                             property name</span><br><span class="line">&lt;property-value&gt;                            property value</span><br></pre></td></tr></table></figure>

<h3 id="查看所有属性"><a href="#查看所有属性" class="headerlink" title="查看所有属性"></a>查看所有属性</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">$ sysprop</span><br><span class="line"> KEY                                                  VALUE</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> java.runtime.name                                    Java(TM) SE Runtime Environment</span><br><span class="line"> sun.boot.library.path                                /Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/lib</span><br><span class="line"> java.vm.version                                      25.51-b03</span><br><span class="line"> user.country.format                                  CN</span><br><span class="line"> gopherProxySet                                       false</span><br><span class="line"> java.vm.vendor                                       Oracle Corporation</span><br><span class="line"> java.vendor.url                                      http://java.oracle.com/</span><br><span class="line"> path.separator                                       :</span><br><span class="line"> java.vm.name                                         Java HotSpot(TM) 64-Bit Server VM</span><br><span class="line"> file.encoding.pkg                                    sun.io</span><br><span class="line"> user.country                                         US</span><br><span class="line"> sun.java.launcher                                    SUN_STANDARD</span><br><span class="line"> sun.os.patch.level                                   unknown</span><br><span class="line"> java.vm.specification.name                           Java Virtual Machine Specification</span><br><span class="line"> user.dir                                             /private/var/tmp</span><br><span class="line"> java.runtime.version                                 1.8.0_51-b16</span><br><span class="line"> java.awt.graphicsenv                                 sun.awt.CGraphicsEnvironment</span><br><span class="line"> java.endorsed.dirs                                   /Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/lib/endors</span><br><span class="line">                                                      ed</span><br><span class="line"> os.arch                                              x86_64</span><br><span class="line"> java.io.tmpdir                                       /var/folders/2c/tbxwzs4s4sbcvh7frbcc7n000000gn/T/</span><br><span class="line"> line.separator</span><br><span class="line"></span><br><span class="line"> java.vm.specification.vendor                         Oracle Corporation</span><br><span class="line"> os.name                                              Mac OS X</span><br><span class="line"> sun.jnu.encoding                                     UTF-8</span><br><span class="line"> java.library.path                                    /Users/wangtao/Library/Java/Extensions:/Library/Java/Extensions:/Network/Libra</span><br><span class="line">                                                      ry/Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java:.</span><br><span class="line"> sun.nio.ch.bugLevel</span><br><span class="line"> java.specification.name                              Java Platform API Specification</span><br><span class="line"> java.class.version                                   52.0</span><br><span class="line"> sun.management.compiler                              HotSpot 64-Bit Tiered Compilers</span><br><span class="line"> os.version                                           10.12.6</span><br><span class="line"> user.home                                            /Users/wangtao</span><br><span class="line"> user.timezone                                        Asia/Shanghai</span><br><span class="line"> java.awt.printerjob                                  sun.lwawt.macosx.CPrinterJob</span><br><span class="line"> file.encoding                                        UTF-8</span><br><span class="line"> java.specification.version                           1.8</span><br><span class="line"> user.name                                            wangtao</span><br><span class="line"> java.class.path                                      .</span><br><span class="line"> java.vm.specification.version                        1.8</span><br><span class="line"> sun.arch.data.model                                  64</span><br><span class="line"> java.home                                            /Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre</span><br><span class="line"> sun.java.command                                     Test</span><br><span class="line"> java.specification.vendor                            Oracle Corporation</span><br><span class="line"> user.language                                        en</span><br><span class="line"> awt.toolkit                                          sun.lwawt.macosx.LWCToolkit</span><br><span class="line"> java.vm.info                                         mixed mode</span><br><span class="line"> java.version                                         1.8.0_51</span><br><span class="line"> java.ext.dirs                                        /Users/wangtao/Library/Java/Extensions:/Library/Java/JavaVirtualMachines/jdk1.</span><br><span class="line">                                                      8.0_51.jdk/Contents/Home/jre/lib/ext:/Library/Java/Extensions:/Network/Library</span><br><span class="line">                                                      /Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java</span><br><span class="line"> sun.boot.class.path                                  /Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/lib/resour</span><br><span class="line">                                                      ces.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/li</span><br><span class="line">                                                      b/rt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/Home/jre/l</span><br><span class="line">                                                      ib/sunrsasign.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Contents/H</span><br><span class="line">                                                      ome/jre/lib/jsse.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Content</span><br><span class="line">                                                      s/Home/jre/lib/jce.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jdk/Conte</span><br><span class="line">                                                      nts/Home/jre/lib/charsets.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.jd</span><br><span class="line">                                                      k/Contents/Home/jre/lib/jfr.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_51.</span><br><span class="line">                                                      jdk/Contents/Home/jre/classes</span><br><span class="line"> java.vendor                                          Oracle Corporation</span><br><span class="line"> file.separator                                       /</span><br><span class="line"> java.vendor.url.bug                                  http://bugreport.sun.com/bugreport/</span><br><span class="line"> sun.cpu.endian                                       little</span><br><span class="line"> sun.io.unicode.encoding                              UnicodeBig</span><br><span class="line"> sun.cpu.isalist</span><br></pre></td></tr></table></figure>

<h3 id="查看单个属性"><a href="#查看单个属性" class="headerlink" title="查看单个属性"></a>查看单个属性</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sysprop java.version</span><br><span class="line">java.version=1.8.0_51</span><br></pre></td></tr></table></figure>

<h3 id="修改单个属性"><a href="#修改单个属性" class="headerlink" title="修改单个属性"></a>修改单个属性</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sysprop user.country</span><br><span class="line">user.country=US</span><br><span class="line">$ sysprop user.country CN</span><br><span class="line">Successfully changed the system property.</span><br><span class="line">user.country=CN</span><br></pre></td></tr></table></figure>

<h2 id="sysenv"><a href="#sysenv" class="headerlink" title="sysenv"></a>sysenv</h2><p><code>sysenv</code> 命令可以获取到环境变量。和<code>sysprop</code> 命令类似。</p>
<div class="note info no-icon"><p>提示</p>
<p>查看当前 JVM 的环境属性( System Environment Variables )</p>
</div>

<h3 id="使用参考-1"><a href="#使用参考-1" class="headerlink" title="使用参考"></a>使用参考</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">USAGE:</span><br><span class="line">  sysenv [-h] [env-name]</span><br><span class="line"></span><br><span class="line">SUMMARY:</span><br><span class="line">  Display the system env.</span><br><span class="line"></span><br><span class="line">EXAMPLES:</span><br><span class="line">  sysenv</span><br><span class="line">  sysenv USER</span><br><span class="line"></span><br><span class="line">WIKI:</span><br><span class="line">  https://arthas.aliyun.com/doc/sysenv</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">-h, --help                                                 this help</span><br><span class="line">&lt;env-name&gt;                                                 env name</span><br></pre></td></tr></table></figure>

<h3 id="查看所有环境变量"><a href="#查看所有环境变量" class="headerlink" title="查看所有环境变量"></a>查看所有环境变量</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ sysenv</span><br><span class="line"> KEY                      VALUE</span><br><span class="line">----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> PATH                     /Users/admin/.sdkman/candidates/visualvm/current/bin:/Users/admin/.sdkman/candidates/ja</span><br><span class="line">                          va/current/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Applications/Wireshark.app/Contents/</span><br><span class="line">                          MacOS</span><br><span class="line"> SDKMAN_VERSION           5.7.3+337</span><br><span class="line"> JAVA_HOME                /Users/admin/.sdkman/candidates/java/current</span><br><span class="line"> JAVA_MAIN_CLASS_65244    demo.MathGame</span><br><span class="line"> TERM                     xterm-256color</span><br><span class="line"> LANG                     zh_CN.UTF-8</span><br><span class="line"> AUTOJUMP_SOURCED         1</span><br><span class="line"> COLORTERM                truecolor</span><br><span class="line"> LOGNAME                  admin</span><br><span class="line"> XPC_SERVICE_NAME         0</span><br><span class="line"> PWD                      /Users/admin/code/ali/arthas/demo</span><br><span class="line"> TERM_PROGRAM_VERSION     3.2.5</span><br><span class="line"> _                        /Users/admin/.sdkman/candidates/java/current/bin/java</span><br><span class="line"> SHELL                    /bin/bash</span><br><span class="line"> TERM_PROGRAM             iTerm.app</span><br><span class="line"> SDKMAN_PLATFORM          Darwin</span><br><span class="line"> USER                     admin</span><br><span class="line"> ITERM_PROFILE            Default</span><br><span class="line"> TMPDIR                   /var/folders/0r/k561bkk917gg972stqclbz9h0000gn/T/</span><br><span class="line"> XPC_FLAGS                0x0</span><br><span class="line"> TERM_SESSION_ID          w0t4p0:60BC264D-9649-42AC-A7E4-AF85B69F93F8</span><br><span class="line"> __CF_USER_TEXT_ENCODING  0x1F5:0x19:0x34</span><br><span class="line"> Apple_PubSub_Socket_Ren  /private/tmp/com.apple.launchd.DwmmjSQsll/Render</span><br><span class="line"> der</span><br><span class="line"> COLORFGBG                7;0</span><br><span class="line"> HOME                     /Users/admin</span><br><span class="line"> SHLVL                    1</span><br><span class="line"> AUTOJUMP_ERROR_PATH      /Users/admin/Library/autojump/errors.log</span><br></pre></td></tr></table></figure>

<h3 id="查看单个环境变量"><a href="#查看单个环境变量" class="headerlink" title="查看单个环境变量"></a>查看单个环境变量</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sysenv USER</span><br><span class="line">USER=admin</span><br></pre></td></tr></table></figure>

<h2 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h2><p><code>jvm</code> 命令会打印出<code>JVM</code> 的各种详细信息。</p>
<div class="note info no-icon"><p>提示</p>
<p>查看当前 JVM 信息</p>
</div>

<h3 id="使用参考-2"><a href="#使用参考-2" class="headerlink" title="使用参考"></a>使用参考</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">$ jvm</span><br><span class="line">RUNTIME</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> MACHINE-NAME                   37@ff267334bb65</span><br><span class="line"> JVM-START-TIME                 2020-07-23 07:50:36</span><br><span class="line"> MANAGEMENT-SPEC-VERSION        1.2</span><br><span class="line"> SPEC-NAME                      Java Virtual Machine Specification</span><br><span class="line"> SPEC-VENDOR                    Oracle Corporation</span><br><span class="line"> SPEC-VERSION                   1.8</span><br><span class="line"> VM-NAME                        Java HotSpot(TM) 64-Bit Server VM</span><br><span class="line"> VM-VENDOR                      Oracle Corporation</span><br><span class="line"> VM-VERSION                     25.201-b09</span><br><span class="line"> INPUT-ARGUMENTS                []</span><br><span class="line"> CLASS-PATH                     demo-arthas-spring-boot.jar</span><br><span class="line"> BOOT-CLASS-PATH                /usr/lib/jvm/java-8-oracle/jre/lib/resources.jar:/usr/lib/jvm/java-8-oracle/j</span><br><span class="line">                                re/lib/rt.jar:/usr/lib/jvm/java-8-oracle/jre/lib/sunrsasign.jar:/usr/lib/jvm/</span><br><span class="line">                                java-8-oracle/jre/lib/jsse.jar:/usr/lib/jvm/java-8-oracle/jre/lib/jce.jar:/us</span><br><span class="line">                                r/lib/jvm/java-8-oracle/jre/lib/charsets.jar:/usr/lib/jvm/java-8-oracle/jre/l</span><br><span class="line">                                ib/jfr.jar:/usr/lib/jvm/java-8-oracle/jre/classes</span><br><span class="line"> LIBRARY-PATH                   /usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> CLASS-LOADING</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> LOADED-CLASS-COUNT             7529</span><br><span class="line"> TOTAL-LOADED-CLASS-COUNT       7529</span><br><span class="line"> UNLOADED-CLASS-COUNT           0</span><br><span class="line"> IS-VERBOSE                     false</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> COMPILATION</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> NAME                           HotSpot 64-Bit Tiered Compilers</span><br><span class="line"> TOTAL-COMPILE-TIME             14921(ms)</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> GARBAGE-COLLECTORS</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> PS Scavenge                            name : PS Scavenge</span><br><span class="line"> [count/time (ms)]                      collectionCount : 7</span><br><span class="line">                                        collectionTime : 68</span><br><span class="line"></span><br><span class="line"> PS MarkSweep                           name : PS MarkSweep</span><br><span class="line"> [count/time (ms)]                      collectionCount : 1</span><br><span class="line">                                        collectionTime : 47</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> MEMORY-MANAGERS</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> CodeCacheManager               Code Cache</span><br><span class="line"></span><br><span class="line"> Metaspace Manager              Metaspace</span><br><span class="line">                                Compressed Class Space</span><br><span class="line"></span><br><span class="line"> Copy                           Eden Space</span><br><span class="line">                                Survivor Space</span><br><span class="line"></span><br><span class="line"> MarkSweepCompact               Eden Space</span><br><span class="line">                                Survivor Space</span><br><span class="line">                                Tenured Gen</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> MEMORY</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> HEAP-MEMORY-USAGE                      init : 268435456(256.0 MiB)</span><br><span class="line"> [memory in bytes]                      used : 18039504(17.2 MiB)</span><br><span class="line">                                        committed : 181403648(173.0 MiB)</span><br><span class="line">                                        max : 3817865216(3.6 GiB)</span><br><span class="line"></span><br><span class="line"> NO-HEAP-MEMORY-USAGE                   init : 2555904(2.4 MiB)</span><br><span class="line"> [memory in bytes]                      used : 33926216(32.4 MiB)</span><br><span class="line">                                        committed : 35176448(33.5 MiB)</span><br><span class="line">                                        max : -1(-1 B)</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> OPERATING-SYSTEM</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> OS                             Linux</span><br><span class="line"> ARCH                           amd64</span><br><span class="line"> PROCESSORS-COUNT               3</span><br><span class="line"> LOAD-AVERAGE                   29.53</span><br><span class="line"> VERSION                        4.15.0-52-generic</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> THREAD</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> COUNT                          30</span><br><span class="line"> DAEMON-COUNT                   24</span><br><span class="line"> PEAK-COUNT                     31</span><br><span class="line"> STARTED-COUNT                  36</span><br><span class="line"> DEADLOCK-COUNT                 0</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> FILE-DESCRIPTOR</span><br><span class="line">--------------------------------------------------------------------------------------------------------------</span><br><span class="line"> MAX-FILE-DESCRIPTOR-COUNT      1048576</span><br><span class="line"> OPEN-FILE-DESCRIPTOR-COUNT     100</span><br><span class="line">Affect(row-cnt:0) cost in 88 ms.</span><br></pre></td></tr></table></figure>

<h3 id="THREAD-相关"><a href="#THREAD-相关" class="headerlink" title="THREAD 相关"></a>THREAD 相关</h3><ul>
<li><code>COUNT</code>: JVM 当前活跃的线程数</li>
<li><code>DAEMON-COUNT</code>: JVM 当前活跃的守护线程数</li>
<li><code>PEAK-COUNT</code>: 从 JVM 启动开始曾经活着的最大线程数</li>
<li><code>STARTED-COUNT</code>: 从 JVM 启动开始总共启动过的线程次数</li>
<li><code>DEADLOCK-COUNT</code>: JVM 当前死锁的线程数</li>
</ul>
<h3 id="文件描述符相关"><a href="#文件描述符相关" class="headerlink" title="文件描述符相关"></a>文件描述符相关</h3><ul>
<li><code>MAX-FILE-DESCRIPTOR-COUNT</code>：JVM 进程最大可以打开的文件描述符数</li>
<li><code>OPEN-FILE-DESCRIPTOR-COUNT</code>：JVM 当前打开的文件描述符数</li>
</ul>
<hr>
<h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><p>为了更好使用 Arthas，下面先介绍 Arthas 里的一些使用技巧。</p>
<h2 id="help"><a href="#help" class="headerlink" title="help"></a>help</h2><p>Arthas 里每一个命令都有详细的帮助信息。可以用<code>-h</code> 来查看。帮助信息里有<code>EXAMPLES</code> 和<code>WIKI</code> 链接。</p>
<p>比如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysprop -h</span><br></pre></td></tr></table></figure>

<h2 id="自动补全"><a href="#自动补全" class="headerlink" title="自动补全"></a>自动补全</h2><p><code>Arthas</code> 支持丰富的自动补全功能，在使用有疑惑时，可以输入<code>Tab</code> 来获取更多信息。</p>
<p>比如输入 <code>sysprop java.</code> 之后，再输入<code>Tab</code> ，会补全出对应的 key。</p>
<h2 id="readline-的快捷键支持"><a href="#readline-的快捷键支持" class="headerlink" title="readline 的快捷键支持"></a>readline 的快捷键支持</h2><p><code>Arthas</code> 支持常见的命令行快捷键，比如<code>Ctrl + A</code> 跳转行首，<code>Ctrl + E</code> 跳转行尾。</p>
<p>更多的快捷键可以用 <code>keymap</code> 命令查看。</p>
<h2 id="历史命令的补全"><a href="#历史命令的补全" class="headerlink" title="历史命令的补全"></a>历史命令的补全</h2><p>如果想再执行之前的命令，可以在输入一半时，按<code>Up/↑</code> 或者 <code>Ddown/↓</code> ，来匹配到之前的命令。</p>
<p>比如之前执行过<code>sysprop java.version</code> ，那么在输入<code>sysprop ja</code> 之后，可以输入<code>Up/↑</code> ，就会自动补全为<code>sysprop java.version</code> 。</p>
<p>如果想查看所有的历史命令，也可以通过 <code>history</code> 命令查看到。</p>
<h2 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h2><p><code>Arthas</code> 支持在 <code>pipeline</code> 之后，执行一些简单的命令，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sysprop | grep java</span><br><span class="line">sysprop | wc -l</span><br></pre></td></tr></table></figure>

<h1 id="Sc-sm-查看已加载的类"><a href="#Sc-sm-查看已加载的类" class="headerlink" title="Sc/sm 查看已加载的类"></a>Sc/sm 查看已加载的类</h1><p>下面介绍 <code>Arthas</code> 里查找已加载类的命令。</p>
<h2 id="Sc"><a href="#Sc" class="headerlink" title="Sc"></a>Sc</h2><p><code>sc</code> 命令可以查找到所有 JVM 已经加载到的类。</p>
<p>如果搜索的是接口，还会搜索所有的实现类。比如查看所有的<code>Filter</code> 实现类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc javax.servlet.Filter</span><br></pre></td></tr></table></figure>

<p>通过<code>-d</code> 参数，可以打印出类加载的具体信息，很方便查找类加载问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc -d javax.servlet.Filter</span><br></pre></td></tr></table></figure>

<p><code>sc</code> 支持通配，比如搜索所有的<code>StringUtils</code> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc *StringUtils</span><br></pre></td></tr></table></figure>

<h2 id="sm"><a href="#sm" class="headerlink" title="sm"></a>sm</h2><div class="note info no-icon"><p>提示</p>
<p>查看已加载类的方法信息</p>
</div>

<p>“Search-Method” 的简写，这个命令能搜索出所有已经加载了 Class 信息的方法信息。</p>
<p><code>sm</code> 命令只能看到由当前类所声明 (declaring) 的方法，父类则无法看到。</p>
<h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><table>
<thead>
<tr>
<th align="right">参数名称</th>
<th align="left">参数说明</th>
</tr>
</thead>
<tbody><tr>
<td align="right"><em>class-pattern</em></td>
<td align="left">类名表达式匹配</td>
</tr>
<tr>
<td align="right"><em>method-pattern</em></td>
<td align="left">方法名表达式匹配</td>
</tr>
<tr>
<td align="right">[d]</td>
<td align="left">展示每个方法的详细信息</td>
</tr>
<tr>
<td align="right">[E]</td>
<td align="left">开启正则表达式匹配，默认为通配符匹配</td>
</tr>
<tr>
<td align="right"><code>[c:]</code></td>
<td align="left">指定 class 的 ClassLoader 的 hashcode</td>
</tr>
<tr>
<td align="right"><code>[classLoaderClass:]</code></td>
<td align="left">指定执行表达式的 ClassLoader 的 class name</td>
</tr>
<tr>
<td align="right"><code>[n:]</code></td>
<td align="left">具有详细信息的匹配类的最大数量（默认为 100）</td>
</tr>
</tbody></table>
<h3 id="使用参考-3"><a href="#使用参考-3" class="headerlink" title="使用参考"></a>使用参考</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ sm java.lang.String</span><br><span class="line">java.lang.String-&gt;&lt;init&gt;</span><br><span class="line">java.lang.String-&gt;equals</span><br><span class="line">java.lang.String-&gt;toString</span><br><span class="line">java.lang.String-&gt;hashCode</span><br><span class="line">java.lang.String-&gt;compareTo</span><br><span class="line">java.lang.String-&gt;indexOf</span><br><span class="line">java.lang.String-&gt;valueOf</span><br><span class="line">java.lang.String-&gt;checkBounds</span><br><span class="line">java.lang.String-&gt;length</span><br><span class="line">java.lang.String-&gt;isEmpty</span><br><span class="line">java.lang.String-&gt;charAt</span><br><span class="line">java.lang.String-&gt;codePointAt</span><br><span class="line">java.lang.String-&gt;codePointBefore</span><br><span class="line">java.lang.String-&gt;codePointCount</span><br><span class="line">java.lang.String-&gt;offsetByCodePoints</span><br><span class="line">java.lang.String-&gt;getChars</span><br><span class="line">java.lang.String-&gt;getBytes</span><br><span class="line">java.lang.String-&gt;contentEquals</span><br><span class="line">java.lang.String-&gt;nonSyncContentEquals</span><br><span class="line">java.lang.String-&gt;equalsIgnoreCase</span><br><span class="line">java.lang.String-&gt;compareToIgnoreCase</span><br><span class="line">java.lang.String-&gt;regionMatches</span><br><span class="line">java.lang.String-&gt;startsWith</span><br><span class="line">java.lang.String-&gt;endsWith</span><br><span class="line">java.lang.String-&gt;indexOfSupplementary</span><br><span class="line">java.lang.String-&gt;lastIndexOf</span><br><span class="line">java.lang.String-&gt;lastIndexOfSupplementary</span><br><span class="line">java.lang.String-&gt;substring</span><br><span class="line">java.lang.String-&gt;subSequence</span><br><span class="line">java.lang.String-&gt;concat</span><br><span class="line">java.lang.String-&gt;replace</span><br><span class="line">java.lang.String-&gt;matches</span><br><span class="line">java.lang.String-&gt;contains</span><br><span class="line">java.lang.String-&gt;replaceFirst</span><br><span class="line">java.lang.String-&gt;replaceAll</span><br><span class="line">java.lang.String-&gt;split</span><br><span class="line">java.lang.String-&gt;join</span><br><span class="line">java.lang.String-&gt;toLowerCase</span><br><span class="line">java.lang.String-&gt;toUpperCase</span><br><span class="line">java.lang.String-&gt;trim</span><br><span class="line">java.lang.String-&gt;toCharArray</span><br><span class="line">java.lang.String-&gt;format</span><br><span class="line">java.lang.String-&gt;copyValueOf</span><br><span class="line">java.lang.String-&gt;intern</span><br><span class="line">Affect(row-cnt:44) cost <span class="keyword">in</span> 1342 ms.</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sm -d java.lang.String toString</span><br><span class="line"> declaring-class  java.lang.String</span><br><span class="line"> method-name      toString</span><br><span class="line"> modifier         public</span><br><span class="line"> annotation</span><br><span class="line"> parameters</span><br><span class="line"> <span class="built_in">return</span>           java.lang.String</span><br><span class="line"> exceptions</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 3 ms.</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Jad"><a href="#Jad" class="headerlink" title="Jad"></a>Jad</h1><p>可以通过 <code>jad</code> 命令来反编译代码：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jad com.example.demo.arthas.user.UserController</span><br></pre></td></tr></table></figure>

<p>通过<code>--source-only</code> 参数可以只打印出在反编译的源代码：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jad --source-only com.example.demo.arthas.user.UserController</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="OGNL"><a href="#OGNL" class="headerlink" title="OGNL"></a>OGNL</h1><h2 id="OGNL-一般语法"><a href="#OGNL-一般语法" class="headerlink" title="OGNL 一般语法"></a>OGNL 一般语法</h2><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><ul>
<li><p>数组和列表的索引，可以使用 <code>array[&quot;length&quot;]</code></p>
</li>
<li><p>JavaBeans 索引属性</p>
<p>如一个 JavaBeans 有以下四个重载方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PropertyType[] getPropertyName();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyName</span><span class="params">(PropertyType[] anArray)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> PropertyType <span class="title">getPropertyName</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyName</span><span class="params">(<span class="keyword">int</span> index, PropertyType value)</span></span>;</span><br></pre></td></tr></table></figure>

<p>则</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">someProperty[2]</span><br></pre></td></tr></table></figure>

<p>等价于 Java 代码的</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getPropertyName(2)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl <span class="string">&quot;&#123;1,2,3,4&#125;[0]&quot;</span></span><br></pre></td></tr></table></figure>

<p>通过上面命令可以获取到列表的第一个元素</p>
<h3 id="变量引用"><a href="#变量引用" class="headerlink" title="变量引用"></a>变量引用</h3><p>使用 <code>#</code> 在 OGNL 中定义临时变量，他们全局可见，此外表达式计算的每一步结果都保存在变量 <code>this</code> 中：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl <span class="string">&quot;&#123;10,20,30&#125;[0].(#this &gt; 5 ? #this*2 : #this+10)&quot;</span></span><br></pre></td></tr></table></figure>

<p>上面命令通过获取列表的第一个元素进行判断，如果大于 <code>5</code> 则乘以 <code>2</code> 反之则加 <code>10</code> 。</p>
<h3 id="方法调用"><a href="#方法调用" class="headerlink" title="方法调用"></a>方法调用</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method( ensureLoaded(), name )</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>OGNL 是运行时调用，因此没有任何静态类型的信息可以参考，所以如果解析到有多个匹配的方法，则任选其中一个方法调用</li>
<li>常量 null 可以匹配所有的非原始类型的对象</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl <span class="string">&quot;&#123;1,2,3,4&#125;.size()&quot;</span></span><br></pre></td></tr></table></figure>

<p>通过上面命令可以调用 <code>ArrayList</code> 的 <code>size()</code> 方法获取到 ArrayList 的大小</p>
<h3 id="复杂链式表达式"><a href="#复杂链式表达式" class="headerlink" title="复杂链式表达式"></a>复杂链式表达式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">headline.parent.(ensureLoaded(), name)</span><br></pre></td></tr></table></figure>

<p>等价于</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">headline.parent.ensureLoaded(), headline.parent.name</span><br><span class="line">ognl <span class="string">&quot;@java.lang.System@out.(print(&#x27;Hello &#x27;), print(&#x27;world\n&#x27;))&quot;</span></span><br></pre></td></tr></table></figure>

<p>运行上面这个命令后，你可以在 Tab1 的终端看到 <code>Hello world</code> 的输出。</p>
<h3 id="集合操作"><a href="#集合操作" class="headerlink" title="集合操作"></a>集合操作</h3><h4 id="新建列表"><a href="#新建列表" class="headerlink" title="新建列表"></a>新建列表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;1 in &#123;2, 3&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>上面这条命令判断 <code>1</code> 是否在列表 <code>[2, 3]</code> 中。</p>
<h4 id="新建原生数组"><a href="#新建原生数组" class="headerlink" title="新建原生数组"></a>新建原生数组</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;new int[] &#123;1, 2, 3&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>指定长度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;new int[9]&quot;</span><br></pre></td></tr></table></figure>

<h4 id="新建-Maps"><a href="#新建-Maps" class="headerlink" title="新建 Maps"></a>新建 Maps</h4><p>新建普通 Map</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;#&#123; &#39;foo&#39;: &#39;foo value&#39;, &#39;bar&#39;: &#39;bar value&#39; &#125;&quot;</span><br></pre></td></tr></table></figure>

<p>新建特定类型 Map</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;#@java.util.HashMap@&#123; &#39;foo&#39;: &#39;foo value&#39;, &#39;bar&#39;: &#39;bar value&#39; &#125;&quot;</span><br></pre></td></tr></table></figure>

<h4 id="集合的投影"><a href="#集合的投影" class="headerlink" title="集合的投影"></a>集合的投影</h4><p>OGNL 把对针对集合上的每个元素调用同一个方法并返回新的集合的行为称之为“投影”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;&#123;1, 2, 3&#125;.&#123;#this*2&#125;&quot;</span><br></pre></td></tr></table></figure>

<h4 id="查找集合元素"><a href="#查找集合元素" class="headerlink" title="查找集合元素"></a>查找集合元素</h4><ul>
<li>查找所有匹配的元素<br><code>ognl &quot;&#123;1024, &#39;Hello world!&#39;, true, 2048&#125;.&#123;? #this instanceof Number&#125;&quot;</code></li>
<li>查找第一个匹配的元素<br><code>ognl &quot;&#123;1024, &#39;Hello world!&#39;, true, 2048&#125;.&#123;^ #this instanceof Number&#125;&quot;</code></li>
<li>查找最后一个匹配的元素<br><code>ognl &quot;&#123;1024, &#39;Hello world!&#39;, true, 2048&#125;.&#123;$ #this instanceof Number&#125;&quot;</code></li>
</ul>
<h4 id="集合的虚拟属性"><a href="#集合的虚拟属性" class="headerlink" title="集合的虚拟属性"></a>集合的虚拟属性</h4><p>OGNL 定义了一些特定的集合属性，含义与相应的 Java 集合方法完全等价。</p>
<ul>
<li><code>Collections</code><ul>
<li><code>size</code> 集合大小</li>
<li><code>isEmpty</code> 集合为空时返回 <code>true</code></li>
</ul>
</li>
<li><code>List</code><ul>
<li><code>iterator</code> 返回 List 的 iterator</li>
</ul>
</li>
<li><code>Map</code><ul>
<li><code>keys</code> 返回 Map 的所有 Key 值</li>
<li><code>values</code> 返回 Map 的所有 Value 值</li>
</ul>
</li>
<li><code>Set</code><ul>
<li><code>iterator</code> 返回 Set 的 iterator</li>
</ul>
</li>
</ul>
<h4 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h4><p>非 <code>java.lang</code> 包下的所有类的构造函数都要用类的权限定名称。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;new java.util.ArrayList()&quot;</span><br></pre></td></tr></table></figure>

<h4 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl -x 3 &#39;@java.lang.Math@sqrt(9.0D)&#39;</span><br></pre></td></tr></table></figure>

<h4 id="静态属性"><a href="#静态属性" class="headerlink" title="静态属性"></a>静态属性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl -x 3 &#39;@java.io.File@separator&#39;</span><br></pre></td></tr></table></figure>

<h4 id="伪-lambda-表达式"><a href="#伪-lambda-表达式" class="headerlink" title="伪 lambda 表达式"></a>伪 lambda 表达式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &quot;#fact &#x3D; :[#this&lt;&#x3D;1? 1 : #this*#fact(#this-1)], #fact(3)&quot;</span><br></pre></td></tr></table></figure>

<p>该命令实现了一个 lambda 递归实现了一个阶乘函数，并求 3 的阶乘。</p>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>更多详细语法请查看<a target="_blank" rel="noopener" href="https://commons.apache.org/proper/commons-ognl/language-guide.html">官方文档</a>。</p>
<h2 id="Arthas-OGNL"><a href="#Arthas-OGNL" class="headerlink" title="Arthas-OGNL"></a>Arthas-OGNL</h2><p>在 Arthas 里，有一个单独的 ognl 命令，可以动态执行代码。</p>
<h3 id="调用-static-函数"><a href="#调用-static-函数" class="headerlink" title="调用 static 函数"></a>调用 static 函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ognl &#39;@java.lang.System@out.println(&quot;hello ognl&quot;)&#39;</span><br></pre></td></tr></table></figure>

<h3 id="查找-UserController-的-ClassLoader"><a href="#查找-UserController-的-ClassLoader" class="headerlink" title="查找 UserController 的 ClassLoader"></a>查找 UserController 的 ClassLoader</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc -d com.example.demo.arthas.user.UserController | grep classLoaderHash</span><br></pre></td></tr></table></figure>

<p>注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，提取对应 ClassLoader 的 hashcode。<br>如果你使用<code>-c</code> ，你需要手动输入由上述命令获取到的 hashcode：<code>-c &lt;hashcode&gt;</code><br>对于只有唯一实例的 ClassLoader 可以通过<code>--classLoaderClass</code> 指定 class name，使用起来更加方便：<br><code>--classLoaderClass</code> 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code> 是动态变化的。</p>
<h3 id="获取静态类的静态字段"><a href="#获取静态类的静态字段" class="headerlink" title="获取静态类的静态字段"></a>获取静态类的静态字段</h3><p>获取<code>CRBCMsgAdapterController</code> 类里的<code>logger</code> 字段：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[arthas@9012]$ ognl -c 18b4aac2 @com.crb.adaptor.controller.CRBCMsgAdapterController@logger</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID=@Long[5454405123156820674],</span><br><span class="line">    FQCN=@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name=@String[com.crb.adaptor.controller.CRBCMsgAdapterController],</span><br><span class="line">    level=null,</span><br><span class="line">    effectiveLevelInt=@Integer[20000],</span><br><span class="line">    parent=@Logger[Logger[com.crb.adaptor.controller]],</span><br><span class="line">    childrenList=null,</span><br><span class="line">    aai=null,</span><br><span class="line">    additive=@Boolean[<span class="literal">true</span>],</span><br><span class="line">    loggerContext=@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>还可以通过<code>-x</code> 参数控制返回值的展开层数。比如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[arthas@9012]$ ognl c 18b4aacc2 -x 2 @com.crb.adaptor.controller.CRBCMsgAdapterController@logger</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID=@Long[5454405123156820674],</span><br><span class="line">    FQCN=@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name=@String[com.crb.adaptor.controller.CRBCMsgAdapterController],</span><br><span class="line">    level=null,</span><br><span class="line">    effectiveLevelInt=@Integer[20000],</span><br><span class="line">    parent=@Logger[</span><br><span class="line">        serialVersionUID=@Long[5454405123156820674],</span><br><span class="line">        FQCN=@String[ch.qos.logback.classic.Logger],</span><br><span class="line">        name=@String[com.crb.adaptor.controller],</span><br><span class="line">        level=null,</span><br><span class="line">        effectiveLevelInt=@Integer[20000],</span><br><span class="line">        parent=@Logger[Logger[com.crb.adaptor]],</span><br><span class="line">        childrenList=@CopyOnWriteArrayList[isEmpty=<span class="literal">false</span>;size=1],</span><br><span class="line">        aai=null,</span><br><span class="line">        additive=@Boolean[<span class="literal">true</span>],</span><br><span class="line">        loggerContext=@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">    ],</span><br><span class="line">    childrenList=null,</span><br><span class="line">    aai=null,</span><br><span class="line">    additive=@Boolean[<span class="literal">true</span>],</span><br><span class="line">    loggerContext=@LoggerContext[</span><br><span class="line">        DEFAULT_PACKAGING_DATA=@Boolean[<span class="literal">false</span>],</span><br><span class="line">        root=@Logger[Logger[ROOT]],</span><br><span class="line">        size=@Integer[416],</span><br><span class="line">        noAppenderWarning=@Integer[2],</span><br><span class="line">        loggerContextListenerList=@ArrayList[isEmpty=<span class="literal">false</span>;size=1],</span><br><span class="line">        loggerCache=@ConcurrentHashMap[isEmpty=<span class="literal">false</span>;size=416],</span><br><span class="line">        loggerContextRemoteView=@LoggerContextVO[LoggerContextVO&#123;name=<span class="string">&#x27;default&#x27;</span>, propertyMap=&#123;PORT=8610, APPLICATION_NAME=core-tf-application&#125;, birthTime=1704438833539&#125;],</span><br><span class="line">        turboFilterList=@TurboFilterList[isEmpty=<span class="literal">true</span>;size=0],</span><br><span class="line">        packagingDataEnabled=@Boolean[<span class="literal">false</span>],</span><br><span class="line">        maxCallerDataDepth=@Integer[8],</span><br><span class="line">        resetCount=@Integer[2],</span><br><span class="line">        frameworkPackages=@ArrayList[isEmpty=<span class="literal">true</span>;size=0],</span><br><span class="line">        birthTime=@Long[1704438833539],</span><br><span class="line">        name=@String[default],</span><br><span class="line">        sm=@BasicStatusManager[ch.qos.logback.core.BasicStatusManager@2eb37a8d],</span><br><span class="line">        propertyMap=@HashMap[isEmpty=<span class="literal">false</span>;size=2],</span><br><span class="line">        objectMap=@HashMap[isEmpty=<span class="literal">false</span>;size=7],</span><br><span class="line">        configurationLock=@LogbackLock[ch.qos.logback.core.spi.LogbackLock@1db45c81],</span><br><span class="line">        scheduledExecutorService=@ScheduledThreadPoolExecutor[java.util.concurrent.ScheduledThreadPoolExecutor@ac21a5d[Running, pool size = 8, active threads = 0, queued tasks = 1, completed tasks = 28]],</span><br><span class="line">        scheduledFutures=@ArrayList[isEmpty=<span class="literal">false</span>;size=1],</span><br><span class="line">        lifeCycleManager=@LifeCycleManager[ch.qos.logback.core.LifeCycleManager@74197f30],</span><br><span class="line">        started=@Boolean[<span class="literal">false</span>],</span><br><span class="line">    ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="执行多行表达式，赋值给临时变量，返回一个-List"><a href="#执行多行表达式，赋值给临时变量，返回一个-List" class="headerlink" title="执行多行表达式，赋值给临时变量，返回一个 List"></a>执行多行表达式，赋值给临时变量，返回一个 List</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ognl <span class="string">&#x27;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#x27;</span></span><br><span class="line">@ArrayList[</span><br><span class="line">    @String[/opt/java/8.0.181-zulu/jre],</span><br><span class="line">    @String[OpenJDK Runtime Environment],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h3><p>在 Arthas 里<code>ognl</code> 表达式是很重要的功能，在很多命令里都可以使用<code>ognl</code> 表达式。</p>
<p>一些更复杂的用法，可以参考：</p>
<ul>
<li>OGNL 特殊用法请参考：<a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/71">https://github.com/alibaba/arthas/issues/71</a></li>
<li>OGNL 表达式官方指南：<a target="_blank" rel="noopener" href="https://commons.apache.org/proper/commons-ognl/language-guide.html">https://commons.apache.org/proper/commons-ognl/language-guide.html</a></li>
</ul>
<hr>
<h1 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h1><p>在 Arthas 里有一些开关，可以通过 <code>options</code> 命令来查看 。</p>
<h2 id="查看所有的-options"><a href="#查看所有的-options" class="headerlink" title="查看所有的 options"></a>查看所有的 options</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ options</span><br><span class="line"> LEVEL  TYPE    NAME          VALUE   SUMMARY               DESCRIPTION</span><br><span class="line">-------------------------------------------------------------------------------------------------------</span><br><span class="line"> 0      boolea  unsafe        <span class="literal">false</span>   Option to support sy  This option enables to proxy functionality</span><br><span class="line">        n                             stem-level class       of JVM classes. Due to serious security r</span><br><span class="line">                                                            isk a JVM crash is possibly be introduced.</span><br><span class="line">                                                             Do not activate it unless you are able to</span><br><span class="line">                                                             manage.</span><br><span class="line"> 1      boolea  dump          <span class="literal">false</span>   Option to dump the e  This option enables the enhanced classes t</span><br><span class="line">        n                             nhanced classes       o be dumped to external file <span class="keyword">for</span> further d</span><br><span class="line">                                                            e-compilation and analysis.</span><br><span class="line"> 1      boolea  batch-re-tra  <span class="literal">true</span>    Option to support ba  This options enables to reTransform classe</span><br><span class="line">        n       nsform                tch reTransform Clas  s with batch mode.</span><br><span class="line">                                      s</span><br><span class="line"> 2      boolea  json-format   <span class="literal">false</span>   Option to support JS  This option enables to format object outpu</span><br><span class="line">        n                             ON format of object   t with JSON when -x option selected.</span><br><span class="line">                                      output</span><br><span class="line"> 1      boolea  disable-sub-  <span class="literal">false</span>   Option to control <span class="keyword">in</span>  This option <span class="built_in">disable</span> to include sub class w</span><br><span class="line">        n       class                 clude sub class when  hen matching class.</span><br><span class="line">                                       class matching</span><br><span class="line"> 1      boolea  support-defa  <span class="literal">true</span>    Option to control <span class="keyword">in</span>  This option <span class="built_in">disable</span> to include default met</span><br><span class="line">        n       ult-method            clude default method  hod <span class="keyword">in</span> interface when matching class.</span><br><span class="line">                                       <span class="keyword">in</span> interface when c</span><br><span class="line">                                      lass matching</span><br><span class="line"> 1      boolea  save-result   <span class="literal">false</span>   Option to <span class="built_in">print</span> comm  This option enables to save each <span class="built_in">command</span><span class="string">&#x27;s</span></span><br><span class="line"><span class="string">        n                             and&#x27;</span>s result to <span class="built_in">log</span>    result to <span class="built_in">log</span> file, <span class="built_in">which</span> path is <span class="variable">$&#123;user.</span></span><br><span class="line"><span class="variable">                                      file                  home&#125;</span>/logs/arthas-cache/result.log.</span><br><span class="line"> 2      String  job-timeout   1d      Option to job timeou  This option setting job timeout,The unit c</span><br><span class="line">                                      t                     an be d, h, m, s <span class="keyword">for</span> day, hour, minute, se</span><br><span class="line">                                                            cond. 1d is one day <span class="keyword">in</span> default</span><br><span class="line"> 1      boolea  print-parent  <span class="literal">true</span>    Option to <span class="built_in">print</span> all   This option enables <span class="built_in">print</span> files <span class="keyword">in</span> parent</span><br><span class="line">        n       -fields               fileds <span class="keyword">in</span> parent cla  class, default value <span class="literal">true</span>.</span><br><span class="line">                                      ss</span><br><span class="line"> 1      boolea  verbose       <span class="literal">false</span>   Option to <span class="built_in">print</span> verb  This option enables <span class="built_in">print</span> verbose informat</span><br><span class="line">        n                             ose information       ion, default value <span class="literal">false</span>.</span><br><span class="line"> 1      boolea  strict        <span class="literal">true</span>    Option to strict mod  By default, strict mode is <span class="literal">true</span>, not allow</span><br><span class="line">        n                             e                     ed to <span class="built_in">set</span> object properties. Want to <span class="built_in">set</span> o</span><br><span class="line">                                                            bject properties, execute `options strict</span><br><span class="line">                                                            <span class="literal">false</span>`</span><br></pre></td></tr></table></figure>

<h2 id="参数说明-1"><a href="#参数说明-1" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th>名称</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>unsafe</td>
<td>false</td>
<td>是否支持对系统级别的类进行增强，打开该开关可能导致把 JVM 搞挂，请慎重选择！</td>
</tr>
<tr>
<td>dump</td>
<td>false</td>
<td>是否支持被增强了的类 dump 到外部文件中，如果打开开关，class 文件会被 dump 到<code>/$&#123;application working dir&#125;/arthas-class-dump/</code>目录下，具体位置详见控制台输出</td>
</tr>
<tr>
<td>batch-re-transform</td>
<td>true</td>
<td>是否支持批量对匹配到的类执行 retransform 操作</td>
</tr>
<tr>
<td>json-format</td>
<td>false</td>
<td>是否支持 json 化的输出</td>
</tr>
<tr>
<td>disable-sub-class</td>
<td>false</td>
<td>是否禁用子类匹配，默认在匹配目标类的时候会默认匹配到其子类，如果想精确匹配，可以关闭此开关</td>
</tr>
<tr>
<td>support-default-method</td>
<td>true</td>
<td>是否支持匹配到 default method， 默认会查找 interface，匹配里面的 default method。参考 <a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/1105">#1105在新窗口打开</a></td>
</tr>
<tr>
<td>save-result</td>
<td>false</td>
<td>是否打开执行结果存日志功能，打开之后所有命令的运行结果都将保存到<code>~/logs/arthas-cache/result.log</code>中</td>
</tr>
<tr>
<td>job-timeout</td>
<td>1d</td>
<td>异步后台任务的默认超时时间，超过这个时间，任务自动停止；比如设置 1d, 2h, 3m, 25s，分别代表天、小时、分、秒</td>
</tr>
<tr>
<td>print-parent-fields</td>
<td>true</td>
<td>是否打印在 parent class 里的 filed</td>
</tr>
<tr>
<td>verbose</td>
<td>false</td>
<td>是否打印更多详细信息</td>
</tr>
<tr>
<td>strict</td>
<td>true</td>
<td>是否启用 strict 模式</td>
</tr>
</tbody></table>
<h2 id="获取单个option-的值"><a href="#获取单个option-的值" class="headerlink" title="获取单个option 的值"></a>获取单个option 的值</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ options json-format</span><br><span class="line"> LEVEL  TYPE  NAME         VALUE  SUMMARY             DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------------------</span><br><span class="line"> 2      bool  json-format  false  Option to support   This option enables to format object</span><br><span class="line">        ean                       JSON format of obj  output with JSON when -x option selec</span><br><span class="line">                                  ect output          ted.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<div class="note info no-icon"><p>提示</p>
<p>默认情况下 json-format 为 false，如果希望 watch / tt 等命令结果以 json 格式输出，则可以设置 json-format 为 true。</p>
</div>

<h2 id="设置指定的-option"><a href="#设置指定的-option" class="headerlink" title="设置指定的 option"></a>设置指定的 option</h2><p>例如，想打开执行结果存日志功能，输入如下命令即可：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ options save-result true</span><br><span class="line"> NAME         BEFORE-VALUE  AFTER-VALUE</span><br><span class="line">----------------------------------------</span><br><span class="line"> save-result  false         true</span><br></pre></td></tr></table></figure>

<h2 id="允许增强-JDK-的类"><a href="#允许增强-JDK-的类" class="headerlink" title="允许增强 JDK 的类"></a>允许增强 JDK 的类</h2><p>默认情况下<code>unsafe</code> 为 false，即 watch/trace 等命令不会增强 JVM 的类，即<code>java.*</code> 下面的类。</p>
<p>如果想增强 JVM 里的类，可以执行 <code>options unsafe true</code> ，设置<code>unsafe</code> 为 true。</p>
<h2 id="以-JSON-格式打印对象"><a href="#以-JSON-格式打印对象" class="headerlink" title="以 JSON 格式打印对象"></a>以 JSON 格式打印对象</h2><p><code>options json-format</code> 可以看到当前的 <code>json-format</code> 为 false<br>运行 <code>ognl &#39;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#39;</code> 得到的结果并不是 JSON 格式</p>
<p>如果希望输出 JSON 格式，可以使用 <code>options json-format true</code> 开启，开启后再运行 <code>ognl &#39;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#39;</code> 这是可以看到输出的格式已经转变为 JSON 格式。</p>
<hr>
<h1 id="案例：排查函数调用异常"><a href="#案例：排查函数调用异常" class="headerlink" title="案例：排查函数调用异常"></a>案例：排查函数调用异常</h1><h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>目前，访问 <code>/user/0</code> ，会返回 500 异常：</p>
<p>但请求的具体参数，异常栈是什么呢？</p>
<h2 id="查看-UserController-的-参数-异常"><a href="#查看-UserController-的-参数-异常" class="headerlink" title="查看 UserController 的 参数/异常"></a>查看 UserController 的 参数/异常</h2><p>在 Arthas 里执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch com.example.demo.arthas.user.UserController * &#39;&#123;params, throwExp&#125;&#39;</span><br></pre></td></tr></table></figure>

<ol>
<li>第一个参数是类名，支持通配</li>
<li>第二个参数是函数名，支持通配</li>
</ol>
<p>访问 <code>/user/0</code>,<code>watch</code> 命令会打印调用的参数和异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[arthas@5728]$ watch  com.example.demo.arthas.user.UserController  * &#39;&#123;params, throwExp&#125;&#39;</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 2) cost in 172 ms, listenerId: 1</span><br><span class="line">method&#x3D;com.example.demo.arthas.user.UserController.findUserById location&#x3D;AtExceptionExit</span><br><span class="line">ts&#x3D;2024-01-05 16:31:06; [cost&#x3D;6.6047ms] result&#x3D;@ArrayList[</span><br><span class="line">    @Object[][isEmpty&#x3D;false;size&#x3D;1],</span><br><span class="line">    @IllegalArgumentException[java.lang.IllegalArgumentException: id &lt; 1],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>可以看到实际抛出的异常是<code>IllegalArgumentException</code> 。</p>
<p>可以输入 <code>Q</code> 或者 <code>Ctrl+C</code> 退出 watch 命令。</p>
<p>如果想把获取到的结果展开，可以用<code>-x</code> 参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[arthas@6392]$ watch  com.example.demo.arthas.user.UserController  * &#39;&#123;params, throwExp&#125;&#39; -x 2</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 2) cost in 119 ms, listenerId: 1</span><br><span class="line">method&#x3D;com.example.demo.arthas.user.UserController.findUserById location&#x3D;AtExceptionExit</span><br><span class="line">ts&#x3D;2024-01-05 16:38:32; [cost&#x3D;6.8937ms] result&#x3D;@ArrayList[</span><br><span class="line">    @Object[][</span><br><span class="line">        @Integer[0],</span><br><span class="line">    ],</span><br><span class="line">    java.lang.IllegalArgumentException: id &lt; 1</span><br><span class="line">        at com.example.demo.arthas.user.UserController.findUserById(UserController.java:19)</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)</span><br><span class="line">        at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)</span><br><span class="line">        at java.lang.reflect.Method.invoke(Unknown Source)</span><br><span class="line">        at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:205)</span><br><span class="line">        at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:133)</span><br><span class="line">        at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:97)</span><br><span class="line">        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:827)</span><br><span class="line">        at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:738)</span><br><span class="line">        at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:85)</span><br><span class="line">        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:967)</span><br><span class="line">        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:901)</span><br><span class="line">        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:970)</span><br><span class="line">        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:861)</span><br><span class="line">        at javax.servlet.http.HttpServlet.service(HttpServlet.java:635)</span><br><span class="line">        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:846)</span><br><span class="line">        at javax.servlet.http.HttpServlet.service(HttpServlet.java:742)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        ......</span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>

<h2 id="返回值表达式"><a href="#返回值表达式" class="headerlink" title="返回值表达式"></a>返回值表达式</h2><p>在上面的例子里，第三个参数是<code>返回值表达式</code> ，它实际上是一个<code>ognl</code> 表达式，它支持一些内置对象：</p>
<ul>
<li><code>loader</code></li>
<li><code>clazz</code></li>
<li><code>method</code></li>
<li><code>target</code></li>
<li><code>params</code></li>
<li><code>returnObj</code></li>
<li><code>throwExp</code></li>
<li><code>isBefore</code></li>
<li><code>isThrow</code></li>
<li><code>isReturn</code></li>
</ul>
<p>你可以利用这些内置对象来组成不同的表达式。比如返回一个数组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch com.example.demo.arthas.user.UserController * &#39;&#123;params[0], target, returnObj&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>更多参考：<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/advice-class.html">https://arthas.aliyun.com/doc/advice-class.html</a></p>
<h2 id="条件表达式"><a href="#条件表达式" class="headerlink" title="条件表达式"></a>条件表达式</h2><p><code>watch</code> 命令支持在第 4 个参数里写条件表达式，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch com.example.demo.arthas.user.UserController * returnObj &#39;params[0] &gt; 100&#39;</span><br></pre></td></tr></table></figure>

<p>当访问 <code>/user/1</code> 时，<code>watch</code> 命令没有输出</p>
<p>当访问 <code>/user/101</code> 时，<code>watch</code> 会打印出结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[arthas@6392]$ watch com.example.demo.arthas.user.UserController  * returnObj &#39;params[0]&gt;100&#39;</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 2) cost in 31 ms, listenerId: 2</span><br><span class="line">method&#x3D;com.example.demo.arthas.user.UserController.findUserById location&#x3D;AtExit</span><br><span class="line">ts&#x3D;2024-01-05 16:46:59; [cost&#x3D;0.5729ms] result&#x3D;@User[</span><br><span class="line">    id&#x3D;@Integer[101],</span><br><span class="line">    name&#x3D;@String[name101],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="当异常时捕获"><a href="#当异常时捕获" class="headerlink" title="当异常时捕获"></a>当异常时捕获</h2><p><code>watch</code> 命令支持<code>-e</code> 选项，表示只捕获抛出异常时的请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch com.example.demo.arthas.user.UserController * &quot;&#123;params[0],throwExp&#125;&quot; -e</span><br></pre></td></tr></table></figure>

<p>当访问<code>/user/0</code>时，<code>watch</code>会打印异常信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[arthas@6392]$ watch com.example.demo.arthas.user.UserController * &quot;&#123;params[0],throwExp&#125;&quot; -e</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 2) cost in 38 ms, listenerId: 6</span><br><span class="line">method&#x3D;com.example.demo.arthas.user.UserController.findUserById location&#x3D;AtExceptionExit</span><br><span class="line">ts&#x3D;2024-01-05 16:57:40; [cost&#x3D;1.197ms] result&#x3D;@ArrayList[</span><br><span class="line">    @Integer[0],</span><br><span class="line">    @IllegalArgumentException[java.lang.IllegalArgumentException: id &lt; 1],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="按照耗时进行过滤"><a href="#按照耗时进行过滤" class="headerlink" title="按照耗时进行过滤"></a>按照耗时进行过滤</h2><p>watch 命令支持按请求耗时进行过滤，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch com.example.demo.arthas.user.UserController * &#39;&#123;params, returnObj&#125;&#39; &#39;#cost&gt;200&#39;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="案例：热更新代码"><a href="#案例：热更新代码" class="headerlink" title="案例：热更新代码"></a>案例：热更新代码</h1><p>下面介绍通过<code>jad</code> /<code>mc</code> /<code>redefine</code> 命令实现动态更新代码的功能。</p>
<p>目前，访问 <code>/user/0</code> ，会返回 500 异常：</p>
<p>下面通过热更新代码，修改这个逻辑。</p>
<h2 id="jad-反编译-UserController"><a href="#jad-反编译-UserController" class="headerlink" title="jad 反编译 UserController"></a>jad 反编译 UserController</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jad --source-only com.example.demo.arthas.user.UserController &gt; &#x2F;tmp&#x2F;UserController.java</span><br></pre></td></tr></table></figure>

<p>jad 反编译的结果保存在 <code>/tmp/UserController.java</code> 文件里了。</p>
<p>再打开一个终端于 <code>Tab 3</code> ，然后在 <code>Tab3</code> 里用 <code>sed</code> 来编辑<code>/tmp/UserController.java</code> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#39;s&#x2F;throw new IllegalArgumentException(&quot;id &lt; 1&quot;)&#x2F;return new User(id, &quot;name&quot; + id)&#x2F;g&#39; &#x2F;tmp&#x2F;UserController.java</span><br></pre></td></tr></table></figure>

<p>使用 <code>cat</code> 命令查看修改后的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;tmp&#x2F;UserController.java</span><br></pre></td></tr></table></figure>

<p>比如当 user id 小于 1 时，也正常返回，不抛出异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@GetMapping(value=&#123;&quot;/user/&#123;id&#125;&quot;&#125;)</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> </span>&#123;</span><br><span class="line">     logger.info(<span class="string">&quot;id: &#123;&#125;&quot;</span>, (Object)id);</span><br><span class="line">     <span class="keyword">if</span> (id != <span class="keyword">null</span> &amp;&amp; id &lt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> User(id, <span class="string">&quot;name&quot;</span> + id);</span><br><span class="line">         <span class="comment">// throw new IllegalArgumentException(&quot;id &lt; 1&quot;);</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> User(id.intValue(), <span class="string">&quot;name&quot;</span> + id);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>mc</code> (Memory Compiler) 命令来编译加载 UserController， 可以通过 -c 指定 classLoaderHash 或者 –classLoaderClass 参数指定 ClassLoader，这里为了操作连贯性使用 classLoaderClass。</p>
<h2 id="查询-UserController-类加载器"><a href="#查询-UserController-类加载器" class="headerlink" title="查询 UserController 类加载器"></a>查询 UserController 类加载器</h2><h3 id="sc-查找加载-UserController-的-ClassLoader"><a href="#sc-查找加载-UserController-的-ClassLoader" class="headerlink" title="sc 查找加载 UserController 的 ClassLoader"></a>sc 查找加载 UserController 的 ClassLoader</h3><p>回到 <code>Tab 2</code> 里运行 <code>sc -d *UserController | grep classLoaderHash</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@6392]$ sc -d *UserController | grep classLoaderHash</span><br><span class="line"> classLoaderHash   38af3868</span><br></pre></td></tr></table></figure>

<h3 id="classloader-查询类加载器名称"><a href="#classloader-查询类加载器名称" class="headerlink" title="classloader 查询类加载器名称"></a>classloader 查询类加载器名称</h3><p><code>classloader -l</code> 查询所有的类加载器列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[arthas@6392]$ classloader  -l</span><br><span class="line"> name                                                             loadedCount  hash      parent</span><br><span class="line"> BootstrapClassLoader                                             3221         null      null</span><br><span class="line"> com.taobao.arthas.agent.ArthasClassloader@384abb78               2630         384abb78  sun.misc.Launcher$ExtClassLoade</span><br><span class="line">                                                                                         r@a09ee92</span><br><span class="line"> org.springframework.boot.loader.LaunchedURLClassLoader@38af3868  4591         38af3868  sun.misc.Launcher$AppClassLoade</span><br><span class="line">                                                                                         r@5c647e05</span><br><span class="line"> sun.misc.Launcher$AppClassLoader@5c647e05                        45           5c647e05  sun.misc.Launcher$ExtClassLoade</span><br><span class="line">                                                                                         r@a09ee92</span><br><span class="line"> sun.misc.Launcher$ExtClassLoader@a09ee92                         19           a09ee92   null</span><br><span class="line">Affect(row-cnt:5) cost in 7 ms.</span><br></pre></td></tr></table></figure>

<p><code>UserController classLoaderHash</code> 值对应的类加载器为 <code>org.springframework.boot.loader.LaunchedURLClassLoader</code></p>
<h3 id="mc-编译加载-UserController"><a href="#mc-编译加载-UserController" class="headerlink" title="mc 编译加载 UserController"></a>mc 编译加载 UserController</h3><p>保存到 <code>/tmp/UserController.java</code> 之后可以使用 mc (Memory Compiler) 命令来编译</p>
<h3 id="mc-指定-classloader-编译-UserController"><a href="#mc-指定-classloader-编译-UserController" class="headerlink" title="mc 指定 classloader 编译 UserController"></a>mc 指定 classloader 编译 UserController</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ mc -c 33c7353a &#x2F;tmp&#x2F;UserController.java  -d &#x2F;tmp&#x2F;</span><br><span class="line">Memory compiler output:</span><br><span class="line">D:\tmp\com\example\demo\arthas\user\UserController.class</span><br><span class="line">Affect(row-cnt:1) cost in 4442 ms.</span><br></pre></td></tr></table></figure>

<h3 id="redefine"><a href="#redefine" class="headerlink" title="redefine"></a>redefine</h3><p>再使用<code>redefine</code> 命令重新加载新编译好的<code>UserController.class</code> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ redefine &#x2F;tmp&#x2F;com&#x2F;example&#x2F;demo&#x2F;arthas&#x2F;user&#x2F;UserController.class</span><br><span class="line">redefine success, size: 1, classes:</span><br><span class="line">com.example.demo.arthas.user.UserController</span><br></pre></td></tr></table></figure>

<h3 id="热修改代码结果"><a href="#热修改代码结果" class="headerlink" title="热修改代码结果"></a>热修改代码结果</h3><p><code>redefine</code> 成功之后，再次访问 <code>/user/0</code>，结果是：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;name0&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="案例：Arthas-后台异步任务"><a href="#案例：Arthas-后台异步任务" class="headerlink" title="案例：Arthas 后台异步任务"></a>案例：Arthas 后台异步任务</h1><p>arthas 中的后台异步任务，使用了仿 linux 系统任务相关的命令。</p>
<h2 id="使用-amp-在后台执行任务，任务输出重定向"><a href="#使用-amp-在后台执行任务，任务输出重定向" class="headerlink" title="使用 &amp; 在后台执行任务，任务输出重定向"></a>使用 &amp; 在后台执行任务，任务输出重定向</h2><p>可通过 <code>&gt;</code> 或者 <code>&gt;&gt;</code> 将任务输出结果输出到指定的文件中，可以和 <code>&amp;</code> 一起使用，实现 arthas 命令的后台异步任务。</p>
<p>当前我们需要排查一个问题，但是这个问题的出现时间不能确定，那我们就可以把检测命令挂在后台运行，并将保存到输出日志，如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch com.example.demo.arthas.user.UserController * &#39;&#123;params, throwExp&#125;&#39; &#39;throwExp !&#x3D; null&#39; &gt;&gt; a.log &amp;</span><br></pre></td></tr></table></figure>

<p>这时命令在后台执行，可以在 console 中继续执行其他命令。</p>
<p>之后我们去访问：<code>/user/0</code></p>
<p>然后使用 <code>cat a.log</code> 可以看到我们刚刚访问的 URL 抛出了一个异常</p>
<h2 id="通过-jobs-查看任务"><a href="#通过-jobs-查看任务" class="headerlink" title="通过 jobs 查看任务"></a>通过 jobs 查看任务</h2><p>如果希望查看当前有哪些 arthas 任务在执行，可以执行 jobs 命令，执行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ jobs</span><br><span class="line">[4]*</span><br><span class="line">       Running           watch com.example.demo.arthas.user.UserController * &#39;&#123;params, throwExp !&#x3D; null&#125;&#39; &gt;&gt; a.log &amp;</span><br><span class="line">       execution count : 1</span><br><span class="line">       start time      : Sat Jan 06 09:36:28 CST 2024</span><br><span class="line">       timeout date    : Sun Jan 07 09:36:28 CST 2024</span><br><span class="line">       session         : 4251ad90-2951-4d33-8da1-2d241a3e0a0f (current)</span><br></pre></td></tr></table></figure>

<p>可以看到目前有一个后台任务在执行</p>
<p>job id 是 4, <code>*</code> 表示此 job 是当前 session 创建（生命周期默认为一天）</p>
<p>状态是 <code>Running</code></p>
<p><code>execution count</code> 是执行次数，从启动开始已经执行了 1 次</p>
<p><code>timeout date</code> 是超时的时间，到这个时间，任务将会自动超时退出。</p>
<h2 id="停止命令、切换前后台"><a href="#停止命令、切换前后台" class="headerlink" title="停止命令、切换前后台"></a>停止命令、切换前后台</h2><p>异步执行的命令，如果希望停止，可执行 <code>kill</code>, 希望命令转到前台、后台继续执行 fg、bg 命令。</p>
<p><code>kill</code>掉job id 是 4 的任务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ kill 4</span><br><span class="line">kill job 4 success</span><br><span class="line">[arthas@3880]$ jobs</span><br></pre></td></tr></table></figure>

<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>最多同时支持 8 个命令使用重定向将结果写日志</li>
<li>请勿同时开启过多的后台异步命令，以免对目标 JVM 性能造成影响</li>
<li>如果不想停止 arthas，继续执行后台任务，可以执行 <code>quit</code> 退出 arthas 控制台（<code>stop</code> 会停止 arthas 服务）</li>
</ul>
<hr>
<h1 id="案例：动态更新应用-Logger-Level"><a href="#案例：动态更新应用-Logger-Level" class="headerlink" title="案例：动态更新应用 Logger Level"></a>案例：动态更新应用 Logger Level</h1><p>在这个案例里，动态修改应用的 Logger Level。</p>
<h2 id="使用-sc-查找-UserController-的-ClassLoader"><a href="#使用-sc-查找-UserController-的-ClassLoader" class="headerlink" title="使用 sc 查找 UserController 的 ClassLoader"></a>使用 sc 查找 UserController 的 ClassLoader</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc -d com.example.demo.arthas.user.UserController | grep classLoaderHash</span><br></pre></td></tr></table></figure>

<p>注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，提取对应 ClassLoader 的 hashcode。<br>如果你使用<code>-c</code> ，你需要手动输入 hashcode：<code>-c &lt;hashcode&gt;</code><br>对于只有唯一实例的 ClassLoader 可以通过<code>--classLoaderClass</code> 指定 class name，使用起来更加方便：<br><code>--classLoaderClass</code> 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code> 是动态变化的。</p>
<h2 id="使用-ognl"><a href="#使用-ognl" class="headerlink" title="使用 ognl"></a>使用 ognl</h2><h3 id="用-ognl-获取-logger"><a href="#用-ognl-获取-logger" class="headerlink" title="用 ognl 获取 logger"></a>用 ognl 获取 logger</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@com.example.demo.arthas.user.UserController@logger&#39;</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID&#x3D;@Long[5454405123156820674],</span><br><span class="line">    FQCN&#x3D;@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name&#x3D;@String[com.example.demo.arthas.user.UserController],</span><br><span class="line">    level&#x3D;null,</span><br><span class="line">    effectiveLevelInt&#x3D;@Integer[20000],</span><br><span class="line">    parent&#x3D;@Logger[Logger[com.example.demo.arthas.user]],</span><br><span class="line">    childrenList&#x3D;null,</span><br><span class="line">    aai&#x3D;null,</span><br><span class="line">    additive&#x3D;@Boolean[true],</span><br><span class="line">    loggerContext&#x3D;@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>可以知道 <code>UserController@logger</code> 实际使用的是 logback。可以看到 <code>level=null</code> ，则说明实际最终的 level 是从 <code>root logger </code>里来的。</p>
<p>查看<code>root logger </code>的<code>Lever</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@org.slf4j.LoggerFactory@getLogger(&quot;root&quot;)&#39;</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID&#x3D;@Long[5454405123156820674],</span><br><span class="line">    FQCN&#x3D;@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name&#x3D;@String[ROOT],</span><br><span class="line">    level&#x3D;@Level[INFO],</span><br><span class="line">    effectiveLevelInt&#x3D;@Integer[20000],</span><br><span class="line">    parent&#x3D;null,</span><br><span class="line">    childrenList&#x3D;@CopyOnWriteArrayList[isEmpty&#x3D;false;size&#x3D;3],</span><br><span class="line">    aai&#x3D;@AppenderAttachableImpl[ch.qos.logback.core.spi.AppenderAttachableImpl@452a4e77],</span><br><span class="line">    additive&#x3D;@Boolean[true],</span><br><span class="line">    loggerContext&#x3D;@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="单独设置-UserController-的-logger-level"><a href="#单独设置-UserController-的-logger-level" class="headerlink" title="单独设置 UserController 的 logger level"></a>单独设置 UserController 的 logger level</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@com.example.demo.arthas.user.UserController@logger.setLevel(@ch.qos.logback.classic.Level@DEBUG)&#39;</span><br><span class="line">null</span><br></pre></td></tr></table></figure>

<p>再次获取 <code>UserController@logger</code> ，可以发现已经是 <code>DEBUG</code> 了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@com.example.demo.arthas.user.UserController@logger&#39;</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID&#x3D;@Long[5454405123156820674],</span><br><span class="line">    FQCN&#x3D;@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name&#x3D;@String[com.example.demo.arthas.user.UserController],</span><br><span class="line">    level&#x3D;@Level[DEBUG],</span><br><span class="line">    effectiveLevelInt&#x3D;@Integer[10000],</span><br><span class="line">    parent&#x3D;@Logger[Logger[com.example.demo.arthas.user]],</span><br><span class="line">    childrenList&#x3D;null,</span><br><span class="line">    aai&#x3D;null,</span><br><span class="line">    additive&#x3D;@Boolean[true],</span><br><span class="line">    loggerContext&#x3D;@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="修改-logback-的全局-logger-level"><a href="#修改-logback-的全局-logger-level" class="headerlink" title="修改 logback 的全局 logger level"></a>修改 logback 的全局 logger level</h3><p>通过获取 <code>root</code> logger，可以修改全局的 logger level：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@org.slf4j.LoggerFactory@getLogger(&quot;root&quot;).setLevel(@ch.qos.logback.classic.Level@DEBUG)&#39;</span><br><span class="line">null</span><br></pre></td></tr></table></figure>

<p>运行下面命令可以看到 <code>ROOT</code> 的 level 已经修改为了 <code>DEBUG</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@org.slf4j.LoggerFactory@getLogger(&quot;root&quot;)&#39;</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID&#x3D;@Long[5454405123156820674],</span><br><span class="line">    FQCN&#x3D;@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name&#x3D;@String[ROOT],</span><br><span class="line">    level&#x3D;@Level[DEBUG],</span><br><span class="line">    effectiveLevelInt&#x3D;@Integer[10000],</span><br><span class="line">    parent&#x3D;null,</span><br><span class="line">    childrenList&#x3D;@CopyOnWriteArrayList[isEmpty&#x3D;false;size&#x3D;3],</span><br><span class="line">    aai&#x3D;@AppenderAttachableImpl[ch.qos.logback.core.spi.AppenderAttachableImpl@452a4e77],</span><br><span class="line">    additive&#x3D;@Boolean[true],</span><br><span class="line">    loggerContext&#x3D;@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="使用-logger"><a href="#使用-logger" class="headerlink" title="使用 logger"></a>使用 logger</h2><p>使用 <code>logger</code> 命令可以相较于 <code>ognl</code> 更加便捷的实现 logger level 的动态设置。</p>
<h3 id="使用-logger-命令获取对应-logger-信息"><a href="#使用-logger-命令获取对应-logger-信息" class="headerlink" title="使用 logger 命令获取对应 logger 信息"></a>使用 logger 命令获取对应 logger 信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ logger --name  com.example.demo.arthas.user.UserController</span><br><span class="line"> name                                      com.example.demo.arthas.user.UserController</span><br><span class="line"> class                                     ch.qos.logback.classic.Logger</span><br><span class="line"> classLoader                               org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a</span><br><span class="line"> classLoaderHash                           33c7353a</span><br><span class="line"> level                                     DEBUG</span><br><span class="line"> effectiveLevel                            DEBUG</span><br><span class="line"> additivity                                true</span><br><span class="line"> codeSource                                jar:file:&#x2F;D:&#x2F;arthas&#x2F;arthas-packaging-3.7.1-bin&#x2F;demo-arthas-spring-boot.jar!&#x2F;BOOT-INF&#x2F;lib&#x2F;logback-classic-1.1.11.jar!&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="单独设置-UserController-的-logger-level-1"><a href="#单独设置-UserController-的-logger-level-1" class="headerlink" title="单独设置 UserController 的 logger level"></a>单独设置 UserController 的 logger level</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ logger --name com.example.demo.arthas.user.UserController --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --level WARN</span><br><span class="line">Update logger level success.</span><br></pre></td></tr></table></figure>

<p>再次获取对应 <code>logger</code> 信息，可以发现已经是 <code>WARN</code> 了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ logger --name com.example.demo.arthas.user.UserController</span><br><span class="line"> name                                      com.example.demo.arthas.user.UserController</span><br><span class="line"> class                                     ch.qos.logback.classic.Logger</span><br><span class="line"> classLoader                               org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a</span><br><span class="line"> classLoaderHash                           33c7353a</span><br><span class="line"> level                                     WARN</span><br><span class="line"> effectiveLevel                            WARN</span><br><span class="line"> additivity                                true</span><br><span class="line"> codeSource                                jar:file:&#x2F;D:&#x2F;arthas&#x2F;arthas-packaging-3.7.1-bin&#x2F;demo-arthas-spring-boot.jar!&#x2F;BOOT-INF&#x2F;lib&#x2F;logback-classic-1.1.11.jar!&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="修改-logback-的全局-logger-level-1"><a href="#修改-logback-的全局-logger-level-1" class="headerlink" title="修改 logback 的全局 logger level"></a>修改 logback 的全局 logger level</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ logger --name ROOT --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --level ERROR</span><br><span class="line">Update logger level success.</span><br></pre></td></tr></table></figure>

<p>运行下面命令可以看到 <code>ROOT</code> 的 level 已经修改为了 <code>ERROR</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ logger  --name ROOT --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader</span><br><span class="line"> name                                      ROOT</span><br><span class="line"> class                                     ch.qos.logback.classic.Logger</span><br><span class="line"> classLoader                               org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a</span><br><span class="line"> classLoaderHash                           33c7353a</span><br><span class="line"> level                                     ERROR</span><br><span class="line"> effectiveLevel                            ERROR</span><br><span class="line"> additivity                                true</span><br><span class="line"> codeSource                                jar:file:&#x2F;D:&#x2F;arthas&#x2F;arthas-packaging-3.7.1-bin&#x2F;demo-arthas-spring-boot.jar!&#x2F;BOOT-INF&#x2F;lib&#x2F;logback-classic-1.1.11.jar!&#x2F;</span><br><span class="line"> appenders                                 name            CONSOLE</span><br><span class="line">                                           class           ch.qos.logback.core.ConsoleAppender</span><br><span class="line">                                           classLoader     org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a</span><br><span class="line">                                           classLoaderHash 33c7353a</span><br><span class="line">                                           target          System.out</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="案例：排查-logger-冲突问题"><a href="#案例：排查-logger-冲突问题" class="headerlink" title="案例：排查 logger 冲突问题"></a>案例：排查 logger 冲突问题</h1><p>在这个案例里，展示排查 logger 冲突的方法。</p>
<h2 id="查找-UserController-的-ClassLoader-1"><a href="#查找-UserController-的-ClassLoader-1" class="headerlink" title="查找 UserController 的 ClassLoader"></a>查找 UserController 的 ClassLoader</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc -d com.example.demo.arthas.user.UserController | grep classLoaderHash</span><br></pre></td></tr></table></figure>

<p>注意 hashcode 是变化的，需要先查看当前的 ClassLoader 信息，提取对应 ClassLoader 的 hashcode。<br>如果你使用<code>-c</code> ，你需要手动输入 hashcode：<code>-c &lt;hashcode&gt;</code><br>对于只有唯一实例的 ClassLoader 可以通过<code>--classLoaderClass</code> 指定 class name，使用起来更加方便：<br><code>--classLoaderClass</code> 的值是 ClassLoader 的类名，只有匹配到唯一的 ClassLoader 实例时才能工作，目的是方便输入通用命令，而<code>-c &lt;hashcode&gt;</code> 是动态变化的。</p>
<h2 id="确认应用使用的-logger-系统"><a href="#确认应用使用的-logger-系统" class="headerlink" title="确认应用使用的 logger 系统"></a>确认应用使用的 logger 系统</h2><p>以 <code>UserController</code> 为例，它使用的是 slf4j api，但实际使用到的 logger 系统是 logback。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader &#39;@com.example.demo.arthas.user.UserController@logger&#39;</span><br><span class="line">@Logger[</span><br><span class="line">    serialVersionUID&#x3D;@Long[5454405123156820674],</span><br><span class="line">    FQCN&#x3D;@String[ch.qos.logback.classic.Logger],</span><br><span class="line">    name&#x3D;@String[com.example.demo.arthas.user.UserController],</span><br><span class="line">    level&#x3D;@Level[INFO],</span><br><span class="line">    effectiveLevelInt&#x3D;@Integer[20000],</span><br><span class="line">    parent&#x3D;@Logger[Logger[com.example.demo.arthas.user]],</span><br><span class="line">    childrenList&#x3D;null,</span><br><span class="line">    aai&#x3D;null,</span><br><span class="line">    additive&#x3D;@Boolean[true],</span><br><span class="line">    loggerContext&#x3D;@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="获取-logback-实际加载的配置文件"><a href="#获取-logback-实际加载的配置文件" class="headerlink" title="获取 logback 实际加载的配置文件"></a>获取 logback 实际加载的配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ ognl --classLoaderClass  org.springframework.boot.loader.LaunchedURLClassLoader  &#39;#map1&#x3D;@org.slf4j.LoggerFactory@getLogger(&quot;root&quot;).loggerContext.objectMap, #map1.get(&quot;CONFIGURATION_WATCH_LIST&quot;)&#39;</span><br><span class="line">@ConfigurationWatchList[</span><br><span class="line">    mainURL&#x3D;@URL[jar:file:&#x2F;D:&#x2F;arthas&#x2F;arthas-packaging-3.7.1-bin&#x2F;demo-arthas-spring-boot.jar!&#x2F;BOOT-INF&#x2F;classes!&#x2F;logback-spring.xml],</span><br><span class="line">    fileWatchList&#x3D;@ArrayList[isEmpty&#x3D;true;size&#x3D;0],</span><br><span class="line">    lastModifiedList&#x3D;@ArrayList[isEmpty&#x3D;true;size&#x3D;0],</span><br><span class="line">    noContextWarning&#x3D;@Integer[0],</span><br><span class="line">    context&#x3D;@LoggerContext[ch.qos.logback.classic.LoggerContext[default]],</span><br><span class="line">    declaredOrigin&#x3D;@ConfigurationWatchList[ch.qos.logback.core.joran.spi.ConfigurationWatchList@5149876],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="使用classloader-命令查找可能存在的-logger-配置文件"><a href="#使用classloader-命令查找可能存在的-logger-配置文件" class="headerlink" title="使用classloader 命令查找可能存在的 logger 配置文件"></a>使用classloader 命令查找可能存在的 logger 配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ classloader --classLoaderClass  org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</span><br><span class="line"> jar:file:&#x2F;D:&#x2F;arthas&#x2F;arthas-packaging-3.7.1-bin&#x2F;demo-arthas-spring-boot.jar!&#x2F;BOOT-INF&#x2F;classes!&#x2F;logback-spring.xml</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost in 1 ms.</span><br></pre></td></tr></table></figure>

<p>可以知道加载的配置的具体来源。</p>
<p>可以尝试加载容易冲突的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback.xml</span><br><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r log4j.properties</span><br></pre></td></tr></table></figure>

<h1 id="案例：获取-Spring-Context"><a href="#案例：获取-Spring-Context" class="headerlink" title="案例：获取 Spring Context"></a>案例：获取 Spring Context</h1><p>在这个案例里，展示获取 spring context，再获取 bean，然后调用函数。</p>
<h2 id="使用-tt-命令获取到-spring-context"><a href="#使用-tt-命令获取到-spring-context" class="headerlink" title="使用 tt 命令获取到 spring context"></a>使用 tt 命令获取到 spring context</h2><p><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/tt.html">tt</a> 即 TimeTunnel，它可以记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tt -t org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter invokeHandlerMethod</span><br></pre></td></tr></table></figure>

<p>访问：<code>/user/1</code></p>
<p>可以看到<code>tt</code> 命令捕获到了请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ tt -t  org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter invokeHandlerMethod</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 1) cost in 50 ms, listenerId: 2</span><br><span class="line"> INDEX           TIMESTAMP                              COST(ms)           IS-RET          IS-EXP         OBJECT                        CLASS                                                     METHOD</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> 1000            2024-01-06 15:47:59                    4.1345             true            false          0x369e7ab5                    RequestMappingHandlerAdapter                              invokeHandlerMethod</span><br></pre></td></tr></table></figure>

<h2 id="使用-tt-命令从调用记录里获取到-spring-context"><a href="#使用-tt-命令从调用记录里获取到-spring-context" class="headerlink" title="使用 tt 命令从调用记录里获取到 spring context"></a>使用 tt 命令从调用记录里获取到 spring context</h2><p>输入 <code>Q</code> 或者 <code>Ctrl + C</code> 退出上面的 <code>tt -t</code> 命令。<br>使用 <code>tt -l</code> 命令可以查看之前 <code>tt</code> 命令捕获到的请求信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tt -i 1000 -w &#39;target.getApplicationContext()&#39;</span><br></pre></td></tr></table></figure>

<h2 id="获取-spring-bean，并调用函数"><a href="#获取-spring-bean，并调用函数" class="headerlink" title="获取 spring bean，并调用函数"></a>获取 spring bean，并调用函数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ tt -i 1000 -w &#39;target.getApplicationContext().getBean(&quot;helloWorldService&quot;).getHelloMessage()&#39;</span><br><span class="line">@String[Hello World]</span><br><span class="line">Affect(row-cnt:1) cost in 4 ms.</span><br></pre></td></tr></table></figure>

<h2 id="Vmtool-获取-HelloWorldService-对象实例，并调用函数"><a href="#Vmtool-获取-HelloWorldService-对象实例，并调用函数" class="headerlink" title="Vmtool 获取 HelloWorldService 对象实例，并调用函数"></a>Vmtool 获取 HelloWorldService 对象实例，并调用函数</h2><p>上面的方法使用 tt 命令获取 spring bean，并调用函数，有点繁琐，更换为使用 <a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/vmtool.html">vmtool</a> 将会极大的简化这个流程，命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ vmtool --action getInstances --className com.example.demo.arthas.aop.HelloWorldService --express &#39;instances[0].getHelloMessage()&#39;</span><br><span class="line">@String[Hello World]</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="案例：排查-HTTP-请求返回-401"><a href="#案例：排查-HTTP-请求返回-401" class="headerlink" title="案例：排查 HTTP 请求返回 401"></a>案例：排查 HTTP 请求返回 401</h1><p>在这个案例里，展示排查 HTTP 401 问题的技巧。</p>
<p>访问： <code>/admin</code></p>
<p>结果是：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Something went wrong:</span> <span class="number">401</span> <span class="string">Unauthorized</span></span><br></pre></td></tr></table></figure>

<p>我们知道<code>401</code> 通常是被权限管理的<code>Filter</code> 拦截了，那么到底是哪个<code>Filter</code> 处理了这个请求，返回了 401？</p>
<h2 id="跟踪所有的-Filter-函数"><a href="#跟踪所有的-Filter-函数" class="headerlink" title="跟踪所有的 Filter 函数"></a>跟踪所有的 Filter 函数</h2><p>开始 trace：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace javax.servlet.Filter *</span><br></pre></td></tr></table></figure>

<p>访问： <code>/admin</code></p>
<p>可以在调用树的最深层，找到<code>AdminFilterConfig$AdminFilter</code> 返回了<code>401</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+---[<span class="number">3.806273</span>ms] javax.servlet.FilterChain:doFilter()</span><br><span class="line">|   <span class="string">`---[3.447472ms] com.example.demo.arthas.AdminFilterConfig$AdminFilter:doFilter()</span></span><br><span class="line"><span class="string">|       `</span>---[<span class="number">0.17259</span>ms] javax.servlet.http.HttpServletResponse:sendError()</span><br></pre></td></tr></table></figure>

<p>输入 <code>Q</code> 或者 <code>Ctrl+C</code> 退出 watch 命令。</p>
<h3 id="通过-stack-获取调用栈"><a href="#通过-stack-获取调用栈" class="headerlink" title="通过 stack 获取调用栈"></a>通过 stack 获取调用栈</h3><p>上面是通过<code>trace</code> 命令来获取信息，从结果里，我们可以知道通过<code>stack</code> 跟踪<code>HttpServletResponse:sendError()</code> ，同样可以知道是哪个<code>Filter</code> 返回了<code>401</code></p>
<p>执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stack javax.servlet.http.HttpServletResponse sendError &#39;params[0]&#x3D;&#x3D;401&#39;</span><br></pre></td></tr></table></figure>

<p>访问： <code>/admin</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ stack  javax.servlet.http.HttpServletResponse sendError &#39;params[0]&#x3D;&#x3D;401&#39;</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 3 , method count: 4) cost in 99 ms, listenerId: 4</span><br><span class="line">ts&#x3D;2024-01-06 16:33:24;thread_name&#x3D;http-nio-80-exec-3;id&#x3D;14;is_daemon&#x3D;true;priority&#x3D;5;TCCL&#x3D;org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader@54c14576</span><br><span class="line">    @org.apache.catalina.connector.Response.sendError()</span><br><span class="line">        at org.apache.catalina.connector.ResponseFacade.sendError(ResponseFacade.java:462)</span><br><span class="line">        at com.example.demo.arthas.AdminFilterConfig$AdminFilter.doFilter(AdminFilterConfig.java:38)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)</span><br><span class="line">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        at org.springframework.web.filter.HttpPutFormContentFilter.doFilterInternal(HttpPutFormContentFilter.java:109)</span><br><span class="line">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        at org.springframework.web.filter.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:81)</span><br><span class="line">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:197)</span><br><span class="line">        at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:198)</span><br><span class="line">        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)</span><br><span class="line">        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:496)</span><br><span class="line">        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:140)</span><br><span class="line">        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:81)</span><br><span class="line">        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)</span><br><span class="line">        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342)</span><br><span class="line">        at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:803)</span><br><span class="line">        at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)</span><br><span class="line">        at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:790)</span><br><span class="line">        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1468)</span><br><span class="line">        at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:748)</span><br></pre></td></tr></table></figure>

<p>输入 <code>Q</code> 或者 <code>Ctrl+C</code> 退出 watch 命令。</p>
<h1 id="案例：理解-Spring-Boot-应用的-ClassLoader-结构"><a href="#案例：理解-Spring-Boot-应用的-ClassLoader-结构" class="headerlink" title="案例：理解 Spring Boot 应用的 ClassLoader 结构"></a>案例：理解 Spring Boot 应用的 ClassLoader 结构</h1><p>下面介绍<code>classloader</code> 命令的功能。</p>
<p>先访问一个 jsp 网页，触发 jsp 的加载： <code>访问 hello 页面</code></p>
<h2 id="列出所有-ClassLoader"><a href="#列出所有-ClassLoader" class="headerlink" title="列出所有 ClassLoader"></a>列出所有 ClassLoader</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ classloader -l</span><br><span class="line"> name                                                             loadedCount  hash      parent</span><br><span class="line"> BootstrapClassLoader                                             3132         null      null</span><br><span class="line"> com.taobao.arthas.agent.ArthasClassloader@a3df247                1810         a3df247   sun.misc.Launcher$ExtClassLoader@f6f4d33</span><br><span class="line"> java.net.FactoryURLClassLoader@7b8e788f                          842          7b8e788f  sun.misc.Launcher$AppClassLoader@3d4eac69</span><br><span class="line"> org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a  4759         33c7353a  sun.misc.Launcher$AppClassLoader@3d4eac69</span><br><span class="line"> sun.misc.Launcher$AppClassLoader@3d4eac69                        45           3d4eac69  sun.misc.Launcher$ExtClassLoader@f6f4d33</span><br><span class="line"> sun.misc.Launcher$ExtClassLoader@f6f4d33                         23           f6f4d33   null</span><br><span class="line">Affect(row-cnt:6) cost in 4 ms.</span><br></pre></td></tr></table></figure>

<h2 id="统计-ClassLoader-实际使用-URL-和未使用的-URL"><a href="#统计-ClassLoader-实际使用-URL-和未使用的-URL" class="headerlink" title="统计 ClassLoader 实际使用 URL 和未使用的 URL"></a>统计 ClassLoader 实际使用 URL 和未使用的 URL</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classloader --url-stat</span><br></pre></td></tr></table></figure>

<div class="note info no-icon"><p>注意：基于 JVM 目前已加载的所有类统计，不代表 Unused URLs 可以从应用中删掉。因为可能将来需要从 Unused URLs 里加载类，或者需要加载 resources</p>
</div>

<h2 id="列出-ClassLoader-里加载的所有类"><a href="#列出-ClassLoader-里加载的所有类" class="headerlink" title="列出 ClassLoader 里加载的所有类"></a>列出 ClassLoader 里加载的所有类</h2><p>列出上面的<code>org.apache.jasper.servlet.JasperLoader</code> 加载的类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ classloader -a --classLoaderClass  org.apache.jasper.servlet.JasperLoader | grep hello</span><br><span class="line"> org.apache.jsp.jsp.hello_jsp</span><br></pre></td></tr></table></figure>

<h2 id="查看类的-classloader-层次"><a href="#查看类的-classloader-层次" class="headerlink" title="查看类的 classloader 层次"></a>查看类的 classloader 层次</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ sc -d org.apache.jsp.jsp.hello_jsp</span><br><span class="line"> class-info        org.apache.jsp.jsp.hello_jsp</span><br><span class="line"> code-source       &#x2F;C:&#x2F;Users&#x2F;pt-tianzhencai&#x2F;AppData&#x2F;Local&#x2F;Temp&#x2F;tomcat.2859845778385490372.80&#x2F;work&#x2F;Tomcat&#x2F;localhost&#x2F;ROOT&#x2F;</span><br><span class="line"> name              org.apache.jsp.jsp.hello_jsp</span><br><span class="line"> isInterface       false</span><br><span class="line"> isAnnotation      false</span><br><span class="line"> isEnum            false</span><br><span class="line"> isAnonymousClass  false</span><br><span class="line"> isArray           false</span><br><span class="line"> isLocalClass      false</span><br><span class="line"> isMemberClass     false</span><br><span class="line"> isPrimitive       false</span><br><span class="line"> isSynthetic       false</span><br><span class="line"> simple-name       hello_jsp</span><br><span class="line"> modifier          final,public</span><br><span class="line"> annotation</span><br><span class="line"> interfaces        org.apache.jasper.runtime.JspSourceDependent,org.apache.jasper.runtime.JspSourceImports</span><br><span class="line"> super-class       +-org.apache.jasper.runtime.HttpJspBase</span><br><span class="line">                     +-javax.servlet.http.HttpServlet</span><br><span class="line">                       +-javax.servlet.GenericServlet</span><br><span class="line">                         +-java.lang.Object</span><br><span class="line"> class-loader      +-org.apache.jasper.servlet.JasperLoader@4bc4fe20</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                       +-org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a</span><br><span class="line">                         +-sun.misc.Launcher$AppClassLoader@3d4eac69</span><br><span class="line">                           +-sun.misc.Launcher$ExtClassLoader@f6f4d33</span><br><span class="line"> classLoaderHash   4bc4fe20</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost in 7 ms.</span><br></pre></td></tr></table></figure>

<h2 id="查看-ClassLoader-树"><a href="#查看-ClassLoader-树" class="headerlink" title="查看 ClassLoader 树"></a>查看 ClassLoader 树</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ classloader -t</span><br><span class="line">+-BootstrapClassLoader</span><br><span class="line">+-sun.misc.Launcher$ExtClassLoader@f6f4d33</span><br><span class="line">  +-com.taobao.arthas.agent.ArthasClassloader@a3df247</span><br><span class="line">  +-sun.misc.Launcher$AppClassLoader@3d4eac69</span><br><span class="line">    +-java.net.FactoryURLClassLoader@7b8e788f</span><br><span class="line">    +-org.springframework.boot.loader.LaunchedURLClassLoader@33c7353a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        +-org.apache.jasper.servlet.JasperLoader@4bc4fe20</span><br><span class="line">Affect(row-cnt:8) cost in 4 ms.</span><br></pre></td></tr></table></figure>

<h2 id="查看-URLClassLoader-实际的-urls"><a href="#查看-URLClassLoader-实际的-urls" class="headerlink" title="查看 URLClassLoader 实际的 urls"></a>查看 URLClassLoader 实际的 urls</h2><p>比如上面查看到的 spring LaunchedURLClassLoader 为 <code>org.springframework.boot.loader.LaunchedURLClassLoader</code> ，可以通过 <code>-c &lt;hashcode&gt;</code> 参数来指定 classloader，还有一种方法可以通过使用 <code>--classLoaderClass</code> 指定类名，从而查看 URLClassLoader 实际的 urls：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader</span><br></pre></td></tr></table></figure>

<h2 id="查找-ClassLoader-里的资源文件"><a href="#查找-ClassLoader-里的资源文件" class="headerlink" title="查找 ClassLoader 里的资源文件"></a>查找 ClassLoader 里的资源文件</h2><p>查找指定的资源文件： <code>classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r java&#x2F;lang&#x2F;String.class</span><br><span class="line"> jar:file:&#x2F;D:&#x2F;developInstall&#x2F;JDK&#x2F;jdk1.8.0_161&#x2F;jre&#x2F;lib&#x2F;rt.jar!&#x2F;java&#x2F;lang&#x2F;String.class</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost in 1 ms.</span><br></pre></td></tr></table></figure>

<p>也可以尝试查找类的 class 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[arthas@3880]$ classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r java&#x2F;lang&#x2F;String.class</span><br><span class="line"> jar:file:&#x2F;D:&#x2F;developInstall&#x2F;JDK&#x2F;jdk1.8.0_161&#x2F;jre&#x2F;lib&#x2F;rt.jar!&#x2F;java&#x2F;lang&#x2F;String.class</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost in 1 ms.</span><br></pre></td></tr></table></figure>

<h1 id="案例：查找-Top-N-线程"><a href="#案例：查找-Top-N-线程" class="headerlink" title="案例：查找 Top N 线程"></a>案例：查找 Top N 线程</h1><h2 id="查看所有线程信息"><a href="#查看所有线程信息" class="headerlink" title="查看所有线程信息"></a>查看所有线程信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread</span><br></pre></td></tr></table></figure>

<h2 id="查看具体线程的栈"><a href="#查看具体线程的栈" class="headerlink" title="查看具体线程的栈"></a>查看具体线程的栈</h2><p>查看线程 ID 16 的栈：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread 16</span><br></pre></td></tr></table></figure>

<h2 id="查看-CPU-使用率-top-n-线程的栈"><a href="#查看-CPU-使用率-top-n-线程的栈" class="headerlink" title="查看 CPU 使用率 top n 线程的栈"></a>查看 CPU 使用率 top n 线程的栈</h2><p>参数<code>n</code> 用来指定最忙的前 N 个线程并打印堆栈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread -n 3</span><br></pre></td></tr></table></figure>

<p>参数<code>i</code> 用来指定 cpu 占比统计的采样间隔，单位为毫秒</p>
<p>查看 5 秒内的 CPU 使用率 top n 线程栈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread -n 3 -i 5000</span><br></pre></td></tr></table></figure>

<h2 id="查找线程是否有阻塞"><a href="#查找线程是否有阻塞" class="headerlink" title="查找线程是否有阻塞"></a>查找线程是否有阻塞</h2><p>参数<code>b</code> 用来指定找出当前阻塞其他线程的线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread -b</span><br></pre></td></tr></table></figure>

<h1 id="案例：获取-Spring-应用运行时配置值"><a href="#案例：获取-Spring-应用运行时配置值" class="headerlink" title="案例：获取 Spring 应用运行时配置值"></a>案例：获取 Spring 应用运行时配置值</h1><p>众所周之，Spring 应用的配置注入方式非常多。除了我们熟悉的方式，比如</p>
<ul>
<li>System Properties/System Env</li>
<li>application.properties/application.yaml</li>
<li>spring profiles</li>
<li>spring cloud config</li>
</ul>
<p>还有很多配置注入的方式，令人眼花缭乱。</p>
<h2 id="获取运行时具体配置"><a href="#获取运行时具体配置" class="headerlink" title="获取运行时具体配置"></a>获取运行时具体配置</h2><p>对于开发人员来说，在运行时怎样确定某个配置是否生效？它的具体值是什么？</p>
<p>用Arthas可以一行命令获取。</p>
<p>比如获取<code>server.port</code>的具体值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vmtool --action getInstances --className org.springframework.context.ConfigurableApplicationContext --express <span class="string">&#x27;instances[0].getEnvironment().getProperty(&quot;server.port&quot;)&#x27;</span></span><br><span class="line">@String[8810]</span><br></pre></td></tr></table></figure>

<h2 id="获取具体的配置来源"><a href="#获取具体的配置来源" class="headerlink" title="获取具体的配置来源"></a>获取具体的配置来源</h2><p>但是怎样具体是从哪个配置源来的？</p>
<ol>
<li><p> 对于 spring boot应用，可以打开一个新的 terminal 窗口，执行 <code>telnet 127.0.0.1 3658</code>连接上Arthas。</p>
</li>
<li><p>执行下面的 watch 命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.context.properties.source.ConfigurationPropertySourcesPropertySource findConfigurationProperty</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li> 在原来窗口用上面的<code>vmtool</code>命令来获取<code>server.port</code>的值</li>
</ol>
<p>可以看到 watch 返回结果里有具体的配置来源<code>application.yml</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ watch org.springframework.boot.context.properties.source.ConfigurationPropertySourcesPropertySource findConfigurationProperty</span><br><span class="line">Press Q or Ctrl+C to abort.</span><br><span class="line">Affect(class count: 1 , method count: 2) cost <span class="keyword">in</span> 217 ms, listenerId: 5</span><br><span class="line">method=org.springframework.boot.context.properties.source.ConfigurationPropertySourcesPropertySource.findConfigurationProperty location=AtExit</span><br><span class="line">ts=2023-11-27 16:08:07.696; [cost=0.327042ms] result=@ArrayList[</span><br><span class="line">    @Object[][isEmpty=<span class="literal">false</span>;size=1],</span><br><span class="line">    @ConfigurationPropertySourcesPropertySource[ConfigurationPropertySourcesPropertySource &#123;name=<span class="string">&#x27;configurationProperties&#x27;</span>&#125;],</span><br><span class="line">    @ConfigurationProperty[[ConfigurationProperty@18fb3ec9 name = server.port, value = 7001, origin = class path resource [application.yml] - 2:9]],</span><br></pre></td></tr></table></figure>

<h1 id="Exit-Stop"><a href="#Exit-Stop" class="headerlink" title="Exit/Stop"></a>Exit/Stop</h1><h2 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h2><p>Arthas 在 watch/trace 等命令时，实际上是修改了应用的字节码，插入增强的代码。显式执行 <code>reset</code> 命令，可以清除掉这些增强代码。</p>
<h2 id="退出-Arthas"><a href="#退出-Arthas" class="headerlink" title="退出 Arthas"></a>退出 Arthas</h2><p>用 <code>exit</code> 或者 <code>quit</code> 命令可以退出 Arthas。</p>
<p>退出 Arthas 之后，还可以再次用 <code>java -jar arthas-boot.jar</code> 来连接。</p>
<h2 id="彻底退出-Arthas"><a href="#彻底退出-Arthas" class="headerlink" title="彻底退出 Arthas"></a>彻底退出 Arthas</h2><p><code>exit/quit</code> 命令只是退出当前 session，arthas server 还在目标进程中运行。</p>
<p>想完全退出 Arthas，可以执行 <code>stop</code> 命令。</p>
<h1 id="Arthas-boot-支持的参数"><a href="#Arthas-boot-支持的参数" class="headerlink" title="Arthas-boot 支持的参数"></a>Arthas-boot 支持的参数</h1><p><code>arthas-boot.jar</code> 支持很多参数，可以执行 <code>java -jar arthas-boot.jar -h</code> 来查看。</p>
<h2 id="允许外部访问"><a href="#允许外部访问" class="headerlink" title="允许外部访问"></a>允许外部访问</h2><p>默认情况下，arthas server 侦听的是 <code>127.0.0.1</code> 这个 IP，如果希望远程可以访问，可以使用<code>--target-ip</code> 的参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar --target-ip</span><br></pre></td></tr></table></figure>

<h2 id="列出所有的版本"><a href="#列出所有的版本" class="headerlink" title="列出所有的版本"></a>列出所有的版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar --versions</span><br></pre></td></tr></table></figure>

<p>使用指定版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar --use-version 3.1.0</span><br></pre></td></tr></table></figure>

<h2 id="只侦听-Telnet-端口，不侦听-HTTP-端口"><a href="#只侦听-Telnet-端口，不侦听-HTTP-端口" class="headerlink" title="只侦听 Telnet 端口，不侦听 HTTP 端口"></a>只侦听 Telnet 端口，不侦听 HTTP 端口</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar --telnet-port 9999 --http-port -1</span><br></pre></td></tr></table></figure>

<h2 id="打印运行的详情"><a href="#打印运行的详情" class="headerlink" title="打印运行的详情"></a>打印运行的详情</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar -v</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Arthas/" rel="tag"># Arthas</a>
              <a href="/tags/Java%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/" rel="tag"># Java诊断工具</a>
              <a href="/tags/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" rel="tag"># 线上问题排查</a>
              <a href="/tags/JVM/" rel="tag"># JVM</a>
              <a href="/tags/%E5%8F%8D%E7%BC%96%E8%AF%91/" rel="tag"># 反编译</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/01/03/Java%E5%BA%94%E7%94%A8%E8%AF%8A%E6%96%AD%E5%88%A9%E5%99%A8Arthas/" rel="prev" title="Arthas基础教程">
                  <i class="fa fa-angle-left"></i> Arthas基础教程
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/01/08/Arthas-%E5%91%BD%E4%BB%A4/" rel="next" title="Arthas 命令">
                  Arthas 命令 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">wotzc</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/wotzc" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
